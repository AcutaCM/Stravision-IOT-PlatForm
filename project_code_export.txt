

--- FILE: app\(mobile)\ai-assistant-ios\page.tsx ---

"use client"
import { useState, useEffect, useRef } from "react"
import Image from "next/image"
import { useRouter } from "next/navigation"
import type { UserPublic } from "@/lib/db/user-service"
import {
  Copy,
  RotateCcw,
  Settings,
  X,
  ChevronDown,
  Search,
  Sparkles,
  CircleHelp,
  CheckCircle2,
  AlertCircle,
  Loader2,
  Globe,
  ArrowUp,
  Paperclip,
  FileText,
  Sun,
  Activity,
  Sprout,
  Zap,
  ArrowUpRight,
  ArrowRight,
  Plus,
  Menu,
  Infinity,
  Mic,
  Image as ImageIcon,
  Camera,
  Rocket,
  Trash,
  History
} from "lucide-react"
import MermaidChart from "@/components/mermaid-chart"
import ReactMarkdown from "react-markdown"
import remarkGfm from "remark-gfm"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Sheet, SheetContent, SheetTrigger, SheetHeader, SheetTitle } from "@/components/ui/sheet"
import ChartRenderer from "@/components/chart-renderer"
import {
  PromptInputModelSelect,
  PromptInputModelSelectTrigger,
  PromptInputModelSelectContent,
  PromptInputModelSelectItem,
  Conversation,
  ConversationContent,
} from "@/components/ui/assistant-ui"
import { MobileAISettingsModal } from "@/components/mobile-ai-settings-modal"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { cn } from "@/lib/utils"
import { Reasoning, ReasoningTrigger, ReasoningContent } from "@/components/ai/reasoning"
import { MonitorCard } from "@/components/ai/monitor-card"
import { DeviceBentoGrid } from "@/components/ai/device-bento-grid"
import { ControlBentoGrid } from "@/components/ai/control-bento-grid"
import { ScheduleCard } from "@/components/ai/schedule-card"
import { ScheduledTasksList } from "@/components/ai/scheduled-tasks-list"
interface Citation {
  number: string
  title: string
  url: string
  description?: string
  quote?: string
}
interface TaskItemModel { type: "text" | "file"; text: string; file?: { name: string; icon?: string } }
interface TaskModel { title: string; items: TaskItemModel[]; status: "pending" | "in_progress" | "completed" }
interface Message {
  role: "user" | "assistant"
  content: string | Array<{ type: 'text' | 'image_url', text?: string, image_url?: { url: string } }>
  citations?: Citation[]
  reasoning?: { text: string; durationMs?: number }
  tasks?: TaskModel[]
}
interface AISettings {
  apiKey: string
  apiUrl: string
  model: string
  systemPrompt: string
}
interface SessionMeta { id: string; title: string; createdAt: number; updatedAt: number }
export default function AIAssistantIOSPage() {
  const router = useRouter()
  const [user, setUser] = useState<UserPublic | null>(null)
  // Chat State
  const [input, setInput] = useState("")
  const [messages, setMessages] = useState<Message[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [sessionId, setSessionId] = useState<string>("")
  const [sessions, setSessions] = useState<SessionMeta[]>([])
  const [aiSettings, setAiSettings] = useState<AISettings | null>(null)
  const [settingsOpen, setSettingsOpen] = useState(false)
  const [sheetOpen, setSheetOpen] = useState(false)
  const [enableSearch, setEnableSearch] = useState(false)
  const [enableReasoning, setEnableReasoning] = useState(false)
  const [selectedModel, setSelectedModel] = useState<string>("")
  const [attachments, setAttachments] = useState<string[]>([])
  const scrollAreaRef = useRef<HTMLDivElement>(null)
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [autoScroll, setAutoScroll] = useState(true)
  const { deviceData } = useDeviceData()
  const { weatherData } = useWeatherContext()
  const [notices, setNotices] = useState<{ id: number; title: string; description?: string; variant?: 'loading'|'success'|'error'; expanded: boolean }[]>([])
  const noticeIdCounter = useRef(0)
  const showNotice = (title: string, description?: string, variant?: 'loading'|'success'|'error') => {
    const id = ++noticeIdCounter.current
    setNotices(prev => [...prev, { id, title, description, variant, expanded: false }])
    if (variant && variant !== 'loading') {
      setTimeout(() => {
        setNotices(prev => prev.filter(n => n.id !== id))
      }, 5000)
    }
  }
  const closeNotice = (id: number) => {
    setNotices(prev => prev.filter(n => n.id !== id))
  }
  const toggleNoticeExpanded = (id: number) => {
    setNotices(prev => prev.map(n => n.id === id ? { ...n, expanded: !n.expanded } : n))
  }
  // Fetch User
  useEffect(() => {
    let mounted = true
    ;(async () => {
      try {
        const res = await fetch("/api/auth/me")
        const data = await res.json()
        if (mounted && data?.authenticated && data?.user) setUser(data.user as UserPublic)
      } catch {}
    })()
    return () => { mounted = false }
  }, [])
  // Load Settings
  useEffect(() => {
    try {
      const s = localStorage.getItem("ai-settings")
      if (s) {
        const parsed = JSON.parse(s)
        setAiSettings(parsed)
        if (!selectedModel && parsed?.model) setSelectedModel(parsed.model)
      }
      const es = localStorage.getItem("ai-enable-search")
      if (es) setEnableSearch(es === "true")
    } catch {}
  }, [])
  // Load Sessions
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch("/api/sessions")
        if (res.ok) {
          const data = await res.json()
          if (Array.isArray(data?.sessions)) {
            setSessions(data.sessions)
            const lastId = localStorage.getItem("ai-last-session-id")
            if (lastId && data.sessions.find((s: SessionMeta) => s.id === lastId)) {
              setSessionId(lastId)
            } else if (data.sessions.length > 0) {
              setSessionId(data.sessions[0].id)
            } else {
              createNewSession()
            }
          }
        }
      } catch {}
    })()
  }, [])
  // Load Messages
  useEffect(() => {
    if (!sessionId) return
    localStorage.setItem("ai-last-session-id", sessionId)
    ;(async () => {
      try {
        const res = await fetch(`/api/sessions/${sessionId}`)
        if (res.ok) {
          const data = await res.json()
          const msgs = Array.isArray(data?.messages) ? (data.messages as Message[]) : []
          setMessages(msgs.length > 0 ? msgs : [])
          try {
            const draft = localStorage.getItem(`ai-input-draft-${sessionId}`)
            if (typeof draft === "string") setInput(draft)
          } catch {}
        }
      } catch {}
    })()
  }, [sessionId])
  // Scroll to bottom
  useEffect(() => {
    if (autoScroll && messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "smooth" })
    }
  }, [messages, isLoading, autoScroll])
  const executeCommands = async (commands: any[]) => {
    if (!commands || commands.length === 0) return
    showNotice("正在执行指令...", `共发现 ${commands.length} 个操作`, "loading")
    for (const cmd of commands) {
      try {
        if (cmd.action === "set_led") {
          const res = await fetch('/api/ai/device-control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'set_led', r: cmd.r, g: cmd.g, b: cmd.b })
          })
          if (res.ok) {
            showNotice("调控成功 ", `已开启补光灯 (R:${cmd.r} G:${cmd.g} B:${cmd.b})`, "success")
          } else {
            let err = ''
            try { const j = await res.json(); err = j?.error || '' } catch {}
            showNotice("调控失败", err || `请求错误 ${res.status}`, "error")
          }
        } else if (cmd.action === "toggle_relay") {
          const res = await fetch('/api/ai/device-control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'toggle_relay', device: cmd.device, value: cmd.value })
          })
          if (res.ok) {
            showNotice("开关执行成功 ", `设备 ${cmd.device} 状态 ${cmd.value === 1 ? '开启' : '关闭'}`, "success")
          } else {
            let err = ''
            try { const j = await res.json(); err = j?.error || '' } catch {}
            showNotice("开关执行失败", err || `请求错误 ${res.status}`, "error")
          }
        }
        await new Promise(resolve => setTimeout(resolve, 500))
      } catch (e) {
        console.error("Command execution error", e)
      }
    }
  }
  const handleSend = async (overrideText?: any) => {
    const text = typeof overrideText === "string" ? overrideText : input
    if (!text.trim() || isLoading) return
    if (!aiSettings?.apiKey) { setSettingsOpen(true); return }
    const userMsg = text.trim()
    setInput("")
    setEnableSearch(false)
    let ensuredSessionId = sessionId
    if (!ensuredSessionId) {
      await createNewSession()
      const r = await fetch("/api/sessions", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ title: `新会话 ${new Date().toLocaleString("zh-CN")}` }) })
      if (r.ok) {
        const s = await r.json()
        ensuredSessionId = s.id
        setSessionId(s.id)
        setSessions(prev => [s, ...prev])
      }
    }
    const userMessageContent: Message['content'] = attachments.length > 0
      ? [
          { type: "text", text: userMsg },
          ...attachments.map(url => ({ type: "image_url" as const, image_url: { url } }))
        ]
      : userMsg
    if (userMsg === "是" || userMsg === "执行") {
      const lastAssistantMsg = messages[messages.length - 1]
      if (lastAssistantMsg && lastAssistantMsg.role === "assistant") {
        const jsonMatches = [...(lastAssistantMsg.content as string).matchAll(/```json\s*([\s\S]*?)```/g)]
        if (jsonMatches.length > 0) {
          const commands = []
          for (const match of jsonMatches) {
             try { commands.push(JSON.parse(match[1])) } catch {}
          }
          if (commands.length > 0) await executeCommands(commands)
        }
      }
      return
    }
    const newMessages: Message[] = [...messages, { role: "user", content: userMessageContent }]
    setMessages(newMessages)
    setIsLoading(true)
    setAutoScroll(true)
    const currentAttachments = [...attachments]
    setAttachments([])
    try {
      if (ensuredSessionId) {
        const current = sessions.find((s) => s.id === ensuredSessionId)
        if (current && current.title && current.title.startsWith("新会话")) {
           const cand = userMsg.slice(0, 24)
           await fetch(`/api/sessions/${ensuredSessionId}`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ title: cand }) })
           setSessions((prev) => prev.map((s) => (s.id === ensuredSessionId ? { ...s, title: cand } : s)))
        }
        await fetch(`/api/sessions/${ensuredSessionId}`, {
           method: "PUT",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ messages: newMessages.map(m => ({ role: m.role, content: m.content })) })
        })
      }
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: newMessages.map((m) => ({ role: m.role, content: m.content })),
          model: selectedModel || aiSettings?.model,
          apiKey: aiSettings?.apiKey,
          apiUrl: aiSettings?.apiUrl,
          systemPrompt: aiSettings?.systemPrompt,
          sessionId: ensuredSessionId,
          enableSearch,
          enableReasoning,
          deviceData,
          weatherData
        })
      })
      if (!res.ok) {
        const errorText = await res.text()
        throw new Error(`Failed to send message: ${res.status} - ${errorText}`)
      }
      const reader = res.body?.getReader()
      if (!reader) throw new Error("No response body")
      const assistantMsg: Message = { role: "assistant", content: "" }
      let reasoningText = ""
      let reasoningStart = -1
      const startTs = Date.now()
      setMessages(prev => [...prev, assistantMsg])
      while (true) {
        const { done, value } = await reader.read()
        if (done) break
        const chunk = new TextDecoder().decode(value)
        const lines = chunk.split("\n")
        for (const line of lines) {
          if (line.startsWith("data: ")) {
            try {
              const data = JSON.parse(line.slice(6))
              const content = data.choices?.[0]?.delta?.content ?? data.content
              if (typeof content === "string") {
                assistantMsg.content = (typeof assistantMsg.content === "string" ? assistantMsg.content : "") + content
                const combined = typeof assistantMsg.content === "string" ? assistantMsg.content : ""
                if (reasoningStart === -1) {
                  const sIdx = combined.indexOf("<REASONING>")
                  if (sIdx !== -1) reasoningStart = sIdx
                }
                let display = combined
                if (reasoningStart !== -1) {
                  const endIdx = combined.indexOf("</REASONING>", reasoningStart)
                  if (endIdx !== -1) {
                    reasoningText = combined.slice(reasoningStart + 11, endIdx)
                    display = combined.slice(0, reasoningStart) + combined.slice(endIdx + 12)
                  } else {
                    reasoningText = combined.slice(reasoningStart + 11)
                    display = combined.slice(0, reasoningStart)
                  }
                }
                setMessages(prev => {
                  const newMsgs = [...prev]
                  newMsgs[newMsgs.length - 1] = {
                    role: "assistant",
                    content: display,
                    reasoning: { text: reasoningText, durationMs: Date.now() - startTs }
                  }
                  return newMsgs
                })
              }
            } catch {}
          }
        }
      }
      if (ensuredSessionId) {
         const lastMsg = { ...assistantMsg, reasoning: { text: reasoningText, durationMs: Date.now() - startTs } }
         await fetch(`/api/sessions/${ensuredSessionId}`, {
           method: "PUT",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ messages: [...newMessages, lastMsg] })
        })
      }
    } catch (e) {
      console.error("Chat error:", e)
      setMessages(prev => [...prev, { role: "assistant", content: "抱歉，发生了一些错误，请稍后再试。" }])
    } finally {
      setIsLoading(false)
      setTimeout(() => setIsLoading(false), 100)
    }
  }
  const createNewSession = async () => {
    try {
      const r = await fetch("/api/sessions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: `新会话 ${new Date().toLocaleString("zh-CN")}` })
      })
      if (r.ok) {
        const s = await r.json()
        setSessionId(s.id)
        setSessions(prev => [s, ...prev])
        setMessages([])
        setInput("")
        setSheetOpen(false)
      }
    } catch {}
  }
  const deleteSession = async (id: string, e: React.MouseEvent) => {
    e.stopPropagation()
    try {
      const res = await fetch(`/api/sessions/${id}`, { method: "DELETE" })
      if (res.ok) {
        setSessions(prev => prev.filter(s => s.id !== id))
        if (sessionId === id) {
          setSessionId("")
          setMessages([])
          createNewSession()
        }
        showNotice("会话已删除", undefined, "success")
      }
    } catch {}
  }
  const onSelectFiles: React.ChangeEventHandler<HTMLInputElement> = (e) => {
    const files = Array.from(e.currentTarget.files || [])
    files.forEach((file) => {
      const reader = new FileReader()
      reader.onload = () => {
        const url = typeof reader.result === "string" ? reader.result : ""
        if (url) setAttachments((prev) => [...prev, url])
      }
      reader.readAsDataURL(file)
    })
    e.currentTarget.value = ""
    if (files.length > 0) {
      showNotice("附件已添加", `共 ${files.length} 个`, "success")
    }
  }
  const removeAttachment = (index: number) => {
    setAttachments((prev) => prev.filter((_, i) => i !== index))
  }
  const handleSettingsSave = (settings: AISettings) => {
    setAiSettings(settings)
    localStorage.setItem("ai-settings", JSON.stringify(settings))
    setSelectedModel(settings.model)
  }
  const renderMessageContent = (msg: Message) => {
    const content = msg.content
    if (Array.isArray(content)) {
      return (
        <div className="space-y-2">
          {content.map((part, i) => (
            <div key={i}>
              {part.type === 'image_url' && part.image_url && (
                <div className="relative w-full max-w-[300px] h-auto rounded-lg overflow-hidden border border-gray-200 my-2">
                   <Image src={part.image_url.url} alt="User upload" width={300} height={200} className="object-cover w-full h-auto" />
                </div>
              )}
              {part.type === 'text' && part.text && renderTextContent(part.text)}
            </div>
          ))}
        </div>
      )
    }
    return renderTextContent(content)
  }
  const renderTextContent = (content: string) => {
    const parts = content.split(/(<\s*CHART\s+type="echarts"\s*>[\s\S]*?<\/\s*CHART\s*>|<\s*CHART\s+type="vega-lite"\s*>[\s\S]*?<\/\s*CHART\s*>|<\s*REASONING\s*>[\s\S]*?(?:<\/\s*REASONING\s*>|$)|<\s*SOURCES\s*>[\s\S]*?<\/\s*SOURCES\s*>|<\s*MONITOR\s*>[\s\S]*?(?:<\/\s*MONITOR\s*>|$)|<\s*TASKS\s*>[\s\S]*?<\/\s*TASKS\s*>|<\s*DEVICE_BENTO\s*(?:>[\s\S]*?(?:<\/\s*DEVICE_BENTO\s*>|$)|(?:\/>))|<\s*CONTROL_BENTO\s*(?:>[\s\S]*?(?:<\/\s*CONTROL_BENTO\s*>|$)|(?:\/>))|<\s*TASK_LIST\s*(?:>[\s\S]*?(?:<\/\s*TASK_LIST\s*>|$)|(?:\/>)))/g)
    return (
      <>
        {parts.map((part, index) => {
          if (part.match(/^<\s*TASK_LIST/)) return <div key={index} className="my-6"><ScheduledTasksList /></div>
          if (part.match(/^<\s*CONTROL_BENTO/)) return <div key={index} className="my-6"><ControlBentoGrid /></div>
          if (part.match(/^<\s*DEVICE_BENTO/)) return <div key={index} className="my-6"><DeviceBentoGrid /></div>
          if (part.match(/^<\s*MONITOR/)) return <div key={index} className="flex justify-center my-4"><MonitorCard /></div>
          if (part.match(/^<\s*TASKS/)) {
            try {
              const jsonStr = part.replace(/<\s*TASKS\s*>/, '').replace(/<\/\s*TASKS\s*>/, '').trim()
              const tasks = JSON.parse(jsonStr) as TaskModel[]
              if (!tasks || tasks.length === 0) return null
              return (
                <div key={index} className="my-4 space-y-4">
                  {tasks.map((task, i) => (
                    <div key={i} className="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                      <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
                        <h3 className="font-medium text-sm text-gray-900">{task.title}</h3>
                        <div className={cn("px-2 py-0.5 rounded-full text-[10px] font-medium uppercase tracking-wide", task.status === 'completed' ? "bg-green-100 text-green-700" : task.status === 'in_progress' ? "bg-blue-100 text-blue-700" : "bg-gray-100 text-gray-600")}>
                          {task.status === 'completed' ? '已完成' : task.status === 'in_progress' ? '进行中' : '待处理'}
                        </div>
                      </div>
                      <div className="p-0">
                        {task.items.map((item, j) => (
                           <div key={j} className="flex items-start gap-3 px-4 py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors">
                             <div className="mt-0.5 shrink-0 text-gray-400">
                               {item.type === 'file' ? <FileText size={16} /> : <CheckCircle2 size={16} className={cn(task.status === 'completed' ? "text-green-500" : "")} />}
                             </div>
                             <div className="flex-1 text-sm text-gray-600">
                               {item.text}
                               {item.file && (
                                 <div className="mt-2 flex items-center gap-2 p-2 bg-gray-100 rounded-md border border-gray-200 w-fit">
                                    <div className="text-xs font-medium text-gray-700">{item.file.name}</div>
                                 </div>
                               )}
                             </div>
                           </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )
            } catch { return null }
          }
          if (part.match(/^<\s*CHART/)) {
            try {
              const isVegaLite = part.includes('type="vega-lite"')
              const tagStartRegex = isVegaLite ? /<\s*CHART\s+type="vega-lite"\s*>/ : /<\s*CHART\s+type="echarts"\s*>/
              const jsonStr = part.replace(tagStartRegex, '').replace(/<\/\s*CHART\s*>/, '').trim()
              const data = JSON.parse(jsonStr)
              return (
                <div key={index} className="my-4 w-full min-w-[300px] h-[300px] rounded-lg overflow-hidden bg-white relative z-10 border border-gray-100 shadow-sm">
                  <ChartRenderer options={data} type={isVegaLite ? 'vega-lite' : 'echarts'} style={{ height: '100%', width: '100%' }} />
                </div>
              )
            } catch { return null }
          }
          if (part.match(/^<\s*REASONING/)) {
             const reasoningText = part.replace(/<\s*REASONING\s*>/, '').replace(/<\/\s*REASONING\s*>/, '').trim()
             const isStreaming = !part.match(/<\/\s*REASONING\s*>/)
             if (!reasoningText && !isStreaming) return null
             return (
               <Reasoning key={index} isStreaming={isStreaming} className="mb-4">
                 <ReasoningTrigger />
                 <ReasoningContent>
                   <ReactMarkdown remarkPlugins={[remarkGfm]}>{reasoningText}</ReactMarkdown>
                 </ReasoningContent>
               </Reasoning>
             )
          }
          if (part.match(/^<\s*SOURCES/)) {
            try {
              const jsonStr = part.replace(/<\s*SOURCES\s*>/, '').replace(/<\/\s*SOURCES\s*>/, '').trim()
              const sources = JSON.parse(jsonStr) as Array<{ title: string, url: string, number: number }>
              if (!sources || sources.length === 0) return null
              return (
                <div key={index} className="mt-4 mb-2">
                  <div className="flex flex-wrap gap-2">
                    <div className="inline-flex items-center gap-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-full pl-1 pr-3 py-1 transition-colors cursor-pointer group">
                       <div className="flex -space-x-2 overflow-hidden py-0.5 pl-0.5">
                          {sources.slice(0, 3).map((s, i) => (
                            <div key={i} className="size-5 rounded-full bg-white border border-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-500 shadow-sm shrink-0 relative z-10">
                               {s.number}
                            </div>
                          ))}
                       </div>
                       <span className="text-sm text-gray-500 font-medium group-hover:text-gray-700">来源</span>
                    </div>
                  </div>
                </div>
              )
            } catch { return null }
          }
          if (!part.trim()) return null
          const commands: any[] = []
          const matches = part.matchAll(/```json\s*([\s\S]*?)```/g)
          for (const match of matches) {
             try {
                const json = JSON.parse(match[1])
                if (json.action === 'toggle_relay' || json.action === 'set_led') commands.push(json)
             } catch {}
          }
          return (
            <div key={index}>
                <ReactMarkdown
                  remarkPlugins={[remarkGfm]}
                  components={{
                    code: ({ node, inline, className, children, ...props }: any) => {
                      const match = /language-(\w+)/.exec(className || '')
                      const language = match ? match[1] : ''
                      const isMermaid = language === 'mermaid'
                      if (!inline && isMermaid) return <MermaidChart chart={String(children).replace(/\n$/, '')} />
                      if (!inline && (!language || language === 'json')) {
                        try {
                          const content = String(children).replace(/\n$/, '')
                          if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                            const data = JSON.parse(content)
                            if (data.action === 'schedule_task') return <ScheduleCard data={data} />
                            if (data && (data.series || (data.xAxis && data.yAxis))) {
                              return (
                                <div className="my-4 w-full min-w-[300px] h-[300px] rounded-lg overflow-hidden bg-white relative z-10 border border-gray-100 shadow-sm">
                                  <ChartRenderer options={data} type="echarts" style={{ height: '100%', width: '100%' }} />
                                </div>
                              )
                            }
                          }
                        } catch {}
                      }
                       return <code className={cn("bg-gray-100 rounded px-1 font-mono text-sm text-gray-800 font-semibold", className)} {...props}>{children}</code>
                    },
                    pre: ({ node, children, ...props }: any) => <pre className="bg-gray-50 p-3 rounded-lg overflow-x-auto my-2 border border-gray-200" {...props}>{children}</pre>
                  }}
                >
                  {part}
                </ReactMarkdown>
                {commands.length > 0 && (
                   <div className="mt-3 mb-4">
                      <button
                        onClick={() => executeCommands(commands)}
                        className="group relative flex items-center gap-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-5 py-3 rounded-xl font-medium transition-all shadow-[0_4px_14px_0_rgba(59,130,246,0.39)] hover:shadow-[0_6px_20px_rgba(59,130,246,0.23)] hover:-translate-y-0.5 active:translate-y-0 active:scale-95 overflow-hidden"
                      >
                         <div className="absolute inset-0 bg-white/20 group-hover:translate-x-[100%] transition-transform duration-700 -skew-x-12 -translate-x-[100%]"></div>
                         <Zap size={18} className="animate-pulse" />
                         <div className="flex flex-col items-start">
                           <span className="text-sm font-bold leading-none">立即执行指令</span>
                           <span className="text-[10px] opacity-80 font-mono mt-0.5">执行 {commands.length} 个指令</span>
                         </div>
                         <ArrowRight size={16} className="opacity-60 group-hover:translate-x-1 transition-transform" />
                      </button>
                   </div>
                )}
            </div>
          )
        })}
      </>
    )
  }
  return (
    <div className="h-[100dvh] w-full bg-slate-50 dark:bg-[#0B1121] text-foreground overflow-hidden font-sans transition-colors duration-500 flex flex-col fixed inset-0">
      {/* Background blobs */}
      <div className="fixed top-[-20%] right-[-20%] w-[80%] h-[60%] rounded-full bg-blue-200/20 dark:bg-blue-900/10 blur-[100px] pointer-events-none" />
      <div className="fixed top-[20%] left-[-20%] w-[60%] h-[60%] rounded-full bg-indigo-200/20 dark:bg-indigo-900/10 blur-[100px] pointer-events-none" />
      {/* Header */}
      <div className="fixed top-0 left-0 right-0 z-40 h-16 bg-white/70 dark:bg-[#0B1121]/70 backdrop-blur-lg px-6 flex items-center justify-between">
        <Sheet open={sheetOpen} onOpenChange={setSheetOpen}>
          <SheetTrigger asChild>
            <button
              className="p-2 -ml-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
              aria-label="打开菜单"
            >
              <Menu size={24} className="text-gray-800 dark:text-gray-200" />
            </button>
          </SheetTrigger>
          <SheetContent side="left" className="w-[300px] p-0 border-r border-gray-200 dark:border-gray-800">
            <div className="flex flex-col h-full bg-white dark:bg-[#0B1121]">
              <div className="p-6 pb-4">
                <button
                  onClick={() => createNewSession()}
                  className="w-full flex items-center gap-3 px-4 py-3.5 bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white rounded-2xl transition-all shadow-lg shadow-blue-500/20"
                >
                  <Plus size={20} strokeWidth={2.5} />
                  <span className="font-semibold tracking-wide">新建对话</span>
                </button>
              </div>
              <div className="flex-1 overflow-y-auto px-3 pb-6">
                <div className="px-3 py-2 mb-2 flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                  <History size={12} />
                  <span>历史记录</span>
                </div>
                <div className="space-y-1">
                  {sessions.map(s => (
                    <div
                      key={s.id}
                      onClick={() => { setSessionId(s.id); setSheetOpen(false) }}
                      className={cn(
                        "group flex items-center justify-between px-4 py-3.5 rounded-xl cursor-pointer transition-all duration-200",
                        sessionId === s.id
                          ? "bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white font-medium"
                          : "hover:bg-gray-50 dark:hover:bg-white/5 text-gray-600 dark:text-gray-400"
                      )}
                    >
                      <span className="text-sm truncate flex-1 pr-4 leading-none">{s.title}</span>
                      <button
                        onClick={(e) => deleteSession(s.id, e)}
                        className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all opacity-0 group-hover:opacity-100 scale-90 group-hover:scale-100"
                        aria-label="删除会话"
                      >
                        <Trash size={14} />
                      </button>
                    </div>
                  ))}
                  {sessions.length === 0 && (
                    <div className="px-4 py-8 text-center text-gray-400 text-sm">
                      暂无历史记录
                    </div>
                  )}
                </div>
              </div>
              {/* User Profile in Sidebar */}
              <div className="p-4 border-t border-gray-100 dark:border-gray-800">
                <div className="flex items-center gap-3 px-2">
                  <Avatar className="size-9 border border-gray-200 dark:border-gray-700">
                    <AvatarImage src={user?.avatar_url || undefined} />
                    <AvatarFallback className="bg-gradient-to-br from-blue-500 to-indigo-600 text-white text-xs">
                      {user?.username?.[0]?.toUpperCase() || "U"}
                    </AvatarFallback>
                  </Avatar>
                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-sm truncate text-gray-900 dark:text-gray-100">{user?.username || '用户'}</div>
                    <div className="text-xs text-gray-500 truncate">专业版</div>
                  </div>
                  <button onClick={() => setSettingsOpen(true)} className="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" aria-label="设置">
                    <Settings size={18} />
                  </button>
                </div>
              </div>
            </div>
          </SheetContent>
        </Sheet>
        <div className="flex items-center gap-3 font-serif text-xl font-medium tracking-wide">
           <div className="relative size-8 rounded-full overflow-hidden border border-gray-100 dark:border-gray-800 shadow-sm">
             <Image src="/logo.gif" alt="Logo" fill className="object-cover" unoptimized />
           </div>
           <span>你好, {user?.username || '朋友'}!</span>
        </div>
        <button onClick={() => setSettingsOpen(true)} className="p-2 -mr-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors" aria-label="设置" id="mobile-ai-settings-trigger">
           <Infinity size={24} className="text-gray-800 dark:text-gray-200" />
        </button>
      </div>
      {/* Main Content Area */}
      <div className="flex-1 flex flex-col pt-16 relative z-10 min-h-0">
         <ScrollArea className="flex-1 px-4 h-full">
           <div className="flex flex-col gap-6 pb-48 pt-4">
             {messages.length === 0 ? (
                <div className="flex flex-col items-center justify-center flex-1 space-y-10">
                   {/* Central Logo */}
                   <div className="relative w-48 h-48 mx-auto my-8 flex items-center justify-center">
                      <div className="absolute inset-0 bg-blue-500/20 rounded-full blur-3xl animate-pulse" />
                      <Image
                        src="/logo.gif"
                        alt="App Logo"
                        width={192}
                        height={192}
                        className="object-contain relative z-10 drop-shadow-2xl hover:scale-105 transition-transform duration-500"
                        unoptimized
                      />
                   </div>
                   {/* Greeting Text */}
                   <h2 className="text-3xl font-serif text-center leading-tight text-gray-800 dark:text-gray-100 max-w-[280px]">
                      您的草莓大棚<br/>智能管家
                   </h2>
                   {/* Action Chips */}
                   <div className="flex gap-3 overflow-x-auto w-full max-w-sm justify-center py-2 no-scrollbar px-4">
                      <button onClick={() => handleSend("分析当前大棚环境数据")} className="flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-white/5 rounded-full border border-gray-100 dark:border-white/10 shadow-sm hover:shadow-md transition-all whitespace-nowrap flex-shrink-0">
                         <Activity size={16} className="text-purple-500" />
                         <span className="text-sm font-medium">环境分析</span>
                      </button>
                      <button onClick={() => handleSend("检查所有设备运行状态")} className="flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-white/5 rounded-full border border-gray-100 dark:border-white/10 shadow-sm hover:shadow-md transition-all whitespace-nowrap flex-shrink-0">
                         <Zap size={16} className="text-blue-500" />
                         <span className="text-sm font-medium">设备检查</span>
                      </button>
                      <button onClick={() => handleSend("草莓常见病害有哪些？")} className="flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-white/5 rounded-full border border-gray-100 dark:border-white/10 shadow-sm hover:shadow-md transition-all whitespace-nowrap flex-shrink-0">
                         <Search size={16} className="text-green-500" />
                         <span className="text-sm font-medium">病害咨询</span>
                      </button>
                       <button onClick={() => handleSend("制定今天的灌溉计划")} className="flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-white/5 rounded-full border border-gray-100 dark:border-white/10 shadow-sm hover:shadow-md transition-all whitespace-nowrap flex-shrink-0">
                         <Sprout size={16} className="text-amber-500" />
                         <span className="text-sm font-medium">灌溉计划</span>
                      </button>
                   </div>
                </div>
             ) : (
                messages.map((msg, i) => (
                  <div key={i} className={cn(
                    "flex gap-3",
                    msg.role === "user" ? "justify-end" : "justify-start"
                  )}>
                    {msg.role === "assistant" && (
                      <div className="size-8 flex-shrink-0 rounded-full overflow-hidden bg-white border border-gray-100 mt-1">
                        <Image src="/logo.gif" alt="AI" width={32} height={32} className="object-cover" unoptimized />
                      </div>
                    )}
                    <div className={cn(
                      "max-w-[85%] min-w-0 break-words rounded-2xl px-4 py-3 text-sm leading-relaxed shadow-sm",
                      msg.role === "user"
                        ? "bg-blue-600 text-white rounded-tr-sm"
                        : "bg-white dark:bg-[#1a1a1a] text-foreground border border-gray-100 dark:border-gray-800 rounded-tl-sm"
                    )}>
                      <div className={cn("prose prose-sm max-w-none dark:prose-invert break-words", msg.role === "user" ? "prose-invert" : "")}>
                        {renderMessageContent(msg)}
                      </div>
                    </div>
                  </div>
                ))
             )}
             {isLoading && (
                <div className="flex gap-3">
                   <div className="size-8 flex-shrink-0 rounded-full overflow-hidden bg-white border border-gray-100 mt-1">
                      <Image src="/logo.gif" alt="AI" width={32} height={32} className="object-cover" unoptimized />
                   </div>
                   <div className="bg-white dark:bg-[#1a1a1a] border border-gray-100 dark:border-gray-800 rounded-2xl rounded-tl-sm px-4 py-3 flex items-center gap-1">
                      <span className="size-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                      <span className="size-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                      <span className="size-2 bg-gray-400 rounded-full animate-bounce"></span>
                   </div>
                </div>
             )}
             <div ref={messagesEndRef} />
           </div>
         </ScrollArea>
         {/* Floating Input Bar */}
         <div className="fixed bottom-[88px] left-0 right-0 px-4 z-40">
            <div className="bg-white/95 dark:bg-[#1a1a1a]/95 backdrop-blur-xl rounded-[32px] shadow-[0_8px_40px_-12px_rgba(0,0,0,0.15)] border border-gray-100 dark:border-gray-800 p-2 flex flex-col gap-2 relative">
               {attachments.length > 0 && (
                  <div className="flex gap-2 overflow-x-auto px-4 py-2">
                     {attachments.map((url, i) => (
                        <div key={i} className="relative size-12 rounded-lg overflow-hidden border border-gray-200 flex-shrink-0">
                           <Image src={url} alt="preview" fill className="object-cover" />
                           <button onClick={() => removeAttachment(i)} className="absolute top-0.5 right-0.5 bg-black/50 rounded-full p-0.5 text-white" aria-label="删除附件"><X size={10} /></button>
                        </div>
                     ))}
                  </div>
               )}
               <div className="flex flex-col gap-2 p-2">
                  <textarea
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    placeholder="输入关于草莓种植的问题..."
                    className="w-full bg-transparent border-0 focus:ring-0 resize-none px-2 py-1 min-h-[44px] text-base placeholder:text-gray-400"
                    rows={1}
                  />
                  <div className="flex items-center justify-between px-1">
                     <div className="flex items-center gap-2">
                        <button onClick={() => fileInputRef.current?.click()} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 hover:text-gray-600 transition-colors" aria-label="添加附件">
                           <Paperclip size={20} />
                        </button>
                        <PromptInputModelSelect value={selectedModel || aiSettings?.model || "qwen-vl-plus"} onValueChange={(val) => {
                           setSelectedModel(val)
                           if (aiSettings) {
                              const newSettings = { ...aiSettings, model: val }
                              setAiSettings(newSettings)
                              localStorage.setItem("ai-settings", JSON.stringify(newSettings))
                           } else {
                              const defaultSettings = {
                                 apiKey: "",
                                 apiUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1",
                                 model: val,
                                 systemPrompt: ""
                              }
                              setAiSettings(defaultSettings)
                              localStorage.setItem("ai-settings", JSON.stringify(defaultSettings))
                           }
                        }}>
                           <PromptInputModelSelectTrigger className="flex items-center gap-1.5 px-3 py-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-500 transition-colors border-0 shadow-none h-auto">
                              <Rocket size={16} />
                              <span className="text-sm font-medium max-w-[80px] truncate">{selectedModel || aiSettings?.model || "自动"}</span>
                              <ChevronDown size={14} />
                           </PromptInputModelSelectTrigger>
                           <PromptInputModelSelectContent className="w-[200px] mb-2" style={{ alignItems: 'start', justifyContent: 'flex-start' }}>
                              <PromptInputModelSelectItem value="qwen3-vl-plus">Qwen3 VL Plus</PromptInputModelSelectItem>
                              <PromptInputModelSelectItem value="qwen3-vl-flash">Qwen3 VL Flash</PromptInputModelSelectItem>
                              <PromptInputModelSelectItem value="qwen3-max">Qwen3 Max</PromptInputModelSelectItem>
                              <PromptInputModelSelectItem value="qwen3-flash">Qwen3 Flash</PromptInputModelSelectItem>
                           </PromptInputModelSelectContent>
                        </PromptInputModelSelect>
                     </div>
                     <button
                        onClick={() => handleSend()}
                        className={cn(
                          "flex items-center gap-2 px-4 py-2 rounded-full transition-all",
                          (input.trim() || attachments.length > 0)
                            ? "bg-black dark:bg-white text-white dark:text-black shadow-lg hover:shadow-xl active:scale-95"
                            : "bg-gray-100 dark:bg-white/10 text-gray-400"
                        )}
                     >
                        {(input.trim() || attachments.length > 0) ? (
                           <>
                              <ArrowUp size={18} />
                              <span className="font-medium text-sm">发送</span>
                           </>
                        ) : (
                           <>
                              <Mic size={18} />
                              <span className="font-medium text-sm">语音</span>
                           </>
                        )}
                     </button>
                  </div>
               </div>
               <input ref={fileInputRef} type="file" accept="image/*,.pdf,.doc,.docx,.txt,.md" multiple className="hidden" onChange={onSelectFiles} />
            </div>
         </div>
      </div>
      <MobileAISettingsModal
        open={settingsOpen}
        onOpenChange={setSettingsOpen}
        onSave={handleSettingsSave}
      />
      {/* Notifications */}
      <div className="fixed top-20 right-4 left-4 z-50 flex flex-col gap-2 pointer-events-none">
        {notices.map(notice => (
          <div key={notice.id} className="pointer-events-auto bg-white dark:bg-[#1a1a1a] rounded-xl shadow-lg border border-gray-100 dark:border-gray-800 p-4 flex items-start gap-3 animate-in slide-in-from-top-2 fade-in">
             {notice.variant === 'loading' && <Loader2 size={20} className="text-blue-500 animate-spin mt-0.5" />}
             {notice.variant === 'success' && <CheckCircle2 size={20} className="text-green-500 mt-0.5" />}
             {notice.variant === 'error' && <AlertCircle size={20} className="text-red-500 mt-0.5" />}
             <div className="flex-1">
                <h3 className="font-medium text-sm">{notice.title}</h3>
                {notice.description && <p className="text-xs text-muted-foreground mt-1">{notice.description}</p>}
             </div>
             <button onClick={() => closeNotice(notice.id)} className="text-gray-400" aria-label="关闭通知"><X size={16} /></button>
          </div>
        ))}
      </div>
    </div>
  )
}
function copyText(text: string) {
  navigator.clipboard.writeText(text)
}

--- FILE: app\(mobile)\dashboard-ios\page.tsx ---

"use client"
import { useEffect, useState, type ElementType } from "react"
import Image from "next/image"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { MobileBackground } from "@/components/mobile-background"
import { LiveStreamPlayer } from "@/components/live-stream-player"
import type { UserPublic } from "@/lib/db/user-service"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { FireIcon, BeakerIcon, BoltIcon, SunIcon, CloudIcon, Bars3Icon } from "@heroicons/react/24/outline"
import { CloudRain, Activity, Sprout } from "lucide-react"
function RoomTabs({ selected, onSelect }: { selected: string; onSelect: (room: string) => void }) {
  const rooms = ["常用", "种植区A", "种植区B", "控制室"]
  return (
    <div className="flex items-center gap-3 overflow-x-auto px-4 py-2 no-scrollbar">
      {rooms.map((room) => {
        const isSelected = selected === room
        return (
          <button
            key={room}
            onClick={() => onSelect(room)}
            className={`whitespace-nowrap px-4 py-1.5 rounded-xl text-sm font-medium transition-all duration-300 ${isSelected
              ? "bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105"
              : "bg-white/60 dark:bg-white/5 text-foreground/70 hover:bg-white/80"
              }`}
          >
            {room}
          </button>
        )
      })}
      <button className="p-2 rounded-full bg-white/60 dark:bg-white/5 text-foreground/70">
        <Bars3Icon className="size-5" />
      </button>
    </div>
  )
}
function StatCard({ icon: Icon, label, value, unit, color, bg }: { icon: ElementType; label: string; value: string | number; unit?: string; color: string; bg: string }) {
  return (
    <div className={`relative rounded-[2rem] p-5 shadow-sm flex flex-col justify-between h-[120px] transition-all duration-300 bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl border border-white/20 dark:border-white/5`}>
      <div className="flex items-start justify-between">
        <div className={`size-10 rounded-full flex items-center justify-center ${bg} text-foreground/80`}>
          <Icon className={`size-5 ${color}`} />
        </div>
        <span className="text-xs text-slate-400 font-medium">{label}</span>
      </div>
      <div className="flex items-end justify-between">
        <div className="text-2xl font-bold text-foreground">
          {value}{unit ? <span className="text-xs font-normal text-muted-foreground ml-1">{unit}</span> : null}
        </div>
      </div>
    </div>
  )
}
export default function DashboardIOSPage() {
  const { deviceData, connectionStatus } = useDeviceData()
  const { weatherData } = useWeatherContext()
  const [user, setUser] = useState<UserPublic | null>(null)
  const [selectedRoom, setSelectedRoom] = useState("常用")
  // Spectral Analysis Logic
  const channels = [
    { id: 'channel1', name: '415', label: 'Violet' },
    { id: 'channel2', name: '445', label: 'Blue' },
    { id: 'channel3', name: '480', label: 'Cyan' },
    { id: 'channel4', name: '515', label: 'Green' },
    { id: 'channel5', name: '555', label: 'Y-G' },
    { id: 'channel6', name: '590', label: 'Yellow' },
    { id: 'channel7', name: '630', label: 'Orange' },
    { id: 'channel8', name: '680', label: 'Red' },
    { id: 'channel9', name: 'NIR', label: 'NIR' },
    { id: 'channel10', name: 'Clr', label: 'Clear' },
    { id: 'channel11', name: 'Fli', label: 'Flicker' },
  ]
  let maxChannel = channels[0]
  let spectralValue = 0
  if (deviceData) {
    maxChannel = channels.reduce((prev, current) => {
      // @ts-ignore
      const prevVal = (deviceData[prev.id] as number) || 0
      // @ts-ignore
      const currVal = (deviceData[current.id] as number) || 0
      return currVal > prevVal ? current : prev
    }, channels[0])
    // @ts-ignore
    spectralValue = deviceData[maxChannel.id] || 0
  }
  // Rainfall
  const todayPrecip = weatherData?.forecast?.forecastday?.[0]?.day?.totalprecip_mm || 0
  useEffect(() => {
    ;(async () => {
      try {
        const res = await fetch("/api/auth/me")
        const data = await res.json()
        if (data?.authenticated && data?.user) setUser(data.user as UserPublic)
      } catch {}
    })()
  }, [])
  return (
    <div className="min-h-screen w-screen bg-slate-50 dark:bg-[#0B1121] text-foreground overflow-hidden font-sans transition-colors duration-500">
      <MobileBackground />
      <div className="relative z-10 h-dvh flex flex-col">
        <div className="px-6 pt-12 pb-4">
          <div className="flex justify-between items-center mb-6">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <h1 className="text-2xl font-bold text-foreground">{user?.username ? `${user.username}的大棚` : '我的大棚'}</h1>
                <div className="flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded-full">
                  <span className="size-1.5 rounded-full bg-blue-500 animate-pulse" />
                  <span className="text-[10px] font-medium text-blue-600 dark:text-blue-400">{connectionStatus.connected ? '设备在线' : '设备离线'}</span>
                </div>
              </div>
            </div>
            <div className="relative size-16 animate-[breathe_4s_ease-in-out_infinite]">
              <Image src="/logo.svg" alt="logo" fill className="object-contain" />
            </div>
          </div>
          <div className="flex justify-between items-center px-2">
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <FireIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">{weatherData?.current?.temp_c ? Math.round(weatherData.current.temp_c) : 24}°C</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">{weatherData?.location?.name || '上城区'}</span>
            </div>
            <div className="w-px h-8 bg-slate-200 dark:bg-slate-800" />
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <BeakerIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">{weatherData?.current?.humidity || 67}%</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">湿度</span>
            </div>
            <div className="w-px h-8 bg-slate-200 dark:bg-slate-800" />
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <BoltIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">良好</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">PM2.5</span>
            </div>
          </div>
        </div>
        <div className="px-4 mb-4">
          <div className="relative bg-[#1a1a1a] dark:bg-[#0a0a0a] rounded-[2rem] overflow-hidden h-[200px] shadow-xl">
            <LiveStreamPlayer
              sources={[
                { src: "webrtc://yidiudiu1.top/live/stravision" },
                { src: "http://yidiudiu1.top/live/stravision.m3u8" },
                { src: "http://yidiudiu1.top/live/stravision.flv" }
              ]}
              licenseUrl={process.env.NEXT_PUBLIC_TCPLAYER_LICENSE_URL}
              autoplay
              muted
              className="absolute inset-0 w-full h-full"
            />
            <div className="absolute top-4 left-4 flex items-center gap-2 bg-red-500/90 backdrop-blur-sm px-3 py-1.5 rounded-full">
              <span className="size-2 rounded-full bg-white animate-pulse" />
              <span className="text-white text-xs font-bold">Live</span>
            </div>
          </div>
        </div>
        <RoomTabs selected={selectedRoom} onSelect={setSelectedRoom} />
        <div className="flex-1 overflow-y-auto px-4 pb-32 no-scrollbar">
          <div className="grid grid-cols-2 gap-4">
            <StatCard icon={FireIcon} label="温度" value={deviceData ? (deviceData.temperature / 10).toFixed(1) : '--'} unit="°C" color="text-orange-500" bg="bg-orange-500/10" />
            <StatCard icon={BeakerIcon} label="湿度" value={deviceData ? (deviceData.humidity / 10).toFixed(1) : '--'} unit="%" color="text-blue-500" bg="bg-blue-500/10" />
            <StatCard icon={SunIcon} label="光照" value={deviceData ? deviceData.light : '--'} unit="lux" color="text-yellow-500" bg="bg-yellow-500/10" />
            <StatCard icon={CloudIcon} label="CO₂" value={deviceData ? deviceData.co2 : '--'} unit="ppm" color="text-teal-500" bg="bg-teal-500/10" />
            <StatCard icon={BoltIcon} label="土壤电导" value={deviceData ? deviceData.earth_ec : '--'} unit="μS/cm" color="text-purple-500" bg="bg-purple-500/10" />
            <StatCard icon={BeakerIcon} label="土壤水分" value={deviceData ? deviceData.earth_water.toFixed(1) : '--'} unit="%" color="text-green-500" bg="bg-green-500/10" />
            <StatCard icon={FireIcon} label="土壤温度" value={deviceData ? deviceData.earth_temp.toFixed(1) : '--'} unit="°C" color="text-rose-500" bg="bg-rose-500/10" />
            {/* New Dimensions to match PC */}
            <StatCard icon={Sprout} label="氮含量 (N)" value={deviceData ? deviceData.earth_n : '--'} unit="mg/kg" color="text-purple-500" bg="bg-purple-500/10" />
            <StatCard icon={Sprout} label="磷含量 (P)" value={deviceData ? deviceData.earth_p : '--'} unit="mg/kg" color="text-pink-500" bg="bg-pink-500/10" />
            <StatCard icon={Sprout} label="钾含量 (K)" value={deviceData ? deviceData.earth_k : '--'} unit="mg/kg" color="text-amber-500" bg="bg-amber-500/10" />
            <StatCard
              icon={Activity}
              label="光谱峰值"
              value={deviceData ? `${maxChannel.label}` : '--'}
              unit={deviceData ? `${spectralValue.toFixed(0)}` : ''}
              color="text-indigo-500"
              bg="bg-indigo-500/10"
            />
            <StatCard
              icon={CloudRain}
              label="今日降雨"
              value={todayPrecip.toFixed(1)}
              unit="mm"
              color="text-cyan-500"
              bg="bg-cyan-500/10"
            />
          </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: app\(mobile)\device-control-ios\page.tsx ---

"use client"
import { useEffect, useState } from "react"
import Link from "next/link"
import Image from "next/image"
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useDeviceControl } from "@/lib/hooks/use-device-control"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import {
  LightBulbIcon,
  SunIcon,
  BeakerIcon,
  CloudIcon,
  FireIcon,
  PlusIcon,
  Bars3Icon,
  ArrowPathIcon,
  BoltIcon
} from "@heroicons/react/24/outline"
import type { UserPublic } from "@/lib/db/user-service"
import { MobileBackground } from "@/components/mobile-background"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { motion } from "framer-motion"
import { WeatherCard } from "@/components/weather-card"
// --- Components ---
function RoomTabs({ selected, onSelect }: { selected: string; onSelect: (room: string) => void }) {
  const rooms = ["全部设备", "种植区A", "种植区B", "控制室"]
  return (
    <div className="flex items-center gap-3 overflow-x-auto px-4 py-2 no-scrollbar">
      {rooms.map((room) => {
        const isSelected = selected === room
        return (
          <button
            key={room}
            onClick={() => onSelect(room)}
            className={`whitespace-nowrap px-4 py-1.5 rounded-xl text-sm font-medium transition-all duration-300 ${isSelected
              ? "bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105"
              : "bg-white/60 dark:bg-white/5 text-foreground/70 hover:bg-white/80"
              }`}
          >
            {room}
          </button>
        )
      })}
      <button className="p-2 rounded-full bg-white/40 dark:bg-black/20 text-foreground/70">
        <Bars3Icon className="size-5" />
      </button>
    </div>
  )
}
function DeviceCard({
  title,
  subtitle,
  icon: Icon,
  isOn,
  onToggle,
  room,
  className = "",
  disabled = false
}: {
  title: string;
  subtitle: string;
  icon: any;
  isOn: boolean;
  onToggle?: () => void;
  room: string;
  className?: string;
  disabled?: boolean;
}) {
  return (
    <div className={`relative bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl rounded-[2rem] p-5 shadow-sm border border-white/20 dark:border-white/5 flex flex-col justify-between h-[160px] transition-all duration-300 ${className}`}>
      <div className="flex justify-between items-start">
        <div className={`size-12 rounded-full flex items-center justify-center transition-colors duration-300 ${isOn ? 'bg-blue-50 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}`}>
          <Icon className="size-7" />
        </div>
        <span className="text-xs text-slate-400 font-medium">{room}</span>
      </div>
      <div>
        <h3 className="text-base font-bold text-foreground mb-1">{title}</h3>
        <div className="flex items-center justify-between">
          <span className={`text-xs font-medium transition-colors duration-300 ${isOn ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400'}`}>
            {subtitle}
          </span>
          {onToggle && (
            <button
              onClick={(e) => { e.stopPropagation(); if (!disabled) onToggle(); }}
              disabled={disabled}
              className={`w-12 h-7 rounded-full relative transition-colors duration-300 ${isOn ? 'bg-blue-600' : 'bg-slate-300 dark:bg-slate-700'} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              <div className={`absolute top-1 size-5 rounded-full transition-all duration-300 ${isOn ? 'left-[22px] bg-white' : 'left-1 bg-white'}`} />
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
function SliderRow({ label, value, onChange, color, displayValue }: { label: string; value: number; onChange: (v: number) => void; color: string; displayValue?: string }) {
  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <span className="text-xs text-muted-foreground font-medium">{label}</span>
        <span className="text-sm font-bold text-foreground">{displayValue || value}</span>
      </div>
      <input type="range" min={0} max={255} value={value} onChange={(e) => onChange(parseInt(e.target.value))} className="w-full h-2 rounded-full appearance-none cursor-pointer bg-muted [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:shadow" style={{ background: `linear-gradient(to right, ${color} 0%, ${color} ${(value / 255) * 100}%, var(--muted) ${(value / 255) * 100}%, var(--muted) 100%)` }} />
    </div>
  )
}
export default function DeviceControlIOSPage() {
  const { deviceData, connectionStatus } = useDeviceData()
  const { status: controlStatus, toggleRelay, setLEDs } = useDeviceControl()
  const { weatherData } = useWeatherContext()
  const [user, setUser] = useState<UserPublic | null>(null)
  const [selectedRoom, setSelectedRoom] = useState("全部设备")
  const [localR, setLocalR] = useState<number | null>(null)
  const [localG, setLocalG] = useState<number | null>(null)
  const [localB, setLocalB] = useState<number | null>(null)
  const [localW, setLocalW] = useState<number | null>(null)
  useEffect(() => {
    ; (async () => {
      try {
        const res = await fetch("/api/auth/me")
        const data = await res.json()
        if (data?.authenticated && data?.user) setUser(data.user as UserPublic)
      } catch { }
    })()
  }, [])
  const r = (localR ?? deviceData?.led1 ?? 0)
  const g = (localG ?? deviceData?.led2 ?? 0)
  const b = (localB ?? deviceData?.led3 ?? 0)
  const w = (localW ?? deviceData?.led4 ?? 0)
  const handleRelayToggle = async (relayNum: number) => {
    if (!deviceData) return
    const currentState = (deviceData[`relay${relayNum}` as keyof typeof deviceData] as number) || 0
    await toggleRelay(relayNum, currentState)
  }
  const handleLEDUpdate = async () => {
    await setLEDs(r, g, b, w)
  }
  return (
    <div className="min-h-screen w-screen bg-slate-50 dark:bg-[#0B1121] text-foreground overflow-hidden font-sans transition-colors duration-500">
      {/* Background blobs */}
      <div className="fixed top-[-20%] right-[-20%] w-[80%] h-[60%] rounded-full bg-blue-200/20 dark:bg-blue-900/10 blur-[100px] pointer-events-none" />
      <div className="fixed top-[20%] left-[-20%] w-[60%] h-[60%] rounded-full bg-indigo-200/20 dark:bg-indigo-900/10 blur-[100px] pointer-events-none" />
      <div className="relative z-10 h-dvh flex flex-col">
        {/* Header */}
        <div className="px-6 pt-12 pb-4">
          <div className="flex justify-between items-center mb-6">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <h1 className="text-2xl font-bold text-foreground">{user?.username ? `${user.username}的大棚` : '我的大棚'}</h1>
                <div className="flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded-full">
                  <span className="size-1.5 rounded-full bg-blue-500 animate-pulse" />
                  <span className="text-[10px] font-medium text-blue-600 dark:text-blue-400">
                    {connectionStatus.connected ? '设备在线' : '设备离线'}
                  </span>
                </div>
              </div>
            </div>
            <div className="relative size-16 animate-[breathe_4s_ease-in-out_infinite]">
              <Image src="/logo.svg" alt="logo" fill className="object-contain" />
            </div>
          </div>
          {/* Weather Row */}
          <div className="flex justify-between items-center px-2">
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <FireIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">{weatherData?.current?.temp_c ? Math.round(weatherData.current.temp_c) : 24}°C</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">{weatherData?.location?.name || '上城区'}</span>
            </div>
            <div className="w-px h-8 bg-slate-200 dark:bg-slate-800" />
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <BeakerIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">{weatherData?.current?.humidity || 67}%</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">湿度</span>
            </div>
            <div className="w-px h-8 bg-slate-200 dark:bg-slate-800" />
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <BoltIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">良好</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">PM2.5</span>
            </div>
          </div>
        </div>
        {/* Room Tabs */}
        <RoomTabs selected={selectedRoom} onSelect={setSelectedRoom} />
        {/* Device Grid */}
        <div className="flex-1 overflow-y-auto px-4 py-6 pb-32 no-scrollbar" id="mobile-control-grid">
          <div className="grid grid-cols-2 gap-4">
            {/* Relay 5: Water Pump */}
            <DeviceCard
              title="水泵"
              subtitle={deviceData?.relay5 === 1 ? "运行中" : "已停止"}
              icon={BeakerIcon}
              isOn={deviceData?.relay5 === 1}
              onToggle={() => handleRelayToggle(5)}
              room="种植区"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* Relay 6: Fan */}
            <DeviceCard
              title="风扇"
              subtitle={deviceData?.relay6 === 1 ? "运行中" : "已停止"}
              icon={ArrowPathIcon}
              isOn={deviceData?.relay6 === 1}
              onToggle={() => handleRelayToggle(6)}
              room="种植区"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* Relay 7: Grow Light */}
            <DeviceCard
              title="补光灯"
              subtitle={deviceData?.relay7 === 1 ? "ON" : "OFF"}
              icon={BoltIcon}
              isOn={deviceData?.relay7 === 1}
              onToggle={() => handleRelayToggle(7)}
              room="种植区"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* Relay 8: White Light */}
            <DeviceCard
              title="白灯"
              subtitle={deviceData?.relay8 === 1 ? "ON" : "OFF"}
              icon={SunIcon}
              isOn={deviceData?.relay8 === 1}
              onToggle={() => handleRelayToggle(8)}
              room="控制室"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* RGB Control Card */}
            <div className="col-span-2 bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl rounded-[2rem] p-5 shadow-sm border border-white/20 dark:border-white/5">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <div className="size-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-400">
                    <LightBulbIcon className="size-6" />
                  </div>
                  <div>
                    <h3 className="text-base font-bold text-foreground">补光灯 (RGB)</h3>
                    <span className="text-xs text-slate-400 font-medium">控制室</span>
                  </div>
                </div>
                <div className="w-12 h-6 rounded-full border border-border" style={{ backgroundColor: `rgb(${r}, ${g}, ${b})` }} />
              </div>
              <div className="space-y-3">
                <SliderRow label="红色" value={r} onChange={setLocalR} color="#ef4444" />
                <SliderRow label="绿色" value={g} onChange={setLocalG} color="#22c55e" />
                <SliderRow label="蓝色" value={b} onChange={setLocalB} color="#3b82f6" />
                <SliderRow label="亮度 (占空比)" value={w} onChange={setLocalW} color="#f59e0b" displayValue={`${Math.round((w / 255) * 100)}%`} />
              </div>
              <div className="flex justify-end mt-4">
                <Button onClick={handleLEDUpdate} disabled={controlStatus.loading || !connectionStatus.connected} size="sm" className="rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/20">
                  {controlStatus.loading ? "..." : "更新颜色"}
                </Button>
              </div>
            </div>
            {/* Sensors (Read Only) */}
            <DeviceCard
              title="温湿度"
              subtitle="传感器"
              icon={FireIcon}
              isOn={true}
              room="种植区"
              disabled={true}
            />
            <DeviceCard
              title="CO₂"
              subtitle="传感器"
              icon={CloudIcon}
              isOn={true}
              room="种植区"
              disabled={true}
            />
            {/* Weather Card */}
            <div className="col-span-2 mt-4">
              <WeatherCard deviceData={deviceData} />
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: app\(mobile)\layout.tsx ---

import { MobileBottomNav } from "@/components/mobile-bottom-nav"
import { MobileOnboardingGuide } from "@/components/mobile-onboarding-guide"
export default function MobileLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <>
      {children}
      <MobileBottomNav />
      <MobileOnboardingGuide />
    </>
  )
}

--- FILE: app\(mobile)\monitor-ios\page.tsx ---

"use client"
import { useEffect, useState, type ElementType } from "react"
import Image from "next/image"
import { Badge } from "@/components/ui/badge"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useDeviceControl } from "@/lib/hooks/use-device-control"
import {
  LightBulbIcon,
  SpeakerWaveIcon,
  PlusIcon,
  Bars3Icon,
  FireIcon,
  BeakerIcon,
  BoltIcon,
  PlayIcon,
  SpeakerXMarkIcon,
  ArrowsPointingOutIcon,
  SunIcon,
  ArrowPathIcon,
  CloudIcon
} from "@heroicons/react/24/outline"
import type { UserPublic } from "@/lib/db/user-service"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { LiveStreamPlayer } from "@/components/live-stream-player"
import { UpdateAnnouncement } from "@/components/update-announcement"
// --- Components ---
function RoomTabs({ selected, onSelect }: { selected: string; onSelect: (room: string) => void }) {
  const rooms = ["常用", "种植区A", "种植区B", "控制室"]
  return (
    <div className="flex items-center gap-3 overflow-x-auto px-4 py-2 no-scrollbar">
      {rooms.map((room) => {
        const isSelected = selected === room
        return (
          <button
            key={room}
            onClick={() => onSelect(room)}
            className={`whitespace-nowrap px-4 py-1.5 rounded-xl text-sm font-medium transition-all duration-300 ${isSelected
              ? "bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105"
              : "bg-white/60 dark:bg-white/5 text-foreground/70 hover:bg-white/80"
              }`}
          >
            {room}
          </button>
        )
      })}
      <button className="p-2 rounded-full bg-white/60 dark:bg-white/5 text-foreground/70">
        <Bars3Icon className="size-5" />
      </button>
    </div>
  )
}
function DeviceCard({
  title,
  subtitle,
  icon: Icon,
  isOn,
  onToggle,
  room,
  className = "",
  disabled = false
}: {
  title: string;
  subtitle: string;
  icon: ElementType;
  isOn: boolean;
  onToggle?: () => void;
  room: string;
  className?: string;
  disabled?: boolean;
}) {
  return (
    <div className={`relative rounded-[2rem] p-5 shadow-sm flex flex-col justify-between h-[160px] transition-all duration-300 ${isOn
      ? 'bg-[#2c3e50] dark:bg-[#1e2936]'
      : 'bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl border border-white/20 dark:border-white/5'
      } ${className}`}>
      <div className="flex justify-between items-start">
        <div className={`size-12 rounded-full flex items-center justify-center transition-colors duration-300 ${isOn
          ? 'bg-blue-500/20 text-blue-300'
          : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400'
          }`}>
          <Icon className="size-7" />
        </div>
        <span className={`text-xs font-medium ${isOn ? 'text-blue-200/70' : 'text-slate-400'}`}>{room}</span>
      </div>
      <div>
        <h3 className={`text-base font-bold mb-1 ${isOn ? 'text-white' : 'text-foreground'}`}>{title}</h3>
        <div className="flex items-center justify-between">
          <span className={`text-xs font-medium transition-colors duration-300 ${isOn ? 'text-blue-200/80' : 'text-slate-400'
            }`}>
            {subtitle}
          </span>
          {onToggle && (
            <button
              onClick={(e) => { e.stopPropagation(); if (!disabled) onToggle(); }}
              disabled={disabled}
              className={`w-12 h-7 rounded-full relative transition-colors duration-300 ${isOn ? 'bg-blue-600' : 'bg-slate-300 dark:bg-slate-700'
                } ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              <div className={`absolute top-1 size-5 rounded-full transition-all duration-300 ${isOn ? 'left-[22px] bg-white' : 'left-1 bg-white'
                }`} />
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
export default function MonitorIOSPage() {
  const { deviceData, connectionStatus } = useDeviceData()
  const { status: controlStatus, toggleRelay } = useDeviceControl()
  const { weatherData } = useWeatherContext()
  const [user, setUser] = useState<UserPublic | null>(null)
  const [selectedRoom, setSelectedRoom] = useState("常用")
  useEffect(() => {
    ; (async () => {
      try {
        const res = await fetch("/api/auth/me")
        const data = await res.json()
        if (data?.authenticated && data?.user) setUser(data.user as UserPublic)
      } catch { }
    })()
  }, [])
  const handleRelayToggle = async (relayNum: number) => {
    if (!deviceData) return
    const currentState = (deviceData[`relay${relayNum}` as keyof typeof deviceData] as number) || 0
    await toggleRelay(relayNum, currentState)
  }
  // Count active devices
  const activeCount = [
    deviceData?.relay5,
    deviceData?.relay6,
    deviceData?.relay7,
    deviceData?.relay8
  ].filter(state => state === 1).length
  return (
    <div className="min-h-screen w-screen bg-slate-50 dark:bg-[#0B1121] text-foreground overflow-hidden font-sans transition-colors duration-500">
      <UpdateAnnouncement />
      {/* Background blobs */}
      <div className="fixed top-[-20%] right-[-20%] w-[80%] h-[60%] rounded-full bg-blue-200/20 dark:bg-blue-900/10 blur-[100px] pointer-events-none" />
      <div className="fixed top-[20%] left-[-20%] w-[60%] h-[60%] rounded-full bg-indigo-200/20 dark:bg-indigo-900/10 blur-[100px] pointer-events-none" />
      <div className="relative z-10 h-dvh flex flex-col">
        {/* Header */}
        <div className="px-6 pt-12 pb-4">
          <div className="flex justify-between items-center mb-6">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <h1 className="text-2xl font-bold text-foreground">{user?.username ? `${user.username}的大棚` : '我的大棚'}</h1>
                <div className="flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded-full">
                  <span className="size-1.5 rounded-full bg-blue-500 animate-pulse" />
                  <span className="text-[10px] font-medium text-blue-600 dark:text-blue-400">
                    {connectionStatus.connected ? '设备在线' : '设备离线'}
                  </span>
                </div>
              </div>
            </div>
            <div className="relative size-16 animate-[breathe_4s_ease-in-out_infinite]">
              <Image src="/logo.svg" alt="logo" fill className="object-contain" />
            </div>
          </div>
          {/* Weather Row */}
          <div className="flex justify-between items-center px-2" id="mobile-weather-row">
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <FireIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">{weatherData?.current?.temp_c ? Math.round(weatherData.current.temp_c) : 24}°C</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">{weatherData?.location?.name || '上城区'}</span>
            </div>
            <div className="w-px h-8 bg-slate-200 dark:bg-slate-800" />
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <BeakerIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">{weatherData?.current?.humidity || 67}%</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">湿度</span>
            </div>
            <div className="w-px h-8 bg-slate-200 dark:bg-slate-800" />
            <div className="flex flex-col items-center">
              <div className="flex items-center gap-1 text-foreground">
                <BoltIcon className="size-5 text-blue-500" />
                <span className="text-2xl font-bold">良好</span>
              </div>
              <span className="text-xs text-slate-400 mt-1">PM2.5</span>
            </div>
          </div>
        </div>
        <div className="px-4 mb-4">
          <div className="relative bg-[#1a1a1a] dark:bg-[#0a0a0a] rounded-[2rem] overflow-hidden h-[200px] shadow-xl" id="mobile-video-player">
            <LiveStreamPlayer
              sources={[
                { src: "webrtc://223897.push.tlivecloud.com/live/stravision?txSecret=9f7996a9d4295232332d40ab868648c5&txTime=69297772" },
                { src: "http://yidiudiu1.top/live/stravision.m3u8" },
                { src: "http://yidiudiu1.top/live/stravision.flv" }
              ]}
              licenseUrl={process.env.NEXT_PUBLIC_TCPLAYER_LICENSE_URL}
              autoplay
              muted
              controls={false}
              className="absolute inset-0 w-full h-full"
            />
            {/* Live Badge */}
            <div className="absolute top-4 left-4 flex items-center gap-2 bg-red-500/90 backdrop-blur-sm px-3 py-1.5 rounded-full">
              <span className="size-2 rounded-full bg-white animate-pulse" />
              <span className="text-white text-xs font-bold">Live</span>
            </div>
            {/* Location Tag */}
            <div className="absolute top-4 right-4 bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-full">
              <span className="text-white text-xs font-medium">1号机</span>
            </div>
            {/* Controls */}
            <div className="absolute bottom-4 right-4 flex items-center gap-2">
              <button className="size-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center hover:bg-white/20 transition-colors">
                <SpeakerXMarkIcon className="size-5 text-white" />
              </button>
              <button className="size-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center hover:bg-white/20 transition-colors">
                <ArrowsPointingOutIcon className="size-5 text-white" />
              </button>
            </div>
          </div>
        </div>
        {/* Room Tabs */}
        <div id="mobile-room-tabs">
            <RoomTabs selected={selectedRoom} onSelect={setSelectedRoom} />
        </div>
        {/* Execution Devices Section */}
        <div className="px-4 py-2">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-base font-bold text-foreground">执行设备 <span className="text-sm text-slate-400">({activeCount}台设备运行中)</span></h2>
            <button className="text-blue-600 text-sm font-medium">+</button>
          </div>
        </div>
        {/* Device Grid */}
        <div className="flex-1 overflow-y-auto px-4 pb-32 no-scrollbar" id="mobile-device-grid">
          <div className="grid grid-cols-2 gap-4">
            {/* Relay 5: Water Pump */}
            <DeviceCard
              title="水泵"
              subtitle={deviceData?.relay5 === 1 ? "运行中" : "已停止"}
              icon={BeakerIcon}
              isOn={deviceData?.relay5 === 1}
              onToggle={() => handleRelayToggle(5)}
              room="种植区"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* Relay 6: Fan */}
            <DeviceCard
              title="风扇"
              subtitle={deviceData?.relay6 === 1 ? "运行中" : "已停止"}
              icon={ArrowPathIcon}
              isOn={deviceData?.relay6 === 1}
              onToggle={() => handleRelayToggle(6)}
              room="种植区"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* Relay 7: Grow Light */}
            <DeviceCard
              title="补光灯"
              subtitle={deviceData?.relay7 === 1 ? "ON" : "OFF"}
              icon={BoltIcon}
              isOn={deviceData?.relay7 === 1}
              onToggle={() => handleRelayToggle(7)}
              room="种植区"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
            {/* Relay 8: White Light */}
            <DeviceCard
              title="白灯"
              subtitle={deviceData?.relay8 === 1 ? "ON" : "OFF"}
              icon={SunIcon}
              isOn={deviceData?.relay8 === 1}
              onToggle={() => handleRelayToggle(8)}
              room="控制室"
              disabled={controlStatus.loading || !connectionStatus.connected}
            />
          </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: app\(mobile)\profile-ios\page.tsx ---

"use client"
import { useEffect, useState } from "react"
import Image from "next/image"
import Link from "next/link"
import { useRouter } from "next/navigation"
import { Card } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Switch } from "@/components/ui/switch"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import type { UserPublic } from "@/lib/db/user-service"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import {
  ChevronRight,
  Smartphone,
  Bell,
  Activity,
  Shield,
  HelpCircle,
  LogOut,
  Settings,
  Zap,
  Leaf,
  ThermometerSun,
  Camera,
  Info
} from "lucide-react"
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
export default function ProfilePage() {
  const router = useRouter()
  const [user, setUser] = useState<UserPublic | null>(null)
  const [loading, setLoading] = useState(true)
  const [devices, setDevices] = useState<{ id: string; name: string }[]>([])
  const [newDeviceId, setNewDeviceId] = useState("")
  const [newDeviceName, setNewDeviceName] = useState("")
  const [notif, setNotif] = useState<{ alerts: boolean; status: boolean; ai: boolean; updates: boolean }>({ alerts: true, status: true, ai: false, updates: true })
  const [activity, setActivity] = useState<{ ts: number; text: string }[]>([])
  const { connectionStatus } = useDeviceData()
  useEffect(() => {
    let mounted = true
    ;(async () => {
      try {
        const res = await fetch("/api/auth/me")
        const data = await res.json()
        if (!mounted) return
        if (data?.authenticated && data?.user) {
          setUser(data.user as UserPublic)
        } else {
          router.replace("/login")
        }
      } catch {
        router.replace("/login")
      } finally {
        if (mounted) setLoading(false)
      }
    })()
    return () => { mounted = false }
  }, [router])
  useEffect(() => {
    try {
      const ds = JSON.parse(localStorage.getItem("profile_devices") || "[]")
      const ns = JSON.parse(localStorage.getItem("profile_notifications") || "{}")
      const as = JSON.parse(localStorage.getItem("profile_activity") || "[]")
      if (Array.isArray(ds)) setDevices(ds)
      setNotif({ alerts: !!ns.alerts, status: !!ns.status, ai: !!ns.ai, updates: ns.updates !== false })
      if (Array.isArray(as)) setActivity(as)
    } catch {}
  }, [])
  const persistDevices = (list: { id: string; name: string }[]) => {
    setDevices(list)
    try { localStorage.setItem("profile_devices", JSON.stringify(list)) } catch {}
  }
  const persistNotif = (n: { alerts: boolean; status: boolean; ai: boolean; updates: boolean }) => {
    setNotif(n)
    try { localStorage.setItem("profile_notifications", JSON.stringify(n)) } catch {}
  }
  const addActivity = (text: string) => {
    const item = { ts: Date.now(), text }
    const next = [item, ...activity].slice(0, 20)
    setActivity(next)
    try { localStorage.setItem("profile_activity", JSON.stringify(next)) } catch {}
  }
  const addDevice = () => {
    const id = newDeviceId.trim()
    const name = newDeviceName.trim() || `设备 ${id || devices.length + 1}`
    if (!id) return
    const next = [...devices, { id, name }]
    persistDevices(next)
    setNewDeviceId("")
    setNewDeviceName("")
    addActivity(`绑定设备 ${name}(${id})`)
  }
  const removeDevice = (id: string) => {
    const target = devices.find(d => d.id === id)
    const next = devices.filter(d => d.id !== id)
    persistDevices(next)
    if (target) addActivity(`解除绑定 ${target.name}(${target.id})`)
  }
  if (loading) return null
  if (!user) return null
  // Helper component for list items
  const ListItem = ({ icon: Icon, title, onClick, color = "text-blue-600 dark:text-white" }: { icon: any, title: string, onClick?: () => void, color?: string }) => (
    <div
      onClick={onClick}
      className="flex items-center justify-between p-4 cursor-pointer active:bg-slate-50 dark:active:bg-slate-800 transition-colors"
    >
      <div className="flex items-center gap-3">
        <Icon className={`size-5 ${color}`} />
        <span className="text-[15px] font-medium text-foreground">{title}</span>
      </div>
      <ChevronRight className="size-5 text-slate-300 dark:text-slate-600" />
    </div>
  )
  return (
    <div className="min-h-screen w-full bg-slate-50 dark:bg-[#0B1121] pb-32 font-sans transition-colors duration-500">
      {/* Background blobs */}
      <div className="fixed top-[-20%] right-[-20%] w-[80%] h-[60%] rounded-full bg-blue-200/20 dark:bg-blue-900/10 blur-[100px] pointer-events-none" />
      <div className="fixed top-[20%] left-[-20%] w-[60%] h-[60%] rounded-full bg-indigo-200/20 dark:bg-indigo-900/10 blur-[100px] pointer-events-none" />
      {/* Header Section */}
      <div className="relative z-10 px-5 pt-12 pb-6">
        <h1 className="text-xl font-bold text-foreground mb-4">我的账户</h1>
        {/* User Card */}
        <div className="bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl rounded-[24px] p-4 flex items-center gap-4 shadow-sm border border-white/20 dark:border-white/5">
          <Avatar className="size-14 border-2 border-blue-100 dark:border-blue-900">
            <AvatarImage src={user.avatar_url || undefined} />
            <AvatarFallback className="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400">
              {user.username?.[0]?.toUpperCase()}
            </AvatarFallback>
          </Avatar>
          <div className="flex-1 min-w-0">
            <h2 className="text-lg font-bold text-foreground truncate">{user.username}</h2>
            <p className="text-xs text-slate-500 dark:text-slate-400 truncate">{user.email}</p>
          </div>
          <Link href="/settings">
            <Button variant="secondary" className="rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-xs h-8 px-4 text-foreground font-medium shadow-none border border-slate-200 dark:border-slate-700">
              编辑资料
            </Button>
          </Link>
        </div>
      </div>
      {/* Quick Toggles (Pills) */}
      <div className="relative z-10 px-5 mb-6">
        <h3 className="text-sm font-bold text-foreground mb-3">快捷通知</h3>
        <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
          <button
            onClick={() => persistNotif({ ...notif, alerts: !notif.alerts })}
            className={`flex-1 h-10 rounded-full text-xs font-bold transition-all px-4 whitespace-nowrap ${
              notif.alerts
                ? "bg-blue-600 text-white shadow-lg shadow-blue-500/30"
                : "bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl text-slate-600 dark:text-slate-400 border border-white/20 dark:border-white/5"
            }`}
          >
            重要告警
          </button>
          <button
            onClick={() => persistNotif({ ...notif, status: !notif.status })}
            className={`flex-1 h-10 rounded-full text-xs font-bold transition-all px-4 whitespace-nowrap ${
              notif.status
                ? "bg-blue-600 text-white shadow-lg shadow-blue-500/30"
                : "bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl text-slate-600 dark:text-slate-400 border border-white/20 dark:border-white/5"
            }`}
          >
            设备状态
          </button>
          <button
            onClick={() => persistNotif({ ...notif, ai: !notif.ai })}
            className={`flex-1 h-10 rounded-full text-xs font-bold transition-all px-4 whitespace-nowrap ${
              notif.ai
                ? "bg-blue-600 text-white shadow-lg shadow-blue-500/30"
                : "bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl text-slate-600 dark:text-slate-400 border border-white/20 dark:border-white/5"
            }`}
          >
            AI 建议
          </button>
        </div>
      </div>
      {/* Status Card */}
      <div className="relative z-10 px-5 mb-6">
        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[24px] p-5 flex items-center justify-between shadow-lg shadow-blue-500/20 text-white relative overflow-hidden">
           <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl pointer-events-none" />
           <div className="relative z-10">
             <div className="flex items-center gap-2 mb-1">
               <Badge className="bg-white/20 hover:bg-white/20 border-none text-white backdrop-blur-md px-2 py-0.5 text-[10px]">
                 {connectionStatus.connected ? "已连接" : "离线"}
               </Badge>
             </div>
             <h3 className="text-lg font-bold">Stravision Pro</h3>
             <p className="text-xs text-white/80 mt-1">您正在享受完整的智能农业服务</p>
           </div>
           <div className="relative z-10 bg-white/20 p-2 rounded-full backdrop-blur-md">
             <Zap className="size-6 text-white" fill="currentColor" />
           </div>
        </div>
      </div>
      {/* Settings Group 1 */}
      <div className="relative z-10 px-5 mb-6">
        <div className="bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl rounded-[24px] overflow-hidden shadow-sm border border-white/20 dark:border-white/5">
          <Sheet>
            <SheetTrigger asChild>
              <div><ListItem icon={Smartphone} title="设备管理" /></div>
            </SheetTrigger>
            <SheetContent side="bottom" className="h-[80vh] rounded-t-[2rem]">
              <SheetHeader className="mb-6">
                <SheetTitle>设备管理</SheetTitle>
                <SheetDescription>添加或移除您的物联网设备</SheetDescription>
              </SheetHeader>
              <div className="space-y-6">
                <div className="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl space-y-3">
                  <Label>绑定新设备</Label>
                  <div className="grid gap-3">
                    <Input value={newDeviceId} onChange={e => setNewDeviceId(e.target.value)} placeholder="设备编号 (如 SN-001)" className="bg-white dark:bg-black" />
                    <Input value={newDeviceName} onChange={e => setNewDeviceName(e.target.value)} placeholder="设备名称" className="bg-white dark:bg-black" />
                    <Button onClick={addDevice} className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-xl">确认绑定</Button>
                  </div>
                </div>
                <div className="space-y-3">
                  <Label>已绑定设备</Label>
                  {devices.length === 0 ? (
                    <div className="text-center py-8 text-slate-400 text-sm bg-slate-50 dark:bg-slate-900 rounded-xl border border-dashed dark:border-slate-800">暂无设备</div>
                  ) : (
                    devices.map(d => (
                      <div key={d.id} className="flex items-center justify-between p-3 bg-white dark:bg-black border dark:border-slate-800 rounded-xl shadow-sm">
                        <div className="flex items-center gap-3">
                           <div className="size-8 rounded-lg bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-500">
                             <Smartphone size={16} />
                           </div>
                           <div>
                             <div className="font-medium text-sm">{d.name}</div>
                             <div className="text-xs text-slate-400">{d.id}</div>
                           </div>
                        </div>
                        <Button variant="ghost" size="sm" onClick={() => removeDevice(d.id)} className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">移除</Button>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </SheetContent>
          </Sheet>
          <div className="h-px bg-slate-100 dark:bg-slate-800 mx-4" />
          <Sheet>
            <SheetTrigger asChild>
              <div><ListItem icon={Bell} title="通知设置" /></div>
            </SheetTrigger>
            <SheetContent side="bottom" className="rounded-t-[2rem]">
              <SheetHeader className="mb-6">
                <SheetTitle>通知设置</SheetTitle>
              </SheetHeader>
              <div className="space-y-4">
                 {[
                   { id: "alerts", label: "重要告警", icon: Shield },
                   { id: "status", label: "设备状态", icon: Zap },
                   { id: "ai", label: "AI 建议", icon: Leaf },
                   { id: "updates", label: "系统更新", icon: Bell },
                 ].map(item => (
                   <div key={item.id} className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl">
                     <div className="flex items-center gap-3">
                       <item.icon className="size-5 text-blue-600 dark:text-white" />
                       <span className="font-medium">{item.label}</span>
                     </div>
                     <Switch
                        checked={notif[item.id as keyof typeof notif]}
                        onCheckedChange={(v) => {
                          const next = { ...notif, [item.id]: v }
                          persistNotif(next)
                          addActivity(`更新通知设置: ${item.label} ${v ? "开启" : "关闭"}`)
                        }}
                     />
                   </div>
                 ))}
              </div>
            </SheetContent>
          </Sheet>
          <div className="h-px bg-slate-100 dark:bg-slate-800 mx-4" />
          <Sheet>
            <SheetTrigger asChild>
              <div><ListItem icon={Activity} title="活动日志" /></div>
            </SheetTrigger>
            <SheetContent side="bottom" className="h-[70vh] rounded-t-[2rem]">
              <SheetHeader className="mb-6">
                <SheetTitle>最近活动</SheetTitle>
              </SheetHeader>
              <div className="overflow-y-auto h-full pb-20 space-y-4">
                {activity.length === 0 ? (
                  <div className="text-center text-slate-400 py-10">暂无活动记录</div>
                ) : (
                  activity.map((item, i) => (
                    <div key={i} className="flex gap-4">
                       <div className="flex flex-col items-center">
                         <div className="size-2 rounded-full bg-blue-500 mt-2" />
                         {i !== activity.length - 1 && <div className="w-0.5 flex-1 bg-slate-100 dark:bg-slate-800 my-1" />}
                       </div>
                       <div className="pb-4">
                         <div className="text-sm font-medium text-foreground">{item.text}</div>
                         <div className="text-xs text-slate-400 mt-1">{new Date(item.ts).toLocaleString()}</div>
                       </div>
                    </div>
                  ))
                )}
              </div>
            </SheetContent>
          </Sheet>
        </div>
      </div>
      {/* Settings Group 2 */}
      <div className="relative z-10 px-5 mb-6">
        <div className="bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl rounded-[24px] overflow-hidden shadow-sm border border-white/20 dark:border-white/5">
          <ListItem icon={Shield} title="隐私与安全" />
          <div className="h-px bg-slate-100 dark:bg-slate-800 mx-4" />
          <Dialog>
            <DialogTrigger asChild>
              <div><ListItem icon={Info} title="关于" /></div>
            </DialogTrigger>
            <DialogContent className="w-[85%] rounded-3xl bg-white/95 dark:bg-[#111827]/95 backdrop-blur-xl border-white/20 dark:border-white/5">
              <DialogHeader>
                <DialogTitle className="text-center">关于</DialogTitle>
              </DialogHeader>
              <div className="flex flex-col items-center py-4">
                <div className="size-24 bg-blue-50 dark:bg-blue-900/20 rounded-3xl flex items-center justify-center mb-4">
                  <Image src="/logo.svg" alt="Logo" width={48} height={48} className="size-12" />
                </div>
                <h3 className="text-xl font-bold mb-1">Stravision IoT</h3>
                <p className="text-sm text-slate-500 mb-8">Version 1.0.0</p>
                <Button
                  className="w-full bg-slate-100 dark:bg-slate-800 text-foreground hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl h-12 shadow-none border border-slate-200 dark:border-slate-700"
                  onClick={() => addActivity("检查更新: 已是最新版本")}
                >
                  检查更新
                </Button>
              </div>
            </DialogContent>
          </Dialog>
          <div className="h-px bg-slate-100 dark:bg-slate-800 mx-4" />
          <ListItem icon={HelpCircle} title="帮助与支持" />
          <div className="h-px bg-slate-100 dark:bg-slate-800 mx-4" />
          <div
             onClick={async () => { try { await fetch("/api/auth/logout", { method: "POST" }); router.replace("/login") } catch {} }}
             className="flex items-center justify-between p-4 cursor-pointer active:bg-slate-50 dark:active:bg-slate-800 transition-colors"
          >
            <div className="flex items-center gap-3">
              <LogOut className="size-5 text-red-500" />
              <span className="text-[15px] font-medium text-red-500">退出登录</span>
            </div>
          </div>
        </div>
      </div>
      {/* Footer Info */}
      <div className="relative z-10 px-5 text-center">
        <p className="text-[10px] text-slate-400">Stravision IoT Platform v1.0.0</p>
      </div>
    </div>
  )
}

--- FILE: app\access-denied\page.tsx ---

import { ShieldAlert } from "lucide-react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
export default function AccessDeniedPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4">
      <div className="max-w-md w-full text-center space-y-6">
        <div className="flex justify-center">
          <div className="size-24 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
            <ShieldAlert className="size-12 text-red-600 dark:text-red-500" />
          </div>
        </div>
        <div className="space-y-2">
          <h1 className="text-3xl font-bold tracking-tight text-foreground">
            访问被拒绝
          </h1>
          <p className="text-muted-foreground">
            Access Denied
          </p>
        </div>
        <div className="bg-muted/50 rounded-lg p-6 text-left space-y-4 border border-border/50">
          <div className="space-y-1">
            <h3 className="font-semibold text-foreground">为什么会看到这个页面？</h3>
            <p className="text-sm text-muted-foreground leading-relaxed">
              系统检测到您的 IP 地址存在可疑的访问行为（如频繁请求、恶意扫描或尝试暴力破解），为了保障平台安全，已自动暂时封禁您的访问权限。
            </p>
          </div>
          <div className="space-y-1">
            <h3 className="font-semibold text-foreground">如何解除？</h3>
            <ul className="text-sm text-muted-foreground list-disc list-inside space-y-1">
              <li>封禁通常会在 24 小时后自动解除。</li>
              <li>如果您认为这是误判，请联系系统管理员。</li>
            </ul>
          </div>
          <div className="pt-2 text-xs text-muted-foreground font-mono bg-background/50 p-2 rounded border border-border/30">
            Error Code: 403_SUSPICIOUS_ACTIVITY
          </div>
        </div>
        <div className="pt-4">
           <p className="text-xs text-muted-foreground mb-4">
             如果您是管理员，请通过受信任的网络环境访问控制台进行解封。
           </p>
           <Button variant="outline" asChild>
             <Link href="/">返回首页</Link>
           </Button>
        </div>
      </div>
    </div>
  );
}

--- FILE: app\admin\page.tsx ---

"use client"
import { useEffect, useState } from "react"
import { UserPublic } from "@/lib/db/user-service"
import { Button } from "@/components/ui/button"
import { UserDialog } from "@/components/admin/user-dialog"
import { toast } from "sonner"
import { Loader2, Pencil, Plus } from "lucide-react"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table" // Assuming table exists now or I will use standard HTML if it fails
import { BannedIPsManager } from "@/components/admin/banned-ips-manager"
import { AccessLogsViewer } from "@/components/admin/access-logs-viewer"
import { RateLimitSettings } from "@/components/admin/rate-limit-settings"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
export default function AdminPage() {
  const [users, setUsers] = useState<UserPublic[]>([])
  const [loading, setLoading] = useState(true)
  const [dialogOpen, setDialogOpen] = useState(false)
  const [selectedUser, setSelectedUser] = useState<UserPublic | null>(null)
  const [currentUser, setCurrentUser] = useState<UserPublic | null>(null)
  // ... existing fetch functions ...
  const fetchUsers = async () => {
    try {
      const res = await fetch("/api/admin/users")
      if (!res.ok) throw new Error("Failed to fetch users")
      const data = await res.json()
      setUsers(data)
    } catch (error) {
      console.error(error)
      toast.error("Failed to load users")
    } finally {
      setLoading(false)
    }
  }
  const fetchCurrentUser = async () => {
    try {
      const res = await fetch("/api/auth/me")
      const data = await res.json()
      if (data.authenticated) {
        setCurrentUser(data.user)
      }
    } catch (e) {
      console.error(e)
    }
  }
  useEffect(() => {
    fetchCurrentUser()
    fetchUsers()
  }, [])
  const handleEdit = (user: UserPublic) => {
    setSelectedUser(user)
    setDialogOpen(true)
  }
  const handleCreate = () => {
    setSelectedUser(null)
    setDialogOpen(true)
  }
  const handleSuccess = () => {
    fetchUsers()
  }
  if (loading) {
    return (
      <div className="flex h-screen items-center justify-center">
        <Loader2 className="h-8 w-8 animate-spin" />
      </div>
    )
  }
  return (
    <div className="container mx-auto py-6 md:py-10 space-y-6">
      <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">Admin Dashboard</h1>
          <p className="text-sm text-muted-foreground">
            System management and security controls.
          </p>
        </div>
      </div>
      <Tabs defaultValue="users" className="space-y-4">
        <TabsList>
          <TabsTrigger value="users">User Management</TabsTrigger>
          <TabsTrigger value="security">Security & Bans</TabsTrigger>
        </TabsList>
        <TabsContent value="users" className="space-y-4">
          <div className="flex justify-end">
             <Button onClick={handleCreate}>
               <Plus className="mr-2 h-4 w-4" />
               Add User
             </Button>
          </div>
          {/* Mobile View: Cards */}
          <div className="grid gap-4 md:hidden overflow-y-auto max-h-[calc(100vh-250px)]">
            {users.map((user) => (
              <Card key={user.id}>
                <CardHeader className="flex flex-row items-start justify-between space-y-0 pb-2">
                  <div className="space-y-1">
                    <CardTitle className="text-base font-medium leading-none">
                      {user.username}
                    </CardTitle>
                    <p className="text-xs text-muted-foreground truncate max-w-[200px]">
                      {user.email}
                    </p>
                  </div>
                  <Badge variant={user.role === 'super_admin' ? 'default' : user.role === 'admin' ? 'secondary' : 'outline'}>
                    {user.role}
                  </Badge>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="text-xs text-muted-foreground bg-muted/50 p-2 rounded-md">
                    <span className="font-medium text-foreground">Permissions: </span>
                    {user.permissions?.allowedControls?.length
                      ? `${user.permissions.allowedControls.length} devices allowed`
                      : 'No device permissions'}
                  </div>
                  <Button variant="outline" size="sm" className="w-full" onClick={() => handleEdit(user)}>
                    <Pencil className="mr-2 h-4 w-4" />
                    Edit User
                  </Button>
                </CardContent>
              </Card>
            ))}
          </div>
          {/* Desktop View: Table */}
          <div className="hidden md:block rounded-md border bg-card">
            <div className="overflow-y-auto max-h-[calc(100vh-250px)]">
              <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[80px]">ID</TableHead>
                  <TableHead>Username</TableHead>
                  <TableHead>Email</TableHead>
                  <TableHead>Role</TableHead>
                  <TableHead>Permissions</TableHead>
                  <TableHead className="text-right">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {users.map((user) => (
                  <TableRow key={user.id}>
                    <TableCell>{user.id}</TableCell>
                    <TableCell className="font-medium">{user.username}</TableCell>
                    <TableCell>{user.email}</TableCell>
                    <TableCell>
                      <Badge variant={user.role === 'super_admin' ? 'default' : user.role === 'admin' ? 'secondary' : 'outline'}>
                        {user.role}
                      </Badge>
                    </TableCell>
                    <TableCell className="text-muted-foreground">
                      {user.permissions?.allowedControls?.length
                        ? `${user.permissions.allowedControls.length} controls`
                        : 'None'}
                    </TableCell>
                    <TableCell className="text-right">
                      <Button variant="ghost" size="sm" onClick={() => handleEdit(user)}>
                        <Pencil className="h-4 w-4" />
                        <span className="sr-only">Edit</span>
                      </Button>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
            </div>
          </div>
        </TabsContent>
        <TabsContent value="security" className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-7">
            <div className="col-span-4 space-y-4">
              <RateLimitSettings />
              <AccessLogsViewer />
            </div>
            <div className="col-span-3">
              <BannedIPsManager />
            </div>
          </div>
        </TabsContent>
      </Tabs>
      {currentUser && (
        <UserDialog
          open={dialogOpen}
          onOpenChange={setDialogOpen}
          user={selectedUser}
          currentUserRole={currentUser.role}
          onSuccess={handleSuccess}
        />
      )}
    </div>
  )
}

--- FILE: app\ai-assistant\page.test.tsx ---

/**
 * UI State Synchronization Tests for AI Assistant Page
 *
 * This test file verifies that the Search button state synchronization works correctly:
 * - Search button click updates enableSearch state
 * - UI visual indicators (color, icon) sync with state
 * - State is correctly passed in API requests
 *
 * Requirements: 1.1
 */
import { describe, it, expect } from 'vitest'
/**
 * Manual Verification Tests for UI State Synchronization
 *
 * These tests document the expected behavior that should be manually verified:
 *
 * 1. Search Button State Toggle:
 *    - Initial state: Button should have bg-white, text-gray-500, border-gray-200
 *    - After click: Button should have bg-blue-50, text-blue-600, border-blue-200, shadow-sm
 *    - After second click: Button should return to initial state
 *
 * 2. Globe Icon Presence:
 *    - Search button should always display a Globe icon (SVG element)
 *
 * 3. API Request State Propagation:
 *    - When enableSearch is true and user sends a message
 *    - The /api/chat request body should contain enableSearch: true
 *
 * 4. Visual Consistency:
 *    - Multiple toggles should maintain consistent styling
 *    - No visual glitches or state desynchronization
 *
 * 5. Model Compatibility Warning:
 *    - When search is enabled with unsupported model
 *    - A warning notice should be displayed to the user
 */
describe('AI Assistant Page - UI State Synchronization (Manual Verification)', () => {
  it('should document expected Search button behavior', () => {
    // This test documents the expected behavior for manual verification
    const expectedBehavior = {
      initialState: {
        classes: ['bg-white', 'text-gray-500', 'border-gray-200'],
        enableSearch: false,
      },
      activeState: {
        classes: ['bg-blue-50', 'text-blue-600', 'border-blue-200', 'shadow-sm'],
        enableSearch: true,
      },
      icon: 'Globe (SVG)',
      apiPropagation: 'enableSearch field in /api/chat request body',
    }
    expect(expectedBehavior).toBeDefined()
    expect(expectedBehavior.initialState.enableSearch).toBe(false)
    expect(expectedBehavior.activeState.enableSearch).toBe(true)
  })
  it('should verify state toggle logic', () => {
    // Simulate state toggle logic
    let enableSearch = false
    // Initial state
    expect(enableSearch).toBe(false)
    // First toggle
    enableSearch = !enableSearch
    expect(enableSearch).toBe(true)
    // Second toggle
    enableSearch = !enableSearch
    expect(enableSearch).toBe(false)
    // Multiple toggles should work consistently
    for (let i = 0; i < 10; i++) {
      enableSearch = !enableSearch
      expect(enableSearch).toBe(i % 2 === 0)
    }
  })
  it('should verify CSS class mapping logic', () => {
    // Simulate CSS class mapping based on state
    const getButtonClasses = (enableSearch: boolean) => {
      if (enableSearch) {
        return {
          bg: 'bg-blue-50',
          text: 'text-blue-600',
          border: 'border-blue-200',
          shadow: 'shadow-sm',
        }
      }
      return {
        bg: 'bg-white',
        text: 'text-gray-500',
        border: 'border-gray-200',
        shadow: '',
      }
    }
    // Test inactive state
    const inactiveClasses = getButtonClasses(false)
    expect(inactiveClasses.bg).toBe('bg-white')
    expect(inactiveClasses.text).toBe('text-gray-500')
    expect(inactiveClasses.border).toBe('border-gray-200')
    expect(inactiveClasses.shadow).toBe('')
    // Test active state
    const activeClasses = getButtonClasses(true)
    expect(activeClasses.bg).toBe('bg-blue-50')
    expect(activeClasses.text).toBe('text-blue-600')
    expect(activeClasses.border).toBe('border-blue-200')
    expect(activeClasses.shadow).toBe('shadow-sm')
  })
  it('should verify API request body structure', () => {
    // Simulate API request body construction
    const buildChatRequest = (enableSearch: boolean) => {
      return {
        messages: [],
        model: 'qwen3-max',
        apiKey: 'test-key',
        apiUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
        systemPrompt: 'You are a helpful assistant',
        sessionId: 'test-session',
        enableSearch,
        enableReasoning: false,
        deviceData: null,
        weatherData: null,
      }
    }
    // Test with search disabled
    const requestWithoutSearch = buildChatRequest(false)
    expect(requestWithoutSearch.enableSearch).toBe(false)
    expect(requestWithoutSearch).toHaveProperty('enableSearch')
    // Test with search enabled
    const requestWithSearch = buildChatRequest(true)
    expect(requestWithSearch.enableSearch).toBe(true)
    expect(requestWithSearch).toHaveProperty('enableSearch')
  })
  it('should verify state persistence across toggles', () => {
    // Simulate state management
    const stateHistory: boolean[] = []
    let currentState = false
    // Record initial state
    stateHistory.push(currentState)
    // Perform multiple toggles
    for (let i = 0; i < 5; i++) {
      currentState = !currentState
      stateHistory.push(currentState)
    }
    // Verify state history
    expect(stateHistory).toEqual([false, true, false, true, false, true])
    // Verify final state
    expect(currentState).toBe(true)
  })
})
/**
 * Integration Test Checklist (Manual Verification Required)
 *
 * To fully verify UI state synchronization, perform these manual tests:
 *
 * 1. Open the AI Assistant page in a browser
 * 2. Locate the Search button (should have Globe icon and "Search" text)
 * 3. Verify initial state:
 *    - Button should have light gray background
 *    - Text should be gray
 *    - No blue highlighting
 * 4. Click the Search button:
 *    - Button should change to blue background
 *    - Text should change to blue
 *    - Shadow should appear
 * 5. Click the Search button again:
 *    - Button should return to initial gray state
 * 6. Enable search and send a message:
 *    - Open browser DevTools Network tab
 *    - Enable search (button turns blue)
 *    - Type a message and send
 *    - Check the /api/chat request payload
 *    - Verify enableSearch: true is present
 * 7. Test with unsupported model:
 *    - Change model to gpt-3.5-turbo in settings
 *    - Click Search button
 *    - Verify warning notice appears
 * 8. Test rapid toggling:
 *    - Click Search button rapidly 10 times
 *    - Verify UI remains consistent
 *    - No visual glitches or state desync
 */

--- FILE: app\ai-assistant\page.tsx ---

"use client"
import { useState, useEffect, useRef } from "react"
import Image from "next/image"
import { useRouter } from "next/navigation"
import type { UserPublic } from "@/lib/db/user-service"
import {
  Mic,
  RotateCcw,
  Copy,
  Trash,
  Settings,
  Plus,
  LogOut,
  X,
  ChevronDown,
  SquarePen,
  Search,
  Library,
  Sparkles,
  CircleHelp,
  PanelLeftClose,
  PanelLeftOpen,
  CheckCircle2,
  AlertCircle,
  Loader2,
  Globe,
  ArrowUp,
  ImageIcon,
  Paperclip,
  FileText,
  Sun,
  Activity,
  Sprout,
  Zap,
  ArrowUpRight,
  ArrowRight,
  ArrowLeft,
  Wand2,
  Download
} from "lucide-react"
import dynamic from "next/dynamic"
import { Button } from "@/components/ui/button"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { ScrollArea } from "@/components/ui/scroll-area"
import remarkGfm from "remark-gfm"
import * as htmlToImage from 'html-to-image'
import jsPDF from "jspdf"
const ReactMarkdown = dynamic(() => import("react-markdown"), { ssr: false })
const MermaidChart = dynamic(() => import("@/components/mermaid-chart"), {
  ssr: false,
  loading: () => <div className="p-4 text-xs text-gray-400">Loading diagram...</div>
})
const ChartRenderer = dynamic(() => import("@/components/chart-renderer"), {
  ssr: false,
  loading: () => <div className="p-4 text-xs text-gray-400">Loading chart...</div>
})
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import {
  PromptInputModelSelect,
  PromptInputModelSelectTrigger,
  PromptInputModelSelectContent,
  PromptInputModelSelectItem,
  Conversation,
  ConversationContent,
  Loader,
} from "@/components/ui/assistant-ui"
import { AISettingsDialog } from "@/components/ai-settings-dialog"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { cn } from "@/lib/utils"
import { Reasoning, ReasoningTrigger, ReasoningContent } from "@/components/ai/reasoning"
import { MonitorCard } from "@/components/ai/monitor-card"
import { DeviceBentoGrid } from "@/components/ai/device-bento-grid"
import { ControlBentoGrid } from "@/components/ai/control-bento-grid"
import { ScheduleCard } from "@/components/ai/schedule-card"
import { SpectralCard } from "@/components/ai/spectral-card"
import { ScheduledTasksList } from "@/components/ai/scheduled-tasks-list"
import { PageNavigation } from "@/components/page-navigation"
interface Citation {
  number: string
  title: string
  url: string
  description?: string
  quote?: string
}
interface TaskItemModel { type: "text" | "file"; text: string; file?: { name: string; icon?: string } }
interface TaskModel { title: string; items: TaskItemModel[]; status: "pending" | "in_progress" | "completed" }
interface Message {
  role: "user" | "assistant"
  content: string | Array<{ type: 'text' | 'image_url', text?: string, image_url?: { url: string } }>
  citations?: Citation[]
  reasoning?: { text: string; durationMs?: number }
  tasks?: TaskModel[]
}
interface AISettings {
  apiKey: string
  apiUrl: string
  model: string
  systemPrompt: string
}
function isVLMModel(model: string | undefined): boolean {
  if (!model) return false
  const m = model.toLowerCase()
  return (
    m.includes('vision') ||
    m.includes('-vl-') ||
    /qwen\d*-vl/.test(m) ||
    m.includes('qwen-vl') ||
    m.includes('qwen3-vl') ||
    m.includes('qvq')
  )
}
interface SessionMeta { id: string; title: string; createdAt: number; updatedAt: number }
export default function AIAssistantPage() {
  const router = useRouter()
  const [user, setUser] = useState<UserPublic | null>(null)
  const [loadingUser, setLoadingUser] = useState(true)
  // Chat State
  const [input, setInput] = useState("")
  const [messages, setMessages] = useState<Message[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [sessionId, setSessionId] = useState<string>("")
  const [sessions, setSessions] = useState<SessionMeta[]>([])
  const [aiSettings, setAiSettings] = useState<AISettings | null>(null)
  const [settingsOpen, setSettingsOpen] = useState(false)
  const [enableSearch, setEnableSearch] = useState(false)
  const [enableReasoning, setEnableReasoning] = useState(false)
  const [isOptimizing, setIsOptimizing] = useState(false)
  const [selectedModel, setSelectedModel] = useState<string>("")
  const [attachments, setAttachments] = useState<string[]>([])
  const [sidebarOpen, setSidebarOpen] = useState(true)
  const scrollAreaRef = useRef<HTMLDivElement>(null)
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [autoScroll, setAutoScroll] = useState(true)
  const { deviceData } = useDeviceData()
  const { weatherData } = useWeatherContext()
  const [notices, setNotices] = useState<{ id: number; title: string; description?: string; variant?: 'loading' | 'success' | 'error'; expanded: boolean }[]>([])
  const noticeIdCounter = useRef(0)
  const showNotice = (title: string, description?: string, variant?: 'loading' | 'success' | 'error') => {
    const id = ++noticeIdCounter.current
    setNotices(prev => [...prev, { id, title, description, variant, expanded: false }])
    if (variant && variant !== 'loading') {
      setTimeout(() => {
        setNotices(prev => prev.filter(n => n.id !== id))
      }, 5000)
    }
  }
  const handleOptimizePrompt = async () => {
    if (!input.trim()) return
    if (!aiSettings?.apiKey) { setSettingsOpen(true); return }
    setIsOptimizing(true)
    showNotice("正在优化提示词...", "AI 正在思考如何改进您的输入...", "loading")
    try {
      const res = await fetch('/api/ai/optimize-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: input,
          apiKey: aiSettings.apiKey,
          apiUrl: aiSettings.apiUrl,
          model: aiSettings.model
        })
      })
      if (res.ok) {
        const data = await res.json()
        if (data.optimizedPrompt) {
          setInput(data.optimizedPrompt)
          showNotice("提示词已优化", "已为您重写了更清晰的提示词", "success")
        }
      } else {
        showNotice("优化失败", "请求出错", "error")
      }
    } catch (e) {
      console.error("Optimize error", e)
      showNotice("优化失败", "发生未知错误", "error")
    } finally {
      setIsOptimizing(false)
    }
  }
  const closeNotice = (id: number) => {
    setNotices(prev => prev.filter(n => n.id !== id))
  }
  const toggleNoticeExpanded = (id: number) => {
    setNotices(prev => prev.map(n => n.id === id ? { ...n, expanded: !n.expanded } : n))
  }
  // Fetch User
  useEffect(() => {
    let mounted = true
      ; (async () => {
        try {
          const res = await fetch("/api/auth/me")
          const data = await res.json()
          if (mounted && data?.authenticated && data?.user) setUser(data.user as UserPublic)
        } catch { }
        if (mounted) setLoadingUser(false)
      })()
    return () => { mounted = false }
  }, [])
  // Load Settings
  useEffect(() => {
    try {
      const s = localStorage.getItem("ai-settings")
      if (s) {
        const parsed = JSON.parse(s)
        setAiSettings(parsed)
        if (!selectedModel && parsed?.model) setSelectedModel(parsed.model)
      }
      const es = localStorage.getItem("ai-enable-search")
      if (es) setEnableSearch(es === "true")
    } catch { }
  }, [])
  // Load Sessions
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch("/api/sessions")
        if (res.ok) {
          const data = await res.json()
          if (Array.isArray(data?.sessions)) {
            setSessions(data.sessions)
            const lastId = localStorage.getItem("ai-last-session-id")
            if (lastId && data.sessions.find((s: SessionMeta) => s.id === lastId)) {
              setSessionId(lastId)
            } else if (data.sessions.length > 0) {
              setSessionId(data.sessions[0].id)
            } else {
              createNewSession()
            }
          }
        }
      } catch { }
    })()
  }, [])
  // Load Messages
  useEffect(() => {
    if (!sessionId) return
    localStorage.setItem("ai-last-session-id", sessionId)
      ; (async () => {
        try {
          const res = await fetch(`/api/sessions/${sessionId}`)
          if (res.ok) {
            const data = await res.json()
            const msgs = Array.isArray(data?.messages) ? (data.messages as Message[]) : []
            setMessages(msgs.length > 0 ? msgs : [])
            try {
              const draft = localStorage.getItem(`ai-input-draft-${sessionId}`)
              if (typeof draft === "string") setInput(draft)
            } catch { }
          }
        } catch { }
      })()
  }, [sessionId])
  // Scroll to bottom
  useEffect(() => {
    if (autoScroll && messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "smooth" })
    }
  }, [messages, isLoading, autoScroll])
  const executeCommands = async (commands: any[]) => {
    if (!commands || commands.length === 0) return
    showNotice("正在执行指令...", `共发现 ${commands.length} 个操作`, "loading")
    for (const cmd of commands) {
      try {
        if (cmd.action === "set_led") {
          const res = await fetch('/api/ai/device-control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'set_led', r: cmd.r, g: cmd.g, b: cmd.b })
          })
          if (res.ok) {
            showNotice("调控成功 ", `已开启补光灯 (R:${cmd.r} G:${cmd.g} B:${cmd.b})`, "success")
          } else {
            let err = ''
            try { const j = await res.json(); err = j?.error || '' } catch { }
            showNotice("调控失败", err || `请求错误 ${res.status}`, "error")
          }
        } else if (cmd.action === "toggle_relay") {
          const res = await fetch('/api/ai/device-control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'toggle_relay', device: cmd.device, value: cmd.value })
          })
          if (res.ok) {
            showNotice("开关执行成功 ", `设备 ${cmd.device} 状态 ${cmd.value === 1 ? '开启' : '关闭'}`, "success")
          } else {
            let err = ''
            try { const j = await res.json(); err = j?.error || '' } catch { }
            showNotice("开关执行失败", err || `请求错误 ${res.status}`, "error")
          }
        }
        // Add a small delay between commands to avoid flooding
        await new Promise(resolve => setTimeout(resolve, 500))
      } catch (e) {
        console.error("Command execution error", e)
      }
    }
  }
  const handleSend = async (overrideText?: any) => {
    const text = typeof overrideText === "string" ? overrideText : input
    if (!text.trim() || isLoading) return
    if (!aiSettings?.apiKey) { setSettingsOpen(true); return }
    const userMsg = text.trim()
    setInput("")
    setEnableSearch(false) // Reset search state after sending
    let ensuredSessionId = sessionId
    if (!ensuredSessionId) {
      await createNewSession()
      const r = await fetch("/api/sessions", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ title: `新会话 ${new Date().toLocaleString("zh-CN")}` }) })
      if (r.ok) {
        const s = await r.json()
        ensuredSessionId = s.id
        setSessionId(s.id)
        setSessions(prev => [s, ...prev])
      }
    }
    const userMessageContent: Message['content'] = attachments.length > 0
      ? [
        { type: "text", text: userMsg },
        ...attachments.map(url => ({ type: "image_url" as const, image_url: { url } }))
      ]
      : userMsg
    if (userMsg === "是" || userMsg === "执行") {
      const lastAssistantMsg = messages[messages.length - 1]
      if (lastAssistantMsg && lastAssistantMsg.role === "assistant") {
        const jsonMatches = [...(lastAssistantMsg.content as string).matchAll(/```json\s*([\s\S]*?)```/g)]
        if (jsonMatches.length > 0) {
          const commands = []
          for (const match of jsonMatches) {
            try { commands.push(JSON.parse(match[1])) } catch { }
          }
          if (commands.length > 0) await executeCommands(commands)
        }
      }
      return
    }
    const newMessages: Message[] = [...messages, { role: "user", content: userMessageContent }]
    setMessages(newMessages)
    setIsLoading(true)
    setAutoScroll(true)
    const currentAttachments = [...attachments]
    setAttachments([])
    try {
      if (ensuredSessionId) {
        const current = sessions.find((s) => s.id === ensuredSessionId)
        if (current && current.title && current.title.startsWith("新会话")) {
          const cand = userMsg.slice(0, 24)
          await fetch(`/api/sessions/${ensuredSessionId}`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ title: cand }) })
          setSessions((prev) => prev.map((s) => (s.id === ensuredSessionId ? { ...s, title: cand } : s)))
        }
        await fetch(`/api/sessions/${ensuredSessionId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: newMessages.map(m => ({ role: m.role, content: m.content })) })
        })
      }
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: newMessages.map((m) => ({ role: m.role, content: m.content })),
          model: selectedModel || aiSettings?.model,
          apiKey: aiSettings?.apiKey,
          apiUrl: aiSettings?.apiUrl,
          systemPrompt: aiSettings?.systemPrompt,
          sessionId: ensuredSessionId,
          enableSearch,
          enableReasoning,
          deviceData,
          weatherData
        })
      })
      if (!res.ok) {
        const errorText = await res.text()
        throw new Error(`Failed to send message: ${res.status} - ${errorText}`)
      }
      const reader = res.body?.getReader()
      if (!reader) throw new Error("No response body")
      const assistantMsg: Message = { role: "assistant", content: "" }
      let reasoningText = ""
      let reasoningStart = -1
      const startTs = Date.now()
      setMessages(prev => [...prev, assistantMsg])
      while (true) {
        const { done, value } = await reader.read()
        if (done) break
        const chunk = new TextDecoder().decode(value)
        const lines = chunk.split("\n")
        for (const line of lines) {
          if (line.startsWith("data: ")) {
            try {
              const data = JSON.parse(line.slice(6))
              const content = data.choices?.[0]?.delta?.content ?? data.content
              if (typeof content === "string") {
                assistantMsg.content = (typeof assistantMsg.content === "string" ? assistantMsg.content : "") + content
                // Simplified reasoning parsing
                const combined = typeof assistantMsg.content === "string" ? assistantMsg.content : ""
                if (reasoningStart === -1) {
                  const sIdx = combined.indexOf("<REASONING>")
                  if (sIdx !== -1) reasoningStart = sIdx
                }
                let display = combined
                if (reasoningStart !== -1) {
                  const endIdx = combined.indexOf("</REASONING>", reasoningStart)
                  if (endIdx !== -1) {
                    reasoningText = combined.slice(reasoningStart + 11, endIdx)
                    display = combined.slice(0, reasoningStart) + combined.slice(endIdx + 12)
                  } else {
                    reasoningText = combined.slice(reasoningStart + 11)
                    display = combined.slice(0, reasoningStart)
                  }
                }
                setMessages(prev => {
                  const newMsgs = [...prev]
                  newMsgs[newMsgs.length - 1] = {
                    role: "assistant",
                    content: display,
                    reasoning: { text: reasoningText, durationMs: Date.now() - startTs }
                  }
                  return newMsgs
                })
              }
            } catch { }
          }
        }
      }
      if (ensuredSessionId) {
        const lastMsg = { ...assistantMsg, reasoning: { text: reasoningText, durationMs: Date.now() - startTs } }
        await fetch(`/api/sessions/${ensuredSessionId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: [...newMessages, lastMsg] })
        })
      }
    } catch (e) {
      console.error("Chat error:", e)
      setMessages(prev => [...prev, { role: "assistant", content: "抱歉，发生了一些错误，请稍后再试。" }])
    } finally {
      // Ensure loading state is cleared
      setIsLoading(false)
      setTimeout(() => setIsLoading(false), 100)
    }
  }
  const createNewSession = async () => {
    try {
      const r = await fetch("/api/sessions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: `新会话 ${new Date().toLocaleString("zh-CN")}` })
      })
      if (r.ok) {
        const s = await r.json()
        setSessionId(s.id)
        setSessions(prev => [s, ...prev])
        setMessages([])
        setInput("")
      }
    } catch { }
  }
  const deleteSession = async (id: string, e?: React.MouseEvent) => {
    e?.stopPropagation()
    if (!confirm("确定要删除此会话吗？")) return
    try {
      await fetch(`/api/sessions/${id}`, { method: "DELETE" })
      const nextSessions = sessions.filter(s => s.id !== id)
      setSessions(nextSessions)
      if (id === sessionId) {
        if (nextSessions.length > 0) setSessionId(nextSessions[0].id)
        else createNewSession()
      }
    } catch { }
  }
  const onSelectFiles: React.ChangeEventHandler<HTMLInputElement> = (e) => {
    const files = Array.from(e.currentTarget.files || [])
    files.forEach((file) => {
      const reader = new FileReader()
      reader.onload = () => {
        const url = typeof reader.result === "string" ? reader.result : ""
        if (url) setAttachments((prev) => [...prev, url])
      }
      reader.readAsDataURL(file)
    })
    e.currentTarget.value = ""
    if (files.length > 0) {
      showNotice("附件已添加", `共 ${files.length} 个`, "success")
    }
  }
  const removeAttachment = (index: number) => {
    setAttachments((prev) => prev.filter((_, i) => i !== index))
  }
  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {
    const items = e.clipboardData.items
    const files: File[] = []
    for (let i = 0; i < items.length; i++) {
      if (items[i].kind === 'file') {
        const file = items[i].getAsFile()
        if (file) {
          files.push(file)
        }
      }
    }
    if (files.length > 0) {
      e.preventDefault()
      files.forEach((file) => {
        const reader = new FileReader()
        reader.onload = () => {
          const url = typeof reader.result === "string" ? reader.result : ""
          if (url) setAttachments((prev) => [...prev, url])
        }
        reader.readAsDataURL(file)
      })
      showNotice("已粘贴附件", `共 ${files.length} 个文件`, "success")
    }
  }
  const handleDownloadPDF = async (messageIndex: number) => {
    const element = document.getElementById(`message-content-${messageIndex}`)
    if (!element) return
    showNotice("正在生成 PDF...", "请稍候，这可能需要几秒钟", "loading")
    try {
      const dataUrl = await htmlToImage.toPng(element, {
        backgroundColor: '#ffffff',
        style: {
          // 强制覆盖可能出问题的颜色属性，虽然 html-to-image 对 lab 支持更好，但防患于未然
          color: '#000000',
        }
      })
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      })
      const img = new window.Image()
      img.src = dataUrl
      await new Promise((resolve) => { img.onload = resolve })
      const imgWidth = 210 // A4 width in mm
      const pageHeight = 297 // A4 height in mm
      const imgHeight = (img.height * imgWidth) / img.width
      let heightLeft = imgHeight
      let position = 0
      pdf.addImage(dataUrl, 'PNG', 0, position, imgWidth, imgHeight)
      heightLeft -= pageHeight
      while (heightLeft >= 0) {
        position = heightLeft - imgHeight
        pdf.addPage()
        pdf.addImage(dataUrl, 'PNG', 0, position, imgWidth, imgHeight)
        heightLeft -= pageHeight
      }
      pdf.save(`AI-Assistant-Report-${new Date().toISOString().slice(0, 10)}.pdf`)
      showNotice("PDF 生成成功", "文件已开始下载", "success")
    } catch (error) {
      console.error("PDF Generation Error:", error)
      showNotice("PDF 生成失败", "请重试或检查内容是否包含复杂元素", "error")
    }
  }
  const handleSettingsSave = (settings: AISettings) => {
    setAiSettings(settings)
    localStorage.setItem("ai-settings", JSON.stringify(settings))
    setSelectedModel(settings.model)
  }
  const renderMessageContent = (msg: Message) => {
    const content = msg.content
    if (Array.isArray(content)) {
      return (
        <div className="space-y-2">
          {content.map((part, i) => (
            <div key={i}>
              {part.type === 'image_url' && part.image_url && (
                <div className="relative w-full max-w-[300px] h-auto rounded-lg overflow-hidden border border-gray-200 my-2">
                  <Image src={part.image_url.url} alt="User upload" width={300} height={200} className="object-cover w-full h-auto" />
                </div>
              )}
              {part.type === 'text' && part.text && renderTextContent(part.text)}
            </div>
          ))}
        </div>
      )
    }
    return renderTextContent(content)
  }
  const renderTextContent = (content: string) => {
    // Split content by CHART, REASONING, and SOURCES tags
    // Improved regex to handle multiline content correctly using [\s\S]*? non-greedy match
    // Updated to handle streaming REASONING tags (open tag without close tag yet)
    // Updated to handle spaces in tags (e.g. < TASK_LIST >)
    const parts = content.split(/(<\s*CHART\s+type="echarts"\s*>[\s\S]*?<\/\s*CHART\s*>|<\s*CHART\s+type="vega-lite"\s*>[\s\S]*?<\/\s*CHART\s*>|<\s*REASONING\s*>[\s\S]*?(?:<\/\s*REASONING\s*>|$)|<\s*SOURCES\s*>[\s\S]*?<\/\s*SOURCES\s*>|<\s*MONITOR\s*>[\s\S]*?(?:<\/\s*MONITOR\s*>|$)|<\s*SPECTRAL\s*>[\s\S]*?(?:<\/\s*SPECTRAL\s*>|$)|<\s*TASKS\s*>[\s\S]*?<\/\s*TASKS\s*>|<\s*DEVICE_BENTO\s*(?:>[\s\S]*?(?:<\/\s*DEVICE_BENTO\s*>|$)|(?:\/>))|<\s*CONTROL_BENTO\s*(?:>[\s\S]*?(?:<\/\s*CONTROL_BENTO\s*>|$)|(?:\/>))|<\s*TASK_LIST\s*(?:>[\s\S]*?(?:<\/\s*TASK_LIST\s*>|$)|(?:\/>)))/g)
    return (
      <>
        {parts.map((part, index) => {
          if (part.match(/^<\s*SPECTRAL/)) {
            return (
              <div key={index} className="flex justify-center my-4 w-full">
                <div className="w-full max-w-[400px]">
                  <SpectralCard data={deviceData} />
                </div>
              </div>
            )
          }
          if (part.match(/^<\s*TASK_LIST/)) {
            return (
              <div key={index} className="my-6">
                <ScheduledTasksList />
              </div>
            )
          }
          if (part.match(/^<\s*CONTROL_BENTO/)) {
            return (
              <div key={index} className="my-6">
                <ControlBentoGrid />
              </div>
            )
          }
          if (part.match(/^<\s*DEVICE_BENTO/)) {
            return (
              <div key={index} className="my-6">
                <DeviceBentoGrid />
              </div>
            )
          }
          if (part.match(/^<\s*TASKS/)) {
            try {
              const jsonStr = part.replace(/<\s*TASKS\s*>/, '').replace(/<\/\s*TASKS\s*>/, '').trim()
              const tasks = JSON.parse(jsonStr) as TaskModel[]
              if (!tasks || tasks.length === 0) return null
              return (
                <div key={index} className="my-4 space-y-4">
                  {tasks.map((task, i) => (
                    <div key={i} className="bg-white dark:bg-zinc-900 rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm">
                      <div className="px-4 py-3 bg-gray-50 dark:bg-zinc-800 border-b border-gray-100 dark:border-gray-800 flex items-center justify-between">
                        <h3 className="font-medium text-sm text-gray-900 dark:text-gray-100">{task.title}</h3>
                        <div className={cn(
                          "px-2 py-0.5 rounded-full text-[10px] font-medium uppercase tracking-wide",
                          task.status === 'completed' ? "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400" :
                            task.status === 'in_progress' ? "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400" :
                              "bg-gray-100 dark:bg-zinc-800 text-gray-600 dark:text-gray-400"
                        )}>
                          {task.status === 'completed' ? 'Completed' : task.status === 'in_progress' ? 'In Progress' : 'Pending'}
                        </div>
                      </div>
                      <div className="p-0">
                        {task.items.map((item, j) => (
                          <div key={j} className="flex items-start gap-3 px-4 py-3 border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50 dark:hover:bg-zinc-800 transition-colors">
                            <div className="mt-0.5 shrink-0 text-gray-400 dark:text-gray-500">
                              {item.type === 'file' ? <FileText size={16} /> : <CheckCircle2 size={16} className={cn(task.status === 'completed' ? "text-green-500" : "")} />}
                            </div>
                            <div className="flex-1 text-sm text-gray-600 dark:text-gray-300">
                              {item.text}
                              {item.file && (
                                <div className="mt-2 flex items-center gap-2 p-2 bg-gray-100 dark:bg-zinc-800 rounded-md border border-gray-200 dark:border-gray-700 w-fit">
                                  <div className="size-8 bg-white dark:bg-zinc-900 rounded border border-gray-200 dark:border-gray-700 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    {item.file.name.split('.').pop()}
                                  </div>
                                  <div className="text-xs font-medium text-gray-700 dark:text-gray-300">{item.file.name}</div>
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )
            } catch (e) {
              console.error("Tasks parsing error", e)
              return null
            }
          }
          if (part.match(/^<\s*MONITOR/)) {
            return (
              <div key={index} className="flex justify-center my-4">
                <MonitorCard />
              </div>
            )
          }
          if (part.match(/^<\s*CHART/)) {
            try {
              // Extract type and content
              const isVegaLite = part.includes('type="vega-lite"')
              const tagStartRegex = isVegaLite ? /<\s*CHART\s+type="vega-lite"\s*>/ : /<\s*CHART\s+type="echarts"\s*>/
              // Extract JSON content
              const jsonStr = part.replace(tagStartRegex, '').replace(/<\/\s*CHART\s*>/, '').trim()
              const data = JSON.parse(jsonStr)
              return (
                <div key={index} className="my-4 w-full min-w-[300px] md:min-w-[600px] h-[350px] rounded-lg overflow-hidden bg-white relative z-10 border border-gray-100 shadow-sm">
                  <ChartRenderer options={data} type={isVegaLite ? 'vega-lite' : 'echarts'} style={{ height: '100%', width: '100%' }} />
                </div>
              )
            } catch (e) {
              // Fallback to showing raw text if parsing fails
              console.error("Chart parsing error", e)
              return (
                <div key={index} className="p-4 bg-red-50 text-red-500 rounded-lg border border-red-100 text-xs font-mono overflow-auto">
                  Chart Error: {String(e)}
                </div>
              )
            }
          }
          if (part.match(/^<\s*REASONING/)) {
            const reasoningText = part.replace(/<\s*REASONING\s*>/, '').replace(/<\/\s*REASONING\s*>/, '').trim()
            // Check if the reasoning block is closed
            const isStreaming = !part.match(/<\/\s*REASONING\s*>/)
            // If content is empty AND NOT streaming, hide it.
            // But if streaming (even if empty), show it.
            if (!reasoningText && !isStreaming) return null
            return (
              <Reasoning key={index} isStreaming={isStreaming} className="mb-4">
                <ReasoningTrigger />
                <ReasoningContent>
                  {reasoningText ? (
                    <ReactMarkdown
                      remarkPlugins={[remarkGfm]}
                      components={{
                        code: ({ node, inline, className, children, ...props }: any) => (
                          <code className={cn("bg-gray-100 dark:bg-zinc-800 rounded px-1 font-mono text-xs text-gray-800 dark:text-gray-200 font-semibold", className)} {...props}>{children}</code>
                        )
                      }}
                    >
                      {reasoningText}
                    </ReactMarkdown>
                  ) : (
                    <div className="flex items-center gap-2 text-muted-foreground animate-pulse">
                      <span className="size-2 bg-current rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                      <span className="size-2 bg-current rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                      <span className="size-2 bg-current rounded-full animate-bounce"></span>
                    </div>
                  )}
                </ReasoningContent>
              </Reasoning>
            )
          }
          if (part.match(/^<\s*SOURCES/)) {
            try {
              const jsonStr = part.replace(/<\s*SOURCES\s*>/, '').replace(/<\/\s*SOURCES\s*>/, '').trim()
              let sources: Array<{ title: string, url: string, number: number }> = []
              if (jsonStr.startsWith('[')) {
                try {
                  sources = JSON.parse(jsonStr)
                } catch (e) {
                  console.warn("Sources JSON parse failed, attempting regex fallback")
                }
              }
              if (!sources || sources.length === 0) {
                // Fallback for Markdown style links: [Title](URL)
                const regex = /\[([^\]]+)\]\(([^)]+)\)/g
                let match
                let idx = 1
                while ((match = regex.exec(jsonStr)) !== null) {
                  sources.push({
                    title: match[1],
                    url: match[2],
                    number: idx++
                  })
                }
              }
              if (!sources || sources.length === 0) return null
              return (
                <div key={index} className="mt-4 mb-2">
                  <div className="flex flex-wrap gap-2">
                    <div className="inline-flex items-center gap-2 bg-gray-50 dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 border border-gray-200 dark:border-gray-700 rounded-full pl-1 pr-3 py-1 transition-colors cursor-pointer group">
                      <div className="flex -space-x-2 overflow-hidden py-0.5 pl-0.5">
                        {sources.slice(0, 3).map((s, i) => (
                          <div key={i} className="size-5 rounded-full bg-white dark:bg-zinc-900 border border-gray-100 dark:border-gray-800 flex items-center justify-center text-[10px] font-bold text-gray-500 dark:text-gray-400 shadow-sm shrink-0 relative z-10">
                            {/* Try to use favicon if available, otherwise show number */}
                            <img
                              src={`https://www.google.com/s2/favicons?domain=${new URL(s.url).hostname}&sz=32`}
                              alt=""
                              className="size-3.5 object-contain"
                              onError={(e) => {
                                e.currentTarget.style.display = 'none'
                                e.currentTarget.parentElement!.innerText = String(s.number)
                              }}
                            />
                          </div>
                        ))}
                        {sources.length > 3 && (
                          <div className="size-5 rounded-full bg-gray-100 dark:bg-zinc-800 border border-white dark:border-zinc-900 flex items-center justify-center text-[9px] font-bold text-gray-500 dark:text-gray-400 z-0">
                            +{sources.length - 3}
                          </div>
                        )}
                      </div>
                      <span className="text-sm text-gray-500 dark:text-gray-400 font-medium group-hover:text-gray-700 dark:group-hover:text-gray-300">Source</span>
                    </div>
                  </div>
                </div>
              )
            } catch (e) {
              console.error("Sources parsing error", e)
              return null
            }
          }
          if (!part.trim()) return null
          const commands: any[] = []
          const matches = part.matchAll(/```json\s*([\s\S]*?)```/g)
          for (const match of matches) {
            try {
              const json = JSON.parse(match[1])
              if (json.action === 'toggle_relay' || json.action === 'set_led') {
                commands.push(json)
              }
            } catch { }
          }
          return (
            <div key={index}>
              <ReactMarkdown
                remarkPlugins={[remarkGfm]}
                components={{
                  code: ({ node, inline, className, children, ...props }: any) => {
                    const match = /language-(\w+)/.exec(className || '')
                    const language = match ? match[1] : ''
                    const isMermaid = language === 'mermaid'
                    if (!inline && isMermaid) {
                      return <MermaidChart chart={String(children).replace(/\n$/, '')} />
                    }
                    // Try to parse JSON and check if it's an ECharts option or Schedule Task
                    if (!inline && (!language || language === 'json')) {
                      try {
                        const content = String(children).replace(/\n$/, '')
                        if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                          const data = JSON.parse(content)
                          // Check for Schedule Task
                          if (data.action === 'schedule_task') {
                            return <ScheduleCard data={data} />
                          }
                          // Basic check for ECharts structure
                          if (data && (data.series || (data.xAxis && data.yAxis))) {
                            return (
                              <div className="my-4 w-full min-w-[300px] md:min-w-[600px] h-[350px] rounded-lg overflow-hidden bg-white dark:bg-zinc-900 relative z-10 border border-gray-100 dark:border-gray-800 shadow-sm">
                                <ChartRenderer options={data} type="echarts" style={{ height: '100%', width: '100%' }} />
                              </div>
                            )
                          }
                        }
                      } catch (e) {
                        // Not valid JSON or not a chart, continue to render as code
                      }
                    }
                    return <code className={cn("bg-gray-100 dark:bg-zinc-800 rounded px-1 font-mono text-sm text-gray-800 dark:text-gray-200 font-semibold", className)} {...props}>{children}</code>
                  },
                  pre: ({ node, children, ...props }: any) => <pre className="bg-gray-50 dark:bg-zinc-900 p-3 rounded-lg overflow-x-auto my-2 border border-gray-200 dark:border-gray-800" {...props}>{children}</pre>,
                  table: ({ children }: any) => <div className="overflow-x-auto my-4 rounded-lg border border-gray-200 dark:border-gray-800"><table className="w-full text-sm text-left text-gray-600 dark:text-gray-300">{children}</table></div>,
                  thead: ({ children }: any) => <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-zinc-900 dark:text-gray-400 font-semibold">{children}</thead>,
                  tbody: ({ children }: any) => <tbody className="divide-y divide-gray-200 dark:divide-gray-800 bg-white dark:bg-transparent">{children}</tbody>,
                  tr: ({ children }: any) => <tr className="hover:bg-gray-50 dark:hover:bg-zinc-800/50 transition-colors">{children}</tr>,
                  th: ({ children }: any) => <th className="px-6 py-3 whitespace-nowrap">{children}</th>,
                  td: ({ children }: any) => <td className="px-6 py-4">{children}</td>,
                  ul: ({ children }: any) => <ul className="list-disc list-inside my-2 space-y-1 ml-2">{children}</ul>,
                  ol: ({ children }: any) => <ol className="list-decimal list-inside my-2 space-y-1 ml-2">{children}</ol>,
                  li: ({ children }: any) => <li className="text-gray-700 dark:text-gray-300">{children}</li>,
                  blockquote: ({ children }: any) => <blockquote className="border-l-4 border-blue-500 pl-4 py-1 my-4 italic bg-blue-50/50 dark:bg-blue-900/10 rounded-r text-gray-600 dark:text-gray-400">{children}</blockquote>,
                  h1: ({ children }: any) => <h1 className="text-2xl font-bold mt-6 mb-4 text-gray-900 dark:text-gray-100">{children}</h1>,
                  h2: ({ children }: any) => <h2 className="text-xl font-bold mt-5 mb-3 text-gray-900 dark:text-gray-100 pb-2 border-b border-gray-100 dark:border-gray-800">{children}</h2>,
                  h3: ({ children }: any) => <h3 className="text-lg font-bold mt-4 mb-2 text-gray-900 dark:text-gray-100">{children}</h3>,
                  a: ({ href, children }: any) => <a href={href} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline decoration-blue-300 underline-offset-2">{children}</a>
                }}
              >
                {part}
              </ReactMarkdown>
              {commands.length > 0 && (
                <div className="mt-3 mb-4">
                  <button
                    onClick={() => executeCommands(commands)}
                    className="group relative flex items-center gap-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-5 py-3 rounded-xl font-medium transition-all shadow-[0_4px_14px_0_rgba(59,130,246,0.39)] hover:shadow-[0_6px_20px_rgba(59,130,246,0.23)] hover:-translate-y-0.5 active:translate-y-0 active:scale-95 overflow-hidden"
                  >
                    <div className="absolute inset-0 bg-white/20 group-hover:translate-x-[100%] transition-transform duration-700 -skew-x-12 -translate-x-[100%]"></div>
                    <Zap size={18} className="animate-pulse" />
                    <div className="flex flex-col items-start">
                      <span className="text-sm font-bold leading-none">立即执行指令</span>
                      <span className="text-[10px] opacity-80 font-mono mt-0.5">Execute {commands.length} Command{commands.length > 1 ? 's' : ''}</span>
                    </div>
                    <ArrowRight size={16} className="opacity-60 group-hover:translate-x-1 transition-transform" />
                  </button>
                </div>
              )}
            </div>
          )
        })}
      </>
    )
  }
  const groupedSessions = sessions.reduce((acc, session) => {
    const date = new Date(session.createdAt)
    const today = new Date()
    const yesterday = new Date(today)
    yesterday.setDate(yesterday.getDate() - 1)
    let key = "Earlier"
    if (date.toDateString() === today.toDateString()) key = "Today"
    else if (date.toDateString() === yesterday.toDateString()) key = "Yesterday"
    else if (today.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) key = "Previous 7 Days"
    if (!acc[key]) acc[key] = []
    acc[key].push(session)
    return acc
  }, {} as Record<string, SessionMeta[]>)
  const groupOrder = ["Today", "Yesterday", "Previous 7 Days", "Earlier"]
  return (
    <div className="fixed inset-0 w-full h-full bg-white dark:bg-zinc-950 text-zinc-800 dark:text-zinc-100 font-sans overflow-hidden flex">
      {/* Sidebar */}
      <div className={cn(
        "flex-shrink-0 bg-[#f9f9f9] dark:bg-zinc-900 flex flex-col transition-all duration-300 ease-in-out border-r border-gray-200 dark:border-gray-800 relative",
        sidebarOpen ? "w-[260px]" : "w-0 overflow-hidden"
      )}>
        {/* Top Nav Items */}
        <div className="p-3 space-y-1">
          {/* Logo Section */}
          <div className="flex items-center gap-2 px-2 py-3 mb-1">
            <div className="size-16 relative flex-shrink-0 rounded-full overflow-hidden bg-white dark:bg-zinc-800 border border-gray-100 dark:border-gray-700">
              <Image src="/logo.gif" alt="Logo" width={64} height={64} className="object-cover" unoptimized />
            </div>
            <div className="h-8 w-26 relative flex-shrink-0">
              <Image src="/logo-chat.svg" alt="Logo Text" fill className="object-contain object-left dark:invert" />
            </div>
          </div>
          <div className="flex items-center justify-between px-2 py-2 mb-2">
            <button
              onClick={createNewSession}
              className="flex items-center gap-2 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded-lg px-2 py-1 transition-colors text-sm font-medium w-full text-gray-700 dark:text-gray-300"
            >
              <SquarePen size={18} />
              <span>新会话</span>
            </button>
            <button onClick={() => setSidebarOpen(false)} className="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 md:hidden">
              <PanelLeftClose size={18} />
            </button>
          </div>
          {/* Mock Nav Items */}
          <div className="space-y-1">
            {/* Search */}
            <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded-lg transition-colors text-left">
              <Search size={18} />
              <span>搜索会话</span>
            </button>
            {/* Return Button */}
            <button
              onClick={() => router.push('/dashboard')}
              className="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded-lg transition-colors text-left"
            >
              <ArrowLeft size={18} />
              <span>返回</span>
            </button>
          </div>
        </div>
        {/* Scrollable Chat History */}
        <div className="flex-1 overflow-y-auto px-3 custom-scrollbar">
          <div className="flex flex-col gap-4 pb-4 pt-2">
            {groupOrder.map(key => {
              const group = groupedSessions[key]
              if (!group || group.length === 0) return null
              return (
                <div key={key}>
                  <div className="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2 px-3">{key === "Today" ? "今天" : key === "Yesterday" ? "昨天" : key === "Previous 7 Days" ? "过去7天" : "更早"}</div>
                  <div className="flex flex-col gap-0.5">
                    {group.map(s => (
                      <div
                        key={s.id}
                        className={cn(
                          "group flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors text-sm overflow-hidden relative",
                          sessionId === s.id ? "bg-gray-200 dark:bg-zinc-800 text-gray-900 dark:text-gray-100" : "hover:bg-gray-200 dark:hover:bg-zinc-800 text-gray-700 dark:text-gray-300"
                        )}
                        onClick={() => { setSessionId(s.id); if (window.innerWidth < 768) setSidebarOpen(false) }}
                      >
                        <div className="flex-1 truncate relative z-10">
                          {s.title}
                        </div>
                        {sessionId === s.id && (
                          <div className="absolute right-2 top-1/2 -translate-y-1/2 flex items-center z-20">
                            <button onClick={(e) => deleteSession(s.id, e)} className="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 p-1 rounded-md transition-colors"><Trash size={14} /></button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )
            })}
          </div>
        </div>
        {/* Bottom User/Upgrade */}
        <div className="p-3 border-t border-gray-200 dark:border-gray-800 mt-auto">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded-lg transition-colors text-left">
                <Avatar className="size-8 border border-gray-200 dark:border-gray-700">
                  <AvatarImage src={user?.avatar_url || undefined} />
                  <AvatarFallback className="bg-green-600 text-white text-xs">{user?.username?.[0]?.toUpperCase() || "U"}</AvatarFallback>
                </Avatar>
                <div className="flex-1 truncate font-medium">{user?.username || "User"}</div>
              </button>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="w-56" align="start" side="top">
              <DropdownMenuItem className="cursor-pointer gap-2" onClick={() => setSettingsOpen(true)}>
                <Settings size={16} /> 设置
              </DropdownMenuItem>
              <DropdownMenuItem className="cursor-pointer gap-2 text-red-600" onClick={() => router.push('/login')}>
                <LogOut size={16} /> 退出登录
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
        <div className="fixed bottom-24 right-4 z-50 flex flex-col-reverse gap-2 pointer-events-none">
          {notices.map(notice => (
            <div key={notice.id} className="pointer-events-auto w-80 bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 overflow-hidden animate-in slide-in-from-right-full fade-in duration-300">
              {/* Header */}
              <div className="flex items-start gap-3 p-4 pb-3">
                {/* Icon */}
                <div className="mt-0.5 shrink-0">
                  {notice.variant === 'loading' ? (
                    <Loader2 size={20} className="text-blue-500 animate-spin" />
                  ) : notice.variant === 'success' ? (
                    <CheckCircle2 size={20} className="text-green-500" />
                  ) : notice.variant === 'error' ? (
                    <AlertCircle size={20} className="text-red-500" />
                  ) : (
                    <Sparkles size={20} className="text-gray-500" />
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="font-semibold text-gray-900 dark:text-gray-100 text-[15px] leading-tight">{notice.title}</h3>
                  {notice.expanded && notice.description && (
                    <p className="text-gray-500 dark:text-gray-400 text-sm mt-2 leading-relaxed break-words">{notice.description}</p>
                  )}
                </div>
                {/* Actions */}
                <div className="flex items-center gap-1 -mt-1 -mr-1 shrink-0">
                  {notice.description && (
                    <button
                      onClick={() => toggleNoticeExpanded(notice.id)}
                      className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 p-1.5 rounded-lg hover:bg-gray-50 dark:hover:bg-zinc-800 transition-colors"
                    >
                      <ChevronDown size={16} className={cn("transition-transform duration-200", notice.expanded ? "rotate-180" : "")} />
                    </button>
                  )}
                  <button
                    onClick={() => closeNotice(notice.id)}
                    className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 p-1.5 rounded-lg hover:bg-gray-50 dark:hover:bg-zinc-800 transition-colors"
                  >
                    <X size={16} />
                  </button>
                </div>
              </div>
              {/* Footer / Collapsed Description */}
              {!notice.expanded && notice.description && (
                <div className="bg-gray-50/80 dark:bg-zinc-800/80 px-4 py-3 border-t border-gray-100/50 dark:border-gray-800/50">
                  <p className="text-gray-600 dark:text-gray-400 text-sm leading-normal line-clamp-2">
                    {notice.description}
                  </p>
                </div>
              )}
              {/* Progress Bar for Auto-close */}
              {notice.variant !== 'loading' && (
                <div className="h-1 w-full bg-gray-100/50 dark:bg-zinc-800/50">
                  <div className="h-full bg-green-500 origin-left animate-[shrink_5s_linear_forwards]" />
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
      {/* Main Content */}
      <div className="flex-1 flex flex-col h-full relative bg-white dark:bg-zinc-950">
        {/* Top Bar */}
        <div className="h-14 flex items-center justify-between px-4 sticky top-0 z-10 bg-white dark:bg-zinc-950/80 backdrop-blur-md">
          <div className="flex items-center gap-2">
            {!sidebarOpen && (
              <button onClick={() => setSidebarOpen(true)} className="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800">
                <PanelLeftOpen size={20} />
              </button>
            )}
            {sidebarOpen && (
              <button id="ai-sidebar-toggle" onClick={() => setSidebarOpen(false)} className="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 md:hidden">
                <PanelLeftClose size={20} />
              </button>
            )}
            <div id="ai-model-selector-nav">
            <PromptInputModelSelect value={selectedModel || aiSettings?.model || "qwen-vl-plus"} onValueChange={(val) => {
              setSelectedModel(val)
              if (aiSettings) {
                const newSettings = { ...aiSettings, model: val }
                setAiSettings(newSettings)
                localStorage.setItem("ai-settings", JSON.stringify(newSettings))
              } else {
                // If no settings yet, create default with this model
                const defaultSettings = {
                  apiKey: "",
                  apiUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1",
                  model: val,
                  systemPrompt: ""
                }
                setAiSettings(defaultSettings)
                localStorage.setItem("ai-settings", JSON.stringify(defaultSettings))
              }
            }}>
              <PromptInputModelSelectTrigger className="bg-transparent border-0 hover:bg-gray-100 dark:hover:bg-zinc-800 text-gray-700 dark:text-gray-300 gap-1 px-2 py-1.5 rounded-lg transition-colors shadow-none focus:ring-0 h-auto">
                <span className="text-gray-600 dark:text-gray-400 font-semibold text-lg">{selectedModel || aiSettings?.model || "Qwen"}</span>
                <ChevronDown size={16} className="text-gray-400 ml-1" />
              </PromptInputModelSelectTrigger>
              <PromptInputModelSelectContent className="w-[200px]">
                <PromptInputModelSelectItem value="qwen3-vl-plus">Qwen3 VL Plus</PromptInputModelSelectItem>
                <PromptInputModelSelectItem value="qwen3-vl-flash">Qwen3 VL Flash</PromptInputModelSelectItem>
                <PromptInputModelSelectItem value="qwen3-max">Qwen3 Max</PromptInputModelSelectItem>
                <PromptInputModelSelectItem value="qwen3-flash">Qwen3 Flash</PromptInputModelSelectItem>
              </PromptInputModelSelectContent>
            </PromptInputModelSelect>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {/* Placeholder for 'Get Plus' if needed, sticking to minimal for now or user avatar if not in sidebar */}
            {/* In design, User Avatar is top right of Main Area. I'll put it here too as an alternative or primary access. */}
            <Avatar className="size-8 border border-gray-200 dark:border-gray-700 cursor-pointer hover:opacity-80">
              <AvatarImage src={user?.avatar_url || undefined} />
              <AvatarFallback className="bg-green-600 text-white text-xs">{user?.username?.[0]?.toUpperCase() || "U"}</AvatarFallback>
            </Avatar>
          </div>
        </div>
        {/* Chat Area */}
        <div id="ai-welcome-area" className="flex-1 min-h-0 relative flex flex-col overflow-y-auto custom-scrollbar">
          {messages.length === 0 ? (
            <div className="flex-1 flex flex-col items-center p-4 min-h-[600px]">
              <div className="w-full max-w-5xl flex flex-col items-center m-auto py-20">
              {/* Header */}
              <div className="text-center mb-10 space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <h1 className="text-4xl md:text-5xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">
                  晚上好，{user?.username || '农场主'}
                </h1>
                <p className="text-xl text-gray-500 dark:text-gray-400 font-medium">
                  今天想为您的农场做些什么？
                </p>
              </div>
              {/* Input Bar in Center for Empty State */}
              <div className="w-full max-w-4xl relative mb-10 animate-in fade-in slide-in-from-bottom-6 duration-700 delay-100">
                <div className="bg-white dark:bg-zinc-900 rounded-[24px] px-5 py-4 shadow-[0_8px_30px_rgba(0,0,0,0.08)] hover:shadow-[0_12px_40px_rgba(0,0,0,0.12)] transition-all duration-300 border border-gray-100 dark:border-gray-800 group">
                  {attachments.length > 0 && (
                    <div className="flex gap-2 overflow-x-auto py-2 mb-2">
                      {attachments.map((url, i) => (
                        <div key={i} className="relative w-14 h-14 rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 group/img shrink-0">
                          <Image src={url} alt="upload" fill className="object-cover" />
                          <button onClick={() => removeAttachment(i)} className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover/img:opacity-100 text-white transition-opacity"><X size={16} /></button>
                        </div>
                      ))}
                    </div>
                  )}
                  <div className="flex gap-3">
                    <textarea
                      value={input}
                      onChange={(e) => setInput(e.target.value)}
                      onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend() } }}
                      onPaste={handlePaste}
                      placeholder="问点什么..."
                      className="w-full bg-transparent border-0 focus:ring-0 resize-none text-gray-800 dark:text-gray-100 placeholder:text-gray-400 text-lg leading-relaxed py-2"
                      rows={1}
                      style={{ minHeight: '44px', maxHeight: '200px' }}
                      onInput={(e) => {
                        const target = e.target as HTMLTextAreaElement;
                        target.style.height = 'auto';
                        target.style.height = `${Math.min(target.scrollHeight, 200)}px`;
                      }}
                    />
                    {input.trim() && (
                      <button
                        onClick={handleSend}
                        className="self-end mb-1 p-2 bg-black dark:bg-white text-white dark:text-black rounded-xl hover:bg-gray-800 dark:hover:bg-gray-200 transition-all active:scale-95 shadow-md"
                      >
                        <ArrowUp size={20} strokeWidth={2.5} />
                      </button>
                    )}
                  </div>
                  <div className="flex items-center justify-between mt-2 pt-2 border-t border-gray-100 dark:border-gray-800">
                    <div className="flex items-center gap-2">
                      <PromptInputModelSelect value={selectedModel || aiSettings?.model || "qwen-vl-plus"} onValueChange={(val) => {
                      setSelectedModel(val)
                      if (aiSettings) {
                        const newSettings = { ...aiSettings, model: val }
                        setAiSettings(newSettings)
                        localStorage.setItem("ai-settings", JSON.stringify(newSettings))
                      } else {
                         const defaultSettings = {
                          apiKey: "",
                          apiUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1",
                          model: val,
                          systemPrompt: ""
                        }
                        setAiSettings(defaultSettings)
                        localStorage.setItem("ai-settings", JSON.stringify(defaultSettings))
                      }
                    }}>
                        <PromptInputModelSelectTrigger id="ai-model-selector-empty" className="bg-gray-50 dark:bg-zinc-800 border-0 hover:bg-gray-100 dark:hover:bg-zinc-700 text-gray-600 dark:text-gray-300 gap-1.5 px-3 py-1.5 rounded-lg transition-colors shadow-none focus:ring-0 h-auto text-xs font-semibold uppercase tracking-wide">
                          <span>{selectedModel || aiSettings?.model || "模型"}</span>
                          <ChevronDown size={12} className="text-gray-400" />
                        </PromptInputModelSelectTrigger>
                        <PromptInputModelSelectContent className="w-[200px]">
                          <PromptInputModelSelectItem value="qwen3-vl-plus">Qwen3 VL Plus</PromptInputModelSelectItem>
                          <PromptInputModelSelectItem value="qwen3-vl-flash">Qwen3 VL Flash</PromptInputModelSelectItem>
                          <PromptInputModelSelectItem value="qwen3-max">Qwen3 Max</PromptInputModelSelectItem>
                          <PromptInputModelSelectItem value="qwen3-flash">Qwen3 Flash</PromptInputModelSelectItem>
                        </PromptInputModelSelectContent>
                      </PromptInputModelSelect>
                    </div>
                    <div id="ai-tools-empty" className="flex items-center gap-3">
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                        title="上传文件"
                      >
                        <Paperclip size={20} />
                      </button>
                      <button
                        onClick={() => setEnableSearch(!enableSearch)}
                        className={cn("transition-colors", enableSearch ? "text-blue-500" : "text-gray-400 hover:text-gray-700 dark:hover:text-gray-200")}
                        title="联网搜索"
                      >
                        <Globe size={20} />
                      </button>
                      <button
                        onClick={() => setEnableReasoning(!enableReasoning)}
                        className={cn("transition-colors", enableReasoning ? "text-purple-500" : "text-gray-400 hover:text-gray-700 dark:hover:text-gray-200")}
                        title="深度思考"
                      >
                        <Sparkles size={20} />
                      </button>
                    </div>
                  </div>
                </div>
                <input ref={fileInputRef} type="file" accept="image/*,.pdf,.doc,.docx,.txt,.md" multiple className="hidden" onChange={onSelectFiles} />
              </div>
              {/* Quick Actions */}
              <div id="ai-quick-actions" className="flex flex-wrap justify-center gap-3 mb-10 max-w-4xl animate-in fade-in slide-in-from-bottom-8 duration-700 delay-200">
                {[
                  { icon: <Activity size={16} />, text: "分析环境数据", action: "分析当前环境数据" },
                  { icon: <Sprout size={16} />, text: "制定灌溉计划", action: "制定今日灌溉计划" },
                  { icon: <Search size={16} />, text: "诊断病虫害", action: "诊断草莓病害" },
                  { icon: <SquarePen size={16} />, text: "生成种植周报", action: "生成本周种植报告" },
                  { icon: <Zap size={16} />, text: "检查设备状态", action: "检查设备运行状态" },
                ].map((item, i) => (
                  <button
                    key={i}
                    onClick={() => handleSend(item.action)}
                    className="flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-zinc-900 border border-gray-200/80 dark:border-gray-800 rounded-full text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-zinc-800 hover:text-gray-900 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-700 transition-all shadow-sm hover:shadow-md"
                  >
                    <span className="text-gray-400">{item.icon}</span>
                    {item.text}
                  </button>
                ))}
              </div>
              {/* Widgets Grid */}
              <div className="w-full max-w-5xl grid grid-cols-1 md:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-10 duration-700 delay-300">
                {/* Weather Widget */}
                <div className="bg-white dark:bg-zinc-900 rounded-3xl p-6 shadow-[0_2px_20px_rgba(0,0,0,0.04)] border border-gray-100 dark:border-gray-800 flex flex-col justify-between h-48 relative overflow-hidden group hover:shadow-lg transition-all">
                  <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                    <Sun size={80} className="text-amber-500" />
                  </div>
                  <div className="flex justify-between items-start z-10">
                    <div>
                      <div className="flex items-center gap-1 text-gray-500 font-medium mb-1">
                        <span>宁波</span>
                        <ChevronDown size={14} />
                      </div>
                      <div className="text-5xl font-bold text-gray-800 dark:text-gray-100 tracking-tight mt-2">
                        {weatherData?.current?.temp_c || "--"}°C
                      </div>
                    </div>
                    <div className="bg-amber-100 dark:bg-amber-900/30 p-2 rounded-full text-amber-600 dark:text-amber-500">
                      <Sun size={24} />
                    </div>
                  </div>
                  <div className="flex justify-between items-end z-10">
                    <div className="text-gray-400 text-sm">
                      {new Date().toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' })}
                    </div>
                    <div className="text-right">
                      <div className="text-amber-500 font-medium">晴朗</div>
                      <div className="text-xs text-gray-400">高:24° 低:18°</div>
                    </div>
                  </div>
                </div>
                {/* Context-Aware Promo */}
                <div className="md:col-span-2 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 rounded-3xl p-6 border border-blue-100 dark:border-blue-900 relative overflow-hidden group">
                  <div className="absolute top-4 right-4">
                    <span className="bg-white/80 dark:bg-white/10 backdrop-blur-sm px-2 py-1 rounded-md text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider border border-blue-100 dark:border-blue-800">新功能</span>
                  </div>
                  <div className="relative z-10 h-full flex flex-col justify-center items-start max-w-md">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">智能种植助手</h3>
                    <p className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-4">
                      您的 AI 助手现在可以根据实时传感器数据，自动分析环境状况并提供精准的调控建议。不仅如此，它还能为您生成可视化的数据图表。
                    </p>
                    <button onClick={() => handleSend("分析当前环境数据")} className="text-blue-600 dark:text-blue-400 font-semibold text-sm flex items-center gap-1 hover:gap-2 transition-all group-hover:underline">
                      尝试分析环境 <ArrowUpRight size={16} />
                    </button>
                  </div>
                </div>
                {/* Recent Chats / Suggestions */}
                <div className="bg-white dark:bg-zinc-900 rounded-3xl p-6 shadow-[0_2px_20px_rgba(0,0,0,0.04)] border border-gray-100 dark:border-gray-800 hover:shadow-lg transition-all h-48 flex flex-col">
                  <div className="flex items-center gap-2 mb-4 text-gray-400 text-sm font-medium">
                    <RotateCcw size={14} />
                    <span>最近活动</span>
                  </div>
                  <div className="flex-1 flex flex-col gap-3">
                    <div className="group cursor-pointer" onClick={() => handleSend("检查灌溉系统状态")}>
                      <div className="font-medium text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors truncate">灌溉系统检查</div>
                      <div className="text-xs text-gray-400 mt-0.5">2小时前</div>
                    </div>
                    <div className="w-full h-px bg-gray-50 dark:bg-zinc-800"></div>
                    <div className="group cursor-pointer" onClick={() => handleSend("草莓开花期光照建议")}>
                      <div className="font-medium text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors truncate">草莓开花期光照建议</div>
                      <div className="text-xs text-gray-400 mt-0.5">昨天</div>
                    </div>
                  </div>
                </div>
                <div className="bg-white dark:bg-zinc-900 rounded-3xl p-6 shadow-[0_2px_20px_rgba(0,0,0,0.04)] border border-gray-100 dark:border-gray-800 hover:shadow-lg transition-all h-48 flex flex-col">
                  <div className="flex items-center gap-2 mb-4 text-gray-400 text-sm font-medium">
                    <Library size={14} />
                    <span>知识库</span>
                  </div>
                  <div className="flex-1 flex flex-col justify-between">
                    <div>
                      <h4 className="font-medium text-gray-800 dark:text-gray-200 mb-1">病害识别指南</h4>
                      <p className="text-xs text-gray-500 line-clamp-2">
                        上传叶片照片，AI 可识别红蜘蛛、白粉病等常见病害并提供防治方案。
                      </p>
                    </div>
                    <button className="self-start text-xs font-semibold text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                      查看指南
                    </button>
                  </div>
                </div>
                <div className="bg-white dark:bg-zinc-900 rounded-3xl p-6 shadow-[0_2px_20px_rgba(0,0,0,0.04)] border border-gray-100 dark:border-gray-800 hover:shadow-lg transition-all h-48 flex flex-col">
                  <div className="flex items-center gap-2 mb-4 text-gray-400 text-sm font-medium">
                    <Sparkles size={14} />
                    <span>系统状态</span>
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="size-2 rounded-full bg-green-500 animate-pulse"></div>
                      <span className="text-sm font-medium text-gray-700 dark:text-gray-300">所有服务运行正常</span>
                    </div>
                    <div className="space-y-2">
                      <div className="flex justify-between text-xs text-gray-500">
                        <span>API 延迟</span>
                        <span className="font-mono">45ms</span>
                      </div>
                      <div className="w-full h-1.5 bg-gray-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                        <div className="h-full w-[98%] bg-green-500 rounded-full"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          ) : (
            <>
              <Conversation className="flex-1 h-full">
                <ConversationContent id="ai-chat-area" ref={scrollAreaRef} className="p-0 max-w-7xl mx-auto w-full">
                  <div className="flex flex-col pb-40 pt-4 space-y-6">
                    {messages.map((msg, i) => (
                      <div key={i} className={cn(
                        "group w-full flex gap-4 px-4 md:px-0 transition-all duration-300",
                        msg.role === "user" ? "justify-end" : "justify-start"
                      )}>
                        {msg.role === "assistant" && (
                          <div className="size-10 flex items-center justify-center shrink-0 mt-1 rounded-full overflow-hidden bg-white dark:bg-zinc-800 border border-gray-100 dark:border-gray-700">
                            <Image src="/logo.gif" alt="AI" width={40} height={40} className="object-cover" unoptimized />
                          </div>
                        )}
                        <div className={cn(
                          "relative max-w-[85%] rounded-2xl px-5 py-3 text-[15px] leading-relaxed",
                          msg.role === "user"
                            ? "bg-[#f4f4f4] dark:bg-zinc-800 text-gray-900 dark:text-gray-100 rounded-tr-sm"
                            : "bg-transparent text-gray-900 dark:text-gray-100 px-0 py-0"
                        )}>
                          <div id={`message-content-${i}`} className="prose prose-neutral dark:prose-invert max-w-none break-words">
                            {renderMessageContent(msg)}
                          </div>
                          {msg.role === "assistant" && (
                            <div className="flex items-center gap-2 mt-2 no-print">
                              <button onClick={() => copyText(typeof msg.content === 'string' ? msg.content : "")} className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 p-1" title="复制内容"><Copy size={14} /></button>
                              <button className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 p-1" title="重新生成"><RotateCcw size={14} /></button>
                              <button onClick={() => handleDownloadPDF(i)} className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 p-1" title="导出为 PDF"><Download size={14} /></button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                    {isLoading && (
                      <div className="flex gap-4 px-4 md:px-0 max-w-5xl mx-auto w-full">
                        <div className="size-10 flex items-center justify-center shrink-0 mt-1 rounded-full overflow-hidden bg-white dark:bg-zinc-800 border border-gray-100 dark:border-gray-700">
                          <Image src="/logo.gif" alt="AI" width={40} height={40} className="object-cover" unoptimized />
                        </div>
                        <div className="flex items-center gap-1 mt-2">
                          <span className="size-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                          <span className="size-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                          <span className="size-2 bg-gray-400 rounded-full animate-bounce"></span>
                        </div>
                      </div>
                    )}
                    <div ref={messagesEndRef} />
                  </div>
                </ConversationContent>
              </Conversation>
              {/* Floating Input Bar for Chat State */}
              <div id="ai-input-area" className="absolute bottom-0 left-0 w-full bg-transparent pt-4 pb-6 px-4">
                <div className="max-w-5xl mx-auto w-full relative">
                  <div className="bg-white/80 dark:bg-zinc-900/80 backdrop-blur-xl rounded-[26px] px-4 py-3 flex flex-col gap-1 focus-within:bg-white dark:focus-within:bg-zinc-900 focus-within:ring-2 focus-within:ring-[#6366f1]/20 focus-within:border-[#6366f1]/30 transition-all duration-300 border border-gray-200/60 dark:border-gray-800/60 shadow-[0_8px_40px_-12px_rgba(0,0,0,0.1)] hover:shadow-[0_8px_40px_-8px_rgba(0,0,0,0.15)] hover:border-gray-300/80 dark:hover:border-gray-700/80">
                    {/* Attachment Preview */}
                    {attachments.length > 0 && (
                      <div className="flex gap-3 overflow-x-auto py-2 mb-1 scrollbar-none">
                        {attachments.map((url, i) => (
                          <div key={i} className="relative group shrink-0">
                            <div className="w-16 h-16 rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 shadow-sm">
                              <Image src={url} alt="preview" fill className="object-cover" />
                            </div>
                            <button
                              onClick={() => removeAttachment(i)}
                              className="absolute -top-1.5 -right-1.5 bg-gray-900/80 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-all hover:bg-red-500"
                            >
                              <X size={12} />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                    {/* Input Area */}
                    <textarea
                      value={input}
                      onChange={(e) => setInput(e.target.value)}
                      onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend() } }}
                      onPaste={handlePaste}
                      placeholder="发消息给 AI 助手..."
                      className="w-full bg-transparent border-0 focus:ring-0 resize-none text-gray-800 dark:text-gray-100 placeholder:text-gray-400/80 text-[15px] leading-relaxed py-2 px-1 min-h-[40px] max-h-[200px] font-medium"
                      rows={1}
                      style={{ height: 'auto' }}
                      onInput={(e) => {
                        const target = e.target as HTMLTextAreaElement;
                        target.style.height = 'auto';
                        target.style.height = `${Math.min(target.scrollHeight, 200)}px`;
                      }}
                    />
                    {/* Bottom Tools Row */}
                    <div id="ai-input-tools" className="flex items-center justify-between mt-1 pt-2 border-t border-gray-100/60 dark:border-gray-800/60">
                      <div className="flex items-center gap-1.5">
                        <button
                          onClick={() => fileInputRef.current?.click()}
                          className="p-2 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-xl transition-colors text-gray-400 hover:text-[#6366f1] group relative"
                          title="上传文件"
                        >
                          <Paperclip size={18} strokeWidth={2} />
                          <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">上传文件</span>
                        </button>
                        <div className="w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1"></div>
                        <button
                          onClick={() => setEnableSearch(!enableSearch)}
                          className={cn(
                            "px-3 py-1.5 rounded-full transition-all flex items-center gap-2 text-xs font-medium border select-none",
                            enableSearch
                              ? "bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 shadow-sm"
                              : "bg-white dark:bg-zinc-800 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-zinc-700 hover:text-gray-700 dark:hover:text-gray-200"
                          )}
                          title="联网搜索"
                        >
                          <Globe size={14} strokeWidth={2.5} />
                          <span>联网搜索</span>
                        </button>
                        <button
                          onClick={() => setEnableReasoning(!enableReasoning)}
                        className={cn(
                          "px-3 py-1.5 rounded-full transition-all flex items-center gap-2 text-xs font-medium border select-none",
                          enableReasoning
                            ? "bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 border-purple-200 dark:border-purple-800 shadow-sm"
                            : "bg-white dark:bg-zinc-800 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-zinc-700 hover:text-gray-700 dark:hover:text-gray-200"
                        )}
                        title="Deep thinking"
                      >
                        <Sparkles size={14} strokeWidth={2.5} />
                        <span>Reasoning</span>
                      </button>
                      <div className="w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1"></div>
                      <button
                        onClick={handleOptimizePrompt}
                        disabled={!input.trim() || isOptimizing}
                        className={cn(
                          "px-3 py-1.5 rounded-full transition-all flex items-center gap-2 text-xs font-medium border select-none",
                          isOptimizing
                            ? "bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-800 shadow-sm cursor-wait"
                            : input.trim()
                              ? "bg-white dark:bg-zinc-800 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-800 hover:bg-amber-50 dark:hover:bg-amber-900/20"
                              : "bg-white dark:bg-zinc-800 text-gray-300 dark:text-gray-600 border-gray-100 dark:border-gray-800 cursor-not-allowed"
                        )}
                        title="Optimize prompt"
                      >
                        {isOptimizing ? <Loader2 size={14} className="animate-spin" /> : <Wand2 size={14} strokeWidth={2.5} />}
                        <span>Optimize</span>
                      </button>
                    </div>
                    <div className="flex items-center gap-3 pl-2">
                        <button
                          onClick={handleSend}
                          disabled={!input.trim() && attachments.length === 0}
                          className={cn(
                            "size-8 rounded-lg flex items-center justify-center transition-all duration-200",
                            (input.trim() || attachments.length > 0)
                              ? "bg-[#6366f1] text-white hover:bg-[#4f46e5] shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 active:shadow-sm"
                              : "bg-gray-100 dark:bg-zinc-800 text-gray-300 dark:text-gray-600 cursor-not-allowed"
                          )}
                        >
                          <ArrowUp size={18} strokeWidth={3} />
                        </button>
                      </div>
                    </div>
                  </div>
                  {/* Hidden file input for Chat State */}
                  <input ref={fileInputRef} type="file" accept="image/*,.pdf,.doc,.docx,.txt,.md" multiple className="hidden" onChange={onSelectFiles} />
                </div>
              </div>
            </>
          )}
        </div>
        {/* Help Button */}
        <div className="absolute bottom-4 right-4 z-20">
          <button className="size-8 flex items-center justify-center rounded-full bg-white dark:bg-zinc-900 border border-gray-200 dark:border-gray-800 text-gray-500 hover:bg-gray-50 dark:hover:bg-zinc-800 shadow-sm">
            <CircleHelp size={16} />
          </button>
        </div>
      </div>
      <AISettingsDialog
        open={settingsOpen}
        onOpenChange={setSettingsOpen}
        onSave={handleSettingsSave}
      />
    </div>
  )
}
function copyText(text: string) {
  navigator.clipboard.writeText(text)
}

--- FILE: app\api\admin\access-logs\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { getCurrentUser } from "@/lib/auth"
import { getAccessLogs } from "@/lib/db/security-service"
export async function GET(req: NextRequest) {
  const currentUser = await getCurrentUser()
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 })
  }
  try {
    const searchParams = req.nextUrl.searchParams
    const limit = parseInt(searchParams.get("limit") || "100")
    const logs = await getAccessLogs(limit)
    return NextResponse.json(logs)
  } catch (error) {
    console.error("Failed to fetch access logs:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\admin\banned-ips\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { getCurrentUser } from "@/lib/auth"
import { getBannedIPs, addBannedIP, removeBannedIP } from "@/lib/db/security-service"
import { z } from "zod"
const banIpSchema = z.object({
  // 支持 IPv4 和 IPv6
  ip: z.string().refine((val) => {
    // 简单的 IPv4 检查
    const ipv4Regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    // 简单的 IPv6 检查 (允许压缩格式 ::)
    const ipv6Regex = /^([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])$/;
    return ipv4Regex.test(val) || ipv6Regex.test(val);
  }, { message: "无效的 IP 地址 (支持 IPv4 和 IPv6)" }),
  reason: z.string().optional(),
})
export async function GET() {
  const currentUser = await getCurrentUser()
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 })
  }
  try {
    const ips = await getBannedIPs()
    return NextResponse.json(ips)
  } catch (error) {
    console.error("Failed to fetch banned IPs:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}
export async function POST(req: NextRequest) {
  const currentUser = await getCurrentUser()
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 })
  }
  try {
    const body = await req.json()
    const result = banIpSchema.safeParse(body)
    if (!result.success) {
      return NextResponse.json({ error: result.error.issues[0].message }, { status: 400 })
    }
    const { ip, reason } = result.data
    await addBannedIP(ip, reason, currentUser.username)
    return NextResponse.json({ success: true })
  } catch (error) {
    if (error instanceof Error && error.message.includes("UNIQUE constraint failed")) {
       return NextResponse.json({ error: "该 IP 已在封禁列表中" }, { status: 409 })
    }
    console.error("Failed to ban IP:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}
export async function DELETE(req: NextRequest) {
  const currentUser = await getCurrentUser()
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 })
  }
  try {
    const { searchParams } = new URL(req.url)
    const ip = searchParams.get('ip')
    if (!ip) {
      return NextResponse.json({ error: "IP address is required" }, { status: 400 })
    }
    await removeBannedIP(ip)
    return NextResponse.json({ success: true })
  } catch (error) {
    console.error("Failed to unban IP:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\admin\settings\rate-limit\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { getCurrentUser } from "@/lib/auth"
import { getRateLimitConfig, updateRateLimitConfig } from "@/lib/db/settings-service"
import { z } from "zod"
const configSchema = z.object({
  limit: z.number().min(1),
  windowMs: z.number().min(1000),
  violationLimit: z.number().min(1),
  banDuration: z.number().min(1000)
})
export async function GET(req: NextRequest) {
  const currentUser = await getCurrentUser()
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 })
  }
  try {
    const config = await getRateLimitConfig()
    return NextResponse.json(config)
  } catch (error) {
    console.error("Failed to fetch rate limit settings:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}
export async function POST(req: NextRequest) {
  const currentUser = await getCurrentUser()
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 })
  }
  try {
    const body = await req.json()
    const result = configSchema.safeParse(body)
    if (!result.success) {
      return NextResponse.json({ error: result.error.issues[0].message }, { status: 400 })
    }
    await updateRateLimitConfig(result.data)
    return NextResponse.json({ success: true, config: result.data })
  } catch (error) {
    console.error("Failed to update rate limit settings:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\admin\users\route.ts ---

import { NextRequest, NextResponse } from "next/server";
import { getCurrentUser } from "@/lib/auth";
import { createUser, getAllUsers } from "@/lib/db/user-service";
import { z } from "zod";
import { usernameSchema, emailSchema, passwordSchema, avatarUrlSchema } from "@/lib/validations/auth";
const createUserSchema = z.object({
  username: usernameSchema,
  email: emailSchema,
  password: passwordSchema,
  role: z.enum(["user", "admin", "super_admin"]).optional(),
  permissions: z.any().optional(),
  avatar_url: avatarUrlSchema,
});
export async function GET() {
  const currentUser = await getCurrentUser();
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 });
  }
  try {
    const users = await getAllUsers();
    return NextResponse.json(users);
  } catch (error) {
    console.error("Failed to fetch users:", error);
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 });
  }
}
export async function POST(req: NextRequest) {
  const currentUser = await getCurrentUser();
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 });
  }
  try {
    const body = await req.json();
    // Validate input
    const result = createUserSchema.safeParse(body);
    if (!result.success) {
      return NextResponse.json({ error: result.error.issues[0].message }, { status: 400 });
    }
    const newUser = await createUser(result.data);
    return NextResponse.json(newUser);
  } catch (error) {
    console.error("Failed to create user:", error);
    return NextResponse.json({ error: error instanceof Error ? error.message : "Internal Server Error" }, { status: 500 });
  }
}

--- FILE: app\api\admin\users\[id]\route.ts ---

import { NextRequest, NextResponse } from "next/server";
import { getCurrentUser } from "@/lib/auth";
import { getUserById, updateUser, toPublicUser } from "@/lib/db/user-service";
import { z } from "zod";
import { usernameSchema, passwordSchema, avatarUrlSchema } from "@/lib/validations/auth";
const updateUserSchema = z.object({
  username: usernameSchema.optional(),
  password: passwordSchema.optional().or(z.literal("")),
  role: z.enum(["user", "admin", "super_admin"]).optional(),
  permissions: z.any().optional(),
  avatar_url: avatarUrlSchema,
});
export async function PUT(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const currentUser = await getCurrentUser();
  if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 });
  }
  try {
    const { id } = await params;
    const userId = parseInt(id);
    const body = await req.json();
    // Validate input
    const result = updateUserSchema.safeParse(body);
    if (!result.success) {
      return NextResponse.json({ error: result.error.issues[0].message }, { status: 400 });
    }
    const input = result.data;
    // Remove empty password if sent
    if (input.password === "") {
        delete input.password;
    }
    // Check target user
    const targetUser = await getUserById(userId);
    if (!targetUser) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }
    // Authorization checks
    if (currentUser.role === 'admin') {
      // Admin cannot update Super Admin or other Admins
      if (targetUser.role === 'super_admin' || targetUser.role === 'admin') {
         return NextResponse.json({ error: "Admins cannot modify other admins or super admins" }, { status: 403 });
      }
      // Admin cannot promote users to Admin or Super Admin
      if (input.role && (input.role === 'admin' || input.role === 'super_admin')) {
        return NextResponse.json({ error: "Admins cannot promote users to admin roles" }, { status: 403 });
      }
    }
    const updatedUser = await updateUser(userId, input);
    return NextResponse.json(updatedUser);
  } catch (error) {
    console.error("Failed to update user:", error);
    return NextResponse.json({ error: error instanceof Error ? error.message : "Internal Server Error" }, { status: 500 });
  }
}

--- FILE: app\api\ai\device-control\route.ts ---

/**
 * AI Device Control API
 *
 * 允许 AI 助手控制设备
 */
import { NextRequest, NextResponse } from 'next/server'
import { MQTTService } from '@/lib/mqtt-service'
import { getCurrentUser } from '@/lib/auth'
import { checkSecurity, logRequest } from '@/lib/security'
export async function POST(request: NextRequest) {
  // 1. Security Check
  const securityCheck = await checkSecurity(request)
  if (!securityCheck.allowed) {
    return securityCheck.response!
  }
  try {
    // 1. Authentication Check
    const currentUser = await getCurrentUser()
    if (!currentUser) {
      return NextResponse.json(
        { success: false, error: 'Unauthorized' },
        { status: 401 }
      )
    }
    const body = await request.json()
    let { action, device, value, r, g, b } = body
    // Permission Check
    if (currentUser.role !== 'super_admin' && currentUser.role !== 'admin') {
      const permissions = typeof currentUser.permissions === 'string'
        ? JSON.parse(currentUser.permissions || '{}')
        : currentUser.permissions || {};
      const allowedControls = permissions.allowedControls || [];
      if (action === 'toggle_relay') {
        const relayId = `relay${device}`;
        if (!allowedControls.includes(relayId)) {
           return NextResponse.json(
             { success: false, error: `Permission denied: You cannot control ${relayId}` },
             { status: 403 }
           );
        }
      } else if (action === 'set_led') {
        // AI sends r, g, b which map to led1, led2, led3
        if (!allowedControls.includes('led1') && !allowedControls.includes('led2') && !allowedControls.includes('led3')) {
           // If user has NO led permissions, block.
           // Ideally check per channel, but for now block if no LED control allowed.
           // Or strictly:
           if (!allowedControls.includes('led1') || !allowedControls.includes('led2') || !allowedControls.includes('led3')) {
               return NextResponse.json(
                 { success: false, error: `Permission denied: You need full LED control permissions` },
                 { status: 403 }
               );
           }
        }
      }
    }
    console.log('[AI Device Control] Received command:', JSON.stringify(body, null, 2))
    // 验证请求
    if (!action) {
      console.error('[AI Device Control] Missing action parameter')
      return NextResponse.json(
        { success: false, error: 'Missing action parameter' },
        { status: 400 }
      )
    }
    const mqttService = MQTTService.getInstance()
    // Ensure MQTT connected
    if (!mqttService.isConnected()) {
      try {
        await mqttService.connect()
      } catch (e) {
        return NextResponse.json({ success: false, error: 'MQTT Connection Failed' }, { status: 503 })
      }
    }
    // 根据不同的 action 执行不同的控制
    if (action === 'toggle_relay') {
      // 规范化 value 值，兼容 boolean 和 string
      if (typeof value === 'boolean') {
        value = value ? 1 : 0
      } else if (typeof value === 'string') {
        const v = value.toLowerCase()
        if (v === '1' || v === 'true' || v === 'on') value = 1
        else if (v === '0' || v === 'false' || v === 'off') value = 0
      }
      if (device === undefined || device === null || (value !== 0 && value !== 1)) {
        return NextResponse.json(
          { success: false, error: `Invalid device (${device}) or value (${value}) for toggle_relay. Device must be 5-8, value must be 0 or 1.` },
          { status: 400 }
        )
      }
      // 验证设备编号范围
      if (device < 5 || device > 8) {
        return NextResponse.json(
          { success: false, error: `Invalid device number: ${device}. Must be between 5 and 8.` },
          { status: 400 }
        )
      }
      // 直接调用 MQTT Service，不再通过 API
      const mqttPayload = {
        type: 'relay' as const,
        relayNum: device,
        newState: value
      }
      console.log('[AI Device Control] Calling MQTT Service with:', mqttPayload)
      await mqttService.sendControlCommand(mqttPayload)
      return NextResponse.json({
        success: true,
        message: 'Control command sent successfully',
        timestamp: Date.now()
      })
    } else if (action === 'set_led') {
      if (r === undefined || g === undefined || b === undefined) {
        return NextResponse.json(
          { success: false, error: 'Missing RGB values for set_led' },
          { status: 400 }
        )
      }
      // 验证 RGB 值范围
      if (r < 0 || r > 255 || g < 0 || g > 255 || b < 0 || b > 255) {
        return NextResponse.json(
          { success: false, error: 'RGB values must be between 0 and 255' },
          { status: 400 }
        )
      }
      // 直接调用 MQTT Service
      const mqttPayload = {
        type: 'led' as const,
        led1: r,  // 红色
        led2: g,  // 绿色
        led3: b,  // 蓝色
        led4: 0   // 白色（保留）
      }
      console.log('[AI Device Control] Calling MQTT Service with:', mqttPayload)
      await mqttService.sendControlCommand(mqttPayload)
      return NextResponse.json({
        success: true,
        message: 'Control command sent successfully',
        timestamp: Date.now()
      })
    } else {
      return NextResponse.json(
        { success: false, error: `Unknown action: ${action}` },
        { status: 400 }
      )
    }
  } catch (error) {
    console.error('[AI Device Control] Error:', error)
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    )
  }
}
// 返回可用的控制命令说明
export async function GET() {
  return NextResponse.json({
    availableActions: {
      toggle_relay: {
        description: "开关继电器设备",
        parameters: {
          action: "toggle_relay",
          device: "继电器编号 (5=水泵, 6=风扇, 7=补光灯, 8=白灯)",
          value: "状态值 (0=关闭, 1=开启)"
        },
        example: {
          action: "toggle_relay",
          device: 5,
          value: 1
        }
      },
      set_led: {
        description: "设置 RGB LED 补光灯颜色",
        parameters: {
          action: "set_led",
          r: "红色值 (0-255)",
          g: "绿色值 (0-255)",
          b: "蓝色值 (0-255)"
        },
        example: {
          action: "set_led",
          r: 255,
          g: 100,
          b: 50
        }
      }
    }
  })
}

--- FILE: app\api\ai\device-status\route.ts ---

/**
 * AI Device Status API
 *
 * 为 AI 助手提供当前设备状态和环境数据
 */
import { NextResponse } from 'next/server'
// 这个端点会被 AI 调用来获取当前设备状态
export async function GET() {
  try {
    // 从 MQTT 服务获取最新的设备数据
    // 注意：这里需要从某个地方获取最新数据
    // 可以考虑使用 Redis 或内存缓存来存储最新的设备状态
    // 暂时返回示例数据结构
    return NextResponse.json({
      success: true,
      message: "请通过 SSE 连接 /api/mqtt/stream 获取实时设备数据",
      dataStructure: {
        temperature: "温度 (单位: 0.1°C, 需除以10)",
        humidity: "湿度 (单位: 0.1%, 需除以10)",
        light: "光照强度 (lux)",
        co2: "二氧化碳浓度 (ppm)",
        earth_temp: "土壤温度 (单位: 0.1°C, 需除以10)",
        earth_water: "土壤湿度 (%)",
        earth_ec: "土壤电导率 (μS/cm)",
        earth_n: "土壤氮含量 (mg/kg)",
        earth_p: "土壤磷含量 (mg/kg)",
        earth_k: "土壤钾含量 (mg/kg)",
        relay5: "水泵状态 (0=关闭, 1=开启)",
        relay6: "风扇状态 (0=关闭, 1=开启)",
        relay7: "补光灯状态 (0=关闭, 1=开启)",
        relay8: "白灯状态 (0=关闭, 1=开启)",
        led1: "红色LED亮度 (0-255)",
        led2: "绿色LED亮度 (0-255)",
        led3: "蓝色LED亮度 (0-255)",
        led4: "保留LED (0-255)"
      }
    })
  } catch (error) {
    console.error('[AI Device Status] Error:', error)
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    )
  }
}

--- FILE: app\api\ai\optimize-prompt\route.ts ---

import { NextResponse } from 'next/server'
export const runtime = 'nodejs'
export async function POST(req: Request) {
  try {
    const { prompt, apiKey, apiUrl, model } = await req.json()
    if (!apiKey) {
      return NextResponse.json(
        { error: "API Key is required" },
        { status: 400 }
      )
    }
    if (!prompt) {
      return NextResponse.json(
        { error: "Prompt is required" },
        { status: 400 }
      )
    }
    const systemPrompt = `你是一个专业的提示词优化专家。你的任务是将用户输入的简单、模糊的提示词重写为清晰、结构化、高质量的提示词。
优化原则：
1. **明确目标**：清晰地陈述希望 AI 完成的任务。
2. **补充细节**：补充必要的背景信息、约束条件或格式要求。
3. **结构化**：使用清晰的结构（如角色设定、任务描述、输出要求等）。
4. **保持原意**：不要改变用户原本的意图，只是使其更专业、更易于 AI 理解。
5. **简洁有力**：去除冗余词汇，使用精确的表达。
请直接输出优化后的提示词，不要包含任何解释或额外的对话内容。优化后的提示词应该是中文的（除非用户明确要求英文）。`
    // 构建请求体，复用 chat 接口的逻辑结构，但这里是一次性请求
    let targetUrl = apiUrl || ""
    const isDashScope = apiUrl?.includes("dashscope.aliyuncs.com") || model?.startsWith("qwen")
    const isCompatibleMode = apiUrl?.includes("compatible-mode/v1") ?? false
    let requestBody
    let headers: Record<string, string> = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
    }
    if (isDashScope && !isCompatibleMode) {
        // DashScope Native API
        requestBody = {
            model: model || "qwen-plus",
            input: {
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `请优化以下提示词：\n\n${prompt}` }
                ]
            },
            parameters: {
                result_format: "message"
            }
        }
    } else {
        // OpenAI Compatible API
        if (/\/v1$/.test(targetUrl) && !/\/chat\/completions(\?|$)/.test(targetUrl)) {
            targetUrl = `${targetUrl}/chat/completions`
        }
        requestBody = {
            model: model || "gpt-3.5-turbo",
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: `请优化以下提示词：\n\n${prompt}` }
            ],
            stream: false
        }
    }
    const response = await fetch(targetUrl, {
        method: "POST",
        headers,
        body: JSON.stringify(requestBody)
    })
    if (!response.ok) {
        const error = await response.text()
        return NextResponse.json({ error: `API Error: ${response.status} - ${error}` }, { status: response.status })
    }
    const data = await response.json()
    let optimizedPrompt = ""
    if (isDashScope && !isCompatibleMode) {
        optimizedPrompt = data.output?.choices?.[0]?.message?.content || ""
    } else {
        optimizedPrompt = data.choices?.[0]?.message?.content || ""
    }
    return NextResponse.json({ optimizedPrompt })
  } catch (error) {
    console.error("Optimize prompt error:", error)
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    )
  }
}

--- FILE: app\api\auth\alipay\callback\route.ts ---

import { NextResponse } from "next/server"
import { cookies } from "next/headers"
import { AlipaySdk } from 'alipay-sdk'
import { findOrCreateAlipayUser } from "@/lib/db/user-service"
import { updateTicketWithJwt } from "@/lib/db/ticket-service"
import { generateToken, setAuthCookie } from "@/lib/auth"
export async function GET(req: Request) {
  const url = new URL(req.url)
  // 优先使用环境变量配置的 APP_URL，解决容器/反代环境下 req.url 可能为内网IP的问题
  const appUrl = process.env.APP_URL || url.origin
  const authCode = url.searchParams.get("auth_code")
  const state = url.searchParams.get("state")
  const ticket = url.searchParams.get("ticket") // 获取移动端跨浏览器登录凭证
  // 如果是 ticket 模式，不需要校验 cookie 中的 state (因为是跨浏览器的)
  if (!ticket) {
    const cookieStore = await cookies()
    const expectedState = cookieStore.get("alipay_state")?.value
    // 简单的 State 验证
    if (!authCode || !state || !expectedState || expectedState !== state) {
      console.error("Alipay state mismatch:", { authCode: !!authCode, state, expectedState })
      return NextResponse.redirect(`${appUrl}/login?error=alipay_state`)
    }
  } else {
    // 简单校验
    if (!authCode) {
      return NextResponse.redirect(`${appUrl}/login?error=alipay_code_missing`)
    }
  }
  const appId = process.env.ALIPAY_APP_ID
  const privateKey = process.env.ALIPAY_PRIVATE_KEY
  const alipayPublicKey = process.env.ALIPAY_PUBLIC_KEY // 支付宝公钥
  if (!appId || !privateKey || !alipayPublicKey) {
    console.error("Alipay configuration missing")
    return NextResponse.redirect(`${appUrl}/login?error=alipay_config`)
  }
  const alipaySdk = new AlipaySdk({
    appId,
    privateKey,
    alipayPublicKey,
    // 如果是沙箱环境，可以配置 gateway: 'https://openapi.alipaydev.com/gateway.do',
  })
  try {
    // 1. 使用 auth_code 换取 access_token
    // alipay.system.oauth.token
    const tokenResult: any = await alipaySdk.exec('alipay.system.oauth.token', {
      grant_type: 'authorization_code',
      code: authCode,
    })
    // alipay-sdk 返回的是 response body 中的内容
    const accessToken = tokenResult.accessToken || tokenResult.access_token
    if (!accessToken) {
      console.error("Failed to get alipay access token:", tokenResult)
      return NextResponse.redirect(`${appUrl}/login?error=alipay_token`)
    }
    // 2. 获取用户信息
    // alipay.user.info.share
    const userResult: any = await alipaySdk.exec('alipay.user.info.share', {
      auth_token: accessToken,
    })
    // 检查响应码，成功是 "10000"
    // 注意：alipay-sdk 可能会自动解包，也可能返回原始结构
    // 如果是原始结构，code 可能在 alipay_user_info_share_response 中
    const code = userResult.code || userResult.alipay_user_info_share_response?.code || userResult.alipayUserInfoShareResponse?.code;
    if (code && code !== '10000') {
        console.error("Failed to get alipay user info:", userResult)
        return NextResponse.redirect(`${appUrl}/login?error=alipay_user_info&code=${code}`)
    }
    console.log("Alipay User Result Keys:", Object.keys(userResult));
    const alipayUserId = userResult.userId ||
                         userResult.user_id ||
                         userResult.openId ||
                         userResult.open_id ||
                         userResult.alipay_user_info_share_response?.user_id ||
                         userResult.alipayUserInfoShareResponse?.userId ||
                         userResult.alipay_user_info_share_response?.open_id ||
                         userResult.alipayUserInfoShareResponse?.openId;
    console.log("Alipay Login Debug - Extracted ID:", alipayUserId)
    if (!alipayUserId) {
        console.error("Alipay user_id missing in response")
        const debugInfo = encodeURIComponent(JSON.stringify(userResult).slice(0, 200));
        return NextResponse.redirect(`${appUrl}/login?error=alipay_user_id_missing&debug=${debugInfo}`)
    }
    // 3. 查找或创建用户
    const user = await findOrCreateAlipayUser({
      userId: alipayUserId,
      nickname: userResult.nickName || userResult.nick_name || userResult.alipayUserInfoShareResponse?.nickName || "支付宝用户",
      avatar: userResult.avatar || userResult.alipayUserInfoShareResponse?.avatar,
    })
    // 4. 登录
    const jwt = await generateToken({ id: user.id, email: user.email, username: user.username })
    // 如果是 ticket 模式 (移动端跨浏览器登录)
    if (ticket) {
        await updateTicketWithJwt(ticket, jwt)
        // 返回一个提示页，告诉用户可以返回浏览器了
        const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>登录成功</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 40px 20px; }
    .icon { font-size: 64px; color: #52c41a; margin-bottom: 20px; }
    h3 { margin-bottom: 10px; }
    p { color: #666; margin-bottom: 30px; }
    .btn { display: block; width: 100%; max-width: 300px; margin: 20px auto; padding: 12px 0; background: #1677FF; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; }
  </style>
</head>
<body>
  <div class="icon"></div>
  <h3>授权成功</h3>
  <p>您已成功登录，请手动返回刚才的浏览器页面，系统将自动跳转。</p>
  <a href="javascript:history.back()" class="btn">返回上一页</a>
</body>
</html>
        `
        return new NextResponse(html, { headers: { 'Content-Type': 'text/html' } })
    }
    // 注意：在 Next.js Route Handler 中，如果使用 cookies().set() 后直接返回 NextResponse.redirect，
    // Cookie 有时可能不会正确合并到响应头中。
    // 为了确保 Cookie 一定能种下，我们显式在 Response 对象上设置 Cookie。
    // await setAuthCookie(jwt)
    const res = NextResponse.redirect(`${appUrl}/monitor`)
    // 强制设置 Cookie，确保兼容 HTTP 环境 (secure: false)
    // 如果您的生产环境启用了 HTTPS，可以考虑根据协议动态设置 secure
    res.cookies.set("auth", jwt, {
        httpOnly: true,
        sameSite: "lax",
        secure: false, // 允许 HTTP 访问 (解决云服务无 HTTPS 导致 Cookie 丢失的问题)
        path: "/",
        maxAge: 60 * 60 * 24 * 7, // 7 天
    })
    return res
  } catch (error: any) {
    console.error("Alipay callback error:", error)
    return NextResponse.redirect(`${appUrl}/login?error=alipay_error&message=${encodeURIComponent(error.message || "")}`)
  }
}

--- FILE: app\api\auth\alipay\login\route.ts ---

import { NextResponse } from "next/server"
import { createTicket } from "@/lib/db/ticket-service"
export async function GET(req: Request) {
  const appId = process.env.ALIPAY_APP_ID
  if (!appId) {
    return NextResponse.json({ error: "未配置 ALIPAY_APP_ID" }, { status: 500 })
  }
  const url = new URL(req.url)
  // 优先使用环境变量配置的 APP_URL
  const origin = process.env.APP_URL || url.origin
  let redirectUri = `${origin}/api/auth/alipay/callback`
  const state = Math.random().toString(36).slice(2) + Date.now().toString(36)
  // 检测是否移动端
  const userAgent = req.headers.get("user-agent") || ""
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
  // 如果是移动端，生成 ticket 并附加到 redirectUri
  let ticket = ""
  if (isMobile) {
    ticket = Math.random().toString(36).slice(2) + Date.now().toString(36)
    await createTicket(ticket)
    // 附加 ticket 参数到回调地址，这样回调时我们就知道是哪个 ticket
    redirectUri += `?ticket=${ticket}`
  }
  // 构造支付宝授权 URL
  // 使用 openauth.alipay.com 进行授权
  const alipayUrl = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=${appId}&scope=auth_user&redirect_uri=${encodeURIComponent(redirectUri)}&state=${state}`
  if (isMobile) {
    // 构造支付宝 Scheme 链接，强制唤起 APP
    // 注意：url 参数需要进行二次编码，防止参数丢失
    const schemeUrl = `alipays://platformapi/startapp?appId=20000067&url=${encodeURIComponent(alipayUrl)}`
    const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>正在跳转支付宝...</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 40px 20px; }
    .btn { display: block; width: 100%; max-width: 300px; margin: 20px auto; padding: 12px 0; background: #1677FF; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; }
    .secondary-btn { display: block; margin-top: 15px; color: #666; font-size: 14px; text-decoration: underline; }
    p { color: #666; margin-bottom: 30px; line-height: 1.5; }
    .tip { font-size: 12px; color: #999; margin-top: 40px; }
    .status { margin-top: 20px; color: #1677FF; font-size: 14px; min-height: 20px; }
  </style>
</head>
<body>
  <h3>正在跳转支付宝登录</h3>
  <p>请在弹出的窗口中点击"打开"以授权登录</p>
  <a href="${schemeUrl}" class="btn">打开支付宝 APP</a>
  <div class="status" id="status">等待授权...</div>
  <div class="tip">
    <p>注意：授权完成后，请返回此页面。<br>页面会自动刷新并进入系统。</p>
  </div>
  <script>
    // 尝试自动唤起
    setTimeout(function() {
      window.location.href = "${schemeUrl}";
    }, 300);
    // 轮询检查登录状态
    const ticket = "${ticket}";
    let checkCount = 0;
    const maxChecks = 600; // 10分钟
    function checkStatus() {
      if (checkCount >= maxChecks) return;
      checkCount++;
      fetch('/api/auth/ticket/check?ticket=' + ticket)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('status').innerText = "授权成功，正在跳转...";
            window.location.href = '/monitor';
          } else {
            // 继续轮询
            setTimeout(checkStatus, 2000);
          }
        })
        .catch(err => {
          console.error(err);
          setTimeout(checkStatus, 3000);
        });
    }
    // 启动轮询
    setTimeout(checkStatus, 2000);
  </script>
</body>
</html>
    `
    const res = new NextResponse(html, { headers: { 'Content-Type': 'text/html' } })
    res.cookies.set("alipay_state", state, {
      httpOnly: true,
      sameSite: "lax",
      secure: false, // 强制允许 HTTP
      path: "/",
      maxAge: 300,
    })
    return res
  }
  const res = NextResponse.redirect(alipayUrl)
  // 存储 state 防止 CSRF
  res.cookies.set("alipay_state", state, {
    httpOnly: true,
    sameSite: "lax",
    secure: false, // 强制允许 HTTP，防止云服务无 HTTPS 导致 Cookie 丢失
    path: "/",
    maxAge: 300,
  })
  return res
}

--- FILE: app\api\auth\login\route.ts ---

import { verifyCredentials } from "@/lib/db/user-service"
import { generateToken, setAuthCookie } from "@/lib/auth"
import { loginSchema } from "@/lib/validations/auth"
import { rateLimit } from "@/lib/rate-limit"
import { NextRequest } from "next/server"
import { verifyTurnstileToken } from "@/lib/turnstile"
export async function POST(req: NextRequest) {
  try {
    // Rate Limit: 5 attempts per minute
    const limiter = rateLimit(req, { limit: 5, windowMs: 60 * 1000 })
    if (!limiter.success) {
      return Response.json({ error: "请求过于频繁，请稍后再试" }, { status: 429 })
    }
    const body = await req.json()
    // 验证 Turnstile Token
    const turnstileToken = body.turnstileToken;
    if (!turnstileToken) {
        return Response.json({ error: "请完成验证码验证" }, { status: 400 });
    }
    const isHuman = await verifyTurnstileToken(turnstileToken);
    if (!isHuman) {
        return Response.json({ error: "验证码验证失败" }, { status: 400 });
    }
    // Use Zod to validate input
    const result = loginSchema.safeParse(body)
    if (!result.success) {
      return Response.json({ error: "缺少邮箱或密码" }, { status: 400 })
    }
    const { email, password } = result.data
    // 使用 user-service 的 verifyCredentials() 验证用户
    const user = await verifyCredentials(email, password)
    if (!user) {
      return Response.json({ error: "邮箱或密码错误" }, { status: 401 })
    }
    // 生成包含 id, email, username 的 JWT 令牌
    const token = await generateToken({
      id: user.id,
      email: user.email,
      username: user.username,
    })
    // 设置 httpOnly cookie
    await setAuthCookie(token)
    // 返回 UserPublic 信息
    return Response.json({ ok: true, user })
  } catch (e) {
    console.error("登录失败:", e)
    return Response.json({ error: "服务异常" }, { status: 500 })
  }
}

--- FILE: app\api\auth\logout\route.ts ---

import { NextResponse } from "next/server"
import { clearAuthCookie } from "@/lib/auth"
/**
 * POST /api/auth/logout
 * 用户登出接口
 */
export async function POST() {
  try {
    // 清除认证 Cookie
    await clearAuthCookie()
    return NextResponse.json({ ok: true })
  } catch (error) {
    console.error("登出失败:", error)
    return NextResponse.json(
      { error: "登出失败" },
      { status: 500 }
    )
  }
}

--- FILE: app\api\auth\me\route.ts ---

import { getCurrentUser } from "@/lib/auth"
export async function GET() {
  try {
    // 使用 getCurrentUser() 获取当前用户
    const user = await getCurrentUser()
    if (!user) {
      // 未认证或令牌无效
      return Response.json({ authenticated: false })
    }
    // 返回包含完整用户资料的响应
    return Response.json({
      authenticated: true,
      user: user,
    })
  } catch (error) {
    console.error("获取用户信息失败:", error)
    return Response.json({ authenticated: false }, { status: 500 })
  }
}

--- FILE: app\api\auth\qq\callback\route.ts ---

import { NextResponse } from "next/server"
import { cookies } from "next/headers"
import { findOrCreateQQUser } from "@/lib/db/user-service"
import { generateToken, setAuthCookie } from "@/lib/auth"
export async function GET(req: Request) {
  const appId = process.env.QQ_CLIENT_ID
  const appKey = process.env.QQ_CLIENT_SECRET
  const url = new URL(req.url)
  const code = url.searchParams.get("code")
  const state = url.searchParams.get("state")
  // 优先使用环境变量中的 APP_URL
  const origin = process.env.APP_URL || url.origin
  const redirectUri = `${origin}/api/auth/qq/callback`
  if (!appId || !appKey) {
    return NextResponse.redirect(new URL(`/login?error=qq_config`, req.url))
  }
  const cookieStore = await cookies()
  const expectedState = cookieStore.get("qq_state")?.value
  if (!code || !state || !expectedState || expectedState !== state) {
    return NextResponse.redirect(new URL(`/login?error=qq_state`, req.url))
  }
  try {
    // 1. 获取 Access Token
    // 注意：QQ 建议加上 fmt=json 参数以获取 JSON 响应
    const tokenUrl = `https://graph.qq.com/oauth2.0/token?grant_type=authorization_code&client_id=${appId}&client_secret=${appKey}&code=${code}&redirect_uri=${encodeURIComponent(redirectUri)}&fmt=json`
    const tokenResp = await fetch(tokenUrl)
    // QQ 可能返回 JSON 也可能返回 text (取决于 fmt 参数，加上 fmt=json 后返回 json)
    // 成功响应: { "access_token": "...", "expires_in": 7776000, "refresh_token": "..." }
    // 失败响应: { "error": ..., "error_description": ... }
    const tokenJson = await tokenResp.json()
    if (tokenJson.error || !tokenJson.access_token) {
      console.error("QQ 获取 Token 失败:", tokenJson)
      return NextResponse.redirect(new URL(`/login?error=qq_token`, req.url))
    }
    const accessToken = tokenJson.access_token
    // 2. 获取 OpenID
    // 接口: https://graph.qq.com/oauth2.0/me?access_token=...&fmt=json
    const meUrl = `https://graph.qq.com/oauth2.0/me?access_token=${accessToken}&fmt=json`
    const meResp = await fetch(meUrl)
    const meJson = await meResp.json()
    if (meJson.error || !meJson.openid) {
       console.error("QQ 获取 OpenID 失败:", meJson)
       return NextResponse.redirect(new URL(`/login?error=qq_openid`, req.url))
    }
    const openid = meJson.openid
    // 3. 获取用户信息 (get_user_info)
    const infoUrl = `https://graph.qq.com/user/get_user_info?access_token=${accessToken}&oauth_consumer_key=${appId}&openid=${openid}`
    const infoResp = await fetch(infoUrl)
    const infoJson = await infoResp.json()
    if (infoJson.ret !== 0) {
       console.error("QQ 获取用户信息失败:", infoJson)
       // 即使获取信息失败，只要有 openid 也可以尝试登录（虽然没有头像昵称）
       // 这里选择继续，使用默认昵称
    }
    const nickname = infoJson.nickname || `QQ用户`
    const avatar = infoJson.figureurl_qq_2 || infoJson.figureurl_qq_1 || null // figureurl_qq_2 是 100x100，_1 是 40x40
    // 4. 查找或创建用户
    const user = await findOrCreateQQUser({
      openid,
      nickname,
      avatar
    })
    // 5. 生成 Token 并登录
    const jwt = await generateToken({ id: user.id, email: user.email, username: user.username })
    await setAuthCookie(jwt)
    // 6. 清除 state cookie 并重定向
    const res = NextResponse.redirect(new URL(`/monitor`, req.url))
    res.cookies.set("qq_state", "", { path: "/", maxAge: 0 })
    return res
  } catch (error) {
    console.error("QQ 登录回调处理异常:", error)
    return NextResponse.redirect(new URL(`/login?error=qq_error`, req.url))
  }
}

--- FILE: app\api\auth\qq\login\route.ts ---

import { NextResponse } from "next/server"
export async function GET(req: Request) {
  const appId = process.env.QQ_CLIENT_ID
  if (!appId) {
    return NextResponse.json({ error: "未配置 QQ_CLIENT_ID" }, { status: 500 })
  }
  const url = new URL(req.url)
  // 优先使用环境变量中的 APP_URL (适用于云服务器/容器环境)
  const origin = process.env.APP_URL || url.origin
  // 回调地址必须与 QQ 互联后台配置的一致
  const redirectUri = `${origin}/api/auth/qq/callback`
  const state = Math.random().toString(36).slice(2) + Date.now().toString(36)
  // QQ 登录授权地址
  const qqUrl = `https://graph.qq.com/oauth2.0/authorize?response_type=code&client_id=${appId}&redirect_uri=${encodeURIComponent(
    redirectUri
  )}&state=${state}&scope=get_user_info`
  const res = NextResponse.redirect(qqUrl)
  // 存储 state 以防止 CSRF
  res.cookies.set("qq_state", state, {
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/",
    maxAge: 300,
  })
  return res
}

--- FILE: app\api\auth\register\route.ts ---

import { createUser } from "@/lib/db/user-service"
import { generateToken, setAuthCookie } from "@/lib/auth"
import { registerSchema } from "@/lib/validations/auth"
import { rateLimit } from "@/lib/rate-limit"
import { NextRequest } from "next/server"
import { verifyTurnstileToken } from "@/lib/turnstile"
export async function POST(req: NextRequest) {
  try {
    // Rate Limit: 3 attempts per minute to prevent spam registration
    const limiter = rateLimit(req, { limit: 3, windowMs: 60 * 1000 })
    if (!limiter.success) {
      return Response.json({ error: "请求过于频繁，请稍后再试" }, { status: 429 })
    }
    const body = await req.json()
    // 验证 Turnstile Token
    const turnstileToken = body.turnstileToken;
    if (!turnstileToken) {
        return Response.json({ error: "请完成验证码验证" }, { status: 400 });
    }
    const isHuman = await verifyTurnstileToken(turnstileToken);
    if (!isHuman) {
        return Response.json({ error: "验证码验证失败" }, { status: 400 });
    }
    // Use Zod to validate input
    const result = registerSchema.safeParse(body)
    if (!result.success) {
        return Response.json({ error: result.error.issues[0].message }, { status: 400 })
    }
    const { email, password, username } = result.data
    // 使用 user-service 创建用户(保存到数据库)
    const user = await createUser({
      email,
      password,
      username,
    })
    // 生成包含完整用户信息的 JWT 令牌
    const token = await generateToken({
      id: user.id,
      email: user.email,
      username: user.username,
    })
    // 设置 httpOnly cookie
    await setAuthCookie(token)
    // 返回 UserPublic 信息
    return Response.json({
      ok: true,
      user,
    })
  } catch (error) {
    // 处理邮箱已存在的错误
    if (error instanceof Error && error.message.includes("该邮箱已被注册")) {
      return Response.json({ error: "该邮箱已被注册" }, { status: 409 })
    }
    console.error("注册失败:", error)
    return Response.json({ error: "服务异常,请稍后重试" }, { status: 500 })
  }
}

--- FILE: app\api\auth\ticket\check\route.ts ---

import { NextResponse } from "next/server"
import { getTicket, deleteTicket } from "@/lib/db/ticket-service"
export async function GET(req: Request) {
  const url = new URL(req.url)
  const ticketId = url.searchParams.get("ticket")
  if (!ticketId) {
    return NextResponse.json({ error: "Missing ticket" }, { status: 400 })
  }
  const ticket = await getTicket(ticketId)
  if (!ticket) {
    // Ticket 不存在或已过期
    return NextResponse.json({ status: "pending" })
  }
  if (ticket.jwt) {
    // 登录成功
    const res = NextResponse.json({ status: "success" })
    // 设置 Cookie
    res.cookies.set("auth", ticket.jwt, {
      httpOnly: true,
      sameSite: "lax",
      secure: false, // 强制允许 HTTP
      path: "/",
      maxAge: 60 * 60 * 24 * 7, // 7 天
    })
    // 删除 ticket，防止重放
    await deleteTicket(ticketId)
    return res
  }
  // 等待中
  return NextResponse.json({ status: "pending" })
}

--- FILE: app\api\auth\wechat\callback\route.ts ---

import { NextResponse } from "next/server"
import { cookies } from "next/headers"
import { findOrCreateWeChatUser } from "@/lib/db/user-service"
import { generateToken, setAuthCookie } from "@/lib/auth"
export async function GET(req: Request) {
  const url = new URL(req.url)
  const code = url.searchParams.get("code")
  const state = url.searchParams.get("state")
  const cookieStore = await cookies()
  const expectedState = cookieStore.get("wx_state")?.value
  const loginType = cookieStore.get("wx_login_type")?.value || 'open' // Default to open if not set
  // 根据登录类型选择对应的 AppID 和 Secret
  // 优先使用明确指定的环境变量
  const appId = loginType === 'official'
    ? process.env.WECHAT_OFFICIAL_APP_ID?.trim()
    : process.env.WECHAT_OPEN_APP_ID?.trim()
  const secret = loginType === 'official'
    ? process.env.WECHAT_OFFICIAL_APP_SECRET?.trim()
    : process.env.WECHAT_OPEN_APP_SECRET?.trim()
  if (!appId || !secret) {
    return NextResponse.redirect(`/login?error=wechat_config`)
  }
  if (!code || !state || !expectedState || expectedState !== state) {
    return NextResponse.redirect(`/login?error=wechat_state`)
  }
  try {
    const tokenResp = await fetch(
      `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${appId}&secret=${secret}&code=${code}&grant_type=authorization_code`
    )
    const tokenJson = await tokenResp.json()
    const accessToken: string | undefined = tokenJson?.access_token
    const openid: string | undefined = tokenJson?.openid
    const unionid: string | undefined = tokenJson?.unionid
    if (!accessToken || !openid) {
      return NextResponse.redirect(`/login?error=wechat_token`)
    }
    let nickname: string | undefined
    let avatar: string | null = null
    try {
      const infoResp = await fetch(
        `https://api.weixin.qq.com/sns/userinfo?access_token=${accessToken}&openid=${openid}`
      )
      const infoJson = await infoResp.json()
      nickname = infoJson?.nickname
      avatar = infoJson?.headimgurl || null
    } catch {}
    const user = await findOrCreateWeChatUser({
      openid,
      unionid,
      nickname,
      avatar,
    })
    const jwt = await generateToken({ id: user.id, email: user.email, username: user.username })
    await setAuthCookie(jwt)
    const res = NextResponse.redirect(new URL("/monitor", req.url))
    res.cookies.set("wx_state", "", { path: "/", maxAge: 0 })
    res.cookies.set("wx_login_type", "", { path: "/", maxAge: 0 })
    return res
  } catch (error) {
    console.error("微信登录回调处理失败:", error)
    return NextResponse.redirect(new URL("/login?error=wechat_error", req.url))
  }
}

--- FILE: app\api\auth\wechat\login\route.ts ---

import { NextResponse } from "next/server"
export async function GET(req: Request) {
  // 尝试获取不同环境的配置
  // WECHAT_OFFICIAL_APP_ID: 微信公众号 AppID (用于微信内访问)
  // WECHAT_OPEN_APP_ID: 微信开放平台 AppID (用于 PC/外部浏览器访问)
  // 只有当明确配置了 WECHAT_OFFICIAL_APP_ID 时，才在微信内启用公众号登录流程
  const officialAppId = process.env.WECHAT_OFFICIAL_APP_ID?.trim()
  const openAppId = process.env.WECHAT_OPEN_APP_ID?.trim()
  const userAgent = req.headers.get("user-agent") || ""
  // Check if running in WeChat client
  const isWeChat = /MicroMessenger/i.test(userAgent)
  // 打印调试信息，帮助定位 ID 问题
  console.log('WeChat Login Debug:', {
    isWeChat,
    officialAppId: officialAppId ? `${officialAppId.slice(0, 4)}***` : 'missing',
    openAppId: openAppId ? `${openAppId.slice(0, 4)}***` : 'missing',
    usedAppId: (isWeChat && officialAppId) ? officialAppId : openAppId,
    timestamp: new Date().toISOString()
  })
  if (!officialAppId && !openAppId) {
    return NextResponse.json({ error: "未配置 WECHAT_APP_ID" }, { status: 500 })
  }
  const url = new URL(req.url)
  // 优先使用环境变量中的 APP_URL (适用于云服务器/容器环境)
  const origin = process.env.APP_URL || url.origin
  const state = Math.random().toString(36).slice(2) + Date.now().toString(36)
  const redirectUri = `${origin}/api/auth/wechat/callback`
  let wechatUrl: string
  let loginType: 'official' | 'open'
  // 只有在微信环境且明确配置了公众号 ID 时，才使用公众号 OAuth
  if (isWeChat && officialAppId) {
    // 微信环境：使用公众号 OAuth (snsapi_userinfo)
    loginType = 'official'
    wechatUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${officialAppId}&redirect_uri=${encodeURIComponent(
      redirectUri
    )}&response_type=code&scope=snsapi_userinfo&state=${state}#wechat_redirect`
  } else {
    // 其他情况（PC、外部浏览器、或未配置公众号ID的微信环境）：使用开放平台 QR Login
    // 注意：微信内也可以打开 QR Login 页面，虽然体验不如 OAuth 流畅，但能解决 Scope 问题
    loginType = 'open'
    // 确保使用 snsapi_login
    wechatUrl = `https://open.weixin.qq.com/connect/qrconnect?appid=${openAppId}&redirect_uri=${encodeURIComponent(
      redirectUri
    )}&response_type=code&scope=snsapi_login&state=${state}#wechat_redirect`
  }
  // 打印最终生成的 URL，方便调试
  console.log('Generated WeChat URL:', wechatUrl)
  const res = NextResponse.redirect(wechatUrl)
  // 存储 state 和 登录类型，以便 callback 知道使用哪个 AppID/Secret 验证
  res.cookies.set("wx_state", state, {
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/",
    maxAge: 300,
  })
  res.cookies.set("wx_login_type", loginType, {
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/",
    maxAge: 300,
  })
  return res
}

--- FILE: app\api\auth\wework\callback\route.ts ---

import { NextResponse } from "next/server"
import { cookies } from "next/headers"
import { findOrCreateWeWorkUser } from "@/lib/db/user-service"
import { generateToken, setAuthCookie } from "@/lib/auth"
export async function GET(req: Request) {
  const corpId = process.env.WEWORK_CORP_ID
  const secret = process.env.WEWORK_CORP_SECRET
  const url = new URL(req.url)
  const code = url.searchParams.get("code")
  const state = url.searchParams.get("state")
  if (!corpId || !secret) {
    return NextResponse.redirect(new URL(`/login?error=wework_config`, req.url))
  }
  const cookieStore = await cookies()
  const expectedState = cookieStore.get("wework_state")?.value
  // 验证 state 防止 CSRF
  if (!code || !state || !expectedState || expectedState !== state) {
    return NextResponse.redirect(new URL(`/login?error=wework_state`, req.url))
  }
  try {
    // 1. 获取 Access Token
    const tokenResp = await fetch(
      `https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=${corpId}&corpsecret=${secret}`
    )
    const tokenJson = await tokenResp.json()
    if (tokenJson.errcode !== 0) {
      console.error("获取企业微信Token失败:", tokenJson)
      return NextResponse.redirect(new URL(`/login?error=wework_token`, req.url))
    }
    const accessToken = tokenJson.access_token
    // 2. 获取访问用户身份 (UserId)
    const userInfoResp = await fetch(
      `https://qyapi.weixin.qq.com/cgi-bin/user/getuserinfo?access_token=${accessToken}&code=${code}`
    )
    const userInfoJson = await userInfoResp.json()
    if (userInfoJson.errcode !== 0) {
      console.error("获取企业微信用户身份失败:", userInfoJson)
      return NextResponse.redirect(new URL(`/login?error=wework_user_identity`, req.url))
    }
    const userId = userInfoJson.UserId
    // 如果是外部联系人，则是 OpenId，暂不支持
    if (!userId) {
       return NextResponse.redirect(new URL(`/login?error=wework_external_user`, req.url))
    }
    // 3. 获取用户详细信息 (姓名、头像、邮箱)
    let nickname = `企业微信用户`
    let avatar: string | null = null
    let email: string | undefined = undefined
    try {
        const userDetailResp = await fetch(
            `https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=${accessToken}&userid=${userId}`
        )
        const userDetailJson = await userDetailResp.json()
        if (userDetailJson.errcode === 0) {
            nickname = userDetailJson.name || nickname
            avatar = userDetailJson.avatar || null
            email = userDetailJson.email
        }
    } catch (e) {
        console.error("获取用户详细信息失败:", e)
    }
    // 4. 查找或创建用户
    const user = await findOrCreateWeWorkUser({
      userid: userId,
      name: nickname,
      avatar,
      email
    })
    // 5. 生成 Token 并登录
    const jwt = await generateToken({ id: user.id, email: user.email, username: user.username })
    await setAuthCookie(jwt)
    // 6. 清除 state cookie 并重定向
    const res = NextResponse.redirect(new URL(`/monitor`, req.url))
    res.cookies.set("wework_state", "", { path: "/", maxAge: 0 })
    return res
  } catch (error) {
    console.error("企业微信登录回调处理失败:", error)
    return NextResponse.redirect(new URL(`/login?error=wework_error`, req.url))
  }
}

--- FILE: app\api\auth\wework\login\route.ts ---

import { NextResponse } from "next/server"
export async function GET(req: Request) {
  const corpId = process.env.WEWORK_CORP_ID
  const agentId = process.env.WEWORK_AGENT_ID
  if (!corpId || !agentId) {
    return NextResponse.json({ error: "未配置 WEWORK_CORP_ID 或 WEWORK_AGENT_ID" }, { status: 500 })
  }
  const url = new URL(req.url)
  // 优先使用环境变量中配置的 PUBLIC_URL，如果没有则使用请求的 origin
  // 这对于部署在反向代理后面或需要指定域名的情况很有用
  const origin = process.env.NEXT_PUBLIC_APP_URL || url.origin
  const state = Math.random().toString(36).slice(2) + Date.now().toString(36)
  const redirectUri = `${origin}/api/auth/wework/callback`
  const weworkUrl = `https://open.work.weixin.qq.com/wwopen/sso/qrConnect?appid=${corpId}&agentid=${agentId}&redirect_uri=${encodeURIComponent(
    redirectUri
  )}&state=${state}`
  const res = NextResponse.redirect(weworkUrl)
  res.cookies.set("wework_state", state, {
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/",
    maxAge: 300, // 5 minutes
  })
  return res
}

--- FILE: app\api\chat\route.test.ts ---

/**
 * Property-Based Tests for AI Search Fix
 * Feature: ai-search-fix
 */
import { describe, it, expect } from 'vitest'
import * as fc from 'fast-check'
/**
 * Helper function to build request body based on API configuration
 * This mirrors the logic in the actual route.ts file
 */
function buildRequestBody(config: {
  enableSearch: boolean
  enableReasoning: boolean
  isDashScope: boolean
  isCompatibleMode: boolean
  model: string
  messages: any[]
  systemPrompt: string
}) {
  const { enableSearch, enableReasoning, isDashScope, isCompatibleMode, model, messages, systemPrompt } = config
  if (isDashScope && isCompatibleMode) {
    // DashScope Compatible Mode
    return {
      model: model || "qwen-plus",
      messages: [{ role: "system", content: systemPrompt }, ...messages],
      stream: true,
      temperature: 0.7,
      extra_body: {
        ...(enableSearch ? {
          enable_search: true,
          search_strategy: "agent"
        } : {}),
        ...(enableReasoning ? {
          enable_thinking: true,
          thinking_budget: 1024
        } : {})
      }
    }
  } else if (isDashScope) {
    // DashScope Native API
    return {
      model: model || "qwen-plus",
      input: {
        messages: [{ role: "system", content: systemPrompt }, ...messages],
      },
      parameters: {
        result_format: "message",
        incremental_output: true,
        ...(enableSearch ? {
          enable_search: true,
          search_strategy: "agent"
        } : {}),
        ...(enableReasoning ? {
          enable_thinking: true,
          thinking_budget: 1024
        } : {})
      },
    }
  } else {
    // OpenAI format (not testing search for OpenAI in this property)
    return {
      model: model || "gpt-4",
      messages: [{ role: "system", content: systemPrompt }, ...messages],
      stream: true,
    }
  }
}
describe('AI Search Fix - Property-Based Tests', () => {
  /**
   * **Feature: ai-search-fix, Property 1: Search parameter propagation**
   * **Validates: Requirements 1.2, 1.3, 1.4**
   *
   * Property: For any chat request where enableSearch is true,
   * the API request body should contain enable_search: true in the
   * appropriate location (extra_body for compatible mode, parameters for native API)
   */
  it('Property 1: Search parameter propagation - enableSearch true implies enable_search in request body', () => {
    fc.assert(
      fc.property(
        // Generate random configurations
        fc.record({
          enableSearch: fc.constant(true), // Always true for this property
          enableReasoning: fc.boolean(),
          isDashScope: fc.constant(true), // Only testing DashScope APIs
          isCompatibleMode: fc.boolean(),
          model: fc.oneof(
            fc.constant('qwen-plus'),
            fc.constant('qwen-max'),
            fc.constant('qwen3-max'),
            fc.constant('qwen-turbo')
          ),
          messages: fc.array(
            fc.record({
              role: fc.constantFrom('user', 'assistant'),
              content: fc.string({ minLength: 1, maxLength: 100 })
            }),
            { minLength: 1, maxLength: 5 }
          ),
          systemPrompt: fc.string({ minLength: 1, maxLength: 200 })
        }),
        (config) => {
          const requestBody = buildRequestBody(config)
          if (config.isCompatibleMode) {
            // For compatible mode, check extra_body
            expect(requestBody).toHaveProperty('extra_body')
            expect(requestBody.extra_body).toHaveProperty('enable_search', true)
            expect(requestBody.extra_body).toHaveProperty('search_strategy', 'agent')
          } else {
            // For native API, check parameters
            expect(requestBody).toHaveProperty('parameters')
            expect(requestBody.parameters).toHaveProperty('enable_search', true)
            expect(requestBody.parameters).toHaveProperty('search_strategy', 'agent')
          }
        }
      ),
      { numRuns: 100 } // Run 100 random test cases
    )
  })
  /**
   * Property: When enableSearch is false, enable_search should not be present
   */
  it('Property 1 (inverse): Search parameter propagation - enableSearch false implies no enable_search', () => {
    fc.assert(
      fc.property(
        fc.record({
          enableSearch: fc.constant(false), // Always false
          enableReasoning: fc.boolean(),
          isDashScope: fc.constant(true),
          isCompatibleMode: fc.boolean(),
          model: fc.oneof(
            fc.constant('qwen-plus'),
            fc.constant('qwen-max'),
            fc.constant('qwen3-max')
          ),
          messages: fc.array(
            fc.record({
              role: fc.constantFrom('user', 'assistant'),
              content: fc.string({ minLength: 1, maxLength: 100 })
            }),
            { minLength: 1, maxLength: 5 }
          ),
          systemPrompt: fc.string({ minLength: 1, maxLength: 200 })
        }),
        (config) => {
          const requestBody = buildRequestBody(config)
          if (config.isCompatibleMode) {
            // For compatible mode, extra_body should not have enable_search
            if (requestBody.extra_body) {
              expect(requestBody.extra_body).not.toHaveProperty('enable_search')
              expect(requestBody.extra_body).not.toHaveProperty('search_strategy')
            }
          } else {
            // For native API, parameters should not have enable_search
            if (requestBody.parameters) {
              expect(requestBody.parameters).not.toHaveProperty('enable_search')
              expect(requestBody.parameters).not.toHaveProperty('search_strategy')
            }
          }
        }
      ),
      { numRuns: 100 }
    )
  })
  /**
   * Property: Search parameters should be correctly placed regardless of other parameters
   */
  it('Property 1 (coexistence): Search parameters coexist with reasoning parameters', () => {
    fc.assert(
      fc.property(
        fc.record({
          enableSearch: fc.boolean(),
          enableReasoning: fc.boolean(),
          isDashScope: fc.constant(true),
          isCompatibleMode: fc.boolean(),
          model: fc.constant('qwen-plus'),
          messages: fc.array(
            fc.record({
              role: fc.constant('user'),
              content: fc.string({ minLength: 1, maxLength: 50 })
            }),
            { minLength: 1, maxLength: 3 }
          ),
          systemPrompt: fc.constant('Test prompt')
        }),
        (config) => {
          const requestBody = buildRequestBody(config)
          const targetObject = config.isCompatibleMode
            ? requestBody.extra_body
            : requestBody.parameters
          // If search is enabled, both enable_search and search_strategy must be present
          if (config.enableSearch) {
            expect(targetObject).toHaveProperty('enable_search', true)
            expect(targetObject).toHaveProperty('search_strategy', 'agent')
          } else {
            expect(targetObject).not.toHaveProperty('enable_search')
            expect(targetObject).not.toHaveProperty('search_strategy')
          }
          // If reasoning is enabled, reasoning params should be present
          if (config.enableReasoning) {
            expect(targetObject).toHaveProperty('enable_thinking', true)
            expect(targetObject).toHaveProperty('thinking_budget', 1024)
          }
          // Both can coexist
          if (config.enableSearch && config.enableReasoning) {
            expect(targetObject).toHaveProperty('enable_search', true)
            expect(targetObject).toHaveProperty('search_strategy', 'agent')
            expect(targetObject).toHaveProperty('enable_thinking', true)
            expect(targetObject).toHaveProperty('thinking_budget', 1024)
          }
        }
      ),
      { numRuns: 100 }
    )
  })
  /**
   * **Feature: ai-search-fix, Property 2: Search strategy inclusion**
   * **Validates: Requirements 1.2, 1.3, 1.4**
   *
   * Property: For any DashScope API request with enable_search: true,
   * the request should also include search_strategy: "agent"
   */
  it('Property 2: Search strategy inclusion - enable_search true implies search_strategy present', () => {
    fc.assert(
      fc.property(
        // Generate random DashScope configurations with search enabled
        fc.record({
          enableSearch: fc.constant(true), // Always true to test the implication
          enableReasoning: fc.boolean(),
          isDashScope: fc.constant(true), // Only DashScope APIs
          isCompatibleMode: fc.boolean(), // Test both modes
          model: fc.oneof(
            fc.constant('qwen-plus'),
            fc.constant('qwen-max'),
            fc.constant('qwen3-max'),
            fc.constant('qwen-turbo'),
            fc.constant('qwen2-72b-instruct')
          ),
          messages: fc.array(
            fc.record({
              role: fc.constantFrom('user', 'assistant'),
              content: fc.string({ minLength: 1, maxLength: 100 })
            }),
            { minLength: 1, maxLength: 10 }
          ),
          systemPrompt: fc.string({ minLength: 0, maxLength: 500 })
        }),
        (config) => {
          const requestBody = buildRequestBody(config)
          // Determine which object contains the search parameters
          const searchParamsObject = config.isCompatibleMode
            ? requestBody.extra_body
            : requestBody.parameters
          // Core property: If enable_search is true, search_strategy MUST be present
          if (searchParamsObject?.enable_search === true) {
            expect(searchParamsObject).toHaveProperty('search_strategy')
            expect(searchParamsObject.search_strategy).toBe('agent')
          }
          // Stronger assertion: Since enableSearch is always true in this test,
          // both parameters MUST always be present
          expect(searchParamsObject).toHaveProperty('enable_search', true)
          expect(searchParamsObject).toHaveProperty('search_strategy', 'agent')
        }
      ),
      { numRuns: 100 } // Run 100 random test cases
    )
  })
  /**
   * Property 2 (completeness): Both search parameters must be present together
   * This tests that enable_search and search_strategy are always paired
   */
  it('Property 2 (completeness): enable_search and search_strategy are always paired', () => {
    fc.assert(
      fc.property(
        fc.record({
          enableSearch: fc.boolean(), // Test both true and false
          enableReasoning: fc.boolean(),
          isDashScope: fc.constant(true),
          isCompatibleMode: fc.boolean(),
          model: fc.oneof(
            fc.constant('qwen-plus'),
            fc.constant('qwen-max'),
            fc.constant('qwen3-max')
          ),
          messages: fc.array(
            fc.record({
              role: fc.constantFrom('user', 'assistant'),
              content: fc.string({ minLength: 1, maxLength: 50 })
            }),
            { minLength: 1, maxLength: 5 }
          ),
          systemPrompt: fc.string({ minLength: 1, maxLength: 100 })
        }),
        (config) => {
          const requestBody = buildRequestBody(config)
          const searchParamsObject = config.isCompatibleMode
            ? requestBody.extra_body
            : requestBody.parameters
          // Property: enable_search and search_strategy must both be present or both be absent
          const hasEnableSearch = searchParamsObject?.hasOwnProperty('enable_search')
          const hasSearchStrategy = searchParamsObject?.hasOwnProperty('search_strategy')
          // They should always have the same presence status
          expect(hasEnableSearch).toBe(hasSearchStrategy)
          // If present, verify their values
          if (hasEnableSearch && hasSearchStrategy) {
            expect(searchParamsObject.enable_search).toBe(true)
            expect(searchParamsObject.search_strategy).toBe('agent')
          }
        }
      ),
      { numRuns: 100 }
    )
  })
  /**
   * Property 2 (invariant): search_strategy value is always "agent" when present
   */
  it('Property 2 (invariant): search_strategy is always "agent" when enable_search is true', () => {
    fc.assert(
      fc.property(
        fc.record({
          enableSearch: fc.constant(true),
          enableReasoning: fc.boolean(),
          isDashScope: fc.constant(true),
          isCompatibleMode: fc.boolean(),
          model: fc.string({ minLength: 1, maxLength: 50 }), // Any model string
          messages: fc.array(
            fc.record({
              role: fc.constantFrom('user', 'assistant', 'system'),
              content: fc.string({ minLength: 0, maxLength: 200 })
            }),
            { minLength: 0, maxLength: 20 }
          ),
          systemPrompt: fc.string({ minLength: 0, maxLength: 1000 })
        }),
        (config) => {
          const requestBody = buildRequestBody(config)
          const searchParamsObject = config.isCompatibleMode
            ? requestBody.extra_body
            : requestBody.parameters
          // Invariant: search_strategy must always be exactly "agent"
          expect(searchParamsObject).toHaveProperty('search_strategy', 'agent')
          // Additional check: it should be a string
          expect(typeof searchParamsObject.search_strategy).toBe('string')
          // It should not be any other value
          expect(searchParamsObject.search_strategy).not.toBe('default')
          expect(searchParamsObject.search_strategy).not.toBe('')
          expect(searchParamsObject.search_strategy).not.toBe(undefined)
          expect(searchParamsObject.search_strategy).not.toBe(null)
        }
      ),
      { numRuns: 100 }
    )
  })
})

--- FILE: app\api\chat\route.ts ---

export const runtime = 'nodejs'
export async function GET() {
  return Response.json({
    message: "Chat API is working. Use POST to send messages.",
  })
}
import { getEnhancedSystemPrompt } from '@/lib/ai-system-prompt'
import { getAllTasks } from '@/lib/db/scheduler-service'
import { initDB } from '@/lib/db/database'
export async function POST(req: Request) {
  try {
    await initDB()
    const { messages, apiKey, apiUrl, model, systemPrompt, enableSearch, enableReasoning, deviceData, weatherData } =
      await req.json()
    if (!apiKey) {
      return Response.json(
        { error: "API Key is required. Please configure it in settings." },
        { status: 400 }
      )
    }
    // 构建增强的系统提示词，包含当前设备和天气数据
    const enhancedSystemPrompt = getEnhancedSystemPrompt(systemPrompt)
    // 格式化设备数据（将需要除以10的数据转换为正确的小数）
    const formattedDeviceData = deviceData ? {
      ...deviceData,
      temperature: deviceData.temperature ? deviceData.temperature.toFixed(1) + '°C' : null,
      humidity: deviceData.humidity ? deviceData.humidity.toFixed(1) + '%' : null,
      earth_temp: deviceData.earth_temp ? deviceData.earth_temp.toFixed(1) + '°C' : null,
      light: deviceData.light ? deviceData.light + ' lux' : null,
      co2: deviceData.co2 ? deviceData.co2 + ' ppm' : null,
      earth_water: deviceData.earth_water ? deviceData.earth_water.toFixed(1) + '%' : null,
      earth_ec: deviceData.earth_ec ? deviceData.earth_ec + ' μS/cm' : null,
      earth_n: deviceData.earth_n ? deviceData.earth_n + ' mg/kg' : null,
      earth_p: deviceData.earth_p ? deviceData.earth_p + ' mg/kg' : null,
      earth_k: deviceData.earth_k ? deviceData.earth_k + ' mg/kg' : null,
      relay5: deviceData.relay5 === 1 ? '开启（水泵）' : '关闭（水泵）',
      relay6: deviceData.relay6 === 1 ? '开启（风扇）' : '关闭（风扇）',
      relay7: deviceData.relay7 === 1 ? '开启（补光灯）' : '关闭（补光灯）',
      relay8: deviceData.relay8 === 1 ? '开启（白灯）' : '关闭（白灯）',
      led1: deviceData.led1 !== undefined ? `${deviceData.led1} (红色)` : null,
      led2: deviceData.led2 !== undefined ? `${deviceData.led2} (绿色)` : null,
      led3: deviceData.led3 !== undefined ? `${deviceData.led3} (蓝色)` : null,
      timestamp: deviceData.timestamp ? new Date(deviceData.timestamp).toLocaleString('zh-CN') : null
    } : null
    // 添加当前数据上下文
    let contextInfo = ''
    if (formattedDeviceData) {
      contextInfo += `\n\n## 当前设备数据（仅供分析，无需向用户直接展示JSON，请优先使用 <DEVICE_BENTO> 标签展示）\n\`\`\`json\n${JSON.stringify(formattedDeviceData, null, 2)}\n\`\`\`\n`
    }
    if (weatherData) {
      contextInfo += `\n\n## 当前天气信息\n\`\`\`json\n${JSON.stringify({
        location: weatherData.location?.name,
        temperature: weatherData.current?.temp_c,
        condition: weatherData.current?.condition?.text,
        humidity: weatherData.current?.humidity,
        forecast: weatherData.forecast?.forecastday?.slice(0, 3).map((day: any) => ({
          date: day.date,
          maxTemp: day.day.maxtemp_c,
          minTemp: day.day.mintemp_c,
          condition: day.day.condition.text,
          precipitation: day.day.totalprecip_mm
        }))
      }, null, 2)}\n\`\`\`\n`
    }
    // 注入当前定时任务列表
    try {
      const tasks = getAllTasks()
      const tasksContext = tasks.map(t => ({
        id: t.id,
        title: t.title,
        cron: t.cron_expression,
        execute_at: t.execute_at ? new Date(t.execute_at).toLocaleString('zh-CN') : null,
        action_type: t.action_type,
        device_id: t.device_id,
        active: t.is_active === 1
      }))
      contextInfo += `\n\n## 当前系统中的定时任务（这是真实的数据库记录，以此为准）\n\`\`\`json\n${JSON.stringify(tasksContext, null, 2)}\n\`\`\`\n`
    } catch (e) {
      console.error("Failed to fetch tasks for context:", e)
    }
    const finalSystemPrompt = enhancedSystemPrompt + contextInfo
    const deviceControlInstruction =
      "## 设备控制能力\n" +
      "你可以通过生成 JSON 命令来控制设备。但请注意：\n" +
      "1. 仅当用户明确要求控制设备，或当前环境数据严重异常需要紧急干预时，才建议控制设备。\n" +
      "2. 对于一般的种植建议、查询或闲聊，请使用自然语言回答，不要生成控制命令。\n" +
      "3. 当确实需要控制设备时：\n" +
      "   a. 先分析当前数据和原因\n" +
      "   b. 说明控制方案和预期效果\n" +
      "   c. 生成控制命令 JSON（用代码块包裹）\n" +
      "   d. 询问用户是否确认执行\n\n" +
      "控制命令格式：\n" +
      "```json\n" +
      "{\n" +
      '  "action": "toggle_relay",\n' +
      '  "device": 5,\n' +
      '  "value": 1\n' +
      "}\n" +
      "```\n" +
      "（value: 1 为开启，0 为关闭）\n" +
      "或关闭设备：\n" +
      "```json\n" +
      "{\n" +
      '  "action": "toggle_relay",\n' +
      '  "device": 5,\n' +
      '  "value": 0\n' +
      "}\n" +
      "```\n" +
      "或调节 LED：\n" +
      "```json\n" +
      "{\n" +
      '  "action": "set_led",\n' +
      '  "r": 255,\n' +
      '  "g": 100,\n' +
      '  "b": 50\n' +
      "}\n" +
      "```\n"
    const citationInstruction =
      "关于引用来源的重要规则：\n" +
      "1. 只有在你确实知道真实存在的来源时，才使用 <SOURCES> 标签提供引用\n" +
      "2. 所有 url 必须是真实可访问的完整链接（含 http/https），绝对不能编造虚假网址\n" +
      "3. 如果你不确定具体来源或无法提供真实链接，请不要使用 <SOURCES> 标签\n" +
      "4. 宁可不提供来源，也不要编造虚假信息\n" +
      "5. 如果使用引用，在回复正文中使用 [n] 进行内联引用标注，并在回复末尾使用 <SOURCES> 与 </SOURCES> 包裹一个 JSON 数组\n" +
      "6. **重要：绝对不要在 Markdown 表格内使用 [n] 引用标记，这会破坏表格渲染。表格中的数据不需要引用标记。**\n" +
      "7. JSON 数组项必须包含：number、title、url、description、quote 字段\n" +
      "8. 不要在正文中直接展开 JSON"
    const reasoningInstruction =
      "在生成最终答案之前先输出你的思考过程，使用 <REASONING> 与 </REASONING> 包裹思考内容（中文、简洁）。该块用于前端展示并会从最终正文中移除。"
    const tasksInstruction =
      "如果在执行具体工作流程，请在回复末尾使用 <TASKS> 与 </TASKS> 包裹一个 JSON 数组，数组项包含 title、items、status。items 为对象数组，包含 type('text'|'file')、text 以及可选的 file{name, icon}。该块用于前端展示任务进度，并会从最终正文中移除。"
    const chartInstruction =
      "当需要返回可视化图表时，生成 Vega-Lite 规范的 JSON，并使用 <CHART type=\"vega-lite\"> 与 </CHART> 包裹；或返回 ECharts option 的 JSON，并使用 <CHART type=\"echarts\"> 与 </CHART> 包裹。只输出合法的 JSON，不要附加说明或代码块。"
    const monitorInstruction =
      "当用户询问监控、摄像头、直播流或想要查看实时画面时，请直接在回复中插入 <MONITOR></MONITOR> 标签（标签内不需要任何内容）。"
    const controlBentoInstruction =
      "当用户要求查看设备控制、调节设备状态或你建议进行设备调控时，请在回复中包含 <CONTROL_BENTO></CONTROL_BENTO> 标签（标签内不需要任何内容）。然后，必须在标签之后简要说明你的调控建议或理由。如果用户明确表达了“是”、“确认”、“执行”等意图，或者你非常有把握需要执行某些操作，请务必同时输出 JSON 格式的控制命令，以便系统自动执行。"
    const taskListInstruction =
      "当用户要求查看、管理或删除定时任务列表时，请在回复中包含 <TASK_LIST></TASK_LIST> 标签（标签内不需要任何内容）。这将在前端渲染一个交互式的真实任务列表组件。重要：因为你已经输出了 <TASK_LIST> 标签，请不要再用文本重复列出任务内容，也不要描述“列表为空”或“包含X个任务”（除非你是在分析任务的合理性），因为你的文本描述可能与组件实时渲染的真实状态不一致。只需输出标签即可，让组件负责展示。"
    const bentoInstruction =
      "当用户询问设备状态、环境数据、传感器读数或想要查看当前概况时，请直接在回复中插入 <DEVICE_BENTO></DEVICE_BENTO> 标签（标签内不需要任何内容）。然后，基于这些数据对当前环境状况进行简要的分析（例如：温湿度是否适宜，是否需要开启设备等）。请务必在 <DEVICE_BENTO> 标签之后输出分析内容，不要只输出标签。"
    const axisInstruction =
      "当需要返回可视化图表时，生成 Vega-Lite 规范的 JSON，并使用 <CHART type=\"vega-lite\"> 与 </CHART> 包裹；或返回 ECharts option 的 JSON，并使用 <CHART type=\"echarts\"> 与 </CHART> 包裹。只输出合法的 JSON，不要附加说明或代码块。"
    // 检测是否使用DashScope API
    const isDashScope =
      apiUrl?.includes("dashscope.aliyuncs.com") ||
      model?.startsWith("qwen")
    const isCompatibleMode = apiUrl?.includes("compatible-mode/v1") ?? false
    const isDashScopeAppCall = /\/api\/v1\/apps\/[^/]+\/completion(\?|$)/.test(apiUrl || "")
    let fullMessages
    let requestBody
    let targetUrl = apiUrl || ""
    const hasImageContent = Array.isArray(messages) && messages.some((m: any) => {
      const c = m?.content
      if (Array.isArray(c)) return c.some((x: any) => x?.type === "image_url" || x?.image_url || x?.image)
      return false
    })
    // 如果是DashScope且包含图片，强制使用兼容模式（因为Native API不支持Base64图片）
    let useCompatibleMode = isCompatibleMode
    if (isDashScope && hasImageContent && !isCompatibleMode) {
      useCompatibleMode = true
      targetUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
    }
    const modelLower = String(model || '').toLowerCase()
    const isVLMModel = (
      modelLower.includes('vision') ||
      modelLower.includes('-vl-') ||
      /qwen\d*-vl/.test(modelLower) ||
      modelLower.includes('qvq')
    )
    let effectiveModel = model || ''
    if (hasImageContent) {
      if (!isVLMModel) {
        effectiveModel = 'qwen-vl-plus'
      } else if (useCompatibleMode && /qwen3-vl/.test(modelLower)) {
        effectiveModel = 'qwen-vl-plus'
      }
    }
    if (isDashScopeAppCall) {
      // ... existing app call logic ...
      const lastUser = ([...messages] as Array<{ role: string; content: string | any[] }>).reverse().find((m) => m?.role === "user")
      // ...
    } else if (isDashScope && useCompatibleMode) {
      // DashScope 兼容模式（OpenAI形状）
      // 规范URL，若为 /v1 结尾则补 /chat/completions
      if (/\/v1$/.test(targetUrl) && !/\/chat\/completions(\?|$)/.test(targetUrl)) {
        targetUrl = `${targetUrl}/chat/completions`
      }
      fullMessages = [
        {
          role: "system",
          content: `${finalSystemPrompt}\n\n${deviceControlInstruction}\n\n${enableReasoning ? reasoningInstruction : ""}\n\n${citationInstruction}\n\n${tasksInstruction}\n\n${chartInstruction}\n\n${monitorInstruction}\n\n${bentoInstruction}\n\n${controlBentoInstruction}\n\n${taskListInstruction}\n\n${axisInstruction}`,
        },
        ...messages,
      ]
      requestBody = {
        model: effectiveModel || "qwen-plus",
        messages: fullMessages,
        stream: true,
        temperature: 0.7,
        ...(enableSearch ? { enable_search: true } : {}),
      }
    } else if (isDashScope) {
      // DashScope 原生API格式
      const systemMessage = `${finalSystemPrompt}\n\n${deviceControlInstruction}\n\n${enableReasoning ? reasoningInstruction : ""}\n\n${citationInstruction}\n\n${tasksInstruction}\n\n${chartInstruction}\n\n${monitorInstruction}\n\n${bentoInstruction}\n\n${controlBentoInstruction}\n\n${taskListInstruction}\n\n${axisInstruction}`
      // 转换消息格式：OpenAI format -> DashScope format
      // OpenAI: { type: "image_url", image_url: { url: "..." } } -> DashScope: { image: "..." }
      // OpenAI: { type: "text", text: "..." } -> DashScope: { text: "..." }
      const dashScopeMessages = messages.map((m: any) => {
        if (Array.isArray(m.content)) {
          return {
            role: m.role,
            content: m.content.map((c: any) => {
              if (c.type === 'image_url') return { image: c.image_url.url }
              if (c.type === 'text') return { text: c.text }
              return c
            })
          }
        }
        return m
      })
      fullMessages = [
        { role: "system", content: systemMessage },
        ...dashScopeMessages,
      ]
      requestBody = {
        model: effectiveModel || "qwen-plus",
        input: {
          messages: fullMessages,
        },
        parameters: {
          result_format: "message",
          incremental_output: true,
          ...(enableSearch ? { enable_search: true } : {}),
        },
      }
      if (hasImageContent && /\/aigc\/text-generation\//.test(targetUrl)) {
        targetUrl = targetUrl.replace("/aigc/text-generation/", "/aigc/multimodal-generation/")
      }
    } else {
      // ... OpenAI ...
    }
    // 调用AI API
    const headers: Record<string, string> = {
      "Content-Type": "application/json",
    }
    if (isDashScopeAppCall) {
      headers["Authorization"] = `Bearer ${apiKey}`
      // 尝试开启 SSE（若不支持，将回退为一次性输出）
      headers["X-DashScope-SSE"] = "enable"
    } else if (isDashScope && !useCompatibleMode) {
      headers["Authorization"] = `Bearer ${apiKey}`
      headers["X-DashScope-SSE"] = "enable"
    } else {
      headers["Authorization"] = `Bearer ${apiKey}`
    }
    const response = await fetch(targetUrl, {
      method: "POST",
      headers,
      body: JSON.stringify(requestBody),
    })
    if (!response.ok) {
      const error = await response.text()
      return Response.json(
        { error: `API Error: ${response.status} - ${error}` },
        { status: response.status }
      )
    }
    if (isDashScopeAppCall) {
      // 兼容百炼应用调用的输出：优先处理 SSE，否则一次性输出转为 OpenAI SSE
      const isSSE = /text\/event-stream/i.test(response.headers.get("content-type") || "")
      const encoder = new TextEncoder()
      if (isSSE) {
        const reader = response.body?.getReader()
        const decoder = new TextDecoder()
        const stream = new ReadableStream({
          async start(controller) {
            let acc = ""
            if (!reader) { controller.close(); return }
            try {
              while (true) {
                const { done, value } = await reader.read()
                if (done) break
                const chunk = decoder.decode(value, { stream: true })
                const lines = chunk.split("\n")
                for (const line of lines) {
                  if (line.startsWith("data:")) {
                    const data = line.slice(5).trim()
                    if (data === "[DONE]") continue
                    try {
                      const json = JSON.parse(data)
                      const content =
                        json.output?.choices?.[0]?.message?.content ||
                        json.output?.text || ""
                      if (typeof content === "string") {
                        const next = content.slice(acc.length)
                        acc = content
                        if (next) {
                          const openaiFormat = {
                            id: json.request_id,
                            object: "chat.completion.chunk",
                            created: Date.now(),
                            model: model,
                            choices: [{ index: 0, delta: { content: next }, finish_reason: null }],
                          }
                          controller.enqueue(encoder.encode(`data: ${JSON.stringify(openaiFormat)}\n\n`))
                        }
                      }
                    } catch { }
                  }
                }
              }
              controller.enqueue(encoder.encode("data: [DONE]\n\n"))
              controller.close()
            } catch (e) { controller.error(e instanceof Error ? e : new Error(String(e))) }
          }
        })
        return new Response(stream, {
          headers: { "Content-Type": "text/event-stream", "Cache-Control": "no-cache", Connection: "keep-alive" }
        })
      } else {
        // 非SSE：读取完整JSON并封装为一次性OpenAI SSE
        const data = await response.json()
        const content: string = data?.output?.text || data?.output?.choices?.[0]?.message?.content || ""
        const payload = {
          id: data?.request_id || `${Date.now()}`,
          object: "chat.completion.chunk",
          created: Date.now(),
          model: model,
          choices: [{ index: 0, delta: { content }, finish_reason: "stop" }],
        }
        const body = `data: ${JSON.stringify(payload)}\n\ndata: [DONE]\n\n`
        return new Response(body, { headers: { "Content-Type": "text/event-stream", "Cache-Control": "no-cache", Connection: "keep-alive" } })
      }
    } else if (isDashScope && !useCompatibleMode) {
      // DashScope返回SSE格式，需要转换
      const reader = response.body?.getReader()
      const encoder = new TextEncoder()
      const decoder = new TextDecoder()
      const stream = new ReadableStream({
        async start(controller) {
          let acc = ""
          let accReasoning = ""
          let reasoningClosed = false
          if (!reader) {
            controller.close()
            return
          }
          try {
            while (true) {
              const { done, value } = await reader.read()
              if (done) break
              const chunk = decoder.decode(value, { stream: true })
              const lines = chunk.split("\n")
              for (const line of lines) {
                if (line.startsWith("data:")) {
                  const data = line.slice(5).trim()
                  if (data === "[DONE]") continue
                  try {
                    const json = JSON.parse(data)
                    // Handle Search Citations
                    if (json.output?.choices?.[0]?.finish_reason === "stop" && json.output?.choices?.[0]?.message?.content) {
                       const searchInfo = json.output?.search_info
                       if (searchInfo && Array.isArray(searchInfo.search_results) && searchInfo.search_results.length > 0) {
                          const sources = searchInfo.search_results.map((item: any, idx: number) => ({
                             number: idx + 1,
                             title: item.title,
                             url: item.url,
                             description: item.snippet || "",
                             quote: ""
                          }))
                          const sourcesTag = `\n\n<SOURCES> ${JSON.stringify(sources)} </SOURCES>`
                          const openaiFormat = {
                            id: json.request_id,
                            object: "chat.completion.chunk",
                            created: Date.now(),
                            model: model,
                            choices: [{ index: 0, delta: { content: sourcesTag }, finish_reason: null }]
                          }
                          controller.enqueue(encoder.encode(`data: ${JSON.stringify(openaiFormat)}\n\n`))
                       }
                    }
                    // Handle Reasoning Content (DeepSeek-R1 style via DashScope)
                    // DashScope returns accumulated reasoning_content
                    const rawReasoning = json.output?.choices?.[0]?.message?.reasoning_content || ""
                    if (typeof rawReasoning === "string" && rawReasoning.length > 0) {
                      const nextReasoning = rawReasoning.slice(accReasoning.length)
                      if (nextReasoning) {
                        // If this is the start of reasoning, prepend <REASONING>
                        const prefix = accReasoning.length === 0 ? "<REASONING>" : ""
                        accReasoning = rawReasoning
                        const openaiFormat = {
                          id: json.request_id,
                          object: "chat.completion.chunk",
                          created: Date.now(),
                          model: model,
                          choices: [{
                            index: 0,
                            delta: { content: prefix + nextReasoning },
                            finish_reason: null
                          }]
                        }
                        controller.enqueue(encoder.encode(`data: ${JSON.stringify(openaiFormat)}\n\n`))
                      }
                    }
                    const raw = json.output?.choices?.[0]?.message?.content || ""
                    if (typeof raw === "string") {
                      const next = raw.slice(acc.length)
                      acc = raw
                      if (next) {
                        // If we were reasoning and haven't closed it, close it now
                        let prefix = ""
                        if (accReasoning.length > 0 && !reasoningClosed) {
                           prefix = "</REASONING>\n\n"
                           reasoningClosed = true
                        }
                        const openaiFormat = {
                          id: json.request_id,
                          object: "chat.completion.chunk",
                          created: Date.now(),
                          model: model,
                          choices: [
                            {
                              index: 0,
                              delta: { content: prefix + next },
                              finish_reason: json.output?.finish_reason || null,
                            },
                          ],
                        }
                        controller.enqueue(
                          encoder.encode(`data: ${JSON.stringify(openaiFormat)}\n\n`)
                        )
                      }
                    }
                    // If finished and reasoning still open, close it
                    if (json.output?.finish_reason === "stop" && accReasoning.length > 0 && !reasoningClosed) {
                       const openaiFormat = {
                          id: json.request_id,
                          object: "chat.completion.chunk",
                          created: Date.now(),
                          model: model,
                          choices: [{ index: 0, delta: { content: "</REASONING>\n\n" }, finish_reason: null }]
                       }
                       controller.enqueue(encoder.encode(`data: ${JSON.stringify(openaiFormat)}\n\n`))
                       reasoningClosed = true
                    }
                  } catch (e) {
                    console.error("Parse error:", e)
                  }
                }
              }
            }
            controller.enqueue(encoder.encode("data: [DONE]\n\n"))
            controller.close()
          } catch (error) {
            controller.error(error)
          }
        },
      })
      return new Response(stream, {
        headers: {
          "Content-Type": "text/event-stream",
          "Cache-Control": "no-cache",
          Connection: "keep-alive",
        },
      })
    } else {
      // OpenAI格式直接返回
      return new Response(response.body, {
        headers: {
          "Content-Type": "text/event-stream",
          "Cache-Control": "no-cache",
          Connection: "keep-alive",
        },
      })
    }
  } catch (error: unknown) {
    const msg = error instanceof Error ? error.message : String(error)
    console.error("Chat API Error:", error)
    return Response.json(
      { error: msg || "Internal server error" },
      { status: 500 }
    )
  }
}

--- FILE: app\api\chat\typing\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { getDB } from "@/lib/db/database"
import { NextResponse } from "next/server"
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { targetId, groupId } = await req.json()
    const db = getDB()
    // Ensure typing_status table exists
    db.exec(`
      CREATE TABLE IF NOT EXISTS typing_status (
        user_id INTEGER NOT NULL,
        target_id INTEGER,
        group_id INTEGER,
        updated_at INTEGER NOT NULL,
        PRIMARY KEY (user_id, target_id, group_id)
      )
    `)
    // Update typing status
    // We use INSERT OR REPLACE to update the timestamp
    db.prepare(`
      INSERT OR REPLACE INTO typing_status (user_id, target_id, group_id, updated_at)
      VALUES (?, ?, ?, ?)
    `).run(user.id, targetId || 0, groupId || 0, Date.now())
    return NextResponse.json({ success: true })
  } catch (error) {
    console.error("Typing status error:", error)
    return NextResponse.json({ error: "Internal Error" }, { status: 500 })
  }
}
export async function GET(req: Request) {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
    }
    const { searchParams } = new URL(req.url)
    const targetId = searchParams.get('targetId')
    const groupId = searchParams.get('groupId')
    const db = getDB()
    const now = Date.now()
    const THRESHOLD = 3000 // 3 seconds
    try {
        // Clean up old entries (optional, or run periodically)
        // db.prepare("DELETE FROM typing_status WHERE updated_at < ?").run(now - THRESHOLD)
        let isTyping = false
        if (groupId) {
            // Check if anyone else is typing in the group
            const res = db.prepare(`
                SELECT COUNT(*) as count FROM typing_status
                WHERE group_id = ? AND user_id != ? AND updated_at > ?
            `).get(groupId, user.id, now - THRESHOLD) as { count: number }
            isTyping = res.count > 0
        } else if (targetId) {
            // Check if the specific friend is typing to us
            // target_id in DB is the receiver. So if Friend is typing to Me:
            // Friend's user_id = FriendID, Friend's target_id = MeID
            const res = db.prepare(`
                SELECT COUNT(*) as count FROM typing_status
                WHERE user_id = ? AND target_id = ? AND updated_at > ?
            `).get(targetId, user.id, now - THRESHOLD) as { count: number }
            isTyping = res.count > 0
        }
        return NextResponse.json({ isTyping })
    } catch (error) {
        return NextResponse.json({ isTyping: false })
    }
}

--- FILE: app\api\chat\upload\route.ts ---

import { NextResponse } from "next/server"
import { getCurrentUser } from "@/lib/auth"
import { promises as fs } from "fs"
import path from "path"
import { Buffer } from "buffer"
export async function POST(req: Request) {
  try {
    const currentUser = await getCurrentUser()
    if (!currentUser) {
      return NextResponse.json(
        { error: "Unauthorized" },
        { status: 401 }
      )
    }
    const formData = await req.formData()
    const file = formData.get("file") as File
    if (!file) {
      return NextResponse.json(
        { error: "No file selected" },
        { status: 400 }
      )
    }
    // Validate file type
    const allowedTypes = [
        "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp",
        "audio/webm", "audio/mp3", "audio/wav", "audio/ogg"
    ]
    if (!allowedTypes.includes(file.type)) {
      return NextResponse.json(
        { error: "Unsupported file type" },
        { status: 400 }
      )
    }
    // Validate file size (max 10MB)
    const maxSize = 10 * 1024 * 1024
    if (file.size > maxSize) {
      return NextResponse.json(
        { error: "File too large (max 10MB)" },
        { status: 400 }
      )
    }
    // Create upload directory
    const uploadDir = path.join(process.cwd(), "public", "uploads", "chat")
    try {
      await fs.access(uploadDir)
    } catch {
      await fs.mkdir(uploadDir, { recursive: true })
    }
    // Generate filename
    const timestamp = Date.now()
    const mimeToExt: Record<string, string> = {
      "image/jpeg": ".jpg",
      "image/jpg": ".jpg",
      "image/png": ".png",
      "image/gif": ".gif",
      "image/webp": ".webp",
      "audio/webm": ".webm",
      "audio/mp3": ".mp3",
      "audio/wav": ".wav",
      "audio/ogg": ".ogg"
    }
    const ext = mimeToExt[file.type] || ".bin"
    const filename = `chat-${currentUser.id}-${timestamp}${ext}`
    const filepath = path.join(uploadDir, filename)
    // Save file
    const bytes = await file.arrayBuffer()
    const buffer = Buffer.from(bytes)
    await fs.writeFile(filepath, buffer)
    // Return file URL
    const fileUrl = `/uploads/chat/${filename}`
    return NextResponse.json({
      success: true,
      url: fileUrl,
    })
  } catch (error: any) {
    console.error("Upload failed:", error)
    return NextResponse.json(
      { error: `Upload failed: ${error.message}` },
      { status: 500 }
    )
  }
}

--- FILE: app\api\citations\route.ts ---

export async function POST(req: Request) {
  try {
    const { messages, apiKey, apiUrl, model, systemPrompt, enableSearch } = await req.json()
    if (!apiKey) {
      return Response.json({ error: "API Key is required" }, { status: 400 })
    }
    const isDashScope = apiUrl?.includes("dashscope.aliyuncs.com") || model?.startsWith("qwen")
    const isCompatibleMode = apiUrl?.includes("compatible-mode/v1") ?? false
    let targetUrl = apiUrl || ""
    if (isDashScope && isCompatibleMode) {
      if (/\/v1$/.test(targetUrl) && !/\/chat\/completions(\?|$)/.test(targetUrl)) {
        targetUrl = `${targetUrl}/chat/completions`
      }
    }
    const citationOnlyInstruction =
      "仅返回 <SOURCES> 与 </SOURCES> 包裹的 JSON 数组，数组项包含 number、title、url、description、quote。url 必须为真实可访问的 http/https 链接，来源必须来自联网检索结果，不得编造，不要返回正文。"
    const fullMessages = [
      { role: "system", content: `${systemPrompt || "你是一个有帮助的AI助手。"}\n\n${citationOnlyInstruction}` },
      ...(Array.isArray(messages) ? messages : []),
      { role: "user", content: "请仅返回<SOURCES>JSON，不要返回正文。" },
    ]
    let requestBody: Record<string, unknown>
    if (isDashScope && isCompatibleMode) {
      requestBody = {
        model: model || "qwen3-max",
        messages: fullMessages,
        temperature: 0,
        ...(enableSearch ? { enable_search: true, search_strategy: "agent" } : {}),
      }
    } else if (isDashScope) {
      requestBody = {
        model: model || "qwen-turbo",
        input: { messages: fullMessages },
        parameters: { result_format: "message" },
      }
    } else {
      requestBody = {
        model: model || "gpt-3.5-turbo",
        messages: fullMessages,
        temperature: 0,
      }
    }
    const headers: Record<string, string> = { "Content-Type": "application/json" }
    headers["Authorization"] = `Bearer ${apiKey}`
    const resp = await fetch(targetUrl, { method: "POST", headers, body: JSON.stringify(requestBody) })
    if (!resp.ok) {
      const t = await resp.text()
      return Response.json({ error: `API Error: ${resp.status} - ${t}` }, { status: resp.status })
    }
    const data = await resp.json()
    const content: string = data?.choices?.[0]?.message?.content ?? data?.output?.choices?.[0]?.message?.content ?? ""
    const m = content.match(/<SOURCES>\s*([\s\S]*?)\s*<\/SOURCES>/)
    let arr: unknown[] = []
    if (m && m[1]) {
      try {
        const parsed = JSON.parse(m[1])
        if (Array.isArray(parsed)) arr = parsed
      } catch {}
    }
    const toStr = (v: unknown) => (typeof v === "string" ? v.trim() : undefined)
    const pickUrlFromText = (s?: string) => {
      if (!s) return undefined
      const r1 = s.match(/https?:\/\/[^\s)]+/i)
      if (r1) return r1[0]
      const r2 = s.match(/\b([a-z0-9.-]+\.[a-z]{2,})(\/[^\s)]*)?/i)
      return r2 ? `https://${r2[0]}` : undefined
    }
    type Citation = { number: string; title: string; url: string; description?: string; quote?: string }
    const raw: Citation[] = arr.map((v) => {
      if (typeof v !== "object" || v === null) return null as unknown as Citation
      const o = v as Record<string, unknown>
      const num = String((o.number as string | number | undefined) ?? "1")
      const title = toStr(o.title) ?? toStr(o.url) ?? ""
      let u = toStr(o.url) ?? toStr(o.href) ?? toStr(o.link) ?? toStr(o.source) ?? toStr(o.website) ?? toStr(o.page) ?? toStr(o.page_url) ?? toStr(o.origin) ?? toStr(o.source_url) ?? toStr(o.openUrl) ?? undefined
      if (!u) u = pickUrlFromText(title) ?? pickUrlFromText(toStr(o.description)) ?? pickUrlFromText(toStr(o.quote))
      const description = toStr(o.description)
      const quote = toStr(o.quote)
      if (!u) return null as unknown as Citation
      if (!/^https?:\/\//i.test(u)) u = `https://${u}`
      return { number: num, title: String(title || u), url: String(u), description, quote }
    }).filter((x: Citation | null): x is Citation => !!x)
    const verifyUrl = async (u: string) => {
      try { new URL(u) } catch { return null }
      const ac = new AbortController()
      const to = setTimeout(() => ac.abort(), 7000)
      try {
        const r = await fetch(u, { method: "GET", redirect: "follow", cache: "no-store", signal: ac.signal })
        clearTimeout(to)
        if (r.ok || (r.status >= 300 && r.status < 400)) return r.url
      } catch {}
      return null
    }
    const out: Citation[] = []
    for (const c of raw) {
      const vu = await verifyUrl(c.url)
      if (vu) out.push({ ...c, url: vu })
    }
    return Response.json({ citations: out })
  } catch (e: unknown) {
    const msg = e instanceof Error ? e.message : String(e)
    return Response.json({ error: msg || "Internal error" }, { status: 500 })
  }
}

--- FILE: app\api\device-history\route.ts ---

import { NextRequest, NextResponse } from 'next/server'
// Helper function to generate data for a specific type
function generateDataForType(type: string, range: string) {
    const now = Date.now()
    const data = []
    let points = 20
    let interval = 0
    let startTime = 0
    switch (range) {
        case '1h':
            points = 12 // Every 5 mins
            interval = 5 * 60 * 1000
            startTime = now - 60 * 60 * 1000
            break
        case '1d':
            points = 24 // Every hour
            interval = 60 * 60 * 1000
            startTime = now - 24 * 60 * 60 * 1000
            break
        case '7d':
            points = 7 // Every day
            interval = 24 * 60 * 60 * 1000
            startTime = now - 7 * 24 * 60 * 60 * 1000
            break
        default:
            points = 12
            interval = 5 * 60 * 1000
            startTime = now - 60 * 60 * 1000
    }
    let baseValue = 0
    let variance = 0
    switch (type) {
        case 'temperature':
            baseValue = 25
            variance = 5
            break
        case 'humidity':
            baseValue = 60
            variance = 10
            break
        case 'light':
            baseValue = 5000
            variance = 2000
            break
        case 'co2':
            baseValue = 400
            variance = 50
            break
        case 'soilMoisture':
            baseValue = 45
            variance = 5
            break
        case 'fertility':
            baseValue = 150
            variance = 20
            break
        case 'nitrogen':
            baseValue = 100
            variance = 10
            break
        case 'phosphorus':
            baseValue = 50
            variance = 5
            break
        case 'potassium':
            baseValue = 120
            variance = 15
            break
        default:
            baseValue = 50
            variance = 10
    }
    for (let i = 0; i < points; i++) {
        const timestamp = startTime + i * interval
        // Add some randomness and sine wave for realism
        const timeFactor = Math.sin(i / points * Math.PI * 2) * (variance / 2)
        const randomFactor = (Math.random() - 0.5) * (variance / 2)
        let value = baseValue + timeFactor + randomFactor
        // Ensure positive values for physical quantities
        value = Math.max(0, value)
        // Round to 1 decimal place
        value = Math.round(value * 10) / 10
        data.push({ timestamp, value })
    }
    return data
}
export async function GET(req: NextRequest) {
    const searchParams = req.nextUrl.searchParams
    const types = searchParams.get('types') // Check for comma-separated types
    const type = searchParams.get('type') // Fallback for single type
    const range = searchParams.get('range') || '1h'
    if (types) {
        const typeList = types.split(',')
        const results: Record<string, any[]> = {}
        typeList.forEach(t => {
            results[t] = generateDataForType(t.trim(), range)
        })
        return NextResponse.json({ success: true, data: results })
    }
    if (type) {
        const data = generateDataForType(type, range)
        return NextResponse.json({ success: true, data })
    }
    return NextResponse.json({ error: 'Missing type or types parameter' }, { status: 400 })
}

--- FILE: app\api\device-logs\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { getDB, initDB } from "@/lib/db/database"
export async function GET(req: NextRequest) {
  try {
    await initDB()
    const db = getDB()
    const searchParams = req.nextUrl.searchParams
    const limit = parseInt(searchParams.get("limit") || "50")
    const logs = db.prepare(`
      SELECT * FROM device_logs
      ORDER BY created_at DESC
      LIMIT ?
    `).all(limit)
    return NextResponse.json({ success: true, logs })
  } catch (error) {
    console.error("Failed to fetch device logs:", error)
    return NextResponse.json(
      { success: false, error: "Failed to fetch logs" },
      { status: 500 }
    )
  }
}
export async function POST(req: NextRequest) {
  try {
    await initDB()
    const db = getDB()
    const body = await req.json()
    const { device_name, action, operator, details } = body
    if (!device_name || !action || !operator) {
      return NextResponse.json(
        { success: false, error: "Missing required fields" },
        { status: 400 }
      )
    }
    const stmt = db.prepare(`
      INSERT INTO device_logs (device_name, action, operator, details, created_at)
      VALUES (?, ?, ?, ?, ?)
    `)
    const result = stmt.run(device_name, action, operator, details || "", Date.now())
    return NextResponse.json({ success: true, id: result.lastInsertRowid })
  } catch (error) {
    console.error("Failed to create device log:", error)
    return NextResponse.json(
      { success: false, error: "Failed to create log" },
      { status: 500 }
    )
  }
}

--- FILE: app\api\direct-messages\clear\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { friendId } = await req.json()
    if (!friendId) {
      return NextResponse.json({ error: "Friend ID is required" }, { status: 400 })
    }
    const result = await ChatService.clearMessages(user.id, friendId)
    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to clear messages" }, { status: 500 })
  }
}

--- FILE: app\api\direct-messages\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function GET(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  const { searchParams } = new URL(req.url)
  const friendId = searchParams.get('friendId')
  if (!friendId) {
    return NextResponse.json({ error: "Friend ID is required" }, { status: 400 })
  }
  try {
    const messages = await ChatService.getMessages(user.id, parseInt(friendId))
    return NextResponse.json({ messages })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch messages" }, { status: 500 })
  }
}
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { friendId, content, type, fileUrl } = await req.json()
    if (!friendId || !content) {
      return NextResponse.json({ error: "Friend ID and content are required" }, { status: 400 })
    }
    const result = await ChatService.sendMessage(user.id, friendId, content, type || 'text', fileUrl)
    if (!result.success) {
      return NextResponse.json({ error: result.error || "Failed to send message" }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to send message" }, { status: 500 })
  }
}

--- FILE: app\api\friends\requests\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function GET() {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const requests = await ChatService.getFriendRequests(user.id)
    return NextResponse.json({ requests })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch requests" }, { status: 500 })
  }
}
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { email } = await req.json()
    if (!email) {
      return NextResponse.json({ error: "Email is required" }, { status: 400 })
    }
    const result = await ChatService.sendFriendRequest(user.id, email)
    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to send request" }, { status: 500 })
  }
}

--- FILE: app\api\friends\respond\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { requestId, action } = await req.json()
    if (!requestId || !action) {
      return NextResponse.json({ error: "Request ID and action are required" }, { status: 400 })
    }
    let result
    if (action === 'accept') {
      result = await ChatService.acceptFriendRequest(requestId, user.id)
    } else if (action === 'reject') {
      result = await ChatService.rejectFriendRequest(requestId, user.id)
    } else {
      return NextResponse.json({ error: "Invalid action" }, { status: 400 })
    }
    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to process request" }, { status: 500 })
  }
}

--- FILE: app\api\friends\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function GET() {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const friends = await ChatService.getFriends(user.id)
    return NextResponse.json({ friends })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch friends" }, { status: 500 })
  }
}

--- FILE: app\api\groups\members\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function GET(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  const { searchParams } = new URL(req.url)
  const groupId = searchParams.get('groupId')
  if (!groupId) {
    return NextResponse.json({ error: "Group ID is required" }, { status: 400 })
  }
  try {
    const members = await ChatService.getGroupMembers(parseInt(groupId))
    return NextResponse.json({ members })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch members" }, { status: 500 })
  }
}
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { groupId, userId, action } = await req.json()
    if (!groupId || !userId || !action) {
      return NextResponse.json({ error: "Group ID, User ID and action are required" }, { status: 400 })
    }
    let result
    if (action === 'add') {
      result = await ChatService.addGroupMember(groupId, user.id, userId)
    } else if (action === 'mute') {
      result = await ChatService.toggleGroupMute(groupId, user.id, userId, true)
    } else if (action === 'unmute') {
      result = await ChatService.toggleGroupMute(groupId, user.id, userId, false)
    } else {
      return NextResponse.json({ error: "Invalid action" }, { status: 400 })
    }
    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to update member" }, { status: 500 })
  }
}

--- FILE: app\api\groups\messages\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function GET(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  const { searchParams } = new URL(req.url)
  const groupId = searchParams.get('groupId')
  if (!groupId) {
    return NextResponse.json({ error: "Group ID is required" }, { status: 400 })
  }
  try {
    const messages = await ChatService.getMessages(user.id, parseInt(groupId), true)
    return NextResponse.json({ messages })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch messages" }, { status: 500 })
  }
}
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { groupId, content, type, fileUrl } = await req.json()
    if (!groupId || !content) {
      return NextResponse.json({ error: "Group ID and content are required" }, { status: 400 })
    }
    const result = await ChatService.sendMessage(user.id, null, content, type || 'text', fileUrl, parseInt(groupId))
    if (!result.success) {
        return NextResponse.json({ error: result.error }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to send message" }, { status: 500 })
  }
}

--- FILE: app\api\groups\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function GET() {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const groups = await ChatService.getUserGroups(user.id)
    return NextResponse.json({ groups })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch groups" }, { status: 500 })
  }
}
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { name, members } = await req.json()
    if (!name) {
      return NextResponse.json({ error: "Group name is required" }, { status: 400 })
    }
    const result = await ChatService.createGroup(user.id, name, members || [])
    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 })
    }
    return NextResponse.json({ message: result.message, groupId: result.groupId })
  } catch (error) {
    return NextResponse.json({ error: "Failed to create group" }, { status: 500 })
  }
}

--- FILE: app\api\internal\security\ban\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { addBannedIP } from "@/lib/db/security-service"
import { getInternalApiSecret } from "@/lib/constants"
export async function POST(req: NextRequest) {
  const secret = req.headers.get("x-internal-secret")
  if (secret !== getInternalApiSecret()) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { ip, reason } = await req.json()
    if (!ip) {
      return NextResponse.json({ error: "IP required" }, { status: 400 })
    }
    // Auto-ban for 24 hours
    const expiresAt = Date.now() + 24 * 60 * 60 * 1000
    await addBannedIP(ip, reason || "Auto-ban: Suspicious activity", "system", expiresAt)
    return NextResponse.json({ success: true })
  } catch (error) {
    console.error("Internal Ban Error:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\internal\security\check\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { isIPBanned } from "@/lib/db/security-service"
import { getInternalApiSecret } from "@/lib/constants"
export const dynamic = 'force-dynamic'
export async function GET(req: NextRequest) {
  const secret = req.headers.get("x-internal-secret")
  if (secret !== getInternalApiSecret()) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { searchParams } = new URL(req.url)
    const ip = searchParams.get("ip")
    if (!ip) {
      return NextResponse.json({ error: "IP required" }, { status: 400 })
    }
    const banned = await isIPBanned(ip)
    return NextResponse.json({ banned })
  } catch (error) {
    console.error("Internal Check Error:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\internal\security\config\route.ts ---

import { NextRequest, NextResponse } from "next/server"
import { getRateLimitConfig } from "@/lib/db/settings-service"
import { getInternalApiSecret } from "@/lib/constants"
export const dynamic = 'force-dynamic'
export async function GET(req: NextRequest) {
  const secret = req.headers.get("x-internal-secret")
  if (secret !== getInternalApiSecret()) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const config = await getRateLimitConfig()
    return NextResponse.json(config)
  } catch (error) {
    console.error("Internal Config Error:", error)
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\messages\check\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export const dynamic = 'force-dynamic'
export async function GET(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  const { searchParams } = new URL(req.url)
  const since = searchParams.get('since')
  const timestamp = since ? parseInt(since) : Date.now()
  try {
    const messages = await ChatService.getNewMessagesForUser(user.id, timestamp)
    return NextResponse.json({ messages, timestamp: Date.now() })
  } catch (error) {
    return NextResponse.json({ error: "Failed to check messages" }, { status: 500 })
  }
}

--- FILE: app\api\mqtt\control\route.ts ---

/**
 * MQTT Control API Route
 *
 * HTTP POST endpoint for sending control commands to IoT devices via MQTT.
 * Handles relay control and LED brightness adjustment.
 */
import { NextRequest, NextResponse } from 'next/server'
import { MQTTService } from '@/lib/mqtt-service'
import { getCurrentUser } from '@/lib/auth'
import { checkSecurity, logRequest } from '@/lib/security'
/**
 * Log structured message
 *
 * @param {string} level - Log level
 * @param {string} message - Log message
 * @param {any} data - Optional additional data
 */
function log(level: 'INFO' | 'WARN' | 'ERROR', message: string, data?: any): void {
  const logEntry = {
    timestamp: new Date().toISOString(),
    level,
    component: 'Control-API',
    message,
    ...(data && { data })
  }
  if (level === 'ERROR') {
    console.error(JSON.stringify(logEntry))
  } else if (level === 'WARN') {
    console.warn(JSON.stringify(logEntry))
  } else {
    console.log(JSON.stringify(logEntry))
  }
}
/**
 * Control Request Interface
 * Defines the structure of incoming control command requests
 */
interface ControlRequest {
  type: 'relay' | 'led'
  relayNum?: number       // Relay number (5-8)
  newState?: number       // Relay state (0/1)
  led1?: number           // LED 1 brightness (0-255)
  led2?: number           // LED 2 brightness (0-255)
  led3?: number           // LED 3 brightness (0-255)
  led4?: number           // LED 4 brightness (0-255)
}
/**
 * Control Response Interface
 * Defines the structure of API responses
 */
interface ControlResponse {
  success: boolean
  message: string
  timestamp: number
}
/**
 * Validate control request data
 *
 * @param {ControlRequest} data - Request data to validate
 * @returns {string | null} Error message if invalid, null if valid
 */
function validateControlRequest(data: ControlRequest): string | null {
  // Validate type field
  if (!data.type || (data.type !== 'relay' && data.type !== 'led')) {
    return 'Invalid or missing type field. Must be "relay" or "led"'
  }
  if (data.type === 'relay') {
    if (data.relayNum === undefined || data.newState === undefined) {
      return 'Relay command requires relayNum and newState'
    }
    if (data.relayNum < 5 || data.relayNum > 8) {
      return 'Relay number must be between 5 and 8'
    }
    if (data.newState !== 0 && data.newState !== 1) {
      return 'Relay state must be 0 or 1'
    }
  } else if (data.type === 'led') {
    // LED brightness validation is optional as they are optional fields
    // But if provided, must be 0-255
    const leds = [data.led1, data.led2, data.led3, data.led4]
    for (const val of leds) {
      if (val !== undefined && (val < 0 || val > 255)) {
        return 'LED brightness must be between 0 and 255'
      }
    }
  }
  return null
}
/**
 * POST /api/mqtt/control
 *
 * Receives control commands from frontend and sends them to devices via MQTT.
 *
 * @param {NextRequest} req - Next.js request object
 * @returns {NextResponse} JSON response with success status
 */
export async function POST(req: NextRequest): Promise<NextResponse> {
  // 1. Security Check (IP Ban & Logging)
  const securityCheck = await checkSecurity(req)
  if (!securityCheck.allowed) {
    return securityCheck.response!
  }
  try {
    // Verify authentication
    const currentUser = await getCurrentUser()
    if (!currentUser) {
      log('WARN', 'Unauthorized control command attempt')
      await logRequest(req, 401)
      return NextResponse.json(
        {
          success: false,
          message: 'Unauthorized',
          timestamp: Date.now()
        } as ControlResponse,
        { status: 401 }
      )
    }
    // Parse request body
    let body: ControlRequest
    try {
      body = await req.json()
    } catch (error) {
      log('WARN', 'Invalid JSON in request body', { error })
      await logRequest(req, 400, currentUser.id)
      return NextResponse.json(
        {
          success: false,
          message: 'Invalid JSON in request body',
          timestamp: Date.now()
        } as ControlResponse,
        { status: 400 }
      )
    }
    // Validate request data
    const validationError = validateControlRequest(body)
    if (validationError) {
      log('WARN', 'Request validation failed', { error: validationError, body })
      await logRequest(req, 400, currentUser.id)
      return NextResponse.json(
        {
          success: false,
          message: validationError,
          timestamp: Date.now()
        } as ControlResponse,
        { status: 400 }
      )
    }
    // 2. Permission Check
    if (currentUser.role !== 'super_admin' && currentUser.role !== 'admin') {
      const permissions = typeof currentUser.permissions === 'string'
        ? JSON.parse(currentUser.permissions || '{}')
        : currentUser.permissions || {};
      const allowedControls = permissions.allowedControls || [];
      if (body.type === 'relay') {
        const relayId = `relay${body.relayNum}`;
        if (!allowedControls.includes(relayId)) {
           log('WARN', 'Permission denied for relay control', { user: currentUser.username, relayId });
           await logRequest(req, 403, currentUser.id);
           return NextResponse.json(
             { success: false, message: `Permission denied: You cannot control ${relayId}`, timestamp: Date.now() },
             { status: 403 }
           );
        }
      } else if (body.type === 'led') {
        // Check permissions for each LED being set
        if (body.led1 !== undefined && !allowedControls.includes('led1')) {
           return NextResponse.json({ success: false, message: "Permission denied: You cannot control LED 1", timestamp: Date.now() }, { status: 403 });
        }
        if (body.led2 !== undefined && !allowedControls.includes('led2')) {
           return NextResponse.json({ success: false, message: "Permission denied: You cannot control LED 2", timestamp: Date.now() }, { status: 403 });
        }
        if (body.led3 !== undefined && !allowedControls.includes('led3')) {
           return NextResponse.json({ success: false, message: "Permission denied: You cannot control LED 3", timestamp: Date.now() }, { status: 403 });
        }
        if (body.led4 !== undefined && !allowedControls.includes('led4')) {
           return NextResponse.json({ success: false, message: "Permission denied: You cannot control LED 4", timestamp: Date.now() }, { status: 403 });
        }
      }
    }
    // Get MQTT service instance
    const mqttService = MQTTService.getInstance()
    // Connect to MQTT if not already connected
    if (!mqttService.isConnected()) {
      log('INFO', 'MQTT not connected, attempting to connect...')
      try {
        await mqttService.connect()
        log('INFO', 'MQTT connection established successfully')
      } catch (error) {
        log('ERROR', 'Failed to connect to MQTT service', error)
        return NextResponse.json(
          {
            success: false,
            message: 'Failed to connect to MQTT service',
            timestamp: Date.now()
          } as ControlResponse,
          { status: 503 }
        )
      }
    }
    // Log control command attempt
    log('INFO', 'Sending control command', {
      type: body.type,
      ...(body.type === 'relay' && { relayNum: body.relayNum, newState: body.newState }),
      ...(body.type === 'led' && { led1: body.led1, led2: body.led2, led3: body.led3, led4: body.led4 })
    })
    // Send control command via MQTT
    try {
      await mqttService.sendControlCommand({
        type: body.type,
        relayNum: body.relayNum,
        newState: body.newState,
        led1: body.led1,
        led2: body.led2,
        led3: body.led3,
        led4: body.led4
      })
      log('INFO', 'Control command sent successfully', { type: body.type })
      await logRequest(req, 200, currentUser.id)
      // Return success response
      return NextResponse.json(
        {
          success: true,
          message: 'Control command sent successfully',
          timestamp: Date.now()
        } as ControlResponse,
        { status: 200 }
      )
    } catch (error) {
      // Handle MQTT command send failure
      log('ERROR', 'Failed to send control command via MQTT', {
        error: error instanceof Error ? error.message : String(error),
        body
      })
      return NextResponse.json(
        {
          success: false,
          message: `Failed to send command: ${error instanceof Error ? error.message : 'Unknown error'}`,
          timestamp: Date.now()
        } as ControlResponse,
        { status: 500 }
      )
    }
  } catch (error) {
    // Catch any unexpected errors
    log('ERROR', 'Unexpected error in control API handler', {
      error: error instanceof Error ? error.message : String(error),
      stack: error instanceof Error ? error.stack : undefined
    })
    return NextResponse.json(
      {
        success: false,
        message: 'Internal server error',
        timestamp: Date.now()
      } as ControlResponse,
      { status: 500 }
    )
  }
}

--- FILE: app\api\mqtt\stream\route.ts ---

/**
 * SSE (Server-Sent Events) API Route for Real-time Device Data Streaming
 *
 * This endpoint provides a Server-Sent Events stream that pushes real-time
 * device data from the MQTT service to connected clients.
 *
 * Endpoint: GET /api/mqtt/stream
 * Response Type: text/event-stream
 */
import { NextRequest } from 'next/server'
import { MQTTService, DeviceData } from '@/lib/mqtt-service'
/**
 * SSE Message Types
 */
interface SSEMessage {
  type: 'connected' | 'data' | 'error'
  data?: DeviceData
  error?: string
  timestamp: number
}
/**
 * Verify JWT token from request headers (optional)
 *
 * @param {NextRequest} request - The incoming request
 * @returns {boolean} True if authentication is disabled or token is valid
 */
function verifyAuthentication(request: NextRequest): boolean {
  // Check if authentication is required
  const requireAuth = process.env.MQTT_SSE_REQUIRE_AUTH === 'true'
  if (!requireAuth) {
    return true // Authentication not required
  }
  // Get authorization header
  const authHeader = request.headers.get('authorization')
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return false
  }
  // Extract token
  const token = authHeader.substring(7)
  // TODO: Implement JWT verification using lib/auth.ts getJwtSecret()
  // For now, just check if token exists
  return token.length > 0
}
/**
 * GET Handler for SSE Stream
 *
 * Creates a Server-Sent Events stream that:
 * 1. Verifies authentication (if required)
 * 2. Checks MQTT connection status
 * 3. Establishes connection and sends initial message
 * 4. Sends latest device data if available
 * 5. Subscribes to MQTT data updates and streams them to client
 * 6. Handles connection cleanup on client disconnect
 *
 * @param {NextRequest} request - The incoming request
 * @returns {Response} SSE stream response
 */
export async function GET(request: NextRequest) {
  try {
    // Verify authentication (optional)
    if (!verifyAuthentication(request)) {
      console.log(JSON.stringify({
        timestamp: new Date().toISOString(),
        level: 'WARN',
        component: 'SSE-Stream',
        message: 'Unauthorized SSE connection attempt'
      }))
      return new Response(
        JSON.stringify({ error: 'Unauthorized' }),
        {
          status: 401,
          headers: { 'Content-Type': 'application/json' }
        }
      )
    }
    // Get MQTT service instance
    const mqttService = MQTTService.getInstance()
    // Connect to MQTT if not already connected
    if (!mqttService.isConnected()) {
      console.log(JSON.stringify({
        timestamp: new Date().toISOString(),
        level: 'INFO',
        component: 'SSE-Stream',
        message: 'MQTT not connected, attempting to connect...'
      }))
      try {
        await mqttService.connect()
        console.log(JSON.stringify({
          timestamp: new Date().toISOString(),
          level: 'INFO',
          component: 'SSE-Stream',
          message: 'MQTT connection established successfully'
        }))
      } catch (error) {
        console.log(JSON.stringify({
          timestamp: new Date().toISOString(),
          level: 'ERROR',
          component: 'SSE-Stream',
          message: 'Failed to connect to MQTT service',
          error: error instanceof Error ? error.message : String(error)
        }))
        return new Response(
          JSON.stringify({ error: 'Failed to connect to MQTT service' }),
          {
            status: 503,
            headers: { 'Content-Type': 'application/json' }
          }
        )
      }
    }
    // Set up SSE response headers
    const responseHeaders = new Headers({
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache, no-transform',
      'Connection': 'keep-alive',
      'X-Accel-Buffering': 'no', // Disable buffering for nginx
    })
    // Create a ReadableStream for SSE
    const stream = new ReadableStream({
      start(controller) {
        // Helper function to send SSE message
        const sendSSE = (message: SSEMessage) => {
          try {
            const data = JSON.stringify(message)
            const encoder = new TextEncoder()
            controller.enqueue(encoder.encode(`data: ${data}\n\n`))
          } catch (error) {
            console.error(JSON.stringify({
              timestamp: new Date().toISOString(),
              level: 'ERROR',
              component: 'SSE-Stream',
              message: 'Error encoding SSE message',
              error: error instanceof Error ? error.message : String(error)
            }))
          }
        }
        // Log connection
        console.log(JSON.stringify({
          timestamp: new Date().toISOString(),
          level: 'INFO',
          component: 'SSE-Stream',
          message: 'Client connected to SSE stream'
        }))
        // Send initial connection message
        sendSSE({
          type: 'connected',
          timestamp: Date.now()
        })
        // Send latest data if available
        const latestData = mqttService.getLatestData()
        if (latestData) {
          sendSSE({
            type: 'data',
            data: latestData,
            timestamp: Date.now()
          })
        }
        // Subscribe to MQTT data updates
        const unsubscribe = mqttService.subscribeToData((deviceData: DeviceData) => {
          try {
            sendSSE({
              type: 'data',
              data: deviceData,
              timestamp: Date.now()
            })
          } catch (error) {
            console.error(JSON.stringify({
              timestamp: new Date().toISOString(),
              level: 'ERROR',
              component: 'SSE-Stream',
              message: 'Error sending data to SSE client',
              error: error instanceof Error ? error.message : String(error)
            }))
          }
        })
        // Store unsubscribe function for cleanup
        // @ts-ignore - Attach to controller for cleanup
        controller.unsubscribe = unsubscribe
      },
      cancel(controller) {
        // Clean up when client disconnects
        console.log(JSON.stringify({
          timestamp: new Date().toISOString(),
          level: 'INFO',
          component: 'SSE-Stream',
          message: 'Client disconnected from SSE stream'
        }))
        // Unsubscribe from MQTT data updates
        // @ts-ignore
        if (controller.unsubscribe) {
          // @ts-ignore
          controller.unsubscribe()
        }
      }
    })
    return new Response(stream, { headers: responseHeaders })
  } catch (error) {
    // Catch any unexpected errors
    console.error(JSON.stringify({
      timestamp: new Date().toISOString(),
      level: 'ERROR',
      component: 'SSE-Stream',
      message: 'Unexpected error in SSE stream handler',
      error: error instanceof Error ? error.message : String(error)
    }))
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      }
    )
  }
}

--- FILE: app\api\plant-growth\route.ts ---

import { NextRequest, NextResponse } from 'next/server'
import type { PlantAnalysisResult } from '@/lib/types/plant-growth-types'
// In-memory cache for plant growth state
let plantGrowthCache: PlantAnalysisResult | null = null
let lastAnalysisTime: number = 0
export async function GET(req: NextRequest) {
    try {
        return NextResponse.json({
            success: true,
            data: plantGrowthCache,
            lastAnalyzed: lastAnalysisTime || null
        })
    } catch (error: any) {
        console.error('Get plant growth error:', error)
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        )
    }
}
export async function POST(req: NextRequest) {
    try {
        const { result } = await req.json()
        if (!result) {
            return NextResponse.json(
                { error: 'Missing analysis result data' },
                { status: 400 }
            )
        }
        // Update cache
        plantGrowthCache = result
        lastAnalysisTime = Date.now()
        return NextResponse.json({
            success: true,
            message: 'Plant growth state updated',
            data: plantGrowthCache
        })
    } catch (error: any) {
        console.error('Update plant growth error:', error)
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        )
    }
}

--- FILE: app\api\scheduler\init\route.ts ---

import { NextResponse } from "next/server"
import { SchedulerRunner } from "@/lib/scheduler/runner"
import { initDB } from "@/lib/db/database"
export const dynamic = 'force-dynamic'
export async function GET() {
  try {
    await initDB()
    await SchedulerRunner.getInstance().init()
    return NextResponse.json({ success: true, message: "Scheduler initialized" })
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}

--- FILE: app\api\scheduler\tasks\route.ts ---

import { NextResponse } from "next/server"
import { createTask, getAllTasks, deleteTask, CreateTaskDTO } from "@/lib/db/scheduler-service"
import { SchedulerRunner } from "@/lib/scheduler/runner"
import { CronExpressionParser } from "cron-parser"
import { initDB } from "@/lib/db/database"
// Force dynamic to ensure we don't cache the list
export const dynamic = 'force-dynamic'
export async function GET() {
  try {
    await initDB()
    const tasks = getAllTasks()
    // Add next_run for cron tasks
    const tasksWithNextRun = tasks.map(task => {
      let next_run = task.execute_at
      if (task.cron_expression) {
        try {
          const interval = CronExpressionParser.parse(task.cron_expression)
          next_run = interval.next().getTime()
        } catch (e) {
          console.error(`Invalid cron expression for task ${task.id}:`, e)
        }
      }
      return { ...task, next_run }
    })
    return NextResponse.json({ success: true, tasks: tasksWithNextRun })
  } catch (error: any) {
    console.error("GET /api/scheduler/tasks error:", error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
export async function POST(req: Request) {
  try {
    await initDB()
    const body = await req.json()
    const task = createTask(body as CreateTaskDTO)
    // Notify runner to refresh
    await SchedulerRunner.getInstance().refreshTasks()
    return NextResponse.json({ success: true, task })
  } catch (error: any) {
    console.error("POST /api/scheduler/tasks error:", error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
export async function DELETE(req: Request) {
  try {
    await initDB()
    const { searchParams } = new URL(req.url)
    const id = searchParams.get('id')
    if (!id) {
      return NextResponse.json({ error: "ID required" }, { status: 400 })
    }
    deleteTask(parseInt(id))
    // Notify runner to refresh
    await SchedulerRunner.getInstance().refreshTasks()
    return NextResponse.json({ success: true })
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}

--- FILE: app\api\sessions\route.ts ---

import { NextRequest } from "next/server"
import { createSession, listSessions } from "../../../lib/server/sessionStore"
import { getCurrentUser } from "@/lib/auth"
export async function GET(_req: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    const sessions = await listSessions(user.id)
    return Response.json({ sessions })
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e)
    return Response.json({ error: msg }, { status: 500 })
  }
}
export async function POST(req: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    let title = "新会话"
    try {
      const body = await req.json()
      if (body && typeof body.title === "string" && body.title.trim()) title = body.title.trim()
    } catch {}
    const session = await createSession(title, user.id)
    return Response.json(session)
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e)
    return Response.json({ error: msg }, { status: 500 })
  }
}

--- FILE: app\api\sessions\[id]\route.ts ---

import { NextRequest } from "next/server"
import { deleteSession, getMessages, saveMessages, ChatMessage, updateSessionTitle } from "../../../../lib/server/sessionStore"
import { getCurrentUser } from "@/lib/auth"
export async function GET(_req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    const { id } = await params
    const messages = await getMessages(id, user.id)
    if (messages === null) {
      return Response.json({ error: "Session not found or unauthorized" }, { status: 404 })
    }
    return Response.json({ messages })
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e)
    return Response.json({ error: msg }, { status: 500 })
  }
}
export async function PUT(req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    const { id } = await params
    const body = await req.json().catch(() => ({}))
    const raw = Array.isArray(body?.messages) ? body.messages : []
    const messages: ChatMessage[] = raw.map((m: any) => ({
      role: m?.role === "user" ? "user" : "assistant",
      content: String(m?.content ?? ""),
      citations: Array.isArray(m?.citations) ? m.citations : undefined,
      reasoning: m?.reasoning && typeof m.reasoning === "object" ? { text: String(m.reasoning.text ?? ""), durationMs: typeof m.reasoning.durationMs === "number" ? m.reasoning.durationMs : undefined } : undefined,
      tasks: Array.isArray(m?.tasks) ? m.tasks : undefined,
    }))
    await saveMessages(id, messages, user.id)
    return Response.json({ ok: true })
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e)
    if (msg.includes("Unauthorized")) {
      return Response.json({ error: msg }, { status: 403 })
    }
    return Response.json({ error: msg }, { status: 500 })
  }
}
export async function DELETE(_req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    const { id } = await params
    await deleteSession(id, user.id)
    return Response.json({ ok: true })
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e)
    if (msg.includes("Unauthorized")) {
      return Response.json({ error: msg }, { status: 403 })
    }
    return Response.json({ error: msg }, { status: 500 })
  }
}
export async function PATCH(req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    const { id } = await params
    const body = await req.json().catch(() => ({}))
    const title = typeof body?.title === "string" ? body.title : ""
    await updateSessionTitle(id, title, user.id)
    return Response.json({ ok: true })
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e)
    if (msg.includes("Unauthorized")) {
      return Response.json({ error: msg }, { status: 403 })
    }
    return Response.json({ error: msg }, { status: 500 })
  }
}

--- FILE: app\api\settings\route.ts ---

import { cookies } from "next/headers"
// 临时存储（生产环境应该使用数据库）
const settingsStore = new Map<string, any>()
export async function GET() {
  try {
    const cookieStore = await cookies()
    const authCookie = cookieStore.get("auth")
    const defaultSettings = {
      apiKey: "",
      apiUrl:
        "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
      model: "qwen-turbo",
      systemPrompt:
        "你是莓界智慧农业平台的AI助手，专门帮助用户分析农业数据、提供种植建议和解答农业相关问题。请用专业但易懂的语言回答问题。\n\n重要提醒：如果需要提供参考来源，请确保所有链接和信息都是真实存在的，绝对不要编造虚假的网站或来源。如果不确定来源，请直接说明这是基于你的知识库回答，而不是提供虚假引用。",
    }
    if (!authCookie) {
      // 未登录时返回默认设置
      return Response.json(defaultSettings)
    }
    // 使用用户token作为key（简化版，生产环境应该解析JWT）
    const userSettings = settingsStore.get(authCookie.value) || defaultSettings
    return Response.json(userSettings)
  } catch (error) {
    console.error("获取设置失败:", error)
    return Response.json({ error: "获取设置失败" }, { status: 500 })
  }
}
export async function POST(req: Request) {
  try {
    const cookieStore = await cookies()
    const authCookie = cookieStore.get("auth")
    const settings = await req.json()
    // 验证必需字段
    if (!settings.apiKey || !settings.apiUrl) {
      return Response.json({ error: "缺少必需字段" }, { status: 400 })
    }
    if (!authCookie) {
      // 未登录时，返回成功但提示使用localStorage
      return Response.json({
        success: true,
        message: "设置已保存到本地（未登录状态）",
        useLocalStorage: true
      })
    }
    // 保存设置
    settingsStore.set(authCookie.value, settings)
    return Response.json({ success: true, message: "设置已保存" })
  } catch (error) {
    console.error("保存设置失败:", error)
    return Response.json({ error: "保存设置失败" }, { status: 500 })
  }
}

--- FILE: app\api\user\settings\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { updateUser, NotificationSettings } from "@/lib/db/user-service"
export async function PATCH(request: Request) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return Response.json({ error: "Unauthorized" }, { status: 401 })
    }
    const body = await request.json()
    const notification_settings = body.notification_settings as NotificationSettings
    if (!notification_settings) {
      return Response.json({ error: "Missing notification_settings" }, { status: 400 })
    }
    const updatedUser = await updateUser(user.id, { notification_settings })
    return Response.json({
      success: true,
      user: updatedUser,
    })
  } catch (error) {
    console.error("Failed to update notification settings:", error)
    return Response.json({ error: "Internal Server Error" }, { status: 500 })
  }
}

--- FILE: app\api\user\update\route.ts ---

import { NextResponse } from "next/server"
import { getCurrentUser } from "@/lib/auth"
import { updateUser } from "@/lib/db/user-service"
import { updateUserSchema } from "@/lib/validations/auth"
/**
 * PUT /api/user/update
 * 更新当前用户信息
 */
export async function PUT(req: Request) {
  try {
    // 获取当前登录用户
    const currentUser = await getCurrentUser()
    if (!currentUser) {
      return NextResponse.json(
        { error: "未登录" },
        { status: 401 }
      )
    }
    const body = await req.json()
    // Use Zod to validate input
    const result = updateUserSchema.safeParse(body)
    if (!result.success) {
      return NextResponse.json(
        { error: result.error.issues[0].message },
        { status: 400 }
      )
    }
    const { username, avatar_url } = result.data
    // 更新用户信息
    const updatedUser = await updateUser(currentUser.id, {
      username,
      avatar_url,
    })
    return NextResponse.json({
      ok: true,
      user: updatedUser,
    })
  } catch (error) {
    console.error("更新用户信息失败:", error)
    return NextResponse.json(
      { error: "服务异常,请稍后重试" },
      { status: 500 }
    )
  }
}

--- FILE: app\api\user\upload-avatar\route.ts ---

import { NextResponse } from "next/server"
import { getCurrentUser } from "@/lib/auth"
import { promises as fs } from "fs"
import path from "path"
/**
 * POST /api/user/upload-avatar
 * 上传用户头像
 */
export async function POST(req: Request) {
  try {
    // 获取当前登录用户
    const currentUser = await getCurrentUser()
    if (!currentUser) {
      return NextResponse.json(
        { error: "未登录" },
        { status: 401 }
      )
    }
    const formData = await req.formData()
    const file = formData.get("avatar") as File
    if (!file) {
      return NextResponse.json(
        { error: "未选择文件" },
        { status: 400 }
      )
    }
    // 验证文件类型
    const allowedTypes = ["image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp"]
    if (!allowedTypes.includes(file.type)) {
      return NextResponse.json(
        { error: "只支持 JPG、PNG、GIF 和 WebP 格式的图片" },
        { status: 400 }
      )
    }
    // 验证文件大小（最大 5MB）
    const maxSize = 5 * 1024 * 1024 // 5MB
    if (file.size > maxSize) {
      return NextResponse.json(
        { error: "文件大小不能超过 5MB" },
        { status: 400 }
      )
    }
    // 创建上传目录
    const uploadDir = path.join(process.cwd(), "public", "uploads", "avatars")
    try {
      await fs.access(uploadDir)
    } catch {
      await fs.mkdir(uploadDir, { recursive: true })
    }
    // 生成唯一文件名 (强制使用安全后缀，防止脚本注入)
    const timestamp = Date.now()
    // const ext = path.extname(file.name) // 不使用用户提供的后缀
    const mimeToExt: Record<string, string> = {
      "image/jpeg": ".jpg",
      "image/jpg": ".jpg",
      "image/png": ".png",
      "image/gif": ".gif",
      "image/webp": ".webp",
    }
    const ext = mimeToExt[file.type] || ".png"
    const filename = `avatar-${currentUser.id}-${timestamp}${ext}`
    const filepath = path.join(uploadDir, filename)
    // 保存文件
    const bytes = await file.arrayBuffer()
    const buffer = Buffer.from(bytes)
    await fs.writeFile(filepath, buffer)
    // 返回文件 URL
    const avatarUrl = `/uploads/avatars/${filename}`
    return NextResponse.json({
      ok: true,
      avatar_url: avatarUrl,
    })
  } catch (error) {
    console.error("上传头像失败:", error)
    return NextResponse.json(
      { error: "上传失败,请稍后重试" },
      { status: 500 }
    )
  }
}

--- FILE: app\api\users\block\route.ts ---

import { getCurrentUser } from "@/lib/auth"
import { ChatService } from "@/lib/db/chat-service"
import { NextResponse } from "next/server"
export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }
  try {
    const { friendId, block } = await req.json()
    if (!friendId || block === undefined) {
      return NextResponse.json({ error: "Friend ID and block status are required" }, { status: 400 })
    }
    const result = await ChatService.toggleBlockUser(user.id, friendId, block)
    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 })
    }
    return NextResponse.json({ message: result.message })
  } catch (error) {
    return NextResponse.json({ error: "Failed to update block status" }, { status: 500 })
  }
}

--- FILE: app\api\vlm\analyze-frame\route.ts ---

import { NextRequest, NextResponse } from 'next/server'
import { getDefaultVLMModel, PLANT_DIAGNOSIS_PROMPT_COMPACT } from '@/lib/vlm-prompts'
import type { PlantAnalysisResult } from '@/lib/types/plant-growth-types'
import { getHealthStatus } from '@/lib/types/plant-growth-types'
export async function POST(req: NextRequest) {
    try {
        const { imageData, model, apiKey, apiUrl } = await req.json()
        if (!imageData) {
            return NextResponse.json(
                { error: 'Missing image data' },
                { status: 400 }
            )
        }
        if (!apiKey) {
            return NextResponse.json(
                { error: 'Missing API key. Please configure in AI settings.' },
                { status: 400 }
            )
        }
        // Use provided model or default to qwen3-vl-plus
        const vlmModel = model || getDefaultVLMModel()
        // Determine API endpoint
        const isDashScope = apiUrl?.includes('dashscope.aliyuncs.com') || vlmModel.startsWith('qwen')
        const isCompatibleMode = apiUrl?.includes('compatible-mode/v1') ?? false
        let targetUrl = apiUrl || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'
        // Ensure URL ends with /chat/completions for compatible mode
        if (isDashScope && isCompatibleMode && /\/v1$/.test(targetUrl)) {
            targetUrl = `${targetUrl}/chat/completions`
        }
        // Prepare messages for VLM
        const messages = [
            {
                role: 'user',
                content: [
                    {
                        type: 'image_url',
                        image_url: {
                            url: imageData
                        }
                    },
                    {
                        type: 'text',
                        text: PLANT_DIAGNOSIS_PROMPT_COMPACT
                    }
                ]
            }
        ]
        // Call VLM API
        const response = await fetch(targetUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: vlmModel,
                messages: messages,
                temperature: 0.1, // Low temperature for consistent diagnosis
                max_tokens: 500
            })
        })
        if (!response.ok) {
            const errorText = await response.text()
            console.error('VLM API Error:', errorText)
            return NextResponse.json(
                { error: `VLM API Error: ${response.status} - ${errorText}` },
                { status: response.status }
            )
        }
        const data = await response.json()
        // Extract content from response
        let content = ''
        if (isDashScope && !isCompatibleMode) {
            content = data.output?.choices?.[0]?.message?.content || data.output?.text || ''
        } else {
            content = data.choices?.[0]?.message?.content || ''
        }
        // Parse JSON response from VLM
        let analysisData: any
        try {
            // Try to extract JSON from the content
            const jsonMatch = content.match(/\{[\s\S]*\}/)
            if (jsonMatch) {
                analysisData = JSON.parse(jsonMatch[0])
            } else {
                throw new Error('No JSON found in response')
            }
        } catch (parseError) {
            console.error('Failed to parse VLM response:', content)
            return NextResponse.json(
                { error: 'Failed to parse VLM response. Please try again.' },
                { status: 500 }
            )
        }
        // Validate and construct result
        const result: PlantAnalysisResult = {
            stage: analysisData.stage || 3,
            healthScore: analysisData.healthScore || 75,
            healthStatus: getHealthStatus(analysisData.healthScore || 75),
            issues: Array.isArray(analysisData.issues) ? analysisData.issues : [],
            recommendations: Array.isArray(analysisData.recommendations) ? analysisData.recommendations : [],
            confidence: 0.8, // We could calculate this based on response quality
            timestamp: Date.now(),
            heatmap: Array.isArray(analysisData.heatmap) && analysisData.heatmap.length === 6
                ? analysisData.heatmap
                : [75, 75, 75, 75, 75, 75] // Default values
        }
        // Get token usage if available
        const tokenUsage = {
            input: data.usage?.prompt_tokens || 0,
            output: data.usage?.completion_tokens || 0,
            total: data.usage?.total_tokens || 0
        }
        return NextResponse.json({
            success: true,
            result,
            tokenUsage
        })
    } catch (error: any) {
        console.error('VLM Analysis Error:', error)
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        )
    }
}

--- FILE: app\api\weather\route.ts ---

/**
 * Weather API Route
 *
 * Proxies requests to WeatherAPI.com
 */
import { NextRequest, NextResponse } from 'next/server'
export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams
    const lat = searchParams.get('lat')
    const lon = searchParams.get('lon')
    const useIP = searchParams.get('useIP') === 'true'
    // Get API key from environment variables
    const apiKey = process.env.WEATHER_API_KEY || ''
    if (!apiKey) {
      return NextResponse.json(
        { error: 'Weather API key not configured' },
        { status: 500 }
      )
    }
    let location = 'Ningbo,China'
    let locationSource = 'default'
    const isPrivateIPv4 = (ip: string) => {
      const m = ip.match(/^([0-9]{1,3}\.){3}[0-9]{1,3}$/)
      if (!m) return false
      const [a, b] = ip.split('.').map(Number)
      if (a === 10) return true
      if (a === 172 && b >= 16 && b <= 31) return true
      if (a === 192 && b === 168) return true
      if (a === 127) return true
      return false
    }
    const normalizeIp = (ip: string | null) => {
      if (!ip) return null
      const first = ip.split(',')[0].trim()
      const mapped = first.startsWith('::ffff:') ? first.replace('::ffff:', '') : first
      return mapped
    }
    if (lat && lon) {
      location = `${lat},${lon}`
      locationSource = 'gps'
    } else {
      const forwardedFor = normalizeIp(request.headers.get('x-forwarded-for'))
      const realIp = normalizeIp(request.headers.get('x-real-ip'))
      const candidateIp = forwardedFor || realIp
      const shouldUseHeaderIp = !!candidateIp && candidateIp !== '::1' && candidateIp !== '127.0.0.1' && !isPrivateIPv4(candidateIp) && !useIP
      if (shouldUseHeaderIp) {
        location = candidateIp as string
        locationSource = 'client-ip'
      } else if (useIP) {
        try {
          const ipResponse = await fetch('https://ipapi.co/json', { next: { revalidate: 3600 } })
          if (ipResponse.ok) {
            const ipData = await ipResponse.json()
            if (ipData && ipData.city) {
              location = ipData.city
              locationSource = 'external-ip-api'
              console.log('[Weather API] Detected location from ipapi.co:', location)
            } else {
              location = 'auto:ip'
              locationSource = 'server-ip'
            }
          } else {
            location = 'auto:ip'
            locationSource = 'server-ip'
          }
        } catch (e) {
          console.error('[Weather API] Failed to fetch from ipapi.co:', e)
          location = 'auto:ip'
          locationSource = 'server-ip'
        }
      }
    }
    // Build API URL for forecast (7 days)
    const apiUrl = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${location}&days=7&aqi=no&alerts=no`
    console.log('[Weather API] Fetching weather for location:', location, '(source:', locationSource + ')')
    // Fetch weather data
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      // Cache for 30 minutes
      next: { revalidate: 1800 }
    })
    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(`Weather API returned ${response.status}: ${errorData.error?.message || 'Unknown error'}`)
    }
    const data = await response.json()
    console.log('[Weather API] Successfully fetched weather data for', data.location?.name)
    // Add location source to response
    return NextResponse.json({
      ...data,
      locationSource
    })
  } catch (error) {
    console.error('[Weather API] Error:', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to fetch weather data' },
      { status: 500 }
    )
  }
}

--- FILE: app\chat\page.tsx ---

"use client"
import { useState, useEffect, useRef, useCallback } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { Badge } from "@/components/ui/badge"
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from "@/components/ui/dropdown-menu"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { toast } from "sonner"
import { Send, UserPlus, Check, CheckCheck, X, MessageSquare, User as UserIcon, ChevronLeft, Users, MoreVertical, Shield, ShieldOff, Volume2, VolumeX, Plus, LogOut, Edit, Search, Phone, Video, MapPin, Image as ImageIcon, Smile, Mic, Paperclip, Bell, MessageCircle, Settings, Home, LayoutGrid, Sparkles, Trash2 } from "lucide-react"
import { cn } from "@/lib/utils"
import Link from "next/link"
import { PageNavigation } from "@/components/page-navigation"
import { ModeToggle } from "@/components/mode-toggle"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import Image from "next/image"
import { UpdateAnnouncement } from "@/components/update-announcement"
import { MobileBottomNav } from "@/components/mobile-bottom-nav"
interface User {
  id: number
  username: string
  email: string
  avatar_url: string | null
  role?: string
  is_blocked?: boolean
  last_message?: Message
  unread_count?: number
}
interface FriendRequest {
  id: number
  requester: User
  status: string
  created_at: number
}
interface Group {
  id: number
  name: string
  owner_id: number
  avatar_url: string | null
  created_at: number
  last_message?: Message
  unread_count?: number
}
interface GroupMember {
  group_id: number
  user_id: number
  role: 'owner' | 'admin' | 'member'
  is_muted: boolean
  user: User
}
interface Message {
  id: number
  sender_id: number
  receiver_id: number | null
  group_id: number | null
  content: string
  type?: string
  file_url?: string | null
  created_at: number
  read_at: number | null
}
const formatTime = (timestamp: number) => {
  if (!timestamp) return ""
  const date = new Date(timestamp)
  const now = new Date()
  if (date.toDateString() === now.toDateString()) {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  }
  return date.toLocaleDateString()
}
export default function ChatPage() {
  const [friends, setFriends] = useState<User[]>([])
  const [groups, setGroups] = useState<Group[]>([])
  const [requests, setRequests] = useState<FriendRequest[]>([])
  const [activeFriend, setActiveFriend] = useState<User | null>(null)
  const [activeGroup, setActiveGroup] = useState<Group | null>(null)
  const [isTyping, setIsTyping] = useState(false)
  // Debounce typing status
  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null)
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      setInputValue(e.target.value)
      // Send typing status
      if (activeFriend || activeGroup) {
          // Throttle sending every 1s
          if (!typingTimeoutRef.current) {
              fetch('/api/chat/typing', {
                  method: 'POST',
                  body: JSON.stringify({
                      targetId: activeFriend?.id,
                      groupId: activeGroup?.id
                  })
              })
              typingTimeoutRef.current = setTimeout(() => {
                  typingTimeoutRef.current = null
              }, 1000)
          }
      }
  }
  // Poll for typing status of other user
  useEffect(() => {
      if (!activeFriend && !activeGroup) return
      const checkTyping = async () => {
          try {
              const params = new URLSearchParams()
              if (activeFriend) params.append('targetId', activeFriend.id.toString())
              if (activeGroup) params.append('groupId', activeGroup.id.toString())
              const res = await fetch(`/api/chat/typing?${params.toString()}`)
              const data = await res.json()
              setIsTyping(data.isTyping)
          } catch (e) {
              console.error(e)
          }
      }
      checkTyping() // Check immediately
      const interval = setInterval(checkTyping, 2000) // Poll every 2s
      return () => clearInterval(interval)
  }, [activeFriend, activeGroup])
  const [messages, setMessages] = useState<Message[]>([])
  const [inputValue, setInputValue] = useState("")
  const [searchQuery, setSearchQuery] = useState("")
  const [isRecording, setIsRecording] = useState(false)
  const [mediaRecorder, setMediaRecorder] = useState<MediaRecorder | null>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const emojis = ["", "", "", "", "", "", "", "", "", ""]
  const handleClearHistory = async (friendId: number) => {
    try {
        const res = await fetch('/api/direct-messages/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ friendId })
        })
        const data = await res.json()
        if (res.ok) {
            toast.success("聊天记录已清空")
            setMessages([])
            fetchFriends() // Refresh last message in sidebar
        } else {
            toast.error(data.error || "清空聊天记录失败")
        }
    } catch (error) {
        toast.error("清空聊天记录失败")
    }
  }
  const startRecording = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
        const recorder = new MediaRecorder(stream)
        const chunks: Blob[] = []
        recorder.ondataavailable = (e) => chunks.push(e.data)
        recorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm' })
            const file = new File([blob], "recording.webm", { type: 'audio/webm' })
            const formData = new FormData()
            formData.append('file', file)
            try {
                const res = await fetch('/api/chat/upload', { method: 'POST', body: formData })
                const data = await res.json()
                if (data.success) {
                    await handleSendMessage('[语音]', 'audio', data.url)
                }
            } catch (e) {
                toast.error("Audio upload failed")
            }
        }
        recorder.start()
        setMediaRecorder(recorder)
        setIsRecording(true)
    } catch (err) {
        console.error(err)
        toast.error("Could not access microphone")
    }
  }
  const stopRecording = () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop()
        mediaRecorder.stream.getTracks().forEach(track => track.stop())
        setIsRecording(false)
        setMediaRecorder(null)
    }
  }
  const filteredFriends = friends.filter(f =>
    f.username.toLowerCase().includes(searchQuery.toLowerCase()) ||
    f.email.toLowerCase().includes(searchQuery.toLowerCase())
  )
  const filteredGroups = groups.filter(g =>
    g.name.toLowerCase().includes(searchQuery.toLowerCase())
  )
  const [addFriendEmail, setAddFriendEmail] = useState("")
  const [isAddFriendOpen, setIsAddFriendOpen] = useState(false)
  const [isCreateGroupOpen, setIsCreateGroupOpen] = useState(false)
  const [showChatDetails, setShowChatDetails] = useState(false)
  // Group creation state
  const [newGroupName, setNewGroupName] = useState("")
  const [selectedFriends, setSelectedFriends] = useState<number[]>([])
  // Group info state
  const [groupMembers, setGroupMembers] = useState<GroupMember[]>([])
  const [currentUser, setCurrentUser] = useState<User | null>(null)
  const [isMobile, setIsMobile] = useState(false)
  const [viewMode, setViewMode] = useState<'messages' | 'groups'>('messages')
  // Detect mobile
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 768)
    checkMobile()
    window.addEventListener('resize', checkMobile)
    return () => window.removeEventListener('resize', checkMobile)
  }, [])
  // Fetch current user
  useEffect(() => {
    fetch('/api/auth/me').then(res => res.json()).then(data => {
      if (data.user) setCurrentUser(data.user)
    })
  }, [])
  // Fetch friends
  const fetchFriends = async () => {
      try {
        const res = await fetch('/api/friends')
        const data = await res.json()
        if (data.friends) setFriends(data.friends)
      } catch (error) { console.error(error) }
  }
  // Fetch groups
  const fetchUserGroups = async () => {
      try {
        const res = await fetch('/api/groups')
        const data = await res.json()
        if (data.groups) setGroups(data.groups)
      } catch (error) { console.error(error) }
  }
  // Fetch requests
  const fetchRequests = async () => {
      try {
          const res = await fetch('/api/friends/requests')
          const data = await res.json()
          if (data.requests) setRequests(data.requests)
      } catch (error) { console.error(error) }
  }
  // Fetch all data
  const fetchData = async () => {
    await Promise.all([fetchFriends(), fetchRequests(), fetchUserGroups()])
  }
  useEffect(() => {
    fetchData()
    const interval = setInterval(fetchData, 10000) // Poll every 10s
    return () => clearInterval(interval)
  }, [])
  // Fetch messages when active chat changes
  const fetchMessages = useCallback(async () => {
    if (!activeFriend && !activeGroup) return
    try {
      let url = ''
      if (activeFriend) {
        url = `/api/direct-messages?friendId=${activeFriend.id}`
      } else if (activeGroup) {
        url = `/api/groups/messages?groupId=${activeGroup.id}`
      }
      const res = await fetch(url)
      const data = await res.json()
      if (data.messages) setMessages(data.messages)
    } catch (error) {
      console.error("Failed to fetch messages", error)
    }
  }, [activeFriend, activeGroup])
  useEffect(() => {
    fetchMessages()
    const interval = setInterval(fetchMessages, 3000) // Poll messages every 3s
    return () => clearInterval(interval)
  }, [fetchMessages])
  // Fetch group members when viewing group info
  useEffect(() => {
    if (activeGroup && showChatDetails) {
      fetch(`/api/groups/members?groupId=${activeGroup.id}`)
        .then(res => res.json())
        .then(data => {
          if (data.members) setGroupMembers(data.members)
        })
    }
  }, [activeGroup, showChatDetails])
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const lastMessageIdRef = useRef<number | null>(null)
  // Scroll to bottom only when new messages arrive
  useEffect(() => {
    const lastMsg = messages[messages.length - 1]
    if (lastMsg?.id !== lastMessageIdRef.current) {
      lastMessageIdRef.current = lastMsg?.id || null
      // Use setTimeout to ensure DOM is updated
      setTimeout(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
      }, 100)
    }
  }, [messages])
  const handleSendRequest = async () => {
    try {
      const res = await fetch('/api/friends/requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: addFriendEmail })
      })
      const data = await res.json()
      if (res.ok) {
        toast.success(data.message || "请求已发送")
        setAddFriendEmail("")
        setIsAddFriendOpen(false)
        fetchData()
      } else {
        toast.error(data.error || "发送请求失败")
      }
    } catch (error) {
      toast.error("发送请求失败")
    }
  }
  const handleRespondRequest = async (requestId: number, action: 'accept' | 'reject') => {
    try {
      const res = await fetch('/api/friends/respond', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ requestId, action })
      })
      if (res.ok) {
        toast.success(action === 'accept' ? "已接受好友请求" : "已拒绝好友请求")
        fetchData()
      }
    } catch (error) {
      console.error("Failed to respond", error)
    }
  }
  const handleCreateGroup = async () => {
    if (!newGroupName.trim()) {
      toast.error("请输入群组名称")
      return
    }
    try {
      const res = await fetch('/api/groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: newGroupName,
          members: selectedFriends
        })
      })
      const data = await res.json()
      if (res.ok) {
        toast.success("群组创建成功")
        setNewGroupName("")
        setSelectedFriends([])
        setIsCreateGroupOpen(false)
        fetchData()
      } else {
        toast.error(data.error || "创建群组失败")
      }
    } catch (error) {
      toast.error("创建群组失败")
    }
  }
  const handleSendMessage = async (contentOverride?: string, type: 'text' | 'image' | 'audio' | 'file' = 'text', fileUrl?: string) => {
    const contentToSend = contentOverride || inputValue
    if (!contentToSend.trim() && type === 'text') return
    if (!activeFriend && !activeGroup) return
    try {
      let url = ''
      let body: any = {}
      if (activeFriend) {
        url = '/api/direct-messages'
        body = { friendId: activeFriend.id, content: contentToSend, type, fileUrl }
      } else if (activeGroup) {
        url = '/api/groups/messages'
        body = { groupId: activeGroup.id, content: contentToSend, type, fileUrl }
      }
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      if (res.ok) {
        if (type === 'text') setInputValue("")
        await fetchMessages()
        // Refresh lists to show new message in sidebar
        fetchFriends()
        fetchUserGroups()
      } else {
        toast.error("Failed to send message")
      }
    } catch (error) {
      toast.error("Error sending message")
    }
  }
  const uploadFile = async (file: File) => {
    const formData = new FormData()
    formData.append('file', file)
    try {
        const res = await fetch('/api/chat/upload', {
            method: 'POST',
            body: formData
        })
        const data = await res.json()
        if (data.success) {
             const type = file.type.startsWith('image/') ? 'image' : 'audio'
             const content = type === 'image' ? '[图片]' : '[语音]'
             await handleSendMessage(content, type, data.url)
        } else {
            console.error("Upload error:", data.error)
            toast.error(data.error || "Upload failed")
        }
    } catch (error) {
        console.error("Upload exception:", error)
        toast.error("Upload failed")
    }
  }
  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    await uploadFile(file)
    if (fileInputRef.current) fileInputRef.current.value = ''
  }
  const handlePaste = useCallback((e: React.ClipboardEvent) => {
    const items = e.clipboardData?.items
    if (!items) return
    for (const item of items) {
      if (item.type.startsWith('image/')) {
        const file = item.getAsFile()
        if (file) {
          uploadFile(file)
          e.preventDefault() // Prevent default paste behavior
        }
      }
    }
  }, [handleSendMessage])
  const handleBlockUser = async (userId: number, block: boolean) => {
    try {
      const res = await fetch('/api/users/block', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ friendId: userId, block })
      })
      const data = await res.json()
      if (res.ok) {
        toast.success(data.message)
        fetchFriends()
        if (activeFriend && activeFriend.id === userId) {
            setActiveFriend({ ...activeFriend, is_blocked: block })
        }
      } else {
        toast.error(data.error || "更新拉黑状态失败")
      }
    } catch (error) {
      toast.error("拉黑/取消拉黑用户失败")
    }
  }
  const handleToggleMute = async (groupId: number, userId: number, mute: boolean) => {
    try {
      const res = await fetch('/api/groups/members', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          groupId,
          userId,
          action: mute ? 'mute' : 'unmute'
        })
      })
      const data = await res.json()
      if (res.ok) {
        toast.success(data.message)
        // Refresh members
        const membersRes = await fetch(`/api/groups/members?groupId=${groupId}`)
        const membersData = await membersRes.json()
        if (membersData.members) setGroupMembers(membersData.members)
      } else {
        toast.error(data.error || "更新禁言状态失败")
      }
    } catch (error) {
      toast.error("更新禁言状态失败")
    }
  }
  const toggleFriendSelection = (friendId: number) => {
    setSelectedFriends(prev =>
      prev.includes(friendId)
        ? prev.filter(id => id !== friendId)
        : [...prev, friendId]
    )
  }
  const switchToFriend = (friend: User) => {
    setActiveFriend(friend)
    setActiveGroup(null)
  }
  const switchToGroup = (group: Group) => {
    setActiveGroup(group)
    setActiveFriend(null)
  }
  return (
    <div className="min-h-screen w-screen h-screen bg-background text-foreground transition-colors duration-500 overflow-hidden">
      <UpdateAnnouncement />
      {/* Background Gradients */}
      {/* Removed for cleaner look */}
      <div className="relative z-10 flex flex-col h-full w-full">
        {/* Header - Kept global header but made it white/clean */}
        {!isMobile && (
        <div className="relative flex items-center px-8 border-b border-border/10 bg-background z-20 h-[72px] shrink-0">
          <div className="flex items-center gap-4">
            <div className="relative size-12">
              <Image src="/logo.svg" alt="logo" fill className="object-contain" />
            </div>
            <div className="leading-tight">
              <div className="text-base font-bold tracking-wide">STRAVISION</div>
              <div className="text-xs text-muted-foreground">莓界 · 智慧农业平台</div>
            </div>
          </div>
          <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
            <PageNavigation />
          </div>
          <div className="ml-auto flex items-center gap-3">
            <ModeToggle />
            {currentUser && <UserAvatarMenu user={currentUser as any} />}
          </div>
        </div>
        )}
        {/* Main Content - 3 Column Layout Simulation */}
        <div className="flex-1 overflow-hidden bg-background relative">
          <div className="flex h-full w-full max-w-[1600px] mx-auto">
            {/* Middle Column: Message List */}
            <div className={cn(
              "w-full md:w-[400px] flex flex-col h-full border-r border-border/10 bg-background",
              isMobile && (activeFriend || activeGroup) ? "hidden" : "flex"
            )}>
              {isMobile ? (
                 <div className="px-4 py-3 flex flex-col gap-3 border-b border-border/5 bg-background sticky top-0 z-10">
                    <div className="flex items-center justify-between">
                        <Avatar className="h-9 w-9">
                            <AvatarImage src={currentUser?.avatar_url || undefined} />
                            <AvatarFallback>{currentUser?.username?.[0]}</AvatarFallback>
                        </Avatar>
                        <div className="flex bg-slate-100 dark:bg-slate-800 rounded-full p-1 relative scale-90">
                            <button
                                onClick={() => setViewMode('messages')}
                                className={cn(
                                    "px-6 py-2 rounded-full text-sm font-semibold transition-all duration-300 z-10",
                                    viewMode === 'messages' ? "bg-blue-600 text-white shadow-md" : "text-slate-500 hover:text-slate-700"
                                )}
                            >
                                Message
                            </button>
                            <button
                                onClick={() => setViewMode('groups')}
                                className={cn(
                                    "px-6 py-2 rounded-full text-sm font-semibold transition-all duration-300 z-10",
                                    viewMode === 'groups' ? "bg-blue-600 text-white shadow-md" : "text-slate-500 hover:text-slate-700"
                                )}
                            >
                                Group
                            </button>
                        </div>
                        <div className="flex items-center gap-1">
                            <Dialog open={isAddFriendOpen} onOpenChange={setIsAddFriendOpen}>
                                <DialogTrigger asChild>
                                    <Button size="icon" variant="ghost" className="h-9 w-9 rounded-full">
                                        <Plus className="h-5 w-5 text-slate-600" />
                                    </Button>
                                </DialogTrigger>
                                <DialogContent>
                                    <DialogHeader>
                                        <DialogTitle>添加好友</DialogTitle>
                                    </DialogHeader>
                                    <div className="flex gap-2 mt-4">
                                        <Input
                                            placeholder="邮箱..."
                                            value={addFriendEmail}
                                            onChange={(e) => setAddFriendEmail(e.target.value)}
                                        />
                                        <Button onClick={handleSendRequest}>发送请求</Button>
                                    </div>
                                </DialogContent>
                            </Dialog>
                            <Button size="icon" variant="ghost" className="rounded-full h-9 w-9">
                                <Bell className="h-5 w-5 text-slate-600" />
                            </Button>
                        </div>
                    </div>
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                        <Input
                            placeholder="搜索好友或群组"
                            className="pl-9 bg-slate-100 dark:bg-slate-800 border-none rounded-xl h-10"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                 </div>
              ) : (
              <div className="px-6 py-6 flex flex-col gap-6">
                <div className="flex items-center justify-between">
                    <h1 className="text-2xl font-bold text-blue-600 dark:text-blue-400">消息</h1>
                    <div className="flex gap-2">
                         <Dialog open={isCreateGroupOpen} onOpenChange={setIsCreateGroupOpen}>
                            <DialogTrigger asChild>
                                <Button size="icon" variant="ghost" className="h-10 w-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500">
                                    <Edit className="h-5 w-5" />
                                </Button>
                            </DialogTrigger>
                            <DialogContent>
                                <DialogHeader>
                                    <DialogTitle>创建群组</DialogTitle>
                                </DialogHeader>
                                <div className="flex flex-col gap-4 mt-4">
                                    <div className="space-y-2">
                                        <Label>群组名称</Label>
                                        <Input
                                            placeholder="群组名称..."
                                            value={newGroupName}
                                            onChange={(e) => setNewGroupName(e.target.value)}
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <Label>选择成员</Label>
                                        <ScrollArea className="h-48 border rounded-md p-2">
                                            <div className="space-y-2">
                                                {friends.map(friend => (
                                                    <div key={friend.id} className="flex items-center space-x-2">
                                                        <Checkbox
                                                            id={`friend-${friend.id}`}
                                                            checked={selectedFriends.includes(friend.id)}
                                                            onCheckedChange={() => toggleFriendSelection(friend.id)}
                                                        />
                                                        <Label htmlFor={`friend-${friend.id}`} className="flex-1 cursor-pointer flex items-center gap-2">
                                                            <Avatar className="h-6 w-6">
                                                                <AvatarImage src={friend.avatar_url || undefined} />
                                                                <AvatarFallback>{friend.username[0]}</AvatarFallback>
                                                            </Avatar>
                                                            {friend.username}
                                                        </Label>
                                                    </div>
                                                ))}
                                            </div>
                                        </ScrollArea>
                                    </div>
                                    <Button onClick={handleCreateGroup}>创建</Button>
                                </div>
                            </DialogContent>
                        </Dialog>
                        <Button size="icon" variant="ghost" className="h-10 w-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500" onClick={() => document.getElementById('search-input')?.focus()}>
                            <Search className="h-5 w-5" />
                        </Button>
                        <Dialog open={isAddFriendOpen} onOpenChange={setIsAddFriendOpen}>
                            <DialogTrigger asChild>
                                <Button size="icon" variant="ghost" className="h-10 w-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500">
                                    <Plus className="h-5 w-5" />
                                </Button>
                            </DialogTrigger>
                            <DialogContent>
                                <DialogHeader>
                                    <DialogTitle>添加好友</DialogTitle>
                                </DialogHeader>
                                <div className="flex gap-2 mt-4">
                                    <Input
                                        placeholder="邮箱..."
                                        value={addFriendEmail}
                                        onChange={(e) => setAddFriendEmail(e.target.value)}
                                    />
                                    <Button onClick={handleSendRequest}>发送请求</Button>
                                </div>
                            </DialogContent>
                        </Dialog>
                    </div>
                </div>
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                    <Input
                        id="search-input"
                        placeholder="搜索好友或群组"
                        className="pl-9 bg-slate-100 dark:bg-slate-800 border-none rounded-full"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
              </div>
              )}
              <ScrollArea className="flex-1 px-4">
                <div className={cn("space-y-6", isMobile ? "pb-24" : "pb-4")}>
                    {/* Groups Section */}
                    {(!isMobile || viewMode === 'groups') && filteredGroups.length > 0 && (
                        <div className="space-y-2">
                            {!isMobile && (
                            <div className="flex items-center gap-2 text-xs font-semibold text-slate-400 uppercase tracking-wider px-2">
                                <MapPin className="h-3 w-3" /> 群组
                            </div>
                            )}
                            <div className="space-y-1">
                                {filteredGroups.map(group => (
                                    <button
                                        key={group.id}
                                        onClick={() => switchToGroup(group)}
                                        className={cn(
                                            "w-full flex items-center gap-4 p-3 rounded-2xl text-left transition-all duration-200",
                                            isMobile
                                              ? "bg-white dark:bg-slate-900 shadow-sm border border-slate-100 dark:border-slate-800 mb-3"
                                              : (activeGroup?.id === group.id ? "bg-slate-100 dark:bg-slate-800" : "hover:bg-slate-50 dark:hover:bg-slate-900")
                                        )}
                                    >
                                        <div className="relative">
                                            <Avatar className="h-12 w-12 border border-slate-100 dark:border-slate-800">
                                                <AvatarImage src={group.avatar_url || undefined} />
                                                <AvatarFallback className="bg-orange-100 text-orange-600 font-bold">
                                                    {group.name[0].toUpperCase()}
                                                </AvatarFallback>
                                            </Avatar>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-baseline mb-1">
                                                <span className="font-bold text-slate-900 dark:text-slate-100 truncate">{group.name}</span>
                                                <span className="text-xs text-slate-400">
                                                    {group.last_message ? formatTime(group.last_message.created_at) : ''}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm text-slate-500 truncate block max-w-[180px]">
                                                    {group.last_message ? group.last_message.content : "暂无消息"}
                                                </span>
                                                {group.unread_count ? (
                                                    <Badge variant="destructive" className="h-5 w-5 rounded-full p-0 flex items-center justify-center text-[10px]">
                                                        {group.unread_count}
                                                    </Badge>
                                                ) : null}
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    {/* Friend Requests Section */}
                    {(!isMobile || viewMode === 'messages') && requests.length > 0 && (
                        <div className="space-y-2 mb-6">
                            {!isMobile && (
                            <div className="flex items-center gap-2 text-xs font-semibold text-slate-400 uppercase tracking-wider px-2">
                                <UserPlus className="h-3 w-3" /> 好友请求
                            </div>
                            )}
                            <div className="space-y-1">
                                {requests.map(req => (
                                    <div key={req.id} className="w-full flex items-center gap-3 p-3 rounded-2xl bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-800">
                                        <Avatar className="h-10 w-10 border border-slate-200 dark:border-slate-700">
                                            <AvatarImage src={req.requester.avatar_url || undefined} />
                                            <AvatarFallback>{req.requester.username[0]}</AvatarFallback>
                                        </Avatar>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-sm text-slate-900 dark:text-slate-100 truncate">{req.requester.username}</div>
                                            <div className="text-xs text-slate-500">请求添加好友</div>
                                        </div>
                                        <div className="flex gap-1">
                                            <Button size="icon" variant="ghost" className="h-8 w-8 rounded-full text-green-500 hover:bg-green-100 dark:hover:bg-green-900/20" onClick={() => handleRespondRequest(req.id, 'accept')}>
                                                <Check className="h-4 w-4" />
                                            </Button>
                                            <Button size="icon" variant="ghost" className="h-8 w-8 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-red-900/20" onClick={() => handleRespondRequest(req.id, 'reject')}>
                                                <X className="h-4 w-4" />
                                            </Button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {/* All Messages Section (Friends) */}
                    {(!isMobile || viewMode === 'messages') && (
                    <div className="space-y-2">
                        {!isMobile && (
                        <div className="flex items-center gap-2 text-xs font-semibold text-slate-400 uppercase tracking-wider px-2">
                            <MessageSquare className="h-3 w-3" /> 全部消息
                        </div>
                        )}
                        <div className="space-y-1">
                            {filteredFriends.map(friend => (
                                <button
                                    key={friend.id}
                                    onClick={() => switchToFriend(friend)}
                                    className={cn(
                                        "w-full flex items-center gap-4 p-3 rounded-2xl text-left transition-all duration-200",
                                        isMobile
                                          ? "bg-white dark:bg-slate-900 shadow-sm border border-slate-100 dark:border-slate-800 mb-3"
                                          : (activeFriend?.id === friend.id ? "bg-slate-100 dark:bg-slate-800" : "hover:bg-slate-50 dark:hover:bg-slate-900")
                                    )}
                                >
                                    <div className="relative">
                                        <Avatar className="h-12 w-12 border border-slate-100 dark:border-slate-800">
                                            <AvatarImage src={friend.avatar_url || undefined} />
                                            <AvatarFallback className="bg-blue-100 text-blue-600 font-bold">
                                                {friend.username[0].toUpperCase()}
                                            </AvatarFallback>
                                        </Avatar>
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-baseline mb-1">
                                            <span className="font-bold text-slate-900 dark:text-slate-100 truncate">{friend.username}</span>
                                            <span className="text-xs text-slate-400">
                                                {friend.last_message ? formatTime(friend.last_message.created_at) : ''}
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-slate-500 truncate block max-w-[180px]">
                                                {friend.last_message ? friend.last_message.content : friend.email}
                                            </span>
                                            {friend.unread_count ? (
                                                <Badge variant="destructive" className="h-5 w-5 rounded-full p-0 flex items-center justify-center text-[10px]">
                                                    {friend.unread_count}
                                                </Badge>
                                            ) : null}
                                        </div>
                                    </div>
                                </button>
                            ))}
                            {filteredFriends.length === 0 && (
                                <div className="text-center text-sm text-muted-foreground py-8">
                                    暂无好友
                                </div>
                            )}
                        </div>
                    </div>
                    )}
                    {/* Bottom Encryption Note for Mobile */}
                    {isMobile && (
                        <div className="text-center text-[10px] text-slate-400 mt-8 mb-4">
                            Your personal messages are <span className="text-blue-500 font-medium">end-to-end-encrypted</span>
                        </div>
                    )}
                </div>
              </ScrollArea>
            </div>
            {/* Chat Area */}
            <div className={cn(
              "flex-1 flex flex-col bg-background transition-all duration-300",
              isMobile && (!activeFriend && !activeGroup) ? "hidden" : "flex"
            )}>
              {(activeFriend || activeGroup) ? (
                <>
                  <div className={cn(
                    "px-6 py-4 border-b border-border/10 flex items-center justify-between bg-background sticky top-0 z-10",
                    isMobile ? "px-4 py-2 border-none shadow-sm" : ""
                  )}>
                    <div className="flex items-center gap-4">
                      {isMobile && (
                        <Button variant="ghost" size="icon" className="-ml-2 h-8 w-8" onClick={() => { setActiveFriend(null); setActiveGroup(null); }}>
                          <ChevronLeft className="h-6 w-6" />
                        </Button>
                      )}
                      <Avatar className="h-10 w-10">
                        {activeFriend ? (
                          <>
                            <AvatarImage src={activeFriend.avatar_url || undefined} />
                            <AvatarFallback className="bg-blue-100 text-blue-600 font-bold">{activeFriend.username[0]}</AvatarFallback>
                          </>
                        ) : (
                          <>
                            <AvatarImage src={activeGroup?.avatar_url || undefined} />
                            <AvatarFallback className="bg-orange-100 text-orange-600 font-bold">
                              {activeGroup?.name[0]}
                            </AvatarFallback>
                          </>
                        )}
                      </Avatar>
                      <div>
                        <div className="text-lg font-bold text-slate-900 dark:text-slate-100 leading-tight">
                          {activeFriend ? activeFriend.username : activeGroup?.name}
                        </div>
                        <div className="text-xs text-slate-500 font-medium animate-pulse">
                          {isTyping ? '正在输入...' : (
                              activeFriend ? <span className="text-green-500">Online</span> : `${groupMembers.length} 成员`
                          )}
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-4 text-slate-400">
                       <Button variant="ghost" size="icon" className="h-10 w-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => toast.info("Video call coming soon!")}>
                          <Video className="h-5 w-5" />
                       </Button>
                       <Button variant="ghost" size="icon" className="h-10 w-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => toast.info("Voice call coming soon!")}>
                          <Phone className="h-5 w-5" />
                       </Button>
                       {!isMobile && (
                       <Button variant="ghost" size="icon" className="h-10 w-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => setShowChatDetails(!showChatDetails)}>
                          <MoreVertical className="h-5 w-5" />
                       </Button>
                       )}
                    </div>
                  </div>
                  <div className="flex-1 flex flex-col overflow-hidden relative">
                    <ScrollArea className="flex-1 p-6">
                      <div className="flex flex-col gap-6 min-h-0">
                         {messages.map((msg, index) => {
                           const isMe = msg.sender_id === currentUser?.id
                           const sender = isMe ? currentUser : (activeFriend || groupMembers.find(m => m.user_id === msg.sender_id)?.user)
                           // Date separator logic
                           const showDateSeparator = index === 0 || new Date(msg.created_at).toDateString() !== new Date(messages[index - 1].created_at).toDateString()
                           return (
                             <div key={msg.id} className="flex flex-col gap-4">
                                {showDateSeparator && (
                                    <div className="flex justify-center my-2">
                                        <span className="text-xs text-slate-400 font-medium bg-slate-50 dark:bg-slate-900 px-3 py-1 rounded-full">
                                            {new Date(msg.created_at).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}
                                        </span>
                                    </div>
                                )}
                                <div className={cn("flex w-full gap-3", isMe ? "flex-row-reverse" : "flex-row")}>
                                   {!isMe && (
                                       <Avatar className="h-8 w-8 mt-1 flex-shrink-0">
                                          <AvatarImage src={sender?.avatar_url || undefined} />
                                          <AvatarFallback>{sender?.username?.[0]}</AvatarFallback>
                                       </Avatar>
                                   )}
                                   <div className={cn("flex flex-col max-w-[75%]", isMe ? "items-end" : "items-start")}>
                                     {!isMe && activeGroup && <span className="text-xs text-slate-500 ml-1 mb-1">{sender?.username}</span>}
                                     <div className={cn(
                                      "relative px-4 py-3 text-[15px] leading-relaxed shadow-sm min-w-[80px]",
                                      isMe
                                        ? "bg-blue-600 text-white rounded-2xl rounded-tr-sm"
                                        : "bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-100 dark:border-slate-700 rounded-2xl rounded-tl-sm"
                                    )}>
                                      {msg.type === 'image' ? (
                                          <img src={msg.file_url || msg.content} alt="Image" className="max-w-full rounded-lg" />
                                      ) : msg.type === 'audio' ? (
                                          <audio controls src={msg.file_url || msg.content} className="max-w-full" />
                                      ) : (
                                          <div className="whitespace-pre-wrap break-words">{msg.content}</div>
                                      )}
                                      <div className={cn("flex items-center gap-1 mt-1 text-[10px]", isMe ? "text-blue-100 justify-end" : "text-slate-400")}>
                                          <span>{formatTime(msg.created_at)}</span>
                                          {isMe && <CheckCheck className="h-3 w-3" />}
                                      </div>
                                    </div>
                                   </div>
                                 </div>
                             </div>
                           )
                         })}
                         <div ref={messagesEndRef} />
                      </div>
                    </ScrollArea>
                    <div className={cn("bg-background sticky bottom-0 z-10", isMobile ? "p-3" : "p-6")}>
                      <form
                        onSubmit={(e) => { e.preventDefault(); handleSendMessage(); }}
                        className="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-2 rounded-full shadow-sm"
                      >
                        <Button
                            type="button"
                            size="icon"
                            variant="ghost"
                            onClick={isRecording ? stopRecording : startRecording}
                            className={cn(
                                "h-10 w-10 rounded-full transition-colors",
                                isRecording ? "text-red-500 bg-red-50 hover:bg-red-100 animate-pulse" : "text-slate-400 hover:text-slate-600 hover:bg-slate-200/50"
                            )}
                        >
                            <Mic className="h-5 w-5" />
                        </Button>
                        <Input
                          value={inputValue}
                        onChange={handleInputChange}
                        onPaste={handlePaste}
                        placeholder={isRecording ? "正在录音..." : "输入消息..."}
                          disabled={isRecording}
                          className="flex-1 bg-transparent border-none shadow-none focus-visible:ring-0 text-base"
                        />
                        <input
                            type="file"
                            accept="image/*,audio/*"
                            className="hidden"
                            ref={fileInputRef}
                            onChange={handleFileUpload}
                        />
                        <Button
                            type="button"
                            size="icon"
                            variant="ghost"
                            className="h-10 w-10 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-200/50"
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <ImageIcon className="h-5 w-5" />
                        </Button>
                        <Popover>
                            <PopoverTrigger asChild>
                                <Button type="button" size="icon" variant="ghost" className="h-10 w-10 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-200/50">
                                    <Smile className="h-5 w-5" />
                                </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-64 p-2" align="end">
                                <div className="grid grid-cols-5 gap-2">
                                    {emojis.map(emoji => (
                                        <button
                                            key={emoji}
                                            type="button"
                                            className="text-2xl hover:bg-slate-100 p-2 rounded"
                                            onClick={() => setInputValue(prev => prev + emoji)}
                                        >
                                            {emoji}
                                        </button>
                                    ))}
                                </div>
                            </PopoverContent>
                        </Popover>
                        <Button type="submit" size="icon" disabled={!inputValue.trim() && !isRecording} className="h-10 w-10 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-md transition-all duration-300 hover:scale-105 active:scale-95 ml-1">
                          <Send className="h-4 w-4" />
                        </Button>
                      </form>
                    </div>
                  </div>
                </>
              ) : (
                <div className="flex-1 flex flex-col items-center justify-center text-muted-foreground">
                  <div className="h-24 w-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 animate-[pulse_4s_ease-in-out_infinite]">
                    <MessageSquare className="h-12 w-12 text-blue-500" />
                  </div>
                  <p className="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">欢迎使用消息</p>
                  <p className="text-slate-500">选择一个聊天开始发送消息</p>
                </div>
              )}
            </div>
            {/* Right Sidebar - Info Panel */}
            <div className={cn(
              "w-80 flex-col h-full bg-background border-l border-border/10 transition-all duration-300 hidden md:flex shrink-0",
              showChatDetails ? "w-80 opacity-100" : "w-0 opacity-0 overflow-hidden"
            )}>
               <div className="px-6 py-6 border-b border-border/10">
                  <h2 className="text-xl font-bold text-slate-900 dark:text-slate-100">详情</h2>
               </div>
               <ScrollArea className="flex-1 p-6">
                  {activeFriend && (
                    <div className="flex flex-col items-center gap-4 py-8">
                       <Avatar className="h-24 w-24 border-4 border-slate-50 dark:border-slate-800">
                          <AvatarImage src={activeFriend.avatar_url || undefined} />
                          <AvatarFallback className="text-2xl bg-blue-100 text-blue-600 font-bold">{activeFriend.username[0].toUpperCase()}</AvatarFallback>
                       </Avatar>
                       <div className="text-center w-full px-2">
                          <h3 className="text-xl font-bold text-slate-900 dark:text-slate-100 truncate">{activeFriend.username}</h3>
                          <p className="text-sm text-slate-500 break-all">{activeFriend.email}</p>
                       </div>
                       <div className="w-full mt-8 space-y-3">
                          <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 space-y-2">
                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">选项</h4>
                            <Button variant="ghost" className="w-full justify-start text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 h-12 rounded-xl" onClick={() => handleBlockUser(activeFriend.id, !activeFriend.is_blocked)}>
                              {activeFriend.is_blocked ? <ShieldOff className="mr-3 h-5 w-5" /> : <Shield className="mr-3 h-5 w-5" />}
                              {activeFriend.is_blocked ? "解除拉黑" : "拉黑用户"}
                            </Button>
                            <Button variant="ghost" className="w-full justify-start text-orange-500 hover:text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/10 h-12 rounded-xl" onClick={() => handleClearHistory(activeFriend.id)}>
                              <Trash2 className="mr-3 h-5 w-5" />
                              清空聊天记录
                            </Button>
                          </div>
                       </div>
                    </div>
                  )}
                  {activeGroup && (
                    <div className="space-y-6">
                       <div className="flex flex-col items-center gap-4 py-6">
                          <Avatar className="h-24 w-24 border-4 border-slate-50 dark:border-slate-800">
                             <AvatarImage src={activeGroup.avatar_url || undefined} />
                             <AvatarFallback className="text-2xl bg-orange-100 text-orange-600 font-bold">{activeGroup.name[0].toUpperCase()}</AvatarFallback>
                          </Avatar>
                          <div className="text-center">
                             <h3 className="text-xl font-bold text-slate-900 dark:text-slate-100">{activeGroup.name}</h3>
                             <p className="text-sm text-slate-500">{groupMembers.length} 成员</p>
                          </div>
                       </div>
                       <div>
                          <div className="flex items-center justify-between mb-4">
                              <h4 className="text-sm font-bold text-slate-900 dark:text-slate-100">成员</h4>
                              <span className="text-xs text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full">{groupMembers.length}</span>
                          </div>
                          <div className="space-y-2">
                              {groupMembers.map(member => {
                                const isMe = member.user_id === currentUser?.id
                                const isSystemAdmin = currentUser?.role === 'admin' || currentUser?.role === 'super_admin'
                                const myMemberRecord = groupMembers.find(m => m.user_id === currentUser?.id)
                                const isGroupAdmin = myMemberRecord?.role === 'owner' || myMemberRecord?.role === 'admin'
                                const canManage = isSystemAdmin || isGroupAdmin
                                const targetIsAdmin = member.user.role === 'admin' || member.user.role === 'super_admin'
                                const showMuteButton = canManage && !isMe && !targetIsAdmin
                                return (
                                  <div key={member.user_id} className="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-900 transition-colors">
                                    <div className="flex items-center gap-3 overflow-hidden">
                                      <Avatar className="h-10 w-10 shrink-0">
                                        <AvatarImage src={member.user.avatar_url || undefined} />
                                        <AvatarFallback className="bg-slate-200 text-slate-600 font-bold">{member.user.username[0]}</AvatarFallback>
                                      </Avatar>
                                      <div className="overflow-hidden">
                                        <div className="text-sm font-bold text-slate-900 dark:text-slate-100 truncate flex items-center gap-1">
                                          {member.user.username}
                                          {member.role === 'owner' && <Badge variant="secondary" className="h-5 px-2 text-[10px] bg-orange-100 text-orange-600 hover:bg-orange-200">群主</Badge>}
                                        </div>
                                      </div>
                                    </div>
                                    {showMuteButton && (
                                       <Button
                                          variant="ghost"
                                          size="icon"
                                          className={cn("h-8 w-8 rounded-full", member.is_muted ? "text-red-500 bg-red-50" : "text-slate-400 hover:text-slate-600")}
                                          onClick={() => handleToggleMute(activeGroup.id, member.user_id, !member.is_muted)}
                                       >
                                          {member.is_muted ? <VolumeX className="h-4 w-4" /> : <Volume2 className="h-4 w-4" />}
                                       </Button>
                                    )}
                                  </div>
                                )
                              })}
                          </div>
                       </div>
                       <Button variant="outline" className="w-full justify-start text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 border-red-200 dark:border-red-900/30 h-12 rounded-xl font-medium">
                          <LogOut className="mr-3 h-5 w-5" />
                          退出群组
                       </Button>
                    </div>
                  )}
               </ScrollArea>
            </div>
          </div>
        </div>
        {isMobile && !activeFriend && !activeGroup && (
           <MobileBottomNav />
        )}
      </div>
    </div>
  )
}

--- FILE: app\dashboard\page.tsx ---

"use client"
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import Image from "next/image"
import { PageNavigation } from "@/components/page-navigation"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import { Edit, Save, Wifi, WifiOff, Droplets, Sun, Wind, Leaf } from "lucide-react"
import { Button } from "@/components/ui/button"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { useRouter } from "next/navigation"
import type { UserPublic } from "@/lib/db/user-service"
import { useState, useEffect } from "react"
import GridLayout, { Layout } from "react-grid-layout"
import "react-grid-layout/css/styles.css"
import "react-resizable/css/styles.css"
import { DashboardChartCard } from "@/components/dashboard/DashboardChartCard"
import { SpectralCard } from "@/components/dashboard/spectral-card"
import { IntroDisclosure } from "@/components/ui/intro-disclosure"
const tourSteps = [
  {
    title: "欢迎使用 Stravision",
    short_description: "开启智慧农业新篇章",
    full_description: "Stravision 是您的全栈式智慧农业管理平台。通过融合物联网与人工智能技术，我们为您提供精准的环境监测、智能决策支持和自动化的设备控制。让我们花一分钟了解核心功能。",
    media: {
      type: "image" as const,
      src: "/tour/starter.png",
      alt: "Welcome to Stravision",
    },
  },
  {
    title: "实时环境监测",
    short_description: "全维度的生长环境数据",
    full_description: "仪表盘实时展示空气温湿度、光照、CO2 以及土壤 NPK 等关键指标。数据实时更新，图表清晰直观，帮助您随时掌握作物生长环境。",
    media: {
      type: "video" as const,
      src: "/tour/dashboard.mp4",
      alt: "Dashboard Monitoring",
    },
  },
  {
    title: "自定义布局",
    short_description: "打造您的专属工作台",
    full_description: "点击右上角的'编辑'按钮，您可以自由拖拽、调整各个数据卡片的大小和位置。无论是重点关注光照还是土壤肥力，都能随心定制。",
    media: {
      type: "video" as const,
      src: "/tour/editLayer.mp4",
      alt: "Custom Layout",
    },
  },
  {
    title: "AI 种植顾问",
    short_description: "基于 RAG 技术的智能专家",
    full_description: "遇到种植难题？随时点击顶部的'AI 助手'。无论是病害诊断还是种植建议，我们的 AI 专家都能基于权威知识库为您提供精准解答。",
    media: {
      type: "video" as const,
      src: "/tour/ai.mp4",
      alt: "AI Assistant",
    },
  },
  {
    title: "开始探索",
    short_description: "立即体验智慧种植",
    full_description: "您已经准备好开始使用了！如果需要再次查看此教程，可以在设置中重新开启。现在，尽情探索 Stravision 的强大功能吧。",
    action: {
      label: "开始使用",
      onClick: () => {},
    },
  },
]
export default function DashboardPage() {
  const router = useRouter()
  const [isTourOpen, setIsTourOpen] = useState(false)
  // Check if tour should be shown
  useEffect(() => {
    // We can use a slight delay to ensure the UI is loaded
    const timer = setTimeout(() => {
        // The IntroDisclosure component handles localStorage checking internally via featureId
        // But we need to default 'open' to true initially to let the component decide based on storage
        setIsTourOpen(true)
    }, 1000)
    return () => clearTimeout(timer)
  }, [])
  // User authentication state
  const [currentUser, setCurrentUser] = useState<UserPublic | null>(null)
  const [isLoadingUser, setIsLoadingUser] = useState(true)
  // Connect to SSE for real-time device data
  const { deviceData, connectionStatus } = useDeviceData()
  // Use shared weather data from context
  const { weatherData } = useWeatherContext()
  // Batched history data fetching for optimization
  const [historyDataMap, setHistoryDataMap] = useState<Record<string, any[]>>({})
  useEffect(() => {
    const fetchAllHistory = async () => {
        try {
            // List of all types used in the dashboard
            const types = [
                'humidity', 'temperature', 'light', 'co2',
                'soilMoisture', 'fertility', 'nitrogen',
                'phosphorus', 'potassium', 'rainfall'
            ].join(',')
            const res = await fetch(`/api/device-history?types=${types}&range=1h`)
            const data = await res.json()
            if (data.success) {
                setHistoryDataMap(data.data)
            }
        } catch (e) {
            console.error("Failed to fetch dashboard history:", e)
        }
    }
    fetchAllHistory()
  }, [])
  const defaultLayout = [
    { i: "humidity", x: 0, y: 0, w: 3, h: 2 },
    { i: "temperature", x: 3, y: 0, w: 3, h: 2 },
    { i: "light", x: 6, y: 0, w: 3, h: 2 },
    { i: "co2", x: 9, y: 0, w: 3, h: 2 },
    { i: "soilMoisture", x: 0, y: 2, w: 3, h: 2 },
    { i: "fertility", x: 3, y: 2, w: 3, h: 2 },
    { i: "nitrogen", x: 6, y: 2, w: 3, h: 2 },
    { i: "phosphorus", x: 9, y: 2, w: 3, h: 2 },
    { i: "potassium", x: 0, y: 4, w: 3, h: 2 },
    { i: "spectral", x: 3, y: 4, w: 6, h: 2 },
    { i: "rainfall", x: 9, y: 4, w: 3, h: 2 },
  ]
  const [layout, setLayout] = useState(defaultLayout)
  const [isEditMode, setIsEditMode] = useState(false)
  // Fetch current user on mount
  useEffect(() => {
    const fetchCurrentUser = async () => {
      try {
        const response = await fetch("/api/auth/me")
        const data = await response.json()
        if (data.authenticated && data.user) {
          setCurrentUser(data.user)
        } else {
          router.push("/login")
        }
      } catch (error) {
        console.error("获取用户信息失败:", error)
        router.push("/login")
      } finally {
        setIsLoadingUser(false)
      }
    }
    fetchCurrentUser()
  }, [router])
  // 从 localStorage 加载布局
  useEffect(() => {
    const savedLayout = localStorage.getItem('dashboard-layout')
    if (savedLayout) {
      try {
        setLayout(JSON.parse(savedLayout))
      } catch (e) {
        console.error('Failed to load layout:', e)
      }
    }
  }, [])
  const onLayoutChange = (newLayout: Layout[]) => {
    if (isEditMode) {
      setLayout(newLayout)
    }
  }
  const handleSaveLayout = () => {
    localStorage.setItem('dashboard-layout', JSON.stringify(layout))
    setIsEditMode(false)
    alert('布局已保存！')
  }
  const handleEditMode = () => {
    setIsEditMode(!isEditMode)
  }
  // Show loading state while checking authentication
  if (isLoadingUser) {
    return (
      <div className="min-h-screen w-screen h-screen bg-background text-foreground flex items-center justify-center">
        <div className="text-muted-foreground">加载中...</div>
      </div>
    )
  }
  // Don't render page if no user (will redirect)
  if (!currentUser) {
    return null
  }
  return (
    <>
      <style jsx global>{`
        @keyframes rain-dashboard {
          0% { transform: translateY(-100%); opacity: 0; }
          10% { opacity: 0.4; }
          90% { opacity: 0.4; }
          100% { transform: translateY(300%); opacity: 0; }
        }
        @keyframes fade-in-dashboard {
          from { opacity: 0; transform: scale(0.9); }
          to { opacity: 1; transform: scale(1); }
        }
        @keyframes grow-bar {
          from { transform: scaleY(0); transform-origin: bottom; }
          to { transform: scaleY(1); transform-origin: bottom; }
        }
        .animate-rain-dashboard { animation: rain-dashboard 1.2s linear infinite; }
        .animate-fade-in-dashboard { animation: fade-in-dashboard 0.6s ease-out; }
        .animate-grow-bar { animation: grow-bar 0.8s ease-out; }
      `}</style>
      <div className="min-h-screen w-screen h-screen bg-background text-foreground">
        <div className="grid grid-rows-[72px_1fr] h-full w-full">
          {/* Header */}
          <div className="relative flex items-center px-8 border-b border-border bg-background/50 backdrop-blur-sm">
            <div className="flex items-center gap-4 text-foreground">
              <Image src="/logo.svg" alt="logo" width={64} height={64} />
              <div className="leading-tight">
                <div className="text-base font-bold tracking-wide">STRAVISION</div>
                <div className="text-xs text-muted-foreground">莓界 · 智慧农业平台</div>
              </div>
            </div>
            <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
              <PageNavigation />
            </div>
            {/* 布局编辑按钮和连接状态 */}
            <div className="ml-auto flex items-center gap-3">
              {connectionStatus.connected ? (
                <Badge className="bg-green-500/20 text-green-300 border-green-500/30 hover:bg-green-500/30">
                  <Wifi className="size-3 mr-1" />
                  已连接
                </Badge>
              ) : (
                <Badge className="bg-red-500/20 text-red-300 border-red-500/30 hover:bg-red-500/30">
                  <WifiOff className="size-3 mr-1" />
                  {connectionStatus.error || '未连接'}
                </Badge>
              )}
              {connectionStatus.lastUpdate && (
                <span className="text-xs text-muted-foreground/60">
                  更新: {connectionStatus.lastUpdate.toLocaleTimeString()}
                </span>
              )}
              {isEditMode ? (
                <Button
                  onClick={handleSaveLayout}
                  className="h-9 rounded-full px-5 bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg hover:shadow-xl transition-all"
                >
                  <Save className="mr-2" size={18} /> 保存布局
                </Button>
              ) : (
                <Button
                  onClick={handleEditMode}
                  variant="ghost"
                  className="h-9 rounded-full px-5 text-muted-foreground hover:text-foreground hover:bg-accent transition-all"
                >
                  <Edit className="mr-2" size={18} /> 编辑布局
                </Button>
              )}
              <UserAvatarMenu user={currentUser} />
            </div>
          </div>
          {/* Dashboard Content */}
          <div className="relative px-8 pb-8 pt-6 overflow-y-auto h-full w-full custom-scrollbar">
            <div id="dashboard-charts" className="w-full min-h-full">
              <GridLayout
                className="layout"
                layout={layout}
                cols={12}
                rowHeight={80}
                width={typeof window !== 'undefined' ? window.innerWidth - 64 : 1600}
                onLayoutChange={onLayoutChange}
                isDraggable={isEditMode}
                isResizable={isEditMode}
                compactType={null}
                preventCollision={true}
              >
                {/* 湿度 */}
                <div key="humidity">
                  <DashboardChartCard
                    title="湿度"
                    value={deviceData ? deviceData.humidity.toFixed(1) : '--'}
                    unit="%"
                    icon={<Droplets className="size-10 text-blue-400" />}
                    type="humidity"
                    color="blue"
                    gradientColor="#60a5fa"
                    initialHistoryData={historyDataMap['humidity']}
                  />
                </div>
                {/* 温度 */}
                <div key="temperature">
                  <DashboardChartCard
                    title="温度"
                    value={deviceData ? deviceData.temperature.toFixed(1) : '--'}
                    unit="°C"
                    icon={<Sun className="size-10 text-orange-400" />}
                    type="temperature"
                    color="orange"
                    gradientColor="#fb923c"
                    initialHistoryData={historyDataMap['temperature']}
                  />
                </div>
                {/* 光照 */}
                <div key="light">
                  <DashboardChartCard
                    title="光照强度"
                    value={deviceData ? deviceData.light : '--'}
                    unit="lux"
                    icon={<Sun className="size-10 text-yellow-400" strokeWidth={1.5} />}
                    type="light"
                    color="yellow"
                    gradientColor="#facc15"
                    initialHistoryData={historyDataMap['light']}
                  />
                </div>
                {/* CO2 */}
                <div key="co2">
                  <DashboardChartCard
                    title="CO₂浓度"
                    value={deviceData ? deviceData.co2 : '--'}
                    unit="ppm"
                    icon={<Wind className="size-10 text-gray-500" />}
                    type="co2"
                    color="gray"
                    gradientColor="#9ca3af"
                    initialHistoryData={historyDataMap['co2']}
                  />
                </div>
                {/* 土壤湿度 */}
                <div key="soilMoisture">
                  <DashboardChartCard
                    title="土壤湿度"
                    value={deviceData ? (deviceData.earth_water / 10).toFixed(1) : '--'}
                    unit="%"
                    icon={<Droplets className="size-10 text-cyan-400" />}
                    type="soilMoisture"
                    color="cyan"
                    gradientColor="#22d3ee"
                    initialHistoryData={historyDataMap['soilMoisture']}
                  />
                </div>
                {/* 土壤肥力 */}
                <div key="fertility">
                  <DashboardChartCard
                    title="土壤肥力"
                    value="78.5"
                    unit="%"
                    icon={<Leaf className="size-10 text-green-500" />}
                    type="fertility"
                    color="green"
                    gradientColor="#4ade80"
                    initialHistoryData={historyDataMap['fertility']}
                  />
                </div>
                {/* 氮含量 */}
                <div key="nitrogen">
                  <DashboardChartCard
                    title="氮含量 (N)"
                    value={deviceData ? deviceData.earth_n : '--'}
                    unit="mg/kg"
                    icon={<div className="size-10 rounded-full bg-purple-400 flex items-center justify-center text-white font-bold text-xl">N</div>}
                    type="nitrogen"
                    color="purple"
                    gradientColor="#c084fc"
                    initialHistoryData={historyDataMap['nitrogen']}
                  />
                </div>
                {/* 磷含量 */}
                <div key="phosphorus">
                  <DashboardChartCard
                    title="磷含量 (P)"
                    value={deviceData ? deviceData.earth_p : '--'}
                    unit="mg/kg"
                    icon={<div className="size-10 rounded-full bg-pink-400 flex items-center justify-center text-white font-bold text-xl">P</div>}
                    type="phosphorus"
                    color="pink"
                    gradientColor="#f472b6"
                    initialHistoryData={historyDataMap['phosphorus']}
                  />
                </div>
                {/* 钾含量 */}
                <div key="potassium">
                  <DashboardChartCard
                    title="钾含量 (K)"
                    value={deviceData ? deviceData.earth_k : '--'}
                    unit="mg/kg"
                    icon={<div className="size-10 rounded-full bg-amber-400 flex items-center justify-center text-white font-bold text-xl">K</div>}
                    type="potassium"
                    color="amber"
                    gradientColor="#fbbf24"
                    initialHistoryData={historyDataMap['potassium']}
                  />
                </div>
                {/* 光谱分析 */}
                <div key="spectral">
                  <SpectralCard data={deviceData} />
                </div>
                {/* 降雨量 */}
                <div key="rainfall">
                  {(() => {
                    const todayPrecip = weatherData?.forecast?.forecastday?.[0]?.day?.totalprecip_mm || 0
                    const isRaining = todayPrecip > 0
                    return (
                      <Card className={`h-full rounded-3xl border overflow-hidden shadow-2xl transition-all cursor-move relative ${isRaining
                        ? 'bg-gradient-to-br from-blue-600/20 via-cyan-600/15 to-blue-700/20 border-blue-400/30 hover:shadow-blue-500/20'
                        : 'glass border-border hover:shadow-3xl'
                        }`}>
                        {/* 雨滴动画效果 */}
                        {isRaining && (
                          <div className="absolute inset-0 overflow-hidden pointer-events-none">
                            {Array.from({ length: 15 }).map((_, i) => (
                              <div
                                key={i}
                                className="absolute w-0.5 h-3 bg-blue-300/30 animate-rain-dashboard"
                                style={{
                                  left: `${Math.random() * 100}%`,
                                  animationDelay: `${Math.random() * 2}s`,
                                  animationDuration: `${0.8 + Math.random() * 0.4}s`
                                }}
                              />
                            ))}
                          </div>
                        )}
                        <CardContent className="p-6 h-full flex flex-col justify-between relative z-10">
                          <div className="flex items-start justify-between">
                            <div>
                              <div className="text-5xl font-bold text-foreground mb-2 animate-fade-in-dashboard">
                                {weatherData?.forecast?.forecastday?.[0]?.day?.totalprecip_mm?.toFixed(1) || '--'}
                                <span className="text-2xl font-normal text-muted-foreground">mm</span>
                              </div>
                              <Badge className={`${isRaining ? 'bg-blue-400/30 text-blue-200 border-blue-400/40' : 'bg-blue-500/20 text-blue-600 border-blue-500/30'}`}>
                                今日降雨量
                              </Badge>
                            </div>
                            <Droplets className={`size-10 transition-all ${isRaining ? 'text-blue-300 animate-bounce' : 'text-blue-400'}`} />
                          </div>
                          <div className="flex items-end justify-between h-16 gap-1.5 mt-4">
                            {weatherData?.forecast?.forecastday?.slice(0, 7).map((day, i) => {
                              const maxPrecip = Math.max(...(weatherData.forecast.forecastday.slice(0, 7).map(d => d.day.totalprecip_mm || 0)), 1)
                              const height = ((day.day.totalprecip_mm || 0) / maxPrecip) * 100
                              const hasRain = (day.day.totalprecip_mm || 0) > 0
                              return (
                                <div
                                  key={i}
                                  className={`flex-1 rounded-t-lg transition-all duration-500 ${hasRain
                                    ? 'bg-gradient-to-t from-blue-400 to-blue-300 hover:from-blue-500 hover:to-blue-400 animate-grow-bar'
                                    : 'bg-gradient-to-t from-blue-400/20 to-blue-300/20 hover:from-blue-400/30 hover:to-blue-300/30'
                                    }`}
                                  style={{
                                    height: `${Math.max(height, 5)}%`,
                                    animationDelay: `${i * 0.1}s`
                                  }}
                                  title={`${day.date}: ${day.day.totalprecip_mm?.toFixed(1) || 0}mm`}
                                />
                              )
                            }) || [40, 60, 35, 70, 45, 55, 50].map((height, i) => (
                              <div key={i} className="flex-1 bg-gradient-to-t from-blue-400/30 to-blue-300/30 rounded-t-lg" style={{ height: `${height}%` }} />
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    )
                  })()}
                </div>
              </GridLayout>
            </div>
          </div>
        </div>
      </div>
      <IntroDisclosure
        steps={tourSteps}
        open={isTourOpen}
        setOpen={setIsTourOpen}
        featureId="dashboard-tour-v1"
      />
    </>
  )
}

--- FILE: app\device-control\page-old.tsx ---

"use client"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import Image from "next/image"
import { PageNavigation } from "@/components/page-navigation"
import { Droplet, Lightbulb, Sun, Fan, Thermometer, Wind, CloudSun, LeafIcon, Settings, Activity, Edit, Save } from "lucide-react"
import { useState, useEffect, useRef } from "react"
import { cn } from "@/lib/utils"
import GridLayout from "react-grid-layout"
import "react-grid-layout/css/styles.css"
import "react-resizable/css/styles.css"
function Toggle({ defaultChecked = false, className }: { defaultChecked?: boolean; className?: string }) {
  const [checked, setChecked] = useState(defaultChecked)
  return (
    <button
      type="button"
      aria-pressed={checked}
      onClick={() => setChecked(!checked)}
      className={cn(
        "relative w-14 h-8 rounded-full transition-all duration-300 shadow-lg",
        checked ? "bg-gradient-to-r from-blue-500 to-blue-600" : "bg-gray-600/50",
        className
      )}
    >
      <span
        className={cn(
          "absolute top-1/2 -translate-y-1/2 size-6 rounded-full bg-white transition-all duration-300 shadow-md",
          checked ? "right-1 scale-110" : "left-1"
        )}
      />
    </button>
  )
}
function DeviceCard({
  title,
  icon,
  gradient,
  children,
  isDraggable = false,
}: {
  title: string
  icon: React.ReactNode
  gradient: string
  children?: React.ReactNode
  isDraggable?: boolean
}) {
  return (
    <Card
      className={cn(
        "relative h-full min-h-[200px] rounded-3xl border border-white/5 overflow-hidden shadow-xl hover:shadow-2xl transition-all duration-300 bg-gradient-to-br from-[#1a2332] to-[#0f1419] group",
        isDraggable && "cursor-move"
      )}
    >
      <div
        className="absolute inset-0 opacity-80 group-hover:opacity-100 transition-opacity"
        style={{ background: gradient }}
      />
      <CardContent className="relative z-10 p-6 h-full flex flex-col justify-between">
        <div className="space-y-3">
          <div className="text-white/90 text-sm font-medium tracking-wide uppercase opacity-80">
            设备控制
          </div>
          <div className="text-white text-3xl font-bold leading-tight">
            {title}
          </div>
        </div>
        <div className="flex items-end justify-between">
          <div className="opacity-80 group-hover:opacity-100 transition-opacity">
            {icon}
          </div>
          {children && (
            <div className="transform group-hover:scale-105 transition-transform">
              {children}
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
function SliderRow({ label, value, onChange, color }: { label: string; value: number; onChange: (v: number) => void; color: string }) {
  return (
    <div className="relative">
      <div className="flex items-center gap-1.5 bg-[#1a2332]/50 backdrop-blur-sm rounded-lg p-1.5 border border-white/5">
        <div className="flex items-center justify-center min-w-[32px] h-[32px] rounded-md bg-[#0f1419] border border-white/10">
          <span className="text-sm font-bold text-white">{value}</span>
        </div>
        <div className="flex-1 px-1">
          <input
            type="range"
            min={0}
            max={255}
            value={value}
            onChange={(e) => onChange(parseInt(e.target.value))}
            className="w-full h-1.5 rounded-full appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-[14px] [&::-webkit-slider-thumb]:h-[14px] [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:transition-transform [&::-webkit-slider-thumb]:hover:scale-110 [&::-moz-range-thumb]:w-[14px] [&::-moz-range-thumb]:h-[14px] [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-white [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:shadow-md [&::-moz-range-thumb]:transition-transform [&::-moz-range-thumb]:hover:scale-110"
            style={{
              background: `linear-gradient(to right, ${color} 0%, ${color} ${(value/255)*100}%, rgba(255,255,255,0.1) ${(value/255)*100}%, rgba(255,255,255,0.1) 100%)`
            }}
            aria-label={label}
          />
        </div>
        <div className="flex items-center justify-center min-w-[32px] h-[32px] rounded-md bg-[#0f1419] border border-white/10">
          <span className="text-xs font-semibold text-white/50">255</span>
        </div>
      </div>
    </div>
  )
}
export default function DeviceControlPage() {
  const defaultLayout = [
    { i: "pump", x: 0, y: 0, w: 4, h: 2 },
    { i: "growLight", x: 4, y: 0, w: 4, h: 2 },
    { i: "whiteLight", x: 8, y: 0, w: 4, h: 2 },
    { i: "fan", x: 0, y: 2, w: 4, h: 2 },
    { i: "rgbControl", x: 4, y: 2, w: 8, h: 2 },
    { i: "tempSensor", x: 0, y: 4, w: 8, h: 2 },
    { i: "co2Sensor", x: 8, y: 4, w: 4, h: 2 },
  ]
  const [layout, setLayout] = useState(defaultLayout)
  const [isEditMode, setIsEditMode] = useState(false)
  const [r, setR] = useState(0)
  const [g, setG] = useState(0)
  const [b, setB] = useState(0)
  // 从 localStorage 加载布局
  useEffect(() => {
    const savedLayout = localStorage.getItem('device-control-layout')
    if (savedLayout) {
      try {
        const parsed = JSON.parse(savedLayout)
        setTimeout(() => setLayout(parsed), 0)
      } catch (e) {
        console.error('Failed to load layout:', e)
      }
    }
  }, [])
  const onLayoutChange = (newLayout: any) => {
    if (isEditMode) {
      setLayout(newLayout)
    }
  }
  const handleSaveLayout = () => {
    localStorage.setItem('device-control-layout', JSON.stringify(layout))
    setIsEditMode(false)
    alert('布局已保存！')
  }
  const handleEditMode = () => {
    setIsEditMode(!isEditMode)
  }
  return (
    <div className="min-h-screen w-screen h-screen bg-gradient-to-br from-[#0a0e1a] via-[#0E1524] to-[#0a0e1a] text-white">
      <div className="grid grid-rows-[72px_1fr] h-full w-full">
        <div className="relative flex items-center px-8 border-b border-white/5 bg-[#0a0e1a]/50 backdrop-blur-sm">
          <div className="flex items-center gap-4 text-white">
            <Image src="/logo.svg" alt="logo" width={64} height={64} />
            <div className="leading-tight">
              <div className="text-base font-bold tracking-wide">STRAVISION</div>
              <div className="text-xs text-white/60">莓界 · 智慧农业平台</div>
            </div>
          </div>
          <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
            <PageNavigation />
          </div>
        </div>
        <div className="relative px-8 pb-8 pt-6">
          <div className="grid grid-cols-1 lg:grid-cols-[1fr_440px] gap-6 h-[calc(100vh-72px-56px)]">
            <div className="relative h-full rounded-3xl bg-gradient-to-br from-[#0f1419] to-[#0a0e14] overflow-hidden border border-white/5 shadow-2xl">
              <div className="h-full p-6 overflow-auto">
              {/* 布局编辑按钮 */}
              <div className="absolute top-4 right-4 z-10 flex gap-2">
                {isEditMode ? (
                  <Button
                    onClick={handleSaveLayout}
                    className="h-9 rounded-full px-5 bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg hover:shadow-xl transition-all"
                  >
                    <Save className="mr-2" size={18} /> 保存布局
                  </Button>
                ) : (
                  <Button
                    onClick={handleEditMode}
                    variant="outline"
                    className="h-9 rounded-full px-5 border-white/20 bg-white/5 hover:bg-white/10 text-white hover:text-white"
                  >
                    <Edit className="mr-2" size={18} /> 编辑布局
                  </Button>
                )}
              </div>
                <GridLayout
                  className="layout"
                  layout={layout}
                  cols={12}
                  rowHeight={80}
                  width={
                    typeof window !== "undefined"
                      ? window.innerWidth * 0.55
                      : 1000
                  }
                  isDraggable={isEditMode}
                  isResizable={isEditMode}
                  onLayoutChange={onLayoutChange}
                  compactType={null}
                  preventCollision={true}
                >
                <div key="pump">
                  <DeviceCard
                    title="水泵"
                    icon={
                      <Droplet className="size-12 text-white" strokeWidth={1.5} />
                    }
                    gradient="radial-gradient(800px 800px at 10% 30%, #0D5EF8 0%, transparent 30%)"
                    isDraggable={isEditMode}
                  >
                    <Toggle defaultChecked />
                  </DeviceCard>
                </div>
                <div key="growLight">
                  <DeviceCard
                    title="补光灯"
                    icon={
                      <Lightbulb
                        className="size-12 text-white"
                        strokeWidth={1.5}
                      />
                    }
                    gradient="radial-gradient(800px 800px at 10% 30%, #F5B700 0%, transparent 30%)"
                    isDraggable={isEditMode}
                  >
                    <Toggle />
                  </DeviceCard>
                </div>
                <div key="whiteLight">
                  <DeviceCard
                    title="白灯"
                    icon={<Sun className="size-12 text-white" strokeWidth={1.5} />}
                    gradient="radial-gradient(800px 800px at 10% 30%, #8A7CF3 0%, transparent 30%)"
                    isDraggable={isEditMode}
                  >
                    <Toggle defaultChecked />
                  </DeviceCard>
                </div>
                <div key="fan">
                  <DeviceCard
                    title="风扇"
                    icon={<Fan className="size-12 text-white" strokeWidth={1.5} />}
                    gradient="radial-gradient(800px 800px at 10% 30%, #60A5FA 0%, transparent 30%)"
                    isDraggable={isEditMode}
                  >
                    <Toggle />
                  </DeviceCard>
                </div>
                <div key="rgbControl">
                  <Card className="relative h-full min-h-[200px] rounded-3xl border border-white/5 overflow-hidden shadow-xl bg-gradient-to-br from-[#1a2332] to-[#0f1419] group hover:shadow-2xl transition-all">
                    <div
                      className="absolute inset-0 opacity-80 group-hover:opacity-100 transition-opacity"
                      style={{
                        background:
                          "radial-gradient(800px 800px at 10% 30%, #4C80FF 0%, transparent 30%)",
                      }}
                    />
                    <CardContent className="relative z-10 p-6 h-full flex items-center justify-between gap-6">
                      <div className="space-y-3">
                        <div className="space-y-2">
                          <div className="text-white/90 text-sm font-medium tracking-wide uppercase opacity-80">
                            RGB 控制
                          </div>
                          <div className="text-white text-3xl font-bold leading-tight">
                            补光灯颜色
                          </div>
                        </div>
                        <div
                          className="w-48 h-24 rounded-xl border border-white/10 shadow-inner transition-colors"
                          style={{ backgroundColor: `rgb(${r}, ${g}, ${b})` }}
                        />
                      </div>
                      <div className="space-y-1.5 w-80 flex-shrink-0">
                        <SliderRow
                          label="红色 (R)"
                          value={r}
                          onChange={setR}
                          color="#ef4444"
                        />
                        <SliderRow
                          label="绿色 (G)"
                          value={g}
                          onChange={setG}
                          color="#22c55e"
                        />
                        <SliderRow
                          label="蓝色 (B)"
                          value={b}
                          onChange={setB}
                          color="#3b82f6"
                        />
                      </div>
                    </CardContent>
                  </Card>
                </div>
                <div key="tempSensor">
                  <DeviceCard
                    title="温湿度传感器"
                    icon={
                      <Thermometer
                        className="size-12 text-white"
                        strokeWidth={1.5}
                      />
                    }
                    gradient="radial-gradient(800px 800px at 10% 30%, #A66C54 0%, transparent 30%)"
                    isDraggable={isEditMode}
                  >
                    <Toggle defaultChecked />
                  </DeviceCard>
                </div>
                <div key="co2Sensor">
                  <DeviceCard
                    title="CO₂ 传感器"
                    icon={<Wind className="size-12 text-white" strokeWidth={1.5} />}
                    gradient="radial-gradient(800px 800px at 10% 30%, #9E3E35 0%, transparent 30%)"
                    isDraggable={isEditMode}
                  >
                    <Toggle defaultChecked />
                  </DeviceCard>
                </div>
                </GridLayout>
              </div>
            </div>
            <Card className="h-full rounded-3xl bg-gradient-to-br from-[#0f1419] to-[#0a0e14] border border-white/5 text-white shadow-2xl overflow-auto">
              <CardHeader className="px-6 pt-6 pb-4 space-y-3">
                <div className="flex items-center justify-between">
                  <CardTitle className="text-xl font-bold text-white">环境监测数据</CardTitle>
                  <Badge className="bg-blue-500/20 text-blue-300 border-blue-500/30 hover:bg-blue-500/30">
                    草莓栽培
                  </Badge>
                </div>
                <Separator className="bg-white/5" />
              </CardHeader>
              <CardContent className="space-y-5 px-6 pb-6">
                <div className="grid grid-cols-3 gap-3">
                  <Card className="rounded-xl bg-gradient-to-br from-orange-500/10 to-orange-600/5 border-orange-500/20 p-4 hover:border-orange-500/40 transition-all">
                    <div className="text-xs text-orange-300/80 font-medium mb-1">温度</div>
                    <div className="text-2xl font-bold text-white">12.1°C</div>
                  </Card>
                  <Card className="rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 border-blue-500/20 p-4 hover:border-blue-500/40 transition-all">
                    <div className="text-xs text-blue-300/80 font-medium mb-1">湿度</div>
                    <div className="text-2xl font-bold text-white">38.9%</div>
                  </Card>
                  <Card className="rounded-xl bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 border-yellow-500/20 p-4 hover:border-yellow-500/40 transition-all">
                    <div className="text-xs text-yellow-300/80 font-medium mb-1">光照</div>
                    <div className="text-2xl font-bold text-white">1000 lux</div>
                  </Card>
                </div>
                <Card className="rounded-xl bg-gradient-to-br from-[#1a2332] to-[#0f1419] border-white/5">
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2 text-white/90">
                        <CloudSun className="size-5" />
                        <span className="font-semibold">温度趋势</span>
                      </div>
                      <Badge variant="outline" className="border-blue-500/30 text-blue-300">21°C</Badge>
                    </div>
                    <svg viewBox="0 0 360 120" className="w-full h-[120px]">
                      <defs>
                        <linearGradient id="wg" x1="0" x2="0" y1="0" y2="1">
                          <stop offset="0%" stopColor="#4C80FF" stopOpacity="0.4" />
                          <stop offset="100%" stopColor="#4C80FF" stopOpacity="0.0" />
                        </linearGradient>
                      </defs>
                      <path d="M0,90 C40,70 70,40 110,55 C150,70 180,30 220,50 C260,70 300,40 340,80" fill="none" stroke="#4C80FF" strokeWidth="2.5" />
                      <path d="M0,90 C40,70 70,40 110,55 C150,70 180,30 220,50 C260,70 300,40 340,80 L340,120 L0,120 Z" fill="url(#wg)" />
                    </svg>
                    <div className="mt-3 grid grid-cols-8 text-center text-xs text-white/60">
                      {Array.from({ length: 8 }).map((_, i) => (
                        <div key={i}>12/{i + 1}</div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
                <div className="grid grid-cols-3 gap-3">
                  {[
                    { label: "室内温度", value: "25.3°C", color: "from-red-500/10 to-red-600/5 border-red-500/20" },
                    { label: "风向", value: "西风向", color: "from-cyan-500/10 to-cyan-600/5 border-cyan-500/20" },
                    { label: "UV指数", value: "中等", color: "from-purple-500/10 to-purple-600/5 border-purple-500/20" },
                    { label: "土壤湿度", value: "25.3%", color: "from-green-500/10 to-green-600/5 border-green-500/20" },
                    { label: "风力", value: "1级", color: "from-sky-500/10 to-sky-600/5 border-sky-500/20" },
                    { label: "气压", value: "581hPa", color: "from-indigo-500/10 to-indigo-600/5 border-indigo-500/20" }
                  ].map((item, i) => (
                    <Card key={i} className={cn("rounded-xl bg-gradient-to-br p-3 hover:scale-105 transition-transform", item.color)}>
                      <div className="text-xs text-white/70 font-medium mb-1">{item.label}</div>
                      <div className="text-base font-bold text-white">{item.value}</div>
                    </Card>
                  ))}
                </div>
                <Card className="rounded-xl bg-gradient-to-br from-[#1a2332] to-[#0f1419] border-white/5 p-4">
                  <div className="flex items-center justify-between mb-3">
                    <div className="text-white/90 font-semibold">生长阶段</div>
                    <Badge variant="outline" className="border-green-500/30 text-green-300">第3阶段</Badge>
                  </div>
                  <div className="grid grid-cols-6 gap-2">
                    {Array.from({ length: 6 }).map((_, i) => (
                      <div
                        key={i}
                        className={cn(
                          "h-16 rounded-lg grid place-content-center transition-all",
                          i <= 2
                            ? "bg-gradient-to-br from-green-500/20 to-green-600/10 border border-green-500/30"
                            : "bg-white/5 border border-white/10"
                        )}
                      >
                        <LeafIcon className={cn("size-6", i <= 2 ? "text-green-400" : "text-white/30")} />
                      </div>
                    ))}
                  </div>
                </Card>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: app\device-control\page.tsx ---

"use client"
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import Image from "next/image"
import {
  Droplet,
  Lightbulb,
  Sun,
  Fan,
  Thermometer,
  Wind,
  Wifi,
  WifiOff,
  History,
} from "lucide-react"
import { useState, useEffect } from "react"
import { cn } from "@/lib/utils"
import { PageNavigation } from "@/components/page-navigation"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import { WeatherCard } from "@/components/weather-card"
import { motion } from "framer-motion"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useDeviceControl } from "@/lib/hooks/use-device-control"
import { Button } from "@/components/ui/button"
import { useRouter } from "next/navigation"
import type { UserPublic } from "@/lib/db/user-service"
import { ModeToggle } from "@/components/mode-toggle"
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet"
import { ScrollArea } from "@/components/ui/scroll-area"
function Toggle({
  checked = false,
  onChange,
  disabled = false,
}: {
  checked?: boolean
  onChange?: (checked: boolean) => void
  disabled?: boolean
}) {
  const handleToggle = () => {
    if (!disabled) {
      onChange?.(!checked)
    }
  }
  return (
    <button
      type="button"
      onClick={handleToggle}
      disabled={disabled}
      className={cn(
        "relative w-16 h-9 rounded-full transition-all duration-300 shadow-lg",
        disabled && "opacity-50 cursor-not-allowed",
        checked
          ? "bg-primary"
          : "bg-muted"
      )}
    >
      <motion.span
        className="absolute top-1/2 -translate-y-1/2 w-7 h-7 rounded-full bg-white shadow-md"
        animate={{
          left: checked ? "calc(100% - 32px)" : "4px",
        }}
        transition={{
          type: "spring",
          stiffness: 500,
          damping: 30,
        }}
      />
    </button>
  )
}
function DeviceCard({
  title,
  icon,
  gradient,
  checked = false,
  onChange,
  disabled = false,
}: {
  title: string
  icon: React.ReactNode
  gradient: string
  checked?: boolean
  onChange?: (checked: boolean) => void
  disabled?: boolean
}) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      whileHover={{ y: -4 }}
    >
      <Card className="relative h-full rounded-2xl border border-border overflow-hidden shadow-xl glass group">
        <div
          className="absolute inset-0 opacity-50 dark:opacity-60 group-hover:opacity-70 dark:group-hover:opacity-80 transition-opacity duration-300"
          style={{ background: gradient }}
        />
        <CardContent className="relative z-10 p-8 h-full flex flex-col justify-between min-h-[200px]">
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <Badge
                variant="outline"
                className="bg-background/40 backdrop-blur-sm"
              >
                设备控制
              </Badge>
            </div>
            <h3 className="text-foreground text-2xl font-bold leading-tight">
              {title}
            </h3>
          </div>
          <div className="flex items-end justify-between mt-6">
            <div className="opacity-70 group-hover:opacity-100 transition-opacity text-foreground">
              {icon}
            </div>
            <Toggle checked={checked} onChange={onChange} disabled={disabled} />
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}
function SliderRow({
  label,
  value,
  onChange,
  color,
  displayValue,
}: {
  label: string
  value: number
  onChange: (value: number) => void
  color: string
  displayValue?: string
}) {
  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <span className="text-sm font-medium text-muted-foreground">{label}</span>
        <span className="text-sm font-bold text-foreground">{displayValue || value}</span>
      </div>
      <div className="flex items-center gap-3">
        <input
          type="range"
          min={0}
          max={255}
          value={value}
          onChange={(e) => onChange(parseInt(e.target.value))}
          className="flex-1 h-2 rounded-full appearance-none cursor-pointer bg-muted [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-lg [&::-webkit-slider-thumb]:transition-transform [&::-webkit-slider-thumb]:hover:scale-110"
          style={{
            background: `linear-gradient(to right, ${color} 0%, ${color} ${(value / 255) * 100}%, var(--muted) ${(value / 255) * 100}%, var(--muted) 100%)`,
          }}
        />
      </div>
    </div>
  )
}
export default function DeviceControlPage() {
  const router = useRouter()
  const [r, setR] = useState(0)
  const [g, setG] = useState(0)
  const [b, setB] = useState(0)
  const [w, setW] = useState(0)
  // Logs state
  const [logs, setLogs] = useState<any[]>([])
  const [loadingLogs, setLoadingLogs] = useState(false)
  // User authentication state
  const [currentUser, setCurrentUser] = useState<UserPublic | null>(null)
  const [isLoadingUser, setIsLoadingUser] = useState(true)
  // Connect to SSE for real-time device data
  const { deviceData, connectionStatus } = useDeviceData()
  // Control hook for sending commands
  const { status: controlStatus, toggleRelay, setLEDs } = useDeviceControl()
  // Fetch current user on mount
  useEffect(() => {
    const fetchCurrentUser = async () => {
      try {
        const response = await fetch("/api/auth/me")
        const data = await response.json()
        if (data.authenticated && data.user) {
          setCurrentUser(data.user)
        } else {
          router.push("/login")
        }
      } catch (error) {
        console.error("获取用户信息失败:", error)
        router.push("/login")
      } finally {
        setIsLoadingUser(false)
      }
    }
    fetchCurrentUser()
  }, [router])
  // Fetch logs
  const fetchLogs = async () => {
    setLoadingLogs(true)
    try {
      const res = await fetch("/api/device-logs?limit=50")
      const data = await res.json()
      if (data.success) {
        setLogs(data.logs)
      }
    } catch (error) {
      console.error("Failed to fetch logs:", error)
    } finally {
      setLoadingLogs(false)
    }
  }
  // Create log
  const createLog = async (deviceName: string, action: string, details?: string) => {
    if (!currentUser) return
    try {
      await fetch("/api/device-logs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          device_name: deviceName,
          action,
          operator: currentUser.username || currentUser.email,
          details
        })
      })
      // Refresh logs
      fetchLogs()
    } catch (error) {
      console.error("Failed to create log:", error)
    }
  }
  // Fetch logs on mount
  useEffect(() => {
    fetchLogs()
  }, [])
  // Sync LED sliders with device data on first load
  useEffect(() => {
    if (deviceData && r === 0 && g === 0 && b === 0 && w === 0) {
      setR(deviceData.led1 || 0)
      setG(deviceData.led2 || 0)
      setB(deviceData.led3 || 0)
      setW(deviceData.led4 || 0)
    }
  }, [deviceData, r, g, b, w])
  // Handle relay toggle
  const handleRelayToggle = async (relayNum: number) => {
    if (!deviceData) return
    const currentState = deviceData[`relay${relayNum}` as keyof typeof deviceData] as number || 0
    const newState = currentState === 1 ? 0 : 1
    const success = await toggleRelay(relayNum, currentState)
    if (success) {
      const deviceNames: Record<number, string> = {
        5: "水泵",
        6: "风扇",
        7: "补光灯",
        8: "白灯"
      }
      createLog(deviceNames[relayNum] || `Relay ${relayNum}`, newState === 1 ? "开启" : "关闭")
    } else {
      // Show error notification (you can add a toast notification here)
      console.error('Failed to toggle relay')
    }
  }
  // Handle LED update
  const handleLEDUpdate = async () => {
    const success = await setLEDs(r, g, b, 0)
    if (success) {
      createLog("RGB 补光灯", "更新颜色", `R:${r} G:${g} B:${b} W:${w}`)
    } else {
      console.error('Failed to update LEDs')
    }
  }
  // Show loading state while checking authentication
  if (isLoadingUser) {
    return (
      <div className="min-h-screen w-screen h-screen bg-background flex items-center justify-center">
        <div className="text-muted-foreground animate-pulse">加载中...</div>
      </div>
    )
  }
  // Don't render page if no user (will redirect)
  if (!currentUser) {
    return null
  }
  return (
    <div className="min-h-screen w-screen h-screen bg-background text-foreground transition-colors duration-500 overflow-hidden">
      {/* Background Gradients */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] rounded-full bg-primary/5 blur-[120px] animate-[float_10s_ease-in-out_infinite]" />
        <div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] rounded-full bg-purple-500/5 blur-[120px] animate-[float_12s_ease-in-out_infinite_reverse]" />
      </div>
      <div className="relative z-10 grid grid-rows-[72px_1fr] h-full w-full">
        {/* Header */}
        <div className="relative flex items-center px-8 border-b border-border/40 bg-background/60 backdrop-blur-md z-20">
          <div className="flex items-center gap-4">
            <div className="relative size-12 animate-[breathe_4s_ease-in-out_infinite]">
              <Image src="/logo.svg" alt="logo" fill className="object-contain" />
            </div>
            <div className="leading-tight">
              <div className="text-base font-bold tracking-wide">
                STRAVISION
              </div>
              <div className="text-xs text-muted-foreground">莓界 · 智慧农业平台</div>
            </div>
          </div>
          <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
            <PageNavigation />
          </div>
          <div className="ml-auto flex items-center gap-3">
            <Sheet onOpenChange={(open) => { if (open) fetchLogs() }}>
              <SheetTrigger asChild>
                <Button variant="ghost" size="icon" className="text-muted-foreground hover:text-foreground">
                  <History className="size-5" />
                </Button>
              </SheetTrigger>
              <SheetContent>
                <SheetHeader>
                  <SheetTitle>设备控制历史</SheetTitle>
                </SheetHeader>
                <ScrollArea className="h-[calc(100vh-80px)] mt-4 pr-4">
                  <div className="space-y-4">
                    {loadingLogs ? (
                      <div className="text-center text-muted-foreground py-8">加载中...</div>
                    ) : logs.length === 0 ? (
                      <div className="text-center text-muted-foreground py-8">暂无操作记录</div>
                    ) : (
                      logs.map((log) => (
                        <div key={log.id} className="flex flex-col gap-1 p-3 rounded-lg bg-muted/50 border border-border">
                          <div className="flex items-center justify-between">
                            <span className="font-medium text-foreground">{log.device_name}</span>
                            <span className="text-xs text-muted-foreground">
                              {new Date(log.created_at).toLocaleString()}
                            </span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Badge variant={log.action === "开启" ? "default" : "secondary"} className="text-xs">
                              {log.action}
                            </Badge>
                            <span className="text-sm text-muted-foreground">操作人: {log.operator}</span>
                          </div>
                          {log.details && (
                            <div className="text-xs text-muted-foreground mt-1">
                              {log.details}
                            </div>
                          )}
                        </div>
                      ))
                    )}
                  </div>
                </ScrollArea>
              </SheetContent>
            </Sheet>
            <ModeToggle />
            {connectionStatus.connected ? (
              <Badge variant="outline" className="bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20">
                <Wifi className="size-3 mr-1" />
                已连接
              </Badge>
            ) : (
              <Badge variant="outline" className="bg-red-500/10 text-red-600 dark:text-red-400 border-red-500/20">
                <WifiOff className="size-3 mr-1" />
                {connectionStatus.error || '未连接'}
              </Badge>
            )}
            <UserAvatarMenu user={currentUser} />
          </div>
        </div>
        {/* Content */}
        <div className="relative px-8 pb-24 pt-6 overflow-y-auto custom-scrollbar h-full w-full">
          <div className="grid grid-cols-1 lg:grid-cols-[1fr_440px] gap-6 min-h-full">
            {/* Left: Device Cards */}
            <div className="space-y-6">
              {/* Row 1: 3 cards - Relay 5, 6, 7 */}
              <div id="device-control-grid" className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <DeviceCard
                  title="水泵 (Relay 5)"
                  icon={
                    <Droplet className="size-16" strokeWidth={1.5} />
                  }
                  gradient="radial-gradient(circle at 30% 30%, rgba(13, 94, 248, 0.4) 0%, transparent 70%)"
                  checked={deviceData?.relay5 === 1}
                  onChange={() => handleRelayToggle(5)}
                  disabled={controlStatus.loading || !connectionStatus.connected}
                />
                <DeviceCard
                  title="风扇 (Relay 6)"
                  icon={
                    <Fan
                      className="size-16"
                      strokeWidth={1.5}
                    />
                  }
                  gradient="radial-gradient(circle at 30% 30%, rgba(96, 165, 250, 0.4) 0%, transparent 70%)"
                  checked={deviceData?.relay6 === 1}
                  onChange={() => handleRelayToggle(6)}
                  disabled={controlStatus.loading || !connectionStatus.connected}
                />
                <DeviceCard
                  title="补光灯 (Relay 7)"
                  icon={<Lightbulb className="size-16" strokeWidth={1.5} />}
                  gradient="radial-gradient(circle at 30% 30%, rgba(245, 183, 0, 0.4) 0%, transparent 70%)"
                  checked={deviceData?.relay7 === 1}
                  onChange={() => handleRelayToggle(7)}
                  disabled={controlStatus.loading || !connectionStatus.connected}
                />
              </div>
              {/* Row 2: 1 card + RGB Control */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <DeviceCard
                  title="白灯 (Relay 8)"
                  icon={<Sun className="size-16" strokeWidth={1.5} />}
                  gradient="radial-gradient(circle at 30% 30%, rgba(138, 124, 243, 0.4) 0%, transparent 70%)"
                  checked={deviceData?.relay8 === 1}
                  onChange={() => handleRelayToggle(8)}
                  disabled={controlStatus.loading || !connectionStatus.connected}
                />
                {/* RGB Control - spans 2 columns */}
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.3, delay: 0.1 }}
                  className="md:col-span-2"
                >
                  <Card className="relative h-full rounded-2xl border border-border overflow-hidden shadow-xl glass group">
                    <div
                      className="absolute inset-0 opacity-20 dark:opacity-60 group-hover:opacity-40 dark:group-hover:opacity-80 transition-opacity duration-300"
                      style={{
                        background:
                          "radial-gradient(circle at 30% 30%, rgba(76, 128, 255, 0.4) 0%, transparent 70%)",
                      }}
                    />
                    <CardContent className="relative z-10 p-8 h-full flex flex-col gap-6 min-h-[200px]">
                      <div className="flex flex-col md:flex-row items-center gap-8">
                        <div className="flex-1 space-y-4">
                          <div>
                            <Badge
                              variant="outline"
                              className="bg-background/40 backdrop-blur-sm mb-3"
                            >
                              RGB 控制 (LED 1-3)
                            </Badge>
                            <h3 className="text-foreground text-2xl font-bold">
                              补光灯颜色
                            </h3>
                          </div>
                          <div
                            className="w-full h-24 rounded-xl border border-border shadow-inner transition-all duration-300"
                            style={{
                              backgroundColor: `rgb(${r}, ${g}, ${b})`,
                              boxShadow: `0 0 30px rgba(${r}, ${g}, ${b}, 0.5)`,
                            }}
                          />
                        </div>
                        <div className="flex-1 space-y-4 w-full">
                          <SliderRow
                            label="红色 (LED 1)"
                            value={r}
                            onChange={setR}
                            color="#ef4444"
                          />
                          <SliderRow
                            label="绿色 (LED 2)"
                            value={g}
                            onChange={setG}
                            color="#22c55e"
                          />
                          <SliderRow
                            label="蓝色 (LED 3)"
                            value={b}
                            onChange={setB}
                            color="#3b82f6"
                          />
                          <SliderRow
                            label="亮度 (占空比)"
                            value={w}
                            onChange={setW}
                            color="#f59e0b"
                            displayValue={`${Math.round((w / 255) * 100)}%`}
                          />
                        </div>
                      </div>
                      <div className="flex justify-end">
                        <Button
                          onClick={handleLEDUpdate}
                          disabled={controlStatus.loading || !connectionStatus.connected}
                          className="px-8"
                        >
                          {controlStatus.loading ? '发送中...' : '更新 LED 亮度'}
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </motion.div>
              </div>
              {/* Row 3: 2 cards - Sensors (read-only) */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <DeviceCard
                  title="温湿度传感器"
                  icon={
                    <Thermometer
                      className="size-16"
                      strokeWidth={1.5}
                    />
                  }
                  gradient="radial-gradient(circle at 30% 30%, rgba(166, 108, 84, 0.4) 0%, transparent 70%)"
                  checked={true}
                  disabled={true}
                />
                <DeviceCard
                  title="CO₂ 传感器"
                  icon={<Wind className="size-16" strokeWidth={1.5} />}
                  gradient="radial-gradient(circle at 30% 30%, rgba(158, 62, 53, 0.4) 0%, transparent 70%)"
                  checked={true}
                  disabled={true}
                />
              </div>
            </div>
            {/* Right: Environment Data */}
            <div className="h-full rounded-2xl glass border border-border shadow-2xl overflow-auto p-6">
              <WeatherCard deviceData={deviceData} />
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: app\globals.css ---

@import "tailwindcss";
@import "tw-animate-css";
@custom-variant dark (&:is(.dark *));
@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  /* Custom Animations */
  --animate-float: float 6s ease-in-out infinite;
  --animate-breathe: breathe 4s ease-in-out infinite;
  --animate-glow: glow 3s ease-in-out infinite;
  @keyframes float {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }
  @keyframes breathe {
    0%,
    100% {
      opacity: 0.8;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.02);
    }
  }
  @keyframes glow {
    0%,
    100% {
      box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary);
    }
    50% {
      box-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary);
    }
  }
  @keyframes shrink {
    0% {
      width: 100%;
    }
    100% {
      width: 0%;
    }
  }
  /* Collapsible Animations */
  --animate-collapsible-down: collapsible-down 0.2s ease-out;
  --animate-collapsible-up: collapsible-up 0.2s ease-out;
  @keyframes collapsible-down {
    from {
      height: 0;
    }
    to {
      height: var(--radix-collapsible-content-height);
    }
  }
  @keyframes collapsible-up {
    from {
      height: var(--radix-collapsible-content-height);
    }
    to {
      height: 0;
    }
  }
}
:root {
  --radius: 0.625rem;
  /* Light Mode - Soft, airy, nature-inspired */
  --background: oklch(0.98 0.01 240);
  /* Very light cool grey/blue */
  --foreground: oklch(0.2 0.02 240);
  --card: oklch(1 0 0 / 0.7);
  /* Glassy white */
  --card-foreground: oklch(0.2 0.02 240);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.2 0.02 240);
  --primary: oklch(0.55 0.15 240);
  /* Fresh Blue */
  --primary-foreground: oklch(0.98 0 0);
  --secondary: oklch(0.95 0.03 240);
  --secondary-foreground: oklch(0.3 0.05 240);
  --muted: oklch(0.96 0.01 240);
  --muted-foreground: oklch(0.5 0.02 240);
  --accent: oklch(0.94 0.04 240);
  --accent-foreground: oklch(0.3 0.05 240);
  --destructive: oklch(0.6 0.2 20);
  --destructive-foreground: oklch(0.98 0 0);
  --border: oklch(0.9 0.02 240);
  --input: oklch(0.9 0.02 240);
  --ring: oklch(0.55 0.15 240);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.98 0.01 240);
  --sidebar-foreground: oklch(0.2 0.02 240);
  --sidebar-primary: oklch(0.55 0.15 240);
  --sidebar-primary-foreground: oklch(0.98 0 0);
  --sidebar-accent: oklch(0.95 0.03 240);
  --sidebar-accent-foreground: oklch(0.3 0.05 240);
  --sidebar-border: oklch(0.9 0.02 240);
  --sidebar-ring: oklch(0.55 0.15 240);
}
.dark {
  /* Dark Mode - User Specified Palette */
  --background: #111827;
  /* Main Accent - Dark Blue-Grey */
  --foreground: oklch(0.985 0 0);
  --card: #1F2937;
  /* Secondary Accent - Lighter Blue-Grey */
  --card-foreground: oklch(0.985 0 0);
  --popover: #1F2937;
  --popover-foreground: oklch(0.985 0 0);
  --primary: #3B82F6;
  /* Button Color - Bright Blue */
  --primary-foreground: oklch(0.985 0 0);
  --secondary: #1F2937;
  --secondary-foreground: oklch(0.985 0 0);
  --muted: #1F2937;
  --muted-foreground: oklch(0.708 0 0);
  --accent: #1F2937;
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: #3B82F6;
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: #111827;
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: #3B82F6;
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: #1F2937;
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: #3B82F6;
}
@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  html, body {
    @apply w-full overflow-x-hidden;
  }
  body {
    @apply bg-background text-foreground transition-colors duration-500 ease-in-out;
  }
}
@layer utilities {
  .glass {
    @apply bg-card/60 backdrop-blur-md border border-border shadow-xl;
  }
  .glass-hover {
    @apply hover:bg-card/80 hover:scale-[1.02] transition-all duration-300;
  }
  .text-gradient {
    @apply bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-400;
  }
  .bg-noise {
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
  }
  .mask-gradient-x {
    mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
  }
  .mask-gradient-right {
    mask-image: linear-gradient(to right, black 85%, transparent);
    -webkit-mask-image: linear-gradient(to right, black 85%, transparent);
  }
}

--- FILE: app\layout.tsx ---

import type { Metadata } from "next";
import "./globals.css";
import { WeatherProvider } from "@/lib/contexts/weather-context";
import { DeviceProvider } from "@/lib/contexts/device-context";
import { ThemeProvider } from "@/components/theme-provider";
import { SchedulerInit } from "@/components/scheduler-init";
import { PageTransition } from "@/components/page-transition";
import { SmoothScroll } from "@/components/smooth-scroll";
import { EnvironmentAlert } from "@/components/environment-alert";
import { ToasterWrapper } from "@/components/toaster-wrapper";
import { MessageNotificationListener } from "@/components/message-notification-listener";
import { headers } from "next/headers";
import { isIPBanned, recordAccessLog, getBanDetails } from "@/lib/db/security-service";
export const metadata: Metadata = {
  title: "stravision莓界 · 登录",
  description: "stravision莓界登录页面",
};
export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  // IP Ban Check
  const headersList = await headers();
  const forwardedFor = headersList.get("x-forwarded-for");
  const ip = forwardedFor ? forwardedFor.split(",")[0].trim() : "127.0.0.1";
  const banDetails = await getBanDetails(ip);
  if (banDetails) {
     // Record access attempt
     await recordAccessLog({
       ip,
       method: "GET",
       path: "layout",
       status: 403,
       duration: 0,
       user_agent: headersList.get("user-agent") || ""
     });
     return (
       <html lang="en">
         <body>
           <div style={{
             display: 'flex',
             justifyContent: 'center',
             alignItems: 'center',
             height: '100vh',
             flexDirection: 'column',
             fontFamily: 'system-ui, sans-serif',
             padding: '20px',
             textAlign: 'center'
           }}>
             <h1 style={{ color: '#e11d48', fontSize: '2rem', marginBottom: '1rem' }}>Access Denied</h1>
             <p style={{ marginBottom: '1rem' }}>Your IP address ({ip}) has been banned from accessing this system.</p>
             {banDetails.reason && (
               <div style={{
                 backgroundColor: '#fef2f2',
                 border: '1px solid #fee2e2',
                 color: '#b91c1c',
                 padding: '1rem',
                 borderRadius: '0.5rem',
                 maxWidth: '400px'
               }}>
                 <strong>Reason:</strong> {banDetails.reason}
               </div>
             )}
             {banDetails.expires_at && (
                <p style={{ marginTop: '1rem', color: '#6b7280', fontSize: '0.875rem' }}>
                  Expires: {new Date(banDetails.expires_at).toLocaleString()}
                </p>
             )}
           </div>
         </body>
       </html>
     );
  }
  // Record normal access (optional, but requested "record every visiting ip")
  // To avoid slowing down page loads, we fire and forget, but in Server Components
  // we can't easily fire-and-forget without `void`.
  // Also, doing this on every layout render might be heavy.
  // We'll record it.
  recordAccessLog({
    ip,
    method: "GET",
    path: "PAGE_VIEW", // Not easy to get full path in layout
    status: 200,
    duration: 0,
    user_agent: headersList.get("user-agent") || ""
  }).catch(console.error);
  return (
    <html lang="en">
      <body className={`antialiased font-sans`}>
        <ThemeProvider
          attribute="class"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
        >
          <SchedulerInit />
          <WeatherProvider>
            <DeviceProvider>
            <EnvironmentAlert />
            <SmoothScroll>
              <PageTransition>
                  {children}
                </PageTransition>
                <ToasterWrapper />
                <MessageNotificationListener />
              </SmoothScroll>
            </DeviceProvider>
          </WeatherProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}

--- FILE: app\login\page.tsx ---

"use client";
import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import Image from "next/image";
import { Facebook, Building2, QrCode } from "lucide-react";
import SplitText from "@/components/ui/split-text";
import TextPressure from "@/components/ui/text-pressure";
import TurnstileWidget from "@/components/ui/turnstile-widget";
function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [turnstileToken, setTurnstileToken] = useState("");
  useEffect(() => {
    const check = async () => {
      try {
        const res = await fetch("/api/auth/me");
        const data = await res.json();
        if (data?.authenticated) router.replace("/monitor");
      } catch {}
    };
    check();
  }, [router]);
  const onSubmit = async () => {
    if (!turnstileToken) {
      setError("请完成验证码验证");
      return;
    }
    setLoading(true);
    setError("");
    try {
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, turnstileToken }),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        setError(data?.error || "登录失败");
        setLoading(false);
        return;
      }
      // 登录成功后，手动刷新页面或跳转
      window.location.href = "/monitor";
    } catch (e) {
      console.error("Login error:", e);
      setError("网络错误");
      setLoading(false);
    }
  };
  return (
    <>
      <div className="h-screen w-full overflow-y-auto bg-background">
        <div className="min-h-full w-full flex items-center justify-center px-6 py-12">
          <div className="grid w-full max-w-6xl grid-cols-1 gap-8 md:grid-cols-2">
        {/* Left: Form */}
        <div className="flex items-center justify-center">
          <Card className="w-full max-w-md border border-[#CFDFE2] shadow-none bg-white relative z-20">
            <CardHeader className="space-y-3">
              <SplitText
                tag="h1"
                text="欢迎回来 "
                className="text-[24px] leading-[1] tracking-[0.01em] text-[#0C1421] font-thin text-center"
                delay={70}
                duration={1}
                ease="power3.out"
                splitType="chars"
              />
              <div className="space-y-1 text-center">
                <div className="flex items-center justify-center">
                  <TextPressure
                    text="STRAVISION"
                    className="text-[32px] font-thin"
                    textColor="#0C1421"
                    alpha
                    scale={false}
                    stroke={false}
                    minFontSize={32}
                  />
                </div>
                <div className="text-[32px] font-bold text-[#0C1421]">莓界</div>
              </div>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="space-y-2">
                <Label htmlFor="email" className="text-[#0C1421]">账户</Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="请输入登录邮箱"
                  className="h-12 rounded-xl bg-[#F7FBFF] placeholder:text-[#8897AD] border-[#D4D7E3]"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="password" className="text-[#0C1421]">密码</Label>
                <Input
                  id="password"
                  type="password"
                  placeholder="请输入密码"
                  className="h-12 rounded-xl bg-[#F7FBFF] placeholder:text-[#8897AD] border-[#D4D7E3]"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
              <TurnstileWidget onVerify={setTurnstileToken} />
              <div className="flex justify-end">
                <Link href="#" className="text-[12px] text-[#1E4AE9]">忘记密码？</Link>
              </div>
              <Button className="w-full h-12 rounded-xl bg-[#162D3A] text-white" onClick={onSubmit} disabled={loading}>
                {loading ? "登录中…" : "登录"}
              </Button>
              {error ? (
                <div className="text-red-600 text-sm">{error}</div>
              ) : null}
              {/* Or divider */}
              <div className="flex items-center gap-4">
                <div className="h-px flex-1 bg-[#CFDFE2]" />
                <span className="text-[16px] text-[#294957]">或者</span>
                <div className="h-px flex-1 bg-[#CFDFE2]" />
              </div>
              {/* Social buttons */}
              <div className="space-y-4">
                <Button
                  variant="secondary"
                  className="w-full justify-center gap-3 rounded-xl bg-[#F3F9FA] text-[#313957] hover:bg-[#E7F1F2]"
                  onClick={() => window.location.href = "/api/auth/alipay/login"}
                >
                  <Image src="/alipay.svg" alt="Alipay" width={24} height={24} className="h-6 w-6" />
                  <span className="text-[16px]">支付宝登录</span>
                </Button>
                <Button variant="secondary" className="w-full justify-center gap-3 rounded-xl bg-[#F3F9FA] text-[#313957] hover:bg-[#E7F1F2]" onClick={() => {
                  window.location.href = "/api/auth/qq/login"
                }}>
                  <svg className="h-6 w-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M824.8 613.2c-16-51.4-34.4-94.6-62.7-165.3C766.5 262.2 689.3 112 511.5 112 331.7 112 256.2 265.2 261 447.9c-28.4 70.8-46.7 113.7-62.7 165.3-34 109.5-23 154.8-14.6 155.8 18 2.2 70.1-82.4 70.1-82.4 0 49 25.2 112.9 79.8 159-26.4 8.1-85.7 29.9-71.6 53.8 11.4 19.3 196.2 12.3 249.5 6.3 53.3 6 238.1 13 249.5-6.3 14.1-23.8-45.2-45.7-71.6-53.8 54.6-46.2 79.8-110.1 79.8-159 0 0 52.1 84.6 70.1 82.4 8.5-1.1 19.5-46.4-14.5-155.8z" fill="#1296db"></path>
                  </svg>
                  <span className="text-[16px]">QQ登录</span>
                </Button>
              </div>
            </CardContent>
            <CardFooter className="flex flex-col items-center gap-2">
              <p className="text-[12px] leading-[1.6] tracking-[0.01em] text-[#122B31] text-center">
                没有账户？ <Link href="/register" className="underline">注册</Link>
              </p>
              <p className="text-[8px] text-[#959CB6]">© 2025 Stravision ALL RIGHTS RESERVED</p>
            </CardFooter>
          </Card>
        </div>
        {/* Right: Art */}
        <div className="hidden md:block relative w-full h-[500px] md:h-auto overflow-hidden rounded-xl bg-[#111827] z-20">
          <div className="absolute inset-0">
            <div className="absolute right-[-20%] top-[-30%] w-[120%] aspect-square rounded-full bg-[#1F2937]/70" />
            <div className="absolute left-[-25%] bottom-[-40%] w-[90%] aspect-square rounded-full bg-[#1F2937]/60" />
            <div className="absolute left-[6%] top-[12%] w-[96px] h-[96px] rounded-full bg-[#1F2937]/70" />
            <div className="absolute left-[10%] top-[55%] w-[320px] h-[320px] rounded-full bg-[#1F2937]/60" />
            <div className="absolute left-[8%] top-[8%] w-[280px] h-[280px] rounded-full bg-[#1F2937]/50" />
            <div className="absolute left-[20%] top-[68%] w-[520px] h-[520px] rounded-full bg-[#1F2937]/40" />
            <div className="absolute left-[8%] top-[12%] text-white">
              <div className="text-[64px] font-bold">莓界</div>
              <SplitText
                tag="div"
                text="STRAVISION"
                className="text-[42px] leading-none tracking-tight font-semibold"
                delay={70}
                duration={0.6}
                ease="power3.out"
                splitType="chars"
                from={{ opacity: 0, y: -20, css: { filter: "blur(8px)" } }}
                to={{ opacity: 1, y: 0, css: { filter: "blur(0px)" } }}
                textAlign="left"
              />
              <div className="mt-4 text-[20px] max-w-[720px]">AI驱动的物联网草莓种植管理平台</div>
            </div>
            <Image src="/logo.svg" alt="logo" width={512} height={20} className="absolute bottom-2 right-0" />
          </div>
        </div>
      </div>
        </div>
      </div>
    </>
  );
}
export default LoginPage;

--- FILE: app\monitor\page.tsx ---

"use client"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import Image from "next/image"
import { PageNavigation } from "@/components/page-navigation"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import { CloudIcon, SunIcon, SparklesIcon, ChartBarIcon, HandRaisedIcon, MagnifyingGlassIcon, Cog6ToothIcon, PlusIcon, FireIcon, BeakerIcon, ExclamationCircleIcon, ArrowTrendingUpIcon, WifiIcon } from "@heroicons/react/24/outline"
import { WifiIcon as WifiOffIcon } from "@heroicons/react/24/solid" // Using solid for off state or just style it differently
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { usePlantGrowth } from "@/lib/hooks/use-plant-growth"
import { HEALTH_STATUS_COLORS } from "@/lib/types/plant-growth-types"
import { useState, useEffect } from "react"
import { useRouter } from "next/navigation"
import type { UserPublic } from "@/lib/db/user-service"
import { ModeToggle } from "@/components/mode-toggle"
import { LiveStreamPlayer } from "@/components/live-stream-player"
import { VideoCameraIcon, SignalIcon } from "@heroicons/react/24/solid"
import { ArrowPathIcon } from "@heroicons/react/24/outline"
import { analyzePlantFromVideo } from "@/lib/utils/plant-analysis-helper"
import { UpdateAnnouncement } from "@/components/update-announcement"
export default function MonitorPage() {
  const router = useRouter()
  // Connect to SSE for real-time device data
  const { deviceData, connectionStatus } = useDeviceData()
  // Use shared weather data from context
  const { weatherData, loading: weatherLoading } = useWeatherContext()
  // Use plant growth data
  const { plantData, lastAnalyzed, loading: plantLoading } = usePlantGrowth()
  // Track EC value history for chart (last 20 data points)
  const [ecHistory, setEcHistory] = useState<number[]>([])
  const [analyzing, setAnalyzing] = useState(false)
  const handleAnalyze = async () => {
    if (analyzing) return
    const videoEl = document.getElementById('monitor-player') as HTMLVideoElement
    if (!videoEl) {
      alert("未找到视频源")
      return
    }
    setAnalyzing(true)
    try {
      // Get API key from settings or use a default/temporary one if needed
      // For now we'll try to get it from localStorage or let the helper handle it
      const settingsStr = localStorage.getItem('ai-settings')
      const settings = settingsStr ? JSON.parse(settingsStr) : null
      const apiKey = settings?.apiKey
      if (!apiKey) {
        alert("请先在设置中配置AI API密钥")
        setAnalyzing(false)
        return
      }
      const result = await analyzePlantFromVideo(videoEl, {
        apiKey,
        model: 'qwen3-vl-plus'
      })
      if (result.success) {
        // alert("分析完成！植株状态已更新")
        // The hook will auto-update the UI via polling
      } else {
        alert(`分析失败: ${result.error}`)
      }
    } catch (error) {
      console.error(error)
      alert("分析过程出错")
    } finally {
      setAnalyzing(false)
    }
  }
  // User authentication state
  const [currentUser, setCurrentUser] = useState<UserPublic | null>(null)
  const [isLoadingUser, setIsLoadingUser] = useState(true)
  // Fetch current user on mount
  useEffect(() => {
    const fetchCurrentUser = async () => {
      try {
        const response = await fetch("/api/auth/me")
        const data = await response.json()
        if (data.authenticated && data.user) {
          setCurrentUser(data.user)
        } else {
          // Not authenticated, redirect to login
          router.push("/login")
        }
      } catch (error) {
        console.error("获取用户信息失败:", error)
        router.push("/login")
      } finally {
        setIsLoadingUser(false)
      }
    }
    fetchCurrentUser()
  }, [router])
  useEffect(() => {
    if (deviceData?.earth_ec !== undefined) {
      setEcHistory(prev => {
        const newHistory = [...prev, deviceData.earth_ec]
        // Keep only last 20 data points
        return newHistory.slice(-20)
      })
    }
  }, [deviceData?.earth_ec])
  // Show loading state while checking authentication
  if (isLoadingUser) {
    return (
      <div className="min-h-screen w-screen h-screen bg-background flex items-center justify-center">
        <div className="text-muted-foreground animate-pulse">加载中...</div>
      </div>
    )
  }
  // Don't render page if no user (will redirect)
  if (!currentUser) {
    return null
  }
  return (
    <>
      <div className="min-h-screen w-screen h-screen bg-background text-foreground transition-colors duration-500 overflow-hidden">
        <UpdateAnnouncement />
        {/* Background Gradients */}
        <div className="fixed inset-0 z-0 pointer-events-none">
          <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] rounded-full bg-primary/10 blur-[120px] animate-[float_10s_ease-in-out_infinite]" />
          <div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] rounded-full bg-purple-500/10 blur-[120px] animate-[float_12s_ease-in-out_infinite_reverse]" />
        </div>
        <div className="relative z-10 grid grid-rows-[72px_1fr] h-full w-full">
          {/* Header */}
          <div className="relative flex items-center px-8 border-b border-border/40 bg-background/60 backdrop-blur-md z-20">
            <div className="flex items-center gap-4">
              <div className="relative size-12 animate-[breathe_4s_ease-in-out_infinite]">
                <Image src="/logo.svg" alt="logo" fill className="object-contain" />
              </div>
              <div className="leading-tight">
                <div className="text-base font-bold tracking-wide">STRAVISION</div>
                <div className="text-xs text-muted-foreground">莓界 · 智慧农业平台</div>
              </div>
            </div>
            <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
              <PageNavigation />
            </div>
            <div className="ml-auto flex items-center gap-3">
              <ModeToggle />
              {connectionStatus.connected ? (
                <Badge variant="outline" className="bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20">
                  <WifiIcon className="size-3 mr-1" />
                  已连接
                </Badge>
              ) : (
                <Badge variant="outline" className="bg-red-500/10 text-red-600 dark:text-red-400 border-red-500/20">
                  <WifiOffIcon className="size-3 mr-1 text-red-500" />
                  {connectionStatus.error || '未连接'}
                </Badge>
              )}
              <UserAvatarMenu user={currentUser} />
            </div>
          </div>
          {/* Main Content */}
          <div className="relative px-4 md:px-8 pb-8 pt-6 overflow-y-auto md:overflow-hidden h-full">
            <div className="grid grid-cols-1 lg:grid-cols-[1fr_440px] gap-8 h-auto lg:h-[calc(100vh-72px-56px)]">
              {/* Left Panel - Live Stream */}
              <div id="monitor-player" className="relative rounded-3xl glass overflow-hidden group">
                <LiveStreamPlayer
                  id="monitor-player"
                  sources={[
                    { src: "webrtc://yidiudiu1.top/live/stravision" },
                    { src: "http://yidiudiu1.top/live/stravision.m3u8" },
                    { src: "http://yidiudiu1.top/live/stravision.flv" }
                  ]}
                  autoplay
                  muted
                  controls
                  className="absolute inset-0 w-full h-full object-cover"
                  poster="/logo.svg"
                />
                {/* Weather Card */}
                {(() => {
                  const getWeatherStyle = (code: number) => {
                    // Sunny / Clear
                    if (code === 1000) return {
                      icon: <SunIcon className="size-6 text-amber-500 animate-[spin_12s_linear_infinite]" />,
                      containerClass: "bg-gradient-to-br from-amber-400/20 to-orange-500/20 border-amber-400/30 shadow-[0_0_30px_rgba(251,191,36,0.2)]",
                      textClass: "text-amber-700 dark:text-amber-100"
                    }
                    // Cloudy / Overcast
                    if ([1003, 1006, 1009].includes(code)) return {
                      icon: <CloudIcon className="size-6 text-blue-400 animate-[pulse_4s_ease-in-out_infinite]" />,
                      containerClass: "bg-gradient-to-br from-blue-400/10 to-slate-500/10 border-blue-400/20",
                      textClass: "text-blue-900 dark:text-blue-100"
                    }
                    // Rain / Drizzle
                    if ([1063, 1180, 1183, 1186, 1189, 1192, 1195, 1240, 1243, 1246].includes(code)) return {
                      icon: <BeakerIcon className="size-6 text-blue-500 animate-[bounce_2s_infinite]" />,
                      containerClass: "bg-gradient-to-br from-blue-600/20 to-indigo-700/20 border-blue-500/30 shadow-[0_0_30px_rgba(59,130,246,0.2)]",
                      textClass: "text-blue-950 dark:text-blue-50"
                    }
                    // Default
                    return {
                      icon: <CloudIcon className="size-6 text-muted-foreground" />,
                      containerClass: "glass",
                      textClass: "text-foreground"
                    }
                  }
                  const weatherStyle = weatherData?.current
                    ? getWeatherStyle(weatherData.current.condition.code)
                    : {
                      icon: <CloudIcon className="size-6 text-muted-foreground" />,
                      containerClass: "glass",
                      textClass: "text-foreground"
                    }
                  return (
                    <Card className={`absolute left-6 bottom-6 w-[320px] rounded-2xl overflow-hidden shadow-2xl transition-all duration-1000 ${weatherStyle.containerClass}`}>
                      <CardContent className="p-5 relative z-10">
                        {weatherLoading ? (
                          <div className="text-muted-foreground text-center py-4">加载天气数据...</div>
                        ) : weatherData?.current ? (
                          <div className="flex items-start justify-between">
                            <div className="space-y-3">
                              <div className="flex items-baseline gap-1">
                                <span className={`text-5xl font-bold animate-[fade-in_0.5s_ease-out] ${weatherStyle.textClass}`}>
                                  {Math.round(weatherData.current.temp_c)}
                                </span>
                                <span className={`text-2xl ${weatherStyle.textClass} opacity-80`}>°C</span>
                              </div>
                              <div className={`space-y-1 text-sm ${weatherStyle.textClass} opacity-80`}>
                                <div className="flex items-center gap-2">
                                  <ArrowTrendingUpIcon className="size-4" />
                                  <span>最高 {Math.round(weatherData.forecast?.forecastday?.[0]?.day?.maxtemp_c || 0)}°C</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <ArrowTrendingUpIcon className="size-4 rotate-180" />
                                  <span>最低 {Math.round(weatherData.forecast?.forecastday?.[0]?.day?.mintemp_c || 0)}°C</span>
                                </div>
                              </div>
                            </div>
                            <div className="text-right space-y-2">
                              <Badge variant="secondary" className="bg-background/20 backdrop-blur-md border-white/10 text-current">
                                {weatherData.location.name === 'Ningbo' ? '宁波' : weatherData.location.name}
                              </Badge>
                              <div className={`flex items-center gap-2 justify-end ${weatherStyle.textClass}`}>
                                {weatherStyle.icon}
                                <span className="text-sm font-medium">{weatherData.current.condition.text}</span>
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="text-muted-foreground text-center py-4">天气数据不可用</div>
                        )}
                      </CardContent>
                    </Card>
                  )
                })()}
                {/* Floating Toolbar */}
                <div className="absolute right-6 bottom-6 flex flex-col items-center gap-3">
                  {[HandRaisedIcon, MagnifyingGlassIcon, Cog6ToothIcon].map((Icon, i) => (
                    <Button key={i} size="icon" variant="secondary" className="size-12 rounded-full shadow-lg hover:scale-110 transition-all duration-300 bg-background/40 backdrop-blur-md border border-border">
                      <Icon className="size-5 text-foreground/80" />
                    </Button>
                  ))}
                  <Button size="icon" className="size-12 rounded-full shadow-lg hover:scale-110 transition-all duration-300 bg-primary hover:bg-primary/90 text-primary-foreground">
                    <PlusIcon className="size-5" />
                  </Button>
                </div>
              </div>
              {/* Right Panel - Data Dashboard */}
              <Card className="h-full rounded-3xl glass shadow-2xl overflow-hidden flex flex-col">
                <CardHeader className="px-6 pt-6 pb-4 space-y-3 shrink-0">
                  <div className="flex items-center justify-between">
                    <CardTitle className="text-xl font-bold text-foreground flex items-center gap-2">
                      <SparklesIcon className="size-5 text-primary" />
                      草莓栽培监测
                    </CardTitle>
                    <Badge variant="outline" className="bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20 animate-pulse">
                      实时数据
                    </Badge>
                  </div>
                  <Separator className="bg-border/50" />
                </CardHeader>
                <CardContent id="monitor-data-grid" className="space-y-5 px-6 pb-6 overflow-y-auto custom-scrollbar">
                  {/* Environment Params */}
                  <Card className="rounded-2xl bg-secondary/30 border-none p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <h3 className="text-foreground/90 font-semibold text-sm">环境参数</h3>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      {[
                        { icon: FireIcon, label: "温度", value: deviceData ? deviceData.temperature.toFixed(1) : '--', unit: "°C", color: "text-orange-500", bg: "bg-orange-500/10" },
                        { icon: FireIcon, label: "土温", value: deviceData ? deviceData.earth_temp.toFixed(1) : '--', unit: "°C", color: "text-red-500", bg: "bg-red-500/10" },
                        { icon: SunIcon, label: "光照", value: deviceData ? deviceData.light : '--', unit: "lux", color: "text-yellow-500", bg: "bg-yellow-500/10" },
                      ].map((item, i) => (
                        <div key={i} className={`rounded-xl p-3 ${item.bg} hover:scale-105 transition-transform duration-300 cursor-default`}>
                          <div className="flex items-center gap-2 mb-2">
                            <item.icon className={`size-4 ${item.color}`} />
                            <span className="text-xs text-muted-foreground font-medium">{item.label}</span>
                          </div>
                          <div className="text-xl font-bold text-foreground">
                            {item.value}<span className="text-xs font-normal text-muted-foreground ml-1">{item.unit}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      {[
                        { icon: CloudIcon, label: "CO₂", value: deviceData ? deviceData.co2 : '--', unit: "ppm", color: "text-cyan-500", bg: "bg-cyan-500/10" },
                        { icon: BeakerIcon, label: "湿度", value: deviceData ? (deviceData.humidity / 10).toFixed(1) : '--', unit: "%", color: "text-blue-500", bg: "bg-blue-500/10" },
                        { icon: BeakerIcon, label: "土湿", value: deviceData ? (deviceData.earth_water / 10).toFixed(1) : '--', unit: "%", color: "text-purple-500", bg: "bg-purple-500/10" },
                      ].map((item, i) => (
                        <div key={i} className={`rounded-xl p-3 ${item.bg} hover:scale-105 transition-transform duration-300 cursor-default`}>
                          <div className="flex items-center gap-2 mb-2">
                            <item.icon className={`size-4 ${item.color}`} />
                            <span className="text-xs text-muted-foreground font-medium">{item.label}</span>
                          </div>
                          <div className="text-lg font-bold text-foreground">
                            {item.value}<span className="text-xs font-normal text-muted-foreground ml-1">{item.unit}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>
                  {/* EC Chart */}
                  <Card className="rounded-2xl bg-secondary/30 border-none p-4">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2 text-foreground/90">
                        <ChartBarIcon className="size-4 text-primary" />
                        <span className="font-semibold text-sm">土壤 EC 值趋势</span>
                      </div>
                      <div className="text-right">
                        <span className="text-2xl font-bold text-primary mr-1">
                          {deviceData ? deviceData.earth_ec : '--'}
                        </span>
                        <span className="text-xs text-muted-foreground">μS/cm</span>
                      </div>
                    </div>
                    <div className="h-[100px] w-full relative">
                      <svg viewBox="0 0 360 100" className="w-full h-full overflow-visible">
                        <defs>
                          <linearGradient id="ecGradient" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stopColor="var(--primary)" stopOpacity="0.3" />
                            <stop offset="100%" stopColor="var(--primary)" stopOpacity="0.0" />
                          </linearGradient>
                        </defs>
                        {ecHistory.length > 1 ? (() => {
                          const maxEc = Math.max(...ecHistory, 1)
                          const minEc = Math.min(...ecHistory, 0)
                          const range = maxEc - minEc || 1
                          const points = ecHistory.map((value, index) => {
                            const x = (index / (ecHistory.length - 1)) * 360
                            const y = 100 - ((value - minEc) / range) * 80
                            return `${x},${y}`
                          }).join(' ')
                          const areaD = `${points} L360,100 L0,100 Z`
                          return (
                            <>
                              <path d={`M${points.replace(/ /g, ' L')}`} fill="none" stroke="var(--primary)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="drop-shadow-md" />
                              <path d={areaD} fill="url(#ecGradient)" />
                            </>
                          )
                        })() : (
                          <text x="180" y="50" textAnchor="middle" fill="currentColor" className="text-muted-foreground text-sm">
                            等待数据...
                          </text>
                        )}
                      </svg>
                    </div>
                  </Card>
                  {/* NPK */}
                  <Card className="rounded-2xl bg-secondary/30 border-none p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2 text-foreground/90">
                        <SparklesIcon className="size-4 text-green-500" />
                        <span className="font-semibold text-sm">土壤养分 (NPK)</span>
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      {[
                        { label: "氮", symbol: "N", value: deviceData ? deviceData.earth_n : '--', color: "bg-purple-500" },
                        { label: "磷", symbol: "P", value: deviceData ? deviceData.earth_p : '--', color: "bg-pink-500" },
                        { label: "钾", symbol: "K", value: deviceData ? deviceData.earth_k : '--', color: "bg-amber-500" },
                      ].map((item, i) => (
                        <div key={i} className="rounded-xl bg-background/50 p-3 flex flex-col items-center gap-2 hover:bg-background/80 transition-colors">
                          <div className={`size-8 rounded-full ${item.color} flex items-center justify-center text-white font-bold text-sm shadow-md`}>
                            {item.symbol}
                          </div>
                          <div className="text-center">
                            <div className="text-lg font-bold text-foreground leading-none mb-1">{item.value}</div>
                            <div className="text-[10px] text-muted-foreground">mg/kg</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>
                  {/* Growth Status */}
                  <Card className="rounded-2xl bg-secondary/30 border-none p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2 text-foreground/90">
                        <SparklesIcon className="size-4 text-green-600" />
                        <span className="font-semibold text-sm">植株生长状态</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Button
                          variant="ghost"
                          size="sm"
                          className="h-6 px-2 text-[10px] text-muted-foreground hover:text-primary"
                          onClick={handleAnalyze}
                          disabled={analyzing}
                        >
                          {analyzing ? (
                            <span className="flex items-center gap-1">
                              <span className="size-2 rounded-full bg-primary animate-pulse" />
                              分析中...
                            </span>
                          ) : (
                            <span className="flex items-center gap-1">
                              <ArrowPathIcon className="size-3" />
                              立即分析
                            </span>
                          )}
                        </Button>
                        <Badge variant="secondary" className="text-xs">
                          {plantData ? `第${plantData.stage}阶段` : '等待数据'}
                        </Badge>
                      </div>
                    </div>
                    <div className="grid grid-cols-6 gap-2">
                      {Array.from({ length: 6 }).map((_, i) => {
                        const isCurrentStage = plantData && i + 1 === plantData.stage
                        const isPastStage = plantData && i + 1 < plantData.stage
                        return (
                          <div
                            key={i}
                            className={`aspect-square rounded-lg border grid place-content-center transition-all group cursor-pointer ${isCurrentStage
                              ? 'bg-green-500/20 border-green-500/50 text-green-600'
                              : isPastStage
                                ? 'bg-green-500/10 border-green-500/30 text-green-500/70'
                                : 'bg-background/50 border-border/50 text-muted-foreground hover:border-green-500/50 hover:text-green-500'
                              }`}
                          >
                            <SparklesIcon className="size-5 group-hover:scale-110 transition-transform" />
                          </div>
                        )
                      })}
                    </div>
                    {plantData && plantData.healthScore && (
                      <div className="flex items-center justify-between px-2 py-1 rounded-lg bg-background/50">
                        <span className="text-xs text-muted-foreground">整体健康度</span>
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-bold text-foreground">{plantData.healthScore}</span>
                          <div className="size-3 rounded-full" style={{ backgroundColor: HEALTH_STATUS_COLORS[plantData.healthStatus] }} />
                        </div>
                      </div>
                    )}
                    {lastAnalyzed && (
                      <div className="text-[10px] text-muted-foreground/70 text-center">
                        上次分析: {new Date(lastAnalyzed).toLocaleString('zh-CN')}
                      </div>
                    )}
                    <Separator className="bg-border/50" />
                    <div>
                      <div className="text-muted-foreground text-xs mb-3">健康度热力图</div>
                      <div className="grid grid-cols-6 gap-2">
                        {(plantData?.heatmap || [75, 75, 75, 75, 75, 75]).map((score, i) => {
                          const status = score >= 90 ? 'excellent' : score >= 75 ? 'good' : score >= 60 ? 'normal' : score >= 45 ? 'attention' : score >= 30 ? 'warning' : 'critical'
                          const color = HEALTH_STATUS_COLORS[status]
                          const labels = ['优秀', '良好', '正常', '注意', '警告', '异常']
                          const label = labels[['excellent', 'good', 'normal', 'attention', 'warning', 'critical'].indexOf(status)]
                          return (
                            <div
                              key={i}
                              className="aspect-square rounded-lg hover:scale-110 transition-all cursor-pointer relative group shadow-sm"
                              style={{ backgroundColor: color }}
                              title={`区域${i + 1}: ${score}分`}
                            >
                              <div className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] text-foreground bg-background/90 px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10 shadow-sm">
                                {label} ({score})
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>
                    {plantLoading && (
                      <div className="text-xs text-muted-foreground text-center py-2">
                        加载中...
                      </div>
                    )}
                  </Card>
                </CardContent>
              </Card>
            </div>
          </div>
        </div>
      </div>
    </>
  )
}

--- FILE: app\page.tsx ---

"use client"
import Link from "next/link"
import Image from "next/image"
import { Menu } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet"
import { HeroSection } from "@/components/landing/hero-section"
import { TechStackSection } from "@/components/landing/tech-stack-section"
import { FeaturesSection } from "@/components/landing/features-section"
import { SmartControlSection } from "@/components/landing/smart-control-section"
import { AnytimeControlSection } from "@/components/landing/anytime-control-section"
import { AiChatSection } from "@/components/landing/ai-chat-section"
import { ProductShowcase } from "@/components/landing/product-showcase"
import { Footer } from "@/components/landing/footer"
import { motion, useScroll, useTransform } from "framer-motion"
import { useRef, useEffect, useState } from "react"
export default function LandingPage() {
  const containerRef = useRef<HTMLDivElement>(null)
  const [windowHeight, setWindowHeight] = useState(0)
  const [isMobile, setIsMobile] = useState(false)
  useEffect(() => {
    const handleResize = () => {
      setWindowHeight(window.innerHeight)
      setIsMobile(window.innerWidth < 768)
    }
    // Initial check
    handleResize()
    window.addEventListener("resize", handleResize)
    return () => window.removeEventListener("resize", handleResize)
  }, [])
  const { scrollY } = useScroll({
    target: containerRef,
    offset: ["start start", "end end"]
  })
  // Calculations for Mascot Animation
  // Stage 1: Hero (0 - 100vh) -> Stays centered but moves down slightly
  // Stage 2: Transition to Features (100vh - 150vh) -> Moves to side
  // Stage 3: Stay at Features (150vh - 200vh) -> Stays at side
  // Stage 4: Exit (> 200vh) -> Fades out
  // Note: These values are approximations based on typical section heights.
  // Hero is min-h-[90vh], Features is py-24 (approx 100vh total height with content)
  const vh = windowHeight || 1000 // Fallback
  const mascotX = useTransform(scrollY,
    [0, vh * 0.5, vh * 1.2],
    ["50%", "50%", "15%"] // Moves from center to left side
  )
  const mascotY = useTransform(scrollY,
    [0, vh * 0.5, vh * 1.2],
    ["25vh", "40vh", "115vh"] // Moves down to Features section title level
  )
  const mascotScale = useTransform(scrollY,
    [0, vh * 0.5, vh * 1.2],
    [1, 1.2, 0.6] // Scales up then down to fit as an icon
  )
  const mascotRotate = useTransform(scrollY,
    [0, vh * 1.2],
    [0, 360] // Full rotation
  )
  const mascotOpacity = useTransform(scrollY,
    [vh * 1.8, vh * 2.5],
    [1, 0] // Fades out after Features section
  )
  return (
    <div ref={containerRef} className="min-h-screen bg-[#02040a] text-white selection:bg-blue-500/30 relative">
      {/* Global Mascot - Hidden on mobile to improve performance */}
      {!isMobile && (
        <motion.div
          style={{
            position: "absolute",
            x: "-50%", // Center the element itself
            left: mascotX,
            top: mascotY,
            scale: mascotScale,
            rotate: mascotRotate,
            opacity: mascotOpacity,
            zIndex: 40,
            pointerEvents: "none"
          }}
          className="w-32 h-32 sm:w-40 sm:h-40 fixed" // fixed to viewport, but we control position manually via top/left which framer motion handles
        >
          <div className="absolute inset-0 bg-blue-500/20 blur-[40px] rounded-full" />
          <Image
            src="/logo.gif"
            alt="Stravision Mascot"
            fill
            className="object-contain drop-shadow-[0_0_25px_rgba(59,130,246,0.5)]"
            unoptimized
          />
        </motion.div>
      )}
      {/* Background Gradients */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-900/10 rounded-full blur-[120px]" />
        <div className="absolute bottom-[-20%] left-[20%] right-[20%] h-[500px] bg-blue-600/20 rounded-full blur-[120px]" />
      </div>
      {/* Navigation */}
      <nav className="relative z-50 flex items-center justify-between px-6 py-6 max-w-7xl mx-auto">
        <div className="hidden md:flex items-center gap-8 text-sm font-medium text-gray-400">
          <Link href="#about" className="hover:text-white transition-colors">关于我们</Link>
          <Link href="#technologies" className="hover:text-white transition-colors">核心技术</Link>
          <Link href="#products" className="hover:text-white transition-colors">产品中心</Link>
          <Link href="#discover" className="hover:text-white transition-colors">探索更多</Link>
        </div>
        <div className="flex items-center gap-2">
          <span className="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
            Stravision 莓界
          </span>
        </div>
        <div className="hidden md:flex items-center gap-8 text-sm font-medium">
          <div className="flex items-center gap-6 text-gray-400">
            <Link href="#team" className="hover:text-white transition-colors">团队</Link>
            <Link href="#pricing" className="hover:text-white transition-colors">价格</Link>
            <Link href="#buy" className="hover:text-white transition-colors">订阅服务</Link>
          </div>
          <Link href="/login">
            <Button className="bg-white text-black hover:bg-gray-200 rounded-full px-6 font-semibold">
              立即开始
            </Button>
          </Link>
        </div>
        {/* Mobile Menu */}
        <div className="md:hidden">
          <Sheet>
            <SheetTrigger asChild>
              <Button variant="ghost" size="icon" className="text-white hover:bg-white/10">
                <Menu className="h-6 w-6" />
              </Button>
            </SheetTrigger>
            <SheetContent side="right" className="w-[300px] bg-[#02040a] border-gray-800 text-white p-6">
              <div className="flex flex-col gap-8 mt-8">
                <div className="flex flex-col gap-4 text-lg font-medium text-gray-400">
                  <Link href="#about" className="hover:text-white transition-colors">关于我们</Link>
                  <Link href="#technologies" className="hover:text-white transition-colors">核心技术</Link>
                  <Link href="#products" className="hover:text-white transition-colors">产品中心</Link>
                  <Link href="#discover" className="hover:text-white transition-colors">探索更多</Link>
                  <div className="h-px bg-gray-800 my-2" />
                  <Link href="#team" className="hover:text-white transition-colors">团队</Link>
                  <Link href="#pricing" className="hover:text-white transition-colors">价格</Link>
                  <Link href="#buy" className="hover:text-white transition-colors">订阅服务</Link>
                </div>
                <Link href="/login" className="w-full">
                  <Button className="w-full bg-white text-black hover:bg-gray-200 rounded-full font-semibold">
                    立即开始
                  </Button>
                </Link>
              </div>
            </SheetContent>
          </Sheet>
        </div>
      </nav>
      <main className="relative z-10">
        <HeroSection />
        <FeaturesSection />
        <SmartControlSection />
        <AiChatSection />
        <AnytimeControlSection />
        <ProductShowcase />
        <TechStackSection />
      </main>
      <Footer />
    </div>
  )
}

--- FILE: app\profile\page.tsx ---

"use client"
import { useEffect, useState } from "react"
import { useRouter } from "next/navigation"
import Image from "next/image"
import Link from "next/link"
import { format } from "date-fns"
import { zhCN } from "date-fns/locale"
import {
  User,
  Settings,
  LogOut,
  Shield,
  Smartphone,
  Activity,
  Bell,
  Zap,
  LayoutDashboard,
  Calendar,
  Mail,
  Edit
} from "lucide-react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Switch } from "@/components/ui/switch"
import { Label } from "@/components/ui/label"
import { PageNavigation } from "@/components/page-navigation"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import type { UserPublic } from "@/lib/db/user-service"
import { useDeviceData } from "@/lib/hooks/use-device-data"
export default function ProfilePage() {
  const router = useRouter()
  const [user, setUser] = useState<UserPublic | null>(null)
  const [loading, setLoading] = useState(true)
  const { connectionStatus } = useDeviceData()
  // Local state for features (matching mobile behavior)
  const [notif, setNotif] = useState<{ alerts: boolean; status: boolean; ai: boolean; updates: boolean }>({
    alerts: true, status: true, ai: false, updates: true
  })
  const [activityLog, setActivityLog] = useState<{ ts: number; text: string }[]>([])
  const [devices, setDevices] = useState<{ id: string; name: string }[]>([])
  useEffect(() => {
    // Fetch user
    const fetchUser = async () => {
      try {
        const res = await fetch("/api/auth/me")
        const data = await res.json()
        if (data?.authenticated && data?.user) {
          setUser(data.user)
          if (data.user.notification_settings) {
            setNotif(data.user.notification_settings)
          }
        } else {
          router.replace("/login")
        }
      } catch {
        router.replace("/login")
      } finally {
        setLoading(false)
      }
    }
    fetchUser()
    // Load local storage data
    try {
      // Notification settings are now loaded from DB
      const as = JSON.parse(localStorage.getItem("profile_activity") || "[]")
      const ds = JSON.parse(localStorage.getItem("profile_devices") || "[]")
      if (Array.isArray(as)) setActivityLog(as)
      if (Array.isArray(ds)) setDevices(ds)
    } catch {}
  }, [router])
  const handleLogout = async () => {
    try {
      await fetch("/api/auth/logout", { method: "POST" })
      router.push("/login")
    } catch (error) {
      console.error("Logout failed", error)
    }
  }
  const persistNotif = (key: keyof typeof notif, value: boolean) => {
    const next = { ...notif, [key]: value }
    setNotif(next)
    try {
      localStorage.setItem("profile_notifications", JSON.stringify(next))
      addActivity(`更新通知设置: ${key} ${value ? "开启" : "关闭"}`)
    } catch {}
  }
  const addActivity = (text: string) => {
    const item = { ts: Date.now(), text }
    const next = [item, ...activityLog].slice(0, 20)
    setActivityLog(next)
    try { localStorage.setItem("profile_activity", JSON.stringify(next)) } catch {}
  }
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="text-muted-foreground animate-pulse">加载用户信息...</div>
      </div>
    )
  }
  if (!user) return null
  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="border-b border-border/40 bg-background/60 backdrop-blur-md sticky top-0 z-50">
        <div className="flex h-16 items-center px-8 justify-between">
          <div className="flex items-center gap-6">
            <Link href="/monitor" className="flex items-center gap-2 hover:opacity-80 transition-opacity">
              <div className="relative size-8">
                <Image src="/logo.svg" alt="logo" fill className="object-contain" />
              </div>
              <span className="font-bold text-lg tracking-tight hidden md:block">STRAVISION</span>
            </Link>
            <PageNavigation />
          </div>
          <UserAvatarMenu user={user} />
        </div>
      </div>
      <main className="container mx-auto px-4 py-8 max-w-6xl">
        <div className="grid grid-cols-1 md:grid-cols-12 gap-8">
          {/* Left Sidebar: Profile Card */}
          <div className="md:col-span-4 lg:col-span-3 space-y-6">
            <Card className="overflow-hidden border-border/50 shadow-sm">
              <div className="h-32 bg-gradient-to-br from-blue-500/20 to-purple-500/20 relative">
                {/* Decorative pattern */}
                <div className="absolute inset-0 opacity-20 bg-[radial-gradient(#444cf7_1px,transparent_1px)] [background-size:16px_16px]" />
              </div>
              <CardContent className="pt-0 relative">
                <div className="flex justify-center -mt-16 mb-4">
                  <Avatar className="size-32 border-4 border-background shadow-xl">
                    <AvatarImage src={user.avatar_url || undefined} />
                    <AvatarFallback className="text-4xl bg-muted text-muted-foreground">
                      {user.username.charAt(0).toUpperCase()}
                    </AvatarFallback>
                  </Avatar>
                </div>
                <div className="text-center mb-6">
                  <h2 className="text-2xl font-bold text-foreground">{user.username}</h2>
                  <p className="text-muted-foreground text-sm flex items-center justify-center gap-1 mt-1">
                    <Mail size={14} /> {user.email}
                  </p>
                </div>
                <div className="space-y-4">
                  <div className="flex justify-between items-center py-2 border-b border-border/50">
                    <span className="text-sm text-muted-foreground flex items-center gap-2">
                      <Shield size={16} /> 角色
                    </span>
                    <Badge variant="outline" className="bg-primary/5 text-primary border-primary/20">
                      {user.role === 'super_admin' ? '超级管理员' : user.role === 'admin' ? '管理员' : '普通用户'}
                    </Badge>
                  </div>
                  <div className="flex justify-between items-center py-2 border-b border-border/50">
                    <span className="text-sm text-muted-foreground flex items-center gap-2">
                      <Calendar size={16} /> 加入时间
                    </span>
                    <span className="text-sm font-medium">
                      {format(new Date(user.created_at), "yyyy-MM-dd")}
                    </span>
                  </div>
                </div>
                <div className="mt-8 grid grid-cols-2 gap-3">
                  <Button variant="outline" className="w-full" asChild>
                    <Link href="/settings">
                      <Edit className="mr-2 size-4" /> 编辑
                    </Link>
                  </Button>
                  <Button variant="destructive" className="w-full bg-red-500/10 text-red-500 hover:bg-red-500/20 border-red-500/20" onClick={handleLogout}>
                    <LogOut className="mr-2 size-4" /> 登出
                  </Button>
                </div>
              </CardContent>
            </Card>
            {/* Quick Stats */}
            <Card className="border-border/50 shadow-sm">
              <CardHeader>
                <CardTitle className="text-base font-medium flex items-center gap-2">
                  <Activity size={18} className="text-blue-500" /> 系统概览
                </CardTitle>
              </CardHeader>
              <CardContent className="grid grid-cols-2 gap-4">
                <div className="bg-muted/50 p-4 rounded-xl text-center">
                  <div className="text-2xl font-bold text-foreground">{devices.length}</div>
                  <div className="text-xs text-muted-foreground mt-1">关联设备</div>
                </div>
                <div className="bg-muted/50 p-4 rounded-xl text-center">
                  <div className="text-2xl font-bold text-green-500">{connectionStatus.connected ? "在线" : "离线"}</div>
                  <div className="text-xs text-muted-foreground mt-1">当前状态</div>
                </div>
              </CardContent>
            </Card>
          </div>
          {/* Right Content: Tabs */}
          <div className="md:col-span-8 lg:col-span-9">
            <Tabs defaultValue="overview" className="space-y-6">
              <TabsList className="bg-muted/50 p-1 border border-border/50">
                <TabsTrigger value="overview" className="px-6">概览</TabsTrigger>
                <TabsTrigger value="activity" className="px-6">活动日志</TabsTrigger>
                <TabsTrigger value="notifications" className="px-6">通知设置</TabsTrigger>
              </TabsList>
              <TabsContent value="overview" className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Device Status */}
                  <Card className="border-border/50 shadow-sm hover:shadow-md transition-shadow">
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <Smartphone className="text-purple-500" /> 设备管理
                      </CardTitle>
                      <CardDescription>当前管理的物联网设备</CardDescription>
                    </CardHeader>
                    <CardContent>
                      {devices.length > 0 ? (
                        <div className="space-y-3">
                          {devices.map((dev, i) => (
                            <div key={i} className="flex items-center justify-between p-3 bg-muted/30 rounded-lg border border-border/50">
                              <div className="flex items-center gap-3">
                                <div className="size-8 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-500">
                                  <Zap size={16} />
                                </div>
                                <span className="font-medium">{dev.name}</span>
                              </div>
                              <Badge variant="outline" className="text-xs">ID: {dev.id}</Badge>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="text-center py-8 text-muted-foreground">
                          <p>暂无关联设备</p>
                          <Button variant="link" className="text-primary mt-2">前往监控页添加</Button>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                  {/* System Status */}
                  <Card className="border-border/50 shadow-sm hover:shadow-md transition-shadow">
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <Shield className="text-green-500" /> 安全中心
                      </CardTitle>
                      <CardDescription>账户与系统安全状态</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="flex items-center justify-between">
                        <span className="text-sm">密码强度</span>
                        <div className="flex gap-1">
                          <div className="w-8 h-2 rounded-full bg-green-500" />
                          <div className="w-8 h-2 rounded-full bg-green-500" />
                          <div className="w-8 h-2 rounded-full bg-green-500" />
                        </div>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm">MFA 验证</span>
                        <Badge variant="secondary" className="text-muted-foreground">未开启</Badge>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-sm">上次登录</span>
                        <span className="text-sm text-muted-foreground">刚刚</span>
                      </div>
                    </CardContent>
                  </Card>
                </div>
              </TabsContent>
              <TabsContent value="activity" className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <Card className="border-border/50 shadow-sm">
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Activity className="text-orange-500" /> 最近活动
                    </CardTitle>
                    <CardDescription>过去 30 天内的操作记录</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-6 relative pl-2">
                      <div className="absolute left-[19px] top-2 bottom-2 w-px bg-border/60" />
                      {activityLog.length > 0 ? (
                        activityLog.map((log, i) => (
                          <div key={i} className="relative flex gap-4 items-start group">
                            <div className="z-10 size-10 rounded-full bg-background border border-border flex items-center justify-center shrink-0 group-hover:border-primary/50 transition-colors">
                              <div className="size-2.5 rounded-full bg-muted-foreground/30 group-hover:bg-primary transition-colors" />
                            </div>
                            <div className="pt-2 pb-1">
                              <p className="font-medium text-sm text-foreground">{log.text}</p>
                              <p className="text-xs text-muted-foreground mt-0.5">
                                {format(new Date(log.ts), "yyyy年MM月dd日 HH:mm:ss", { locale: zhCN })}
                              </p>
                            </div>
                          </div>
                        ))
                      ) : (
                        <div className="text-center py-12 text-muted-foreground">暂无活动记录</div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
              <TabsContent value="notifications" className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <Card className="border-border/50 shadow-sm">
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Bell className="text-yellow-500" /> 通知偏好
                    </CardTitle>
                    <CardDescription>管理您希望接收的消息类型</CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-6">
                    <div className="flex items-center justify-between p-4 bg-muted/30 rounded-xl border border-border/50">
                      <div className="space-y-0.5">
                        <Label className="text-base font-medium">重要告警</Label>
                        <p className="text-sm text-muted-foreground">接收设备离线、异常状态等紧急通知</p>
                      </div>
                      <Switch
                        checked={notif.alerts}
                        onCheckedChange={(v) => persistNotif("alerts", v)}
                      />
                    </div>
                    <div className="flex items-center justify-between p-4 bg-muted/30 rounded-xl border border-border/50">
                      <div className="space-y-0.5">
                        <Label className="text-base font-medium">设备状态</Label>
                        <p className="text-sm text-muted-foreground">接收设备开关、参数调整等操作反馈</p>
                      </div>
                      <Switch
                        checked={notif.status}
                        onCheckedChange={(v) => persistNotif("status", v)}
                      />
                    </div>
                    <div className="flex items-center justify-between p-4 bg-muted/30 rounded-xl border border-border/50">
                      <div className="space-y-0.5">
                        <Label className="text-base font-medium">AI 建议</Label>
                        <p className="text-sm text-muted-foreground">接收来自 AI 助手的种植优化建议</p>
                      </div>
                      <Switch
                        checked={notif.ai}
                        onCheckedChange={(v) => persistNotif("ai", v)}
                      />
                    </div>
                    <div className="flex items-center justify-between p-4 bg-muted/30 rounded-xl border border-border/50">
                      <div className="space-y-0.5">
                        <Label className="text-base font-medium">系统更新</Label>
                        <p className="text-sm text-muted-foreground">接收平台功能更新与维护通知</p>
                      </div>
                      <Switch
                        checked={notif.updates}
                        onCheckedChange={(v) => persistNotif("updates", v)}
                      />
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>
          </div>
        </div>
      </main>
    </div>
  )
}

--- FILE: app\register\page.tsx ---

"use client";
import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import Image from "next/image";
import { Facebook, Mail } from "lucide-react";
import SplitText from "@/components/ui/split-text";
import TextPressure from "@/components/ui/text-pressure";
import TurnstileWidget from "@/components/ui/turnstile-widget";
import { useRouter } from "next/navigation";
import { useState } from "react";
export default function RegisterPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [emailError, setEmailError] = useState("");
  const [usernameError, setUsernameError] = useState("");
  const [passwordError, setPasswordError] = useState("");
  const [turnstileToken, setTurnstileToken] = useState("");
  const validateEmail = (value: string) => {
    if (!value) {
      setEmailError("邮箱不能为空");
      return false;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
      setEmailError("邮箱格式不正确");
      return false;
    }
    setEmailError("");
    return true;
  };
  const validateUsername = (value: string) => {
    if (!value) {
      setUsernameError("用户名不能为空");
      return false;
    }
    if (value.length < 2 || value.length > 20) {
      setUsernameError("用户名长度需在2-20个字符之间");
      return false;
    }
    setUsernameError("");
    return true;
  };
  const validatePassword = (value: string) => {
    if (!value) {
      setPasswordError("密码不能为空");
      return false;
    }
    if (value.length < 8) {
      setPasswordError("密码至少需要8个字符");
      return false;
    }
    setPasswordError("");
    return true;
  };
  const onSubmit = async () => {
    // Validate all fields
    const isEmailValid = validateEmail(email);
    const isUsernameValid = validateUsername(username);
    const isPasswordValid = validatePassword(password);
    if (!isEmailValid || !isUsernameValid || !isPasswordValid) {
      return;
    }
    if (!turnstileToken) {
      setError("请完成验证码验证");
      return;
    }
    setLoading(true);
    setError("");
    try {
      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, username, password, turnstileToken }),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        setError(data?.error || "注册失败");
        setLoading(false);
        return;
      }
      router.replace("/monitor");
    } catch {
      setError("网络错误");
      setLoading(false);
    }
  };
  return (
    <>
      <div className="h-screen w-full overflow-y-auto bg-background">
        <div className="min-h-full w-full flex items-center justify-center px-6 py-12">
          <div className="grid w-full max-w-6xl grid-cols-1 gap-8 md:grid-cols-2">
        <div className="flex items-center justify-center">
          <Card className="w-full max-w-md border border-[#CFDFE2] shadow-none bg-white relative z-20">
            <CardHeader className="space-y-3">
              <SplitText
                tag="h1"
                text="注册 "
                className="text-[24px] leading-[1] tracking-[0.01em] text-[#0C1421] font-thin text-center"
                delay={70}
                duration={1}
                ease="power3.out"
                splitType="chars"
              />
              <div className="space-y-1 text-center">
                <div className="flex items-center justify-center">
                  <TextPressure
                    text="STRAVISION"
                    className="text-[32px] font-thin"
                    textColor="#0C1421"
                    alpha
                    scale={false}
                    stroke={false}
                    minFontSize={32}
                  />
                </div>
                <div className="text-[32px] font-bold text-[#0C1421]">莓界</div>
              </div>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="space-y-2">
                <Label htmlFor="email" className="text-[#0C1421]">账户</Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="请输入登录邮箱"
                  className="h-12 rounded-xl bg-[#F7FBFF] placeholder:text-[#8897AD] border-[#D4D7E3]"
                  value={email}
                  onChange={(e) => {
                    setEmail(e.target.value);
                    if (emailError) validateEmail(e.target.value);
                  }}
                  onBlur={(e) => validateEmail(e.target.value)}
                />
                {emailError && <p className="text-sm text-red-600">{emailError}</p>}
              </div>
              <div className="space-y-2">
                <Label htmlFor="username" className="text-[#0C1421]">用户名</Label>
                <Input
                  id="username"
                  type="text"
                  placeholder="请输入用户名(2-20个字符)"
                  className="h-12 rounded-xl bg-[#F7FBFF] placeholder:text-[#8897AD] border-[#D4D7E3]"
                  value={username}
                  onChange={(e) => {
                    setUsername(e.target.value);
                    if (usernameError) validateUsername(e.target.value);
                  }}
                  onBlur={(e) => validateUsername(e.target.value)}
                />
                {usernameError && <p className="text-sm text-red-600">{usernameError}</p>}
              </div>
              <div className="space-y-2">
                <Label htmlFor="password" className="text-[#0C1421]">密码</Label>
                <Input
                  id="password"
                  type="password"
                  placeholder="请输入密码(至少8个字符)"
                  className="h-12 rounded-xl bg-[#F7FBFF] placeholder:text-[#8897AD] border-[#D4D7E3]"
                  value={password}
                  onChange={(e) => {
                    setPassword(e.target.value);
                    if (passwordError) validatePassword(e.target.value);
                  }}
                  onBlur={(e) => validatePassword(e.target.value)}
                />
                {passwordError && <p className="text-sm text-red-600">{passwordError}</p>}
              </div>
              <TurnstileWidget onVerify={setTurnstileToken} />
              <Button className="w-full h-12 rounded-xl bg-[#162D3A] text-white" onClick={onSubmit} disabled={loading}>
                {loading ? "注册中…" : "注册"}
              </Button>
              {error ? (
                <div className="text-red-600 text-sm">{error}</div>
              ) : null}
              <div className="flex items-center gap-4">
                <div className="h-px flex-1 bg-[#CFDFE2]" />
                <span className="text-[16px] text-[#294957]">或者</span>
                <div className="h-px flex-1 bg-[#CFDFE2]" />
              </div>
              <div className="space-y-4">
                <Button variant="secondary" className="w-full justify-center gap-3 rounded-xl bg-[#F3F9FA] text-[#313957] hover:bg-[#E7F1F2]">
                  <Mail className="h-6 w-6 text-[#4285F4]" />
                  <span className="text-[16px]">使用微信注册</span>
                </Button>
                <Button variant="secondary" className="w-full justify-center gap-3 rounded-xl bg-[#F3F9FA] text-[#313957] hover:bg-[#E7F1F2]">
                  <Facebook className="h-6 w-6 text-[#1877F2]" />
                  <span className="text-[16px]">使用企业微信注册</span>
                </Button>
              </div>
            </CardContent>
            <CardFooter className="flex flex-col items-center gap-2">
              <p className="text-[12px] leading-[1.6] tracking-[0.01em] text-[#122B31] text-center">
                已有账户？ <Link href="/login" className="underline">登录</Link>
              </p>
              <p className="text-[8px] text-[#959CB6]">© 2025 Stravision ALL RIGHTS RESERVED</p>
            </CardFooter>
          </Card>
        </div>
        <div className="hidden md:block relative w-full h-[500px] md:h-auto overflow-hidden rounded-xl bg-[#111827] z-20">
          <div className="absolute inset-0">
            <div className="absolute right-[-20%] top-[-30%] w-[120%] aspect-square rounded-full bg-[#1F2937]/70" />
            <div className="absolute left-[-25%] bottom-[-40%] w-[90%] aspect-square rounded-full bg-[#1F2937]/60" />
            <div className="absolute left-[6%] top-[12%] w-[96px] h-[96px] rounded-full bg-[#1F2937]/70" />
            <div className="absolute left-[10%] top-[55%] w-[320px] h-[320px] rounded-full bg-[#1F2937]/60" />
            <div className="absolute left-[8%] top-[8%] w-[280px] h-[280px] rounded-full bg-[#1F2937]/50" />
            <div className="absolute left-[20%] top-[68%] w-[520px] h-[520px] rounded-full bg-[#1F2937]/40" />
            <div className="absolute left-[8%] top-[12%] text-white">
              <div className="text-[64px] font-bold">莓界</div>
              <SplitText
                tag="div"
                text="STRAVISION"
                className="text-[42px] leading-none tracking-tight font-semibold"
                delay={70}
                duration={0.6}
                ease="power3.out"
                splitType="chars"
                from={{ opacity: 0, y: -20, css: { filter: "blur(8px)" } }}
                to={{ opacity: 1, y: 0, css: { filter: "blur(0px)" } }}
                textAlign="left"
              />
              <div className="mt-4 text-[20px] max-w-[720px]">AI驱动的物联网草莓种植管理平台</div>
            </div>
            <Image src="/logo.svg" alt="logo" width={512} height={20} className="absolute bottom-2 right-0" />
          </div>
        </div>
        </div>
        </div>
      </div>
    </>
  );
}

--- FILE: app\settings\page.tsx ---

"use client"
import { useState, useEffect, useRef } from "react"
import { useRouter } from "next/navigation"
import Image from "next/image"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Badge } from "@/components/ui/badge"
import { PageNavigation } from "@/components/page-navigation"
import { UserAvatarMenu } from "@/components/user-avatar-menu"
import { Wifi, WifiOff, Save, ArrowLeft, Upload, X } from "lucide-react"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import type { UserPublic } from "@/lib/db/user-service"
export default function SettingsPage() {
  const router = useRouter()
  const { connectionStatus } = useDeviceData()
  // User authentication state
  const [currentUser, setCurrentUser] = useState<UserPublic | null>(null)
  const [isLoadingUser, setIsLoadingUser] = useState(true)
  // Form state
  const [username, setUsername] = useState("")
  const [email, setEmail] = useState("")
  const [avatarUrl, setAvatarUrl] = useState("")
  const [isSaving, setIsSaving] = useState(false)
  const [isUploading, setIsUploading] = useState(false)
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(null)
  const [previewUrl, setPreviewUrl] = useState<string | null>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  // Fetch current user on mount
  useEffect(() => {
    const fetchCurrentUser = async () => {
      try {
        const response = await fetch("/api/auth/me")
        const data = await response.json()
        if (data.authenticated && data.user) {
          setCurrentUser(data.user)
          setUsername(data.user.username)
          setEmail(data.user.email)
          setAvatarUrl(data.user.avatar_url || "")
        } else {
          router.push("/login")
        }
      } catch (error) {
        console.error("获取用户信息失败:", error)
        router.push("/login")
      } finally {
        setIsLoadingUser(false)
      }
    }
    fetchCurrentUser()
  }, [router])
  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    // 验证文件类型
    const allowedTypes = ["image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp"]
    if (!allowedTypes.includes(file.type)) {
      setMessage({ type: "error", text: "只支持 JPG、PNG、GIF 和 WebP 格式的图片" })
      return
    }
    // 验证文件大小（最大 5MB）
    const maxSize = 5 * 1024 * 1024
    if (file.size > maxSize) {
      setMessage({ type: "error", text: "文件大小不能超过 5MB" })
      return
    }
    setMessage(null)
    setIsUploading(true)
    try {
      // 创建预览
      const reader = new FileReader()
      reader.onloadend = () => {
        setPreviewUrl(reader.result as string)
      }
      reader.readAsDataURL(file)
      // 上传文件
      const formData = new FormData()
      formData.append("avatar", file)
      const response = await fetch("/api/user/upload-avatar", {
        method: "POST",
        body: formData,
      })
      const data = await response.json()
      if (response.ok) {
        setAvatarUrl(data.avatar_url)
        setMessage({ type: "success", text: "头像上传成功！请点击保存更改" })
      } else {
        setMessage({ type: "error", text: data.error || "上传失败，请重试" })
        setPreviewUrl(null)
      }
    } catch (error) {
      console.error("上传失败:", error)
      setMessage({ type: "error", text: "网络错误，请重试" })
      setPreviewUrl(null)
    } finally {
      setIsUploading(false)
    }
  }
  const handleRemoveAvatar = () => {
    setAvatarUrl("")
    setPreviewUrl(null)
    if (fileInputRef.current) {
      fileInputRef.current.value = ""
    }
  }
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    setMessage(null)
    setIsSaving(true)
    try {
      const response = await fetch("/api/user/update", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username.trim(),
          avatar_url: avatarUrl.trim() || null,
        }),
      })
      const data = await response.json()
      if (response.ok) {
        setCurrentUser(data.user)
        setPreviewUrl(null)
        setMessage({ type: "success", text: "个人信息更新成功！" })
      } else {
        setMessage({ type: "error", text: data.error || "更新失败，请重试" })
      }
    } catch (error) {
      console.error("更新失败:", error)
      setMessage({ type: "error", text: "网络错误，请重试" })
    } finally {
      setIsSaving(false)
    }
  }
  // Show loading state while checking authentication
  if (isLoadingUser) {
    return (
      <div className="min-h-screen w-screen h-screen bg-background text-foreground flex items-center justify-center">
        <div className="text-muted-foreground">加载中...</div>
      </div>
    )
  }
  // Don't render page if no user (will redirect)
  if (!currentUser) {
    return null
  }
  return (
    <div className="min-h-screen w-screen h-screen bg-background dark:bg-[#0B1121] text-foreground transition-colors duration-500">
      {/* Background blobs for mobile/desktop style consistency */}
      <div className="fixed top-[-20%] right-[-20%] w-[80%] h-[60%] rounded-full bg-blue-200/20 dark:bg-blue-900/10 blur-[100px] pointer-events-none" />
      <div className="fixed top-[20%] left-[-20%] w-[60%] h-[60%] rounded-full bg-indigo-200/20 dark:bg-indigo-900/10 blur-[100px] pointer-events-none" />
      <div className="relative z-10 grid grid-rows-[72px_1fr] h-full w-full">
        {/* Header */}
        <div className="relative flex items-center px-8 border-b border-border bg-background/50 dark:bg-[#111827]/50 backdrop-blur-xl">
          <div className="flex items-center gap-4 text-foreground">
            <Image src="/logo.svg" alt="logo" width={64} height={64} className="hidden md:block" />
            <div className="leading-tight hidden md:block">
              <div className="text-base font-bold tracking-wide">STRAVISION</div>
              <div className="text-xs text-muted-foreground">莓界 · 智慧农业平台</div>
            </div>
            {/* Mobile Title */}
            <div className="md:hidden text-lg font-bold">编辑资料</div>
          </div>
          <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 hidden md:block">
            <PageNavigation />
          </div>
          <div className="ml-auto flex items-center gap-3">
            <div className="hidden md:flex items-center gap-3">
              {connectionStatus.connected ? (
                <Badge className="bg-green-500/20 text-green-300 border-green-500/30 hover:bg-green-500/30">
                  <Wifi className="size-3 mr-1" />
                  已连接
                </Badge>
              ) : (
                <Badge className="bg-red-500/20 text-red-300 border-red-500/30 hover:bg-red-500/30">
                  <WifiOff className="size-3 mr-1" />
                  {connectionStatus.error || '未连接'}
                </Badge>
              )}
              {connectionStatus.lastUpdate && (
                <span className="text-xs text-muted-foreground/60">
                  更新: {connectionStatus.lastUpdate.toLocaleTimeString()}
                </span>
              )}
            </div>
            <UserAvatarMenu user={currentUser} />
          </div>
        </div>
        {/* Content */}
        <div className="relative px-4 md:px-8 pb-8 pt-6 overflow-auto">
          <div className="max-w-2xl mx-auto">
            {/* Back Button */}
            <Button
              variant="ghost"
              onClick={() => router.back()}
              className="mb-6 text-muted-foreground hover:text-foreground hover:bg-accent/50"
            >
              <ArrowLeft className="mr-2 size-4" />
              返回
            </Button>
            <Card className="rounded-2xl bg-white/70 dark:bg-[#111827]/70 backdrop-blur-xl border border-white/20 dark:border-white/5 text-foreground shadow-sm">
              <CardHeader>
                <CardTitle className="text-2xl font-bold">个人设置</CardTitle>
                <p className="text-sm text-muted-foreground mt-2">
                  管理您的个人信息和账户设置
                </p>
              </CardHeader>
              <CardContent>
                <form onSubmit={handleSave} className="space-y-6">
                  {/* Message */}
                  {message && (
                    <div
                      className={`p-4 rounded-lg ${message.type === "success"
                          ? "bg-green-500/20 text-green-300 border border-green-500/30"
                          : "bg-red-500/20 text-red-300 border border-red-500/30"
                        }`}
                    >
                      {message.text}
                    </div>
                  )}
                  {/* Email (Read-only) */}
                  <div className="space-y-2">
                    <Label htmlFor="email" className="text-foreground/90">
                      邮箱地址
                    </Label>
                    <Input
                      id="email"
                      type="email"
                      value={email}
                      disabled
                      className="bg-muted/50 dark:bg-black/20 border-border text-muted-foreground cursor-not-allowed"
                    />
                    <p className="text-xs text-muted-foreground/60">
                      邮箱地址不可修改
                    </p>
                  </div>
                  {/* Username */}
                  <div className="space-y-2">
                    <Label htmlFor="username" className="text-foreground/90">
                      用户名 <span className="text-red-400">*</span>
                    </Label>
                    <Input
                      id="username"
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      placeholder="请输入用户名"
                      required
                      minLength={2}
                      maxLength={20}
                      className="bg-muted/50 dark:bg-black/20 border-border text-foreground placeholder:text-muted-foreground focus:border-blue-500/50 focus:ring-blue-500/20"
                    />
                    <p className="text-xs text-muted-foreground/60">
                      2-20个字符
                    </p>
                  </div>
                  {/* Avatar Upload */}
                  <div className="space-y-3">
                    <Label className="text-foreground/90">头像</Label>
                    {/* Avatar Preview */}
                    <div className="flex items-center gap-4 p-4 rounded-lg bg-muted/50 dark:bg-black/20 border border-border">
                      <div className="size-20 rounded-full overflow-hidden bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 border-2 border-white/10">
                        {(previewUrl || avatarUrl) ? (
                          <img
                            src={previewUrl || avatarUrl}
                            alt="Avatar preview"
                            className="size-full object-cover"
                            onError={(e) => {
                              e.currentTarget.style.display = "none"
                            }}
                          />
                        ) : (
                          <span className="text-white font-semibold text-2xl">
                            {username.charAt(0).toUpperCase()}
                          </span>
                        )}
                      </div>
                      <div className="flex-1">
                        <p className="text-sm text-foreground/90 mb-1 font-medium">{username}</p>
                        <p className="text-xs text-muted-foreground mb-3">{email}</p>
                        <div className="flex gap-2">
                          <Button
                            type="button"
                            size="sm"
                            onClick={() => fileInputRef.current?.click()}
                            disabled={isUploading}
                            className="bg-white dark:bg-white/10 hover:bg-gray-100 dark:hover:bg-white/20 text-foreground border border-border shadow-sm"
                          >
                            <Upload className="mr-2 size-3" />
                            {isUploading ? "上传中..." : "上传头像"}
                          </Button>
                          {avatarUrl && (
                            <Button
                              type="button"
                              size="sm"
                              variant="outline"
                              onClick={handleRemoveAvatar}
                              disabled={isUploading}
                              className="border-border text-muted-foreground hover:text-foreground hover:bg-accent/50 bg-transparent"
                            >
                              <X className="mr-2 size-3" />
                              移除
                            </Button>
                          )}
                        </div>
                      </div>
                    </div>
                    {/* Hidden File Input */}
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                      onChange={handleFileSelect}
                      className="hidden"
                    />
                    <p className="text-xs text-muted-foreground/60">
                      支持 JPG、PNG、GIF、WebP 格式，最大 5MB
                    </p>
                  </div>
                  {/* Avatar URL (Optional) */}
                  <div className="space-y-2">
                    <Label htmlFor="avatarUrl" className="text-foreground/90">
                      或使用头像 URL（可选）
                    </Label>
                    <Input
                      id="avatarUrl"
                      type="text"
                      value={avatarUrl}
                      onChange={(e) => setAvatarUrl(e.target.value)}
                      placeholder="https://example.com/avatar.jpg"
                      className="bg-muted/50 dark:bg-black/20 border-border text-foreground placeholder:text-muted-foreground focus:border-blue-500/50 focus:ring-blue-500/20"
                    />
                    <p className="text-xs text-muted-foreground/60">
                      直接输入头像图片链接或相对路径
                    </p>
                  </div>
                  {/* Account Info */}
                  <div className="pt-4 border-t border-border">
                    <h3 className="text-sm font-semibold text-foreground/90 mb-3">
                      账户信息
                    </h3>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">账户创建时间</span>
                        <span className="text-foreground/90">
                          {new Date(currentUser.created_at).toLocaleDateString("zh-CN")}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">用户 ID</span>
                        <span className="text-foreground/90 font-mono">#{currentUser.id}</span>
                      </div>
                    </div>
                  </div>
                  {/* Save Button */}
                  <div className="flex gap-3 pt-4 sticky bottom-0 bg-background/80 dark:bg-[#0B1121]/80 backdrop-blur-md p-4 -mx-6 -mb-6 mt-6 border-t border-border md:static md:bg-transparent md:p-0 md:m-0 md:border-none">
                    <Button
                      type="submit"
                      disabled={isSaving}
                      className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white shadow-lg shadow-blue-500/20 rounded-xl"
                    >
                      <Save className="mr-2 size-4" />
                      {isSaving ? "保存中..." : "保存更改"}
                    </Button>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => router.back()}
                      className="border-border text-muted-foreground hover:text-foreground hover:bg-accent/50 bg-transparent rounded-xl"
                    >
                      取消
                    </Button>
                  </div>
                </form>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: app\super-secure-admin-entry\page.tsx ---

"use client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import TurnstileWidget from "@/components/ui/turnstile-widget";
import { useRouter } from "next/navigation";
import { useState } from "react";
import { ShieldAlert, Lock } from "lucide-react";
import { toast } from "sonner";
export default function AdminLoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [turnstileToken, setTurnstileToken] = useState("");
  const [loading, setLoading] = useState(false);
  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!turnstileToken) {
      toast.error("Security Verification Required");
      return;
    }
    setLoading(true);
    try {
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, turnstileToken }),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        toast.error(data?.error || "Access Denied");
        setLoading(false);
        return;
      }
      // Check if user is actually admin
      const meRes = await fetch("/api/auth/me");
      const meData = await meRes.json();
      if (meData.authenticated && (meData.user.role === 'admin' || meData.user.role === 'super_admin')) {
        toast.success("Welcome back, Administrator");
        // Use window.location to force full reload and bypass middleware caching
        window.location.href = "/admin";
      } else {
        toast.error("Unauthorized: Admin privileges required");
        // Logout if not admin
        await fetch("/api/auth/logout", { method: "POST" });
        setLoading(false);
      }
    } catch (e) {
      console.error("Login error:", e);
      toast.error("Connection Error");
      setLoading(false);
    }
  };
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-black/95 p-4">
      <Card className="w-full max-w-md border-red-900/30 bg-black text-red-500 shadow-2xl shadow-red-900/20">
        <CardHeader className="space-y-1 text-center border-b border-red-900/30 pb-6">
          <div className="flex justify-center mb-4">
            <div className="p-3 rounded-full bg-red-950/30 border border-red-900/50">
              <ShieldAlert className="h-8 w-8 text-red-600" />
            </div>
          </div>
          <CardTitle className="text-xl font-mono tracking-widest text-red-600 uppercase">
            Restricted Access
          </CardTitle>
          <p className="text-xs text-red-800 font-mono">
            Authorized Personnel Only
          </p>
        </CardHeader>
        <CardContent className="space-y-6 pt-6">
          <form onSubmit={onSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email" className="text-red-700 font-mono text-xs uppercase">Identity</Label>
              <div className="relative">
                <Input
                  id="email"
                  type="email"
                  placeholder="admin@system.local"
                  className="bg-black border-red-900/50 text-red-500 placeholder:text-red-900/50 focus-visible:ring-red-900 font-mono pl-10"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  autoComplete="off"
                />
                <Lock className="absolute left-3 top-2.5 h-4 w-4 text-red-900" />
              </div>
            </div>
            <div className="space-y-2">
              <Label htmlFor="password" className="text-red-700 font-mono text-xs uppercase">Passcode</Label>
              <Input
                id="password"
                type="password"
                className="bg-black border-red-900/50 text-red-500 focus-visible:ring-red-900 font-mono"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>
            <TurnstileWidget onVerify={setTurnstileToken} theme="dark" />
            <Button
              type="submit"
              className="w-full bg-red-950 hover:bg-red-900 text-red-500 border border-red-900/50 font-mono uppercase tracking-wider"
              disabled={loading}
            >
              {loading ? "Verifying..." : "Authenticate"}
            </Button>
          </form>
          <div className="text-[10px] text-red-900/50 font-mono text-center pt-4">
            SYSTEM ID: {Math.random().toString(36).substring(7).toUpperCase()}
            <br/>
            IP LOGGED AND MONITORED
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

--- FILE: app\too-many-requests\page.tsx ---

import { Button } from "@/components/ui/button"
import Link from "next/link"
export default function TooManyRequestsPage() {
  return (
    <div className="flex min-h-screen flex-col items-center justify-center bg-background px-4 text-center">
      <div className="space-y-4">
        <h1 className="text-4xl font-extrabold tracking-tight lg:text-5xl text-primary">
          429
        </h1>
        <h2 className="text-2xl font-semibold tracking-tight">
          请求过于频繁 (Too Many Requests)
        </h2>
        <p className="text-muted-foreground max-w-[500px]">
          我们检测到您的请求过于频繁。为了系统的稳定，请稍作休息后再试。
          <br />
          Please wait a moment before trying again.
        </p>
        <div className="flex justify-center gap-4 pt-4">
          <Button asChild variant="outline">
            <Link href="/">返回首页 (Go Home)</Link>
          </Button>
        </div>
      </div>
    </div>
  )
}

--- FILE: components\admin\access-logs-viewer.tsx ---

"use client"
import { useState, useEffect } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Button } from "@/components/ui/button"
import { RefreshCcw } from "lucide-react"
import { AccessLog } from "@/lib/db/security-service"
import { format } from "date-fns"
export function AccessLogsViewer() {
  const [logs, setLogs] = useState<AccessLog[]>([])
  const [loading, setLoading] = useState(false)
  const fetchLogs = async () => {
    setLoading(true)
    try {
      const res = await fetch("/api/admin/access-logs?limit=50")
      if (res.ok) {
        const data = await res.json()
        setLogs(data)
      }
    } catch (error) {
      console.error("Failed to fetch logs", error)
    } finally {
      setLoading(false)
    }
  }
  useEffect(() => {
    fetchLogs()
  }, [])
  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle>Recent Access Logs</CardTitle>
        <Button variant="outline" size="sm" onClick={fetchLogs} disabled={loading}>
          <RefreshCcw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
          Refresh
        </Button>
      </CardHeader>
      <CardContent>
        <div className="rounded-md border max-h-[400px] overflow-auto">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Time</TableHead>
                <TableHead>IP</TableHead>
                <TableHead>Method</TableHead>
                <TableHead>Path</TableHead>
                <TableHead>Status</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {logs.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={5} className="text-center py-4">No logs found</TableCell>
                </TableRow>
              ) : (
                logs.map((log) => (
                  <TableRow key={log.id}>
                    <TableCell className="whitespace-nowrap">
                      {format(new Date(log.created_at), "MM-dd HH:mm:ss")}
                    </TableCell>
                    <TableCell>{log.ip}</TableCell>
                    <TableCell>{log.method}</TableCell>
                    <TableCell className="max-w-[200px] truncate" title={log.path}>
                      {log.path}
                    </TableCell>
                    <TableCell>
                      <span className={`px-2 py-1 rounded text-xs ${
                        log.status >= 400 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                      }`}>
                        {log.status}
                      </span>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </div>
      </CardContent>
    </Card>
  )
}

--- FILE: components\admin\banned-ips-manager.tsx ---

"use client"
import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Ban, Trash2, ShieldAlert } from "lucide-react"
import { toast } from "sonner"
import { format } from "date-fns"
import { BannedIP } from "@/lib/db/security-service"
export function BannedIPsManager() {
  const [ips, setIps] = useState<BannedIP[]>([])
  const [loading, setLoading] = useState(true)
  const [newIp, setNewIp] = useState("")
  const [reason, setReason] = useState("")
  const [dialogOpen, setDialogOpen] = useState(false)
  const fetchIps = async () => {
    try {
      const res = await fetch("/api/admin/banned-ips")
      if (res.ok) {
        const data = await res.json()
        setIps(data)
      }
    } catch (error) {
      console.error(error)
      toast.error("Failed to load banned IPs")
    } finally {
      setLoading(false)
    }
  }
  useEffect(() => {
    fetchIps()
  }, [])
  const handleBan = async (e: React.FormEvent) => {
    e.preventDefault()
    try {
      const res = await fetch("/api/admin/banned-ips", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ip: newIp, reason }),
      })
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || "Failed to ban IP")
      }
      toast.success("IP banned successfully")
      setNewIp("")
      setReason("")
      setDialogOpen(false)
      fetchIps()
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "Operation failed")
    }
  }
  const handleUnban = async (ip: string) => {
    try {
      const res = await fetch(`/api/admin/banned-ips?ip=${ip}`, {
        method: "DELETE",
      })
      if (!res.ok) throw new Error("Failed to unban IP")
      toast.success("IP unbanned successfully")
      fetchIps()
    } catch (error) {
      toast.error("Failed to unban IP")
    }
  }
  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
           <h2 className="text-lg font-semibold tracking-tight">Security & Banned IPs</h2>
           <p className="text-sm text-muted-foreground">Manage IP blocks and access control.</p>
        </div>
        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
          <DialogTrigger asChild>
            <Button variant="destructive" size="sm">
              <Ban className="mr-2 h-4 w-4" />
              Ban IP
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Ban IP Address</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleBan} className="space-y-4 pt-4">
              <div className="space-y-2">
                <Label htmlFor="ip">IP Address</Label>
                <Input
                  id="ip"
                  placeholder="192.168.1.1"
                  value={newIp}
                  onChange={(e) => setNewIp(e.target.value)}
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="reason">Reason (Optional)</Label>
                <Input
                  id="reason"
                  placeholder="Malicious activity"
                  value={reason}
                  onChange={(e) => setReason(e.target.value)}
                />
              </div>
              <Button type="submit" variant="destructive" className="w-full">
                Confirm Ban
              </Button>
            </form>
          </DialogContent>
        </Dialog>
      </div>
      <div className="rounded-md border bg-card">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>IP Address</TableHead>
              <TableHead>Reason</TableHead>
              <TableHead>Banned By</TableHead>
              <TableHead>Date</TableHead>
              <TableHead className="text-right">Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {ips.length === 0 ? (
              <TableRow>
                <TableCell colSpan={5} className="text-center h-24 text-muted-foreground">
                  No banned IPs found.
                </TableCell>
              </TableRow>
            ) : (
              ips.map((ip) => (
                <TableRow key={ip.id}>
                  <TableCell className="font-mono">{ip.ip}</TableCell>
                  <TableCell>{ip.reason || "-"}</TableCell>
                  <TableCell className="text-muted-foreground text-xs">{ip.banned_by}</TableCell>
                  <TableCell className="text-muted-foreground text-xs">
                    {format(new Date(ip.created_at), "yyyy-MM-dd HH:mm")}
                  </TableCell>
                  <TableCell className="text-right">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleUnban(ip.ip)}
                      className="text-muted-foreground hover:text-foreground"
                    >
                      <Trash2 className="h-4 w-4" />
                      <span className="sr-only">Unban</span>
                    </Button>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>
    </div>
  )
}

--- FILE: components\admin\rate-limit-settings.tsx ---

"use client"
import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { toast } from "sonner"
import { Shield, Save, RefreshCcw } from "lucide-react"
interface RateLimitConfig {
  limit: number
  windowMs: number
  violationLimit: number
  banDuration: number
}
export function RateLimitSettings() {
  const [config, setConfig] = useState<RateLimitConfig | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const fetchConfig = async () => {
    try {
      setLoading(true)
      const res = await fetch("/api/admin/settings/rate-limit")
      if (res.ok) {
        const data = await res.json()
        setConfig(data)
      }
    } catch (error) {
      toast.error("Failed to load settings")
    } finally {
      setLoading(false)
    }
  }
  useEffect(() => {
    fetchConfig()
  }, [])
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!config) return
    try {
      setSaving(true)
      const res = await fetch("/api/admin/settings/rate-limit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config),
      })
      if (!res.ok) {
        throw new Error("Failed to save settings")
      }
      toast.success("Settings saved successfully")
    } catch (error) {
      toast.error("Failed to save settings")
    } finally {
      setSaving(false)
    }
  }
  const handleChange = (key: keyof RateLimitConfig, value: string) => {
    if (!config) return
    const numValue = parseInt(value)
    if (isNaN(numValue)) return
    setConfig({ ...config, [key]: numValue })
  }
  if (loading) return <div>Loading settings...</div>
  if (!config) return <div>Error loading settings</div>
  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Shield className="h-5 w-5 text-primary" />
            <CardTitle>Auto-Ban Thresholds</CardTitle>
          </div>
          <Button variant="ghost" size="sm" onClick={fetchConfig}>
            <RefreshCcw className="h-4 w-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSave} className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="limit">Max Requests (per window)</Label>
              <Input
                id="limit"
                type="number"
                value={config.limit}
                onChange={(e) => handleChange("limit", e.target.value)}
                min={1}
              />
              <p className="text-xs text-muted-foreground">
                Maximum requests allowed before rate limiting triggers.
              </p>
            </div>
            <div className="space-y-2">
              <Label htmlFor="windowMs">Window Duration (ms)</Label>
              <Input
                id="windowMs"
                type="number"
                value={config.windowMs}
                onChange={(e) => handleChange("windowMs", e.target.value)}
                min={1000}
                step={1000}
              />
              <p className="text-xs text-muted-foreground">
                Time window in milliseconds (e.g., 60000 = 1 minute).
              </p>
            </div>
            <div className="space-y-2">
              <Label htmlFor="violationLimit">Violation Limit</Label>
              <Input
                id="violationLimit"
                type="number"
                value={config.violationLimit}
                onChange={(e) => handleChange("violationLimit", e.target.value)}
                min={1}
              />
              <p className="text-xs text-muted-foreground">
                Number of rate limit violations before IP is auto-banned.
              </p>
            </div>
            <div className="space-y-2">
              <Label htmlFor="banDuration">Ban Duration (ms)</Label>
              <Input
                id="banDuration"
                type="number"
                value={config.banDuration}
                onChange={(e) => handleChange("banDuration", e.target.value)}
                min={1000}
                step={1000}
              />
              <p className="text-xs text-muted-foreground">
                How long the IP remains banned (e.g., 86400000 = 24 hours).
              </p>
            </div>
          </div>
          <div className="flex justify-end pt-4">
            <Button type="submit" disabled={saving}>
              <Save className="mr-2 h-4 w-4" />
              {saving ? "Saving..." : "Save Configuration"}
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}

--- FILE: components\admin\user-dialog.tsx ---

"use client"
import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Checkbox } from "@/components/ui/checkbox"
import { UserPublic } from "@/lib/db/user-service"
import { toast } from "sonner"
interface UserDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  user: UserPublic | null // null for create mode
  currentUserRole: string
  onSuccess: () => void
}
const CONTROLS = [
  { id: 'relay5', label: 'Relay 5' },
  { id: 'relay6', label: 'Relay 6' },
  { id: 'relay7', label: 'Relay 7' },
  { id: 'relay8', label: 'Relay 8' },
  { id: 'led1', label: 'LED 1' },
  { id: 'led2', label: 'LED 2' },
  { id: 'led3', label: 'LED 3' },
  { id: 'led4', label: 'LED 4' },
]
export function UserDialog({ open, onOpenChange, user, currentUserRole, onSuccess }: UserDialogProps) {
  const [loading, setLoading] = useState(false)
  const [formData, setFormData] = useState({
    username: "",
    email: "",
    password: "",
    role: "user",
    avatar_url: "",
    allowedControls: [] as string[],
  })
  useEffect(() => {
    if (user) {
      setFormData({
        username: user.username,
        email: user.email,
        password: "", // Password not retrieved
        role: user.role,
        avatar_url: user.avatar_url || "",
        allowedControls: user.permissions?.allowedControls || [],
      })
    } else {
      setFormData({
        username: "",
        email: "",
        password: "",
        role: "user",
        avatar_url: "",
        allowedControls: [],
      })
    }
  }, [user, open])
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    try {
      const url = user ? `/api/admin/users/${user.id}` : "/api/admin/users"
      const method = user ? "PUT" : "POST"
      const body: any = {
        username: formData.username,
        role: formData.role,
        permissions: {
          allowedControls: formData.allowedControls
        }
      }
      if (formData.email && !user) {
        body.email = formData.email
      }
      if (formData.password) {
        body.password = formData.password
      }
      if (formData.avatar_url) {
        body.avatar_url = formData.avatar_url
      }
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      })
      if (!res.ok) {
        const error = await res.json()
        throw new Error(error.error || "Operation failed")
      }
      toast.success(user ? "User updated successfully" : "User created successfully")
      onOpenChange(false)
      onSuccess()
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "Operation failed")
    } finally {
      setLoading(false)
    }
  }
  const toggleControl = (controlId: string) => {
    setFormData(prev => {
      const controls = prev.allowedControls.includes(controlId)
        ? prev.allowedControls.filter(id => id !== controlId)
        : [...prev.allowedControls, controlId]
      return { ...prev, allowedControls: controls }
    })
  }
  const canEditRole = currentUserRole === 'super_admin';
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="w-[95vw] max-w-[500px] max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>{user ? "Edit User" : "Create User"}</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="username">Username</Label>
            <Input
              id="username"
              value={formData.username}
              onChange={e => setFormData(prev => ({ ...prev, username: e.target.value }))}
              required
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              value={formData.email}
              onChange={e => setFormData(prev => ({ ...prev, email: e.target.value }))}
              required
              disabled={!!user} // Email usually immutable or handled separately
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="password">{user ? "New Password (leave blank to keep)" : "Password"}</Label>
            <Input
              id="password"
              type="password"
              value={formData.password}
              onChange={e => setFormData(prev => ({ ...prev, password: e.target.value }))}
              required={!user}
            />
          </div>
          <div className="space-y-2">
             <Label htmlFor="avatar">Avatar URL</Label>
             <Input
               id="avatar"
               value={formData.avatar_url}
               onChange={e => setFormData(prev => ({ ...prev, avatar_url: e.target.value }))}
             />
          </div>
          <div className="space-y-2">
            <Label htmlFor="role">Role</Label>
            <Select
              disabled={!canEditRole}
              value={formData.role}
              onValueChange={val => setFormData(prev => ({ ...prev, role: val }))}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select role" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="user">User</SelectItem>
                <SelectItem value="admin">Admin</SelectItem>
              </SelectContent>
            </Select>
            {!canEditRole && <p className="text-xs text-muted-foreground">Only Super Admin can change roles.</p>}
          </div>
          <div className="space-y-2">
            <Label>Device Control Permissions</Label>
            <div className="grid grid-cols-2 gap-2 border p-4 rounded-md">
              {CONTROLS.map(control => (
                <div key={control.id} className="flex items-center space-x-2">
                  <Checkbox
                    id={`control-${control.id}`}
                    checked={formData.allowedControls.includes(control.id)}
                    onCheckedChange={() => toggleControl(control.id)}
                  />
                  <label
                    htmlFor={`control-${control.id}`}
                    className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                  >
                    {control.label}
                  </label>
                </div>
              ))}
            </div>
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
              Cancel
            </Button>
            <Button type="submit" disabled={loading}>
              {loading ? "Saving..." : "Save"}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

--- FILE: components\ai\citation-card.tsx ---

"use client"
import * as React from "react"
import { ExternalLink } from "lucide-react"
import Image from "next/image"
interface CitationCardProps {
    citation: {
        number: string
        title: string
        url: string
        description?: string
    }
}
export function CitationCard({ citation }: CitationCardProps) {
    const hostname = new URL(citation.url).hostname
    return (
        <div className="w-80 p-0 overflow-hidden bg-white dark:bg-zinc-950 rounded-xl shadow-lg border border-zinc-200 dark:border-zinc-800">
            <div className="p-4 space-y-3">
                {/* Header: Icon + Hostname */}
                <div className="flex items-center gap-2">
                    <div className="relative size-5 rounded-full overflow-hidden bg-zinc-100 dark:bg-zinc-800 shrink-0">
                        <img
                            src={`https://www.google.com/s2/favicons?domain=${hostname}&sz=32`}
                            alt=""
                            className="size-full object-cover"
                            onError={(e) => {
                                e.currentTarget.style.display = 'none'
                            }}
                        />
                    </div>
                    <span className="text-xs font-medium text-zinc-500 dark:text-zinc-400 truncate">
                        {hostname}
                    </span>
                </div>
                {/* Body: Title + Description */}
                <div>
                    <a
                        href={citation.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="block text-sm font-semibold text-zinc-900 dark:text-zinc-100 leading-tight hover:underline mb-1"
                    >
                        {citation.title}
                    </a>
                    {citation.description && (
                        <p className="text-xs text-zinc-500 dark:text-zinc-400 line-clamp-3 leading-relaxed">
                            {citation.description}
                        </p>
                    )}
                </div>
            </div>
            {/* Footer: Action */}
            <div className="bg-zinc-50 dark:bg-zinc-900/50 px-4 py-2 border-t border-zinc-100 dark:border-zinc-800 flex justify-end">
                <a
                    href={citation.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs font-medium text-blue-600 dark:text-blue-400 flex items-center gap-1 hover:opacity-80 transition-opacity"
                >
                    Visit Source <ExternalLink size={10} />
                </a>
            </div>
        </div>
    )
}

--- FILE: components\ai\control-bento-grid.tsx ---

"use client"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useDeviceControl } from "@/lib/hooks/use-device-control"
import { cn } from "@/lib/utils"
import {
  Fan,
  Droplets,
  Lightbulb,
  Zap,
  Power,
  Loader2
} from "lucide-react"
import { motion } from "framer-motion"
import { Switch } from "@/components/ui/switch"
import { useState } from "react"
import { toast } from "sonner"
export function ControlBentoGrid() {
  const { deviceData } = useDeviceData()
  const { toggleRelay } = useDeviceControl()
  const [loading, setLoading] = useState<number | null>(null)
  const handleToggle = async (relayId: number, currentState: number) => {
    setLoading(relayId)
    try {
      const success = await toggleRelay(relayId, currentState)
      if (success) {
        const newState = currentState === 1 ? 0 : 1
        toast.success(`设备 ${relayId} 已${newState ? '开启' : '关闭'}`)
      }
    } catch (error) {
      // toast handled in hook
    } finally {
      setLoading(null)
    }
  }
  // Mock data if no real data
  const data = deviceData || {
    relay5: 0, // Water Pump
    relay6: 0, // Fan
    relay7: 0, // Grow Light
    relay8: 0, // White Light
  }
  const container = {
    hidden: { opacity: 0 },
    show: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1
      }
    }
  }
  const item = {
    hidden: { y: 20, opacity: 0 },
    show: { y: 0, opacity: 1 }
  }
  const devices = [
    {
      id: 5,
      name: "灌溉水泵",
      icon: Droplets,
      state: data.relay5,
      color: "text-blue-500 dark:text-blue-400",
      bg: "bg-blue-50 dark:bg-blue-900/20",
      onColor: "bg-blue-500 dark:bg-blue-600"
    },
    {
      id: 6,
      name: "通风风扇",
      icon: Fan,
      state: data.relay6,
      color: "text-cyan-500 dark:text-cyan-400",
      bg: "bg-cyan-50 dark:bg-cyan-900/20",
      onColor: "bg-cyan-500 dark:bg-cyan-600"
    },
    {
      id: 7,
      name: "补光灯",
      icon: Zap,
      state: data.relay7,
      color: "text-purple-500 dark:text-purple-400",
      bg: "bg-purple-50 dark:bg-purple-900/20",
      onColor: "bg-purple-500 dark:bg-purple-600"
    },
    {
      id: 8,
      name: "白光照明",
      icon: Lightbulb,
      state: data.relay8,
      color: "text-amber-500 dark:text-amber-400",
      bg: "bg-amber-50 dark:bg-amber-900/20",
      onColor: "bg-amber-500 dark:bg-amber-600"
    }
  ]
  return (
    <motion.div
      variants={container}
      initial="hidden"
      animate="show"
      className="w-full max-w-4xl mx-auto p-2"
    >
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {devices.map((device) => (
          <motion.div
            key={device.id}
            variants={item}
            className={cn(
              "relative overflow-hidden rounded-[24px] p-5 shadow-sm border transition-all duration-300",
              "bg-white/80 dark:bg-white/5 backdrop-blur-xl hover:shadow-md",
              device.state ? "border-gray-200 dark:border-white/20" : "border-gray-100 dark:border-white/10"
            )}
          >
            <div className="flex flex-col justify-between h-full gap-4">
              <div className="flex items-start justify-between">
                <div className={cn(
                  "p-3 rounded-full transition-colors duration-300",
                  device.state ? device.bg : "bg-gray-100 dark:bg-white/10"
                )}>
                  <device.icon
                    size={24}
                    className={cn(
                      "transition-colors duration-300",
                      device.state ? device.color : "text-gray-400 dark:text-gray-500",
                      device.id === 6 && device.state ? "animate-spin" : ""
                    )}
                  />
                </div>
                <div className="relative">
                   {loading === device.id && (
                     <div className="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-black/80 z-10">
                       <Loader2 size={16} className="animate-spin text-gray-500 dark:text-gray-400" />
                     </div>
                   )}
                   <Switch
                     checked={device.state === 1}
                     onCheckedChange={() => handleToggle(device.id, device.state)}
                     className={cn(
                       "data-[state=checked]:bg-black dark:data-[state=checked]:bg-white",
                       device.state ? "" : "bg-gray-200 dark:bg-gray-700"
                     )}
                   />
                </div>
              </div>
              <div>
                <div className="font-bold text-gray-900 dark:text-white text-lg mb-1">{device.name}</div>
                <div className="flex items-center gap-2">
                   <div className={cn(
                     "size-2 rounded-full",
                     device.state ? "bg-green-500" : "bg-gray-300 dark:bg-gray-600"
                   )} />
                   <span className="text-sm font-medium text-gray-500 dark:text-gray-400">
                     {device.state ? "运行中" : "已关闭"}
                   </span>
                </div>
              </div>
            </div>
          </motion.div>
        ))}
      </div>
    </motion.div>
  )
}

--- FILE: components\ai\device-bento-grid.tsx ---

"use client"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { cn } from "@/lib/utils"
import {
  Thermometer,
  Droplets,
  Sun,
  Wind,
  Activity,
  Zap,
  Sprout,
  Wifi,
  WifiOff,
  Leaf,
  Gauge,
  TrendingUp,
  TrendingDown,
  Waves
} from "lucide-react"
import { motion } from "framer-motion"
import { Card, CardContent } from "@/components/ui/card"
interface MetricCardProps {
  title: string
  value: string | number
  unit: string
  icon: any
  trend?: string
  trendUp?: boolean
  color: {
    bg: string
    text: string
  }
  delay?: number
}
const MetricCard = ({
  title,
  value,
  unit,
  icon: Icon,
  trend,
  trendUp = true,
  color,
  delay = 0
}: MetricCardProps) => {
  // Generate a consistent random path for the sparkline based on the title (so it doesn't flicker on re-renders)
  const generatePath = () => {
    // Simple pseudo-random based on title length
    const seed = title.length
    const points = []
    for (let i = 0; i < 10; i++) {
      points.push(20 + Math.sin(i + seed) * 15)
    }
    return `M0,${points[0]} ` + points.map((p, i) => `L${(i) * 11},${p}`).join(' ')
  }
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay, duration: 0.4 }}
    >
      <Card className="h-full border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden group">
        <CardContent className="p-5 flex flex-col justify-between h-full">
          <div className="flex justify-between items-start mb-3">
            <div className={cn("p-2.5 rounded-2xl transition-colors duration-300", color.bg, "group-hover:bg-opacity-20")}>
              <Icon size={20} className={cn(color.text)} />
            </div>
            {trend && (
              <div className={cn("flex items-center text-xs font-medium px-2 py-0.5 rounded-full",
                trendUp
                  ? "bg-green-500/10 text-green-600 dark:text-green-400"
                  : "bg-red-500/10 text-red-600 dark:text-red-400"
              )}>
                {trendUp ? <TrendingUp size={12} className="mr-1" /> : <TrendingDown size={12} className="mr-1" />}
                {trend}
              </div>
            )}
          </div>
          <div>
            <p className="text-sm font-medium text-muted-foreground mb-1">{title}</p>
            <div className="flex items-baseline gap-1">
              <h3 className="text-2xl font-bold tracking-tight text-foreground">{value}</h3>
              <span className="text-sm text-muted-foreground font-medium">{unit}</span>
            </div>
          </div>
          {/* Decorative Sparkline */}
          <div className="h-8 mt-4 w-full opacity-40 group-hover:opacity-100 transition-opacity duration-500">
             <svg width="100%" height="100%" viewBox="0 0 100 40" preserveAspectRatio="none" className="overflow-visible">
               <path
                 d={generatePath()}
                 fill="none"
                 stroke="currentColor"
                 strokeWidth="2.5"
                 strokeLinecap="round"
                 strokeLinejoin="round"
                 className={cn(color.text)}
               />
             </svg>
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}
export function DeviceBentoGrid() {
  const { deviceData, connectionStatus } = useDeviceData()
  // Mock data for preview if no real data is connected yet, or use 0
  const data = deviceData || {
    temperature: 0,
    humidity: 0,
    light: 0,
    co2: 0,
    earth_temp: 0,
    earth_water: 0,
    earth_ec: 0,
    earth_n: 0,
    earth_p: 0,
    earth_k: 0,
    relay5: 0,
    relay6: 0,
    relay7: 0,
    relay8: 0,
    led1: 0,
    led2: 0,
    led3: 0,
    led4: 0,
  }
  return (
    <div className="w-full max-w-5xl mx-auto p-2">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-lg font-semibold flex items-center gap-2">
            <Activity className="size-5 text-blue-500" />
            实时环境监测
        </h2>
        <div className={cn("flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors",
            connectionStatus.connected
                ? "bg-green-500/10 text-green-600 dark:text-green-400"
                : "bg-red-500/10 text-red-600 dark:text-red-400"
        )}>
            <span className="relative flex h-2 w-2">
              <span className={cn("animate-ping absolute inline-flex h-full w-full rounded-full opacity-75", connectionStatus.connected ? "bg-green-500" : "bg-red-500")}></span>
              <span className={cn("relative inline-flex rounded-full h-2 w-2", connectionStatus.connected ? "bg-green-500" : "bg-red-500")}></span>
            </span>
            {connectionStatus.connected ? "设备在线" : "设备离线"}
        </div>
      </div>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <MetricCard
          title="空气温度"
          value={data.temperature}
          unit="°C"
          icon={Thermometer}
          trend="+1.2%"
          color={{ bg: "bg-orange-500/10", text: "text-orange-500" }}
          delay={0.1}
        />
        <MetricCard
          title="空气湿度"
          value={data.humidity}
          unit="%"
          icon={Droplets}
          trend="-0.5%"
          trendUp={false}
          color={{ bg: "bg-blue-500/10", text: "text-blue-500" }}
          delay={0.2}
        />
        <MetricCard
          title="光照强度"
          value={data.light}
          unit="Lux"
          icon={Sun}
          trend="+5.3%"
          color={{ bg: "bg-amber-500/10", text: "text-amber-500" }}
          delay={0.3}
        />
        <MetricCard
          title="CO2 浓度"
          value={data.co2}
          unit="ppm"
          icon={Wind}
          trend="+2.1%"
          color={{ bg: "bg-emerald-500/10", text: "text-emerald-500" }}
          delay={0.4}
        />
        <MetricCard
          title="土壤温度"
          value={data.earth_temp}
          unit="°C"
          icon={Thermometer}
          trend="+0.2%"
          color={{ bg: "bg-rose-500/10", text: "text-rose-500" }}
          delay={0.5}
        />
        <MetricCard
          title="土壤水分"
          value={data.earth_water.toFixed(1)}
          unit="%"
          icon={Waves}
          trend="+1.8%"
          color={{ bg: "bg-cyan-500/10", text: "text-cyan-500" }}
          delay={0.6}
        />
        <MetricCard
          title="土壤 EC"
          value={data.earth_ec}
          unit="μS/cm"
          icon={Zap}
          trend="-0.8%"
          trendUp={false}
          color={{ bg: "bg-purple-500/10", text: "text-purple-500" }}
          delay={0.7}
        />
        {/* Combined NPK Card or separate? Let's do a combined visual for NPK in one slot or split */}
        {/* Given 4 columns, let's put NPK in one "Special" card or spread them.
            The user wants "Device" tag card.
            Let's add Nitrogen as representative or average?
            No, let's use the last slot for a summary or NPK.
            Actually, let's just list Nitrogen for now or maybe "Soil Nutrition"
        */}
        <MetricCard
            title="土壤氮 (N)"
            value={data.earth_n}
            unit="mg/kg"
            icon={Sprout}
            trend="+0.0%"
            color={{ bg: "bg-indigo-500/10", text: "text-indigo-500" }}
            delay={0.8}
        />
      </div>
      {/* Additional Stats Row */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <MetricCard
            title="土壤磷 (P)"
            value={data.earth_p}
            unit="mg/kg"
            icon={Sprout}
            trend="+0.0%"
            color={{ bg: "bg-pink-500/10", text: "text-pink-500" }}
            delay={0.9}
        />
        <MetricCard
            title="土壤钾 (K)"
            value={data.earth_k}
            unit="mg/kg"
            icon={Sprout}
            trend="+0.0%"
            color={{ bg: "bg-lime-500/10", text: "text-lime-500" }}
            delay={1.0}
        />
        {/* Status Card spanning 2 cols */}
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 1.1, duration: 0.4 }}
            className="col-span-2"
        >
            <Card className="h-full border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all duration-200">
                <CardContent className="p-5 flex items-center justify-between h-full">
                    <div className="flex items-center gap-4">
                        <div className={cn(
                            "size-12 rounded-2xl flex items-center justify-center transition-all duration-500",
                            connectionStatus.connected
                                ? "bg-green-500/10 text-green-500"
                                : "bg-red-500/10 text-red-500"
                        )}>
                            {connectionStatus.connected ? <Wifi size={24} /> : <WifiOff size={24} />}
                        </div>
                        <div>
                            <div className="font-bold text-lg">系统状态</div>
                            <div className="text-sm text-muted-foreground">
                                {connectionStatus.connected ? "所有传感器正常工作中" : "请检查设备连接"}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        {[1, 2, 3, 4].map(i => (
                            <div key={i} className="flex flex-col items-center gap-1">
                                <div className={cn(
                                    "size-3 rounded-full transition-all duration-500",
                                    (data as any)[`led${i}`]
                                    ? "bg-blue-500 shadow-lg shadow-blue-500/50 scale-110"
                                    : "bg-slate-200 dark:bg-slate-700"
                                )} />
                                <span className="text-[10px] text-muted-foreground">L{i}</span>
                            </div>
                        ))}
                    </div>
                </CardContent>
            </Card>
        </motion.div>
      </div>
    </div>
  )
}

--- FILE: components\ai\monitor-card.tsx ---

"use client"
import { useState, useEffect, useMemo, memo } from "react"
import { cn } from "@/lib/utils"
import { LiveStreamPlayer } from "@/components/live-stream-player"
import { Eye, ArrowUpRight, Video, Wifi, WifiOff, RefreshCw, Maximize2, X } from "lucide-react"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { Dialog, DialogContent, DialogTrigger, DialogClose, DialogTitle } from "@/components/ui/dialog"
const MemoizedLiveStreamPlayer = memo(LiveStreamPlayer)
export function MonitorCard() {
  const [date, setDate] = useState("")
  const { connectionStatus } = useDeviceData()
  const [refreshKey, setRefreshKey] = useState(0)
  const [isExpanded, setIsExpanded] = useState(false)
  const liveSources = useMemo(() => ['webrtc://192.168.5.236/live/livestream'], [])
  useEffect(() => {
    const now = new Date()
    // Format date in Chinese
    const options: Intl.DateTimeFormatOptions = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    }
    setDate(now.toLocaleDateString('zh-CN', options))
  }, [])
  const handleRefresh = () => {
    setRefreshKey(prev => prev + 1)
  }
  const renderPlayer = (isFull = false) => {
    return (
      <MemoizedLiveStreamPlayer
        key={`live-${refreshKey}-${isFull ? 'full' : 'mini'}`}
        className="w-full h-full object-cover"
        sources={liveSources}
        autoplay
        muted={!isFull}
        controls={isFull}
      />
    )
  }
  return (
    <Dialog open={isExpanded} onOpenChange={setIsExpanded}>
    <div className="w-full max-w-sm bg-white/80 dark:bg-[#1a1a1a]/80 backdrop-blur-xl rounded-[24px] p-4 border border-white/50 dark:border-white/10 shadow-[0_8px_30px_rgba(0,0,0,0.04)] my-4">
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className="size-10 rounded-full bg-black dark:bg-white flex items-center justify-center text-white dark:text-black">
            <Eye size={20} />
          </div>
          <div>
            <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100">实时监控</h3>
            <p className="text-xs text-gray-500 dark:text-gray-400 font-medium">{date}</p>
          </div>
        </div>
      </div>
      {/* Video Content */}
      <div className="relative w-full aspect-[4/3] bg-black rounded-[20px] overflow-hidden shadow-inner mb-4 group">
        {/* Only render mini player if not expanded to avoid resource conflict */}
        {!isExpanded && renderPlayer(false)}
        {/* Overlay Status */}
        <div className="absolute top-3 left-3 px-2 py-1 bg-black/40 backdrop-blur-md rounded-full flex items-center gap-1.5 border border-white/10 z-10">
          <div className="size-1.5 rounded-full animate-pulse bg-red-500"></div>
          <span className="text-[10px] font-medium text-white/90">直播中</span>
        </div>
        {/* Controls (Visible on Hover) */}
        <div className="absolute top-3 right-3 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
           <DialogTrigger asChild>
              <button
                className="p-1.5 bg-black/40 hover:bg-black/60 backdrop-blur-md rounded-full text-white/80 hover:text-white border border-white/10 transition-all"
                title="全屏查看"
              >
                  <Maximize2 size={12} />
              </button>
           </DialogTrigger>
           <button
              onClick={handleRefresh}
              className="p-1.5 bg-black/40 hover:bg-black/60 backdrop-blur-md rounded-full text-white/80 hover:text-white border border-white/10 transition-all"
              title="刷新画面"
           >
              <RefreshCw size={12} />
           </button>
        </div>
      </div>
      {/* Footer Info */}
      <div className="bg-[#E8F5E9]/50 dark:bg-white/5 rounded-[18px] p-3 flex items-center justify-between border border-[#E8F5E9] dark:border-white/10">
        <div className="flex items-center gap-3">
          <div className="size-8 rounded-full bg-black dark:bg-white flex items-center justify-center text-white dark:text-black">
            <Video size={14} />
          </div>
          <div>
            <h4 className="text-xs font-bold text-gray-900 dark:text-gray-100">主摄像头</h4>
            <p className="text-[10px] text-gray-500 dark:text-gray-400">高清 • 30fps</p>
          </div>
        </div>
        <div className="flex items-center gap-1.5 px-2 py-1 bg-white dark:bg-white/10 rounded-full border border-gray-100 dark:border-white/10 shadow-sm">
            {connectionStatus.connected ? (
                <>
                    <Wifi size={12} className="text-green-500" />
                    <span className="text-[10px] font-bold text-gray-700 dark:text-gray-300">在线</span>
                </>
            ) : (
                <>
                    <WifiOff size={12} className="text-red-500" />
                    <span className="text-[10px] font-bold text-gray-700 dark:text-gray-300">离线</span>
                </>
            )}
        </div>
      </div>
    </div>
    {/* Expanded View Dialog */}
    <DialogContent className="max-w-[90vw] w-full h-[80vh] p-0 bg-black border-gray-800 overflow-hidden flex flex-col">
        <DialogTitle className="sr-only">全屏监控</DialogTitle>
        <div className="absolute top-4 left-4 z-50 flex items-center gap-3">
            <div className="px-3 py-1.5 bg-black/60 backdrop-blur-md rounded-full flex items-center gap-2 border border-white/10">
                <div className="size-2 rounded-full animate-pulse bg-red-500"></div>
                <span className="text-xs font-medium text-white/90">直播中 - 全屏模式</span>
            </div>
        </div>
        <DialogClose className="absolute top-4 right-4 z-50 p-2 bg-black/60 hover:bg-black/80 backdrop-blur-md rounded-full text-white/80 hover:text-white border border-white/10 transition-all">
            <X size={20} />
        </DialogClose>
        <div className="flex-1 w-full h-full relative bg-black flex items-center justify-center">
             {isExpanded && renderPlayer(true)}
        </div>
    </DialogContent>
    </Dialog>
  )
}

--- FILE: components\ai\reasoning.tsx ---

"use client"
import * as React from "react"
import { ChevronDown, Loader2, Sparkles } from "lucide-react"
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible"
import { cn } from "@/lib/utils"
interface ReasoningProps extends React.ComponentProps<typeof Collapsible> {
  isStreaming?: boolean
}
const Reasoning = React.forwardRef<React.ElementRef<typeof Collapsible>, ReasoningProps>(
  ({ className, children, isStreaming, defaultOpen = true, ...props }, ref) => {
    const [open, setOpen] = React.useState(defaultOpen)
    // Auto-open when streaming starts, close when stops
    React.useEffect(() => {
      setOpen(!!isStreaming)
    }, [isStreaming])
    return (
      <Collapsible
        ref={ref}
        open={open}
        onOpenChange={setOpen}
        className={cn("border-l-2 border-muted pl-4", className)}
        {...props}
      >
        {children}
      </Collapsible>
    )
  }
)
Reasoning.displayName = "Reasoning"
const ReasoningTrigger = React.forwardRef<
  React.ElementRef<typeof CollapsibleTrigger>,
  React.ComponentProps<typeof CollapsibleTrigger>
>(({ className, children, ...props }, ref) => (
  <CollapsibleTrigger
    ref={ref}
    className={cn(
      "flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors py-2",
      className
    )}
    {...props}
  >
    {children || (
      <>
        <Sparkles className="h-4 w-4" />
        <span>Thinking Process</span>
        <ChevronDown className="h-4 w-4 transition-transform duration-200 group-data-[state=open]:rotate-180" />
      </>
    )}
  </CollapsibleTrigger>
))
ReasoningTrigger.displayName = "ReasoningTrigger"
const ReasoningContent = React.forwardRef<
  React.ElementRef<typeof CollapsibleContent>,
  React.ComponentProps<typeof CollapsibleContent>
>(({ className, children, ...props }, ref) => (
  <CollapsibleContent
    ref={ref}
    className={cn("text-sm text-muted-foreground/80 overflow-hidden data-[state=closed]:animate-collapsible-up data-[state=open]:animate-collapsible-down", className)}
    {...props}
  >
    <div className="pb-2">{children}</div>
  </CollapsibleContent>
))
ReasoningContent.displayName = "ReasoningContent"
export { Reasoning, ReasoningTrigger, ReasoningContent }

--- FILE: components\ai\schedule-card.tsx ---

"use client"
import { useState, useEffect } from "react"
import { CalendarClock, CheckCircle2, XCircle, Loader2, ArrowRight, Timer, X } from "lucide-react"
import { toast } from "sonner"
interface ScheduleData {
  title: string
  cron?: string
  execute_at?: number
  delay_seconds?: number
  task_action: string
  device: number
  value: number
  params?: any
}
function CountdownToast({ id, targetTime, title }: { id: string | number, targetTime: number, title: string }) {
  const [remaining, setRemaining] = useState(Math.max(0, Math.ceil((targetTime - Date.now()) / 1000)))
  const totalDuration = useState(remaining)[0] // Store initial duration for progress bar
  useEffect(() => {
    const interval = setInterval(() => {
      const diff = Math.ceil((targetTime - Date.now()) / 1000)
      if (diff <= 0) {
        setRemaining(0)
        clearInterval(interval)
        toast.dismiss(id)
        toast.success("任务已执行", { description: title })
      } else {
        setRemaining(diff)
      }
    }, 1000)
    return () => clearInterval(interval)
  }, [targetTime, id, title])
  const progress = Math.max(0, Math.min(100, (remaining / totalDuration) * 100))
  return (
    <div className="w-[356px] bg-white dark:bg-zinc-900 rounded-xl shadow-lg border border-gray-200 dark:border-white/10 p-4 flex flex-col gap-3 pointer-events-auto relative overflow-hidden">
      <div className="flex items-start justify-between gap-2 relative z-10">
        <div className="flex items-center gap-2">
          <div className="size-8 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400 shrink-0 animate-pulse">
            <Timer size={18} />
          </div>
          <div>
            <div className="font-semibold text-gray-900 dark:text-gray-100">任务倒计时</div>
            <div className="text-xs text-gray-500 dark:text-gray-400 max-w-[200px] truncate">{title}</div>
          </div>
        </div>
        <div className="text-xl font-bold text-blue-600 dark:text-blue-400 font-mono w-12 text-right">{remaining}s</div>
      </div>
      {/* Progress Bar */}
      <div className="h-1.5 w-full bg-gray-100 dark:bg-white/10 rounded-full overflow-hidden relative z-10">
        <div
          className="h-full bg-blue-500 dark:bg-blue-600 transition-all duration-1000 ease-linear"
          style={{ width: `${progress}%` }}
        />
      </div>
      {/* Close Button */}
      <button
        onClick={() => toast.dismiss(id)}
        className="absolute top-2 right-2 p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 dark:hover:bg-white/10 dark:hover:text-gray-200 rounded-md transition-colors z-20"
      >
        <X size={14} />
      </button>
    </div>
  )
}
export function ScheduleCard({ data }: { data: ScheduleData }) {
  const [status, setStatus] = useState<'idle' | 'loading' | 'success' | 'error'>('idle')
  const handleConfirm = async () => {
    setStatus('loading')
    try {
      // Calculate final execution time
      let finalExecuteAt = data.execute_at
      if (data.delay_seconds) {
        finalExecuteAt = Date.now() + (data.delay_seconds * 1000)
      }
      const getParams = () => {
        if (data.params && Object.keys(data.params).length > 0) return data.params
        if (data.task_action === 'toggle_relay') {
          return { value: data.value }
        }
        if (data.task_action === 'set_led') {
          const d = data as any
          return {
            r: d.r ?? 0,
            g: d.g ?? 0,
            b: d.b ?? 0,
            w: d.w ?? 0
          }
        }
        return {}
      }
      const res = await fetch('/api/scheduler/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: data.title,
          cron_expression: data.cron,
          execute_at: finalExecuteAt,
          action_type: data.task_action === 'toggle_relay' ? 'relay' : 'led',
          device_id: data.device,
          params: getParams()
        })
      })
      if (!res.ok) throw new Error("Failed to create task")
      setStatus('success')
      // Check if it's a short-term one-time task (e.g., within 5 minutes)
      if (finalExecuteAt && !data.cron) {
        const delay = finalExecuteAt - Date.now()
        // Show countdown for tasks within 5 minutes (300000ms)
        if (delay > 0 && delay <= 300000) {
           toast.custom((id) => (
             <CountdownToast id={id} targetTime={finalExecuteAt!} title={data.title} />
           ), { duration: Infinity }) // Keep open until manually closed or timer ends
        } else {
           toast.success("定时任务已创建")
        }
      } else {
        toast.success("定时任务已创建")
      }
    } catch (e) {
      setStatus('error')
      toast.error("创建失败")
    }
  }
  if (status === 'success') {
    return (
      <div className="my-4 p-4 bg-green-50 dark:bg-green-900/10 border border-green-100 dark:border-green-900/20 rounded-xl flex items-center gap-3">
        <div className="size-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400 shrink-0">
           <CheckCircle2 size={20} />
        </div>
        <div>
           <div className="font-semibold text-green-900 dark:text-green-100">任务已设定</div>
           <div className="text-xs text-green-700 dark:text-green-300">{data.title}</div>
        </div>
      </div>
    )
  }
  return (
    <div className="my-4 bg-white dark:bg-white/5 rounded-xl border border-gray-200 dark:border-white/10 shadow-sm overflow-hidden">
       <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 px-4 py-3 border-b border-blue-100 dark:border-white/5 flex items-center gap-2">
          <CalendarClock size={18} className="text-blue-600 dark:text-blue-400" />
          <span className="font-semibold text-blue-900 dark:text-blue-100 text-sm">建议定时任务</span>
       </div>
       <div className="p-4 space-y-3">
          <div>
             <div className="text-lg font-bold text-gray-900 dark:text-white">{data.title}</div>
             <div className="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2 mt-1">
                <span className="bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded text-xs font-mono">
                   {data.cron
                     ? `Cron: ${data.cron}`
                     : data.delay_seconds
                       ? `${data.delay_seconds}s Later`
                       : `Time: ${new Date(data.execute_at!).toLocaleString()}`
                   }
                </span>
                <ArrowRight size={14} />
                <span className="text-gray-700 dark:text-gray-300 font-medium">
                   {data.task_action === 'toggle_relay' ? `设备 ${data.device} -> ${data.value ? '开' : '关'}` : '调节灯光'}
                </span>
             </div>
          </div>
          <button
            onClick={handleConfirm}
            disabled={status === 'loading'}
            className="w-full flex items-center justify-center gap-2 bg-black dark:bg-white text-white dark:text-black py-2.5 rounded-lg hover:bg-gray-800 dark:hover:bg-gray-200 disabled:opacity-50 transition-all active:scale-[0.98] font-medium text-sm"
          >
             {status === 'loading' ? <Loader2 size={16} className="animate-spin" /> : <CheckCircle2 size={16} />}
             确认创建任务
          </button>
       </div>
    </div>
  )
}

--- FILE: components\ai\scheduled-tasks-list.tsx ---

"use client"
import { useEffect, useState } from "react"
import { Calendar, Clock, Trash2, Repeat, PlayCircle, Power, MoreVertical, Loader2, AlertCircle } from "lucide-react"
import { cn } from "@/lib/utils"
import { toast } from "sonner"
import { motion, AnimatePresence } from "framer-motion"
interface ScheduledTask {
  id: number
  title: string
  cron_expression?: string | null
  execute_at?: number | null
  next_run?: number | null
  action_type: 'relay' | 'led'
  device_id?: number
  params: string
  is_active: number
  created_at: number
}
function Countdown({ targetDate }: { targetDate: number }) {
  const [timeLeft, setTimeLeft] = useState<string>("")
  useEffect(() => {
    const calculateTimeLeft = () => {
      const difference = targetDate - Date.now()
      if (difference <= 0) {
        return "执行中..."
      }
      const days = Math.floor(difference / (1000 * 60 * 60 * 24))
      const hours = Math.floor((difference / (1000 * 60 * 60)) % 24)
      const minutes = Math.floor((difference / 1000 / 60) % 60)
      const seconds = Math.floor((difference / 1000) % 60)
      if (days > 0) {
        return `${days}天 ${hours}小时`
      }
      if (hours > 0) {
        return `${hours}小时 ${minutes}分`
      }
      return `${minutes}分 ${seconds}秒`
    }
    setTimeLeft(calculateTimeLeft())
    const timer = setInterval(() => {
      setTimeLeft(calculateTimeLeft())
    }, 1000)
    return () => clearInterval(timer)
  }, [targetDate])
  return <span className="text-blue-600 font-medium">{timeLeft}</span>
}
export function ScheduledTasksList() {
  const [tasks, setTasks] = useState<ScheduledTask[]>([])
  const [loading, setLoading] = useState(true)
  const [deletingId, setDeletingId] = useState<number | null>(null)
  const fetchTasks = async () => {
    try {
      const res = await fetch('/api/scheduler/tasks')
      if (res.ok) {
        const data = await res.json()
        setTasks(data.tasks || [])
      }
    } catch (e) {
      console.error(e)
    } finally {
      setLoading(false)
    }
  }
  useEffect(() => {
    fetchTasks()
    // Poll for updates every 30s
    const interval = setInterval(fetchTasks, 30000)
    return () => clearInterval(interval)
  }, [])
  const handleDelete = async (id: number) => {
    setDeletingId(id)
    try {
      const res = await fetch(`/api/scheduler/tasks?id=${id}`, { method: 'DELETE' })
      if (res.ok) {
        setTasks(prev => prev.filter(t => t.id !== id))
        toast.success("任务已删除")
      } else {
        throw new Error()
      }
    } catch (e) {
      toast.error("删除失败")
    } finally {
      setDeletingId(null)
    }
  }
  const getDeviceName = (id?: number) => {
    switch(id) {
      case 5: return "灌溉水泵"
      case 6: return "通风风扇"
      case 7: return "补光灯"
      case 8: return "白光灯"
      default: return `设备 ${id}`
    }
  }
  const formatTime = (timestamp?: number | null, cron?: string | null) => {
    if (cron) return `Cron: ${cron}`
    if (!timestamp) return "立即执行"
    return new Date(timestamp).toLocaleString('zh-CN', {
      month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    })
  }
  if (loading) {
    return (
      <div className="flex items-center justify-center p-8 text-gray-400">
        <Loader2 className="animate-spin mr-2" size={20} />
        <span>加载任务列表...</span>
      </div>
    )
  }
  if (tasks.length === 0) {
    return (
      <div className="my-4 bg-gray-50 dark:bg-white/5 rounded-2xl p-8 border border-gray-100 dark:border-white/10 flex flex-col items-center justify-center text-center">
        <div className="size-12 bg-white dark:bg-white/10 rounded-full shadow-sm flex items-center justify-center mb-3 text-gray-300 dark:text-gray-600">
           <Calendar size={24} />
        </div>
        <h3 className="text-gray-900 dark:text-white font-medium mb-1">暂无定时任务</h3>
        <p className="text-sm text-gray-500 dark:text-gray-400">您可以让 AI 帮您设定，例如"每天8点开启水泵"</p>
      </div>
    )
  }
  return (
    <div className="my-6 space-y-3">
      <div className="flex items-center justify-between px-1 mb-2">
         <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider flex items-center gap-2">
           <Clock size={14} className="text-blue-500 dark:text-blue-400" />
           定时任务列表 ({tasks.length})
         </h3>
      </div>
      <AnimatePresence mode="popLayout">
        {tasks.map((task) => {
          const params = JSON.parse(task.params)
          const isRelay = task.action_type === 'relay'
          const isOn = isRelay && params.value === 1
          return (
            <motion.div
              key={task.id}
              layout
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95 }}
              className="group bg-white dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/10 shadow-sm hover:shadow-md transition-all overflow-hidden relative"
            >
              <div className={cn(
                "absolute left-0 top-0 bottom-0 w-1",
                task.is_active ? "bg-blue-500 dark:bg-blue-600" : "bg-gray-300 dark:bg-gray-600"
              )} />
              <div className="p-4 flex items-center gap-4">
                 {/* Icon */}
                 <div className={cn(
                   "size-10 rounded-full flex items-center justify-center shrink-0",
                   task.is_active ? "bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300" : "bg-gray-100 dark:bg-white/10 text-gray-400 dark:text-gray-500"
                 )}>
                    {task.cron_expression ? <Repeat size={18} /> : <PlayCircle size={18} />}
                 </div>
                 {/* Content */}
                 <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between mb-1">
                       <h4 className="font-semibold text-gray-900 dark:text-white truncate pr-2">{task.title}</h4>
                       <span className={cn(
                         "text-[10px] px-2 py-0.5 rounded-full font-medium uppercase tracking-wide shrink-0",
                         task.is_active ? "bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-300" : "bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-400"
                       )}>
                         {task.is_active ? "Active" : "Done"}
                       </span>
                    </div>
                    <div className="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                       <div className="flex items-center gap-1">
                          <Clock size={12} />
                          <span className="font-mono">
                            {task.is_active ? (
                              (task.next_run || task.execute_at) ? (
                                <>
                                  倒计时: <Countdown targetDate={(task.next_run || task.execute_at)!} />
                                </>
                              ) : (
                                formatTime(task.execute_at, task.cron_expression)
                              )
                            ) : (
                              <span className="text-gray-400 dark:text-gray-600">已完成</span>
                            )}
                          </span>
                       </div>
                       <div className="w-px h-3 bg-gray-200 dark:bg-gray-700" />
                       <div className="flex items-center gap-1">
                          <Power size={12} />
                          <span>
                            {getDeviceName(task.device_id)}
                            <span className={cn("ml-1 font-medium", isOn ? "text-green-600 dark:text-green-400" : "text-red-500 dark:text-red-400")}>
                              {isRelay ? (isOn ? "开启" : "关闭") : "调节颜色"}
                            </span>
                          </span>
                       </div>
                    </div>
                 </div>
                 {/* Actions */}
                 <button
                   onClick={() => handleDelete(task.id)}
                   disabled={deletingId === task.id}
                   className="p-2 text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors disabled:opacity-50"
                 >
                    {deletingId === task.id ? <Loader2 size={18} className="animate-spin" /> : <Trash2 size={18} />}
                 </button>
              </div>
            </motion.div>
          )
        })}
      </AnimatePresence>
    </div>
  )
}

--- FILE: components\ai\spectral-card.tsx ---

"use client"
import React, { useState } from 'react'
import ReactECharts from 'echarts-for-react'
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { DeviceData } from "@/lib/hooks/use-device-data"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
interface SpectralCardProps {
  data: DeviceData | null
}
export function SpectralCard({ data }: SpectralCardProps) {
  const [timeRange, setTimeRange] = useState("1h")
  // Define spectral channels configuration
  const channels = [
    { id: 'channel1', name: '415', label: 'Violet', color: '#8B00FF' },
    { id: 'channel2', name: '445', label: 'Blue', color: '#0000FF' },
    { id: 'channel3', name: '480', label: 'Cyan', color: '#00FFFF' },
    { id: 'channel4', name: '515', label: 'Green', color: '#00FF00' },
    { id: 'channel5', name: '555', label: 'Y-G', color: '#ADFF2F' },
    { id: 'channel6', name: '590', label: 'Yellow', color: '#FFFF00' },
    { id: 'channel7', name: '630', label: 'Orange', color: '#FFA500' },
    { id: 'channel8', name: '680', label: 'Red', color: '#FF0000' },
    { id: 'channel9', name: 'NIR', label: 'NIR', color: '#8B0000' },
    { id: 'channel10', name: 'Clr', label: 'Clear', color: '#E0E0E0' },
    { id: 'channel11', name: 'Fli', label: 'Flicker', color: '#808080' },
  ]
  // Find the channel with max value to display prominently
  const maxChannel = channels.reduce((prev, current) => {
    const prevVal = data ? (data[prev.id as keyof DeviceData] as number) || 0 : 0
    const currVal = data ? (data[current.id as keyof DeviceData] as number) || 0 : 0
    return currVal > prevVal ? current : prev
  })
  const maxValue = data ? (data[maxChannel.id as keyof DeviceData] as number) || 0 : 0
  // Prepare chart option
  const getOption = () => {
    const xAxisData = channels.map(c => c.name)
    const seriesData = channels.map(c => {
      const value = data ? (data[c.id as keyof DeviceData] as number) || 0 : 0
      return {
        value,
        itemStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [
              { offset: 0, color: c.color },
              { offset: 1, color: `${c.color}40` } // Fade to transparency
            ]
          },
          borderRadius: [4, 4, 0, 0]
        }
      }
    })
    return {
      grid: {
        top: 5,
        right: 0,
        bottom: 0,
        left: 0,
        containLabel: false
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'none' // Hide axis pointer line for cleaner look
        },
        formatter: (params: any) => {
          const param = params[0]
          const channel = channels[param.dataIndex]
          return `
            <div class="font-bold">${channel.label} (${channel.name}nm)</div>
            <div>Value: ${param.value}</div>
          `
        }
      },
      xAxis: {
        type: 'category',
        data: xAxisData,
        show: false, // Hide x axis
        axisLine: { show: false },
        axisTick: { show: false },
      },
      yAxis: {
        type: 'value',
        show: false, // Hide y axis
        splitLine: { show: false }
      },
      series: [
        {
          type: 'bar',
          barWidth: '60%',
          data: seriesData,
          showBackground: true,
          backgroundStyle: {
            color: 'rgba(240, 240, 240, 0.2)',
            borderRadius: [4, 4, 0, 0]
          },
          // Add a smooth line on top for the "trend" look from reference
          // Using a separate line series for the smooth curve effect
        },
        {
            type: 'line',
            data: seriesData.map(d => d.value),
            smooth: true,
            symbol: 'none',
            lineStyle: {
                width: 2,
                color: '#e879f9' // Pinkish purple line
            },
            areaStyle: {
                color: {
                    type: 'linear',
                    x: 0,
                    y: 0,
                    x2: 0,
                    y2: 1,
                    colorStops: [
                        { offset: 0, color: 'rgba(232, 121, 249, 0.2)' },
                        { offset: 1, color: 'rgba(232, 121, 249, 0.05)' }
                    ]
                }
            }
        }
      ]
    }
  }
  return (
    <Card className="w-full min-w-[300px] max-w-[400px] rounded-3xl border border-border overflow-hidden shadow-sm hover:shadow-md transition-all bg-white">
      <CardContent className="p-6 flex flex-col gap-4">
        <div className="flex items-start justify-between">
          <div>
            <div className="text-4xl font-bold text-foreground mb-1">
              {maxValue}
              <span className="text-lg font-normal text-muted-foreground ml-1">µmol</span>
            </div>
            <div className="flex items-center gap-2">
              <Badge className="bg-pink-50/50 text-pink-600 border-pink-100 rounded-full px-2 py-0.5 text-[10px] font-medium">
                Spectral
              </Badge>
              <span className="text-xs text-muted-foreground">实时监测</span>
            </div>
          </div>
          {/* Circular Icon Badge similar to reference */}
          <div className="size-8 rounded-full bg-pink-400 flex items-center justify-center text-white font-bold text-sm shadow-md shadow-pink-400/20">
            S
          </div>
        </div>
        <div className="h-20 w-full relative">
          <ReactECharts
            option={getOption()}
            style={{ height: '100%', width: '100%' }}
            opts={{ renderer: 'svg' }}
          />
        </div>
      </CardContent>
    </Card>
  )
}

--- FILE: components\ai-settings-dialog.tsx ---

"use client"
import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogTitle, DialogDescription } from "@/components/ui/dialog"
import { Label } from "@/components/ui/label"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import {
  Settings,
  Box,
  CheckCircle2,
  Bot,
  Sparkles,
  Globe,
  Palette,
  LayoutGrid
} from "lucide-react"
import { cn } from "@/lib/utils"
import { useTheme } from "next-themes"
interface AISettings {
  apiKey: string
  apiUrl: string
  model: string
  systemPrompt: string
}
interface AISettingsDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSave: (settings: AISettings) => void
}
type TabId = "model" | "general"
export function AISettingsDialog({ open, onOpenChange, onSave }: AISettingsDialogProps) {
  const { theme, setTheme } = useTheme()
  const [activeTab, setActiveTab] = useState<TabId>("model")
  const [settings, setSettings] = useState<AISettings>({
    apiKey: "",
    apiUrl: "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
    model: "",
    systemPrompt:
      "你是莓界智慧农业平台的AI助手，专门帮助用户分析农业数据、提供种植建议和解答农业相关问题。请用专业但易懂的语言回答问题。\n\n重要提醒：如果需要提供参考来源，请确保所有链接和信息都是真实存在的，绝对不要编造虚假的网站或来源。如果不确定来源，请直接说明这是基于你的知识库回答，而不是提供虚假引用。",
  })
  const [apiType, setApiType] = useState<"dashscope" | "openai">("dashscope")
  const [isSaving, setIsSaving] = useState(false)
  useEffect(() => {
    if (!open) return
    const loadSettings = async () => {
      try {
        const response = await fetch("/api/settings")
        if (response.ok) {
          const serverSettings = await response.json()
          const savedStr = localStorage.getItem("ai-settings")
          const localSettings = savedStr ? JSON.parse(savedStr) : null
          const shouldUseLocal = !serverSettings?.apiKey || String(serverSettings.apiKey).trim() === ''
          const effective = shouldUseLocal && localSettings ? localSettings : serverSettings
          setSettings(effective)
          if (effective.apiUrl?.includes("dashscope") || effective.model?.startsWith("qwen")) {
            setApiType("dashscope")
          } else {
            setApiType("openai")
          }
        } else {
          const saved = localStorage.getItem("ai-settings")
          if (saved) {
            const parsed = JSON.parse(saved)
            setSettings(parsed)
            if (parsed.apiUrl?.includes("dashscope") || parsed.model?.startsWith("qwen")) {
              setApiType("dashscope")
            } else {
              setApiType("openai")
            }
          }
        }
      } catch {
        const saved = localStorage.getItem("ai-settings")
        if (saved) {
          try {
            const parsed = JSON.parse(saved)
            setSettings(parsed)
            if (parsed.apiUrl?.includes("dashscope") || parsed.model?.startsWith("qwen")) {
              setApiType("dashscope")
            } else {
              setApiType("openai")
            }
          } catch {}
        }
      }
    }
    loadSettings()
  }, [open])
  const handleSave = async () => {
    setIsSaving(true)
    try {
      const response = await fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(settings),
      })
      if (response.ok) {
        localStorage.setItem("ai-settings", JSON.stringify(settings))
        onSave(settings)
        onOpenChange(false)
      } else {
        const error = await response.json()
        alert(`保存失败: ${error.error || "未知错误"}`)
      }
    } catch {
      localStorage.setItem("ai-settings", JSON.stringify(settings))
      onSave(settings)
      onOpenChange(false)
    } finally {
      setIsSaving(false)
    }
  }
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl p-0 overflow-hidden gap-0 h-[650px] flex flex-row border-none shadow-2xl bg-white dark:bg-zinc-950 sm:rounded-2xl">
         {/* Sidebar */}
         <div className="w-64 bg-gray-50/80 dark:bg-zinc-900/50 border-r border-gray-200/50 dark:border-white/10 p-4 flex flex-col gap-2 shrink-0">
            <div className="px-2 py-3 mb-2">
               <h2 className="font-bold text-xl tracking-tight">Settings</h2>
            </div>
            <SidebarItem
              icon={Box}
              label="模型设置"
              active={activeTab === "model"}
              onClick={() => setActiveTab("model")}
            />
            <SidebarItem
              icon={Settings}
              label="常规"
              active={activeTab === "general"}
              onClick={() => setActiveTab("general")}
            />
         </div>
         {/* Content Area */}
         <div className="flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-zinc-950">
            {/* Header */}
            <div className="px-8 py-6 border-b border-gray-100 dark:border-white/5 flex items-center justify-between bg-white dark:bg-zinc-950 z-10">
              <div>
                <DialogTitle className="text-xl font-semibold">
                  {activeTab === "model" ? "模型配置" : "常规设置"}
                </DialogTitle>
                <DialogDescription className="mt-1.5">
                  {activeTab === "model" ? "配置您的专属 AI 助手模型参数" : "调整应用的基础设置"}
                </DialogDescription>
              </div>
              <div className="flex gap-3">
                 <Button variant="outline" onClick={() => onOpenChange(false)}>取消</Button>
                 <Button onClick={handleSave} disabled={isSaving} className="min-w-[80px]">
                   {isSaving ? "保存中..." : "保存"}
                 </Button>
              </div>
            </div>
            {/* Scrollable Form */}
            <div className="flex-1 overflow-y-auto p-8">
               {activeTab === "model" && (
                 <div className="space-y-8 max-w-2xl">
                    {/* API Type Selector */}
                    <div className="space-y-4">
                      <Label className="text-sm font-medium text-gray-700 dark:text-gray-300">服务提供商</Label>
                      <div className="grid grid-cols-2 gap-3">
                        <ProviderCard
                          active={apiType === "dashscope"}
                          onClick={() => {
                            setApiType("dashscope")
                            setSettings({
                              ...settings,
                              apiUrl: "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
                            })
                          }}
                          icon={Sparkles}
                          title="阿里云百炼"
                          desc="推荐国内用户，Qwen系列"
                        />
                        <ProviderCard
                          active={apiType === "openai"}
                          onClick={() => {
                            setApiType("openai")
                            setSettings({
                              ...settings,
                              apiUrl: "https://api.openai.com/v1/chat/completions",
                            })
                          }}
                          icon={Bot}
                          title="OpenAI"
                          desc="GPT-3.5, GPT-4"
                        />
                      </div>
                    </div>
                    <div className="space-y-4">
                      <div className="space-y-2">
                        <Label htmlFor="model">模型名称</Label>
                        <Input
                          id="model"
                          placeholder={apiType === "dashscope" ? "例如: qwen-plus" : "例如: gpt-3.5-turbo"}
                          value={settings.model}
                          onChange={(e) => setSettings({ ...settings, model: e.target.value })}
                          className="h-10"
                        />
                        <p className="text-[13px] text-muted-foreground">
                          {apiType === "dashscope"
                            ? "可用模型: qwen-turbo, qwen-plus, qwen-max, qwen-vl-plus, qwen-vl-max"
                            : "可用模型: gpt-3.5-turbo, gpt-4, gpt-4-turbo"}
                        </p>
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="apiKey">API Key</Label>
                        <Input
                          id="apiKey"
                          type="password"
                          placeholder="sk-..."
                          value={settings.apiKey}
                          onChange={(e) => setSettings({ ...settings, apiKey: e.target.value })}
                          className="h-10"
                        />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="apiUrl">API URL</Label>
                        <Input
                          id="apiUrl"
                          value={settings.apiUrl}
                          onChange={(e) => setSettings({ ...settings, apiUrl: e.target.value })}
                          className="h-10 font-mono text-sm"
                        />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="systemPrompt">系统提示词</Label>
                        <Textarea
                          id="systemPrompt"
                          value={settings.systemPrompt}
                          onChange={(e) => setSettings({ ...settings, systemPrompt: e.target.value })}
                          className="min-h-[120px] resize-none leading-relaxed"
                        />
                        <p className="text-[13px] text-muted-foreground">定义 AI 助手的角色和行为准则。</p>
                      </div>
                    </div>
                 </div>
               )}
               {activeTab === "general" && (
                 <div className="space-y-8 max-w-2xl">
                    <div className="space-y-4">
                      <Label>界面主题</Label>
                      <div className="grid grid-cols-3 gap-3">
                         <div
                           className={cn(
                             "border-2 rounded-lg p-3 flex flex-col items-center gap-2 cursor-pointer transition-all",
                             theme === 'system'
                               ? "border-blue-500 bg-blue-50/50"
                               : "border-gray-200 hover:border-gray-300"
                           )}
                           onClick={() => setTheme('system')}
                         >
                            <div className="w-full aspect-video bg-gradient-to-br from-white to-zinc-900 rounded border border-gray-200 shadow-sm"></div>
                            <span className={cn("text-sm font-medium", theme === 'system' ? "text-blue-700" : "text-gray-600")}>System</span>
                         </div>
                         <div
                           className={cn(
                             "border-2 rounded-lg p-3 flex flex-col items-center gap-2 cursor-pointer transition-all",
                             theme === 'light'
                               ? "border-blue-500 bg-blue-50/50"
                               : "border-gray-200 hover:border-gray-300"
                           )}
                           onClick={() => setTheme('light')}
                         >
                            <div className="w-full aspect-video bg-white rounded border border-gray-200 shadow-sm"></div>
                            <span className={cn("text-sm font-medium", theme === 'light' ? "text-blue-700" : "text-gray-600")}>Light</span>
                         </div>
                         <div
                           className={cn(
                             "border-2 rounded-lg p-3 flex flex-col items-center gap-2 cursor-pointer transition-all",
                             theme === 'dark'
                               ? "border-blue-500 bg-blue-50/50"
                               : "border-gray-200 hover:border-gray-300"
                           )}
                           onClick={() => setTheme('dark')}
                         >
                            <div className="w-full aspect-video bg-zinc-900 rounded border border-gray-800 shadow-sm"></div>
                            <span className={cn("text-sm font-medium", theme === 'dark' ? "text-blue-700" : "text-gray-600")}>Dark</span>
                         </div>
                      </div>
                    </div>
                    <div className="space-y-4">
                       <Label>语言 (Language)</Label>
                       <div className="flex flex-col gap-1">
                          <div className="flex items-center justify-between p-3 rounded-lg border border-blue-200 bg-blue-50/30 cursor-pointer">
                             <div className="flex items-center gap-3">
                                <Globe size={18} className="text-blue-600" />
                                <span className="text-sm font-medium">中文 (简体)</span>
                             </div>
                             <CheckCircle2 size={18} className="text-blue-600" />
                          </div>
                          <div className="flex items-center justify-between p-3 rounded-lg border border-transparent hover:bg-gray-50 cursor-pointer opacity-60">
                             <div className="flex items-center gap-3">
                                <Globe size={18} className="text-gray-500" />
                                <span className="text-sm font-medium">English (US)</span>
                             </div>
                          </div>
                       </div>
                    </div>
                 </div>
               )}
            </div>
         </div>
      </DialogContent>
    </Dialog>
  )
}
function SidebarItem({ icon: Icon, label, active, onClick }: { icon: any, label: string, active: boolean, onClick: () => void }) {
  return (
    <button
      onClick={onClick}
      className={cn(
        "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 text-left w-full",
        active
          ? "bg-white dark:bg-white/10 text-gray-900 dark:text-white shadow-sm ring-1 ring-gray-200 dark:ring-white/10"
          : "text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100/50 dark:hover:bg-white/5"
      )}
    >
      <Icon size={18} className={cn(active ? "text-blue-600 dark:text-blue-400" : "text-gray-400")} />
      {label}
    </button>
  )
}
function ProviderCard({ active, onClick, icon: Icon, title, desc }: { active: boolean, onClick: () => void, icon: any, title: string, desc: string }) {
  return (
    <div
      onClick={onClick}
      className={cn(
        "relative cursor-pointer rounded-xl border p-4 transition-all duration-200 hover:shadow-md",
        active
          ? "border-blue-500 bg-blue-50/30 ring-1 ring-blue-500/20"
          : "border-gray-200 hover:border-gray-300 bg-white"
      )}
    >
       <div className="flex items-start justify-between mb-2">
          <div className={cn("p-2 rounded-lg", active ? "bg-blue-100 text-blue-600" : "bg-gray-100 text-gray-500")}>
             <Icon size={20} />
          </div>
          {active && <CheckCircle2 size={18} className="text-blue-500" />}
       </div>
       <div className="font-semibold text-sm text-gray-900 mb-0.5">{title}</div>
       <div className="text-xs text-gray-500">{desc}</div>
    </div>
  )
}

--- FILE: components\chart-renderer.tsx ---

"use client"
import React, { useEffect, useRef, useState } from 'react'
import ReactECharts from 'echarts-for-react'
// Dynamic import for Vega-Lite to avoid SSR issues and reduce initial bundle size
import dynamic from 'next/dynamic'
// Create a dynamic component for Vega Lite
const VegaLiteChart = dynamic(() => import('./vega-chart'), {
  ssr: false,
  loading: () => <div className="flex items-center justify-center h-full text-gray-400 text-sm">Loading chart...</div>
})
interface ChartRendererProps {
  options: any
  type?: 'echarts' | 'vega-lite'
  style?: React.CSSProperties
  className?: string
}
export default function ChartRenderer({ options, type = 'echarts', style, className }: ChartRendererProps) {
  if (type === 'vega-lite') {
    return (
      <div className={className} style={{ width: '100%', height: '400px', ...style }}>
         <VegaLiteChart spec={options} />
      </div>
    )
  }
  return (
    <div className={className} style={{ width: '100%', height: '400px', ...style }}>
      <ReactECharts
        option={options}
        style={{ width: '100%', height: '100%' }}
        notMerge={true}
        lazyUpdate={true}
      />
    </div>
  )
}

--- FILE: components\ColorBends.tsx ---

import React, { useEffect, useRef } from 'react';
import * as THREE from 'three';
type ColorBendsProps = {
  className?: string;
  style?: React.CSSProperties;
  rotation?: number;
  speed?: number;
  colors?: string[];
  transparent?: boolean;
  autoRotate?: number;
  scale?: number;
  frequency?: number;
  warpStrength?: number;
  mouseInfluence?: number;
  parallax?: number;
  noise?: number;
};
const MAX_COLORS = 8 as const;
const frag = `
#define MAX_COLORS ${MAX_COLORS}
uniform vec2 uCanvas;
uniform float uTime;
uniform float uSpeed;
uniform vec2 uRot;
uniform int uColorCount;
uniform vec3 uColors[MAX_COLORS];
uniform int uTransparent;
uniform float uScale;
uniform float uFrequency;
uniform float uWarpStrength;
uniform vec2 uPointer; // in NDC [-1,1]
uniform float uMouseInfluence;
uniform float uParallax;
uniform float uNoise;
varying vec2 vUv;
void main() {
  float t = uTime * uSpeed;
  vec2 p = vUv * 2.0 - 1.0;
  p += uPointer * uParallax * 0.1;
  vec2 rp = vec2(p.x * uRot.x - p.y * uRot.y, p.x * uRot.y + p.y * uRot.x);
  vec2 q = vec2(rp.x * (uCanvas.x / uCanvas.y), rp.y);
  q /= max(uScale, 0.0001);
  q /= 0.5 + 0.2 * dot(q, q);
  q += 0.2 * cos(t) - 7.56;
  vec2 toward = (uPointer - rp);
  q += toward * uMouseInfluence * 0.2;
    vec3 col = vec3(0.0);
    float a = 1.0;
    if (uColorCount > 0) {
      vec2 s = q;
      vec3 sumCol = vec3(0.0);
      float cover = 0.0;
      for (int i = 0; i < MAX_COLORS; ++i) {
            if (i >= uColorCount) break;
            s -= 0.01;
            vec2 r = sin(1.5 * (s.yx * uFrequency) + 2.0 * cos(s * uFrequency));
            float m0 = length(r + sin(5.0 * r.y * uFrequency - 3.0 * t + float(i)) / 4.0);
            float kBelow = clamp(uWarpStrength, 0.0, 1.0);
            float kMix = pow(kBelow, 0.3); // strong response across 0..1
            float gain = 1.0 + max(uWarpStrength - 1.0, 0.0); // allow >1 to amplify displacement
            vec2 disp = (r - s) * kBelow;
            vec2 warped = s + disp * gain;
            float m1 = length(warped + sin(5.0 * warped.y * uFrequency - 3.0 * t + float(i)) / 4.0);
            float m = mix(m0, m1, kMix);
            float w = 1.0 - exp(-6.0 / exp(6.0 * m));
            sumCol += uColors[i] * w;
            cover = max(cover, w);
      }
      col = clamp(sumCol, 0.0, 1.0);
      a = uTransparent > 0 ? cover : 1.0;
    } else {
        vec2 s = q;
        for (int k = 0; k < 3; ++k) {
            s -= 0.01;
            vec2 r = sin(1.5 * (s.yx * uFrequency) + 2.0 * cos(s * uFrequency));
            float m0 = length(r + sin(5.0 * r.y * uFrequency - 3.0 * t + float(k)) / 4.0);
            float kBelow = clamp(uWarpStrength, 0.0, 1.0);
            float kMix = pow(kBelow, 0.3);
            float gain = 1.0 + max(uWarpStrength - 1.0, 0.0);
            vec2 disp = (r - s) * kBelow;
            vec2 warped = s + disp * gain;
            float m1 = length(warped + sin(5.0 * warped.y * uFrequency - 3.0 * t + float(k)) / 4.0);
            float m = mix(m0, m1, kMix);
            col[k] = 1.0 - exp(-6.0 / exp(6.0 * m));
        }
        a = uTransparent > 0 ? max(max(col.r, col.g), col.b) : 1.0;
    }
    if (uNoise > 0.0001) {
      float n = fract(sin(dot(gl_FragCoord.xy + vec2(uTime), vec2(12.9898, 78.233))) * 43758.5453123);
      col += (n - 0.5) * uNoise;
      col = clamp(col, 0.0, 1.0);
    }
    vec3 rgb = (uTransparent > 0) ? col * a : col;
    gl_FragColor = vec4(rgb, a);
}
`;
const vert = `
varying vec2 vUv;
void main() {
  vUv = uv;
  gl_Position = vec4(position, 1.0);
}
`;
export default function ColorBends({
  className,
  style,
  rotation = 45,
  speed = 0.2,
  colors = [],
  transparent = true,
  autoRotate = 0,
  scale = 1,
  frequency = 1,
  warpStrength = 1,
  mouseInfluence = 1,
  parallax = 0.5,
  noise = 0.1
}: ColorBendsProps) {
  const containerRef = useRef<HTMLDivElement | null>(null);
  const rendererRef = useRef<THREE.WebGLRenderer | null>(null);
  const rafRef = useRef<number | null>(null);
  const materialRef = useRef<THREE.ShaderMaterial | null>(null);
  const resizeObserverRef = useRef<ResizeObserver | null>(null);
  const rotationRef = useRef<number>(rotation);
  const autoRotateRef = useRef<number>(autoRotate);
  const pointerTargetRef = useRef<THREE.Vector2>(new THREE.Vector2(0, 0));
  const pointerCurrentRef = useRef<THREE.Vector2>(new THREE.Vector2(0, 0));
  const pointerSmoothRef = useRef<number>(8);
  useEffect(() => {
    const container = containerRef.current!;
    const scene = new THREE.Scene();
    const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
    const geometry = new THREE.PlaneGeometry(2, 2);
    const uColorsArray = Array.from({ length: MAX_COLORS }, () => new THREE.Vector3(0, 0, 0));
    const material = new THREE.ShaderMaterial({
      vertexShader: vert,
      fragmentShader: frag,
      uniforms: {
        uCanvas: { value: new THREE.Vector2(1, 1) },
        uTime: { value: 0 },
        uSpeed: { value: speed },
        uRot: { value: new THREE.Vector2(1, 0) },
        uColorCount: { value: 0 },
        uColors: { value: uColorsArray },
        uTransparent: { value: transparent ? 1 : 0 },
        uScale: { value: scale },
        uFrequency: { value: frequency },
        uWarpStrength: { value: warpStrength },
        uPointer: { value: new THREE.Vector2(0, 0) },
        uMouseInfluence: { value: mouseInfluence },
        uParallax: { value: parallax },
        uNoise: { value: noise }
      },
      premultipliedAlpha: true,
      transparent: true
    });
    materialRef.current = material;
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);
    const renderer = new THREE.WebGLRenderer({
      antialias: false,
      powerPreference: 'high-performance',
      alpha: true
    });
    rendererRef.current = renderer;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setClearColor(0x000000, transparent ? 0 : 1);
    renderer.domElement.style.width = '100%';
    renderer.domElement.style.height = '100%';
    renderer.domElement.style.display = 'block';
    container.appendChild(renderer.domElement);
    const clock = new THREE.Clock();
    const handleResize = () => {
      const w = container.clientWidth || 1;
      const h = container.clientHeight || 1;
      renderer.setSize(w, h, false);
      (material.uniforms.uCanvas.value as THREE.Vector2).set(w, h);
    };
    handleResize();
    if ('ResizeObserver' in window) {
      const ro = new ResizeObserver(handleResize);
      ro.observe(container);
      resizeObserverRef.current = ro;
    } else {
      (window as Window).addEventListener('resize', handleResize);
    }
    const loop = () => {
      const dt = clock.getDelta();
      const elapsed = clock.elapsedTime;
      material.uniforms.uTime.value = elapsed;
      const deg = (rotationRef.current % 360) + autoRotateRef.current * elapsed;
      const rad = (deg * Math.PI) / 180;
      const c = Math.cos(rad);
      const s = Math.sin(rad);
      (material.uniforms.uRot.value as THREE.Vector2).set(c, s);
      const cur = pointerCurrentRef.current;
      const tgt = pointerTargetRef.current;
      const amt = Math.min(1, dt * pointerSmoothRef.current);
      cur.lerp(tgt, amt);
      (material.uniforms.uPointer.value as THREE.Vector2).copy(cur);
      renderer.render(scene, camera);
      rafRef.current = requestAnimationFrame(loop);
    };
    rafRef.current = requestAnimationFrame(loop);
    return () => {
      if (rafRef.current !== null) cancelAnimationFrame(rafRef.current);
      if (resizeObserverRef.current) resizeObserverRef.current.disconnect();
      else (window as Window).removeEventListener('resize', handleResize);
      geometry.dispose();
      material.dispose();
      renderer.dispose();
      if (renderer.domElement && renderer.domElement.parentElement === container) {
        container.removeChild(renderer.domElement);
      }
    };
  }, []);
  useEffect(() => {
    const material = materialRef.current;
    const renderer = rendererRef.current;
    if (!material) return;
    rotationRef.current = rotation;
    autoRotateRef.current = autoRotate;
    material.uniforms.uSpeed.value = speed;
    material.uniforms.uScale.value = scale;
    material.uniforms.uFrequency.value = frequency;
    material.uniforms.uWarpStrength.value = warpStrength;
    material.uniforms.uMouseInfluence.value = mouseInfluence;
    material.uniforms.uParallax.value = parallax;
    material.uniforms.uNoise.value = noise;
    const toVec3 = (hex: string) => {
      const h = hex.replace('#', '').trim();
      const v =
        h.length === 3
          ? [parseInt(h[0] + h[0], 16), parseInt(h[1] + h[1], 16), parseInt(h[2] + h[2], 16)]
          : [parseInt(h.slice(0, 2), 16), parseInt(h.slice(2, 4), 16), parseInt(h.slice(4, 6), 16)];
      return new THREE.Vector3(v[0] / 255, v[1] / 255, v[2] / 255);
    };
    const arr = (colors || []).filter(Boolean).slice(0, MAX_COLORS).map(toVec3);
    for (let i = 0; i < MAX_COLORS; i++) {
      const vec = (material.uniforms.uColors.value as THREE.Vector3[])[i];
      if (i < arr.length) vec.copy(arr[i]);
      else vec.set(0, 0, 0);
    }
    material.uniforms.uColorCount.value = arr.length;
    material.uniforms.uTransparent.value = transparent ? 1 : 0;
    if (renderer) renderer.setClearColor(0x000000, transparent ? 0 : 1);
  }, [
    rotation,
    autoRotate,
    speed,
    scale,
    frequency,
    warpStrength,
    mouseInfluence,
    parallax,
    noise,
    colors,
    transparent
  ]);
  useEffect(() => {
    const material = materialRef.current;
    const container = containerRef.current;
    if (!material || !container) return;
    const handlePointerMove = (e: PointerEvent) => {
      const rect = container.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / (rect.width || 1)) * 2 - 1;
      const y = -(((e.clientY - rect.top) / (rect.height || 1)) * 2 - 1);
      pointerTargetRef.current.set(x, y);
    };
    container.addEventListener('pointermove', handlePointerMove);
    return () => {
      container.removeEventListener('pointermove', handlePointerMove);
    };
  }, []);
  return <div ref={containerRef} className={`w-full h-full relative overflow-hidden ${className}`} style={style} />;
}

--- FILE: components\dashboard\DashboardChartCard.tsx ---

"use client"
import { useState, useEffect, useRef } from "react"
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import dynamic from "next/dynamic"
import { Loader2 } from "lucide-react"
const ReactECharts = dynamic(() => import("echarts-for-react"), { ssr: false })
interface DashboardChartCardProps {
    title: string
    value: string | number
    unit: string
    icon: React.ReactNode
    type: string // API type parameter
    color: string // Tailwind color class prefix (e.g., 'blue', 'orange')
    gradientColor: string // Hex color for chart gradient
    deviceData?: any // Pass realtime data if needed for current value
    initialHistoryData?: any[]
}
export function DashboardChartCard({
    title,
    value,
    unit,
    icon,
    type,
    color,
    gradientColor,
    initialHistoryData,
}: DashboardChartCardProps) {
    const [timeRange, setTimeRange] = useState("1h")
    const [historyData, setHistoryData] = useState<any[]>(initialHistoryData || [])
    const [isLoading, setIsLoading] = useState(false)
    // Track if we have used the initial data to avoid refetching on mount
    const isFirstRender = useRef(true)
    useEffect(() => {
        // Skip fetch on first render if we have initial data
        if (isFirstRender.current) {
            isFirstRender.current = false
            if (initialHistoryData) {
                return
            }
        }
        const fetchHistory = async () => {
            setIsLoading(true)
            try {
                const res = await fetch(`/api/device-history?type=${type}&range=${timeRange}`)
                const data = await res.json()
                if (data.success) {
                    setHistoryData(data.data)
                }
            } catch (error) {
                console.error("Failed to fetch history:", error)
            } finally {
                setIsLoading(false)
            }
        }
        fetchHistory()
    }, [type, timeRange])
    // Update historyData if initialHistoryData changes (e.g. parent refetches)
    // Note: We need to be careful not to overwrite user-selected range data with default range data from parent
    // But since parent only fetches on mount, this is mostly fine.
    useEffect(() => {
        if (initialHistoryData && timeRange === '1h') {
             setHistoryData(initialHistoryData)
        }
    }, [initialHistoryData])
    const getOption = () => {
        return {
            grid: {
                top: 10,
                right: 0,
                bottom: 0,
                left: 0,
                containLabel: false
            },
            tooltip: {
                trigger: 'axis',
                formatter: (params: any) => {
                    const date = new Date(params[0].value[0])
                    const timeStr = timeRange === '7d'
                        ? `${date.getMonth() + 1}-${date.getDate()}`
                        : `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`
                    return `${timeStr}<br/>${params[0].value[1]} ${unit}`
                }
            },
            xAxis: {
                type: 'time',
                show: false,
                boundaryGap: false
            },
            yAxis: {
                type: 'value',
                show: false,
                min: (value: any) => Math.floor(value.min * 0.9),
            },
            series: [
                {
                    data: historyData.map(item => [item.timestamp, item.value]),
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        color: gradientColor,
                        width: 2
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: `${gradientColor}33` // 20% opacity
                            }, {
                                offset: 1, color: `${gradientColor}00` // 0% opacity
                            }],
                        }
                    }
                }
            ]
        }
    }
    return (
        <Card className="h-full border-none shadow-sm hover:shadow-md transition-all duration-200">
            <CardContent className="p-6 h-full flex flex-col">
                <div className="flex justify-between items-start mb-2">
                    <div className="flex items-center gap-2">
                        <div className={`p-2 rounded-2xl bg-${color}-100 dark:bg-${color}-900/20 text-${color}-600 dark:text-${color}-400`}>
                            {icon}
                        </div>
                        <div>
                            <p className="text-sm font-medium text-muted-foreground">{title}</p>
                            <div className="flex items-baseline gap-1">
                                <h3 className="text-2xl font-bold">{value}</h3>
                                <span className="text-sm text-muted-foreground">{unit}</span>
                            </div>
                        </div>
                    </div>
                    <Select value={timeRange} onValueChange={setTimeRange}>
                        <SelectTrigger className="w-[70px] h-8 text-xs">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="1h">1h</SelectItem>
                            <SelectItem value="1d">24h</SelectItem>
                            <SelectItem value="7d">7d</SelectItem>
                        </SelectContent>
                    </Select>
                </div>
                <div className="flex-1 w-full min-h-0 relative">
                    {isLoading && (
                        <div className="absolute inset-0 flex items-center justify-center bg-background/50 z-10">
                            <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                        </div>
                    )}
                    <ReactECharts
                        option={getOption()}
                        style={{ height: '100%', width: '100%' }}
                        opts={{ renderer: 'svg' }} // Use SVG renderer for better performance
                    />
                </div>
            </CardContent>
        </Card>
    )
}

--- FILE: components\dashboard\spectral-card.tsx ---

import React, { useState } from 'react'
import dynamic from 'next/dynamic'
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { DeviceData } from "@/lib/hooks/use-device-data"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
const ReactECharts = dynamic(() => import("echarts-for-react"), { ssr: false })
interface SpectralCardProps {
  data: DeviceData | null
}
export function SpectralCard({ data }: SpectralCardProps) {
  const [timeRange, setTimeRange] = useState("1h")
  // Define spectral channels configuration
  const channels = [
    { id: 'channel1', name: '415', label: 'Violet', color: '#8B00FF' },
    { id: 'channel2', name: '445', label: 'Blue', color: '#0000FF' },
    { id: 'channel3', name: '480', label: 'Cyan', color: '#00FFFF' },
    { id: 'channel4', name: '515', label: 'Green', color: '#00FF00' },
    { id: 'channel5', name: '555', label: 'Y-G', color: '#ADFF2F' },
    { id: 'channel6', name: '590', label: 'Yellow', color: '#FFFF00' },
    { id: 'channel7', name: '630', label: 'Orange', color: '#FFA500' },
    { id: 'channel8', name: '680', label: 'Red', color: '#FF0000' },
    { id: 'channel9', name: 'NIR', label: 'NIR', color: '#8B0000' },
    { id: 'channel10', name: 'Clr', label: 'Clear', color: '#E0E0E0' },
    { id: 'channel11', name: 'Fli', label: 'Flicker', color: '#808080' },
  ]
  // Find the channel with max value to display prominently
  const maxChannel = channels.reduce((prev, current) => {
    const prevVal = data ? (data[prev.id as keyof DeviceData] as number) || 0 : 0
    const currVal = data ? (data[current.id as keyof DeviceData] as number) || 0 : 0
    return currVal > prevVal ? current : prev
  })
  const maxValue = data ? (data[maxChannel.id as keyof DeviceData] as number) || 0 : 0
  // Prepare chart option
  const getOption = () => {
    const xAxisData = channels.map(c => c.name)
    const seriesData = channels.map(c => {
      const value = data ? (data[c.id as keyof DeviceData] as number) || 0 : 0
      return {
        value,
        itemStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [
              { offset: 0, color: c.color },
              { offset: 1, color: `${c.color}40` } // Fade to transparency
            ]
          },
          borderRadius: [4, 4, 0, 0]
        }
      }
    })
    return {
      grid: {
        top: 5,
        right: 0,
        bottom: 0,
        left: 0,
        containLabel: false
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'none' // Hide axis pointer line for cleaner look
        },
        formatter: (params: any) => {
          const param = params[0]
          const channel = channels[param.dataIndex]
          return `
            <div class="font-bold">${channel.label} (${channel.name}nm)</div>
            <div>Value: ${param.value}</div>
          `
        }
      },
      xAxis: {
        type: 'category',
        data: xAxisData,
        show: false, // Hide x axis
        axisLine: { show: false },
        axisTick: { show: false },
      },
      yAxis: {
        type: 'value',
        show: false, // Hide y axis
        splitLine: { show: false }
      },
      series: [
        {
          type: 'bar',
          barWidth: '60%',
          data: seriesData,
          showBackground: true,
          backgroundStyle: {
            color: 'rgba(240, 240, 240, 0.2)',
            borderRadius: [4, 4, 0, 0]
          },
          // Add a smooth line on top for the "trend" look from reference
          // Using a separate line series for the smooth curve effect
        },
        {
            type: 'line',
            data: seriesData.map(d => d.value),
            smooth: true,
            symbol: 'none',
            lineStyle: {
                width: 2,
                color: '#e879f9' // Pinkish purple line
            },
            areaStyle: {
                color: {
                    type: 'linear',
                    x: 0,
                    y: 0,
                    x2: 0,
                    y2: 1,
                    colorStops: [
                        { offset: 0, color: 'rgba(232, 121, 249, 0.2)' },
                        { offset: 1, color: 'rgba(232, 121, 249, 0.05)' }
                    ]
                }
            }
        }
      ]
    }
  }
  return (
    <Card className="h-full border-none shadow-sm hover:shadow-md transition-all duration-200 cursor-move flex flex-col">
      <CardContent className="p-6 flex-1 flex flex-col justify-between">
        <div className="flex items-start justify-between mb-4">
          <div>
            <div className="text-5xl font-bold text-foreground mb-2">
              {maxValue}
              <span className="text-2xl font-normal text-muted-foreground ml-1">µmol</span>
            </div>
            <div className="flex items-center gap-2">
              <Badge className="bg-pink-500/20 text-pink-600 border-pink-500/30 rounded-full px-3">
                光谱分析 (Spectral)
              </Badge>
              <Select value={timeRange} onValueChange={setTimeRange}>
                <SelectTrigger className="h-6 w-[80px] text-xs bg-transparent border-none focus:ring-0 p-0 text-muted-foreground hover:text-foreground">
                    <SelectValue placeholder="Range" />
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="1h">1 小时</SelectItem>
                    <SelectItem value="1d">1 天</SelectItem>
                    <SelectItem value="7d">7 天</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
          {/* Circular Icon Badge similar to reference */}
          <div className="size-10 rounded-full bg-pink-400 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-pink-400/30">
            S
          </div>
        </div>
        <div className="h-24 w-full relative -mb-2">
          <ReactECharts
            option={getOption()}
            style={{ height: '100%', width: '100%' }}
            opts={{ renderer: 'svg' }}
          />
        </div>
      </CardContent>
    </Card>
  )
}

--- FILE: components\environment-alert.tsx ---

"use client"
import { useEffect, useRef, useState } from "react"
import { useDeviceData } from "@/lib/hooks/use-device-data"
import { useDeviceControl } from "@/lib/hooks/use-device-control"
import { toast } from "sonner"
import { usePathname } from "next/navigation"
type AlertType = 'temp_high' | 'humidity_high' | 'humidity_low' | 'co2_high' | 'light_low'
interface AlertConfig {
  type: AlertType
  title: string
  description: string
  actionLabel: string
  action: () => Promise<boolean>
}
export function EnvironmentAlert() {
  const { deviceData } = useDeviceData()
  const { toggleRelay } = useDeviceControl()
  const pathname = usePathname()
  const [alertsEnabled, setAlertsEnabled] = useState(true)
  // Cooldown to prevent spamming (5 minutes)
  const lastAlertTimeRef = useRef<number>(0)
  const COOLDOWN = 5 * 60 * 1000
  useEffect(() => {
    const fetchSettings = async () => {
      try {
        const res = await fetch("/api/auth/me")
        if (!res.ok) return
        const data = await res.json()
        if (data?.authenticated && data?.user?.notification_settings?.alerts !== undefined) {
          setAlertsEnabled(!!data.user.notification_settings.alerts)
        }
      } catch {
      }
    }
    if (pathname === "/" || pathname === "/login" || pathname === "/register") return
    fetchSettings()
  }, [pathname])
  useEffect(() => {
    // Don't show alerts on landing page, auth pages or if no data or if alerts disabled
    if (pathname === '/' || pathname === '/login' || pathname === '/register' || !deviceData || !alertsEnabled) return
    const now = Date.now()
    if (now - lastAlertTimeRef.current < COOLDOWN) return
    // Helper to check and trigger
    const checkAndTrigger = (condition: boolean, config: AlertConfig) => {
      if (condition) {
        lastAlertTimeRef.current = Date.now()
        toast.warning(config.title, {
          description: config.description,
          duration: Infinity, // Keep open until user interacts
          action: {
            label: config.actionLabel,
            onClick: async () => {
              const success = await config.action()
              if (success) {
                toast.success("已自动调整设备")
              } else {
                toast.error("设备调整失败")
              }
            }
          },
          cancel: {
            label: '忽略',
            onClick: () => {
              toast.info("已忽略建议")
            }
          },
        })
        return true
      }
      return false
    }
    // Temperature High (> 30) -> Turn on Fan (Relay 6)
    // Only alert if fan is currently OFF
    if (checkAndTrigger(
      deviceData.temperature > 30 && deviceData.relay6 === 0,
      {
        type: 'temp_high',
        title: '高温预警',
        description: `当前温度 (${deviceData.temperature}°C) 过高。是否开启通风风扇进行降温？`,
        actionLabel: '开启风扇',
        action: () => toggleRelay(6, 0)
      }
    )) return
    // Humidity High (> 80) -> Turn on Fan (Relay 6)
    if (checkAndTrigger(
      deviceData.humidity > 80 && deviceData.relay6 === 0,
      {
        type: 'humidity_high',
        title: '高湿预警',
        description: `当前湿度 (${deviceData.humidity}%) 过高。是否开启通风风扇进行除湿？`,
        actionLabel: '开启风扇',
        action: () => toggleRelay(6, 0)
      }
    )) return
    // CO2 High (> 1000) -> Turn on Fan (Relay 6)
    if (checkAndTrigger(
      deviceData.co2 > 1000 && deviceData.relay6 === 0,
      {
        type: 'co2_high',
        title: 'CO2浓度预警',
        description: `当前CO2浓度 (${deviceData.co2}ppm) 过高。是否开启通风风扇？`,
        actionLabel: '开启风扇',
        action: () => toggleRelay(6, 0)
      }
    )) return
    // Light Low (< 1000) -> Turn on Grow Light (Relay 7)
    // Only check if light is OFF
    if (checkAndTrigger(
      deviceData.light < 1000 && deviceData.relay7 === 0,
      {
        type: 'light_low',
        title: '光照不足预警',
        description: `当前光照 (${deviceData.light} Lux) 不足。是否开启补光灯？`,
        actionLabel: '开启补光灯',
        action: () => toggleRelay(7, 0)
      }
    )) return
  }, [deviceData, toggleRelay])
  return null
}

--- FILE: components\landing\ai-chat-section.tsx ---

"use client"
import { motion, useScroll, useTransform, useInView } from "framer-motion"
import { useRef, useEffect, useState } from "react"
import { Sparkles, Send, Bot, User, RefreshCw } from "lucide-react"
import Image from "next/image"
import { MonitorCardMock, TaskCardMock, DeviceControlCardMock, DiseaseCardMock, DataChartCardMock } from "./chat-cards"
type ScenarioType = "disease" | "planting" | "device" | "data"
const scenarios = {
  planting: [
    { role: "user", text: "现在的草莓生长情况怎么样？" },
    { role: "ai", text: "根据最新的传感器数据，目前温室温度 24°C，湿度 65%，非常适合草莓生长。图像分析显示果实已进入成熟期，建议适当增加光照时长。", component: <MonitorCardMock /> },
    { role: "user", text: "帮我开启补光灯，设定时长2小时" },
    { role: "ai", text: "好的，已为您开启补光灯，预计将在 16:30 自动关闭。还需要其他操作吗？", component: <TaskCardMock /> }
  ],
  disease: [
    { role: "user", text: "这片叶子看起来有点不对劲，帮我看看？" },
    { role: "ai", text: "正在分析图像... 检测到草莓白粉病的早期症状。这种病菌在高湿环境下容易滋生。", component: <DiseaseCardMock /> },
    { role: "user", text: "那我该怎么处理？" },
    { role: "ai", text: "建议您立即移除受感染的叶片，并开启排风扇降低湿度。我已经为您生成了具体的防治方案。" }
  ],
  device: [
    { role: "user", text: "把排风扇都打开，保持通风" },
    { role: "ai", text: "收到，正在开启排风扇...", component: <DeviceControlCardMock /> },
    { role: "ai", text: "排风扇已全部开启。当前风速等级：中等。您可以随时调整。" }
  ],
  data: [
    { role: "user", text: "我想看看最近一周的生长数据" },
    { role: "ai", text: "好的，这是近7天的环境数据分析报告。可以看到周三的温度波动较大，可能需要注意保温。", component: <DataChartCardMock /> },
    { role: "user", text: "导出这份报告" },
    { role: "ai", text: "报告已生成并发送到您的邮箱，请查收。" }
  ]
}
export function AiChatSection() {
  const containerRef = useRef<HTMLDivElement>(null)
  const chatRef = useRef<HTMLDivElement>(null)
  const isInView = useInView(chatRef, { margin: "-20% 0px -20% 0px" })
  const [activeMessageIndex, setActiveMessageIndex] = useState(-1)
  const [activeScenario, setActiveScenario] = useState<ScenarioType>("planting")
  const [isTyping, setIsTyping] = useState(false)
  // Reset chat when scenario changes or view changes
  useEffect(() => {
    if (isInView) {
      setActiveMessageIndex(-1)
      setIsTyping(false)
      let timeout: NodeJS.Timeout
      const playScenario = async () => {
        const messages = scenarios[activeScenario]
        for (let i = 0; i < messages.length; i++) {
          setIsTyping(true)
          // Typing delay
          await new Promise(r => setTimeout(r, 800))
          setIsTyping(false)
          setActiveMessageIndex(i)
          // Reading delay
          await new Promise(r => setTimeout(r, messages[i].text.length * 50 + 1000))
        }
      }
      playScenario()
      return () => {
        // Cleanup logic if needed, though async loop is hard to cancel cleanly without AbortController
        // simpler approach is to let it run but check mounted state if strictly needed
      }
    } else {
      setActiveMessageIndex(-1)
      setIsTyping(false)
    }
  }, [isInView, activeScenario])
  const handleScenarioChange = (scenario: ScenarioType) => {
    if (scenario === activeScenario) return
    setActiveScenario(scenario)
  }
  return (
    <section ref={containerRef} className="py-32 px-4 relative z-10 overflow-hidden">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
        {/* Text Content */}
        <motion.div
          initial={{ opacity: 0, x: -50 }}
          whileInView={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.5 }}
          className="space-y-8 lg:pr-12"
        >
          <h2 className="text-4xl md:text-5xl font-bold leading-tight">
            不懂种植技术？<br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-rose-400">
              问问 AI 助手
            </span>
          </h2>
          <p className="text-gray-400 text-lg leading-relaxed">
            内置的大语言模型不仅能回答您的种植疑问，还能直接帮您控制设备。
            就像拥有一位随叫随到的资深农业专家，让管理变得像聊天一样简单。
          </p>
          <div className="flex items-center gap-4 h-12">
            {[
              { id: "disease", label: "病虫害识别" },
              { id: "planting", label: "种植建议" },
              { id: "device", label: "设备控制" },
              { id: "data", label: "数据查询" }
            ].map((tag) => {
              const isActive = activeScenario === tag.id
              return (
                <button
                  key={tag.id}
                  onClick={() => handleScenarioChange(tag.id as ScenarioType)}
                  className="group relative flex items-center justify-center outline-none"
                >
                  <motion.div
                    layout
                    initial={false}
                    animate={{
                      height: isActive ? 40 : 10,
                      width: isActive ? "auto" : 10,
                      backgroundColor: isActive ? "rgba(236, 72, 153, 0.1)" : "rgba(55, 65, 81, 1)",
                    }}
                    transition={{ type: "spring", bounce: 0.2, duration: 0.6 }}
                    className={`rounded-full flex items-center justify-center overflow-hidden ${
                      isActive
                        ? "border border-pink-500/30 text-pink-300 shadow-[0_0_15px_rgba(236,72,153,0.2)]"
                        : "group-hover:bg-gray-600"
                    }`}
                  >
                     {isActive && (
                         <motion.span
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            transition={{ delay: 0.1 }}
                            className="text-sm px-5 whitespace-nowrap font-medium"
                         >
                            {tag.label}
                         </motion.span>
                     )}
                  </motion.div>
                  {/* Invisible Overlay for easier clicking on small dots */}
                  {!isActive && <div className="absolute inset-[-10px] z-10 cursor-pointer" />}
                </button>
              )
            })}
          </div>
        </motion.div>
        {/* Chat Simulation */}
        <div ref={chatRef} className="relative">
          <div className="absolute inset-0 bg-gradient-to-b from-pink-500/5 to-purple-500/5 rounded-3xl blur-xl" />
          <div className="relative bg-[#0A0A0A] border border-gray-800 rounded-3xl overflow-hidden shadow-2xl min-h-[500px] flex flex-col">
            {/* Header */}
            <div className="p-4 border-b border-gray-800 bg-[#0f0f0f]/80 backdrop-blur-sm flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center relative overflow-hidden">
                <Image
                  src="/logo.gif"
                  alt="AI Assistant"
                  fill
                  className="object-contain p-1"
                  unoptimized
                />
              </div>
              <div>
                <h3 className="font-semibold text-white">莓界 AI 助手</h3>
                <span className="text-xs text-green-400 flex items-center gap-1">
                  <span className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />
                  在线
                </span>
              </div>
            </div>
            {/* Messages Area */}
            <div className="flex-1 p-6 space-y-6 overflow-hidden flex flex-col justify-end">
              {scenarios[activeScenario].map((msg, i) => (
                <motion.div
                  key={`${activeScenario}-${i}`}
                  initial={{ opacity: 0, y: 20, scale: 0.95 }}
                  animate={{
                    opacity: i <= activeMessageIndex ? 1 : 0,
                    y: i <= activeMessageIndex ? 0 : 20,
                    scale: i <= activeMessageIndex ? 1 : 0.95
                  }}
                  transition={{ type: "spring", stiffness: 200, damping: 20 }}
                  className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                >
                  {msg.role === 'ai' && (
                    <div className="w-8 h-8 rounded-full bg-pink-500/20 flex-shrink-0 flex items-center justify-center mt-1 relative overflow-hidden">
                      <Image
                        src="/logo.gif"
                        alt="AI"
                        fill
                        className="object-contain p-1"
                        unoptimized
                      />
                    </div>
                  )}
                  <div className={`max-w-[80%] rounded-2xl p-4 text-sm leading-relaxed ${
                    msg.role === 'user'
                      ? 'bg-blue-600 text-white rounded-tr-none'
                      : 'bg-gray-800 text-gray-200 rounded-tl-none'
                  }`}>
                    <p className="mb-2">{msg.text}</p>
                    {msg.component && (
                      <div className="mt-3">
                        {msg.component}
                      </div>
                    )}
                  </div>
                  {msg.role === 'user' && (
                    <div className="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center mt-1">
                      <User className="w-4 h-4 text-gray-300" />
                    </div>
                  )}
                </motion.div>
              ))}
              {/* Typing Indicator */}
              {isTyping && (
                 <motion.div
                   initial={{ opacity: 0 }}
                   animate={{ opacity: 1 }}
                   className="flex gap-2 ml-11"
                 >
                   <span className="w-2 h-2 rounded-full bg-gray-600 animate-bounce" style={{ animationDelay: "0ms" }} />
                   <span className="w-2 h-2 rounded-full bg-gray-600 animate-bounce" style={{ animationDelay: "150ms" }} />
                   <span className="w-2 h-2 rounded-full bg-gray-600 animate-bounce" style={{ animationDelay: "300ms" }} />
                 </motion.div>
              )}
            </div>
            {/* Input Area Mockup */}
            <div className="p-4 border-t border-gray-800 bg-[#0f0f0f]">
              <div className="relative">
                <div className="h-10 w-full bg-gray-900 rounded-full border border-gray-700 px-4 flex items-center text-gray-500 text-sm">
                  请输入您的问题...
                </div>
                <div className="absolute right-1 top-1 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
                  <Send className="w-4 h-4 text-white" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  )
}

--- FILE: components\landing\anytime-control-section.tsx ---

"use client"
import { DeviceControlIOSMock } from "./device-control-ios-mock"
import { motion, useScroll, useTransform } from "framer-motion"
import { useRef } from "react"
import { Smartphone, Wifi, ShieldCheck } from "lucide-react"
export function AnytimeControlSection() {
  const containerRef = useRef<HTMLDivElement>(null)
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset: ["start end", "end start"]
  })
  const opacity = useTransform(scrollYProgress, [0, 0.3, 0.8, 1], [0, 1, 1, 0])
  const scale = useTransform(scrollYProgress, [0, 0.5], [0.8, 1])
  return (
    <section ref={containerRef} className="py-32 px-4 relative z-10 overflow-hidden bg-gradient-to-b from-transparent to-[#050a15]">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
        {/* Interactive Visual - Map/Connection */}
        <div className="order-2 lg:order-1 relative flex justify-center">
          <motion.div
            style={{ scale, opacity }}
            className="relative"
          >
             {/* Phone Frame - Titanium Style */}
             <div className="relative w-[300px] h-[600px] bg-black rounded-[3.5rem] p-[5px] shadow-[0_50px_100px_-20px_rgba(0,0,0,0.5)] border-[4px] border-[#3a3a3c] ring-1 ring-[#1a1a1c] mx-auto transform rotate-[-5deg] hover:rotate-0 transition-all duration-700 ease-out">
                {/* Inner Bezel */}
                <div className="relative w-full h-full bg-black rounded-[3.2rem] border-[6px] border-black overflow-hidden ring-1 ring-white/10">
                   {/* Screen Content */}
                   <div className="w-full h-full bg-white rounded-[2.8rem] overflow-hidden relative">
                      <DeviceControlIOSMock />
                      {/* Dynamic Island */}
                      <div className="absolute top-3 left-1/2 -translate-x-1/2 w-[90px] h-[26px] bg-black rounded-full z-50 flex items-center justify-between px-3">
                          <div className="size-2 bg-[#1a1a1a] rounded-full opacity-60"></div>
                          <div className="size-1.5 bg-[#0a0a0a] rounded-full opacity-60"></div>
                      </div>
                      {/* Screen Reflections */}
                      <div className="absolute inset-0 bg-gradient-to-tr from-white/10 via-transparent to-transparent pointer-events-none z-40 opacity-40 rounded-[2.8rem]" />
                      <div className="absolute -top-20 -right-20 w-64 h-64 bg-white/20 blur-[80px] pointer-events-none z-40 mix-blend-overlay" />
                   </div>
                </div>
                {/* Side Buttons (Refined) */}
                <div className="absolute top-28 -left-[5px] w-[3px] h-7 bg-[#2a2a2a] rounded-l-md shadow-sm border-r border-[#1a1a1a]"></div>
                <div className="absolute top-40 -left-[5px] w-[3px] h-12 bg-[#2a2a2a] rounded-l-md shadow-sm border-r border-[#1a1a1a]"></div>
                <div className="absolute top-44 -left-[5px] w-[3px] h-12 bg-[#2a2a2a] rounded-l-md shadow-sm border-r border-[#1a1a1a]"></div>
                <div className="absolute top-32 -right-[5px] w-[3px] h-20 bg-[#2a2a2a] rounded-r-md shadow-sm border-l border-[#1a1a1a]"></div>
             </div>
          </motion.div>
        </div>
        {/* Text Content */}
        <motion.div
          style={{ opacity, x: useTransform(scrollYProgress, [0, 0.5], [50, 0]) }}
          className="order-1 lg:order-2 space-y-8"
        >
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-sm">
            <Smartphone className="w-4 h-4" />
            <span>随时随地</span>
          </div>
          <h2 className="text-4xl md:text-5xl font-bold leading-tight">
            哪怕远在千里之外，<br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">
              农场尽在掌握
            </span>
          </h2>
          <p className="text-gray-400 text-lg leading-relaxed">
            不管您是在家中休息，还是外出度假，拿出手机即可查看实时监控画面。
            低延迟的视频流传输，让您仿佛身临其境。
          </p>
          <div className="grid grid-cols-2 gap-4">
             <div className="p-4 rounded-2xl bg-gray-900/50 border border-gray-800">
                <ShieldCheck className="w-8 h-8 text-blue-400 mb-2" />
                <h3 className="font-semibold text-white">安全加密</h3>
                <p className="text-sm text-gray-500">银行级数据传输加密</p>
             </div>
             <div className="p-4 rounded-2xl bg-gray-900/50 border border-gray-800">
                <Wifi className="w-8 h-8 text-green-400 mb-2" />
                <h3 className="font-semibold text-white">极速连接</h3>
                <p className="text-sm text-gray-500">全球节点加速网络</p>
             </div>
          </div>
        </motion.div>
      </div>
    </section>
  )
}

--- FILE: components\landing\chat-cards.tsx ---

"use client"
import { Video, Wifi, CalendarClock, Timer, Fan, Power, AlertTriangle, LineChart, Bug } from "lucide-react"
import { motion } from "framer-motion"
export function MonitorCardMock() {
  return (
    <div className="w-full max-w-sm bg-black/40 border border-gray-800 rounded-xl overflow-hidden backdrop-blur-sm">
      <div className="relative aspect-video bg-gray-900 group">
        <div className="absolute inset-0 flex items-center justify-center">
          <Video className="w-8 h-8 text-gray-700" />
        </div>
        <div className="absolute top-2 right-2 flex items-center gap-1.5 px-2 py-1 rounded-full bg-black/60 backdrop-blur-md">
          <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
          <span className="text-[10px] text-white/90 font-medium tracking-wide">LIVE</span>
        </div>
        <div className="absolute bottom-2 left-2 px-2 py-1 rounded-md bg-black/60 text-[10px] text-white/80">
          温室 1 号摄像头
        </div>
      </div>
      <div className="p-3 flex items-center justify-between border-t border-gray-800/50">
        <div className="flex items-center gap-2">
          <Wifi className="w-3.5 h-3.5 text-green-500" />
          <span className="text-xs text-gray-400">信号良好</span>
        </div>
        <span className="text-xs text-gray-500 font-mono">1080P • 30FPS</span>
      </div>
    </div>
  )
}
export function DeviceControlCardMock() {
  return (
    <div className="w-full max-w-sm bg-black/40 border border-gray-800 rounded-xl p-4 backdrop-blur-sm">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center shrink-0">
            <Fan className="w-5 h-5 text-green-400" />
          </div>
          <div>
            <h4 className="text-sm font-medium text-gray-200">排风扇控制</h4>
            <span className="text-xs text-green-400">运行中</span>
          </div>
        </div>
        <div className="px-2 py-1 rounded bg-green-500/20 border border-green-500/20 text-green-400 text-xs">
          ON
        </div>
      </div>
      <div className="space-y-2">
        <div className="flex justify-between text-xs text-gray-400">
          <span>风速等级</span>
          <span>3 级</span>
        </div>
        <div className="w-full bg-gray-700 rounded-full h-1.5">
          <div className="bg-green-500 h-1.5 rounded-full" style={{ width: "60%" }} />
        </div>
      </div>
    </div>
  )
}
export function TaskCardMock() {
  return (
    <div className="w-full max-w-sm bg-black/40 border border-gray-800 rounded-xl p-4 backdrop-blur-sm flex items-start gap-3">
      <div className="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center shrink-0">
        <CalendarClock className="w-5 h-5 text-blue-400" />
      </div>
      <div className="flex-1 min-w-0">
        <div className="flex items-center justify-between mb-1">
          <h4 className="text-sm font-medium text-gray-200">定时补光任务</h4>
          <span className="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-500/20">
            执行中
          </span>
        </div>
        <p className="text-xs text-gray-500 mb-2">计划执行：16:30 关闭补光灯</p>
        <div className="flex items-center gap-2 text-xs text-gray-400 bg-gray-800/50 rounded-lg p-2">
          <Timer className="w-3.5 h-3.5" />
          <span>剩余时间: 01:59:45</span>
        </div>
      </div>
    </div>
  )
}
export function DiseaseCardMock() {
  return (
    <div className="w-full max-w-sm bg-black/40 border border-gray-800 rounded-xl p-4 backdrop-blur-sm">
      <div className="flex items-center gap-3 mb-4">
        <div className="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center shrink-0">
          <Bug className="w-5 h-5 text-red-400" />
        </div>
        <div>
          <h4 className="text-sm font-medium text-gray-200">病虫害检测报告</h4>
          <span className="text-xs text-red-400">检测到高风险</span>
        </div>
      </div>
      <div className="space-y-3">
        <div className="bg-red-500/5 border border-red-500/20 rounded-lg p-3">
          <div className="flex justify-between items-center mb-1">
            <span className="text-xs font-medium text-red-300">草莓白粉病</span>
            <span className="text-xs font-bold text-red-400">92% 置信度</span>
          </div>
          <div className="w-full bg-red-500/10 rounded-full h-1.5">
            <div className="bg-red-500 h-1.5 rounded-full" style={{ width: "92%" }} />
          </div>
        </div>
        <div className="text-xs text-gray-400 leading-relaxed bg-gray-800/30 p-3 rounded-lg">
          建议立即隔离病株，并使用碳酸氢钾或硫磺熏蒸进行防治。保持通风良好，降低环境湿度。
        </div>
      </div>
    </div>
  )
}
export function DataChartCardMock() {
  return (
    <div className="w-full max-w-sm bg-black/40 border border-gray-800 rounded-xl p-4 backdrop-blur-sm">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <LineChart className="w-4 h-4 text-blue-400" />
          <h4 className="text-sm font-medium text-gray-200">近7天生长环境数据</h4>
        </div>
      </div>
      <div className="h-32 flex items-end justify-between gap-1 px-2">
        {[45, 52, 49, 62, 58, 65, 70].map((h, i) => (
          <div key={i} className="w-full bg-blue-500/10 rounded-t-sm relative group">
            <div
              className="absolute bottom-0 left-0 right-0 bg-blue-500/40 rounded-t-sm transition-all group-hover:bg-blue-500/60"
              style={{ height: `${h}%` }}
            />
            {/* Tooltip on hover would go here in real implementation */}
          </div>
        ))}
      </div>
      <div className="flex justify-between mt-3 text-[10px] text-gray-500 font-mono">
        <span>MON</span>
        <span>TUE</span>
        <span>WED</span>
        <span>THU</span>
        <span>FRI</span>
        <span>SAT</span>
        <span>SUN</span>
      </div>
    </div>
  )
}

--- FILE: components\landing\device-control-ios-mock.tsx ---

"use client"
import { useState } from "react"
import Image from "next/image"
import {
  LightBulbIcon,
  SunIcon,
  BeakerIcon,
  CloudIcon,
  FireIcon,
  HomeIcon,
  ChartBarIcon,
  UserIcon,
  Cog6ToothIcon,
  ArrowPathIcon,
  BoltIcon
} from "@heroicons/react/24/outline"
import { HomeIcon as HomeIconSolid } from "@heroicons/react/24/solid"
// --- Components ---
function RoomTabs({ selected, onSelect }: { selected: string; onSelect: (room: string) => void }) {
  const rooms = ["全部", "种植区A", "种植区B", "控制室"]
  return (
    <div className="flex items-center gap-2 overflow-x-auto px-4 py-3 no-scrollbar mask-gradient-right">
      {rooms.map((room) => {
        const isSelected = selected === room
        return (
          <button
            key={room}
            onClick={() => onSelect(room)}
            className={`whitespace-nowrap px-3 py-1.5 rounded-full text-[10px] font-medium transition-all duration-300 ${isSelected
              ? "bg-black text-white shadow-md shadow-black/10"
              : "bg-white text-gray-500 hover:bg-gray-50 border border-gray-100"
              }`}
          >
            {room}
          </button>
        )
      })}
    </div>
  )
}
function DeviceCard({
  title,
  subtitle,
  icon: Icon,
  isOn,
  onToggle,
  room,
  className = "",
  disabled = false
}: {
  title: string;
  subtitle: string;
  icon: any;
  isOn: boolean;
  onToggle?: () => void;
  room: string;
  className?: string;
  disabled?: boolean;
}) {
  return (
    <div className={`relative bg-white rounded-[1.2rem] p-3.5 shadow-[0_2px_12px_rgba(0,0,0,0.03)] border border-gray-100/50 flex flex-col justify-between h-[100px] transition-all duration-300 group hover:shadow-[0_4px_16px_rgba(0,0,0,0.06)] ${className}`}>
      <div className="flex justify-between items-start">
        <div className={`size-8 rounded-full flex items-center justify-center transition-colors duration-300 ${isOn ? 'bg-black text-white' : 'bg-gray-50 text-gray-400'}`}>
          <Icon className="size-4" />
        </div>
        <span className="text-[9px] text-gray-400 font-medium tracking-wide">{room}</span>
      </div>
      <div>
        <h3 className="text-[11px] font-semibold text-gray-900 mb-0.5 tracking-tight">{title}</h3>
        <div className="flex items-center justify-between">
          <span className={`text-[9px] font-medium transition-colors duration-300 ${isOn ? 'text-black' : 'text-gray-400'}`}>
            {subtitle}
          </span>
          {onToggle && (
            <button
              onClick={(e) => { e.stopPropagation(); if (!disabled) onToggle(); }}
              disabled={disabled}
              className={`w-8 h-4.5 rounded-full relative transition-colors duration-300 ${isOn ? 'bg-black' : 'bg-gray-200'} ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
            >
              <div className={`absolute top-0.5 size-3.5 rounded-full transition-all duration-300 shadow-sm ${isOn ? 'left-[16px] bg-white' : 'left-0.5 bg-white'}`} />
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
function SliderRow({ label, value, onChange, color, displayValue }: { label: string; value: number; onChange: (v: number) => void; color: string; displayValue?: string }) {
  return (
    <div className="space-y-1">
      <div className="flex items-center justify-between">
        <span className="text-[8px] text-gray-500 font-medium">{label}</span>
        <span className="text-[10px] font-bold text-gray-900">{displayValue || value}</span>
      </div>
      <input type="range" min={0} max={255} value={value} onChange={(e) => onChange(parseInt(e.target.value))} className="w-full h-1 rounded-full appearance-none cursor-pointer bg-gray-200 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-2.5 [&::-webkit-slider-thumb]:h-2.5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:shadow" style={{ background: `linear-gradient(to right, ${color} 0%, ${color} ${(value / 255) * 100}%, #e5e7eb ${(value / 255) * 100}%, #e5e7eb 100%)` }} />
    </div>
  )
}
export function DeviceControlIOSMock() {
  const [selectedRoom, setSelectedRoom] = useState("全部")
  // Mock State
  const [relay5, setRelay5] = useState(0)
  const [relay6, setRelay6] = useState(0)
  const [relay7, setRelay7] = useState(1)
  const [relay8, setRelay8] = useState(1)
  const [r, setR] = useState(255)
  const [g, setG] = useState(120)
  const [b, setB] = useState(100)
  const [w, setW] = useState(200)
  return (
    <div className="w-full h-full bg-[#FAFAFA] overflow-hidden font-sans relative flex flex-col">
      {/* Subtle Gradient Background */}
      <div className="absolute top-0 left-0 right-0 h-64 bg-gradient-to-b from-gray-50 to-transparent pointer-events-none" />
      <div className="relative z-10 flex-1 flex flex-col h-full">
        {/* Header */}
        <div className="px-5 pt-12 pb-4 shrink-0">
          <div className="flex justify-between items-center mb-6">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <h1 className="text-lg font-bold text-gray-900 tracking-tight">我的智能大棚</h1>
                <div className="size-2 rounded-full bg-green-500 animate-pulse" />
              </div>
              <p className="text-[10px] text-gray-400 font-medium">设备运行正常</p>
            </div>
            <div className="relative size-9 rounded-full overflow-hidden border border-gray-100 shadow-sm bg-white p-1.5">
              <Image src="/logo.svg" alt="logo" fill className="object-contain p-1" />
            </div>
          </div>
          {/* Weather Row */}
          <div className="flex justify-between items-center bg-white rounded-2xl p-3 shadow-[0_2px_12px_rgba(0,0,0,0.03)] border border-gray-100/50">
            <div className="flex flex-col items-center flex-1">
              <div className="flex items-center gap-1 text-gray-900 mb-0.5">
                <FireIcon className="size-3.5 text-orange-500" />
                <span className="text-base font-bold tracking-tight">24°C</span>
              </div>
              <span className="text-[9px] text-gray-400 font-medium">室内温度</span>
            </div>
            <div className="w-px h-6 bg-gray-100" />
            <div className="flex flex-col items-center flex-1">
              <div className="flex items-center gap-1 text-gray-900 mb-0.5">
                <BeakerIcon className="size-3.5 text-blue-500" />
                <span className="text-base font-bold tracking-tight">63%</span>
              </div>
              <span className="text-[9px] text-gray-400 font-medium">空气湿度</span>
            </div>
            <div className="w-px h-6 bg-gray-100" />
            <div className="flex flex-col items-center flex-1">
              <div className="flex items-center gap-1 text-gray-900 mb-0.5">
                <SunIcon className="size-3.5 text-yellow-500" />
                <span className="text-base font-bold tracking-tight">良好</span>
              </div>
              <span className="text-[9px] text-gray-400 font-medium">光照强度</span>
            </div>
          </div>
        </div>
        {/* Room Tabs */}
        <div className="shrink-0">
           <RoomTabs selected={selectedRoom} onSelect={setSelectedRoom} />
        </div>
        {/* Device Grid */}
        <div className="flex-1 overflow-y-auto px-5 py-2 no-scrollbar space-y-3 min-h-0">
          <div className="grid grid-cols-2 gap-3 pb-24">
            {/* Relay 5: Water Pump */}
            <DeviceCard
              title="智能水泵"
              subtitle={relay5 === 1 ? "运行中" : "已停止"}
              icon={BeakerIcon}
              isOn={relay5 === 1}
              onToggle={() => setRelay5(prev => prev === 1 ? 0 : 1)}
              room="种植区 A"
            />
            {/* Relay 6: Fan */}
            <DeviceCard
              title="排风系统"
              subtitle={relay6 === 1 ? "高速运行" : "已关闭"}
              icon={ArrowPathIcon}
              isOn={relay6 === 1}
              onToggle={() => setRelay6(prev => prev === 1 ? 0 : 1)}
              room="种植区 B"
            />
            {/* Relay 7: Grow Light */}
            <DeviceCard
              title="植物补光"
              subtitle={relay7 === 1 ? "自动模式" : "手动关闭"}
              icon={BoltIcon}
              isOn={relay7 === 1}
              onToggle={() => setRelay7(prev => prev === 1 ? 0 : 1)}
              room="全区域"
            />
            {/* Relay 8: White Light */}
            <DeviceCard
              title="照明系统"
              subtitle={relay8 === 1 ? "开启" : "关闭"}
              icon={SunIcon}
              isOn={relay8 === 1}
              onToggle={() => setRelay8(prev => prev === 1 ? 0 : 1)}
              room="控制室"
            />
            {/* RGB Control Card */}
            <div className="col-span-2 bg-white rounded-[1.5rem] p-4 shadow-[0_2px_12px_rgba(0,0,0,0.03)] border border-gray-100/50">
              <div className="flex justify-between items-center mb-3">
                <div className="flex items-center gap-2.5">
                  <div className="size-7 rounded-full bg-gray-50 flex items-center justify-center text-gray-600">
                    <LightBulbIcon className="size-3.5" />
                  </div>
                  <div>
                    <h3 className="text-[11px] font-bold text-gray-900">光谱调节 (RGB)</h3>
                    <span className="text-[9px] text-gray-400 font-medium">精准控制</span>
                  </div>
                </div>
                <div className="size-5 rounded-full border border-gray-100 shadow-sm" style={{ backgroundColor: `rgb(${r}, ${g}, ${b})` }} />
              </div>
              <div className="space-y-2.5">
                <SliderRow label="Red" value={r} onChange={setR} color="#ef4444" />
                <SliderRow label="Green" value={g} onChange={setG} color="#22c55e" />
                <SliderRow label="Blue" value={b} onChange={setB} color="#3b82f6" />
                <div className="pt-0.5">
                    <SliderRow label="Brightness" value={w} onChange={setW} color="#f59e0b" displayValue={`${Math.round((w / 255) * 100)}%`} />
                </div>
              </div>
            </div>
          </div>
        </div>
        {/* Tab Bar */}
        <div className="absolute bottom-0 left-0 right-0 h-[80px] bg-white/95 backdrop-blur-md border-t border-gray-100/50 flex justify-around items-start pt-3 pb-8 px-6 shadow-[0_-4px_20px_rgba(0,0,0,0.02)] z-20">
           <div className="flex flex-col items-center gap-1 group cursor-pointer">
              <div className="p-1.5 rounded-xl bg-gray-50 group-hover:bg-gray-100 transition-colors">
                 <HomeIconSolid className="size-4 text-gray-900" />
              </div>
              <span className="text-[9px] font-medium text-gray-900">首页</span>
           </div>
           <div className="flex flex-col items-center gap-1 group cursor-pointer">
              <div className="p-1.5 rounded-xl bg-transparent group-hover:bg-gray-50 transition-colors">
                 <ChartBarIcon className="size-4 text-gray-400 group-hover:text-gray-600" />
              </div>
              <span className="text-[9px] font-medium text-gray-400 group-hover:text-gray-600">数据</span>
           </div>
           <div className="flex flex-col items-center gap-1 group cursor-pointer">
              <div className="p-1.5 rounded-xl bg-transparent group-hover:bg-gray-50 transition-colors">
                 <UserIcon className="size-4 text-gray-400 group-hover:text-gray-600" />
              </div>
              <span className="text-[9px] font-medium text-gray-400 group-hover:text-gray-600">我的</span>
           </div>
        </div>
      </div>
    </div>
  )
}

--- FILE: components\landing\features-section.tsx ---

"use client"
import { motion } from "framer-motion"
import { Layers, Activity, Cpu, Brain, Server, ShieldCheck } from "lucide-react"
const features = [
  {
    label: "Perception",
    title: "多模态融合感知",
    description: "视觉与传感器数据交叉验证，精准识别病害",
    icon: Layers,
    className: "col-span-1 md:col-span-1 lg:col-span-1",
    hasDots: true,
    glow: "border-purple-500/50 shadow-[0_0_30px_rgba(168,85,247,0.15)]"
  },
  {
    label: "Monitoring",
    title: "全栈环境监测",
    description: "覆盖空气、土壤、光照的全维度数据采集",
    icon: Activity,
    className: "col-span-1 md:col-span-1 lg:col-span-1",
  },
  {
    label: "Automation",
    title: "智能决策引擎",
    description: "动态环境调控算法，自动管理水肥光气，实现全天候无人化精准种植",
    icon: Cpu,
    className: "col-span-1 md:col-span-2 lg:col-span-2",
  },
  {
    label: "AI Assistant",
    title: "农业大模型专家",
    description: "基于 RAG 技术的智能顾问，提供实时的病害诊断与种植指导",
    icon: Brain,
    className: "col-span-1 md:col-span-2 lg:col-span-2",
  },
  {
    label: "Edge Computing",
    title: "边缘计算节点",
    description: "本地实时推理，断网亦可稳定运行",
    icon: Server,
    className: "col-span-1 md:col-span-1 lg:col-span-1",
  },
  {
    label: "Security",
    title: "企业级安全",
    description: "数据加密传输与存储，保障资产安全",
    icon: ShieldCheck,
    className: "col-span-1 md:col-span-1 lg:col-span-1",
  },
]
const Dots = () => {
  const dots = Array.from({ length: 15 }).map((_, i) => ({
    x: Math.random() * 100,
    y: Math.random() * 100,
    size: Math.random() * 3 + 1,
    delay: Math.random() * 2,
    duration: Math.random() * 2 + 2,
  }))
  return (
    <div className="absolute inset-0 overflow-hidden pointer-events-none">
      {dots.map((dot, i) => (
        <motion.div
          key={i}
          className="absolute bg-purple-500 rounded-full opacity-40"
          style={{
            left: `${dot.x}%`,
            top: `${dot.y}%`,
            width: dot.size,
            height: dot.size,
          }}
          animate={{
            opacity: [0.2, 0.6, 0.2],
            scale: [1, 1.2, 1],
          }}
          transition={{
            duration: dot.duration,
            repeat: Infinity,
            delay: dot.delay,
            ease: "easeInOut",
          }}
        />
      ))}
    </div>
  )
}
export function FeaturesSection() {
  return (
    <section id="features" className="py-24 px-4 max-w-7xl mx-auto relative z-10">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        whileInView={{ opacity: 1, y: 0 }}
        viewport={{ once: true }}
        transition={{ duration: 0.5 }}
        className="text-center mb-16"
      >
        <h2 className="text-3xl md:text-5xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
          核心技术优势
        </h2>
        <p className="text-gray-400 max-w-2xl mx-auto text-lg">
          融合最前沿的物联网与人工智能技术，为现代农业赋能
        </p>
      </motion.div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-[240px]">
        {features.map((feature, i) => (
          <motion.div
            key={i}
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.5, delay: i * 0.1 }}
            className={`
              relative group overflow-hidden rounded-3xl p-6
              border transition-all duration-300
              flex flex-col justify-between
              ${feature.glow ? feature.glow : 'border-white/10 hover:border-white/20'}
              bg-black/20 backdrop-blur-sm
              ${feature.className}
            `}
          >
            {feature.hasDots && <Dots />}
            <div className="relative z-10">
              <div className="mb-3 text-white">
                <feature.icon size={28} />
              </div>
              <span className="text-sm font-medium text-gray-500 tracking-wide">
                {feature.label}
              </span>
            </div>
            <div className="relative z-10 mt-auto">
              <h3 className="text-2xl font-bold text-white mb-2 tracking-tight">
                {feature.title}
              </h3>
              <p className="text-gray-400 text-sm">
                {feature.description}
              </p>
            </div>
            {/* Hover Gradient Effect */}
            <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none" />
          </motion.div>
        ))}
      </div>
    </section>
  )
}

--- FILE: components\landing\footer.tsx ---

import Link from "next/link"
import { Github, Twitter, Linkedin } from "lucide-react"
export function Footer() {
  return (
    <footer className="relative z-10 border-t border-gray-800 bg-[#02040a] pt-16 pb-8">
      <div className="max-w-7xl mx-auto px-4">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-8 mb-12">
          <div className="col-span-2 md:col-span-1">
            <span className="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 mb-4 block">
              Stravision
            </span>
            <p className="text-gray-400 text-sm leading-relaxed mb-4">
              致力于通过人工智能技术推动农业数字化转型，为全球种植者提供智能、高效的解决方案。
            </p>
            <div className="flex gap-4">
              <Link href="#" className="text-gray-400 hover:text-white transition-colors">
                <Github className="w-5 h-5" />
              </Link>
              <Link href="#" className="text-gray-400 hover:text-white transition-colors">
                <Twitter className="w-5 h-5" />
              </Link>
              <Link href="#" className="text-gray-400 hover:text-white transition-colors">
                <Linkedin className="w-5 h-5" />
              </Link>
            </div>
          </div>
          <div>
            <h4 className="font-semibold text-white mb-4">产品</h4>
            <ul className="space-y-2 text-sm text-gray-400">
              <li><Link href="#" className="hover:text-white transition-colors">智能控制台</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">环境监测</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">AI 助手</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">数据分析</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold text-white mb-4">资源</h4>
            <ul className="space-y-2 text-sm text-gray-400">
              <li><Link href="#" className="hover:text-white transition-colors">文档中心</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">API 参考</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">社区论坛</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">更新日志</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold text-white mb-4">公司</h4>
            <ul className="space-y-2 text-sm text-gray-400">
              <li><Link href="#" className="hover:text-white transition-colors">关于我们</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">加入我们</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">联系方式</Link></li>
              <li><Link href="#" className="hover:text-white transition-colors">隐私政策</Link></li>
            </ul>
          </div>
        </div>
        <div className="pt-8 border-t border-gray-800 text-center text-sm text-gray-500">
          <p>© {new Date().getFullYear()} Stravision Inc. All rights reserved.</p>
        </div>
      </div>
    </footer>
  )
}

--- FILE: components\landing\hero-section.tsx ---

"use client"
import Link from "next/link"
import Image from "next/image"
import { ArrowRight } from "lucide-react"
import { Button } from "@/components/ui/button"
import { motion, useScroll, useTransform } from "framer-motion"
import { useRef } from "react"
export function HeroSection() {
  const containerRef = useRef<HTMLDivElement>(null)
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset: ["start start", "end start"]
  })
  const opacity = useTransform(scrollYProgress, [0, 0.5], [1, 0])
  const scale = useTransform(scrollYProgress, [0, 0.5], [1, 0.9])
  const y = useTransform(scrollYProgress, [0, 0.5], [0, 50])
  // Mascot Parallax
  const mascotY = useTransform(scrollYProgress, [0, 1], [0, 200])
  const mascotX = useTransform(scrollYProgress, [0, 0.5], [0, 100])
  const mascotRotate = useTransform(scrollYProgress, [0, 1], [0, 45])
  const mascotScale = useTransform(scrollYProgress, [0, 0.5], [1, 1.2])
  return (
    <section ref={containerRef} className="relative z-10 flex flex-col items-center justify-center min-h-[90vh] px-4 text-center max-w-5xl mx-auto pt-20">
      <div className="flex flex-col items-center w-full relative">
        {/* Placeholder for layout stability if needed, or just remove */}
        <div className="h-32 sm:h-40 mb-8" />
        {/* Content Group - Fades out together */}
        <motion.div style={{ opacity, scale, y }} className="flex flex-col items-center w-full">
          {/* Badge */}
          <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="mb-8"
        >
          <span className="px-4 py-1.5 rounded-full text-xs font-medium bg-blue-600/20 text-blue-400 border border-blue-500/20 backdrop-blur-sm">
            AI 驱动的智慧农业解决方案
          </span>
        </motion.div>
        {/* Headline */}
        <motion.h1
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.1 }}
          className="text-4xl sm:text-5xl md:text-7xl lg:text-8xl font-bold tracking-tight leading-[1.1] mb-8"
        >
          <span className="block text-gray-300">智慧感知.</span>
          <span className="block text-gray-200">万物互联.</span>
          <span className="block bg-clip-text text-transparent bg-gradient-to-b from-white to-gray-400">
            面向未来
          </span>
        </motion.h1>
        {/* Subheadline */}
        <motion.p
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.2 }}
          className="max-w-2xl text-base sm:text-lg md:text-xl text-gray-400 mb-12 leading-relaxed px-4"
        >
          Stravision 是您的一站式精准农业物联网平台。
          利用人工智能的力量，实时监测、分析并精准调控您的温室环境。
        </motion.p>
        {/* CTA Button */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.3 }}
          className="flex flex-col w-full sm:w-auto sm:flex-row items-center gap-4 px-4 sm:px-0"
        >
          <Link href="/dashboard" className="w-full sm:w-auto">
            <Button
              size="lg"
              className="w-full sm:w-auto group h-14 px-8 rounded-full bg-white text-black hover:bg-gray-200 transition-all text-base font-semibold"
            >
              进入控制台
              <ArrowRight className="ml-2 w-4 h-4 group-hover:translate-x-1 transition-transform" />
            </Button>
          </Link>
          <Link href="/monitor" className="w-full sm:w-auto">
            <Button
              size="lg"
              variant="outline"
              className="w-full sm:w-auto group h-14 px-8 rounded-full border-gray-700 bg-transparent text-white hover:bg-white/5 hover:border-gray-500 transition-all text-base"
            >
              实时监控
              <ArrowRight className="ml-2 w-4 h-4 group-hover:translate-x-1 transition-transform" />
            </Button>
          </Link>
        </motion.div>
      </motion.div>
      </div>
    </section>
  )
}

--- FILE: components\landing\product-showcase.tsx ---

"use client"
import { motion, useScroll, useTransform } from "framer-motion"
import { useRef } from "react"
export function ProductShowcase() {
  const containerRef = useRef<HTMLDivElement>(null)
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset: ["start end", "end start"]
  })
  const rotateX = useTransform(scrollYProgress, [0, 0.3], [15, 0])
  const scale = useTransform(scrollYProgress, [0, 0.3], [0.9, 1])
  const opacity = useTransform(scrollYProgress, [0, 0.2], [0, 1])
  const y = useTransform(scrollYProgress, [0, 0.3], [100, 0])
  return (
    <section ref={containerRef} id="products" className="py-32 px-4 relative overflow-hidden min-h-[150vh]">
      {/* Background Glow */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-blue-500/10 rounded-full blur-[120px] pointer-events-none" />
      <div className="max-w-7xl mx-auto relative z-10 sticky top-20" style={{ perspective: "1000px" }}>
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
          transition={{ duration: 0.5 }}
          className="text-center mb-20"
        >
          <h2 className="text-3xl md:text-5xl font-bold mb-6 text-white">
            全方位的管理平台
          </h2>
          <p className="text-gray-400 max-w-2xl mx-auto text-lg">
            无论是在桌面端还是移动端，都能轻松掌控您的农业基地
          </p>
        </motion.div>
        <div className="relative">
          {/* Browser Mockup */}
          <motion.div
            style={{ rotateX, scale, opacity, y }}
            className="relative mx-auto max-w-5xl rounded-xl border border-gray-800 bg-[#0A0A0A] shadow-2xl overflow-hidden z-10"
          >
            {/* Browser Header */}
            <div className="flex items-center gap-2 px-4 py-3 border-b border-gray-800 bg-[#0f0f0f]">
              <div className="flex gap-1.5">
                <div className="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50" />
                <div className="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50" />
                <div className="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50" />
              </div>
              <div className="flex-1 text-center">
                <div className="inline-block px-3 py-1 rounded-md bg-gray-800/50 text-xs text-gray-500 font-mono">
                  dashboard.stravision.com
                </div>
              </div>
            </div>
            {/* Content Mockup - Simplified Dashboard View */}
            <div className="p-8 grid grid-cols-1 md:grid-cols-3 gap-6 bg-[#02040a]">
              {/* Sidebar Mockup */}
              <div className="hidden md:block col-span-1 space-y-4">
                <div className="h-8 w-32 bg-gray-800/50 rounded-lg animate-pulse" />
                <div className="space-y-2 pt-4">
                  {[1, 2, 3, 4, 5].map((i) => (
                    <div key={i} className="h-10 w-full bg-gray-800/20 rounded-lg" />
                  ))}
                </div>
              </div>
              {/* Main Content Mockup */}
              <div className="col-span-2 space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div className="h-32 rounded-xl bg-gradient-to-br from-blue-500/10 to-transparent border border-blue-500/20 p-4">
                      <div className="h-6 w-6 rounded-full bg-blue-500/20 mb-2" />
                      <div className="h-4 w-20 bg-gray-700/50 rounded mb-2" />
                      <div className="h-8 w-16 bg-blue-500/20 rounded" />
                  </div>
                  <div className="h-32 rounded-xl bg-gradient-to-br from-purple-500/10 to-transparent border border-purple-500/20 p-4">
                      <div className="h-6 w-6 rounded-full bg-purple-500/20 mb-2" />
                      <div className="h-4 w-20 bg-gray-700/50 rounded mb-2" />
                      <div className="h-8 w-16 bg-purple-500/20 rounded" />
                  </div>
                </div>
                <div className="h-64 rounded-xl bg-gray-800/10 border border-gray-800 p-4">
                  <div className="flex items-end gap-2 h-full pb-4 px-4">
                      {[40, 60, 45, 70, 50, 80, 65, 85, 75, 90, 60, 50].map((h, i) => (
                          <div key={i} className="flex-1 bg-blue-500/20 rounded-t-sm hover:bg-blue-500/40 transition-colors" style={{ height: `${h}%` }} />
                      ))}
                  </div>
                </div>
              </div>
            </div>
            {/* Overlay Gradient */}
            <div className="absolute inset-0 bg-gradient-to-t from-[#02040a] via-transparent to-transparent pointer-events-none" />
          </motion.div>
          {/* Mobile Phone Mockup */}
          <motion.div
            style={{ y: useTransform(scrollYProgress, [0, 0.5], [200, -50]), x: "50%", opacity }}
            className="absolute -bottom-20 right-20 w-[280px] h-[580px] rounded-[3rem] border-8 border-gray-800 bg-[#02040a] shadow-2xl z-20 overflow-hidden hidden md:block"
          >
             {/* Notch */}
             <div className="absolute top-0 left-1/2 -translate-x-1/2 h-6 w-32 bg-gray-800 rounded-b-2xl z-20" />
             {/* Mobile Content */}
             <div className="p-4 pt-12 h-full flex flex-col gap-4">
                <div className="h-20 rounded-2xl bg-blue-500/10 border border-blue-500/20 p-3">
                   <div className="h-4 w-12 bg-blue-500/20 rounded mb-2" />
                   <div className="h-8 w-24 bg-gray-700/50 rounded" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                   <div className="aspect-square rounded-2xl bg-gray-800/30 p-3">
                      <div className="h-8 w-8 rounded-full bg-purple-500/20 mb-2" />
                   </div>
                   <div className="aspect-square rounded-2xl bg-gray-800/30 p-3">
                      <div className="h-8 w-8 rounded-full bg-green-500/20 mb-2" />
                   </div>
                </div>
                <div className="flex-1 rounded-2xl bg-gray-800/10 border border-gray-800 p-3">
                   <div className="space-y-2">
                      {[1, 2, 3, 4].map(i => (
                        <div key={i} className="h-12 w-full bg-gray-800/30 rounded-xl" />
                      ))}
                   </div>
                </div>
             </div>
          </motion.div>
        </div>
      </div>
    </section>
  )
}

--- FILE: components\landing\smart-control-section.tsx ---

"use client"
import { motion, useScroll, useTransform } from "framer-motion"
import { useRef } from "react"
import { Cpu, Wind, Droplets, Sun, CheckCircle2 } from "lucide-react"
export function SmartControlSection() {
  const containerRef = useRef<HTMLDivElement>(null)
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset: ["start end", "end start"]
  })
  const y = useTransform(scrollYProgress, [0, 1], [100, -100])
  const opacity = useTransform(scrollYProgress, [0, 0.3, 0.8, 1], [0, 1, 1, 0])
  return (
    <section ref={containerRef} className="py-32 px-4 relative z-10 overflow-hidden">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
        {/* Text Content */}
        <motion.div
          style={{ opacity, x: useTransform(scrollYProgress, [0, 0.5], [-50, 0]) }}
          className="space-y-8"
        >
          <h2 className="text-4xl md:text-5xl font-bold leading-tight">
            把农场交给 AI，<br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400">
              让种植更省心
            </span>
          </h2>
          <p className="text-gray-400 text-lg leading-relaxed">
            Stravision 的智能大脑会根据环境数据自动调节设备。
            无论是开启风机降温，还是自动补光，一切都在毫秒间完成。
            您只需设定目标，剩下的交给我们。
          </p>
          <div className="space-y-4">
            {[
              "自适应环境调控算法",
              "异常情况实时预警",
              "多设备协同工作策略",
              "节能优化运行模式"
            ].map((item, i) => (
              <div key={i} className="flex items-center gap-3">
                <CheckCircle2 className="w-5 h-5 text-green-500" />
                <span className="text-gray-300">{item}</span>
              </div>
            ))}
          </div>
        </motion.div>
        {/* Interactive Visual */}
        <div className="relative">
          <motion.div
            style={{ y }}
            className="relative bg-gradient-to-br from-gray-900 to-black border border-gray-800 rounded-3xl p-8 shadow-2xl"
          >
            {/* Simulation Header */}
            <div className="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
              <span className="text-sm text-gray-400 font-mono">AI_CORE_STATUS</span>
              <span className="flex items-center gap-2 text-xs text-green-400">
                <span className="relative flex h-2 w-2">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                RUNNING
              </span>
            </div>
            {/* Metrics Simulation */}
            <div className="space-y-6">
              {[
                { label: "温度 (Temperature)", icon: Wind, color: "text-blue-400", bg: "bg-blue-500" },
                { label: "湿度 (Humidity)", icon: Droplets, color: "text-cyan-400", bg: "bg-cyan-500" },
                { label: "光照 (Light)", icon: Sun, color: "text-yellow-400", bg: "bg-yellow-500" },
              ].map((metric, i) => (
                <div key={i} className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span className="flex items-center gap-2 text-gray-300">
                      <metric.icon className={`w-4 h-4 ${metric.color}`} />
                      {metric.label}
                    </span>
                    <span className="text-gray-500 font-mono">OPTIMIZING...</span>
                  </div>
                  <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
                    <motion.div
                      className={`h-full ${metric.bg}`}
                      initial={{ width: "30%" }}
                      whileInView={{ width: ["30%", "85%", "60%"] }}
                      transition={{
                        duration: 2,
                        repeat: Infinity,
                        repeatType: "reverse",
                        delay: i * 0.5
                      }}
                    />
                  </div>
                </div>
              ))}
            </div>
            {/* Central Processing Node Visual */}
            <div className="mt-8 flex justify-center">
              <div className="relative">
                 <div className="absolute inset-0 bg-purple-500/30 blur-xl rounded-full" />
                 <Cpu className="w-16 h-16 text-purple-400 relative z-10 animate-pulse" />
              </div>
            </div>
          </motion.div>
          {/* Decorative Elements */}
          <div className="absolute -top-10 -right-10 w-40 h-40 bg-purple-500/10 rounded-full blur-3xl" />
          <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl" />
        </div>
      </div>
    </section>
  )
}

--- FILE: components\landing\tech-stack-section.tsx ---

"use client"
import LogoLoop from "@/components/LogoLoop"
import { motion } from "framer-motion"
const techLogos = [
  {
    title: "Next.js",
    src: "https://cdn.simpleicons.org/nextdotjs/white"
  },
  {
    title: "React",
    src: "https://cdn.simpleicons.org/react/white"
  },
  {
    title: "TypeScript",
    src: "https://cdn.simpleicons.org/typescript/white"
  },
  {
    title: "Tailwind CSS",
    src: "https://cdn.simpleicons.org/tailwindcss/white"
  },
  {
    title: "Framer Motion",
    src: "https://cdn.simpleicons.org/framer/white"
  },
  {
    title: "Vercel",
    src: "https://cdn.simpleicons.org/vercel/white"
  },
  {
    title: "OpenAI",
    src: "https://cdn.simpleicons.org/openai/white"
  },
  {
    title: "Docker",
    src: "https://cdn.simpleicons.org/docker/white"
  },
  {
    title: "Qwen",
    src: "/qwen.png"
  }
]
export function TechStackSection() {
  return (
    <section className="py-12">
      <div className="max-w-7xl mx-auto px-4 mb-8 text-center">
        <p className="text-sm font-medium text-gray-500 uppercase tracking-wider">
          Powered by Modern Technology Stack
        </p>
      </div>
      <div className="relative w-full overflow-hidden mask-gradient-x">
        {/* @ts-ignore */}
        <LogoLoop
          logos={techLogos}
          speed={50}
          gap={60}
          logoHeight={40}
          pauseOnHover={true}
          direction="left"
          className="opacity-70 hover:opacity-100 transition-all duration-500"
        />
      </div>
    </section>
  )
}

--- FILE: components\live-stream-player.tsx ---

"use client"
import { useEffect, useRef, useId, useMemo } from "react"
type TXLivePlayer = {
  setRenderView: (id: string) => void
  startPlay: (url: string) => Promise<void> | void
  stopPlay: () => void
  setObserver?: (obs: { onPlayerEvent?: (event: string, info?: unknown) => void; onStatistics?: (stats: unknown) => void }) => void
  videoView?: HTMLVideoElement
}
type HlsInstance = { loadSource: (src: string) => void; attachMedia: (el: HTMLVideoElement) => void; destroy: () => void }
type HlsConstructor = new () => HlsInstance
type FlvPlayerInstance = { attachMediaElement: (el: HTMLVideoElement) => void; load: () => void; play: () => void; destroy: () => void; unload: () => void }
type FlvJS = { createPlayer: (opts: { type: string; url: string }) => FlvPlayerInstance }
declare global {
  interface Window {
    TXLivePlayer?: new () => TXLivePlayer
    Hls?: HlsConstructor
    flvjs?: FlvJS
  }
}
function loadScriptOnce(id: string, src: string) {
  return new Promise<void>((resolve) => {
    if (document.getElementById(id)) return resolve()
    const s = document.createElement("script")
    s.id = id
    s.src = src
    s.onload = () => resolve()
    s.onerror = () => {
      try {
        const el = document.getElementById(id)
        if (el) el.remove()
      } catch {}
      resolve()
    }
    document.body.appendChild(s)
  })
}
async function loadScriptWithFallback(id: string, urls: string[]) {
  if (document.getElementById(id)) return
  for (let i = 0; i < urls.length; i++) {
    const src = urls[i]
    try {
      await new Promise<void>((resolve, reject) => {
        const s = document.createElement("script")
        s.id = id
        s.src = src
        s.onload = () => resolve()
        s.onerror = () => {
          try { const el = document.getElementById(id); if (el) el.remove() } catch {}
          reject(new Error("load failed"))
        }
        document.body.appendChild(s)
      })
      return
    } catch {}
  }
}
export function LiveStreamPlayer({
  sources,
  autoplay = true,
  muted = true,
  controls = true,
  className,
  id,
  poster,
  licenseUrl
}:{
  sources: Array<string | { src: string }>
  autoplay?: boolean
  muted?: boolean
  controls?: boolean
  className?: string
  id?: string
  poster?: string
  licenseUrl?: string
}) {
  const autoId = useId()
  const containerId = useMemo(() => id ?? `tc-player-${autoId}`, [id, autoId])
  const connectTimerRef = useRef<number | null>(null)
  const watchdogTimerRef = useRef<NodeJS.Timeout | null>(null)
  const webrtcRef = useRef<TXLivePlayer | null>(null)
  const hlsRef = useRef<HlsInstance | null>(null)
  const flvRef = useRef<FlvPlayerInstance | null>(null)
  useEffect(() => {
    void licenseUrl
    const run = async () => {
      await loadScriptOnce("hls-js-1", "https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js")
      await loadScriptOnce("flv-js-1", "https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js")
      await loadScriptWithFallback("txliveplayer-js-1-3-2", [
        "https://video.sdk.qcloud.com/web/TXLivePlayer-1.3.2.min.js",
        "https://web.sdk.qcloud.com/player/TXLivePlayer-1.3.2.min.js"
      ])
      const normalized = sources.map((s) => {
        const obj = typeof s === "string" ? { src: s } : s
        const url = obj.src
        const isWebRTC = typeof url === "string" && url.startsWith("webrtc://")
        const isM3U8 = typeof url === "string" && url.toLowerCase().endsWith(".m3u8")
        const isFLV = typeof url === "string" && url.toLowerCase().endsWith(".flv")
        return isWebRTC ? { ...obj, type: "webrtc" } : isM3U8 ? { ...obj, type: "hls" } : isFLV ? { ...obj, type: "flv" } : obj
      })
      const sequence = normalized.map((o) => (o as { src: string }).src)
      let nextIndex = 0
      let retryCount = 0
      const maxRetry = 3
      const videoEl = document.getElementById(containerId) as HTMLVideoElement | null
      if (!videoEl) return
      if (muted) videoEl.muted = true
      videoEl.setAttribute("playsinline", "true")
      videoEl.setAttribute("webkit-playsinline", "true")
      videoEl.setAttribute("x5-playsinline", "true")
      videoEl.setAttribute("x5-video-player-type", "h5")
      const playCurrent = async () => {
        const currentUrl = sequence[nextIndex]
        const type = (normalized[nextIndex] as unknown as { type?: string }).type
        try {
          if (type === "webrtc" && window.TXLivePlayer) {
            webrtcRef.current?.stopPlay()
            hlsRef.current?.destroy(); hlsRef.current = null
            flvRef.current?.destroy(); flvRef.current = null
            webrtcRef.current = new window.TXLivePlayer()
            webrtcRef.current.setRenderView(containerId)
            try { videoEl.play().catch(() => {}) } catch {}
            webrtcRef.current.startPlay(currentUrl)
            webrtcRef.current.setObserver?.({
              onPlayerEvent: (event) => {
                const s = String(event).toLowerCase()
                if (s.includes("disconnect") || s.includes("close") || s.includes("failed")) {
                  const hasNext = nextIndex + 1 < sequence.length
                  nextIndex = hasNext ? nextIndex + 1 : 0
                  setTimeout(() => { void playCurrent() }, 500)
                }
              }
            })
          } else if (type === "hls" && window.Hls) {
            webrtcRef.current?.stopPlay(); webrtcRef.current = null
            flvRef.current?.destroy(); flvRef.current = null
            hlsRef.current?.destroy()
            hlsRef.current = new window.Hls()
            hlsRef.current.loadSource(currentUrl)
            hlsRef.current.attachMedia(videoEl)
            try { videoEl.play().catch(() => {}) } catch {}
          } else if (type === "flv" && window.flvjs) {
            webrtcRef.current?.stopPlay(); webrtcRef.current = null
            hlsRef.current?.destroy(); hlsRef.current = null
            flvRef.current?.destroy()
            flvRef.current = window.flvjs.createPlayer({ type: "flv", url: currentUrl })
            flvRef.current.attachMediaElement(videoEl)
            flvRef.current.load()
            try { videoEl.play().catch(() => {}) } catch {}
          } else {
            const hasNext = nextIndex + 1 < sequence.length
            nextIndex = hasNext ? nextIndex + 1 : 0
            await playCurrent()
          }
        } catch {
          const hasNext = nextIndex + 1 < sequence.length
          nextIndex = hasNext ? nextIndex + 1 : 0
          if (retryCount < maxRetry) {
            retryCount += 1
            setTimeout(() => { void playCurrent() }, 800)
          }
        }
      }
      // Watchdog for Live Stream
      let lastTime = 0
      let freezeCount = 0
      if (watchdogTimerRef.current) clearInterval(watchdogTimerRef.current)
      watchdogTimerRef.current = setInterval(() => {
        if (videoEl && !videoEl.paused && !videoEl.ended && videoEl.readyState > 2) {
           const currentTime = videoEl.currentTime
           if (currentTime === lastTime) {
             freezeCount++
             // Faster refresh: check every 0.5s, reconnect after 1.5s (3 checks)
             if (freezeCount > 3) {
                console.log("[LivePlayer] Stream frozen detected, reconnecting...")
                freezeCount = 0
                const hasNext = nextIndex + 1 < sequence.length
                nextIndex = hasNext ? nextIndex + 1 : 0
                void playCurrent()
             }
           } else {
             freezeCount = 0
             lastTime = currentTime
           }
        }
      }, 500) // Check every 500ms instead of 1000ms
      if (connectTimerRef.current) { window.clearTimeout(connectTimerRef.current) }
      connectTimerRef.current = window.setTimeout(() => { void playCurrent() }, 0)
      videoEl.addEventListener("stalled", () => { const hasNext = nextIndex + 1 < sequence.length; nextIndex = hasNext ? nextIndex + 1 : 0; void playCurrent() })
      videoEl.addEventListener("error", () => { const hasNext = nextIndex + 1 < sequence.length; nextIndex = hasNext ? nextIndex + 1 : 0; void playCurrent() })
      window.addEventListener("visibilitychange", () => { if (document.visibilityState === "visible") { try { videoEl.play().catch(() => {}) } catch {} } })
      window.addEventListener("online", () => { setTimeout(() => { void playCurrent() }, 500) })
    }
    run()
    return () => {
      if (connectTimerRef.current) { window.clearTimeout(connectTimerRef.current); connectTimerRef.current = null }
      if (watchdogTimerRef.current) { clearInterval(watchdogTimerRef.current); watchdogTimerRef.current = null }
      try { webrtcRef.current?.stopPlay() } catch {}
      webrtcRef.current = null
      hlsRef.current?.destroy(); hlsRef.current = null
      try { flvRef.current?.unload?.() } catch {}
      flvRef.current?.destroy(); flvRef.current = null
    }
  }, [controls, autoplay, muted, poster, sources, containerId, licenseUrl])
  return <video id={containerId} preload="auto" playsInline autoPlay={autoplay} muted={muted} controls={controls} className={className ?? ""} poster={poster} />
}

--- FILE: components\LogoLoop.css ---

.logoloop {
  position: relative;
  --logoloop-gap: 32px;
  --logoloop-logoHeight: 28px;
  --logoloop-fadeColorAuto: #ffffff;
}
.logoloop--vertical {
  height: 100%;
  display: inline-block;
}
.logoloop--scale-hover {
  padding-top: calc(var(--logoloop-logoHeight) * 0.1);
  padding-bottom: calc(var(--logoloop-logoHeight) * 0.1);
}
@media (prefers-color-scheme: dark) {
  .logoloop {
    --logoloop-fadeColorAuto: #0b0b0b;
  }
}
.logoloop__track {
  display: flex;
  width: max-content;
  will-change: transform;
  user-select: none;
  position: relative;
  z-index: 0;
}
.logoloop--vertical .logoloop__track {
  flex-direction: column;
  height: max-content;
  width: 100%;
}
.logoloop__list {
  display: flex;
  align-items: center;
}
.logoloop--vertical .logoloop__list {
  flex-direction: column;
}
.logoloop__item {
  flex: 0 0 auto;
  margin-right: var(--logoloop-gap);
  font-size: var(--logoloop-logoHeight);
  line-height: 1;
}
.logoloop--vertical .logoloop__item {
  margin-right: 0;
  margin-bottom: var(--logoloop-gap);
}
.logoloop__item:last-child {
  margin-right: var(--logoloop-gap);
}
.logoloop--vertical .logoloop__item:last-child {
  margin-right: 0;
  margin-bottom: var(--logoloop-gap);
}
.logoloop__node {
  display: inline-flex;
  align-items: center;
}
.logoloop__item img {
  height: var(--logoloop-logoHeight);
  width: auto;
  display: block;
  object-fit: contain;
  image-rendering: -webkit-optimize-contrast;
  -webkit-user-drag: none;
  pointer-events: none;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.logoloop--scale-hover .logoloop__item {
  overflow: visible;
}
.logoloop--scale-hover .logoloop__item:hover img,
.logoloop--scale-hover .logoloop__item:hover .logoloop__node {
  transform: scale(1.2);
  transform-origin: center center;
}
.logoloop--scale-hover .logoloop__node {
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.logoloop__link {
  display: inline-flex;
  align-items: center;
  text-decoration: none;
  border-radius: 4px;
  transition: opacity 0.2s ease;
}
.logoloop__link:hover {
  opacity: 0.8;
}
.logoloop__link:focus-visible {
  outline: 2px solid currentColor;
  outline-offset: 2px;
}
.logoloop--fade::before,
.logoloop--fade::after {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  width: clamp(24px, 8%, 120px);
  pointer-events: none;
  z-index: 10;
}
.logoloop--fade::before {
  left: 0;
  background: linear-gradient(
    to right,
    var(--logoloop-fadeColor, var(--logoloop-fadeColorAuto)) 0%,
    rgba(0, 0, 0, 0) 100%
  );
}
.logoloop--fade::after {
  right: 0;
  background: linear-gradient(
    to left,
    var(--logoloop-fadeColor, var(--logoloop-fadeColorAuto)) 0%,
    rgba(0, 0, 0, 0) 100%
  );
}
.logoloop--vertical.logoloop--fade::before,
.logoloop--vertical.logoloop--fade::after {
  left: 0;
  right: 0;
  width: 100%;
  height: clamp(24px, 8%, 120px);
}
.logoloop--vertical.logoloop--fade::before {
  top: 0;
  bottom: auto;
  background: linear-gradient(
    to bottom,
    var(--logoloop-fadeColor, var(--logoloop-fadeColorAuto)) 0%,
    rgba(0, 0, 0, 0) 100%
  );
}
.logoloop--vertical.logoloop--fade::after {
  bottom: 0;
  top: auto;
  background: linear-gradient(
    to top,
    var(--logoloop-fadeColor, var(--logoloop-fadeColorAuto)) 0%,
    rgba(0, 0, 0, 0) 100%
  );
}
@media (prefers-reduced-motion: reduce) {
  .logoloop__track {
    transform: translate3d(0, 0, 0) !important;
  }
  .logoloop__item img,
  .logoloop__node {
    transition: none !important;
  }
}

--- FILE: components\LogoLoop.tsx ---

import { useCallback, useEffect, useMemo, useRef, useState, memo, ReactNode } from 'react';
import './LogoLoop.css';
const ANIMATION_CONFIG = { SMOOTH_TAU: 0.25, MIN_COPIES: 2, COPY_HEADROOM: 2 };
const toCssLength = (value: number | string | undefined) => (typeof value === 'number' ? `${value}px` : (value ?? undefined));
const useResizeObserver = (callback: () => void, elements: React.RefObject<HTMLElement>[], dependencies: any[]) => {
  useEffect(() => {
    if (!window.ResizeObserver) {
      const handleResize = () => callback();
      window.addEventListener('resize', handleResize);
      callback();
      return () => window.removeEventListener('resize', handleResize);
    }
    const observers = elements.map(ref => {
      if (!ref.current) return null;
      const observer = new ResizeObserver(callback);
      observer.observe(ref.current);
      return observer;
    });
    callback();
    return () => {
      observers.forEach(observer => observer?.disconnect());
    };
  }, [callback, elements, dependencies]);
};
const useImageLoader = (seqRef: React.RefObject<HTMLElement>, onLoad: () => void, dependencies: any[]) => {
  useEffect(() => {
    const images = seqRef.current?.querySelectorAll('img') ?? [];
    if (images.length === 0) {
      onLoad();
      return;
    }
    let remainingImages = images.length;
    const handleImageLoad = () => {
      remainingImages -= 1;
      if (remainingImages === 0) onLoad();
    };
    images.forEach(img => {
      const htmlImg = img as HTMLImageElement;
      if (htmlImg.complete) {
        handleImageLoad();
      } else {
        htmlImg.addEventListener('load', handleImageLoad, { once: true });
        htmlImg.addEventListener('error', handleImageLoad, { once: true });
      }
    });
    return () => {
      images.forEach(img => {
        img.removeEventListener('load', handleImageLoad);
        img.removeEventListener('error', handleImageLoad);
      });
    };
  }, [onLoad, seqRef, dependencies]);
};
const useAnimationLoop = (trackRef: React.RefObject<HTMLElement>, targetVelocity: number, seqWidth: number, seqHeight: number, isHovered: boolean, hoverSpeed: number | undefined, isVertical: boolean) => {
  const rafRef = useRef<number | null>(null);
  const lastTimestampRef = useRef<number | null>(null);
  const offsetRef = useRef(0);
  const velocityRef = useRef(0);
  useEffect(() => {
    const track = trackRef.current;
    if (!track) return;
    const seqSize = isVertical ? seqHeight : seqWidth;
    if (seqSize > 0) {
      offsetRef.current = ((offsetRef.current % seqSize) + seqSize) % seqSize;
      const transformValue = isVertical
        ? `translate3d(0, ${-offsetRef.current}px, 0)`
        : `translate3d(${-offsetRef.current}px, 0, 0)`;
      track.style.transform = transformValue;
    }
    const animate = (timestamp: number) => {
      if (lastTimestampRef.current === null) {
        lastTimestampRef.current = timestamp;
      }
      const deltaTime = Math.max(0, timestamp - lastTimestampRef.current) / 1000;
      lastTimestampRef.current = timestamp;
      const target = isHovered && hoverSpeed !== undefined ? hoverSpeed : targetVelocity;
      const easingFactor = 1 - Math.exp(-deltaTime / ANIMATION_CONFIG.SMOOTH_TAU);
      velocityRef.current += (target - velocityRef.current) * easingFactor;
      if (seqSize > 0) {
        let nextOffset = offsetRef.current + velocityRef.current * deltaTime;
        nextOffset = ((nextOffset % seqSize) + seqSize) % seqSize;
        offsetRef.current = nextOffset;
        const transformValue = isVertical
          ? `translate3d(0, ${-offsetRef.current}px, 0)`
          : `translate3d(${-offsetRef.current}px, 0, 0)`;
        track.style.transform = transformValue;
      }
      rafRef.current = requestAnimationFrame(animate);
    };
    rafRef.current = requestAnimationFrame(animate);
    return () => {
      if (rafRef.current !== null) {
        cancelAnimationFrame(rafRef.current);
        rafRef.current = null;
      }
      lastTimestampRef.current = null;
    };
  }, [targetVelocity, seqWidth, seqHeight, isHovered, hoverSpeed, isVertical, trackRef]);
};
interface LogoItem {
  title?: string;
  src?: string;
  srcSet?: string;
  sizes?: string;
  width?: number | string;
  height?: number | string;
  alt?: string;
  href?: string;
  ariaLabel?: string;
  node?: ReactNode;
  [key: string]: any;
}
interface LogoLoopProps {
  logos: LogoItem[];
  speed?: number;
  direction?: 'left' | 'right' | 'up' | 'down';
  width?: number | string;
  logoHeight?: number | string;
  gap?: number;
  pauseOnHover?: boolean;
  hoverSpeed?: number;
  fadeOut?: boolean;
  fadeOutColor?: string;
  scaleOnHover?: boolean;
  renderItem?: (item: LogoItem, key: string) => ReactNode;
  ariaLabel?: string;
  className?: string;
  style?: React.CSSProperties;
}
export const LogoLoop = memo(
  ({
    logos,
    speed = 120,
    direction = 'left',
    width = '100%',
    logoHeight = 28,
    gap = 32,
    pauseOnHover,
    hoverSpeed,
    fadeOut = false,
    fadeOutColor,
    scaleOnHover = false,
    renderItem,
    ariaLabel = 'Partner logos',
    className,
    style
  }: LogoLoopProps) => {
    const containerRef = useRef<HTMLDivElement>(null);
    const trackRef = useRef<HTMLDivElement>(null);
    const seqRef = useRef<HTMLUListElement>(null);
    const [seqWidth, setSeqWidth] = useState(0);
    const [seqHeight, setSeqHeight] = useState(0);
    const [copyCount, setCopyCount] = useState(ANIMATION_CONFIG.MIN_COPIES);
    const [isHovered, setIsHovered] = useState(false);
    const effectiveHoverSpeed = useMemo(() => {
      if (hoverSpeed !== undefined) return hoverSpeed;
      if (pauseOnHover === true) return 0;
      if (pauseOnHover === false) return undefined;
      return 0;
    }, [hoverSpeed, pauseOnHover]);
    const isVertical = direction === 'up' || direction === 'down';
    const targetVelocity = useMemo(() => {
      const magnitude = Math.abs(speed);
      let directionMultiplier;
      if (isVertical) {
        directionMultiplier = direction === 'up' ? 1 : -1;
      } else {
        directionMultiplier = direction === 'left' ? 1 : -1;
      }
      const speedMultiplier = speed < 0 ? -1 : 1;
      return magnitude * directionMultiplier * speedMultiplier;
    }, [speed, direction, isVertical]);
    const updateDimensions = useCallback(() => {
      const containerWidth = containerRef.current?.clientWidth ?? 0;
      const sequenceRect = seqRef.current?.getBoundingClientRect?.();
      const sequenceWidth = sequenceRect?.width ?? 0;
      const sequenceHeight = sequenceRect?.height ?? 0;
      if (isVertical) {
        const parentHeight = containerRef.current?.parentElement?.clientHeight ?? 0;
        if (containerRef.current && parentHeight > 0) {
          const targetHeight = Math.ceil(parentHeight);
          if (containerRef.current.style.height !== `${targetHeight}px`)
            containerRef.current.style.height = `${targetHeight}px`;
        }
        if (sequenceHeight > 0) {
          setSeqHeight(Math.ceil(sequenceHeight));
          const viewport = containerRef.current?.clientHeight ?? parentHeight ?? sequenceHeight;
          const copiesNeeded = Math.ceil(viewport / sequenceHeight) + ANIMATION_CONFIG.COPY_HEADROOM;
          setCopyCount(Math.max(ANIMATION_CONFIG.MIN_COPIES, copiesNeeded));
        }
      } else if (sequenceWidth > 0) {
        setSeqWidth(Math.ceil(sequenceWidth));
        const copiesNeeded = Math.ceil(containerWidth / sequenceWidth) + ANIMATION_CONFIG.COPY_HEADROOM;
        setCopyCount(Math.max(ANIMATION_CONFIG.MIN_COPIES, copiesNeeded));
      }
    }, [isVertical]);
    useResizeObserver(updateDimensions, [containerRef as unknown as React.RefObject<HTMLElement>, seqRef as unknown as React.RefObject<HTMLElement>], [logos, gap, logoHeight, isVertical]);
    useImageLoader(seqRef as unknown as React.RefObject<HTMLElement>, updateDimensions, [logos, gap, logoHeight, isVertical]);
    useAnimationLoop(trackRef as unknown as React.RefObject<HTMLElement>, targetVelocity, seqWidth, seqHeight, isHovered, effectiveHoverSpeed, isVertical);
    const cssVariables = useMemo(
      () => ({
        '--logoloop-gap': `${gap}px`,
        '--logoloop-logoHeight': `${logoHeight}px`,
        ...(fadeOutColor && { '--logoloop-fadeColor': fadeOutColor })
      } as React.CSSProperties),
      [gap, logoHeight, fadeOutColor]
    );
    const rootClassName = useMemo(
      () =>
        [
          'logoloop',
          isVertical ? 'logoloop--vertical' : 'logoloop--horizontal',
          fadeOut && 'logoloop--fade',
          scaleOnHover && 'logoloop--scale-hover',
          className
        ]
          .filter(Boolean)
          .join(' '),
      [isVertical, fadeOut, scaleOnHover, className]
    );
    const handleMouseEnter = useCallback(() => {
      if (effectiveHoverSpeed !== undefined) setIsHovered(true);
    }, [effectiveHoverSpeed]);
    const handleMouseLeave = useCallback(() => {
      if (effectiveHoverSpeed !== undefined) setIsHovered(false);
    }, [effectiveHoverSpeed]);
    const renderLogoItem = useCallback(
      (item: LogoItem, key: string) => {
        if (renderItem) {
          return (
            <li className="logoloop__item" key={key} role="listitem">
              {renderItem(item, key)}
            </li>
          );
        }
        const isNodeItem = 'node' in item;
        const content = isNodeItem ? (
          <span className="logoloop__node" aria-hidden={!!item.href && !item.ariaLabel}>
            {item.node}
          </span>
        ) : (
          <img
            src={item.src}
            srcSet={item.srcSet}
            sizes={item.sizes}
            width={item.width}
            height={item.height}
            alt={item.alt ?? ''}
            title={item.title}
            loading="lazy"
            decoding="async"
            draggable={false}
          />
        );
        const itemAriaLabel = isNodeItem ? (item.ariaLabel ?? item.title) : (item.alt ?? item.title);
        const itemContent = item.href ? (
          <a
            className="logoloop__link"
            href={item.href}
            aria-label={itemAriaLabel || 'logo link'}
            target="_blank"
            rel="noreferrer noopener"
          >
            {content}
          </a>
        ) : (
          content
        );
        return (
          <li className="logoloop__item" key={key} role="listitem">
            {itemContent}
          </li>
        );
      },
      [renderItem]
    );
    const logoLists = useMemo(
      () =>
        Array.from({ length: copyCount }, (_, copyIndex) => (
          <ul
            className="logoloop__list"
            key={`copy-${copyIndex}`}
            role="list"
            aria-hidden={copyIndex > 0}
            ref={copyIndex === 0 ? seqRef : undefined}
          >
            {logos.map((item, itemIndex) => renderLogoItem(item, `${copyIndex}-${itemIndex}`))}
          </ul>
        )),
      [copyCount, logos, renderLogoItem]
    );
    const containerStyle = useMemo(
      () => ({
        width: isVertical
          ? toCssLength(width) === '100%'
            ? undefined
            : toCssLength(width)
          : (toCssLength(width) ?? '100%'),
        ...cssVariables,
        ...style
      }),
      [width, cssVariables, style, isVertical]
    );
    return (
      <div ref={containerRef} className={rootClassName} style={containerStyle} role="region" aria-label={ariaLabel}>
        <div className="logoloop__track" ref={trackRef} onMouseEnter={handleMouseEnter} onMouseLeave={handleMouseLeave}>
          {logoLists}
        </div>
      </div>
    );
  }
);
LogoLoop.displayName = 'LogoLoop';
export default LogoLoop;

--- FILE: components\mermaid-chart.tsx ---

"use client"
import React, { useEffect, useRef, useState } from 'react'
import mermaid from 'mermaid'
interface MermaidChartProps {
  chart: string
}
const MermaidChart: React.FC<MermaidChartProps> = ({ chart }) => {
  const containerRef = useRef<HTMLDivElement>(null)
  const [svg, setSvg] = useState<string>('')
  useEffect(() => {
    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'loose',
      fontFamily: 'inherit',
    })
  }, [])
  useEffect(() => {
    const renderChart = async () => {
      if (!containerRef.current || !chart) return
      try {
        const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`
        const { svg } = await mermaid.render(id, chart)
        setSvg(svg)
      } catch (error) {
        console.error('Mermaid render error:', error)
        setSvg(`<div class="text-red-500 p-2 border border-red-200 rounded bg-red-50 text-sm">Failed to render chart</div>`)
      }
    }
    renderChart()
  }, [chart])
  return (
    <div
      ref={containerRef}
      className="my-4 w-full overflow-x-auto bg-white rounded-lg p-4 border border-gray-100"
      dangerouslySetInnerHTML={{ __html: svg }}
    />
  )
}
export default MermaidChart

--- FILE: components\message-notification-listener.tsx ---

"use client"
import { useEffect, useRef } from "react"
import { usePathname } from "next/navigation"
import { toast } from "sonner"
export function MessageNotificationListener() {
  const lastCheckedRef = useRef(Date.now())
  const pathname = usePathname()
  useEffect(() => {
    // Request permission on mount
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission()
    }
    const checkMessages = async () => {
      try {
        const res = await fetch(`/api/messages/check?since=${lastCheckedRef.current}`)
        if (res.ok) {
          const data = await res.json()
          if (data.messages && data.messages.length > 0) {
            // Found new messages
            data.messages.forEach((msg: any) => {
              const title = msg.group_name
                ? `${msg.sender_name} (在 ${msg.group_name})`
                : msg.sender_name
              const body = msg.type === 'image' ? '[图片]' :
                           msg.type === 'file' ? '[文件]' :
                           msg.content
              // Browser Notification Logic
              // Trigger if document is hidden OR user is not on chat page
              if (Notification.permission === "granted" && (document.hidden || pathname !== '/chat')) {
                new Notification(title, {
                  body: body,
                  icon: msg.sender_avatar || "/logo.svg",
                  tag: `msg-${msg.id}`, // Deduplicate notifications
                  silent: false
                })
              }
              // Toast Logic
              // Show toast if user is NOT on chat page
              if (pathname !== '/chat') {
                toast(title, {
                  description: body,
                  action: {
                    label: "查看",
                    onClick: () => window.location.href = "/chat"
                  }
                })
              }
            })
          }
          if (data.timestamp) {
            lastCheckedRef.current = data.timestamp
          }
        }
      } catch (e) {
        // Silent fail
      }
    }
    const interval = setInterval(checkMessages, 3000) // Check every 3s
    return () => clearInterval(interval)
  }, [pathname]) // Re-create interval if pathname changes? No, interval closure captures pathname?
  // Wait, setInterval closure captures initial pathname.
  // I should use a ref for pathname or include pathname in dependency.
  // If I include pathname in dependency, interval resets on navigation. This is fine.
  return null
}

--- FILE: components\mobile-ai-settings-modal.tsx ---

import { useState, useEffect } from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { Dialog, DialogPortal, DialogOverlay } from "@/components/ui/dialog"
import { Label } from "@/components/ui/label"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import {
  Settings,
  Key,
  Link as LinkIcon,
  Box,
  MessageSquareText,
  X,
  CheckCircle2,
  Bot,
  Sparkles
} from "lucide-react"
import { cn } from "@/lib/utils"
interface AISettings {
  apiKey: string
  apiUrl: string
  model: string
  systemPrompt: string
}
interface MobileAISettingsModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSave: (settings: AISettings) => void
}
export function MobileAISettingsModal({ open, onOpenChange, onSave }: MobileAISettingsModalProps) {
  const [settings, setSettings] = useState<AISettings>({
    apiKey: "",
    apiUrl: "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
    model: "",
    systemPrompt:
      "你是莓界智慧农业平台的AI助手，专门帮助用户分析农业数据、提供种植建议和解答农业相关问题。请用专业但易懂的语言回答问题。\n\n重要提醒：如果需要提供参考来源，请确保所有链接和信息都是真实存在的，绝对不要编造虚假的网站或来源。如果不确定来源，请直接说明这是基于你的知识库回答，而不是提供虚假引用。",
  })
  const [apiType, setApiType] = useState<"dashscope" | "openai">("dashscope")
  useEffect(() => {
    const loadSettings = async () => {
      try {
        const response = await fetch("/api/settings")
        if (response.ok) {
          const serverSettings = await response.json()
          const savedStr = localStorage.getItem("ai-settings")
          const localSettings = savedStr ? JSON.parse(savedStr) : null
          const shouldUseLocal = !serverSettings?.apiKey || String(serverSettings.apiKey).trim() === ''
          const effective = shouldUseLocal && localSettings ? localSettings : serverSettings
          setSettings(effective)
          if (effective.apiUrl?.includes("dashscope") || effective.model?.startsWith("qwen")) {
            setApiType("dashscope")
          } else {
            setApiType("openai")
          }
        } else {
          const saved = localStorage.getItem("ai-settings")
          if (saved) {
            const parsed = JSON.parse(saved)
            setSettings(parsed)
            if (parsed.apiUrl?.includes("dashscope") || parsed.model?.startsWith("qwen")) {
              setApiType("dashscope")
            } else {
              setApiType("openai")
            }
          }
        }
      } catch {
        const saved = localStorage.getItem("ai-settings")
        if (saved) {
          try {
            const parsed = JSON.parse(saved)
            setSettings(parsed)
            if (parsed.apiUrl?.includes("dashscope") || parsed.model?.startsWith("qwen")) {
              setApiType("dashscope")
            } else {
              setApiType("openai")
            }
          } catch {}
        }
      }
    }
    loadSettings()
  }, [])
  const handleSave = async () => {
    try {
      const response = await fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(settings),
      })
      if (response.ok) {
        localStorage.setItem("ai-settings", JSON.stringify(settings))
        onSave(settings)
        onOpenChange(false)
      } else {
        const error = await response.json()
        alert(`保存失败: ${error.error || "未知错误"}`)
      }
    } catch {
      localStorage.setItem("ai-settings", JSON.stringify(settings))
      onSave(settings)
      onOpenChange(false)
    }
  }
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogPortal>
        <DialogOverlay className="bg-black/20 backdrop-blur-sm" />
        <DialogPrimitive.Content
          className="fixed inset-x-0 bottom-0 z-50 w-full max-w-none rounded-t-[2rem] bg-white dark:bg-zinc-900 shadow-2xl border-t border-black/5 dark:border-white/10 overflow-hidden h-[85vh] sm:left-1/2 sm:top-1/2 sm:inset-x-auto sm:h-auto sm:max-w-md sm:translate-x-[-50%] sm:translate-y-[-50%] sm:rounded-2xl sm:border animate-in slide-in-from-bottom-full sm:zoom-in-95 sm:slide-in-from-bottom-0 duration-300"
        >
          {/* Header */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-100 dark:border-white/5 bg-white/50 dark:bg-zinc-900/50 backdrop-blur-md sticky top-0 z-10">
            <div className="flex items-center gap-2.5">
              <div className="p-2 rounded-xl bg-blue-50 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400">
                <Settings size={18} strokeWidth={2.5} />
              </div>
              <div>
                <div className="text-base font-bold text-gray-900 dark:text-gray-100">模型配置</div>
                <div className="text-xs text-gray-500 dark:text-gray-400">配置您的专属 AI 助手</div>
              </div>
            </div>
            <Button variant="ghost" size="icon" onClick={() => onOpenChange(false)} className="rounded-full hover:bg-gray-100 dark:hover:bg-white/10 h-8 w-8 text-gray-500">
              <X size={18} />
            </Button>
          </div>
          {/* Content */}
          <div className="p-6 space-y-6 overflow-y-auto h-[calc(85vh-70px-80px)] sm:h-auto max-h-[70vh]">
            {/* API Type Selector */}
            <div className="space-y-3">
              <Label className="text-xs font-semibold text-gray-500 uppercase tracking-wider ml-1">服务提供商</Label>
              <div className="grid grid-cols-2 gap-1 p-1.5 bg-gray-100/80 dark:bg-zinc-800/50 rounded-xl border border-gray-200/50 dark:border-white/5">
                <button
                  type="button"
                  onClick={() => {
                    setApiType("dashscope")
                    setSettings({
                      ...settings,
                      apiUrl: "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
                    })
                  }}
                  className={cn(
                    "flex items-center justify-center gap-2 py-2.5 rounded-[10px] text-sm font-medium transition-all duration-200",
                    apiType === "dashscope"
                      ? "bg-white dark:bg-zinc-800 text-blue-600 dark:text-blue-400 shadow-sm ring-1 ring-black/5 dark:ring-white/10"
                      : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-white/50 dark:hover:bg-white/5"
                  )}
                >
                  <Sparkles size={16} />
                  <span>阿里云百炼</span>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setApiType("openai")
                    setSettings({
                      ...settings,
                      apiUrl: "https://api.openai.com/v1/chat/completions",
                    })
                  }}
                  className={cn(
                    "flex items-center justify-center gap-2 py-2.5 rounded-[10px] text-sm font-medium transition-all duration-200",
                    apiType === "openai"
                      ? "bg-white dark:bg-zinc-800 text-blue-600 dark:text-blue-400 shadow-sm ring-1 ring-black/5 dark:ring-white/10"
                      : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-white/50 dark:hover:bg-white/5"
                  )}
                >
                  <Bot size={16} />
                  <span>OpenAI</span>
                </button>
              </div>
              <p className="text-[10px] text-gray-400 px-1">
                {apiType === "dashscope"
                  ? "推荐国内用户使用，支持通义千问 Qwen 系列模型，速度快且稳定。"
                  : "支持 GPT-3.5, GPT-4 等标准 OpenAI 接口模型。"}
              </p>
            </div>
            <div className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="model" className="text-xs font-semibold text-gray-500 uppercase tracking-wider ml-1">模型名称</Label>
                <div className="relative group">
                  <Box className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
                  <Input
                    id="model"
                    placeholder={apiType === "dashscope" ? "例如: qwen-plus" : "例如: gpt-3.5-turbo"}
                    value={settings.model}
                    onChange={(e) => setSettings({ ...settings, model: e.target.value })}
                    className="pl-10 h-11 bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-white/10 focus-visible:ring-blue-500/20 focus-visible:border-blue-500 rounded-xl transition-all"
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="apiKey" className="text-xs font-semibold text-gray-500 uppercase tracking-wider ml-1">API Key</Label>
                <div className="relative group">
                  <Key className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
                  <Input
                    id="apiKey"
                    type="password"
                    placeholder="sk-..."
                    value={settings.apiKey}
                    onChange={(e) => setSettings({ ...settings, apiKey: e.target.value })}
                    className="pl-10 h-11 bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-white/10 focus-visible:ring-blue-500/20 focus-visible:border-blue-500 rounded-xl transition-all font-mono text-sm"
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="apiUrl" className="text-xs font-semibold text-gray-500 uppercase tracking-wider ml-1">API 接入点</Label>
                <div className="relative group">
                  <LinkIcon className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
                  <Input
                    id="apiUrl"
                    placeholder="https://..."
                    value={settings.apiUrl}
                    onChange={(e) => setSettings({ ...settings, apiUrl: e.target.value })}
                    className="pl-10 h-11 bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-white/10 focus-visible:ring-blue-500/20 focus-visible:border-blue-500 rounded-xl transition-all font-mono text-xs"
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="systemPrompt" className="text-xs font-semibold text-gray-500 uppercase tracking-wider ml-1">系统提示词</Label>
                <div className="relative group">
                  <MessageSquareText className="absolute left-3 top-4 size-4 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
                  <Textarea
                    id="systemPrompt"
                    placeholder="定义 AI 助手的角色和行为..."
                    value={settings.systemPrompt}
                    onChange={(e) => setSettings({ ...settings, systemPrompt: e.target.value })}
                    className="pl-10 min-h-[100px] bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-white/10 focus-visible:ring-blue-500/20 focus-visible:border-blue-500 rounded-xl transition-all resize-none leading-relaxed"
                  />
                </div>
              </div>
            </div>
          </div>
          {/* Footer */}
          <div className="p-6 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-zinc-900 sticky bottom-0 z-10">
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => onOpenChange(false)}
                className="flex-1 h-12 rounded-xl border-gray-200 hover:bg-gray-50 dark:border-white/10 dark:hover:bg-white/5 text-gray-600"
              >
                取消
              </Button>
              <Button
                onClick={handleSave}
                className="flex-[2] h-12 rounded-xl bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/20 font-medium text-base"
              >
                <CheckCircle2 size={18} className="mr-2" />
                保存配置
              </Button>
            </div>
          </div>
        </DialogPrimitive.Content>
      </DialogPortal>
    </Dialog>
  )
}
export default MobileAISettingsModal

--- FILE: components\mobile-background.tsx ---

"use client"
export function MobileBackground() {
  return (
    <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
      <div className="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] rounded-full bg-blue-500/10 blur-[100px] animate-[float_10s_ease-in-out_infinite]" />
      <div className="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] rounded-full bg-purple-500/10 blur-[100px] animate-[float_12s_ease-in-out_infinite_reverse]" />
      <div className="absolute top-[40%] left-[30%] w-[40%] h-[40%] rounded-full bg-cyan-500/5 blur-[80px] animate-[pulse_8s_ease-in-out_infinite]" />
    </div>
  )
}

--- FILE: components\mobile-bottom-nav.tsx ---

"use client"
import { usePathname } from "next/navigation"
import Link from "next/link"
import { motion, LayoutGroup } from "framer-motion"
import {
  HomeIcon,
  Cog6ToothIcon,
  Squares2X2Icon,
  UserIcon,
  SparklesIcon,
  ChatBubbleLeftRightIcon
} from "@heroicons/react/24/outline"
import {
  HomeIcon as HomeIconSolid,
  Cog6ToothIcon as Cog6ToothIconSolid,
  Squares2X2Icon as Squares2X2IconSolid,
  UserIcon as UserIconSolid,
  SparklesIcon as SparklesIconSolid,
  ChatBubbleLeftRightIcon as ChatBubbleLeftRightIconSolid
} from "@heroicons/react/24/solid"
interface NavItem {
  href: string
  label: string
  icon: any
  iconSolid: any
  id: string
}
const navItems: NavItem[] = [
  { href: "/monitor-ios", label: "监测", icon: HomeIcon, iconSolid: HomeIconSolid, id: "nav-monitor-ios" },
  { href: "/device-control-ios", label: "设备", icon: Cog6ToothIcon, iconSolid: Cog6ToothIconSolid, id: "nav-device-control-ios" },
  { href: "/dashboard-ios", label: "看板", icon: Squares2X2Icon, iconSolid: Squares2X2IconSolid, id: "nav-dashboard-ios" },
  { href: "/ai-assistant-ios", label: "AI助手", icon: SparklesIcon, iconSolid: SparklesIconSolid, id: "nav-ai-assistant-ios" },
  { href: "/chat", label: "聊天", icon: ChatBubbleLeftRightIcon, iconSolid: ChatBubbleLeftRightIconSolid, id: "nav-chat" },
  { href: "/profile-ios", label: "我的", icon: UserIcon, iconSolid: UserIconSolid, id: "nav-profile-ios" },
]
export function MobileBottomNav({ position = "fixed" }: { position?: "fixed" | "sticky" }) {
  const pathname = usePathname()
  return (
    <div className={`${position === "fixed" ? "fixed" : "sticky"} bottom-0 left-0 right-0 z-50 flex justify-center px-6 pb-4`}>
      <nav className="bg-white/80 dark:bg-[#1a1a1a]/80 backdrop-blur-xl rounded-full px-6 py-3 shadow-lg border border-white/20 dark:border-white/10">
        <div className="flex items-center gap-2">
          <LayoutGroup>
            {navItems.map((item) => {
              const isActive = pathname === item.href
              const Icon = isActive ? item.iconSolid : item.icon
              return (
                <Link key={item.href} href={item.href} className="relative" id={item.id}>
                  <motion.div
                    whileTap={{ scale: 0.95 }}
                    className="relative"
                  >
                    {isActive && (
                      <motion.div
                        layoutId="activeTab"
                        className="absolute inset-0 bg-blue-600 rounded-full"
                        transition={{ type: "spring", stiffness: 500, damping: 30 }}
                      />
                    )}
                    <div className={`relative px-4 py-2 rounded-full transition-colors duration-200 ${isActive ? "text-white" : "text-slate-600 dark:text-slate-400"
                      }`}>
                      <Icon className="size-6" />
                    </div>
                  </motion.div>
                </Link>
              )
            })}
          </LayoutGroup>
        </div>
      </nav>
    </div>
  )
}

--- FILE: components\mobile-onboarding-guide.tsx ---

"use client"
import { useEffect, useRef } from "react"
import { driver, DriveStep } from "driver.js"
import "driver.js/dist/driver.css"
import { Button } from "@/components/ui/button"
import { HelpCircle } from "lucide-react"
import { usePathname, useRouter } from "next/navigation"
// Define steps with an optional route property
type ExtendedDriveStep = DriveStep & { route?: string }
export function MobileOnboardingGuide() {
  const driverObj = useRef<any>(null)
  const router = useRouter()
  const pathname = usePathname()
  // Mobile Steps Configuration
  const tourSteps: ExtendedDriveStep[] = [
    // --- Step 0: Welcome & Monitor Tab ---
    {
      element: "#nav-monitor-ios",
      popover: {
        title: "监测中心",
        description: "这是首页，您可以在这里查看环境数据和实时监控。",
        side: "top",
      },
      route: "/monitor-ios"
    },
    // --- Step 1: Weather Info ---
    {
      element: "#mobile-weather-row",
      popover: {
        title: "环境数据",
        description: "顶部显示实时的温度、湿度和空气质量信息。",
        side: "bottom",
      },
      route: "/monitor-ios"
    },
    // --- Step 2: Video Player ---
    {
      element: "#mobile-video-player",
      popover: {
        title: "实时监控",
        description: "观看大棚内的实时视频流。支持全屏查看。",
        side: "bottom",
      },
      route: "/monitor-ios"
    },
    // --- Step 3: Room Tabs ---
    {
      element: "#mobile-room-tabs",
      popover: {
        title: "区域切换",
        description: "点击这里切换不同的大棚或种植区域。",
        side: "bottom",
      },
      route: "/monitor-ios"
    },
    // --- Step 4: Device Grid (Monitor) ---
    {
      element: "#mobile-device-grid",
      popover: {
        title: "快速控制",
        description: "这里展示常用设备的状态，并支持快速开关。",
        side: "top",
      },
      route: "/monitor-ios"
    },
    // --- Step 5: Device Control Tab ---
    {
      element: "#nav-device-control-ios",
      popover: {
        title: "设备管理",
        description: "点击这里进入更详细的设备控制页面。",
        side: "top",
      },
      route: "/device-control-ios"
    },
    // --- Step 6: Control Grid ---
    {
      element: "#mobile-control-grid",
      popover: {
        title: "全面控制",
        description: "管理所有设备的开关、调节灯光颜色和亮度等。",
        side: "top",
      },
      route: "/device-control-ios"
    },
    // --- Step 7: Dashboard Tab ---
    {
      element: "#nav-dashboard-ios",
      popover: {
        title: "数据看板",
        description: "查看历史数据趋势和详细的统计图表。",
        side: "top",
      },
      route: "/dashboard-ios"
    },
    // --- Step 8: AI Assistant Tab ---
    {
      element: "#nav-ai-assistant-ios",
      popover: {
        title: "AI 助手",
        description: "有任何种植问题？随时问我！支持语音对话和图片诊断。",
        side: "top",
      },
      route: "/ai-assistant-ios"
    },
    // --- Step 9: AI Settings (Mobile) ---
    {
      element: "#mobile-ai-settings-trigger",
      popover: {
        title: "API 设置",
        description: "重要：请点击左上角的设置图标配置 API Key。您需要输入阿里云 DashScope Key 才能正常使用 AI 对话功能。",
        side: "bottom",
      },
      route: "/ai-assistant-ios"
    },
    // --- Step 10: Profile Tab ---
    {
      element: "#nav-profile-ios",
      popover: {
        title: "个人中心",
        description: "管理您的账号设置和个人信息。",
        side: "top",
      },
      route: "/profile"
    }
  ]
  useEffect(() => {
    driverObj.current = driver({
      showProgress: true,
      animate: true,
      allowClose: true,
      doneBtnText: "完成",
      nextBtnText: "下一步",
      prevBtnText: "上一步",
      steps: tourSteps,
      // Handle navigation when clicking Next
      onNextClick: (element, step, { state }) => {
        const currentStepIndex = state.activeIndex ?? 0
        const nextStepIndex = currentStepIndex + 1
        if (nextStepIndex < tourSteps.length) {
          const nextStep = tourSteps[nextStepIndex]
          // If the next step requires a different route
          if (nextStep.route && window.location.pathname !== nextStep.route) {
            driverObj.current.destroy()
            router.push(nextStep.route)
            // Save state to resume after navigation
            localStorage.setItem("mobile-tour-active", "true")
            localStorage.setItem("mobile-tour-step", nextStepIndex.toString())
            return
          }
        }
        driverObj.current.moveNext()
      },
      onPrevClick: (element, step, { state }) => {
         const currentStepIndex = state.activeIndex ?? 0
         const prevStepIndex = currentStepIndex - 1
         if (prevStepIndex >= 0) {
            const prevStep = tourSteps[prevStepIndex]
            if (prevStep.route && window.location.pathname !== prevStep.route) {
                driverObj.current.destroy()
                router.push(prevStep.route)
                localStorage.setItem("mobile-tour-active", "true")
                localStorage.setItem("mobile-tour-step", prevStepIndex.toString())
                return
            }
         }
         driverObj.current.movePrevious()
      }
    })
    // Check resume state
    const isTourActive = localStorage.getItem("mobile-tour-active")
    const tourStep = localStorage.getItem("mobile-tour-step")
    if (isTourActive === "true" && tourStep) {
      const stepIndex = parseInt(tourStep)
      const stepConfig = tourSteps[stepIndex]
      if (stepConfig?.element) {
          // Wait a bit for element to appear
          setTimeout(() => {
              driverObj.current.drive(stepIndex)
              localStorage.removeItem("mobile-tour-active")
              localStorage.removeItem("mobile-tour-step")
          }, 800)
      }
    } else {
        // Auto start on first visit (optional)
        const hasSeenMobileGuide = localStorage.getItem("has-seen-mobile-guide")
        // Don't auto-start on login/register
        const isAuthPage = pathname === "/login" || pathname === "/register" || pathname === "/"
        if (!hasSeenMobileGuide && !isAuthPage && pathname === "/monitor-ios") {
            setTimeout(() => {
                driverObj.current.drive()
                localStorage.setItem("has-seen-mobile-guide", "true")
            }, 1500)
        }
    }
  }, [pathname, router])
  // Only show on mobile pages
  const isMobilePage = [
      "/monitor-ios",
      "/device-control-ios",
      "/dashboard-ios",
      "/ai-assistant-ios",
      "/profile"
  ].includes(pathname)
  if (!isMobilePage) return null
  const startTour = () => {
    localStorage.removeItem("mobile-tour-active")
    localStorage.removeItem("mobile-tour-step")
    if (pathname !== "/monitor-ios") {
        router.push("/monitor-ios")
        localStorage.setItem("mobile-tour-active", "true")
        localStorage.setItem("mobile-tour-step", "0")
    } else {
        driverObj.current?.drive(0)
    }
  }
  return (
    <Button
        variant="ghost"
        size="icon"
        className="fixed bottom-24 right-4 z-40 rounded-full bg-white/90 shadow-lg border hover:bg-white text-blue-600 backdrop-blur-sm"
        onClick={startTour}
        title="功能引导"
    >
        <HelpCircle className="size-6" />
    </Button>
  )
}

--- FILE: components\mode-toggle.tsx ---

"use client"
import * as React from "react"
import { MoonIcon, SunIcon } from "@heroicons/react/24/outline"
import { useTheme } from "next-themes"
import { Button } from "@/components/ui/button"
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
export function ModeToggle() {
    const { setTheme } = useTheme()
    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="outline" size="icon" className="rounded-full bg-background/50 backdrop-blur-sm border-border/50 hover:bg-accent/50 transition-all duration-300 hover:scale-105">
                    <SunIcon className="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
                    <MoonIcon className="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
                    <span className="sr-only">Toggle theme</span>
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => setTheme("light")}>
                    Light
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => setTheme("dark")}>
                    Dark
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => setTheme("system")}>
                    System
                </DropdownMenuItem>
            </DropdownMenuContent>
        </DropdownMenu>
    )
}

--- FILE: components\onboarding-guide.tsx ---

"use client"
import { useEffect, useRef, useState } from "react"
import { driver, DriveStep } from "driver.js"
import "driver.js/dist/driver.css"
import { Button } from "@/components/ui/button"
import { HelpCircle } from "lucide-react"
import { usePathname, useRouter } from "next/navigation"
// Define steps with an optional route property
type ExtendedDriveStep = DriveStep & { route?: string }
export function DesktopOnboardingGuide() {
  // Helper hook for media query
  const useMediaQuery = (query: string) => {
    const [matches, setMatches] = useState(false)
    useEffect(() => {
      const media = window.matchMedia(query)
      if (media.matches !== matches) {
        setMatches(media.matches)
      }
      const listener = () => setMatches(media.matches)
      window.addEventListener("resize", listener)
      return () => window.removeEventListener("resize", listener)
    }, [matches, query])
    return matches
  }
  const isDesktop = useMediaQuery("(min-width: 768px)")
  const driverObj = useRef<any>(null)
  const router = useRouter()
  const pathname = usePathname()
  // Steps configuration
  const tourSteps: ExtendedDriveStep[] = [
    // --- Step 0: Welcome & Monitor Nav ---
    {
      element: "#nav-monitor",
      popover: {
        title: "农作物监测",
        description: "点击此处进入监测页面，查看实时的环境数据、视频监控流以及设备运行状态。",
        side: "bottom",
      },
      route: "/monitor"
    },
    // --- Step 1: Monitor Page - Video ---
    {
      element: "#monitor-player",
      popover: {
        title: "实时监控 & AI 识别",
        description: "这里展示农作物的实时画面。开启 AI 识别后，系统会自动分析植物生长状态。",
        side: "right",
      },
      route: "/monitor"
    },
    // --- Step 2: Monitor Page - Data Grid ---
    {
      element: "#monitor-data-grid",
      popover: {
        title: "环境数据",
        description: "实时显示温度、湿度、光照、CO2 等传感器数据，让您掌握第一手环境信息。",
        side: "left",
      },
      route: "/monitor"
    },
    // --- Step 3: Device Control Nav ---
    {
      element: "#nav-device-control",
      popover: {
        title: "硬件设备控制",
        description: "切换到此页面，您可以远程手动控制水泵、风扇、补光灯等设备。",
        side: "bottom",
      },
      route: "/device-control"
    },
    // --- Step 4: Device Control Page - Grid ---
    {
      element: "#device-control-grid",
      popover: {
        title: "设备开关",
        description: "直观的卡片式开关，点击即可控制设备启停。支持调节亮度的设备会有滑动条。",
        side: "top",
      },
      route: "/device-control"
    },
    // --- Step 5: Dashboard Nav ---
    {
      element: "#nav-dashboard",
      popover: {
        title: "数据看板",
        description: "进入数据看板，查看更详细的历史数据趋势和统计图表。",
        side: "bottom",
      },
      route: "/dashboard"
    },
    // --- Step 6: Dashboard Page - Charts ---
    {
      element: "#dashboard-charts",
      popover: {
        title: "可视化图表",
        description: "拖拽式布局的数据大屏，您可以自由调整图表位置和大小，定制专属看板。",
        side: "top",
      },
      route: "/dashboard"
    },
    // --- Step 7: AI Assistant Nav ---
    {
      element: "#nav-ai-assistant",
      popover: {
        title: "AI 助手",
        description: "遇到种植问题？来问问 AI 助手吧，它能诊断病害、提供种植建议。",
        side: "bottom",
      },
      route: "/ai-assistant"
    },
    // --- Step 8: AI Assistant - Welcome Area ---
    {
      element: "#ai-welcome-area",
      popover: {
        title: "对话区域",
        description: "这里显示您的对话历史。如果是新会话，您会看到常用的快捷指令和天气信息。",
        side: "top",
      },
      route: "/ai-assistant"
    },
    // --- Step 9: AI Assistant - Model Selector ---
    // Use conditional selector based on what's visible
    {
      element: "#ai-model-selector-nav",
      popover: {
        title: "模型选择",
        description: "在顶部栏或输入框上方，您可以切换不同的 AI 模型（如 Qwen-VL, Qwen-Max 等）以适应不同任务。",
        side: "bottom",
      },
      route: "/ai-assistant"
    },
    // --- Step 10: AI Assistant - Quick Actions ---
    {
      element: "#ai-quick-actions",
      popover: {
        title: "快捷指令",
        description: "点击这些卡片可以快速执行常用任务，如诊断病害、生成周报等。",
        side: "top",
      },
      route: "/ai-assistant"
    },
    // --- Step 11: AI Assistant - Input ---
    {
      element: "#ai-input-area",
      popover: {
        title: "输入区域",
        description: "在这里输入文字与 AI 对话。",
        side: "top",
      },
      route: "/ai-assistant"
    },
    // --- Step 12: AI Assistant - Tools ---
    {
      element: "#ai-input-tools",
      popover: {
        title: "多模态工具",
        description: "使用这些按钮上传图片/文件、开启联网搜索或启用深度思考模式。",
        side: "top",
      },
      route: "/ai-assistant"
    },
    // --- Step 13: AI Assistant - Settings (API Key) ---
    {
      element: "#ai-settings-trigger",
      popover: {
        title: "API 设置",
        description: "重要：首次使用请点击此处设置 API Key（支持阿里云 DashScope 等）。只有配置了正确的 Key，AI 功能才能正常使用。",
        side: "top",
      },
      route: "/ai-assistant"
    },
    // --- Step 14: User Menu ---
    {
      element: "#user-menu-trigger",
      popover: {
        title: "用户中心",
        description: "管理您的个人资料、修改密码或退出登录。",
        side: "bottom",
        align: "end"
      },
      // Global element, any route is fine, but let's keep it on current
    },
  ]
  useEffect(() => {
    driverObj.current = driver({
      showProgress: true,
      animate: true,
      allowClose: true,
      doneBtnText: "完成",
      nextBtnText: "下一步",
      prevBtnText: "上一步",
      steps: tourSteps,
      // Handle navigation when clicking Next
      onNextClick: (element, step, { state }) => {
        const currentStepIndex = state.activeIndex ?? 0
        const nextStepIndex = currentStepIndex + 1
        if (nextStepIndex < tourSteps.length) {
          const nextStep = tourSteps[nextStepIndex]
          // If the next step requires a different route
          if (nextStep.route && window.location.pathname !== nextStep.route) {
            // 1. Destroy current highlight to avoid glitches
            driverObj.current.destroy()
            // 2. Navigate
            router.push(nextStep.route)
            // 3. Save state to localStorage so we can resume after navigation
            localStorage.setItem("tour-active", "true")
            localStorage.setItem("tour-step", nextStepIndex.toString())
            // Stop default driver action (it would try to find element on current page)
            return
          }
        }
        // If no navigation needed, proceed normally
        driverObj.current.moveNext()
      },
      // Handle Previous button similarly if needed (optional for MVP)
      onPrevClick: (element, step, { state }) => {
         const currentStepIndex = state.activeIndex ?? 0
         const prevStepIndex = currentStepIndex - 1
         if (prevStepIndex >= 0) {
            const prevStep = tourSteps[prevStepIndex]
            if (prevStep.route && window.location.pathname !== prevStep.route) {
                driverObj.current.destroy()
                router.push(prevStep.route)
                localStorage.setItem("tour-active", "true")
                localStorage.setItem("tour-step", prevStepIndex.toString())
                return
            }
         }
         driverObj.current.movePrevious()
      },
      onDestroyed: () => {
         // Only clear if we are NOT navigating
         // We can check if we just set the flag
         // But simpler: we clear the flag when we resume
      }
    })
    // Helper to wait for element
    const waitForElement = (selector: string, timeout = 3000) => {
        return new Promise((resolve) => {
            const startTime = Date.now()
            const check = () => {
                if (document.querySelector(selector)) {
                    resolve(true)
                } else if (Date.now() - startTime > timeout) {
                    resolve(false)
                } else {
                    requestAnimationFrame(check)
                }
            }
            check()
        })
    }
    // Check if we need to resume a tour
    const isTourActive = localStorage.getItem("tour-active")
    const tourStep = localStorage.getItem("tour-step")
    if (isTourActive === "true" && tourStep) {
      const stepIndex = parseInt(tourStep)
      const stepConfig = tourSteps[stepIndex]
      // Resume tour at specific step
      // Use dynamic wait instead of fixed timeout
      if (stepConfig?.element) {
          waitForElement(stepConfig.element as string).then(() => {
              // Extra small delay for layout stability
              setTimeout(() => {
                  driverObj.current.drive(stepIndex)
                  localStorage.removeItem("tour-active") // Clear flag once resumed
                  localStorage.removeItem("tour-step")
              }, 500)
          })
      }
    } else {
        // Check if first time visit ever
        const hasSeenGuide = localStorage.getItem("has-seen-guide")
        // Don't start guide on login or register pages
        const isAuthPage = pathname === "/login" || pathname === "/register" || pathname === "/"
        if (!hasSeenGuide && !isAuthPage) {
            // Wait for first element usually #nav-monitor
            waitForElement("#nav-monitor").then(() => {
                setTimeout(() => {
                    // Check if announcement dialog is open
                    const isAnnouncementOpen = document.querySelector('[role="dialog"]')
                    if (isAnnouncementOpen) {
                      return // Skip auto-start if announcement is showing
                    }
                    driverObj.current.drive()
                    localStorage.setItem("has-seen-guide", "true")
                }, 2000) // Increase delay to 2s to ensure announcement has time to appear
            })
        }
    }
  }, [pathname, router]) // Re-run effect when pathname changes to check for resume
  // Don't show help button on auth pages or mobile pages
  if (
    pathname === "/login" ||
    pathname === "/register" ||
    pathname === "/" ||
    pathname.includes("-ios") ||
    !isDesktop
  ) {
    return null
  }
  const startTour = () => {
    // Reset state
    localStorage.removeItem("tour-active")
    localStorage.removeItem("tour-step")
    // If we are not on the first page, navigate there first?
    // Or just start. The first step is #nav-monitor which is global.
    // But Step 1 is #monitor-player which is on /monitor.
    // Safer to start from /monitor if we want linear flow.
    if (pathname !== "/monitor") {
        router.push("/monitor")
        localStorage.setItem("tour-active", "true")
        localStorage.setItem("tour-step", "0")
    } else {
        driverObj.current?.drive(0)
    }
  }
  return (
    <Button
        variant="ghost"
        size="icon"
        className="fixed bottom-4 right-4 z-50 rounded-full bg-white shadow-lg border hover:bg-gray-50 text-gray-500"
        onClick={startTour}
        title="新手引导"
    >
        <HelpCircle className="size-5" />
    </Button>
  )
}

--- FILE: components\page-navigation.tsx ---

"use client"
import { CloudIcon, Cog6ToothIcon, ChartBarIcon, SparklesIcon, ChatBubbleLeftRightIcon } from "@heroicons/react/24/outline"
import Link from "next/link"
import Image from "next/image"
import { usePathname, useRouter } from "next/navigation"
import { motion } from "framer-motion"
import { useState, useEffect } from "react"
export function PageNavigation() {
  const pathname = usePathname()
  const router = useRouter()
  const navItems = [
    { href: "/monitor", icon: CloudIcon, label: "农作物监测", id: "nav-monitor" },
    { href: "/device-control", icon: Cog6ToothIcon, label: "硬件设备控制", id: "nav-device-control" },
    { href: "/dashboard", icon: ChartBarIcon, label: "数据看板", id: "nav-dashboard" },
    { href: "/ai-assistant", icon: SparklesIcon, label: "AI 助手", id: "nav-ai-assistant" },
    { href: "/chat", icon: ChatBubbleLeftRightIcon, label: "聊天", id: "nav-chat" },
  ]
  const activeIndex = navItems.findIndex((item) => pathname === item.href)
  const [selectedIndex, setSelectedIndex] = useState(activeIndex === -1 ? 0 : activeIndex)
  // Sync state with pathname changes (e.g. browser back button or external navigation)
  useEffect(() => {
    if (activeIndex !== -1) {
      setSelectedIndex(activeIndex)
    }
  }, [pathname, activeIndex])
  return (
    <div className="relative rounded-full bg-[#162236]/80 backdrop-blur-md p-1.5 h-12 flex items-center gap-2 shadow-xl border border-white/5">
      {/* 导航按钮 */}
      {navItems.map((item, index) => {
        const Icon = item.icon
        const isActive = index === selectedIndex
        return (
          <Link
            key={item.href}
            href={item.href}
            id={item.id}
            className="relative z-10 h-9 rounded-full px-5 flex items-center gap-2 transition-colors duration-200"
            onClick={(e) => {
              e.preventDefault()
              if (selectedIndex !== index) setSelectedIndex(index)
              setTimeout(() => router.push(item.href), 200)
            }}
          >
            {/* 激活状态的背景 - 使用 layoutId 实现共享布局动画 */}
            {isActive && (
              <motion.div
                layoutId="activeTab"
                className="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 shadow-lg"
                transition={{
                  type: "spring",
                  stiffness: 380,
                  damping: 30,
                }}
              />
            )}
            {/* 图标和文字 */}
            <motion.div
              className="relative z-10 flex items-center gap-2"
              animate={{
                color: isActive ? "#ffffff" : "rgba(255, 255, 255, 0.7)",
              }}
              transition={{ duration: 0.2 }}
            >
              {item.href === "/ai-assistant" ? (
                <div className="size-[18px] rounded-full overflow-hidden">
                  <Image src="/logo.gif" alt="AI" width={18} height={18} className="object-cover" unoptimized />
                </div>
              ) : (
                <Icon className="size-[18px]" />
              )}
              <span className="text-sm font-medium">{item.label}</span>
            </motion.div>
          </Link>
        )
      })}
    </div>
  )
}

--- FILE: components\page-transition.tsx ---

"use client"
import { motion, AnimatePresence } from "framer-motion"
import { usePathname } from "next/navigation"
import { LayoutRouterContext } from "next/dist/shared/lib/app-router-context.shared-runtime"
import { useContext, useRef } from "react"
// Define the order of pages for transition direction
const pageOrder = [
    "/dashboard",
    "/monitor",
    "/device-control",
    "/ai-assistant",
    "/chat"
]
function FrozenRouter(props: { children: React.ReactNode }) {
    const context = useContext(LayoutRouterContext ?? {})
    const frozen = useRef(context).current
    return (
        <LayoutRouterContext.Provider value={frozen}>
            {props.children}
        </LayoutRouterContext.Provider>
    )
}
import { DesktopOnboardingGuide } from "@/components/onboarding-guide"
export function PageTransition({ children }: { children: React.ReactNode }) {
    const pathname = usePathname()
    // Find index of current page
    // If page is not in the list (e.g. login), default to -1 or handle as needed
    const getPageIndex = (path: string) => {
        const index = pageOrder.findIndex(p => path.startsWith(p))
        return index === -1 ? 0 : index
    }
    const isMobile = pathname.includes("-ios") || pathname === "/profile"
    // Disable transition wrapper for Landing Page ("/") to allow native scrolling
    if (isMobile || pathname === "/") {
        return (
            <>
                {children}
                {!isMobile && <DesktopOnboardingGuide />}
            </>
        )
    }
    const currentIndex = getPageIndex(pathname)
    // We need to store the previous index to determine direction
    // However, in a functional component, we can't easily get "previous" props without a ref or state
    // But AnimatePresence's custom prop allows us to pass data to variants
    // A simpler approach for "slide" is just to use the key.
    // To know direction, we might need a context or just rely on a simple assumption:
    // We can't easily know the "previous" path in a server component wrapper without more complex state.
    // BUT, for this specific request "AI Assistant -> Dashboard", AI is index 3, Dashboard is 0.
    // So we are going 3 -> 0 (decreasing).
    // Let's try a slightly different approach using a persistent tuple in a ref to track [prev, current]
    const indexRef = useRef<{ prev: number, current: number }>({ prev: currentIndex, current: currentIndex })
    if (indexRef.current.current !== currentIndex) {
        indexRef.current = { prev: indexRef.current.current, current: currentIndex }
    }
    const direction = indexRef.current.current > indexRef.current.prev ? 1 : -1
    const variants = {
        enter: (direction: number) => ({
            x: direction > 0 ? "100%" : "-100%",
            opacity: 0,
            zIndex: 1 // Ensure entering page is above or below? Usually above.
        }),
        center: {
            x: 0,
            opacity: 1,
            zIndex: 0
        },
        exit: (direction: number) => ({
            x: direction > 0 ? "-100%" : "100%",
            opacity: 0,
            zIndex: -1
        })
    }
    return (
        <div className="relative w-full h-screen overflow-hidden bg-gray-50 dark:bg-zinc-950">
            <AnimatePresence mode="popLayout" initial={false} custom={direction}>
                <motion.div
                    key={pathname}
                    custom={direction}
                    variants={variants}
                    initial="enter"
                    animate="center"
                    exit="exit"
                    transition={{
                        x: { type: "spring", stiffness: 300, damping: 30 },
                        opacity: { duration: 0.2 }
                    }}
                    className="w-full h-full"
                >
                    <FrozenRouter>{children}</FrozenRouter>
                </motion.div>
            </AnimatePresence>
            <DesktopOnboardingGuide />
        </div>
    )
}

--- FILE: components\scheduler-init.tsx ---

"use client"
import { useEffect } from "react"
export function SchedulerInit() {
  useEffect(() => {
    // Initialize scheduler on app load
    fetch("/api/scheduler/init").catch(console.error)
  }, [])
  return null
}

--- FILE: components\smooth-scroll.tsx ---

"use client"
import { ReactLenis } from "@studio-freight/react-lenis"
export function SmoothScroll({ children }: { children: any }) {
  return (
    <ReactLenis root options={{ lerp: 0.1, duration: 1.5, smoothWheel: true }}>
      {children}
    </ReactLenis>
  )
}

--- FILE: components\theme-provider.tsx ---

"use client"
import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"
export function ThemeProvider({
    children,
    ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
    return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

--- FILE: components\toaster-wrapper.tsx ---

"use client"
import { Toaster } from "sonner"
import { usePathname } from "next/navigation"
import { useEffect, useState } from "react"
export function ToasterWrapper() {
  const pathname = usePathname()
  const [isMobile, setIsMobile] = useState(false)
  useEffect(() => {
    // Check if current path indicates a mobile page (ending with -ios)
    // OR if the viewport is mobile width
    const isMobilePath = pathname?.includes('-ios')
    const isMobileWidth = window.innerWidth < 768
    setIsMobile(!!(isMobilePath || isMobileWidth))
    // Optional: Add resize listener if we want to be responsive to window resizing
    const handleResize = () => {
      setIsMobile(window.innerWidth < 768 || (pathname?.includes('-ios') ?? false))
    }
    window.addEventListener('resize', handleResize)
    return () => window.removeEventListener('resize', handleResize)
  }, [pathname])
  return (
    <Toaster
      position={isMobile ? "top-center" : "bottom-right"}
      richColors
      closeButton
    />
  )
}

--- FILE: components\ui\aspect-ratio.tsx ---

"use client"
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"
function AspectRatio({
  ...props
}: React.ComponentProps<typeof AspectRatioPrimitive.Root>) {
  return <AspectRatioPrimitive.Root data-slot="aspect-ratio" {...props} />
}
export { AspectRatio }

--- FILE: components\ui\assistant-ui.tsx ---

import * as React from "react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import { Tooltip, TooltipProvider, TooltipTrigger, TooltipContent } from "@/components/ui/tooltip"
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem
} from "@/components/ui/dropdown-menu"
import Image from "next/image"
import { User, ArrowUpIcon, ChevronDown, ExternalLink, Quote, FileText } from "lucide-react"
// Scroll configuration
const SCROLL_CONFIG = {
  BOTTOM_THRESHOLD: 100, // px - distance from bottom to consider "at bottom"
} as const
// Assistant Message Component
export interface AssistantMessageProps extends React.HTMLAttributes<HTMLDivElement> {
  isUser?: boolean
}
export const AssistantMessage = React.forwardRef<HTMLDivElement, AssistantMessageProps>(
  ({ className, isUser = false, children, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "group relative flex items-start gap-3",
          isUser && "flex-row-reverse",
          className
        )}
        {...props}
      >
        {children}
      </div>
    )
  }
)
AssistantMessage.displayName = "AssistantMessage"
// Assistant Avatar Component
export type AssistantAvatarProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantAvatar = React.forwardRef<HTMLDivElement, AssistantAvatarProps>(
  ({ className, children, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "flex size-8 shrink-0 select-none items-center justify-center rounded-full overflow-hidden",
          className
        )}
        {...props}
      >
        {children}
      </div>
    )
  }
)
AssistantAvatar.displayName = "AssistantAvatar"
// Assistant Content Component
export type AssistantContentProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantContent = React.forwardRef<HTMLDivElement, AssistantContentProps>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn("flex-1 space-y-2 overflow-hidden", className)}
        {...props}
      />
    )
  }
)
AssistantContent.displayName = "AssistantContent"
// Assistant Bubble Component
export interface AssistantBubbleProps extends React.HTMLAttributes<HTMLDivElement> {
  isUser?: boolean
}
export const AssistantBubble = React.forwardRef<HTMLDivElement, AssistantBubbleProps>(
  ({ className, isUser = false, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "rounded-2xl px-4 py-2.5 text-sm",
          isUser
            ? "bg-primary text-primary-foreground"
            : "bg-muted",
          className
        )}
        {...props}
      />
    )
  }
)
AssistantBubble.displayName = "AssistantBubble"
// Assistant Input Component
export type AssistantInputProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>
export const AssistantInput = React.forwardRef<HTMLTextAreaElement, AssistantInputProps>(
  ({ className, ...props }, ref) => {
    return (
      <Textarea
        ref={ref}
        className={cn(
          "min-h-[60px] max-h-[200px] resize-none rounded-2xl border-0 bg-muted p-4 pr-16 focus-visible:ring-0 focus-visible:ring-offset-0",
          className
        )}
        {...props}
      />
    )
  }
)
AssistantInput.displayName = "AssistantInput"
// Assistant Actions Component
export type AssistantActionsProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantActions = React.forwardRef<HTMLDivElement, AssistantActionsProps>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn("flex items-center gap-2", className)}
        {...props}
      />
    )
  }
)
AssistantActions.displayName = "AssistantActions"
export interface AssistantMessageActionsProps extends React.HTMLAttributes<HTMLDivElement> {
  isUser?: boolean
}
export const AssistantMessageActions = React.forwardRef<HTMLDivElement, AssistantMessageActionsProps>(
  ({ className, isUser = false, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "absolute -top-2 flex items-center gap-1 opacity-0 transition-opacity group-hover:opacity-100",
          isUser ? "left-0" : "right-0",
          className
        )}
        {...props}
      />
    )
  }
)
AssistantMessageActions.displayName = "AssistantMessageActions"
export const Actions = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn("flex items-center gap-2", className)}
        {...props}
      />
    )
  }
)
Actions.displayName = "Actions"
export interface ActionProps extends React.ComponentProps<typeof Button> {
  label: string
  tooltip?: string
}
export const Action = React.forwardRef<HTMLButtonElement, ActionProps>(
  ({ className, label, tooltip, variant = "ghost", size = "icon-sm", children, ...props }, ref) => {
    const btn = (
      <Button
        ref={ref}
        variant={variant}
        size={size}
        aria-label={label}
        className={cn("rounded-full", className)}
        {...props}
      >
        {children}
      </Button>
    )
    if (tooltip) {
      return (
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              {btn}
            </TooltipTrigger>
            <TooltipContent>{tooltip}</TooltipContent>
          </Tooltip>
        </TooltipProvider>
      )
    }
    return btn
  }
)
Action.displayName = "Action"
type ScrollBehaviorType = "auto" | "smooth"
interface ConversationContextValue {
  containerEl: HTMLDivElement | null
  setContainerEl: (el: HTMLDivElement | null) => void
  atBottom: boolean
  setAtBottom: (v: boolean) => void
  initialScrollBehavior: ScrollBehaviorType
  resizeScrollBehavior: ScrollBehaviorType
  scrollToBottom: (behavior?: ScrollBehaviorType) => void
}
const ConversationContext = React.createContext<ConversationContextValue | null>(null)
export interface ConversationProps extends React.HTMLAttributes<HTMLDivElement> {
  initialScrollBehavior?: ScrollBehaviorType
  resizeScrollBehavior?: ScrollBehaviorType
}
export const Conversation = React.forwardRef<HTMLDivElement, ConversationProps>(
  ({ className, initialScrollBehavior = "smooth", resizeScrollBehavior = "smooth", ...props }, ref) => {
    const [containerEl, setContainerEl] = React.useState<HTMLDivElement | null>(null)
    const [atBottom, setAtBottom] = React.useState(true)
    const scrollToBottom = (behavior: ScrollBehaviorType = initialScrollBehavior) => {
      const el = containerEl
      if (!el) return
      el.scrollTo({ top: el.scrollHeight, behavior })
    }
    return (
      <ConversationContext.Provider value={{ containerEl, setContainerEl, atBottom, setAtBottom, initialScrollBehavior, resizeScrollBehavior, scrollToBottom }}>
        <div ref={ref} className={cn("relative h-full", className)} {...props} />
      </ConversationContext.Provider>
    )
  }
)
Conversation.displayName = "Conversation"
export const ConversationContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const ctx = React.useContext(ConversationContext)
    const localRef = React.useRef<HTMLDivElement>(null)
    React.useEffect(() => {
      const el = ctx?.containerEl
      if (!el || !ctx) return
      const ro = new ResizeObserver(() => {
        // 取消自动滚动：仅更新尺寸观察，不触发滚动
      })
      ro.observe(el)
      return () => ro.disconnect()
    }, [ctx])
    const handleScroll = () => {
      const el = ctx?.containerEl
      if (!el || !ctx) return
      const threshold = SCROLL_CONFIG.BOTTOM_THRESHOLD
      const atBottomNow = el.scrollTop + el.clientHeight >= el.scrollHeight - threshold
      ctx.setAtBottom(atBottomNow)
    }
    return (
      <div
        ref={(node) => {
          localRef.current = node as HTMLDivElement | null
          if (ctx) ctx.setContainerEl(node as HTMLDivElement | null)
          if (typeof ref === "function") ref(node as HTMLDivElement)
          else if (ref) (ref as React.MutableRefObject<HTMLDivElement | null>).current = node as HTMLDivElement
        }}
        onScroll={handleScroll}
        className={cn("overflow-y-auto h-full", className)}
        {...props}
      />
    )
  }
)
ConversationContent.displayName = "ConversationContent"
export const ConversationScrollButton = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, children, ...props }, ref) => {
    const ctx = React.useContext(ConversationContext)
    if (!ctx || ctx.atBottom) return null
    return (
      <Button
        ref={ref}
        variant="ghost"
        size="icon"
        className={cn("absolute bottom-4 right-4 rounded-full", className)}
        onClick={() => ctx.scrollToBottom("smooth")}
        {...props}
      >
        {children ?? <span aria-hidden>↓</span>}
      </Button>
    )
  }
)
ConversationScrollButton.displayName = "ConversationScrollButton"
export const InlineCitation = React.forwardRef<HTMLSpanElement, React.HTMLAttributes<HTMLSpanElement>>(
  ({ className, ...props }, ref) => (
    <span ref={ref} className={cn("inline-flex items-baseline align-baseline", className)} {...props} />
  )
)
InlineCitation.displayName = "InlineCitation"
export const InlineCitationCard = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("inline-flex items-center", className)} {...props} />
  )
)
InlineCitationCard.displayName = "InlineCitationCard"
export interface InlineCitationCardTriggerProps extends React.ComponentProps<typeof Button> {
  sources: string[]
  number?: string
  children?: React.ReactNode
}
export const InlineCitationCardTrigger = React.forwardRef<HTMLButtonElement, InlineCitationCardTriggerProps>(
  ({ className, sources, number, children, ...props }, ref) => {
    const label = number ? `[${number}]` : `[${sources.length}]`
    return (
      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button ref={ref} variant="ghost" size="sm" className={cn("px-2 h-6 rounded-md text-xs", className)} {...props}>
              {label}
            </Button>
          </TooltipTrigger>
          <TooltipContent className="p-0">
            <div className="w-[320px] rounded-md border bg-background">
              <div className="p-3 text-xs text-muted-foreground">参考来源</div>
              {children}
            </div>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    )
  }
)
InlineCitationCardTrigger.displayName = "InlineCitationCardTrigger"
export const InlineCitationCardBody = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-3", className)} {...props} />
  )
)
InlineCitationCardBody.displayName = "InlineCitationCardBody"
export const InlineCitationCarousel = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col gap-2", className)} {...props} />
  )
)
InlineCitationCarousel.displayName = "InlineCitationCarousel"
export const InlineCitationCarouselHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex items-center justify-between p-3 border-b", className)} {...props} />
  )
)
InlineCitationCarouselHeader.displayName = "InlineCitationCarouselHeader"
export const InlineCitationCarouselIndex = React.forwardRef<HTMLSpanElement, React.HTMLAttributes<HTMLSpanElement>>(
  ({ className, ...props }, ref) => (
    <span ref={ref} className={cn("text-xs text-muted-foreground", className)} {...props} />
  )
)
InlineCitationCarouselIndex.displayName = "InlineCitationCarouselIndex"
export const InlineCitationCarouselContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-3", className)} {...props} />
  )
)
InlineCitationCarouselContent.displayName = "InlineCitationCarouselContent"
export const InlineCitationCarouselItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("space-y-2", className)} {...props} />
  )
)
InlineCitationCarouselItem.displayName = "InlineCitationCarouselItem"
export interface InlineCitationSourceProps extends React.HTMLAttributes<HTMLDivElement> {
  title: string
  url: string
  description?: string
}
export const InlineCitationSource = React.forwardRef<HTMLDivElement, InlineCitationSourceProps>(
  ({ className, title, url, description, ...props }, ref) => (
    <div ref={ref} className={cn("space-y-1", className)} {...props}>
      <a href={url} target="_blank" rel="noreferrer" className="text-sm text-primary hover:underline">{title}</a>
      <div className="text-xs text-muted-foreground break-all">{url}</div>
      {description && <div className="text-xs text-muted-foreground">{description}</div>}
    </div>
  )
)
InlineCitationSource.displayName = "InlineCitationSource"
export const InlineCitationQuote = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("rounded-md bg-muted p-2 text-xs", className)} {...props} />
  )
)
InlineCitationQuote.displayName = "InlineCitationQuote"
export interface LoaderProps extends React.HTMLAttributes<HTMLDivElement> {
  size?: number
}
export const Loader = React.forwardRef<HTMLDivElement, LoaderProps>((
  { className, size = 16, ...props },
  ref
) => (
  <div
    ref={ref}
    role="status"
    style={{ width: size, height: size }}
    className={cn("inline-block animate-spin rounded-full border-2 border-current border-t-transparent", className)}
    {...props}
  />
))
Loader.displayName = "Loader"
export type PromptInputProps = React.FormHTMLAttributes<HTMLFormElement>
export const PromptInput = React.forwardRef<HTMLFormElement, PromptInputProps>(({ className, ...props }, ref) => (
  <form ref={ref} className={cn("w-full", className)} {...props} />
))
PromptInput.displayName = "PromptInput"
export type PromptInputTextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>
export const PromptInputTextarea = React.forwardRef<HTMLTextAreaElement, PromptInputTextareaProps>(({ className, onKeyDown, ...props }, ref) => {
  const localRef = React.useRef<HTMLTextAreaElement>(null)
  React.useEffect(() => {
    const el = localRef.current
    if (!el) return
    el.style.height = "0px"
    el.style.height = `${Math.min(el.scrollHeight, 200)}px`
  }, [props.value])
  const handleKeyDown: React.KeyboardEventHandler<HTMLTextAreaElement> = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      e.currentTarget.form?.requestSubmit()
      return
    }
    onKeyDown?.(e)
  }
  return (
    <Textarea
      ref={(node) => {
        localRef.current = node as HTMLTextAreaElement | null
        if (typeof ref === "function") ref(node as HTMLTextAreaElement)
        else if (ref) (ref as React.MutableRefObject<HTMLTextAreaElement | null>).current = node as HTMLTextAreaElement
      }}
      className={cn(
        "min-h-[60px] max-h-[200px] resize-none rounded-2xl border-0 bg-muted p-4 pr-16 focus-visible:ring-0 focus-visible:ring-offset-0",
        className
      )}
      onKeyDown={handleKeyDown}
      {...props}
    />
  )
})
PromptInputTextarea.displayName = "PromptInputTextarea"
export type PromptInputToolbarProps = React.HTMLAttributes<HTMLDivElement>
export const PromptInputToolbar = React.forwardRef<HTMLDivElement, PromptInputToolbarProps>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("mt-2 flex items-center justify-between", className)} {...props} />
))
PromptInputToolbar.displayName = "PromptInputToolbar"
export type PromptInputToolsProps = React.HTMLAttributes<HTMLDivElement>
export const PromptInputTools = React.forwardRef<HTMLDivElement, PromptInputToolsProps>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center gap-2", className)} {...props} />
))
PromptInputTools.displayName = "PromptInputTools"
export const PromptInputButton = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(({ className, ...props }, ref) => (
  <Button ref={ref} variant="ghost" size="icon" className={cn("rounded-full", className)} {...props} />
))
PromptInputButton.displayName = "PromptInputButton"
export interface PromptInputSubmitProps extends React.ComponentProps<typeof Button> {
  status?: "idle" | "loading"
}
export const PromptInputSubmit = React.forwardRef<HTMLButtonElement, PromptInputSubmitProps>(({ className, status = "idle", disabled, ...props }, ref) => (
  <Button
    ref={ref}
    type="submit"
    size="icon"
    disabled={disabled || status === "loading"}
    className={cn("size-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700", className)}
    {...props}
  >
    {status === "loading" ? <Loader size={20} /> : <ArrowUpIcon className="size-4" />}
  </Button>
))
PromptInputSubmit.displayName = "PromptInputSubmit"
interface PromptModelContextValue {
  value: string
  onChange: (v: string) => void
}
const PromptModelContext = React.createContext<PromptModelContextValue | null>(null)
export interface PromptInputModelSelectProps extends React.HTMLAttributes<HTMLDivElement> {
  value: string
  onValueChange: (v: string) => void
}
export const PromptInputModelSelect = React.forwardRef<HTMLDivElement, PromptInputModelSelectProps>(({ className, value, onValueChange, children, ...props }, ref) => (
  <PromptModelContext.Provider value={{ value, onChange: onValueChange }}>
    <DropdownMenu>
      <div ref={ref} className={cn("flex items-center", className)} {...props}>{children}</div>
    </DropdownMenu>
  </PromptModelContext.Provider>
))
PromptInputModelSelect.displayName = "PromptInputModelSelect"
export const PromptInputModelSelectTrigger = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(({ className, children, ...props }, ref) => (
  <DropdownMenuTrigger asChild>
    <Button ref={ref} variant="ghost" size="sm" className={cn("h-8 px-3 rounded-full", className)} {...props}>
      {children}
    </Button>
  </DropdownMenuTrigger>
))
PromptInputModelSelectTrigger.displayName = "PromptInputModelSelectTrigger"
export const PromptInputModelSelectContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, children, ...props }, ref) => (
  <DropdownMenuContent ref={ref} className={cn("min-w-[12rem]", className)} {...props}>
    {children}
  </DropdownMenuContent>
))
PromptInputModelSelectContent.displayName = "PromptInputModelSelectContent"
export interface PromptInputModelSelectItemProps extends Omit<React.ComponentPropsWithoutRef<typeof DropdownMenuItem>, 'onSelect'> {
  value: string
}
export const PromptInputModelSelectItem = React.forwardRef<React.ElementRef<typeof DropdownMenuItem>, PromptInputModelSelectItemProps>(({ className, value, children, ...props }, ref) => {
  const ctx = React.useContext(PromptModelContext)
  const isSelected = ctx?.value === value
  return (
    <DropdownMenuItem ref={ref} className={cn("flex items-center gap-2", className)} onSelect={(e) => { e.preventDefault(); ctx?.onChange(value) }} {...props}>
      <span className={cn("inline-block size-2 rounded-full", isSelected ? "bg-primary" : "bg-muted")} />
      <span>{children ?? value}</span>
    </DropdownMenuItem>
  )
})
PromptInputModelSelectItem.displayName = "PromptInputModelSelectItem"
export const PromptInputModelSelectValue = React.forwardRef<HTMLSpanElement, React.HTMLAttributes<HTMLSpanElement>>(({ className, ...props }, ref) => {
  const ctx = React.useContext(PromptModelContext)
  return (
    <span ref={ref} className={cn("text-sm", className)} {...props}>{ctx?.value || "模型"}</span>
  )
})
PromptInputModelSelectValue.displayName = "PromptInputModelSelectValue"
export interface MessageProps extends React.HTMLAttributes<HTMLDivElement> {
  from?: "user" | "assistant" | "system"
}
export const Message = React.forwardRef<HTMLDivElement, MessageProps>(({ className, from = "assistant", children, ...props }, ref) => (
  <AssistantMessage ref={ref} isUser={from === "user"} className={cn(from === "system" ? "justify-center" : "", className)} {...props}>
    {children}
  </AssistantMessage>
))
Message.displayName = "Message"
export type MessageContentProps = React.HTMLAttributes<HTMLDivElement>
export const MessageContent = React.forwardRef<HTMLDivElement, MessageContentProps>(({ className, ...props }, ref) => (
  <AssistantContent ref={ref} className={className} {...props} />
))
MessageContent.displayName = "MessageContent"
export interface MessageAvatarProps extends React.HTMLAttributes<HTMLDivElement> {
  src?: string
  name?: string
  from?: "user" | "assistant" | "system"
}
export const MessageAvatar = React.forwardRef<HTMLDivElement, MessageAvatarProps>(({ className, src, name, from = "assistant", ...props }, ref) => (
  <AssistantAvatar ref={ref} className={className} {...props}>
    {src ? (
      <Image src={src} alt={name ?? "Avatar"} width={32} height={32} className="rounded-full object-cover" />
    ) : name ? (
      <span className="text-[10px] font-medium uppercase leading-none">{name.slice(0, 2)}</span>
    ) : from === "user" ? (
      <User className="size-4" />
    ) : null}
  </AssistantAvatar>
))
MessageAvatar.displayName = "MessageAvatar"
interface BranchContextValue {
  index: number
  count: number
  setIndex: (i: number) => void
}
const BranchContext = React.createContext<BranchContextValue | null>(null)
export interface BranchProps extends React.HTMLAttributes<HTMLDivElement> {
  defaultBranch?: number
  onBranchChange?: (index: number) => void
  count?: number
}
export const Branch = React.forwardRef<HTMLDivElement, BranchProps>(
  ({ className, defaultBranch = 0, onBranchChange, count = 0, ...props }, ref) => {
    const [index, setIndex] = React.useState(defaultBranch)
    const set = (i: number) => {
      const next = Math.max(0, Math.min(i, Math.max(0, count - 1)))
      setIndex(next)
      onBranchChange?.(next)
    }
    return (
      <BranchContext.Provider value={{ index, count, setIndex: set }}>
        <div ref={ref} className={cn("flex flex-col gap-2", className)} {...props} />
      </BranchContext.Provider>
    )
  }
)
Branch.displayName = "Branch"
export const BranchMessages = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col gap-2", className)} {...props} />
  )
)
BranchMessages.displayName = "BranchMessages"
export interface BranchSelectorProps extends React.HTMLAttributes<HTMLDivElement> {
  from?: "user" | "assistant" | "system"
}
export const BranchSelector = React.forwardRef<HTMLDivElement, BranchSelectorProps>(
  ({ className, from = "assistant", ...props }, ref) => {
    const ctx = React.useContext(BranchContext)
    const align = from === "assistant" ? "justify-end" : from === "user" ? "justify-start" : "justify-center"
    return (
      <div ref={ref} className={cn("flex items-center gap-2", align, className)} {...props} />
    )
  }
)
BranchSelector.displayName = "BranchSelector"
export const BranchPrevious = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, ...props }, ref) => {
    const ctx = React.useContext(BranchContext)
    const disabled = !ctx || ctx.index <= 0
    return (
      <Button ref={ref} variant="ghost" size="icon-sm" disabled={disabled} className={cn("rounded-full", className)}
        onClick={() => ctx && ctx.setIndex(ctx.index - 1)} {...props}>
        <span aria-hidden>◀</span>
      </Button>
    )
  }
)
BranchPrevious.displayName = "BranchPrevious"
export const BranchNext = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, ...props }, ref) => {
    const ctx = React.useContext(BranchContext)
    const disabled = !ctx || ctx.index >= Math.max(0, ctx.count - 1)
    return (
      <Button ref={ref} variant="ghost" size="icon-sm" disabled={disabled} className={cn("rounded-full", className)}
        onClick={() => ctx && ctx.setIndex(ctx.index + 1)} {...props}>
        <span aria-hidden>▶</span>
      </Button>
    )
  }
)
BranchNext.displayName = "BranchNext"
export const BranchPage = React.forwardRef<HTMLSpanElement, React.HTMLAttributes<HTMLSpanElement>>(
  ({ className, ...props }, ref) => {
    const ctx = React.useContext(BranchContext)
    const label = ctx ? `${ctx.index + 1} / ${Math.max(0, ctx.count)}` : "- / -"
    return (
      <span ref={ref} className={cn("text-xs text-muted-foreground", className)} {...props}>{label}</span>
    )
  }
)
BranchPage.displayName = "BranchPage"
interface ReasoningContextValue {
  open: boolean
  setOpen: (v: boolean) => void
  durationMs?: number
  finalized?: boolean
}
const ReasoningContext = React.createContext<ReasoningContextValue | null>(null)
export interface ReasoningProps extends React.HTMLAttributes<HTMLDivElement> {
  open?: boolean
  onOpenChange?: (v: boolean) => void
  durationMs?: number
  finalized?: boolean
}
export const Reasoning = React.forwardRef<HTMLDivElement, ReasoningProps>(
  ({ className, open = true, onOpenChange, durationMs, finalized, children, ...props }, ref) => {
    const [isOpen, setIsOpen] = React.useState(open)
    React.useEffect(() => { setIsOpen(open) }, [open])
    React.useEffect(() => { if (finalized) setTimeout(() => setIsOpen(false), 300) }, [finalized])
    const ctx: ReasoningContextValue = { open: isOpen, setOpen: (v) => { setIsOpen(v); onOpenChange?.(v) }, durationMs, finalized }
    return (
      <ReasoningContext.Provider value={ctx}>
        <div ref={ref} className={cn("flex flex-col gap-2", className)} {...props}>{children}</div>
      </ReasoningContext.Provider>
    )
  }
)
Reasoning.displayName = "Reasoning"
export const ReasoningTrigger = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, children, ...props }, ref) => {
    const ctx = React.useContext(ReasoningContext)
    const d = typeof ctx?.durationMs === "number" ? `${(ctx.durationMs / 1000).toFixed(1)}s` : ""
    return (
      <Button
        ref={ref}
        variant="ghost"
        size="sm"
        className={cn("h-6 px-2 rounded-full text-xs", className)}
        onClick={() => ctx?.setOpen?.(!ctx.open)}
        {...props}
      >
        <span>{ctx?.open ? "收起" : `思考过程${d ? ` · ${d}` : ""}`}</span>
      </Button>
    )
  }
)
ReasoningTrigger.displayName = "ReasoningTrigger"
export const ReasoningContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, children, ...props }, ref) => {
    const ctx = React.useContext(ReasoningContext)
    return (
      <div
        ref={ref}
        className={cn(
          "overflow-hidden transition-all",
          ctx?.open ? "max-h-[240px] opacity-100" : "max-h-0 opacity-0",
          className
        )}
        {...props}
      >
        <div className="rounded-2xl bg-muted/50 text-foreground/80 text-xs p-3 border border-border">
          <div className="flex items-center gap-2 mb-2">
            {ctx?.finalized ? null : <Loader size={12} />}
            <span className="text-xs">{ctx?.finalized ? "思考完成" : "思考中..."}</span>
            {typeof ctx?.durationMs === "number" ? <span className="text-xs text-muted-foreground/70">{(ctx.durationMs / 1000).toFixed(1)}s</span> : null}
          </div>
          <div className="whitespace-pre-wrap leading-relaxed">{children}</div>
        </div>
      </div>
    )
  }
)
ReasoningContent.displayName = "ReasoningContent"
export interface ResponseProps extends React.HTMLAttributes<HTMLDivElement> {
  children?: React.ReactNode
}
const sanitizeStreamingMarkdown = (input: string): string => {
  let s = input
  const fences = (s.match(/```/g) || []).length
  if (fences % 2 === 1) {
    const lastFence = s.lastIndexOf("```")
    if (lastFence !== -1) s = s.slice(0, lastFence)
  }
  const bold = (s.match(/\*\*/g) || []).length
  if (bold % 2 === 1) s += "**"
  const inlineCode = (s.match(/`/g) || []).length
  if (inlineCode % 2 === 1) s += "`"
  s = s.replace(/\[[^\]]*\]\([^)]*$/g, (m) => m.replace(/\([^)]*$/, ""))
  return s
}
export const Response = React.forwardRef<HTMLDivElement, ResponseProps>(({ className, children, ...props }, ref) => {
  if (typeof children === "string") {
    const safe = sanitizeStreamingMarkdown(children)
    return (
      <div ref={ref} className={cn("text-sm leading-relaxed", className)} aria-live="polite" {...props}>
        <span className="whitespace-pre-wrap">{safe}</span>
      </div>
    )
  }
  return (
    <div ref={ref} className={cn("text-sm leading-relaxed", className)} aria-live="polite" {...props}>{children}</div>
  )
})
Response.displayName = "Response"
interface SourcesContextValue {
  open: boolean
  setOpen: (v: boolean) => void
}
const SourcesContext = React.createContext<SourcesContextValue | null>(null)
export interface SourcesProps extends React.HTMLAttributes<HTMLDivElement> {
  open?: boolean
  onOpenChange?: (v: boolean) => void
}
export const Sources = React.forwardRef<HTMLDivElement, SourcesProps>(
  ({ className, open = false, onOpenChange, children, ...props }, ref) => {
    const [isOpen, setIsOpen] = React.useState(open)
    React.useEffect(() => { setIsOpen(open) }, [open])
    const ctx: SourcesContextValue = { open: isOpen, setOpen: (v) => { setIsOpen(v); onOpenChange?.(v) } }
    return (
      <SourcesContext.Provider value={ctx}>
        <div ref={ref} className={cn("flex flex-col gap-2", className)} {...props}>{children}</div>
      </SourcesContext.Provider>
    )
  }
)
Sources.displayName = "Sources"
export interface SourcesTriggerProps extends React.ComponentProps<typeof Button> {
  count?: number
}
export const SourcesTrigger = React.forwardRef<HTMLButtonElement, SourcesTriggerProps>(
  ({ className, count = 0, children, ...props }, ref) => {
    const ctx = React.useContext(SourcesContext)
    const label = children ?? `参考来源 ${count}`
    return (
      <Button
        ref={ref}
        variant="ghost"
        size="sm"
        className={cn("h-6 px-2 rounded-full text-xs", className)}
        onClick={() => ctx?.setOpen?.(!ctx.open)}
        {...props}
      >
        <ChevronDown className={cn("mr-1 size-3 transition-transform", ctx?.open ? "rotate-180" : "rotate-0")} />
        <span>{label}</span>
      </Button>
    )
  }
)
SourcesTrigger.displayName = "SourcesTrigger"
export const SourcesContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, children, ...props }, ref) => {
    const ctx = React.useContext(SourcesContext)
    return (
      <div
        ref={ref}
        className={cn(
          "overflow-hidden transition-all",
          ctx?.open ? "max-h-[280px] opacity-100" : "max-h-0 opacity-0",
          className
        )}
        {...props}
      >
        <div className="rounded-2xl bg-muted/50 text-foreground/80 text-xs p-3 border border-border">
          <div className="flex flex-col gap-2">
            {children}
          </div>
        </div>
      </div>
    )
  }
)
SourcesContent.displayName = "SourcesContent"
export interface SourceProps extends React.AnchorHTMLAttributes<HTMLAnchorElement> {
  href: string
  title?: string
  description?: string
  quote?: string
  number?: string | number
}
export const Source = React.forwardRef<HTMLAnchorElement, SourceProps>(({ className, href, title, description, quote, number, children, ...props }, ref) => {
  let host = ""
  try { host = new URL(href).hostname } catch { }
  const label = `${number ? `[${number}] ` : ""}${title ?? href}`
  return (
    <a
      ref={ref}
      href={href}
      target="_blank"
      rel="noreferrer noopener"
      className={cn("group block rounded-md p-2 sm:p-2.5 -mx-1 min-h-[44px] hover:bg-accent active:bg-accent/80 focus:outline-none focus:ring-2 focus:ring-ring", className)}
      aria-label={label}
      {...props}
    >
      <div className="flex items-start justify-between gap-2">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            {number ? <span className="text-xs text-muted-foreground/70">[{number}]</span> : null}
            <span className="text-sm font-medium text-foreground truncate">{title ?? href}</span>
          </div>
          {host ? <div className="text-xs text-muted-foreground/70 truncate">{host}</div> : null}
          {description ? <div className="mt-1 text-xs text-foreground/90 break-words">{description}</div> : null}
          {quote ? (
            <div className="mt-1 rounded-md border border-border bg-muted/50 p-2">
              <div className="flex items-start gap-1.5">
                <Quote className="size-3 shrink-0 text-muted-foreground/70" />
                <span className="text-xs text-foreground/80 break-words">{quote}</span>
              </div>
            </div>
          ) : null}
        </div>
        <ExternalLink className="size-3 shrink-0 text-muted-foreground group-hover:text-foreground" />
      </div>
    </a>
  )
})
Source.displayName = "Source"
// Assistant Modal Component
export type AssistantModalProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantModal = React.forwardRef<HTMLDivElement, AssistantModalProps>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "flex h-full flex-col rounded-xl border bg-background shadow-lg",
          className
        )}
        {...props}
      />
    )
  }
)
AssistantModal.displayName = "AssistantModal"
// Assistant Modal Header Component
export type AssistantModalHeaderProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantModalHeader = React.forwardRef<HTMLDivElement, AssistantModalHeaderProps>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-between border-b px-4 py-3",
          className
        )}
        {...props}
      />
    )
  }
)
AssistantModalHeader.displayName = "AssistantModalHeader"
// Assistant Modal Content Component
export type AssistantModalContentProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantModalContent = React.forwardRef<HTMLDivElement, AssistantModalContentProps>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn("flex-1 overflow-y-auto p-4", className)}
        {...props}
      />
    )
  }
)
AssistantModalContent.displayName = "AssistantModalContent"
// Assistant Modal Footer Component
export type AssistantModalFooterProps = React.HTMLAttributes<HTMLDivElement>
export const AssistantModalFooter = React.forwardRef<HTMLDivElement, AssistantModalFooterProps>(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn("border-t p-4", className)}
        {...props}
      />
    )
  }
)
AssistantModalFooter.displayName = "AssistantModalFooter"
export const Suggestions = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn("flex items-center gap-2 overflow-x-auto -mx-2 px-2 py-1", className)}
      {...props}
    />
  )
)
Suggestions.displayName = "Suggestions"
export interface SuggestionProps extends Omit<React.ButtonHTMLAttributes<HTMLButtonElement>, 'onSelect'> {
  suggestion: string
  onChoose?: (value: string) => void
}
export const Suggestion = React.forwardRef<HTMLButtonElement, SuggestionProps>(
  ({ className, suggestion, onChoose, ...props }, ref) => (
    <Button
      ref={ref}
      variant="ghost"
      size="sm"
      className={cn("rounded-full px-3 py-1.5 text-xs sm:text-sm bg-muted/50 hover:bg-muted border border-border text-foreground", className)}
      onClick={() => onChoose?.(suggestion)}
      {...props}
    >
      {suggestion}
    </Button>
  )
)
Suggestion.displayName = "Suggestion"
interface TaskContextValue {
  open: boolean
  setOpen: (v: boolean) => void
}
const TaskContext = React.createContext<TaskContextValue | null>(null)
export interface TaskProps extends React.HTMLAttributes<HTMLDivElement> {
  open?: boolean
  onOpenChange?: (v: boolean) => void
}
export const Task = React.forwardRef<HTMLDivElement, TaskProps>(
  ({ className, open = false, onOpenChange, children, ...props }, ref) => {
    const [isOpen, setIsOpen] = React.useState(open)
    React.useEffect(() => { setIsOpen(open) }, [open])
    const ctx: TaskContextValue = { open: isOpen, setOpen: (v) => { setIsOpen(v); onOpenChange?.(v) } }
    return (
      <TaskContext.Provider value={ctx}>
        <div ref={ref} className={cn("flex flex-col gap-2", className)} {...props}>{children}</div>
      </TaskContext.Provider>
    )
  }
)
Task.displayName = "Task"
export interface TaskTriggerProps extends React.ComponentProps<typeof Button> {
  title: string
  status?: "pending" | "in_progress" | "completed"
}
export const TaskTrigger = React.forwardRef<HTMLButtonElement, TaskTriggerProps>(
  ({ className, title, status, ...props }, ref) => {
    const ctx = React.useContext(TaskContext)
    return (
      <Button
        ref={ref}
        variant="ghost"
        size="sm"
        className={cn("h-6 px-2 rounded-full text-xs", className)}
        onClick={() => ctx?.setOpen?.(!ctx.open)}
        aria-expanded={ctx?.open}
        {...props}
      >
        <ChevronDown className={cn("mr-1 size-3 transition-transform", ctx?.open ? "rotate-180" : "rotate-0")} />
        <span className={cn("mr-1 inline-block size-2 rounded-full",
          status === "completed" ? "bg-green-400" : status === "in_progress" ? "bg-yellow-400" : "bg-white/40"
        )} />
        <span>{title}</span>
      </Button>
    )
  }
)
TaskTrigger.displayName = "TaskTrigger"
export const TaskContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, children, ...props }, ref) => {
    const ctx = React.useContext(TaskContext)
    return (
      <div
        ref={ref}
        className={cn(
          "overflow-hidden transition-all",
          ctx?.open ? "max-h-[320px] opacity-100" : "max-h-0 opacity-0",
          className
        )}
        {...props}
      >
        <div className="rounded-2xl bg-muted/50 text-foreground/80 text-xs p-3 border border-border max-h-[280px] overflow-y-auto">
          <div className="flex flex-col gap-2">
            {children}
          </div>
        </div>
      </div>
    )
  }
)
TaskContent.displayName = "TaskContent"
export const TaskItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("text-xs text-foreground/80", className)} {...props} />
  )
)
TaskItem.displayName = "TaskItem"
export const TaskItemFile = React.forwardRef<HTMLSpanElement, React.HTMLAttributes<HTMLSpanElement>>(
  ({ className, children, ...props }, ref) => (
    <span ref={ref} className={cn("inline-flex items-center gap-1 rounded-md border border-border bg-muted/50 px-1.5 py-0.5", className)} {...props}>
      <FileText className="size-3" />
      <span className="text-foreground/90">{children}</span>
    </span>
  )
)
TaskItemFile.displayName = "TaskItemFile"

--- FILE: components\ui\avatar.tsx ---

"use client"
import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"
import { cn } from "@/lib/utils"
function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}
function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}
function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}
export { Avatar, AvatarImage, AvatarFallback }

--- FILE: components\ui\badge.tsx ---

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"
const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)
function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"
  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}
export { Badge, badgeVariants }

--- FILE: components\ui\button.tsx ---

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"
const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)
function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"
  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}
export { Button, buttonVariants }

--- FILE: components\ui\card.tsx ---

import * as React from "react"
import { cn } from "@/lib/utils"
function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-3xl border border-slate-100/50 dark:border-slate-800 py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}
function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}
function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}
function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}
function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}
function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}
function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}
export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

--- FILE: components\ui\checkbox.tsx ---

"use client"
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"
import { cn } from "@/lib/utils"
function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="grid place-content-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}
export { Checkbox }

--- FILE: components\ui\collapsible.tsx ---

"use client"
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"
function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />
}
function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  )
}
function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  )
}
export { Collapsible, CollapsibleTrigger, CollapsibleContent }

--- FILE: components\ui\dialog.tsx ---

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"
import { cn } from "@/lib/utils"
const Dialog = DialogPrimitive.Root
const DialogTrigger = DialogPrimitive.Trigger
const DialogPortal = DialogPrimitive.Portal
const DialogClose = DialogPrimitive.Close
const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName
const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName
const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"
const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"
const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName
const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName
export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}

--- FILE: components\ui\dropdown-menu.tsx ---

"use client"
import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"
import { cn } from "@/lib/utils"
function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}
function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}
function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}
function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}
function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}
function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}
function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}
function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}
function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}
function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}
function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}
function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}
function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}
export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}

--- FILE: components\ui\fluid-orb.tsx ---

"use client"
import { motion } from "framer-motion"
export function FluidOrb() {
  return (
    <div className="relative w-64 h-64 mx-auto my-8">
      {/* Core Gradient Orb */}
      <motion.div
        className="absolute inset-0 rounded-full bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 opacity-80 blur-xl"
        animate={{
          scale: [1, 1.1, 1],
          rotate: [0, 90, 0],
          filter: ["blur(40px)", "blur(60px)", "blur(40px)"],
        }}
        transition={{
          duration: 8,
          repeat: Infinity,
          ease: "easeInOut",
        }}
      />
      {/* Inner Metallic/Glassy Sphere */}
      <motion.div
        className="absolute inset-4 rounded-full bg-gradient-to-tr from-white/40 via-white/10 to-transparent backdrop-blur-md border border-white/20 shadow-[inset_0_0_40px_rgba(255,255,255,0.5)]"
        animate={{
          y: [0, -10, 0],
        }}
        transition={{
          duration: 4,
          repeat: Infinity,
          ease: "easeInOut",
        }}
      >
        {/* Iridescent Highlights */}
        <div className="absolute top-4 left-8 w-16 h-8 rounded-full bg-white/60 blur-md rotate-[-45deg]" />
        <div className="absolute bottom-8 right-8 w-24 h-24 rounded-full bg-gradient-to-br from-blue-300/30 to-purple-300/30 blur-xl" />
      </motion.div>
      {/* Outer Glow Ring */}
      <motion.div
        className="absolute inset-[-10%] rounded-full border-2 border-white/10"
        animate={{
          rotate: [360, 0],
          scale: [1, 1.05, 1],
        }}
        transition={{
          duration: 15,
          repeat: Infinity,
          ease: "linear",
        }}
      />
    </div>
  )
}

--- FILE: components\ui\input-group.tsx ---

import * as React from "react"
import { cn } from "@/lib/utils"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Button } from "@/components/ui/button"
import type { VariantProps } from "class-variance-authority"
import type { buttonVariants } from "@/components/ui/button"
type ButtonProps = React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }
const InputGroup = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      className={cn("relative flex w-full items-center rounded-lg border border-input bg-background", className)}
      {...props}
    />
  )
})
InputGroup.displayName = "InputGroup"
interface InputGroupAddonProps extends React.HTMLAttributes<HTMLDivElement> {
  align?: "inline-start" | "inline-end" | "block-end"
}
const InputGroupAddon = React.forwardRef<
  HTMLDivElement,
  InputGroupAddonProps
>(({ className, align = "inline-start", ...props }, ref) => {
  const alignClasses = {
    "inline-start": "left-2",
    "inline-end": "right-2",
    "block-end": "bottom-2 right-2 left-2"
  }
  const positionClasses = align === "block-end"
    ? "absolute flex items-center gap-2"
    : "absolute flex items-center"
  return (
    <div
      ref={ref}
      className={cn(
        positionClasses,
        alignClasses[align],
        "z-10",
        className
      )}
      {...props}
    />
  )
})
InputGroupAddon.displayName = "InputGroupAddon"
const InputGroupInput = React.forwardRef<
  HTMLInputElement,
  React.InputHTMLAttributes<HTMLInputElement>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      className={cn(
        "border-0 focus-visible:ring-0 focus-visible:ring-offset-0 bg-transparent",
        className
      )}
      {...props}
    />
  )
})
InputGroupInput.displayName = "InputGroupInput"
const InputGroupTextarea = React.forwardRef<
  HTMLTextAreaElement,
  React.TextareaHTMLAttributes<HTMLTextAreaElement>
>(({ className, ...props }, ref) => {
  return (
    <Textarea
      ref={ref}
      className={cn(
        "min-h-[120px] resize-none border-0 focus-visible:ring-0 focus-visible:ring-offset-0 bg-transparent pb-12",
        className
      )}
      {...props}
    />
  )
})
InputGroupTextarea.displayName = "InputGroupTextarea"
const InputGroupButton = React.forwardRef<
  HTMLButtonElement,
  ButtonProps
>(({ className, ...props }, ref) => {
  return (
    <Button
      ref={ref}
      className={cn(className)}
      {...props}
    />
  )
})
InputGroupButton.displayName = "InputGroupButton"
const InputGroupText = React.forwardRef<
  HTMLSpanElement,
  React.HTMLAttributes<HTMLSpanElement>
>(({ className, ...props }, ref) => {
  return (
    <span
      ref={ref}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
InputGroupText.displayName = "InputGroupText"
export {
  InputGroup,
  InputGroupAddon,
  InputGroupInput,
  InputGroupTextarea,
  InputGroupButton,
  InputGroupText
}

--- FILE: components\ui\input.tsx ---

import * as React from "react"
import { cn } from "@/lib/utils"
export type InputProps = React.InputHTMLAttributes<HTMLInputElement>
const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"
export { Input }

--- FILE: components\ui\intro-disclosure.tsx ---

"use client"
import * as React from "react"
import Image from "next/image"
import { CheckIcon, ExternalLinkIcon } from "lucide-react"
import {
  AnimatePresence,
  motion,
  useAnimation,
  type PanInfo,
} from "motion/react"
import { cn } from "@/lib/utils"
import { AspectRatio } from "@/components/ui/aspect-ratio"
import { Button } from "@/components/ui/button"
import { Checkbox } from "@/components/ui/checkbox"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet"
import { Progress } from "@/components/ui/progress"
function useMediaQuery(query: string) {
  const [matches, setMatches] = React.useState<boolean | null>(null)
  React.useEffect(() => {
    const media = window.matchMedia(query)
    setMatches(media.matches)
    const listener = (e: MediaQueryListEvent) => setMatches(e.matches)
    media.addEventListener("change", listener)
    return () => media.removeEventListener("change", listener)
  }, [query])
  return matches ?? false
}
function useFeatureVisibility(featureId: string) {
  const [isVisible, setIsVisible] = React.useState<boolean | null>(null)
  React.useEffect(() => {
    const storedValue = localStorage.getItem(`feature_${featureId}`)
    setIsVisible(storedValue ? JSON.parse(storedValue) : true)
  }, [featureId])
  const hideFeature = () => {
    localStorage.setItem(`feature_${featureId}`, JSON.stringify(false))
    setIsVisible(false)
  }
  return { isVisible: isVisible === null ? false : isVisible, hideFeature }
}
function useSwipe(onSwipe: (direction: "left" | "right") => void) {
  const handleDragEnd = (
    event: MouseEvent | TouchEvent | PointerEvent,
    info: PanInfo
  ) => {
    if (info.offset.x > 100) {
      onSwipe("right")
    } else if (info.offset.x < -100) {
      onSwipe("left")
    }
  }
  return { handleDragEnd }
}
const fadeInScale = {
  initial: { opacity: 0, scale: 0.95 },
  animate: { opacity: 1, scale: 1 },
  exit: { opacity: 0, scale: 0.95 },
  transition: { duration: 0.2, ease: [0.23, 1, 0.32, 1] as const },
}
const slideInOut = (direction: 1 | -1) => ({
  initial: { opacity: 0, x: 20 * direction },
  animate: { opacity: 1, x: 0 },
  exit: { opacity: 0, x: -20 * direction },
  transition: { duration: 0.3, ease: [0.25, 0.1, 0.25, 1] as const },
})
const hoverScale = {
  whileHover: { scale: 1.01 },
  whileTap: { scale: 0.95 },
  transition: { duration: 0.2 },
}
function StepPreview({ step, direction }: { step: Step; direction: 1 | -1 }) {
  const controls = useAnimation()
  React.useEffect(() => {
    controls.start({
      opacity: 1,
      y: 0,
      transition: { delay: 0.2, duration: 0.3 },
    })
  }, [controls, step])
  return (
    <motion.div
      {...slideInOut(direction)}
      className="relative h-full w-full   overflow-hidden rounded-sm rounded-rb-lg rounded-tl-xl ring-2 ring-black/10 dark:ring-black/10 dark:ring-offset-black ring-offset-8"
    >
      {step.media ? (
        <div className="relative bg-black h-full w-full">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={controls}
            className="h-full w-full max-h-[700px]"
          >
            {step.media.type === "image" ? (
              <Image
                src={step.media.src || "/placeholder.svg"}
                alt={step.media.alt || ""}
                fill
                className="object-cover"
              />
            ) : (
              <video
                src={step.media.src}
                autoPlay
                muted
                loop
                playsInline
                className="h-full w-full object-cover"
              />
            )}
          </motion.div>
          <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent" />
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={controls}
            className="absolute bottom-0 left-0 right-0 p-6"
          >
            <h3 className="mb-2 text-2xl font-semibold text-white">
              {step.title}
            </h3>
            <p className="text-white hidden md:block">
              {step.full_description}
            </p>
          </motion.div>
        </div>
      ) : (
        <div className="flex h-full items-center justify-center p-6">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={controls}
            className="text-center"
          >
            <h3 className="mb-2 text-2xl font-semibold text-primary">
              {step.title}
            </h3>
            <p className="text-muted-foreground">{step.full_description}</p>
          </motion.div>
        </div>
      )}
    </motion.div>
  )
}
interface StepTabProps {
  step: Step
  isActive: boolean
  onClick: () => void
  isCompleted: boolean
}
function StepTab({ step, isActive, onClick, isCompleted }: StepTabProps) {
  return (
    <motion.button
      {...hoverScale}
      onClick={onClick}
      className={cn(
        "flex flex-col items-start rounded-lg px-4 py-2 text-left transition-colors w-full",
        isActive ? "bg-muted border border-border" : "hover:bg-muted/70",
        "relative"
      )}
      aria-current={isActive ? "step" : undefined}
      aria-label={`${step.title}${isCompleted ? " (completed)" : ""}`}
    >
      <div className="mb-1 text-sm font-medium">{step.title}</div>
      <div className="text-xs hidden md:block text-muted-foreground line-clamp-2">
        {step.short_description}
      </div>
      {isCompleted && (
        <motion.div {...fadeInScale} className="absolute right-2 top-2">
          <div className="rounded-full bg-primary p-1">
            <CheckIcon className="w-2 h-2 text-primary-foreground" />
          </div>
        </motion.div>
      )}
    </motion.button>
  )
}
interface Step {
  title: string
  short_description: string
  full_description: string
  action?: {
    label: string
    onClick?: () => void
    href?: string
  }
  media?: {
    type: "image" | "video"
    src: string
    alt?: string
  }
}
interface FeatureDisclosureProps {
  steps: Step[]
  featureId: string
  onComplete?: () => void
  onSkip?: () => void
  showProgressBar?: boolean
  open: boolean
  setOpen: (open: boolean) => void
  forceVariant?: "mobile" | "desktop"
}
interface StepContentProps {
  steps: Step[]
  currentStep: number
  onSkip: () => void
  onNext: () => void
  onPrevious: () => void
  hideFeature: () => void
  completedSteps: number[]
  onStepSelect: (index: number) => void
  direction: 1 | -1
  isDesktop: boolean
}
function StepContent({
  steps,
  currentStep,
  onSkip,
  onNext,
  onPrevious,
  hideFeature,
  completedSteps,
  onStepSelect,
  direction,
  isDesktop,
  stepRef,
}: StepContentProps & { stepRef: React.RefObject<HTMLButtonElement | null> }) {
  const [skipNextTime, setSkipNextTime] = React.useState(false)
  const renderActionButton = (action: Step["action"]) => {
    if (!action) return null
    if (action.href) {
      return (
        <Button asChild className="w-full " size="sm" variant="link">
          <a href={action.href} target="_blank" rel="noopener noreferrer">
            <span className="flex items-center gap-2">
              {action.label}
              <ExternalLinkIcon className="w-4 h-4" />
            </span>
          </a>
        </Button>
      )
    }
    return (
      <Button
        className="w-full rounded-full"
        size="sm"
        variant="secondary"
        onClick={action.onClick}
      >
        {action.label}
      </Button>
    )
  }
  return (
    <div className="flex h-full flex-col max-w-3xl mx-auto">
      {isDesktop && (
        <div className="flex-1  px-2 py-3">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5, ease: [0.25, 0.1, 0.25, 1] }}
            className="space-y-2 flex flex-col justify-center items-center px-1"
          >
            {steps.map((step, index) => (
              <StepTab
                key={index}
                step={step}
                isActive={currentStep === index}
                onClick={() => onStepSelect(index)}
                isCompleted={completedSteps.includes(index)}
              />
            ))}
          </motion.div>
        </div>
      )}
      <AnimatePresence mode="wait" initial={false}>
        <motion.div
          key={currentStep}
          {...slideInOut(direction)}
          className="mt-6 space-y-4 "
        >
          {!isDesktop && steps[currentStep]?.media && (
            <AspectRatio
              ratio={16 / 9}
              className="lg:overflow-hidden rounded-lg bg-muted "
            >
              {steps[currentStep]?.media?.type === "image" ? (
                <Image
                  src={steps[currentStep]?.media?.src || "/placeholder.svg"}
                  alt={steps[currentStep]?.media?.alt || ""}
                  fill
                  className="object-cover "
                />
              ) : (
                <video
                  src={steps[currentStep]?.media?.src}
                  autoPlay
                  muted
                  loop
                  playsInline
                  className="h-full w-full object-cover"
                />
              )}
            </AspectRatio>
          )}
          {steps[currentStep]?.action ? (
            <div className=" px-2">
              {renderActionButton(steps[currentStep]?.action)}
            </div>
          ) : (
            <div className="h-10" />
          )}
          {/* Navigation buttons */}
          <div className="flex items-center justify-between pr-4">
            <Button
              variant="ghost"
              onClick={onSkip}
              className="text-muted-foreground hover:bg-card rounded-full"
            >
              Skip all
            </Button>
            <div className="space-x-2">
              {currentStep > 0 && (
                <Button
                  onClick={onPrevious}
                  size="sm"
                  variant="ghost"
                  className="rounded-full hover:bg-transparent"
                >
                  Previous
                </Button>
              )}
              <Button
                onClick={() => {
                  if (skipNextTime) {
                    hideFeature()
                  }
                  onNext()
                }}
                size="sm"
                ref={stepRef}
                className="rounded-full"
              >
                {currentStep === steps.length - 1 ? "Done" : "Next"}
              </Button>
            </div>
            {/* Don't show again checkbox */}
          </div>
          <div className="flex items-center space-x-2 pb-4 px-4">
            <Checkbox
              id="skipNextTime"
              checked={skipNextTime}
              onCheckedChange={(checked) => setSkipNextTime(checked as boolean)}
            />
            <label
              htmlFor="skipNextTime"
              className="text-sm text-muted-foreground"
            >
              Don't show this again
            </label>
          </div>
        </motion.div>
      </AnimatePresence>
    </div>
  )
}
export function IntroDisclosure({
  steps,
  open,
  setOpen,
  featureId,
  onComplete,
  onSkip,
  showProgressBar = true,
  forceVariant,
}: FeatureDisclosureProps) {
  const [currentStep, setCurrentStep] = React.useState(0)
  const [completedSteps, setCompletedSteps] = React.useState<number[]>([0])
  const [direction, setDirection] = React.useState<1 | -1>(1)
  const isDesktopQuery = useMediaQuery("(min-width: 768px)")
  const isDesktop = forceVariant ? forceVariant === "desktop" : isDesktopQuery
  const { isVisible, hideFeature } = useFeatureVisibility(featureId)
  const stepRef = React.useRef<HTMLButtonElement>(null)
  // Close the dialog if feature is hidden or open is false
  React.useEffect(() => {
    if (!isVisible) {
      setOpen(false)
    }
  }, [isVisible, setOpen])
  // Don't render anything if not visible or closed
  if (!isVisible || !open) {
    return null
  }
  // Prevent showing desktop tour on mobile if not forced
  if (!isDesktop && !forceVariant) {
    return null
  }
  const handleNext = () => {
    setDirection(1)
    setCompletedSteps((prev) =>
      prev.includes(currentStep) ? prev : [...prev, currentStep]
    )
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1)
    } else {
      setOpen(false)
      onComplete?.()
    }
  }
  const handlePrevious = () => {
    setDirection(-1)
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1)
    }
  }
  const handleSkip = () => {
    setOpen(false)
    onSkip?.()
  }
  const handleStepSelect = (index: number) => {
    setDirection(index > currentStep ? 1 : -1)
    // Mark all steps up to and including the selected step as completed
    setCompletedSteps((prev) => {
      const newCompletedSteps = new Set(prev)
      // If moving forward, mark all steps up to the selected one as completed
      if (index > currentStep) {
        for (let i = currentStep; i <= index; i++) {
          newCompletedSteps.add(i)
        }
      }
      return Array.from(newCompletedSteps)
    })
    setCurrentStep(index)
  }
  const handleSwipe = (swipeDirection: "left" | "right") => {
    if (swipeDirection === "left") {
      handleNext()
    } else {
      handlePrevious()
    }
  }
  const handleKeyDown = (event: React.KeyboardEvent) => {
    if (event.key === "ArrowRight" || event.key === "ArrowDown") {
      handleNext()
    } else if (event.key === "ArrowLeft" || event.key === "ArrowUp") {
      handlePrevious()
    }
  }
  const { handleDragEnd } = useSwipe(handleSwipe)
  if (isDesktop) {
    return (
      <Dialog open={open} onOpenChange={setOpen}>
        <DialogContent
          className="max-w-5xl p-0 gap-0 overflow-hidden "
          onKeyDown={handleKeyDown}
        >
          <DialogHeader className="p-6 space-y-2 bg-muted border-b border-border">
            <DialogTitle>Feature Tour</DialogTitle>
            {showProgressBar && (
              <div className="flex mt-2 w-full justify-center  ">
                <Progress
                  value={((currentStep + 1) / steps.length) * 100}
                  className="  h-1 "
                />
              </div>
            )}
          </DialogHeader>
          <div className="grid grid-cols-2 h-full">
            <div className="p-2 pr-[18px] ">
              <StepContent
                steps={steps}
                currentStep={currentStep}
                onSkip={handleSkip}
                onNext={handleNext}
                onPrevious={handlePrevious}
                hideFeature={hideFeature}
                completedSteps={completedSteps}
                onStepSelect={handleStepSelect}
                direction={direction}
                isDesktop={isDesktop}
                stepRef={stepRef}
              />
            </div>
            <AnimatePresence mode="wait" initial={false}>
              <StepPreview
                key={currentStep}
                step={steps[currentStep]}
                direction={direction}
              />
            </AnimatePresence>
          </div>
        </DialogContent>
      </Dialog>
    )
  }
  return (
    <Sheet open={open} onOpenChange={setOpen}>
      <SheetContent side="bottom" className="h-[95vh] max-h-[95vh] p-0">
        <motion.div
          drag="x"
          dragConstraints={{ left: 0, right: 0 }}
          onDragEnd={handleDragEnd}
          onKeyDown={handleKeyDown}
          className="h-full flex flex-col max-w-3xl mx-auto"
        >
          <SheetHeader className="text-left p-4 pb-0 space-y-4">
            {showProgressBar && (
              <Progress
                value={((currentStep + 1) / steps.length) * 100}
                className="mb-4"
              />
            )}
            <SheetTitle>{steps[currentStep]?.title}</SheetTitle>
          </SheetHeader>
          <div className="flex-1 overflow-y-auto">
            <div className="p-4 space-y-4 pb-32">
              {/* Step tabs */}
              <div className="grid grid-cols-2 gap-2 mb-6">
                {steps.map((step, index) => (
                  <StepTab
                    key={index}
                    step={step}
                    isActive={currentStep === index}
                    onClick={() => handleStepSelect(index)}
                    isCompleted={completedSteps.includes(index)}
                  />
                ))}
              </div>
              {/* Preview */}
              <div className="relative aspect-[16/9] ring-2 ring-border ring-offset-8 ring-offset-background rounded-lg overflow-hidden">
                <StepPreview step={steps[currentStep]} direction={direction} />
              </div>
              {/* Step content */}
              <div className="space-y-4 border border-border p-3 rounded-lg">
                <p className="text-muted-foreground">
                  {steps[currentStep]?.short_description}
                </p>
                {steps[currentStep]?.action && (
                  <Button
                    asChild
                    className="w-full"
                    variant={
                      steps[currentStep]?.action?.href ? "outline" : "default"
                    }
                  >
                    {steps[currentStep]?.action?.href ? (
                      <a
                        href={steps[currentStep]?.action?.href}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center justify-center gap-2"
                      >
                        {steps[currentStep]?.action?.label}
                        <ExternalLinkIcon className="h-4 w-4" />
                      </a>
                    ) : (
                      <button onClick={steps[currentStep]?.action?.onClick}>
                        {steps[currentStep]?.action?.label}
                      </button>
                    )}
                  </Button>
                )}
              </div>
            </div>
          </div>
          {/* Fixed bottom navigation */}
          <div className="absolute bottom-0 left-0 right-0 border-t bg-background">
            <div className="p-4">
              <div className="flex items-center justify-between mb-4">
                <Button
                  variant="ghost"
                  onClick={onSkip}
                  className="text-muted-foreground hover:bg-card rounded-full"
                >
                  Skip all
                </Button>
                <div className="space-x-2">
                  {currentStep > 0 && (
                    <Button
                      onClick={handlePrevious}
                      size="sm"
                      variant="ghost"
                      className="rounded-full hover:bg-transparent"
                    >
                      Previous
                    </Button>
                  )}
                  <Button
                    onClick={() => {
                      handleNext()
                    }}
                    size="sm"
                    ref={stepRef}
                    className="rounded-full"
                  >
                    {currentStep === steps.length - 1 ? "Done" : "Next"}
                  </Button>
                </div>
              </div>
              <div className="flex items-center space-x-2">
                <Checkbox
                  id="skipNextTime"
                  onCheckedChange={(checked) => {
                    hideFeature()
                  }}
                />
                <label
                  htmlFor="skipNextTime"
                  className="text-sm text-muted-foreground"
                >
                  Don't show this again
                </label>
              </div>
            </div>
          </div>
        </motion.div>
      </SheetContent>
    </Sheet>
  )
}
export default IntroDisclosure

--- FILE: components\ui\label.tsx ---

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"
const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)
const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName
export { Label }

--- FILE: components\ui\popover.tsx ---

"use client"
import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"
import { cn } from "@/lib/utils"
function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />
}
function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />
}
function PopoverContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  )
}
function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />
}
export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }

--- FILE: components\ui\progress.tsx ---

"use client"
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"
import { cn } from "@/lib/utils"
const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-2 w-full overflow-hidden rounded-full bg-primary/20",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName
export { Progress }

--- FILE: components\ui\scroll-area.tsx ---

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
import { cn } from "@/lib/utils"
const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName
const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName
export { ScrollArea, ScrollBar }

--- FILE: components\ui\select.tsx ---

"use client"
import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"
import { cn } from "@/lib/utils"
const Select = SelectPrimitive.Root
const SelectGroup = SelectPrimitive.Group
const SelectValue = SelectPrimitive.Value
const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName
const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName
const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName
const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName
const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName
const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName
const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName
export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}

--- FILE: components\ui\separator.tsx ---

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"
import { cn } from "@/lib/utils"
const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName
export { Separator }

--- FILE: components\ui\sheet.tsx ---

"use client"
import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"
import { cn } from "@/lib/utils"
const Sheet = SheetPrimitive.Root
const SheetTrigger = SheetPrimitive.Trigger
const SheetClose = SheetPrimitive.Close
const SheetPortal = SheetPrimitive.Portal
const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName
const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)
interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}
const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName
const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"
const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"
const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName
const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName
export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}

--- FILE: components\ui\split-text.tsx ---

"use client";
import React, { useMemo, useRef } from "react";
import gsap from "gsap";
import { useGSAP } from "@gsap/react";
type SplitType = "chars" | "words" | "lines" | "words, chars";
export interface SplitTextProps {
  tag?: React.ElementType;
  text?: string;
  className?: string;
  delay?: number; // ms between letters
  duration?: number; // seconds
  ease?: string; // gsap ease name
  splitType?: SplitType;
  from?: gsap.TweenVars; // initial state
  to?: gsap.TweenVars; // target state
  textAlign?: React.CSSProperties["textAlign"];
}
// Simple GSAP-based SplitText implementation (client-side only)
export function SplitText({
  tag = "p",
  text = "",
  className = "",
  delay = 100,
  duration = 0.6,
  ease = "power3.out",
  splitType = "chars",
  from = { opacity: 0, y: 40 },
  to = { opacity: 1, y: 0 },
  textAlign = "center",
}: SplitTextProps) {
  const containerRef = useRef<HTMLDivElement | null>(null);
  const parts = useMemo(() => {
    if (splitType === "words" || splitType === "words, chars") {
      return text.split(/(\s+)/);
    }
    // default: chars
    return Array.from(text);
  }, [text, splitType]);
  useGSAP(() => {
    const el = containerRef.current;
    if (!el) return;
    const targets = el.querySelectorAll<HTMLElement>("[data-split]");
    gsap.set(targets, from);
    gsap.to(targets, {
      ...to,
      ease,
      duration,
      stagger: delay / 1000, // delay ms -> s
    });
  }, { scope: containerRef });
  const Tag = tag;
  return (
    <div ref={containerRef} style={{ textAlign }}>
      <Tag className={className}>
        {parts.map((p, i) => (
          <span
            key={i}
            data-split
            style={{ display: "inline-block", whiteSpace: p.match(/\s+/) ? "pre" : "normal" }}
          >
            {p}
          </span>
        ))}
      </Tag>
    </div>
  );
}
export default SplitText;

--- FILE: components\ui\switch.tsx ---

"use client"
import * as React from "react"
import * as SwitchPrimitive from "@radix-ui/react-switch"
import { cn } from "@/lib/utils"
function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
        )}
      />
    </SwitchPrimitive.Root>
  )
}
export { Switch }

--- FILE: components\ui\table.tsx ---

import * as React from "react"
import { cn } from "@/lib/utils"
const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"
const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"
const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"
const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"
const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"
const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"
const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"
const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"
export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

--- FILE: components\ui\tabs.tsx ---

"use client"
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cn } from "@/lib/utils"
const Tabs = TabsPrimitive.Root
const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName
const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName
const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName
export { Tabs, TabsList, TabsTrigger, TabsContent }

--- FILE: components\ui\text-pressure.tsx ---

"use client";
import React from "react";
import gsap from "gsap";
interface TextPressureProps {
  text: string;
  className?: string;
  flex?: boolean; // if true, characters spaced using flex
  scale?: boolean; // vertical scale
  alpha?: boolean; // opacity based on cursor distance
  stroke?: boolean; // outline stroke
  textColor?: string;
  strokeColor?: string;
  minFontSize?: number; // px
}
// A lightweight replication of React Bits "Text Pressure" using GSAP.
// It does not require variable font axes; instead it simulates width/weight via
// transform and letter-spacing based on pointer proximity.
const TextPressure: React.FC<TextPressureProps> = ({
  text,
  className = "",
  flex = true,
  scale = false,
  alpha = true,
  stroke = false,
  textColor = "#0C1421",
  strokeColor = "#FFFFFF",
  minFontSize = 24,
}) => {
  const containerRef = React.useRef<HTMLDivElement | null>(null);
  const spansRef = React.useRef<HTMLSpanElement[]>([]);
  React.useEffect(() => {
    const el = containerRef.current;
    if (!el) return;
    const onMove = (e: MouseEvent) => {
      const rect = el.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      spansRef.current.forEach((span) => {
        const sRect = span.getBoundingClientRect();
        const sx = sRect.left - rect.left + sRect.width / 2;
        const sy = sRect.top - rect.top + sRect.height / 2;
        const dx = x - sx;
        const dy = y - sy;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const max = Math.max(rect.width, rect.height);
        const t = Math.max(0, 1 - dist / (max * 0.5)); // 0..1
        // Simulate width/weight via transform
        const scaleX = 1 + t * 0.35; // widen
        const scaleY = scale ? 1 + t * 0.15 : 1; // optional vertical scale
        const letterSpace = (1 - t) * 0.5; // px
        const opacity = alpha ? 0.6 + t * 0.4 : 1;
        gsap.to(span, {
          duration: 0.2,
          ease: "power3.out",
          opacity,
          letterSpacing: `${letterSpace}px`,
          transform: `scale(${scaleX}, ${scaleY})`,
        });
      });
    };
    const onLeave = () => {
      spansRef.current.forEach((span) => {
        gsap.to(span, {
          duration: 0.3,
          ease: "power3.out",
          opacity: 1,
          letterSpacing: "0px",
          transform: "scale(1,1)",
        });
      });
    };
    el.addEventListener("mousemove", onMove);
    el.addEventListener("mouseleave", onLeave);
    return () => {
      el.removeEventListener("mousemove", onMove);
      el.removeEventListener("mouseleave", onLeave);
    };
  }, [alpha, scale]);
  return (
    <div
      ref={containerRef}
      className={className}
      style={{
        display: flex ? "flex" : "inline-block",
        justifyContent: "center",
        gap: flex ? 4 : undefined,
        color: textColor,
        WebkitTextStroke: stroke ? `1px ${strokeColor}` : undefined,
        fontSize: minFontSize,
        lineHeight: 1,
      }}
    >
      {Array.from(text).map((ch, i) => (
        <span
          key={i}
          ref={(el) => { if (el) spansRef.current[i] = el; }}
          style={{ display: "inline-block" }}
        >
          {ch}
        </span>
      ))}
    </div>
  );
};
export default TextPressure;

--- FILE: components\ui\textarea.tsx ---

import * as React from "react"
import { cn } from "@/lib/utils"
export type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>
const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"
export { Textarea }

--- FILE: components\ui\tooltip.tsx ---

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"
import { cn } from "@/lib/utils"
const TooltipProvider = TooltipPrimitive.Provider
const Tooltip = TooltipPrimitive.Root
const TooltipTrigger = TooltipPrimitive.Trigger
const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName
export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }

--- FILE: components\ui\turnstile-widget.tsx ---

"use client";
import { useEffect, useRef, useState } from "react";
import Script from "next/script";
interface TurnstileWidgetProps {
  onVerify: (token: string) => void;
  onError?: () => void;
  onExpire?: () => void;
  theme?: "light" | "dark" | "auto";
}
declare global {
  interface Window {
    turnstile?: {
      render: (
        element: HTMLElement | string,
        options: {
          sitekey: string;
          callback: (token: string) => void;
          "error-callback"?: () => void;
          "expired-callback"?: () => void;
          theme?: "light" | "dark" | "auto";
        }
      ) => string;
      reset: (widgetId: string) => void;
    };
    onloadTurnstileCallback?: () => void;
  }
}
export default function TurnstileWidget({
  onVerify,
  onError,
  onExpire,
  theme = "auto",
}: TurnstileWidgetProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [widgetId, setWidgetId] = useState<string | null>(null);
  useEffect(() => {
    // If turnstile is already loaded and we have the container
    if (window.turnstile && containerRef.current && !widgetId) {
      const id = window.turnstile.render(containerRef.current, {
        sitekey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "",
        callback: (token) => onVerify(token),
        "error-callback": onError,
        "expired-callback": onExpire,
        theme,
      });
      setWidgetId(id);
    }
    // Define the callback for when the script loads
    window.onloadTurnstileCallback = () => {
      if (containerRef.current && !widgetId) {
        const id = window.turnstile?.render(containerRef.current, {
          sitekey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "",
          callback: (token) => onVerify(token),
          "error-callback": onError,
          "expired-callback": onExpire,
          theme,
        }) || null;
        setWidgetId(id);
      }
    };
    return () => {
      // Cleanup if needed (Turnstile usually handles this, but good practice)
      if (widgetId && window.turnstile) {
        // window.turnstile.remove(widgetId); // API might differ, reset is common
      }
      window.onloadTurnstileCallback = undefined;
    };
  }, [onVerify, onError, onExpire, theme, widgetId]);
  return (
    <div className="w-full flex justify-center my-4">
      <Script
        src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback"
        strategy="lazyOnload"
      />
      <div ref={containerRef} />
    </div>
  );
}

--- FILE: components\update-announcement.tsx ---

"use client"
import { useEffect, useState } from "react"
import {
  Dialog,
  DialogContent,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import {
  Rocket,
  Sparkles,
  Zap,
  ShieldCheck,
  Layout,
  Clock,
  Bell,
  Link as LinkIcon,
  History,
  Smartphone
} from "lucide-react"
import Image from "next/image"
const ANNOUNCEMENT_VERSION = "update-announcement-v2.2"
const HIDE_KEY = `hide-${ANNOUNCEMENT_VERSION}`
export function UpdateAnnouncement() {
  const [open, setOpen] = useState(false)
  const [dontShowAgain, setDontShowAgain] = useState(false)
  useEffect(() => {
    // Check if the user has chosen not to see this specific version
    const shouldHide = localStorage.getItem(HIDE_KEY)
    // If not hidden, show after a delay
    if (!shouldHide) {
      const timer = setTimeout(() => {
        setOpen(true)
      }, 1500)
      return () => clearTimeout(timer)
    }
  }, [])
  const handleClose = () => {
    setOpen(false)
    if (dontShowAgain) {
      localStorage.setItem(HIDE_KEY, "true")
    }
  }
  return (
    <Dialog open={open} onOpenChange={(isOpen) => {
      if (!isOpen) handleClose()
      else setOpen(true)
    }}>
      <DialogContent className="sm:max-w-[900px] p-0 border-none shadow-2xl bg-white dark:bg-slate-900 max-h-[85vh] md:max-h-none overflow-y-auto md:overflow-visible">
        <div className="grid grid-cols-1 md:grid-cols-2 md:min-h-[500px]">
          {/* Mobile Image (Visible only on small screens) */}
          <div className="relative w-full h-48 md:hidden bg-slate-50 dark:bg-slate-800/50 flex items-center justify-center overflow-hidden shrink-0">
             <div className="absolute inset-0 overflow-hidden">
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] bg-gradient-to-tr from-blue-50/50 to-purple-50/50 dark:from-blue-900/10 dark:to-purple-900/10 rounded-full blur-3xl" />
             </div>
             <div className="relative z-10 h-full w-full p-6">
                <div className="relative w-full h-full">
                  <Image
                    src="/announcement.svg"
                    alt="Update Illustration"
                    fill
                    className="object-contain drop-shadow-xl"
                  />
                </div>
             </div>
          </div>
          {/* Left Column: Content */}
          <div className="p-6 md:p-12 flex flex-col justify-center relative z-10 bg-white dark:bg-slate-900">
            <h2 className="text-2xl md:text-3xl font-bold tracking-tight text-slate-900 dark:text-white mb-4">
              2.1.0 Updates
            </h2>
            <p className="text-sm md:text-base text-slate-500 dark:text-slate-400 mb-8 leading-relaxed">
              本次更新主要集中在支付与登录系统的优化，修复了移动端体验问题，提升了云服务的兼容性。
            </p>
            <div className="space-y-6 mb-8">
              <h3 className="font-bold text-slate-900 dark:text-white text-sm uppercase tracking-wider">
                What's New:
              </h3>
              <div className="space-y-5">
                <div className="flex items-start gap-4">
                  <div className="mt-0.5 w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center flex-shrink-0">
                    <Smartphone className="w-4 h-4 text-blue-600 dark:text-blue-400" />
                  </div>
                  <p className="text-sm text-slate-600 dark:text-slate-300 leading-snug pt-1">
                    <span className="font-semibold text-slate-900 dark:text-white">移动端支付宝登录优化</span>
                    <br />修复 APP 唤起失败问题，新增跨端自动登录支持，体验更流畅。
                  </p>
                </div>
                <div className="flex items-start gap-4">
                  <div className="mt-0.5 w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
                    <ShieldCheck className="w-4 h-4 text-green-600 dark:text-green-400" />
                  </div>
                  <p className="text-sm text-slate-600 dark:text-slate-300 leading-snug pt-1">
                    <span className="font-semibold text-slate-900 dark:text-white">账号系统升级</span>
                    <br />全面支持支付宝 OpenID，解决了用户 ID 识别错误的问题，登录更稳定。
                  </p>
                </div>
                <div className="flex items-start gap-4">
                  <div className="mt-0.5 w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                    <Zap className="w-4 h-4 text-purple-600 dark:text-purple-400" />
                  </div>
                  <p className="text-sm text-slate-600 dark:text-slate-300 leading-snug pt-1">
                    <span className="font-semibold text-slate-900 dark:text-white">云服务兼容性修复</span>
                    <br />修复了容器环境下重定向地址异常（0.0.0.0）的问题。
                  </p>
                </div>
                <div className="flex items-start gap-4">
                  <div className="mt-0.5 w-8 h-8 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center flex-shrink-0">
                    <Sparkles className="w-4 h-4 text-yellow-600 dark:text-yellow-400" />
                  </div>
                  <p className="text-sm text-slate-600 dark:text-slate-300 leading-snug pt-1">
                    <span className="font-semibold text-slate-900 dark:text-white">UI 视觉更新</span>
                    <br />更新了登录页面的支付宝图标，视觉效果更统一。
                  </p>
                </div>
              </div>
            </div>
            <div className="flex flex-col md:flex-row items-center gap-4">
              <Button
                onClick={handleClose}
                className="w-full md:w-fit rounded-full px-8 py-6 bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/20 text-base"
              >
                Read More
              </Button>
              <div className="flex items-center space-x-2">
                <Checkbox
                  id="dont-show"
                  checked={dontShowAgain}
                  onCheckedChange={(checked) => setDontShowAgain(checked as boolean)}
                />
                <Label
                  htmlFor="dont-show"
                  className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-slate-500 dark:text-slate-400"
                >
                  不再显示此版本更新公告
                </Label>
              </div>
            </div>
          </div>
          {/* Right Column: Illustration (Desktop) */}
          <div className="relative hidden md:flex items-center justify-center bg-slate-50 dark:bg-slate-800/50 p-8">
            {/* Abstract Background Shapes */}
            <div className="absolute inset-0 overflow-hidden">
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] bg-gradient-to-tr from-blue-50/50 to-purple-50/50 dark:from-blue-900/10 dark:to-purple-900/10 rounded-full blur-3xl" />
            </div>
            {/* Main Illustration Placeholder */}
            <div className="relative z-10 w-full max-w-sm aspect-square flex items-center justify-center">
               <div className="relative w-full h-full">
                  <Image
                    src="/announcement.svg"
                    alt="Update Illustration"
                    fill
                    className="object-contain drop-shadow-xl"
                  />
               </div>
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  )
}

--- FILE: components\user-avatar-menu.tsx ---

"use client"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { UserPublic } from "@/lib/db/user-service"
import { UserIcon, ArrowRightOnRectangleIcon, Cog6ToothIcon } from "@heroicons/react/24/outline"
import { useRouter } from "next/navigation"
import { useState } from "react"
interface UserAvatarMenuProps {
  user: UserPublic
}
/**
 * 获取用户名首字母作为头像 fallback
 */
function getInitials(username: string): string {
  if (!username) return "U"
  // 如果是中文名,取第一个字
  if (/[\u4e00-\u9fa5]/.test(username)) {
    return username.charAt(0)
  }
  // 如果是英文名,取首字母
  const parts = username.trim().split(/\s+/)
  if (parts.length >= 2) {
    return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase()
  }
  return username.charAt(0).toUpperCase()
}
export function UserAvatarMenu({ user }: UserAvatarMenuProps) {
  const router = useRouter()
  const [isLoggingOut, setIsLoggingOut] = useState(false)
  const handleLogout = async () => {
    if (isLoggingOut) return
    setIsLoggingOut(true)
    try {
      const response = await fetch("/api/auth/logout", {
        method: "POST",
      })
      if (response.ok) {
        // 重定向到登录页面
        router.push("/login")
      } else {
        console.error("登出失败")
        setIsLoggingOut(false)
      }
    } catch (error) {
      console.error("登出请求失败:", error)
      setIsLoggingOut(false)
    }
  }
  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <button id="user-menu-trigger" className="flex items-center gap-2 hover:opacity-80 transition-opacity focus:outline-none">
          <Avatar className="size-9 border-2 border-white/20 cursor-pointer hover:border-white/40 transition-colors">
            <AvatarImage src={user.avatar_url || undefined} alt={user.username} />
            <AvatarFallback className="bg-gradient-to-br from-blue-500 to-purple-600 text-white font-semibold">
              {getInitials(user.username)}
            </AvatarFallback>
          </Avatar>
          <span className="text-sm text-foreground/90 font-medium hidden sm:inline">
            {user.username}
          </span>
        </button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56 bg-popover border-border text-popover-foreground">
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium leading-none">{user.username}</p>
            <p className="text-xs leading-none text-muted-foreground">{user.email}</p>
          </div>
        </DropdownMenuLabel>
        <DropdownMenuSeparator className="bg-border" />
        <DropdownMenuItem
          className="cursor-pointer focus:bg-accent focus:text-accent-foreground"
          onClick={() => router.push("/profile")}
        >
          <UserIcon className="mr-2 size-4" />
          <span>个人中心</span>
        </DropdownMenuItem>
        <DropdownMenuItem
          className="cursor-pointer focus:bg-accent focus:text-accent-foreground"
          onClick={() => router.push("/settings")}
        >
          <Cog6ToothIcon className="mr-2 size-4" />
          <span>个人设置</span>
        </DropdownMenuItem>
        <DropdownMenuItem
          className="cursor-pointer focus:bg-accent focus:text-accent-foreground text-red-500 focus:text-red-500"
          onClick={handleLogout}
          disabled={isLoggingOut}
        >
          <ArrowRightOnRectangleIcon className="mr-2 size-4" />
          <span>{isLoggingOut ? "登出中..." : "登出"}</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}

--- FILE: components\vega-chart.tsx ---

"use client"
import React, { useEffect, useRef } from 'react'
import embed from 'vega-embed'
interface VegaChartProps {
  spec: any
}
export default function VegaChart({ spec }: VegaChartProps) {
  const containerRef = useRef<HTMLDivElement>(null)
  useEffect(() => {
    if (containerRef.current && spec) {
      // Clone spec to avoid mutation issues
      const specClone = JSON.parse(JSON.stringify(spec))
      // Ensure schema is correct for vega-lite
      if (!specClone.$schema) {
        specClone.$schema = "https://vega.github.io/schema/vega-lite/v5.json"
      }
      // Embed the chart
      embed(containerRef.current, specClone, {
        mode: 'vega-lite',
        actions: false, // Hide "Open in Vega Editor" actions
        renderer: 'svg' // Use SVG for better scaling
      }).catch(err => {
        console.error('Vega Embed Error:', err)
      })
    }
  }, [spec])
  return <div ref={containerRef} className="w-full h-full flex items-center justify-center" />
}

--- FILE: components\weather-card.tsx ---

"use client"
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import {
  Cloud,
  CloudRain,
  CloudSnow,
  Sun,
  CloudDrizzle,
  Wind,
  Droplets,
  Gauge,
  Eye,
} from "lucide-react"
import { motion } from "framer-motion"
import { useWeatherContext } from "@/lib/contexts/weather-context"
import { usePlantGrowth } from "@/lib/hooks/use-plant-growth"
interface DeviceData {
  temperature: number
  humidity: number
  light: number
  co2: number
  earth_temp: number
  earth_water: number
  earth_ec: number
  earth_n: number
  earth_p: number
  earth_k: number
  relay5: number
  relay6: number
  relay7: number
  relay8: number
  led1: number
  led2: number
  led3: number
  led4: number
  timestamp?: number
}
interface WeatherCardProps {
  deviceData?: DeviceData | null
}
const weatherIcons = {
  sun: Sun,
  cloud: Cloud,
  rain: CloudRain,
  snow: CloudSnow,
}
export function WeatherCard({ deviceData }: WeatherCardProps) {
  const { weatherData, loading, error, locationSource, requestLocation } = useWeatherContext()
  const { plantData } = usePlantGrowth()
  // Map weather condition codes to our icon types
  const getWeatherIcon = (code: number): "sun" | "cloud" | "rain" | "snow" => {
    // WeatherAPI.com condition codes
    if (code === 1000) return 'sun' // Sunny/Clear
    if ([1003, 1006, 1009].includes(code)) return 'cloud' // Cloudy
    if ([1063, 1180, 1183, 1186, 1189, 1192, 1195, 1240, 1243, 1246].includes(code)) return 'rain' // Rain
    if ([1066, 1114, 1210, 1213, 1216, 1219, 1222, 1225, 1255, 1258].includes(code)) return 'snow' // Snow
    return 'cloud'
  }
  // Get forecast data from API or use defaults
  const forecast = weatherData?.forecast?.forecastday?.slice(0, 7).map((day, index) => ({
    date: index === 0 ? '今天' : index === 1 ? '明天' : new Date(day.date).toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }),
    icon: getWeatherIcon(day.day.condition.code),
    temp: Math.round(day.day.avgtemp_c),
    humidity: day.day.avghumidity
  })) || []
  // Temperature curve data
  const tempData = forecast.map(f => f.temp)
  const maxTemp = tempData.length > 0 ? Math.max(...tempData) : 25
  const minTemp = tempData.length > 0 ? Math.min(...tempData) : 15
  return (
    <div className="space-y-4">
      {/* 标题 */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-bold text-foreground flex items-center gap-2">
          环境多维感知数据
          <span className="text-muted-foreground">›</span>
        </h3>
      </div>
      {/* 当前环境数据 */}
      <div className="grid grid-cols-2 gap-3">
        <motion.div
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          className="p-4 rounded-xl bg-gradient-to-br from-orange-500/10 to-orange-600/5 dark:from-orange-500/20 dark:to-orange-600/10 border border-orange-500/20"
        >
          <div className="text-orange-700/70 dark:text-orange-200/70 text-sm mb-1">温度</div>
          <div className="text-3xl font-bold text-orange-950 dark:text-white">
            {deviceData ? deviceData.temperature.toFixed(1) : '--'}
            <span className="text-lg text-orange-900/70 dark:text-white/70 ml-1">°C</span>
          </div>
        </motion.div>
        <motion.div
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ delay: 0.1 }}
          className="p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 dark:from-blue-500/20 dark:to-blue-600/10 border border-blue-500/20"
        >
          <div className="text-blue-700/70 dark:text-blue-200/70 text-sm mb-1">湿度</div>
          <div className="text-3xl font-bold text-blue-950 dark:text-white">
            {deviceData ? (deviceData.humidity / 10).toFixed(1) : '--'}
            <span className="text-lg text-blue-900/70 dark:text-white/70 ml-1">%</span>
          </div>
        </motion.div>
        <motion.div
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ delay: 0.2 }}
          className="p-4 rounded-xl bg-gradient-to-br from-gray-500/10 to-gray-600/5 dark:from-gray-500/20 dark:to-gray-600/10 border border-gray-500/20"
        >
          <div className="text-gray-700/70 dark:text-gray-200/70 text-sm mb-1">二氧化碳</div>
          <div className="text-3xl font-bold text-gray-900 dark:text-white">
            {deviceData ? deviceData.co2 : '--'}
            <span className="text-lg text-gray-800/70 dark:text-white/70 ml-1">ppm</span>
          </div>
        </motion.div>
        <motion.div
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ delay: 0.3 }}
          className="p-4 rounded-xl bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 dark:from-yellow-500/20 dark:to-yellow-600/10 border border-yellow-500/20"
        >
          <div className="text-yellow-700/70 dark:text-yellow-200/70 text-sm mb-1">光照</div>
          <div className="text-3xl font-bold text-yellow-950 dark:text-white">
            {deviceData ? deviceData.light : '--'}
            <span className="text-lg text-yellow-900/70 dark:text-white/70 ml-1">lux</span>
          </div>
        </motion.div>
      </div>
      {/* 天气预报卡片 */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.4 }}
      >
        <Card className="bg-gradient-to-br from-blue-500/20 to-blue-600/10 dark:from-blue-500/30 dark:to-blue-600/20 border-blue-400/30 overflow-hidden">
          <CardContent className="p-6 space-y-4">
            {/* 当前天气和定位 */}
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                {loading ? (
                  <div className="text-white/50">加载中...</div>
                ) : error ? (
                  <div className="text-red-400 text-sm">天气数据加载失败</div>
                ) : weatherData?.current ? (
                  <>
                    {(() => {
                      const Icon = weatherIcons[getWeatherIcon(weatherData.current.condition.code)]
                      return <Icon className="size-12 text-blue-600 dark:text-white" strokeWidth={1.5} />
                    })()}
                    <div>
                      <div className="text-4xl font-bold text-blue-950 dark:text-white">
                        {Math.round(weatherData.current.temp_c)}°C
                      </div>
                      <div className="text-sm text-blue-800/70 dark:text-white/70 mt-1">
                        {weatherData.current.condition.text}
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    <Cloud className="size-12 text-white" strokeWidth={1.5} />
                    <div>
                      <div className="text-4xl font-bold text-white">--°C</div>
                    </div>
                  </>
                )}
              </div>
              {/* 定位信息 */}
              {weatherData?.location && (
                <div
                  className="text-right cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={requestLocation}
                  title="点击重新定位"
                >
                  <div className="flex items-center justify-end gap-1.5">
                    <span className="text-xl font-medium text-blue-950 dark:text-white">
                      {weatherData.location.name === 'Ningbo' ? '宁波' : weatherData.location.name}
                    </span>
                    {locationSource && (
                      <span
                        className="text-base"
                        title={
                          locationSource === 'gps' ? 'GPS定位' :
                            locationSource === 'ip' ? 'IP定位' :
                              '默认位置'
                        }
                      >
                        {locationSource === 'gps' ? '' : locationSource === 'ip' ? '' : ''}
                      </span>
                    )}
                  </div>
                  <div className="text-sm text-blue-800/60 dark:text-white/60">
                    {weatherData.location.region === 'Zhejiang' ? '浙江' : weatherData.location.region}
                  </div>
                </div>
              )}
            </div>
            {/* 7天预报 - 日期和图标 */}
            <div className="grid grid-cols-7 gap-2 text-center">
              {forecast.length > 0 ? forecast.map((day, i) => {
                const Icon = weatherIcons[day.icon]
                return (
                  <div key={i} className="space-y-2">
                    <div className="text-xs text-blue-900/70 dark:text-white/70 font-medium">{day.date}</div>
                    <Icon className="size-5 text-blue-700 dark:text-white mx-auto" strokeWidth={1.5} />
                  </div>
                )
              }) : (
                Array.from({ length: 7 }).map((_, i) => (
                  <div key={i} className="space-y-2">
                    <div className="text-xs text-white/70">--</div>
                    <Cloud className="size-5 text-white/30 mx-auto" strokeWidth={1.5} />
                  </div>
                ))
              )}
            </div>
            {/* 温度曲线 - 与上下对齐 */}
            <div className="relative h-28">
              {tempData.length > 1 ? (
                <div className="w-full h-full">
                  <svg viewBox="0 0 700 100" className="w-full h-full" preserveAspectRatio="xMidYMid meet">
                    <defs>
                      <linearGradient id="tempGradient" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stopColor="rgba(96, 165, 250, 0.4)" />
                        <stop offset="100%" stopColor="rgba(96, 165, 250, 0.05)" />
                      </linearGradient>
                    </defs>
                    {/* 绘制曲线和填充区域 */}
                    {(() => {
                      const range = maxTemp - minTemp || 1
                      const padding = 25 // 上下留白
                      // 计算每个点的位置，使其与列对齐
                      const points = tempData.map((temp, i) => {
                        // 计算 x 坐标：每列中心位置
                        const columnWidth = 700 / tempData.length
                        const x = columnWidth * i + columnWidth / 2
                        // 计算 y 坐标
                        const y = padding + ((maxTemp - temp) / range) * (100 - padding * 2)
                        return { x, y, temp }
                      })
                      // 构建路径
                      const linePath = points.map((p, i) =>
                        `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
                      ).join(' ')
                      const areaPath = `${linePath} L ${points[points.length - 1].x} 100 L ${points[0].x} 100 Z`
                      return (
                        <>
                          {/* 填充区域 */}
                          <path d={areaPath} fill="url(#tempGradient)" />
                          {/* 曲线 */}
                          <path d={linePath} fill="none" stroke="rgba(96, 165, 250, 0.9)" strokeWidth="2" />
                          {/* 数据点和温度标签 */}
                          {points.map((p, i) => (
                            <g key={i}>
                              <circle cx={p.x} cy={p.y} r="4" fill="white" />
                              <text
                                x={p.x}
                                y={p.y - 12}
                                textAnchor="middle"
                                fill="currentColor"
                                className="text-blue-900 dark:text-white"
                                fontSize="16"
                                fontWeight="600"
                                style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}
                              >
                                {p.temp}°
                              </text>
                            </g>
                          ))}
                        </>
                      )
                    })()}
                  </svg>
                </div>
              ) : (
                <div className="flex items-center justify-center h-full text-white/30 text-sm">
                  等待天气数据...
                </div>
              )}
            </div>
            {/* 湿度 - 与上方对齐 */}
            <div className="grid grid-cols-7 gap-2 text-center">
              {weatherData?.forecast?.forecastday?.slice(0, 7).map((day, i) => (
                <div key={i} className="space-y-1">
                  <Droplets className="size-4 text-blue-500 dark:text-blue-300 mx-auto" />
                  <div className="text-xs text-blue-900/90 dark:text-white/90">{day.day.avghumidity}%</div>
                </div>
              )) || Array.from({ length: 7 }).map((_, i) => (
                <div key={i} className="space-y-1">
                  <Droplets className="size-4 text-blue-300/30 mx-auto" />
                  <div className="text-xs text-white/50">--</div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </motion.div>
      {/* 详细环境数据 */}
      <div className="grid grid-cols-3 gap-3">
        {(() => {
          const outdoorData = weatherData?.current ? [
            {
              label: "室外温度",
              value: `${Math.round(weatherData.current.temp_c)}°C`,
              icon: Sun
            },
            {
              label: weatherData.current.wind_dir ? `${weatherData.current.wind_dir}风向` : "风向",
              value: weatherData.current.wind_kph < 12 ? "微风" :
                weatherData.current.wind_kph < 30 ? "中等" :
                  weatherData.current.wind_kph < 50 ? "强风" : "大风",
              icon: Wind
            },
            {
              label: "UV",
              value: weatherData.current.uv >= 6 ? "强" :
                weatherData.current.uv >= 3 ? "中等" : "弱",
              icon: Sun
            },
            {
              label: "室外湿度",
              value: `${weatherData.current.humidity}%`,
              icon: Droplets
            },
            {
              label: "室外风力",
              value: `${Math.round(weatherData.current.wind_kph)}km/h`,
              icon: Wind
            },
            {
              label: "室外气压",
              value: `${Math.round(weatherData.current.pressure_mb)}hPa`,
              icon: Gauge
            },
          ] : [
            { label: "室外温度", value: "--", icon: Sun },
            { label: "风向", value: "--", icon: Wind },
            { label: "UV", value: "--", icon: Sun },
            { label: "室外湿度", value: "--", icon: Droplets },
            { label: "室外风力", value: "--", icon: Wind },
            { label: "室外气压", value: "--", icon: Gauge },
          ];
          return outdoorData.map((item, i) => (
            <motion.div
              key={i}
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.5 + i * 0.05 }}
              className="p-3 rounded-lg bg-secondary/50 dark:bg-white/5 border border-border dark:border-white/10"
            >
              <div className="flex items-center gap-2 mb-2">
                <item.icon className="size-4 text-muted-foreground dark:text-white/70" />
                <div className="text-xs text-muted-foreground dark:text-white/60">{item.label}</div>
              </div>
              <div className="text-lg font-bold text-foreground dark:text-white">{item.value}</div>
            </motion.div>
          ));
        })()}
      </div>
      {/* 生长阶段 */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.8 }}
        className="p-4 rounded-xl bg-gradient-to-r from-green-500/10 to-emerald-500/10 dark:from-green-500/20 dark:to-emerald-500/20 border border-green-500/30"
      >
        <div className="text-sm text-green-800/70 dark:text-green-200/70 mb-3">草莓生长阶段</div>
        <div className="flex items-center justify-between">
          {["", "", "", "", ""].map((emoji, i) => {
            const stage = i + 1
            const isActive = plantData && stage <= plantData.stage
            const isCurrent = plantData && stage === plantData.stage
            return (
              <div
                key={i}
                className={`text-3xl transition-all ${isActive
                    ? isCurrent
                      ? "opacity-100 scale-125 drop-shadow-lg"
                      : "opacity-100 scale-110"
                    : "opacity-40 scale-100"
                  }`}
              >
                {emoji}
              </div>
            )
          })}
        </div>
        <div className="mt-3 text-xs text-green-800/70 dark:text-green-200/70">
          当前阶段：{plantData ? (
            ['幼苗期', '生长期', '花芽分化期', '开花结果期', '果实成熟期', '采收后期'][plantData.stage - 1] || `第${plantData.stage}阶段`
          ) : '等待数据...'}
        </div>
        {plantData?.healthScore && (
          <div className="mt-2 flex items-center gap-2">
            <div className="text-xs text-green-800/70 dark:text-green-200/70">健康度：</div>
            <div className="flex-1 h-2 bg-green-900/20 dark:bg-green-100/10 rounded-full overflow-hidden">
              <div
                className="h-full bg-gradient-to-r from-green-600 to-emerald-500 transition-all duration-500"
                style={{ width: `${plantData.healthScore}%` }}
              />
            </div>
            <div className="text-xs font-bold text-green-800 dark:text-green-200">{plantData.healthScore}</div>
          </div>
        )}
      </motion.div>
    </div>
  )
}

--- FILE: lib\ai-system-prompt.ts ---

/**
 * AI 助手系统提示词
 *
 * 为智慧农业平台的 AI 助手提供专业知识和控制能力
 */
export const SMART_AGRICULTURE_SYSTEM_PROMPT = `你是莓界智慧农业平台的 AI 助手，专门帮助用户管理草莓种植环境和设备控制。
## 你的能力
### 1. 环境数据分析
你可以访问以下实时环境数据（已格式化，可直接使用）：
- **temperature**: 室内温度（已转换为°C，带单位）
- **humidity**: 室内湿度（已转换为%，带单位）
- **light**: 光照强度（lux，带单位）
- **co2**: 二氧化碳浓度（ppm，带单位）
- **earth_temp**: 土壤温度（已转换为°C，带单位）
- **earth_water**: 土壤含水量（%，带单位）
- **earth_ec**: 土壤电导率（μS/cm，带单位）
- **earth_n/earth_p/earth_k**: 土壤氮磷钾含量（mg/kg，带单位）
- **relay5-8**: 继电器状态（已转换为中文说明）
- led1-3: RGB LED 亮度值（0-255，已标注颜色）
- **channel1-11**: 光谱传感器数据 (μmol/m²/s)
  - channel1: 415nm (紫光) - 影响次生代谢产物积累
  - channel2: 445nm (蓝光) - 促进营养生长，防止徒长
  - channel3: 480nm (青光)
  - channel4: 515nm (绿光) - 穿透冠层，辅助光合作用
  - channel5: 555nm (黄绿光)
  - channel6: 590nm (黄光)
  - channel7: 630nm (橙光)
  - channel8: 680nm (红光) - 光合作用核心波段，促进开花结果
  - channel9: NIR (近红外) - 影响光形态建成
  - channel10: Clear (全光谱)
  - channel11: Flicker (频闪)
注意：所有数据都已经过格式化处理，温度和湿度已经除以10并转换为正确的小数值。
**重要：** 当你需要向用户展示当前的传感器数据、设备状态或环境概况时，请务必在回复中包含 <DEVICE_BENTO><${""}/DEVICE_BENTO> 标签。
**关键要求：** 不要只输出标签！在标签之后，你必须根据当前的数据对环境状况进行简要的分析和点评。例如：指出哪些指标偏高/偏低，是否符合草莓生长需求，或者给出简短的调整建议。
**光谱分析：** 当用户询问关于光谱数据、光照分析或需要查看光谱图表时，请在回复中包含 <SPECTRAL><${""}/SPECTRAL> 标签。这将展示一个专业的光谱分析图表。
**关键要求：** 在展示光谱图表后，请结合具体的波段数据（红光、蓝光、NIR等）进行分析，指出当前光质是否适合草莓所处的生长阶段。
**控制面板：** 当用户要求查看设备控制、调节设备状态或你建议进行设备调控时，请在回复中包含 <CONTROL_BENTO><${""}/CONTROL_BENTO> 标签。这将展示一个交互式的设备控制面板，用户可以直接在卡片上点击开关来控制设备。
**任务列表：** 当用户要求查看、管理或删除定时任务列表时，请在回复中包含 <TASK_LIST><${""}/TASK_LIST> 标签。这将展示一个美观的交互式任务列表，允许用户查看状态或删除任务。
**关键要求：**
1. 在输出 <CONTROL_BENTO>, <TASK_LIST> 或 <SPECTRAL> 标签之前或之后，必须简要说明调控的理由和建议。
2. **重要修改**：即使用了 <CONTROL_BENTO> 标签，如果用户明确表达了“是”、“确认”、“执行”等意图，或者你非常有把握需要执行某些操作，**请务必同时输出 JSON 格式的控制命令**。这样系统可以自动执行，用户也可以手动操作面板，双重保障。
### 2. 设备控制能力
你可以控制以下设备（通过调用 API）：
**继电器设备**:
- Relay 5: 水泵（灌溉系统）
- Relay 6: 风扇（通风降温）
- Relay 7: RGB 补光灯
- Relay 8: 白光灯
**RGB LED 控制**:
- LED 1-3: RGB 补光灯颜色调节（0-255）
### 3. 天气信息
你可以联网搜索用户所在位置的天气信息，包括：
- 当前温度、湿度、天气状况
- 未来7天天气预报
- 降雨量预测
### 4. 定时任务管理
你可以创建定时任务来自动化管理设备。当用户要求"每天8点开启"或"10分钟后关闭"时，请使用 \`schedule_task\` 命令。
**创建定时任务命令格式**:
\`\`\`json
{
  "action": "schedule_task",
  "title": "任务描述（如：每天早上8点开启灌溉）",
  "cron": "0 8 * * *", // Cron表达式（用于周期性任务）
  "execute_at": 1735689600000, // (可选) 指定执行绝对时间戳
  "delay_seconds": 300, // (可选) 延迟执行秒数。如果是相对时间任务（如"5分钟后"），请优先使用此字段，不要计算execute_at，前端会在点击时自动计算。
  "task_action": "toggle_relay", // 要执行的动作：toggle_relay 或 set_led
  "device": 5, // 设备ID
  "value": 1, // 参数值
  "params": { "r": 255, "g": 0, "b": 0 } // 或者用于LED的复杂参数
}
\`\`\`
注意：
- Cron表达式格式: \`分 时 日 月 周\` (如 \`0 8 * * *\` 表示每天08:00)
- 如果是一次性相对任务（如"10分钟后"），请直接使用 \`delay_seconds\` 字段（单位：秒），不要自己计算时间戳，以免因系统时间偏差导致执行失败。
- 如果是指定绝对时间（如"明天下午3点"），请计算出时间戳并使用 \`execute_at\` 字段。
- 任务创建后会自动生效
## 草莓种植最佳实践
### 温度管理
- **最佳温度**: 白天 20-25°C，夜间 10-15°C
- **开花期**: 15-20°C
- **果实成熟期**: 18-22°C
- **过高**: >30°C 需开启风扇降温
- **过低**: <10°C 需关闭风扇，考虑加温
### 湿度管理
- **最佳湿度**: 60-80%
- **过高**: >85% 易发病害，需开启风扇通风
- **过低**: <50% 需开启灌溉系统
### 光照管理
- **最佳光照**: 30000-50000 lux
- **光照不足**: <20000 lux 需开启补光灯
- **补光时间**: 每天12-14小时
- **光谱管理**:
  - **蓝光 (445nm)**: 促进营养生长，增加叶片厚度，使植株矮壮。
  - **红光 (680nm)**: 光合作用效率最高，促进开花和果实发育。
  - **红蓝比 (R:B)**:
    - 生长期: 建议 3:1 到 4:1，蓝光比例稍高防徒长。
    - 开花结果期: 建议 5:1 到 8:1，红光为主促进产量。
  - **绿光 (515nm)**: 虽吸收率低，但能穿透冠层到达下部叶片，提高整体光合效率。
- **补光颜色建议**:
  - 生长期: 蓝光为主 (R:50, G:100, B:255)
  - 开花期: 红蓝混合 (R:200, G:50, B:150)
  - 结果期: 红光为主 (R:255, G:100, B:50)
### CO₂ 管理
- **最佳浓度**: 800-1200 ppm
- **过低**: <400 ppm 需关闭风扇，减少通风
- **过高**: >1500 ppm 需开启风扇通风
### 土壤管理
- **土壤湿度**: 保持在 60-80%
- **土壤EC**: 1.0-2.0 mS/cm (1000-2000 μS/cm)
- **土壤温度**: 18-22°C
- **NPK 平衡**:
  - 生长期: N:P:K = 2:1:2
  - 开花期: N:P:K = 1:2:2
  - 结果期: N:P:K = 1:1:3
## 智能控制策略
### 自动化建议流程
1. **分析当前环境数据**
2. **对比最佳实践标准**
3. **考虑天气预报**（如即将下雨，减少灌溉）
4. **生成控制方案**
5. **说明调控理由**
6. **执行控制命令**（需用户确认）
### 控制命令格式
当你需要控制设备时，使用以下格式：
\`\`\`json
{
  "action": "toggle_relay",
  "device": 5,
  "value": 1
}
\`\`\`
或设置 LED 颜色：
\`\`\`json
{
  "action": "set_led",
  "r": 255,
  "g": 100,
  "b": 50
}
\`\`\`
**重要**: 在执行任何控制命令前，必须：
1. 清楚说明为什么要这样调控
2. 说明预期效果
3. 询问用户是否确认执行
## 交互风格
- 专业但友好
- 数据驱动的建议
- 清晰的因果解释
- 主动提供优化建议
- 考虑能源效率和成本
## 示例对话
用户: "帮我看看现在的环境怎么样"
助手: "<DEVICE_BENTO><${""}/DEVICE_BENTO>
让我分析一下当前环境数据：
- 温度: 28°C（偏高，最佳范围 20-25°C）
- 湿度: 55%（正常）
- 光照: 15000 lux（偏低，建议 30000-50000 lux）
建议：
1. 开启风扇降温
2. 开启补光灯，建议使用生长期配色（蓝光为主）
是否需要我执行这些调控？"
用户: "根据天气情况给我一个今天的设备控制方案"
助手: "好的，让我先查询当地天气... [搜索天气]
今天天气：晴天，最高温度 32°C，无降雨
综合分析：
- 高温天气，需要加强降温
- 无降雨，需要正常灌溉
- 光照充足，可减少补光时间
控制方案：
1. 上午10点前：开启风扇，关闭补光灯
2. 中午12-14点：开启灌溉系统5分钟
3. 下午16点后：根据光照情况开启补光灯
4. 晚上20点：关闭所有设备
您可以使用下方的控制面板进行操作：
<CONTROL_BENTO><${""}/CONTROL_BENTO>"
记住：你的目标是帮助用户种植出高品质的草莓，通过智能化管理提高产量和品质。`
export const getEnhancedSystemPrompt = (basePrompt?: string) => {
  const now = new Date()
  const timeString = now.toLocaleString('zh-CN', {
    timeZone: 'Asia/Shanghai',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  })
  const timestamp = now.getTime()
  const dynamicContext = `
当前系统时间: ${timeString} (Timestamp: ${timestamp})
**非常重要**: 请严格基于上述“当前系统时间”来计算所有定时任务的时间戳。严禁使用 2024 年或过去的任何时间作为未来任务的执行时间，除非现在真的是 2024 年。
`
  return `${basePrompt || '你是一个有帮助的AI助手。'}\n\n${dynamicContext}\n\n${SMART_AGRICULTURE_SYSTEM_PROMPT}`
}

--- FILE: lib\auth\session-store.ts ---

// Simple in-memory store for login sessions
// In a production environment with multiple instances, this should be Redis
export const loginSessions = new Map<string, { token: string; user: any; timestamp: number }>();
// Cleanup old sessions periodically (e.g. every 5 minutes)
setInterval(() => {
  const now = Date.now();
  for (const [uuid, session] of loginSessions.entries()) {
    if (now - session.timestamp > 10 * 60 * 1000) { // 10 minutes expiry
      loginSessions.delete(uuid);
    }
  }
}, 5 * 60 * 1000);

--- FILE: lib\auth.ts ---

import { cookies } from "next/headers"
import { getUserById, type UserPublic, toPublicUser } from "./db/user-service"
import { signToken, verifyToken as verifyTokenJose, type JWTPayload } from "./token"
export type { JWTPayload };
/**
 * Get JWT Secret (Re-export for compatibility if needed, though mostly internal)
 */
export function getJwtSecret(): string {
   const secret = process.env.JWT_SECRET;
   return secret || "dev-secret-change-in-production";
}
/**
 * Generate JWT Token
 */
export async function generateToken(payload: Omit<JWTPayload, "exp" | "iat">): Promise<string> {
  return signToken(payload);
}
/**
 * Verify JWT Token
 */
export async function verifyToken(token: string): Promise<JWTPayload | null> {
  return verifyTokenJose(token);
}
/**
 * Set Auth Cookie
 */
export async function setAuthCookie(token: string): Promise<void> {
  const cookieStore = await cookies()
  const isProduction = process.env.NODE_ENV === "production"
  cookieStore.set("auth", token, {
    httpOnly: true, // 防止 XSS 攻击
    sameSite: "lax", // 防止 CSRF 攻击
    secure: isProduction, // 生产环境仅允许 HTTPS
    path: "/",
    maxAge: 60 * 60 * 24 * 7, // 7 天(秒)
  })
}
/**
 * Clear Auth Cookie
 */
export async function clearAuthCookie(): Promise<void> {
  const cookieStore = await cookies()
  cookieStore.delete("auth")
}
/**
 * Get Current User
 */
export async function getCurrentUser(): Promise<UserPublic | null> {
  try {
    const cookieStore = await cookies()
    const token = cookieStore.get("auth")?.value
    if (!token) {
      return null
    }
    // Verify token (async now)
    const payload = await verifyToken(token)
    if (!payload) {
      return null
    }
    // Get user from DB
    const user = await getUserById(payload.id)
    if (!user) {
      return null
    }
    return toPublicUser(user)
  } catch (error) {
    console.error("获取当前用户失败:", error)
    return null
  }
}

--- FILE: lib\constants.ts ---

export function getInternalApiSecret(): string {
  // In production, this MUST be set in environment variables
  return process.env.INTERNAL_API_SECRET || "stravision-internal-secret-fallback";
}

--- FILE: lib\contexts\device-context.tsx ---

"use client"
import React, { createContext, useContext, useEffect, useState, useRef, useCallback } from 'react'
export interface DeviceData {
  temperature: number
  humidity: number
  light: number
  co2: number
  earth_temp: number
  earth_water: number
  earth_ec: number
  earth_n: number
  earth_p: number
  earth_k: number
  relay5: number
  relay6: number
  relay7: number
  relay8: number
  led1: number
  led2: number
  led3: number
  led4: number
  channel1?: number
  channel2?: number
  channel3?: number
  channel4?: number
  channel5?: number
  channel6?: number
  channel7?: number
  channel8?: number
  channel9?: number
  channel10?: number
  channel11?: number
  timestamp?: number
}
export interface ConnectionStatus {
  connected: boolean
  error: string | null
  lastUpdate: Date | null
}
interface DeviceContextType {
  deviceData: DeviceData | null
  connectionStatus: ConnectionStatus
}
const DeviceContext = createContext<DeviceContextType | undefined>(undefined)
export function DeviceProvider({ children }: { children: React.ReactNode }) {
  const [deviceData, setDeviceData] = useState<DeviceData | null>(null)
  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>({
    connected: false,
    error: null,
    lastUpdate: null
  })
  const eventSourceRef = useRef<EventSource | null>(null)
  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null)
  const reconnectAttemptsRef = useRef(0)
  const maxReconnectAttempts = 5
  const connect = useCallback(() => {
    // Clean up existing connection
    if (eventSourceRef.current) {
      eventSourceRef.current.close()
    }
    // Clear any pending reconnect
    if (reconnectTimeoutRef.current) {
      clearTimeout(reconnectTimeoutRef.current)
      reconnectTimeoutRef.current = null
    }
    try {
      // Only log in development to reduce console noise
      if (process.env.NODE_ENV === 'development') {
        console.log('[SSE] Connecting to /api/mqtt/stream...')
      }
      const eventSource = new EventSource('/api/mqtt/stream')
      eventSourceRef.current = eventSource
      eventSource.onopen = () => {
        if (process.env.NODE_ENV === 'development') {
          console.log('[SSE] Connection established')
        }
        setConnectionStatus(prev => ({
          ...prev,
          connected: true,
          error: null,
          lastUpdate: new Date()
        }))
        reconnectAttemptsRef.current = 0
      }
      eventSource.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data)
          if (message.type === 'connected') {
             // connection established message
          } else if (message.type === 'data' && message.data) {
            // Normalize data (divide specific fields by 10)
            const normalizedData = {
              ...message.data,
              temperature: message.data.temperature !== undefined ? message.data.temperature / 10 : 0,
              humidity: message.data.humidity !== undefined ? message.data.humidity / 10 : 0,
              earth_temp: message.data.earth_temp !== undefined ? message.data.earth_temp / 10 : 0,
              earth_water: message.data.earth_water !== undefined ? message.data.earth_water / 10 : 0
            }
            setDeviceData(normalizedData)
            setConnectionStatus(prev => ({
              ...prev,
              lastUpdate: new Date()
            }))
          }
        } catch (error) {
          console.error('[SSE] Error parsing message:', error)
        }
      }
      eventSource.onerror = (error) => {
        console.error('[SSE] Connection error:', error)
        eventSource.close()
        eventSourceRef.current = null
        setConnectionStatus(prev => ({
          ...prev,
          connected: false,
          error: 'Connection lost'
        }))
        // Attempt reconnect with exponential backoff
        if (reconnectAttemptsRef.current < maxReconnectAttempts) {
          const timeout = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 10000)
          console.log(`[SSE] Reconnecting in ${timeout}ms...`)
          reconnectTimeoutRef.current = setTimeout(() => {
            reconnectAttemptsRef.current++
            connect()
          }, timeout)
        }
      }
    } catch (error) {
      console.error('[SSE] Setup error:', error)
      setConnectionStatus(prev => ({
        ...prev,
        error: 'Failed to setup connection'
      }))
    }
  }, [])
  useEffect(() => {
    connect()
    return () => {
      if (eventSourceRef.current) {
        eventSourceRef.current.close()
      }
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current)
      }
    }
  }, [connect])
  return (
    <DeviceContext.Provider value={{ deviceData, connectionStatus }}>
      {children}
    </DeviceContext.Provider>
  )
}
export function useDeviceContext() {
  const context = useContext(DeviceContext)
  if (context === undefined) {
    throw new Error('useDeviceContext must be used within a DeviceProvider')
  }
  return context
}

--- FILE: lib\contexts\weather-context.tsx ---

"use client"
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react'
import { WeatherData } from '@/lib/hooks/use-weather'
interface WeatherContextType {
  weatherData: WeatherData | null
  loading: boolean
  error: string | null
  locationSource: 'gps' | 'ip' | 'default' | null
  refetch: () => void
  requestLocation: () => void
}
const WeatherContext = createContext<WeatherContextType | undefined>(undefined)
export function WeatherProvider({ children }: { children: ReactNode }) {
  const [weatherData, setWeatherData] = useState<WeatherData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [location, setLocation] = useState<{ lat: number; lon: number } | null>(null)
  const [locationSource, setLocationSource] = useState<'gps' | 'ip' | 'default' | null>(null)
  const [gpsAttempted, setGpsAttempted] = useState(false)
  // Request user's geolocation
  const requestLocation = () => {
    if ('geolocation' in navigator) {
      console.log('[WeatherContext] Requesting GPS location...')
      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log('[WeatherContext] GPS location obtained:', position.coords.latitude, position.coords.longitude)
          setLocation({
            lat: position.coords.latitude,
            lon: position.coords.longitude
          })
          setGpsAttempted(true)
        },
        (error) => {
          console.warn('[WeatherContext] Geolocation error:', error.message, '- will use IP fallback')
          setLocation(null)
          setGpsAttempted(true)
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000 // Cache for 5 minutes
        }
      )
    } else {
      console.warn('[WeatherContext] Geolocation not available - will use IP fallback')
      setGpsAttempted(true)
    }
  }
  // Get user's geolocation on mount
  useEffect(() => {
    requestLocation()
  }, [])
  const fetchWeather = async () => {
    // Wait for GPS attempt to complete before fetching
    if (!gpsAttempted) {
      return
    }
    try {
      setLoading(true)
      setError(null)
      // Build URL with three-tier location strategy
      let url = '/api/weather'
      let source: 'gps' | 'ip' | 'default' = 'default'
      if (location) {
        // Priority 1: Use GPS coordinates
        url += `?lat=${location.lat}&lon=${location.lon}`
        source = 'gps'
        console.log('[WeatherContext] Using GPS location:', location.lat, location.lon)
      } else {
        // Priority 2: Use IP geolocation
        url += '?useIP=true'
        source = 'ip'
        console.log('[WeatherContext] Using IP geolocation fallback')
      }
      const response = await fetch(url)
      if (!response.ok) {
        throw new Error('Failed to fetch weather data')
      }
      const data = await response.json()
      if (data.error) {
        throw new Error(data.error)
      }
      // Use location source from API response if available
      setLocationSource(data.locationSource || source)
      setWeatherData(data)
      console.log('[WeatherContext] Weather data fetched for:', data.location?.name, '(source:', data.locationSource || source + ')')
    } catch (err) {
      console.error('[WeatherContext] Error:', err)
      setError(err instanceof Error ? err.message : 'Unknown error')
    } finally {
      setLoading(false)
    }
  }
  useEffect(() => {
    fetchWeather()
    // Refresh weather data every 30 minutes
    const interval = setInterval(fetchWeather, 30 * 60 * 1000)
    return () => clearInterval(interval)
  }, [location, gpsAttempted])
  return (
    <WeatherContext.Provider value={{
      weatherData,
      loading,
      error,
      locationSource,
      refetch: fetchWeather,
      requestLocation
    }}>
      {children}
    </WeatherContext.Provider>
  )
}
export function useWeatherContext() {
  const context = useContext(WeatherContext)
  if (context === undefined) {
    throw new Error('useWeatherContext must be used within a WeatherProvider')
  }
  return context
}

--- FILE: lib\db\chat-service.ts ---

import { getDB, initDB } from "./database"
import { UserPublic, toPublicUser, User } from "./user-service"
let dbInitPromise: Promise<void> | null = null
async function ensureDB() {
  if (!dbInitPromise) {
    dbInitPromise = initDB()
  }
  await dbInitPromise
}
export interface FriendRequest {
  id: number
  requester_id: number
  addressee_id: number
  status: 'pending' | 'accepted' | 'rejected'
  created_at: number
  requester?: UserPublic
  addressee?: UserPublic
}
export interface Message {
  id: number
  sender_id: number
  receiver_id: number
  content: string
  type: 'text' | 'image' | 'file'
  file_url?: string
  group_id?: number | null
  read_at?: number
  created_at: number
}
export interface Group {
  id: number
  name: string
  owner_id: number
  avatar_url?: string
  created_at: number
}
export interface GroupMember {
  group_id: number
  user_id: number
  role: 'owner' | 'admin' | 'member'
  is_muted: boolean // 0 or 1 in DB
  joined_at: number
  user?: UserPublic
}
export class ChatService {
  /**
   * Block or Unblock a user
   */
  static async toggleBlockUser(userId: number, friendId: number, block: boolean): Promise<{ success: boolean; message: string }> {
    await ensureDB()
    const db = getDB()
    if (block) {
      // Check if target is an admin
      const friend = db.prepare("SELECT role FROM users WHERE id = ?").get(friendId) as { role: string } | undefined
      if (friend && (friend.role === 'admin' || friend.role === 'super_admin')) {
        return { success: false, message: 'Cannot block an administrator' }
      }
    }
    try {
      db.prepare("UPDATE friends SET is_blocked = ? WHERE user_id = ? AND friend_id = ?")
        .run(block ? 1 : 0, userId, friendId)
      return { success: true, message: block ? 'User blocked' : 'User unblocked' }
    } catch (error) {
      console.error("Failed to toggle block:", error)
      return { success: false, message: 'Internal error' }
    }
  }
  /**
   * Check if blocked
   */
  static async isBlocked(userId: number, friendId: number): Promise<boolean> {
    await ensureDB()
    const db = getDB()
    const result = db.prepare("SELECT is_blocked FROM friends WHERE user_id = ? AND friend_id = ?").get(userId, friendId) as { is_blocked: number } | undefined
    return result ? !!result.is_blocked : false
  }
  /**
   * Create a group
   */
  static async createGroup(ownerId: number, name: string, initialMemberIds: number[] = []): Promise<{ success: boolean; groupId?: number; message: string }> {
    await ensureDB()
    const db = getDB()
    const transaction = db.transaction(() => {
      const result = db.prepare("INSERT INTO groups (name, owner_id, created_at) VALUES (?, ?, ?)").run(name, ownerId, Date.now())
      const groupId = result.lastInsertRowid as number
      // Add owner
      db.prepare("INSERT INTO group_members (group_id, user_id, role, joined_at) VALUES (?, ?, 'owner', ?)").run(groupId, ownerId, Date.now())
      // Add members
      const stmt = db.prepare("INSERT INTO group_members (group_id, user_id, role, joined_at) VALUES (?, ?, 'member', ?)")
      for (const memberId of initialMemberIds) {
        if (memberId !== ownerId) {
           stmt.run(groupId, memberId, Date.now())
        }
      }
      return groupId
    })
    try {
      const groupId = transaction()
      return { success: true, groupId, message: 'Group created' }
    } catch (error) {
      console.error("Failed to create group:", error)
      return { success: false, message: 'Internal error' }
    }
  }
  /**
   * Get user groups
   */
  static async getUserGroups(userId: number): Promise<Group[]> {
    await ensureDB()
    const db = getDB()
    // Ensure last_read_at column exists (simple migration)
    try {
        const tableInfo = db.prepare("PRAGMA table_info(group_members)").all() as any[];
        if (!tableInfo.some(c => c.name === 'last_read_at')) {
            db.exec("ALTER TABLE group_members ADD COLUMN last_read_at INTEGER DEFAULT 0");
        }
    } catch (e) {}
    const groups = db.prepare(`
      SELECT g.*, gm.last_read_at
      FROM groups g
      JOIN group_members gm ON g.id = gm.group_id
      WHERE gm.user_id = ?
    `).all(userId) as (Group & { last_read_at: number })[]
    return groups.map(group => {
        const lastMessage = db.prepare(`
            SELECT * FROM messages WHERE group_id = ? ORDER BY created_at DESC LIMIT 1
        `).get(group.id) as Message | undefined
        const unread = db.prepare(`
            SELECT COUNT(*) as count FROM messages
            WHERE group_id = ? AND created_at > ?
        `).get(group.id, group.last_read_at || 0) as { count: number }
        return {
            ...group,
            last_message: lastMessage,
            unread_count: unread.count
        }
    })
  }
  /**
   * Get group members
   */
  static async getGroupMembers(groupId: number): Promise<GroupMember[]> {
    await ensureDB()
    const db = getDB()
    const members = db.prepare(`
      SELECT gm.*, u.id as u_id, u.email as u_email, u.username as u_username, u.avatar_url as u_avatar_url, u.role as u_role
      FROM group_members gm
      JOIN users u ON gm.user_id = u.id
      WHERE gm.group_id = ?
    `).all(groupId) as any[]
    return members.map(m => ({
      group_id: m.group_id,
      user_id: m.user_id,
      role: m.role,
      is_muted: !!m.is_muted,
      joined_at: m.joined_at,
      user: {
        id: m.u_id,
        email: m.u_email,
        username: m.u_username,
        avatar_url: m.u_avatar_url,
        role: m.u_role || 'user',
        permissions: {},
        notification_settings: { alerts: false, status: false, ai: false, updates: false },
        created_at: 0
      }
    }))
  }
  /**
   * Send message (updated for group support)
   */
  static async sendMessage(senderId: number, receiverId: number | null, content: string, type: 'text' | 'image' | 'file' = 'text', fileUrl?: string, groupId?: number): Promise<{ success: boolean; message?: Message; error?: string }> {
    await ensureDB()
    const db = getDB()
    // Check block status for 1-on-1
    if (!groupId && receiverId) {
      const isBlockedByReceiver = await this.isBlocked(receiverId, senderId)
      if (isBlockedByReceiver) {
        return { success: false, error: 'You are blocked by this user' }
      }
    }
    // Check mute status for Group
    if (groupId) {
       const member = db.prepare("SELECT is_muted FROM group_members WHERE group_id = ? AND user_id = ?").get(groupId, senderId) as { is_muted: number } | undefined
       if (!member) return { success: false, error: 'Not a member' }
       if (member.is_muted) return { success: false, error: 'You are muted in this group' }
    }
    try {
      // For group messages, receiver_id is not used but the column is NOT NULL.
      // We use sender_id as a placeholder for receiver_id in group messages.
      const actualReceiverId = groupId ? senderId : (receiverId || 0);
      const result = db.prepare(`
        INSERT INTO messages (sender_id, receiver_id, group_id, content, type, file_url, created_at)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `).run(senderId, actualReceiverId, groupId || null, content, type, fileUrl, Date.now())
      return {
        success: true,
        message: {
          id: result.lastInsertRowid as number,
          sender_id: senderId,
          receiver_id: actualReceiverId,
          group_id: groupId || null,
          content,
          type,
          file_url: fileUrl,
          created_at: Date.now()
        }
      }
    } catch (e) {
      console.error("SendMessage Error:", e);
      return { success: false, error: 'Failed to send' }
    }
  }
  /**
   * Get messages (updated for group support)
   */
  static async getMessages(userId: number, targetId: number, isGroup: boolean = false, limit = 50, offset = 0): Promise<Message[]> {
    await ensureDB()
    const db = getDB()
    let messages;
    if (isGroup) {
      messages = db.prepare(`
        SELECT * FROM messages
        WHERE group_id = ?
        ORDER BY created_at DESC
        LIMIT ? OFFSET ?
      `).all(targetId, limit, offset) as Message[]
      // Mark group as read
      try {
        db.prepare("UPDATE group_members SET last_read_at = ? WHERE group_id = ? AND user_id = ?").run(Date.now(), targetId, userId)
      } catch (e) {}
    } else {
      messages = db.prepare(`
        SELECT * FROM messages
        WHERE group_id IS NULL AND ((sender_id = ? AND receiver_id = ?) OR (sender_id = ? AND receiver_id = ?))
        ORDER BY created_at DESC
        LIMIT ? OFFSET ?
      `).all(userId, targetId, targetId, userId, limit, offset) as Message[]
      // Mark direct messages as read
      try {
        db.prepare("UPDATE messages SET read_at = ? WHERE sender_id = ? AND receiver_id = ? AND read_at IS NULL").run(Date.now(), targetId, userId)
      } catch (e) {}
    }
    return messages.reverse()
  }
  /**
   * Toggle mute member in group
   */
  static async toggleGroupMute(groupId: number, adminId: number, targetUserId: number, mute: boolean): Promise<{ success: boolean; message: string }> {
    await ensureDB()
    const db = getDB()
    // Check if operator is System Admin
    const operatorUser = db.prepare("SELECT role FROM users WHERE id = ?").get(adminId) as { role: string } | undefined
    const isSystemAdmin = operatorUser && (operatorUser.role === 'admin' || operatorUser.role === 'super_admin')
    // Check group admin rights
    const admin = db.prepare("SELECT role FROM group_members WHERE group_id = ? AND user_id = ?").get(groupId, adminId) as { role: string } | undefined
    const isGroupAdmin = admin && (admin.role === 'owner' || admin.role === 'admin')
    if (!isSystemAdmin && !isGroupAdmin) {
        return { success: false, message: 'Unauthorized' }
    }
    // Check if target is System Admin (cannot be muted)
    if (mute) {
        const targetUser = db.prepare("SELECT role FROM users WHERE id = ?").get(targetUserId) as { role: string } | undefined
        if (targetUser && (targetUser.role === 'admin' || targetUser.role === 'super_admin')) {
             return { success: false, message: 'Cannot mute an administrator' }
        }
    }
    db.prepare("UPDATE group_members SET is_muted = ? WHERE group_id = ? AND user_id = ?").run(mute ? 1 : 0, groupId, targetUserId)
    return { success: true, message: mute ? 'User muted' : 'User unmuted' }
  }
  /**
   * Add member to group
   */
  static async addGroupMember(groupId: number, adminId: number, targetUserId: number): Promise<{ success: boolean; message: string }> {
      await ensureDB()
      const db = getDB()
      // Check admin rights (optional: currently allow any member to add? No, let's restrict to admin/owner for safety, or allow all)
      // Usually inviting is allowed by everyone, but adding directly might need permission.
      // Let's allow any member to invite for now to keep it simple, OR strictly owner.
      // Let's check if inviter is in group.
      const inviter = db.prepare("SELECT 1 FROM group_members WHERE group_id = ? AND user_id = ?").get(groupId, adminId)
      if (!inviter) return { success: false, message: 'Not a member' }
      try {
          db.prepare("INSERT INTO group_members (group_id, user_id, role, joined_at) VALUES (?, ?, 'member', ?)").run(groupId, targetUserId, Date.now())
          return { success: true, message: 'Member added' }
      } catch (e) {
          return { success: false, message: 'Failed to add member' }
      }
  }
  static async sendFriendRequest(requesterId: number, addresseeEmail: string): Promise<{ success: boolean; message: string }> {
    await ensureDB()
    const db = getDB()
    // Find addressee
    const addressee = db.prepare('SELECT * FROM users WHERE email = ?').get(addresseeEmail) as User | undefined
    if (!addressee) {
      return { success: false, message: 'User not found' }
    }
    if (addressee.id === requesterId) {
      return { success: false, message: 'Cannot add yourself as friend' }
    }
    // Check if already friends
    const existingFriend = db.prepare('SELECT 1 FROM friends WHERE user_id = ? AND friend_id = ?').get(requesterId, addressee.id)
    if (existingFriend) {
      return { success: false, message: 'Already friends' }
    }
    // Check if request already exists
    const existingRequest = db.prepare('SELECT * FROM friend_requests WHERE requester_id = ? AND addressee_id = ? AND status = ?')
      .get(requesterId, addressee.id, 'pending')
    if (existingRequest) {
      return { success: false, message: 'Friend request already sent' }
    }
    // Check if they sent one to us
    const reverseRequest = db.prepare('SELECT * FROM friend_requests WHERE requester_id = ? AND addressee_id = ? AND status = ?')
      .get(addressee.id, requesterId, 'pending') as FriendRequest | undefined
    if (reverseRequest) {
        // Auto accept if they already asked
        return this.acceptFriendRequest(reverseRequest.id, requesterId)
    }
    try {
      db.prepare(`
        INSERT INTO friend_requests (requester_id, addressee_id, status, created_at, updated_at)
        VALUES (?, ?, 'pending', ?, ?)
      `).run(requesterId, addressee.id, Date.now(), Date.now())
      return { success: true, message: 'Friend request sent' }
    } catch (error) {
      console.error('Failed to send friend request:', error)
      return { success: false, message: 'Internal error' }
    }
  }
  /**
   * Get pending friend requests for a user
   */
  static async getFriendRequests(userId: number): Promise<FriendRequest[]> {
    await ensureDB()
    const db = getDB()
    const requests = db.prepare(`
      SELECT fr.*,
             u.id as u_id, u.email as u_email, u.username as u_username, u.avatar_url as u_avatar_url
      FROM friend_requests fr
      JOIN users u ON fr.requester_id = u.id
      WHERE fr.addressee_id = ? AND fr.status = 'pending'
    `).all(userId) as any[]
    return requests.map(r => ({
      id: r.id,
      requester_id: r.requester_id,
      addressee_id: r.addressee_id,
      status: r.status,
      created_at: r.created_at,
      requester: {
        id: r.u_id,
        email: r.u_email,
        username: r.u_username,
        avatar_url: r.u_avatar_url,
        role: 'user', // Simplified
        permissions: {},
        notification_settings: {
            alerts: false,
            status: false,
            ai: false,
            updates: false
        },
        created_at: 0
      }
    }))
  }
  /**
   * Accept friend request
   */
  static async acceptFriendRequest(requestId: number, userId: number): Promise<{ success: boolean; message: string }> {
    await ensureDB()
    const db = getDB()
    const request = db.prepare('SELECT * FROM friend_requests WHERE id = ?').get(requestId) as FriendRequest | undefined
    if (!request) {
      return { success: false, message: 'Request not found' }
    }
    if (request.addressee_id !== userId) {
      return { success: false, message: 'Unauthorized' }
    }
    const transaction = db.transaction(() => {
      // Update request status
      db.prepare("UPDATE friend_requests SET status = 'accepted', updated_at = ? WHERE id = ?").run(Date.now(), requestId)
      // Add to friends table (bidirectional)
      db.prepare("INSERT OR IGNORE INTO friends (user_id, friend_id, created_at) VALUES (?, ?, ?)").run(request.requester_id, request.addressee_id, Date.now())
      db.prepare("INSERT OR IGNORE INTO friends (user_id, friend_id, created_at) VALUES (?, ?, ?)").run(request.addressee_id, request.requester_id, Date.now())
    })
    try {
      transaction()
      return { success: true, message: 'Friend request accepted' }
    } catch (error) {
      console.error('Failed to accept friend request:', error)
      return { success: false, message: 'Internal error' }
    }
  }
  /**
   * Reject friend request
   */
  static async rejectFriendRequest(requestId: number, userId: number): Promise<{ success: boolean; message: string }> {
    await ensureDB()
    const db = getDB()
    const request = db.prepare('SELECT * FROM friend_requests WHERE id = ?').get(requestId) as FriendRequest | undefined
    if (!request) {
        return { success: false, message: 'Request not found' }
    }
    if (request.addressee_id !== userId) {
        return { success: false, message: 'Unauthorized' }
    }
    try {
        db.prepare("UPDATE friend_requests SET status = 'rejected', updated_at = ? WHERE id = ?").run(Date.now(), requestId)
        return { success: true, message: 'Friend request rejected' }
    } catch (error) {
        return { success: false, message: 'Internal error' }
    }
  }
  /**
   * Get friends list
   */
  static async getFriends(userId: number): Promise<(UserPublic & { last_message?: Message, unread_count: number })[]> {
    await ensureDB()
    const db = getDB()
    const friends = db.prepare(`
      SELECT u.*
      FROM friends f
      JOIN users u ON f.friend_id = u.id
      WHERE f.user_id = ?
    `).all(userId) as User[]
    return friends.map(friend => {
      const lastMessage = db.prepare(`
        SELECT * FROM messages
        WHERE group_id IS NULL AND ((sender_id = ? AND receiver_id = ?) OR (sender_id = ? AND receiver_id = ?))
        ORDER BY created_at DESC
        LIMIT 1
      `).get(userId, friend.id, friend.id, userId) as Message | undefined
      const unread = db.prepare(`
        SELECT COUNT(*) as count FROM messages
        WHERE group_id IS NULL AND sender_id = ? AND receiver_id = ? AND (read_at IS NULL OR read_at = 0)
      `).get(friend.id, userId) as { count: number }
      return {
        ...toPublicUser(friend),
        last_message: lastMessage,
        unread_count: unread.count
      }
    })
  }
  /**
   * Get new messages for user (for notifications)
   */
  static async getNewMessagesForUser(userId: number, since: number): Promise<(Message & { sender_name: string; group_name?: string; sender_avatar?: string })[]> {
    await ensureDB()
    const db = getDB()
    // Get direct messages
    const directMessages = db.prepare(`
      SELECT m.*, u.username as sender_name, u.avatar_url as sender_avatar
      FROM messages m
      JOIN users u ON m.sender_id = u.id
      WHERE m.receiver_id = ? AND m.created_at > ?
    `).all(userId, since) as (Message & { sender_name: string; sender_avatar?: string })[]
    // Get group messages (excluding muted groups and self-sent messages)
    const groupMessages = db.prepare(`
      SELECT m.*, u.username as sender_name, u.avatar_url as sender_avatar, g.name as group_name
      FROM messages m
      JOIN group_members gm ON m.group_id = gm.group_id
      JOIN users u ON m.sender_id = u.id
      JOIN groups g ON m.group_id = g.id
      WHERE gm.user_id = ?
      AND m.sender_id != ?
      AND m.created_at > ?
      AND m.group_id IS NOT NULL
      AND gm.is_muted = 0
    `).all(userId, userId, since) as (Message & { sender_name: string; group_name: string; sender_avatar?: string })[]
    return [...directMessages, ...groupMessages].sort((a, b) => b.created_at - a.created_at)
  }
  /**
   * Clear chat history
   */
  static async clearMessages(userId: number, friendId: number): Promise<{ success: boolean; message: string }> {
    await ensureDB()
    const db = getDB()
    try {
      db.prepare(`
        DELETE FROM messages
        WHERE group_id IS NULL
        AND ((sender_id = ? AND receiver_id = ?) OR (sender_id = ? AND receiver_id = ?))
      `).run(userId, friendId, friendId, userId)
      return { success: true, message: 'Chat history cleared' }
    } catch (error) {
      console.error("Failed to clear messages:", error)
      return { success: false, message: 'Internal error' }
    }
  }
}

--- FILE: lib\db\database.ts ---

if (typeof process !== 'undefined' && process.env.NEXT_RUNTIME === 'edge') {
  throw new Error('Database module cannot run in Edge runtime')
}
import Database from "better-sqlite3"
import path from "path"
import { promises as fs } from "fs"
let db: Database.Database | null = null
/**
 * 获取数据库文件路径
 */
function getDatabasePath(): string {
  return process.env.DATABASE_PATH || path.join(process.cwd(), "data", "users.db")
}
/**
 * 初始化数据库连接和表结构
 */
export async function initDB(): Promise<void> {
  if (db) {
    return // 已经初始化
  }
  const dbPath = getDatabasePath()
  const dbDir = path.dirname(dbPath)
  // 确保数据目录存在
  try {
    await fs.mkdir(dbDir, { recursive: true })
  } catch (error) {
    console.error("Failed to create database directory:", error)
    throw error
  }
  // 创建数据库连接
  try {
    db = new Database(dbPath)
    // 启用外键约束
    db.pragma("foreign_keys = ON")
    // 优化 WAL 模式
    db.pragma('journal_mode = WAL')
    // 增加 busy timeout，减少 SQLITE_BUSY 错误
    db.pragma('busy_timeout = 5000')
    // 检查并添加 role 列
    try {
      const tableInfo = db.prepare("PRAGMA table_info(users)").all() as any[];
      const hasRole = tableInfo.some(col => col.name === 'role');
      if (!hasRole) {
        db.exec("ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'");
      }
      const hasPermissions = tableInfo.some(col => col.name === 'permissions');
      if (!hasPermissions) {
        db.exec("ALTER TABLE users ADD COLUMN permissions TEXT DEFAULT '{}'");
      }
    } catch (e) {
      console.error("Failed to migrate users table:", e);
    }
  } catch (error) {
    console.error("Failed to open database:", error)
    throw error
  }
  // 创建 users 表（新库会包含微信字段，旧库需要后续迁移）
  db.exec(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      email TEXT UNIQUE,
      password_hash TEXT,
      username TEXT NOT NULL,
      avatar_url TEXT,
      role TEXT DEFAULT 'user',
      permissions TEXT DEFAULT '{}',
      wechat_openid TEXT UNIQUE,
      wechat_unionid TEXT,
      wework_userid TEXT,
      qq_openid TEXT UNIQUE,
      alipay_user_id TEXT UNIQUE,
      notification_settings TEXT DEFAULT '{}',
      created_at INTEGER NOT NULL,
      updated_at INTEGER NOT NULL
    )
  `)
  // 创建 scheduled_tasks 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS scheduled_tasks (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      cron_expression TEXT,
      execute_at INTEGER,
      action_type TEXT NOT NULL,
      device_id INTEGER,
      params TEXT NOT NULL,
      is_active INTEGER DEFAULT 1,
      created_at INTEGER NOT NULL,
      updated_at INTEGER NOT NULL
    )
  `)
  // 创建 banned_ips 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS banned_ips (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      ip TEXT UNIQUE NOT NULL,
      reason TEXT,
      banned_by TEXT,
      expires_at INTEGER,
      created_at INTEGER NOT NULL
    )
  `)
  // 创建 access_logs 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS access_logs (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      ip TEXT NOT NULL,
      method TEXT,
      path TEXT,
      status INTEGER,
      duration INTEGER,
      user_id INTEGER,
      user_agent TEXT,
      created_at INTEGER NOT NULL
    )
  `)
  // 创建 device_logs 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS device_logs (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      device_name TEXT NOT NULL,
      action TEXT NOT NULL,
      operator TEXT NOT NULL,
      details TEXT,
      created_at INTEGER NOT NULL
    )
  `)
  // 创建 login_tickets 表 (用于移动端唤起APP后的跨浏览器登录)
  db.exec(`
    CREATE TABLE IF NOT EXISTS login_tickets (
      ticket TEXT PRIMARY KEY,
      jwt TEXT,
      created_at INTEGER NOT NULL
    )
  `)
  // 创建 system_settings 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS system_settings (
      key TEXT PRIMARY KEY,
      value TEXT NOT NULL,
      updated_at INTEGER NOT NULL
    )
  `)
  // 旧库迁移：检测并补充缺失列
  try {
    const columns = db.prepare(`PRAGMA table_info(users)`).all() as Array<{ name: string }>
    const names = new Set(columns.map((c) => c.name))
    if (!names.has("wechat_openid")) {
      db.exec(`ALTER TABLE users ADD COLUMN wechat_openid TEXT`)
    }
    if (!names.has("wechat_unionid")) {
      db.exec(`ALTER TABLE users ADD COLUMN wechat_unionid TEXT`)
    }
    if (!names.has("wework_userid")) {
      db.exec(`ALTER TABLE users ADD COLUMN wework_userid TEXT`)
    }
    if (!names.has("qq_openid")) {
      db.exec(`ALTER TABLE users ADD COLUMN qq_openid TEXT`)
    }
    if (!names.has("alipay_user_id")) {
      db.exec(`ALTER TABLE users ADD COLUMN alipay_user_id TEXT`)
    }
  } catch (e) {
    console.error("Failed to migrate users table columns:", e)
    throw e
  }
  // 创建索引以加速查询
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_wechat_openid ON users(wechat_openid);
  `)
  // ----------------------------------------------------------------------
  // 聊天系统相关表 (Friends, Friend Requests, Messages)
  // ----------------------------------------------------------------------
  // friend_requests 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS friend_requests (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      requester_id INTEGER NOT NULL,
      addressee_id INTEGER NOT NULL,
      status TEXT DEFAULT 'pending', -- pending, accepted, rejected
      created_at INTEGER NOT NULL,
      updated_at INTEGER NOT NULL,
      FOREIGN KEY(requester_id) REFERENCES users(id),
      FOREIGN KEY(addressee_id) REFERENCES users(id),
      UNIQUE(requester_id, addressee_id)
    )
  `)
  // friends 表 (双向关系，存储两条记录或查询时处理，这里选择存储唯一关系通常用 id1 < id2 约束，或者简单存两条)
  // 为了查询方便，通常存两条: (A, B) 和 (B, A) 当 A 和 B 成为朋友时。
  db.exec(`
    CREATE TABLE IF NOT EXISTS friends (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      friend_id INTEGER NOT NULL,
      created_at INTEGER NOT NULL,
      FOREIGN KEY(user_id) REFERENCES users(id),
      FOREIGN KEY(friend_id) REFERENCES users(id),
      UNIQUE(user_id, friend_id)
    )
  `)
  // messages 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      sender_id INTEGER NOT NULL,
      receiver_id INTEGER NOT NULL,
      content TEXT,
      type TEXT DEFAULT 'text', -- text, image, file
      file_url TEXT,
      read_at INTEGER,
      created_at INTEGER NOT NULL,
      FOREIGN KEY(sender_id) REFERENCES users(id),
      FOREIGN KEY(receiver_id) REFERENCES users(id)
    )
  `)
  // 消息索引
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_messages_sender_receiver ON messages(sender_id, receiver_id);
    CREATE INDEX IF NOT EXISTS idx_messages_receiver_read ON messages(receiver_id, read_at);
  `)
  // ----------------------------------------------------------------------
  // 群聊与屏蔽功能扩展
  // ----------------------------------------------------------------------
  // 1. friends 表增加 is_blocked 字段
  try {
    const tableInfo = db.prepare("PRAGMA table_info(friends)").all() as any[];
    const hasBlocked = tableInfo.some(col => col.name === 'is_blocked');
    if (!hasBlocked) {
      db.exec("ALTER TABLE friends ADD COLUMN is_blocked INTEGER DEFAULT 0");
    }
  } catch (e) {
    console.error("Failed to migrate friends table:", e);
  }
  // 2. messages 表增加 group_id 字段
  try {
    const tableInfo = db.prepare("PRAGMA table_info(messages)").all() as any[];
    const hasGroupId = tableInfo.some(col => col.name === 'group_id');
    if (!hasGroupId) {
      db.exec("ALTER TABLE messages ADD COLUMN group_id INTEGER");
      db.exec("CREATE INDEX IF NOT EXISTS idx_messages_group_id ON messages(group_id)");
    }
  } catch (e) {
    console.error("Failed to migrate messages table:", e);
  }
  // 3. groups 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS groups (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      owner_id INTEGER NOT NULL,
      avatar_url TEXT,
      created_at INTEGER NOT NULL,
      FOREIGN KEY(owner_id) REFERENCES users(id)
    )
  `)
  // 4. group_members 表
  db.exec(`
    CREATE TABLE IF NOT EXISTS group_members (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      group_id INTEGER NOT NULL,
      user_id INTEGER NOT NULL,
      role TEXT DEFAULT 'member', -- owner, admin, member
      is_muted INTEGER DEFAULT 0, -- 在群内是否被禁言
      joined_at INTEGER NOT NULL,
      FOREIGN KEY(group_id) REFERENCES groups(id),
      FOREIGN KEY(user_id) REFERENCES users(id),
      UNIQUE(group_id, user_id)
    )
  `)
  console.log("Database initialized successfully at:", dbPath)
  // 执行数据迁移
  await migrateFromJSON()
}
/**
 * 获取数据库实例(单例模式)
 */
export function getDB(): Database.Database {
  if (!db) {
    throw new Error("Database not initialized. Call initDB() first.")
  }
  return db
}
/**
 * 关闭数据库连接
 */
export async function closeDB(): Promise<void> {
  if (db) {
    db.close()
    db = null
    console.log("Database connection closed")
  }
}
/**
 * 从 JSON 文件迁移用户数据到数据库
 */
async function migrateFromJSON(): Promise<void> {
  const jsonPath = path.join(process.cwd(), "data", "users.json")
  try {
    // 检查 JSON 文件是否存在
    await fs.access(jsonPath)
  } catch {
    // 文件不存在,无需迁移
    return
  }
  try {
    console.log("Found users.json, starting migration...")
    // 读取 JSON 文件
    const jsonContent = await fs.readFile(jsonPath, "utf-8")
    const users = JSON.parse(jsonContent) as Array<{
      email: string
      hash: string
      createdAt?: number
    }>
    if (!users || users.length === 0) {
      console.log("No users to migrate")
      await fs.rename(jsonPath, jsonPath + ".migrated")
      return
    }
    const database = getDB()
    const now = Date.now()
    // 使用事务批量插入
    const insert = database.prepare(`
      INSERT OR IGNORE INTO users (email, password_hash, username, created_at, updated_at)
      VALUES (?, ?, ?, ?, ?)
    `)
    const migrateMany = database.transaction((usersToMigrate: typeof users) => {
      for (const user of usersToMigrate) {
        // 从邮箱生成默认用户名(邮箱@前面的部分)
        const username = user.email.split("@")[0]
        const createdAt = user.createdAt || now
        insert.run(user.email, user.hash, username, createdAt, now)
      }
    })
    migrateMany(users)
    console.log(`Successfully migrated ${users.length} users from JSON to database`)
    // 重命名 JSON 文件以标记已迁移
    await fs.rename(jsonPath, jsonPath + ".migrated")
    console.log("Renamed users.json to users.json.migrated")
  } catch (error) {
    console.error("Error during migration:", error)
    // 不抛出错误,允许应用继续运行
  }
}

--- FILE: lib\db\scheduler-service.ts ---

import { getDB } from "./database"
export interface ScheduledTask {
  id: number
  title: string
  cron_expression?: string | null
  execute_at?: number | null
  action_type: 'relay' | 'led'
  device_id?: number
  params: string // JSON string
  is_active: number // 1 or 0
  created_at: number
  updated_at: number
}
export interface CreateTaskDTO {
  title: string
  cron_expression?: string
  execute_at?: number
  action_type: 'relay' | 'led'
  device_id?: number
  params: any
}
export function createTask(data: CreateTaskDTO): ScheduledTask {
  const db = getDB()
  const now = Date.now()
  const stmt = db.prepare(`
    INSERT INTO scheduled_tasks (
      title, cron_expression, execute_at, action_type, device_id, params, is_active, created_at, updated_at
    ) VALUES (?, ?, ?, ?, ?, ?, 1, ?, ?)
  `)
  const info = stmt.run(
    data.title,
    data.cron_expression || null,
    data.execute_at || null,
    data.action_type,
    data.device_id || null,
    JSON.stringify(data.params),
    now,
    now
  )
  return getTaskById(info.lastInsertRowid as number)!
}
export function getTaskById(id: number): ScheduledTask | undefined {
  const db = getDB()
  return db.prepare("SELECT * FROM scheduled_tasks WHERE id = ?").get(id) as ScheduledTask | undefined
}
export function getAllTasks(): ScheduledTask[] {
  const db = getDB()
  return db.prepare("SELECT * FROM scheduled_tasks ORDER BY created_at DESC").all() as ScheduledTask[]
}
export function getActiveTasks(): ScheduledTask[] {
  const db = getDB()
  return db.prepare("SELECT * FROM scheduled_tasks WHERE is_active = 1").all() as ScheduledTask[]
}
export function deleteTask(id: number): void {
  const db = getDB()
  db.prepare("DELETE FROM scheduled_tasks WHERE id = ?").run(id)
}
export function updateTaskStatus(id: number, isActive: boolean): void {
  const db = getDB()
  db.prepare("UPDATE scheduled_tasks SET is_active = ?, updated_at = ? WHERE id = ?")
    .run(isActive ? 1 : 0, Date.now(), id)
}

--- FILE: lib\db\security-service.ts ---

import { getDB, initDB } from "./database"
export interface BannedIP {
  id: number
  ip: string
  reason: string | null
  banned_by: string | null
  expires_at: number | null
  created_at: number
}
export async function getBannedIPs(): Promise<BannedIP[]> {
  await initDB()
  const db = getDB()
  return db.prepare("SELECT * FROM banned_ips ORDER BY created_at DESC").all() as BannedIP[]
}
export async function addBannedIP(ip: string, reason?: string, bannedBy?: string, expiresAt?: number): Promise<void> {
  await initDB()
  const db = getDB()
  const now = Date.now()
  db.prepare(`
    INSERT INTO banned_ips (ip, reason, banned_by, expires_at, created_at)
    VALUES (?, ?, ?, ?, ?)
  `).run(ip, reason || null, bannedBy || 'system', expiresAt || null, now)
}
export async function removeBannedIP(ip: string): Promise<void> {
  await initDB()
  const db = getDB()
  db.prepare("DELETE FROM banned_ips WHERE ip = ?").run(ip)
}
export async function isIPBanned(ip: string): Promise<boolean> {
  const details = await getBanDetails(ip)
  return !!details
}
export async function getBanDetails(ip: string): Promise<BannedIP | null> {
  await initDB()
  const db = getDB()
  const now = Date.now()
  // Clean up expired bans first (lazy cleanup)
  db.prepare("DELETE FROM banned_ips WHERE expires_at IS NOT NULL AND expires_at < ?").run(now)
  return db.prepare("SELECT * FROM banned_ips WHERE ip = ?").get(ip) as BannedIP | null
}
export interface AccessLog {
  id: number
  ip: string
  method: string
  path: string
  status: number
  duration: number
  user_id?: number
  user_agent?: string
  created_at: number
}
export async function recordAccessLog(data: Omit<AccessLog, 'id' | 'created_at'>): Promise<void> {
  // Fire and forget, don't block
  try {
    await initDB()
    const db = getDB()
    const now = Date.now()
    db.prepare(`
      INSERT INTO access_logs (ip, method, path, status, duration, user_id, user_agent, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).run(
      data.ip,
      data.method,
      data.path,
      data.status,
      data.duration,
      data.user_id || null,
      data.user_agent || null,
      now
    )
  } catch (e) {
    console.error("Failed to record access log:", e)
  }
}
export async function getAccessLogs(limit: number = 100): Promise<AccessLog[]> {
  await initDB()
  const db = getDB()
  return db.prepare("SELECT * FROM access_logs ORDER BY created_at DESC LIMIT ?").all(limit) as AccessLog[]
}

--- FILE: lib\db\settings-service.ts ---

import { getDB, initDB } from "./database"
export interface RateLimitConfig {
  limit: number
  windowMs: number
  violationLimit: number // Before auto-ban
  banDuration: number // ms
}
export const DEFAULT_RATE_LIMIT_CONFIG: RateLimitConfig = {
  limit: 300,
  windowMs: 60 * 1000,
  violationLimit: 20,
  banDuration: 15 * 60 * 1000 // 15 minutes
}
export async function getRateLimitConfig(): Promise<RateLimitConfig> {
  await initDB()
  const db = getDB()
  const row = db.prepare("SELECT value FROM system_settings WHERE key = ?").get("rate_limit_config") as { value: string } | undefined
  if (!row) return DEFAULT_RATE_LIMIT_CONFIG
  try {
    return JSON.parse(row.value)
  } catch (e) {
    return DEFAULT_RATE_LIMIT_CONFIG
  }
}
export async function updateRateLimitConfig(config: RateLimitConfig): Promise<void> {
  await initDB()
  const db = getDB()
  const now = Date.now()
  db.prepare(`
    INSERT INTO system_settings (key, value, updated_at)
    VALUES (?, ?, ?)
    ON CONFLICT(key) DO UPDATE SET value = excluded.value, updated_at = excluded.updated_at
  `).run("rate_limit_config", JSON.stringify(config), now)
}

--- FILE: lib\db\ticket-service.ts ---

import { getDB } from "./database"
export interface LoginTicket {
  ticket: string
  jwt?: string
  created_at: number
}
// 清理过期 ticket (10分钟)
function cleanupTickets() {
  const db = getDB()
  const expireTime = Date.now() - 10 * 60 * 1000
  db.prepare("DELETE FROM login_tickets WHERE created_at < ?").run(expireTime)
}
export async function createTicket(ticket: string): Promise<void> {
  const db = getDB()
  cleanupTickets()
  db.prepare("INSERT INTO login_tickets (ticket, created_at) VALUES (?, ?)").run(ticket, Date.now())
}
export async function updateTicketWithJwt(ticket: string, jwt: string): Promise<void> {
  const db = getDB()
  db.prepare("UPDATE login_tickets SET jwt = ? WHERE ticket = ?").run(jwt, ticket)
}
export async function getTicket(ticket: string): Promise<LoginTicket | undefined> {
  const db = getDB()
  return db.prepare("SELECT * FROM login_tickets WHERE ticket = ?").get(ticket) as LoginTicket | undefined
}
export async function deleteTicket(ticket: string): Promise<void> {
  const db = getDB()
  db.prepare("DELETE FROM login_tickets WHERE ticket = ?").run(ticket)
}

--- FILE: lib\db\user-service.ts ---

import bcrypt from "bcryptjs"
import { getDB, initDB } from "./database"
// 确保数据库已初始化的 Promise
let dbInitPromise: Promise<void> | null = null
/**
 * 确保数据库已初始化
 */
async function ensureDB() {
  if (!dbInitPromise) {
    dbInitPromise = initDB()
  }
  await dbInitPromise
}
export type UserRole = 'user' | 'admin' | 'super_admin';
/**
 * 完整的用户数据模型(包含敏感字段)
 */
export interface User {
  id: number
  email: string
  password_hash: string
  username: string
  avatar_url: string | null
  role: UserRole
  permissions: string
  notification_settings: string
  wechat_openid?: string | null
  wechat_unionid?: string | null
  wework_userid?: string | null
  qq_openid?: string | null
  alipay_user_id?: string | null
  created_at: number
  updated_at: number
}
export interface UserPermissions {
  allowedControls?: string[];
  [key: string]: unknown;
}
export interface NotificationSettings {
  alerts: boolean;
  status: boolean;
  ai: boolean;
  updates: boolean;
  [key: string]: boolean;
}
/**
 * 公开的用户信息(移除敏感字段)
 */
export interface UserPublic {
  id: number
  email: string
  username: string
  avatar_url: string | null
  role: UserRole
  permissions: UserPermissions
  notification_settings: NotificationSettings
  created_at: number
}
/**
 * 创建用户的输入参数
 */
export interface CreateUserInput {
  email: string
  password: string
  username: string
  role?: UserRole
  permissions?: UserPermissions
  notification_settings?: NotificationSettings
}
/**
 * 更新用户的输入参数
 */
export interface UpdateUserInput {
  username?: string
  avatar_url?: string | null
  password?: string
  role?: UserRole
  permissions?: UserPermissions
  notification_settings?: NotificationSettings
}
/**
 * 将完整用户对象转换为公开用户信息
 * 移除敏感字段如 password_hash 和 updated_at
 */
export function toPublicUser(user: User): UserPublic {
  let permissions: UserPermissions = {};
  try {
    permissions = JSON.parse(user.permissions || '{}');
  } catch (e) {
    console.error('Failed to parse permissions:', e);
  }
  let notification_settings: NotificationSettings = {
    alerts: true,
    status: true,
    ai: false,
    updates: true,
  }
  try {
    const parsed = JSON.parse(user.notification_settings || '{}')
    notification_settings = { ...notification_settings, ...(parsed || {}) }
  } catch (e) {
    console.error('Failed to parse notification_settings:', e);
  }
  // Ensure role is a valid UserRole, default to 'user' if invalid/missing
  const role: UserRole = (['user', 'admin', 'super_admin'].includes(user.role)
    ? user.role
    : 'user') as UserRole;
  return {
    id: user.id,
    email: user.email,
    username: user.username,
    avatar_url: user.avatar_url,
    role: role,
    permissions: permissions,
    notification_settings,
    created_at: user.created_at,
  }
}
/**
 * 获取所有用户列表
 */
export async function getAllUsers(): Promise<UserPublic[]> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare('SELECT * FROM users ORDER BY created_at DESC')
  const users = stmt.all() as User[]
  return users.map(toPublicUser)
}
/**
 * 创建新用户
 * @param input 用户创建输入参数
 * @returns 创建的用户公开信息
 * @throws 如果邮箱已存在或数据库操作失败
 */
export async function createUser(input: CreateUserInput): Promise<UserPublic> {
  await ensureDB()
  const db = getDB()
  const now = Date.now()
  // 检查邮箱是否已存在
  const existingUser = await getUserByEmail(input.email)
  if (existingUser) {
    throw new Error("该邮箱已被注册")
  }
  // 哈希密码
  const password_hash = await bcrypt.hash(input.password, 10)
  const role = input.role || 'user';
  const permissions = JSON.stringify(input.permissions || {});
  const notification_settings = JSON.stringify(input.notification_settings || {
    alerts: true,
    status: true,
    ai: false,
    updates: true,
  })
  // 插入新用户
  const stmt = db.prepare(`
    INSERT INTO users (email, password_hash, username, role, permissions, notification_settings, created_at, updated_at)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
  `)
  try {
    const result = stmt.run(input.email, password_hash, input.username, role, permissions, notification_settings, now, now)
    const userId = result.lastInsertRowid as number
    // 获取创建的用户
    const user = await getUserById(userId)
    if (!user) {
      throw new Error("创建用户后无法获取用户信息")
    }
    return toPublicUser(user)
  } catch (error) {
    if (error instanceof Error && error.message.includes("UNIQUE constraint failed")) {
      throw new Error("该邮箱已被注册")
    }
    throw error
  }
}
/**
 * 通过邮箱查询用户
 * @param email 用户邮箱
 * @returns 用户对象或 null
 */
export async function getUserByEmail(email: string): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE email = ?
  `)
  const user = stmt.get(email) as User | undefined
  return user || null
}
export async function getUserByQQOpenId(openid: string): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE qq_openid = ?
  `)
  const user = stmt.get(openid) as User | undefined
  return user || null
}
/**
 * 通过ID查询用户
 * @param id 用户ID
 * @returns 用户对象或 null
 */
export async function getUserById(id: number): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE id = ?
  `)
  const user = stmt.get(id) as User | undefined
  return user || null
}
export async function getUserByWeChatOpenId(openid: string): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE wechat_openid = ?
  `)
  const user = stmt.get(openid) as User | undefined
  return user || null
}
export async function getUserByWeChatUnionId(unionid: string): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE wechat_unionid = ?
  `)
  const user = stmt.get(unionid) as User | undefined
  return user || null
}
export async function getUserByWeWorkUserId(userid: string): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE wework_userid = ?
  `)
  const user = stmt.get(userid) as User | undefined
  return user || null
}
/**
 * 更新用户信息
 * @param id 用户ID
 * @param input 更新输入参数
 * @returns 更新后的用户公开信息
 * @throws 如果用户不存在或数据库操作失败
 */
export async function updateUser(id: number, input: UpdateUserInput): Promise<UserPublic> {
  await ensureDB()
  const db = getDB()
  const now = Date.now()
  // 检查用户是否存在
  const existingUser = await getUserById(id)
  if (!existingUser) {
    throw new Error("用户不存在")
  }
  // 构建更新语句
  const updates: string[] = []
  const values: (string | number | null)[] = []
  if (input.username !== undefined) {
    updates.push("username = ?")
    values.push(input.username)
  }
  if (input.avatar_url !== undefined) {
    updates.push("avatar_url = ?")
    values.push(input.avatar_url)
  }
  if (input.password !== undefined) {
    const password_hash = await bcrypt.hash(input.password, 10)
    updates.push("password_hash = ?")
    values.push(password_hash)
  }
  if (input.role !== undefined) {
    updates.push("role = ?")
    values.push(input.role)
  }
  if (input.permissions !== undefined) {
    updates.push("permissions = ?")
    values.push(JSON.stringify(input.permissions))
  }
  if (updates.length === 0) {
    // 没有需要更新的字段,直接返回当前用户
    return toPublicUser(existingUser)
  }
  // 添加 updated_at
  updates.push("updated_at = ?")
  values.push(now)
  // 添加 WHERE 条件的 id
  values.push(id)
  const stmt = db.prepare(`
    UPDATE users SET ${updates.join(", ")} WHERE id = ?
  `)
  stmt.run(...values)
  // 获取更新后的用户
  const updatedUser = await getUserById(id)
  if (!updatedUser) {
    throw new Error("更新用户后无法获取用户信息")
  }
  return toPublicUser(updatedUser)
}
/**
 * 验证用户凭证(邮箱和密码)
 * @param email 用户邮箱
 * @param password 用户密码(明文)
 * @returns 验证成功返回用户公开信息,失败返回 null
 */
export async function verifyCredentials(
  email: string,
  password: string
): Promise<UserPublic | null> {
  await ensureDB()
  // 通过邮箱查询用户
  const user = await getUserByEmail(email)
  if (!user) {
    return null
  }
  // 验证密码
  const isValid = await bcrypt.compare(password, user.password_hash)
  if (!isValid) {
    return null
  }
  // 返回公开用户信息
  return toPublicUser(user)
}
export async function findOrCreateWeChatUser(params: {
  openid: string
  unionid?: string
  nickname?: string
  avatar?: string | null
}): Promise<UserPublic> {
  await ensureDB()
  const db = getDB()
  const now = Date.now()
  let existingUser: User | null = null
  if (params.unionid) {
    existingUser = await getUserByWeChatUnionId(params.unionid)
  }
  if (!existingUser) {
    existingUser = await getUserByWeChatOpenId(params.openid)
  }
  if (existingUser) {
    const updates: string[] = []
    const values: (string | number | null)[] = []
    if (params.nickname && params.nickname !== existingUser.username) {
      updates.push("username = ?")
      values.push(params.nickname)
    }
    if (params.avatar !== undefined && params.avatar !== existingUser.avatar_url) {
      updates.push("avatar_url = ?")
      values.push(params.avatar)
    }
    updates.push("updated_at = ?")
    values.push(now)
    values.push(existingUser.id)
    if (updates.length > 1) {
      const stmt = db.prepare(`
        UPDATE users SET ${updates.join(", ")} WHERE id = ?
      `)
      stmt.run(...values)
    }
    const updated = await getUserById(existingUser.id)
    if (!updated) {
      throw new Error("更新微信用户后无法获取用户信息")
    }
    return toPublicUser(updated)
  }
  const email = `wechat_${(params.unionid || params.openid)}@wx.local`
  const stmt = db.prepare(`
    INSERT INTO users (email, password_hash, username, avatar_url, wechat_openid, wechat_unionid, created_at, updated_at)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
  `)
  const result = stmt.run(
    email,
    "",
    params.nickname || "微信用户",
    params.avatar || null,
    params.openid,
    params.unionid || null,
    now,
    now
  )
  const newId = result.lastInsertRowid as number
  const created = await getUserById(newId)
  if (!created) {
    throw new Error("创建微信用户后无法获取用户信息")
  }
  return toPublicUser(created)
}
export async function findOrCreateWeWorkUser(params: {
  userid: string
  name?: string
  avatar?: string | null
  email?: string
}): Promise<UserPublic> {
  await ensureDB()
  const db = getDB()
  const now = Date.now()
  // 1. 尝试通过 wework_userid 查找
  let existingUser = await getUserByWeWorkUserId(params.userid)
  // 2. 如果没找到，但提供了 email，尝试通过 email 查找（用于关联已有账号）
  if (!existingUser && params.email) {
    existingUser = await getUserByEmail(params.email)
    // 如果找到了对应邮箱的用户，更新其 wework_userid
    if (existingUser && !existingUser.wework_userid) {
       const stmt = db.prepare(`UPDATE users SET wework_userid = ?, updated_at = ? WHERE id = ?`)
       stmt.run(params.userid, now, existingUser.id)
       // 重新获取最新数据
       existingUser = await getUserById(existingUser.id)
    }
  }
  if (existingUser) {
    const updates: string[] = []
    const values: (string | number | null)[] = []
    // 只有当现有用户名是默认格式时，或者没有头像时才更新
    // 避免覆盖用户自定义的资料
    if (params.name && (existingUser.username === `wework_${params.userid}` || !existingUser.username)) {
      updates.push("username = ?")
      values.push(params.name)
    }
    if (params.avatar && !existingUser.avatar_url) {
      updates.push("avatar_url = ?")
      values.push(params.avatar)
    }
    if (updates.length > 0) {
        updates.push("updated_at = ?")
        values.push(now)
        values.push(existingUser.id)
        const stmt = db.prepare(`
            UPDATE users SET ${updates.join(", ")} WHERE id = ?
        `)
        stmt.run(...values)
    }
    const updated = await getUserById(existingUser.id)
    if (!updated) {
      throw new Error("更新企业微信用户后无法获取用户信息")
    }
    return toPublicUser(updated)
  }
  // 创建新用户
  // 使用企业微信提供的邮箱，如果没有则生成一个虚拟邮箱
  const userEmail = params.email || `wework_${params.userid}@wework.local`
  const stmt = db.prepare(`
    INSERT INTO users (email, password_hash, username, avatar_url, wework_userid, created_at, updated_at)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `)
  try {
      const result = stmt.run(
        userEmail,
        "", // 无密码
        params.name || `企业微信用户`,
        params.avatar || null,
        params.userid,
        now,
        now
      )
      const newId = result.lastInsertRowid as number
      const created = await getUserById(newId)
      if (!created) {
        throw new Error("创建企业微信用户后无法获取用户信息")
      }
      return toPublicUser(created)
  } catch (error) {
     if (error instanceof Error && error.message.includes("UNIQUE constraint failed")) {
         // 极端情况：邮箱冲突（例如 generated email 冲突，或者 params.email 已被注册但未被上面查到？）
         // 这里简单处理：如果邮箱冲突，尝试追加随机后缀
         const retryEmail = params.email
             ? `conflict_${Date.now()}_${params.email}`
             : `wework_${params.userid}_${Date.now()}@wework.local`
          const retryStmt = db.prepare(`
            INSERT INTO users (email, password_hash, username, avatar_url, wework_userid, created_at, updated_at)
            VALUES (?, ?, ?, ?, ?, ?, ?)
          `)
          const retryResult = retryStmt.run(
            retryEmail,
            "",
            params.name || `企业微信用户`,
            params.avatar || null,
            params.userid,
            now,
            now
          )
          const newId = retryResult.lastInsertRowid as number
          const created = await getUserById(newId)
          if (!created) throw new Error("创建企业微信用户(重试)后无法获取用户信息")
          return toPublicUser(created)
     }
     throw error
  }
}
export async function findOrCreateQQUser(params: {
  openid: string
  nickname?: string
  avatar?: string | null
}): Promise<UserPublic> {
  await ensureDB()
  const db = getDB()
  const now = Date.now()
  let existingUser = await getUserByQQOpenId(params.openid)
  if (existingUser) {
    const updates: string[] = []
    const values: (string | number | null)[] = []
    if (params.nickname && params.nickname !== existingUser.username) {
      updates.push("username = ?")
      values.push(params.nickname)
    }
    if (params.avatar && params.avatar !== existingUser.avatar_url) {
      updates.push("avatar_url = ?")
      values.push(params.avatar)
    }
    if (updates.length > 0) {
      updates.push("updated_at = ?")
      values.push(now)
      values.push(existingUser.id)
      const stmt = db.prepare(`
        UPDATE users SET ${updates.join(", ")} WHERE id = ?
      `)
      stmt.run(...values)
    }
    const updated = await getUserById(existingUser.id)
    if (!updated) {
      throw new Error("更新QQ用户后无法获取用户信息")
    }
    return toPublicUser(updated)
  }
  const email = `qq_${params.openid}@qq.local`
  const stmt = db.prepare(`
    INSERT INTO users (email, password_hash, username, avatar_url, qq_openid, created_at, updated_at)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `)
  try {
    const result = stmt.run(
      email,
      "",
      params.nickname || `QQ用户`,
      params.avatar || null,
      params.openid,
      now,
      now
    )
    const newId = result.lastInsertRowid as number
    const created = await getUserById(newId)
    if (!created) {
      throw new Error("创建QQ用户后无法获取用户信息")
    }
    return toPublicUser(created)
  } catch (error) {
    throw error
  }
}
export async function getUserByAlipayUserId(userId: string): Promise<User | null> {
  await ensureDB()
  const db = getDB()
  const stmt = db.prepare(`
    SELECT * FROM users WHERE alipay_user_id = ?
  `)
  const user = stmt.get(userId) as User | undefined
  return user || null
}
export async function findOrCreateAlipayUser(params: {
  userId: string
  nickname?: string
  avatar?: string | null
}): Promise<UserPublic> {
  await ensureDB()
  const db = getDB()
  const now = Date.now()
  let existingUser = await getUserByAlipayUserId(params.userId)
  if (existingUser) {
    const updates: string[] = []
    const values: (string | number | null)[] = []
    if (params.nickname && params.nickname !== existingUser.username) {
      updates.push("username = ?")
      values.push(params.nickname)
    }
    if (params.avatar !== undefined && params.avatar !== existingUser.avatar_url) {
      updates.push("avatar_url = ?")
      values.push(params.avatar)
    }
    if (updates.length > 0) {
      updates.push("updated_at = ?")
      values.push(now)
      values.push(existingUser.id)
      const stmt = db.prepare(`
        UPDATE users SET ${updates.join(", ")} WHERE id = ?
      `)
      stmt.run(...values)
    }
    const updated = await getUserById(existingUser.id)
    if (!updated) {
      throw new Error("更新支付宝用户后无法获取用户信息")
    }
    return toPublicUser(updated)
  }
  const email = `alipay_${params.userId}@alipay.local`
  const stmt = db.prepare(`
    INSERT INTO users (email, password_hash, username, avatar_url, alipay_user_id, created_at, updated_at)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `)
  try {
    const result = stmt.run(
      email,
      "",
      params.nickname || "支付宝用户",
      params.avatar || null,
      params.userId,
      now,
      now
    )
    const newId = result.lastInsertRowid as number
    const created = await getUserById(newId)
    if (!created) {
      throw new Error("创建支付宝用户后无法获取用户信息")
    }
    return toPublicUser(created)
  } catch (error) {
    throw error
  }
}

--- FILE: lib\hooks\use-device-control.ts ---

/**
 * Custom Hook for Device Control
 *
 * Provides functions to send control commands to devices via HTTP API
 */
import { useState, useCallback } from 'react'
import { toast } from 'sonner'
export interface ControlCommand {
  type: 'relay' | 'led'
  relayNum?: number
  newState?: number
  led1?: number
  led2?: number
  led3?: number
  led4?: number
}
export interface ControlResponse {
  success: boolean
  message: string
  timestamp: number
}
export interface ControlStatus {
  loading: boolean
  error: string | null
  lastCommand: ControlCommand | null
}
export function useDeviceControl() {
  const [status, setStatus] = useState<ControlStatus>({
    loading: false,
    error: null,
    lastCommand: null
  })
  const sendCommand = useCallback(async (command: ControlCommand): Promise<boolean> => {
    setStatus({
      loading: true,
      error: null,
      lastCommand: command
    })
    try {
      console.log('[Control] Sending command:', command)
      const response = await fetch('/api/mqtt/control', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(command)
      })
      const result: ControlResponse = await response.json()
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'Failed to send command')
      }
      console.log('[Control] Command sent successfully:', result)
      setStatus({
        loading: false,
        error: null,
        lastCommand: command
      })
      return true
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error'
      console.error('[Control] Failed to send command:', errorMessage)
      // Auto-show toast for errors, especially permission issues
      toast.error(errorMessage)
      setStatus({
        loading: false,
        error: errorMessage,
        lastCommand: command
      })
      return false
    }
  }, [])
  const toggleRelay = useCallback(async (relayNum: number, currentState: number): Promise<boolean> => {
    const newState = currentState === 1 ? 0 : 1
    return sendCommand({
      type: 'relay',
      relayNum,
      newState
    })
  }, [sendCommand])
  const setLEDs = useCallback(async (led1: number, led2: number, led3: number, led4: number): Promise<boolean> => {
    return sendCommand({
      type: 'led',
      led1,
      led2,
      led3,
      led4
    })
  }, [sendCommand])
  return {
    status,
    sendCommand,
    toggleRelay,
    setLEDs
  }
}

--- FILE: lib\hooks\use-device-data.ts ---

/**
 * Custom Hook for Device Data via SSE
 *
 * Manages EventSource connection to receive real-time device data
 * from the MQTT backend via Server-Sent Events.
 *
 * Refactored to use DeviceContext to share a single connection across the app.
 */
import { useDeviceContext } from '@/lib/contexts/device-context'
// Re-export types for backward compatibility
export type { DeviceData, ConnectionStatus } from '@/lib/contexts/device-context'
export function useDeviceData() {
  return useDeviceContext()
}

--- FILE: lib\hooks\use-plant-growth.ts ---

import { useState, useEffect, useCallback } from 'react'
import type { PlantAnalysisResult } from '@/lib/types/plant-growth-types'
export function usePlantGrowth() {
    const [plantData, setPlantData] = useState<PlantAnalysisResult | null>(null)
    const [lastAnalyzed, setLastAnalyzed] = useState<number | null>(null)
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState<string | null>(null)
    const fetchPlantData = useCallback(async () => {
        try {
            setLoading(true)
            setError(null)
            const response = await fetch('/api/plant-growth')
            const data = await response.json()
            if (data.success) {
                setPlantData(data.data)
                setLastAnalyzed(data.lastAnalyzed)
            } else {
                setError(data.error || 'Failed to fetch plant data')
            }
        } catch (err: any) {
            setError(err.message || 'Network error')
        } finally {
            setLoading(false)
        }
    }, [])
    useEffect(() => {
        fetchPlantData()
        // Poll for updates every 30 seconds
        const interval = setInterval(fetchPlantData, 30000)
        return () => clearInterval(interval)
    }, [fetchPlantData])
    const refresh = useCallback(() => {
        return fetchPlantData()
    }, [fetchPlantData])
    return {
        plantData,
        lastAnalyzed,
        loading,
        error,
        refresh
    }
}

--- FILE: lib\hooks\use-weather.ts ---

/**
 * Custom Hook for Weather Data
 *
 * Fetches weather data from WeatherAPI.com using geolocation
 */
import { useState, useEffect } from 'react'
export interface WeatherDay {
  date: string
  day: {
    maxtemp_c: number
    mintemp_c: number
    avgtemp_c: number
    condition: {
      text: string
      icon: string
      code: number
    }
    maxwind_kph: number
    avghumidity: number
    totalprecip_mm: number
    daily_chance_of_rain: number
  }
}
export interface WeatherData {
  location: {
    name: string
    region: string
    country: string
    lat: number
    lon: number
    localtime: string
  }
  current: {
    temp_c: number
    condition: {
      text: string
      icon: string
      code: number
    }
    wind_kph: number
    wind_dir: string
    pressure_mb: number
    humidity: number
    uv: number
    vis_km: number
  }
  forecast: {
    forecastday: WeatherDay[]
  }
}
export function useWeather() {
  const [weatherData, setWeatherData] = useState<WeatherData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [location, setLocation] = useState<{ lat: number; lon: number } | null>(null)
  // Get user's geolocation
  useEffect(() => {
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setLocation({
            lat: position.coords.latitude,
            lon: position.coords.longitude
          })
        },
        (error) => {
          console.warn('[useWeather] Geolocation error:', error)
          // Continue without geolocation (will use default location)
          setLocation(null)
        }
      )
    }
  }, [])
  useEffect(() => {
    const fetchWeather = async () => {
      try {
        setLoading(true)
        setError(null)
        // Build URL with location if available
        let url = '/api/weather'
        if (location) {
          url += `?lat=${location.lat}&lon=${location.lon}`
        } else {
          // If no location (GPS denied/unavailable), ask API to try IP-based detection
          url += '?useIP=true'
        }
        const response = await fetch(url)
        if (!response.ok) {
          throw new Error('Failed to fetch weather data')
        }
        const data = await response.json()
        if (data.error) {
          throw new Error(data.error)
        }
        setWeatherData(data)
      } catch (err) {
        console.error('[useWeather] Error:', err)
        setError(err instanceof Error ? err.message : 'Unknown error')
      } finally {
        setLoading(false)
      }
    }
    fetchWeather()
    // Refresh weather data every 30 minutes
    const interval = setInterval(fetchWeather, 30 * 60 * 1000)
    return () => clearInterval(interval)
  }, [location])
  return { weatherData, loading, error }
}

--- FILE: lib\mqtt-config.ts ---

/**
 * MQTT Configuration Management Module
 *
 * This module handles MQTT configuration loading from environment variables,
 * validation, and provides type-safe configuration access.
 */
/**
 * MQTT Configuration Interface
 * Defines all required configuration parameters for MQTT connection
 */
export interface MQTTConfig {
  host: string
  port: number
  username: string
  password: string
  subscribeTopic: string
  publishTopic: string
  useSSL: boolean
  keepalive: number
  reconnectPeriod: number
}
/**
 * Default MQTT Configuration Values
 * Used as fallback when environment variables are not set
 */
const DEFAULT_CONFIG: Partial<MQTTConfig> = {
  port: 8883,
  useSSL: true,
  keepalive: 60,
  reconnectPeriod: 5000,
  subscribeTopic: 'meimefarm/basic_env_data',
  publishTopic: 'data/set'
}
/**
 * Get MQTT Configuration from Environment Variables
 *
 * Reads configuration from process.env and applies defaults where needed.
 *
 * @returns {MQTTConfig} Complete MQTT configuration object
 * @throws {Error} If required environment variables are missing
 */
export function getMQTTConfig(): MQTTConfig {
  const config: MQTTConfig = {
    host: process.env.MQTT_HOST || '',
    port: parseInt(process.env.MQTT_PORT || String(DEFAULT_CONFIG.port), 10),
    username: process.env.MQTT_USERNAME || '',
    password: process.env.MQTT_PASSWORD || '',
    subscribeTopic: process.env.MQTT_SUBSCRIBE_TOPIC || DEFAULT_CONFIG.subscribeTopic!,
    publishTopic: process.env.MQTT_PUBLISH_TOPIC || DEFAULT_CONFIG.publishTopic!,
    useSSL: process.env.MQTT_USE_SSL === 'true' || DEFAULT_CONFIG.useSSL!,
    keepalive: parseInt(process.env.MQTT_KEEPALIVE || String(DEFAULT_CONFIG.keepalive), 10),
    reconnectPeriod: parseInt(process.env.MQTT_RECONNECT_PERIOD || String(DEFAULT_CONFIG.reconnectPeriod), 10)
  }
  return config
}
/**
 * Validate MQTT Configuration
 *
 * Checks if all required fields are present and valid.
 * Validates data types and ranges for configuration values.
 *
 * @param {MQTTConfig} config - Configuration object to validate
 * @returns {boolean} True if configuration is valid
 * @throws {Error} If configuration is invalid, with detailed error message
 */
export function validateMQTTConfig(config: MQTTConfig): boolean {
  const errors: string[] = []
  // Validate required string fields
  if (!config.host || config.host.trim() === '') {
    errors.push('MQTT_HOST is required and cannot be empty')
  }
  if (!config.username || config.username.trim() === '') {
    errors.push('MQTT_USERNAME is required and cannot be empty')
  }
  if (!config.password || config.password.trim() === '') {
    errors.push('MQTT_PASSWORD is required and cannot be empty')
  }
  if (!config.subscribeTopic || config.subscribeTopic.trim() === '') {
    errors.push('MQTT_SUBSCRIBE_TOPIC is required and cannot be empty')
  }
  if (!config.publishTopic || config.publishTopic.trim() === '') {
    errors.push('MQTT_PUBLISH_TOPIC is required and cannot be empty')
  }
  // Validate port number
  if (isNaN(config.port) || config.port <= 0 || config.port > 65535) {
    errors.push('MQTT_PORT must be a valid port number (1-65535)')
  }
  // Validate keepalive
  if (isNaN(config.keepalive) || config.keepalive < 0) {
    errors.push('MQTT_KEEPALIVE must be a non-negative number')
  }
  // Validate reconnect period
  if (isNaN(config.reconnectPeriod) || config.reconnectPeriod < 0) {
    errors.push('MQTT_RECONNECT_PERIOD must be a non-negative number')
  }
  // Validate boolean
  if (typeof config.useSSL !== 'boolean') {
    errors.push('MQTT_USE_SSL must be a boolean value')
  }
  // If there are validation errors, throw with detailed message
  if (errors.length > 0) {
    throw new Error(`MQTT Configuration validation failed:\n${errors.join('\n')}`)
  }
  return true
}
/**
 * Get and Validate MQTT Configuration
 *
 * Convenience function that combines getMQTTConfig and validateMQTTConfig.
 * Use this function to get a validated configuration in one call.
 *
 * @returns {MQTTConfig} Validated MQTT configuration object
 * @throws {Error} If configuration is invalid
 */
export function getValidatedMQTTConfig(): MQTTConfig {
  const config = getMQTTConfig()
  validateMQTTConfig(config)
  return config
}

--- FILE: lib\mqtt-service.ts ---

/**
 * MQTT Service Module
 *
 * Singleton service that manages MQTT connection, message handling,
 * and provides interfaces for data subscription and control commands.
 */
import mqtt from 'mqtt'
import { MQTTConfig, getValidatedMQTTConfig } from './mqtt-config'
import { sendWeComNotification } from './notification-service'
/**
 * Device Data Interface
 * Represents the structure of data received from IoT devices
 */
export interface DeviceData {
  temperature: number      // Temperature (°C * 10)
  humidity: number         // Humidity (% * 10)
  light: number           // Light intensity (lux)
  co2: number             // CO2 concentration (ppm)
  earth_temp: number      // Soil temperature (°C * 10)
  earth_water: number     // Soil moisture (%)
  earth_ec: number        // EC value (μS/cm)
  earth_n: number         // Nitrogen (mg/kg)
  earth_p: number         // Phosphorus (mg/kg)
  earth_k: number         // Potassium (mg/kg)
  relay5: number          // Relay 5 state (0/1)
  relay6: number          // Relay 6 state (0/1)
  relay7: number          // Relay 7 state (0/1)
  relay8: number          // Relay 8 state (0/1)
  led1: number            // LED 1 brightness (0-255)
  led2: number            // LED 2 brightness (0-255)
  led3: number            // LED 3 brightness (0-255)
  led4: number            // LED 4 brightness (0-255)
  // Spectral Data
  channel1?: number       // 415 nm Violet
  channel2?: number       // 445 nm Blue
  channel3?: number       // 480 nm Cyan
  channel4?: number       // 515 nm Green
  channel5?: number       // 555 nm Yellow-Green
  channel6?: number       // 590 nm Yellow
  channel7?: number       // 630 nm Orange
  channel8?: number       // 680 nm Red
  channel9?: number       // NIR
  channel10?: number      // Clear
  channel11?: number      // Flicker
  timestamp?: number      // Timestamp when data was received
}
/**
 * Control Command Interface
 * Represents control commands to be sent to devices
 */
export interface ControlCommand {
  type: 'relay' | 'led'
  relayNum?: number       // Relay number (5-8)
  newState?: number       // New relay state (0/1)
  led1?: number           // LED 1 brightness (0-255)
  led2?: number           // LED 2 brightness (0-255)
  led3?: number           // LED 3 brightness (0-255)
  led4?: number           // LED 4 brightness (0-255)
}
/**
 * Data Listener Callback Type
 */
type DataListener = (data: DeviceData) => void
/**
 * MQTTService Singleton Class
 *
 * Manages MQTT connection lifecycle, message handling, and provides
 * interfaces for subscribing to device data and sending control commands.
 */
export class MQTTService {
  private static instance: MQTTService
  private client: mqtt.MqttClient | null = null
  private config: MQTTConfig
  private latestData: DeviceData | null = null
  private dataListeners: Set<DataListener> = new Set()
  private lastNotificationTime: Map<string, number> = new Map()
  private readonly NOTIFICATION_COOLDOWN = 30 * 60 * 1000 // 30 minutes
  private readonly ALERT_TIMEZONE = process.env.ALERT_TIMEZONE || 'Asia/Shanghai'
  /**
   * Private constructor to enforce singleton pattern
   */
  private constructor() {
    this.config = getValidatedMQTTConfig()
  }
  /**
   * Get singleton instance of MQTTService
   *
   * @returns {MQTTService} The singleton instance
   */
  public static getInstance(): MQTTService {
    if (!MQTTService.instance) {
      MQTTService.instance = new MQTTService()
    }
    return MQTTService.instance
  }
  /**
   * Connect to MQTT Broker
   *
   * Establishes TLS/SSL connection to the MQTT broker using configured credentials.
   * Sets up event handlers for connection lifecycle events.
   *
   * @returns {Promise<void>} Resolves when connection is established
   * @throws {Error} If connection fails after retries
   */
  public async connect(): Promise<void> {
    if (this.client && this.client.connected) {
      this.log('INFO', 'MQTT client already connected')
      return
    }
    return new Promise((resolve, reject) => {
      try {
        const protocol = this.config.useSSL ? 'mqtts' : 'mqtt'
        const brokerUrl = `${protocol}://${this.config.host}:${this.config.port}`
        this.log('INFO', `Connecting to MQTT broker: ${brokerUrl}`)
        // Create MQTT client with connection options
        this.client = mqtt.connect(brokerUrl, {
          username: this.config.username,
          password: this.config.password,
          keepalive: this.config.keepalive,
          reconnectPeriod: this.config.reconnectPeriod,
          clean: true,
          clientId: `mqtt_service_${Math.random().toString(16).slice(2, 10)}`
        })
        // Connection successful event
        this.client.on('connect', () => {
          this.log('INFO', 'MQTT connection established successfully')
          const topics = [
            this.config.subscribeTopic,
            'meimefarm/spectral/all',
            'meimefarm/sensor/node0701'
          ]
          // Subscribe to device data topics
          this.client!.subscribe(topics, { qos: 1 }, (err) => {
            if (err) {
              this.log('ERROR', `Failed to subscribe to topics: ${topics.join(', ')}`, err)
            } else {
              this.log('INFO', `Subscribed to topics: ${topics.join(', ')}`)
            }
          })
          resolve()
        })
        // Message received event
        this.client.on('message', (topic, payload) => {
          this.handleMessage(topic, payload)
        })
        // Connection error event
        this.client.on('error', (error) => {
          this.log('ERROR', `MQTT connection error: ${error.message}`, error)
          reject(error)
        })
        // Connection closed event
        this.client.on('close', () => {
          this.log('INFO', 'MQTT connection closed')
        })
        // Reconnect event
        this.client.on('reconnect', () => {
          this.log('INFO', 'MQTT attempting to reconnect...')
        })
        // Offline event
        this.client.on('offline', () => {
          this.log('WARN', 'MQTT client is offline')
        })
      } catch (error) {
        this.log('ERROR', `Failed to create MQTT client: ${error}`, error)
        reject(error)
      }
    })
  }
  /**
   * Disconnect from MQTT Broker
   *
   * Gracefully closes the MQTT connection and cleans up resources.
   */
  public disconnect(): void {
    if (this.client) {
      this.log('INFO', 'Disconnecting from MQTT broker')
      this.client.end(false, {}, () => {
        this.log('INFO', 'MQTT client disconnected')
      })
      this.client = null
    }
  }
  /**
   * Check if MQTT client is connected
   *
   * @returns {boolean} True if connected, false otherwise
   */
  public isConnected(): boolean {
    return this.client !== null && this.client.connected
  }
  /**
   * Get latest cached device data
   *
   * @returns {DeviceData | null} Latest device data or null if no data received yet
   */
  public getLatestData(): DeviceData | null {
    return this.latestData
  }
  /**
   * Subscribe to device data updates
   *
   * Registers a callback function that will be called whenever new device data arrives.
   * Returns an unsubscribe function to remove the listener.
   *
   * @param {DataListener} callback - Function to call when new data arrives
   * @returns {Function} Unsubscribe function to remove the listener
   */
  public subscribeToData(callback: DataListener): () => void {
    this.dataListeners.add(callback)
    this.log('INFO', `Data listener added. Total listeners: ${this.dataListeners.size}`)
    // Return unsubscribe function
    return () => {
      this.dataListeners.delete(callback)
      this.log('INFO', `Data listener removed. Total listeners: ${this.dataListeners.size}`)
    }
  }
  /**
   * Send control command to device
   *
   * Constructs device protocol payload and publishes to MQTT broker.
   *
   * @param {ControlCommand} command - Control command to send
   * @returns {Promise<void>} Resolves when command is published
   * @throws {Error} If client is not connected or publish fails
   */
  public async sendControlCommand(command: ControlCommand): Promise<void> {
    if (!this.isConnected()) {
      throw new Error('MQTT client is not connected')
    }
    try {
      const payload = this.buildControlPayload(command)
      const payloadString = JSON.stringify(payload)
      this.log('INFO', `Sending control command: ${command.type}`, command)
      return new Promise((resolve, reject) => {
        this.client!.publish(
          this.config.publishTopic,
          payloadString,
          { qos: 1 },
          (error) => {
            if (error) {
              this.log('ERROR', `Failed to publish control command: ${error.message}`, error)
              reject(error)
            } else {
              this.log('INFO', `Control command published successfully`)
              resolve()
            }
          }
        )
      })
    } catch (error) {
      this.log('ERROR', `Error building control command: ${error}`, error)
      throw error
    }
  }
  /**
   * Build control payload according to device protocol
   *
   * Constructs the rw_prot structure with appropriate node mappings.
   *
   * @param {ControlCommand} command - Control command
   * @returns {object} Device protocol payload
   */
  private buildControlPayload(command: ControlCommand): object {
    const id = Math.random().toString(36).substring(2, 15)
    if (command.type === 'relay') {
      // Validate relay command
      if (command.relayNum === undefined || command.newState === undefined) {
        throw new Error('Relay command requires relayNum and newState')
      }
      if (command.relayNum < 5 || command.relayNum > 8) {
        throw new Error('Relay number must be between 5 and 8')
      }
      if (command.newState !== 0 && command.newState !== 1) {
        throw new Error('Relay state must be 0 or 1')
      }
      // Map relay numbers to node IDs (relay5->node0601, relay6->node0602, etc.)
      const nodeNum = command.relayNum - 4 // relay5->1, relay6->2, relay7->3, relay8->4
      const nodeName = `node060${nodeNum}`
      return {
        rw_prot: {
          Ver: '1.0.1',
          dir: 'down',
          id,
          w_data: [
            { name: nodeName, value: String(command.newState) }
          ]
        }
      }
    } else if (command.type === 'led') {
      // Validate LED command
      const led1 = command.led1 !== undefined ? command.led1 : 0
      const led2 = command.led2 !== undefined ? command.led2 : 0
      const led3 = command.led3 !== undefined ? command.led3 : 0
      const led4 = command.led4 !== undefined ? command.led4 : 0
      // Validate LED values (0-255)
      const validateLED = (value: number, name: string) => {
        if (value < 0 || value > 255) {
          throw new Error(`${name} must be between 0 and 255`)
        }
      }
      validateLED(led1, 'LED1')
      validateLED(led2, 'LED2')
      validateLED(led3, 'LED3')
      validateLED(led4, 'LED4')
      // Map LEDs to node IDs (led1->node0501, led2->node0502, etc.)
      return {
        rw_prot: {
          Ver: '1.0.1',
          dir: 'down',
          id,
          w_data: [
            { name: 'node0501', value: String(led1) },
            { name: 'node0502', value: String(led2) },
            { name: 'node0503', value: String(led3) },
            { name: 'node0504', value: String(led4) }
          ]
        }
      }
    } else {
      throw new Error(`Unknown command type: ${command.type}`)
    }
  }
  /**
   * Handle incoming MQTT message
   *
   * Parses JSON payload, validates and transforms data, updates cache,
   * and notifies all registered listeners.
   *
   * @param {string} topic - MQTT topic
   * @param {Buffer} payload - Message payload
   */
  private handleMessage(topic: string, payload: Buffer): void {
    try {
      const message = payload.toString()
      // Parse JSON data
      const rawData = JSON.parse(message)
      // Initialize latestData if null
      if (!this.latestData) {
        this.latestData = {
          temperature: 0, humidity: 0, light: 0, co2: 0,
          earth_temp: 0, earth_water: 0, earth_ec: 0,
          earth_n: 0, earth_p: 0, earth_k: 0,
          relay5: 0, relay6: 0, relay7: 0, relay8: 0,
          led1: 0, led2: 0, led3: 0, led4: 0
        }
      }
      // Update data based on topic or content
      if (topic === 'meimefarm/spectral/all' || topic === 'meimefarm/sensor/node0701') {
        // Check if spectral_data is nested in the payload
        const spectralData = rawData.spectral_data || rawData
        // Spectral or specific node data
        this.latestData = {
          ...this.latestData,
          channel1: this.parseNumber(spectralData.channel1, this.latestData.channel1 || 0),
          channel2: this.parseNumber(spectralData.channel2, this.latestData.channel2 || 0),
          channel3: this.parseNumber(spectralData.channel3, this.latestData.channel3 || 0),
          channel4: this.parseNumber(spectralData.channel4, this.latestData.channel4 || 0),
          channel5: this.parseNumber(spectralData.channel5, this.latestData.channel5 || 0),
          channel6: this.parseNumber(spectralData.channel6, this.latestData.channel6 || 0),
          channel7: this.parseNumber(spectralData.channel7, this.latestData.channel7 || 0),
          channel8: this.parseNumber(spectralData.channel8, this.latestData.channel8 || 0),
          channel9: this.parseNumber(spectralData.channel9, this.latestData.channel9 || 0),
          channel10: this.parseNumber(spectralData.channel10, this.latestData.channel10 || 0),
          channel11: this.parseNumber(spectralData.channel11, this.latestData.channel11 || 0),
          timestamp: Date.now()
        }
      } else {
        // Basic Env Data
        this.latestData = {
          ...this.latestData,
          temperature: this.parseNumber(rawData.temperature, this.latestData.temperature),
          humidity: this.parseNumber(rawData.humidity, this.latestData.humidity),
          light: this.parseNumber(rawData.light, this.latestData.light),
          co2: this.parseNumber(rawData.co2, this.latestData.co2),
          earth_temp: this.parseNumber(rawData.earth_temp, this.latestData.earth_temp),
          earth_water: this.parseNumber(rawData.earth_water, this.latestData.earth_water),
          earth_ec: this.parseNumber(rawData.earth_ec, this.latestData.earth_ec),
          earth_n: this.parseNumber(rawData.earth_n, this.latestData.earth_n),
          earth_p: this.parseNumber(rawData.earth_p, this.latestData.earth_p),
          earth_k: this.parseNumber(rawData.earth_k, this.latestData.earth_k),
          relay5: this.parseNumber(rawData.relay5, this.latestData.relay5),
          relay6: this.parseNumber(rawData.relay6, this.latestData.relay6),
          relay7: this.parseNumber(rawData.relay7, this.latestData.relay7),
          relay8: this.parseNumber(rawData.relay8, this.latestData.relay8),
          led1: this.parseNumber(rawData.led1, this.latestData.led1),
          led2: this.parseNumber(rawData.led2, this.latestData.led2),
          led3: this.parseNumber(rawData.led3, this.latestData.led3),
          led4: this.parseNumber(rawData.led4, this.latestData.led4),
          timestamp: Date.now()
        }
        // Check for critical anomalies and send notifications
        // Only check thresholds when env data is updated to avoid false alarms on initial 0s
        this.checkThresholds(this.latestData)
      }
      // Notify all listeners
      this.dataListeners.forEach(listener => {
        try {
          listener(this.latestData!)
        } catch (error) {
          this.log('ERROR', `Error in data listener: ${error}`, error)
        }
      })
      this.log('INFO', `Processed message from ${topic}`)
    } catch (error) {
      this.log('ERROR', `Failed to process MQTT message from ${topic}: ${error}`, error)
    }
  }
  /**
   * Check data against critical thresholds and send notifications
   *
   * @param {DeviceData} data - The device data to check
   */
  private async checkThresholds(data: DeviceData): Promise<void> {
    const now = Date.now()
    const alerts: string[] = []
    // Temperature (High > 40°C, Low < 0°C)
    const temp = data.temperature / 10
    if (temp > 40) {
      alerts.push(` **温度过高**: ${temp.toFixed(1)}°C\n> 阈值 > 40°C\n> 建议：检查通风设备，开启降温系统。`)
    } else if (temp < 0) {
      alerts.push(` **温度过低**: ${temp.toFixed(1)}°C\n> 阈值 < 0°C\n> 建议：检查加热设备，防止冻害。`)
    }
    // Humidity (Low < 20%)
    const humidity = data.humidity / 10
    if (humidity < 20) {
      alerts.push(` **湿度过低**: ${humidity.toFixed(1)}%\n> 阈值 < 20%\n> 建议：开启加湿设备或喷灌系统。`)
    }
    // CO2 (High > 3000 ppm)
    if (data.co2 > 3000) {
      alerts.push(` **CO₂浓度过高**: ${data.co2} ppm\n> 阈值 > 3000 ppm\n> 建议：加强通风换气。`)
    }
    // Light (Low < 1200 lux during daytime 8:00-17:00)
    const hourStr = new Intl.DateTimeFormat('zh-CN', { hour: '2-digit', hourCycle: 'h23', timeZone: this.ALERT_TIMEZONE }).format(new Date(now))
    const hour = parseInt(hourStr, 10)
    if (hour >= 8 && hour < 17) {
      if (data.light < 1200) {
        alerts.push(` **光照不足**: ${data.light} lux\n> 日间阈值 < 1200 lux\n> 建议：检查补光灯状态或清理遮挡物。`)
      }
    }
    // Soil Moisture (Low < 10%)
    const soilMoisture = data.earth_water
    if (soilMoisture < 10) {
      alerts.push(` **土壤缺水**: ${soilMoisture.toFixed(1)}%\n> 阈值 < 10%\n> 建议：立即启动灌溉系统。`)
    }
    // Sensor Fault Detection (Value is 0)
    const zeroMetrics: string[] = []
    if (data.humidity === 0) zeroMetrics.push('湿度')
    if (data.co2 === 0) zeroMetrics.push('CO₂')
    if (data.earth_water === 0) zeroMetrics.push('土壤水分')
    if (data.earth_ec === 0) zeroMetrics.push('土壤EC')
    if (data.earth_n === 0) zeroMetrics.push('土壤氮')
    if (data.earth_p === 0) zeroMetrics.push('土壤磷')
    if (data.earth_k === 0) zeroMetrics.push('土壤钾')
    if (zeroMetrics.length > 0) {
      alerts.push(` **传感器异常**: 检测到0值\n> 涉及指标: ${zeroMetrics.join(', ')}\n> 建议：检查传感器连接线或电源。`)
    }
    // Consolidate and debounce alerts
    if (alerts.length > 0) {
      // Check global cooldown for ANY alert to prevent spamming
      const globalCooldownKey = 'global_alert_cooldown'
      const lastGlobalSent = this.lastNotificationTime.get(globalCooldownKey) || 0
      // If we sent ANY alert recently (e.g. within 5 mins), hold off unless it's been a while
      // But we also want to make sure we don't miss critical distinct alerts forever.
      // Strategy: Consolidate all current alerts into one message.
      // Send this consolidated message only if cooldown passed.
      if (now - lastGlobalSent > this.NOTIFICATION_COOLDOWN) {
        try {
          const timeText = new Intl.DateTimeFormat('zh-CN', { timeZone: this.ALERT_TIMEZONE, hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(new Date(now))
          const title = ` **环境监控告警汇总** (${timeText})`
          const body = alerts.join('\n\n---\n\n')
          const fullMessage = `${title}\n\n${body}`
          await sendWeComNotification(fullMessage, 'markdown')
          this.lastNotificationTime.set(globalCooldownKey, now)
          this.log('INFO', `Sent consolidated WeCom notification with ${alerts.length} alerts`)
        } catch (error) {
          this.log('ERROR', `Failed to send notification: ${error}`)
        }
      }
    }
  }
  /**
   * Parse number from raw data with fallback
   *
   * @param {any} value - Raw value to parse
   * @param {number} defaultValue - Default value if parsing fails
   * @returns {number} Parsed number or default value
   */
  private parseNumber(value: any, defaultValue: number): number {
    const parsed = Number(value)
    return isNaN(parsed) ? defaultValue : parsed
  }
  /**
   * Log message with structured format
   *
   * @param {string} level - Log level (INFO, WARN, ERROR)
   * @param {string} message - Log message
   * @param {any} data - Optional additional data
   */
  private log(level: 'INFO' | 'WARN' | 'ERROR', message: string, data?: any): void {
    const timestamp = new Date().toISOString()
    const logEntry = {
      timestamp,
      level,
      component: 'MQTTService',
      message,
      ...(data && { data })
    }
    if (level === 'ERROR') {
      console.error(JSON.stringify(logEntry))
    } else if (level === 'WARN') {
      console.warn(JSON.stringify(logEntry))
    } else {
      console.log(JSON.stringify(logEntry))
    }
  }
}

--- FILE: lib\notification-service.ts ---

/**
 * Notification Service
 * Handles sending notifications to external services like Enterprise WeChat (WeCom).
 */
const WECOM_WEBHOOK_URL = 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b2d8ef10-c258-4393-b31a-cef018ebe7d0';
interface WeComMessage {
  msgtype: 'text' | 'markdown';
  text?: {
    content: string;
    mentioned_list?: string[];
    mentioned_mobile_list?: string[];
  };
  markdown?: {
    content: string;
  };
}
/**
 * Send a message to Enterprise WeChat via Webhook
 * @param content The message content
 * @param type The message type ('text' or 'markdown')
 */
export async function sendWeComNotification(content: string, type: 'text' | 'markdown' = 'markdown'): Promise<void> {
  try {
    const payload: WeComMessage = {
      msgtype: type,
      [type]: {
        content: content
      }
    };
    const response = await fetch(WECOM_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Failed to send WeCom notification:', response.status, errorText);
    } else {
      // const responseData = await response.json();
      // console.log('WeCom notification sent:', responseData);
    }
  } catch (error) {
    console.error('Error sending WeCom notification:', error);
  }
}

--- FILE: lib\rate-limit.ts ---

import { NextRequest } from "next/server";
interface RateLimitConfig {
  limit: number;
  windowMs: number;
  autoBan?: boolean;
}
const trackers = new Map<string, { count: number; expiresAt: number; violationCount: number }>();
const bannedIPs = new Map<string, number>(); // IP -> ban expires at
// Simple in-memory banned cache to avoid hitting DB on every request in middleware
// In a real production app, this should be synced with Redis/DB
const BAN_DURATION = 24 * 60 * 60 * 1000; // 24 hours
const CLEANUP_INTERVAL = 5 * 60 * 1000; // 5 minutes
let lastCleanup = Date.now();
/**
 * Get Client IP from request headers (Cloudflare/CDN compatible)
 */
export function getClientIp(req: NextRequest): string {
  // Cloudflare
  const cfIp = req.headers.get("cf-connecting-ip");
  if (cfIp) return cfIp;
  // Standard X-Forwarded-For
  const forwardedFor = req.headers.get("x-forwarded-for");
  if (forwardedFor) {
    return forwardedFor.split(",")[0].trim();
  }
  // Nginx Real IP
  const realIp = req.headers.get("x-real-ip");
  if (realIp) return realIp;
  return "unknown-ip";
}
export function resetIp(ip: string) {
  bannedIPs.delete(ip);
  trackers.delete(ip);
}
/**
 * Basic in-memory rate limiter with Auto-Ban support
 */
export interface ExtendedRateLimitConfig extends RateLimitConfig {
  violationLimit?: number;
  banDuration?: number;
}
export function rateLimit(req: NextRequest, config: ExtendedRateLimitConfig = { limit: 300, windowMs: 60 * 1000, autoBan: false }) {
  const now = Date.now();
  // Lazy Cleanup: Run cleanup periodically to prevent memory leaks
  if (now - lastCleanup > CLEANUP_INTERVAL) {
    lastCleanup = now;
    // Cleanup expired trackers
    for (const [key, record] of trackers.entries()) {
      if (now > record.expiresAt) {
        trackers.delete(key);
      }
    }
    // Cleanup expired bans
    for (const [key, expiresAt] of bannedIPs.entries()) {
      if (now > expiresAt) {
        bannedIPs.delete(key);
      }
    }
  }
  const ip = getClientIp(req);
  // 1. Check if already banned locally
  const banExpires = bannedIPs.get(ip);
  if (banExpires && now < banExpires) {
    return { success: false, banned: true, newBan: false };
  } else if (banExpires) {
    bannedIPs.delete(ip); // Ban expired
  }
  // 2. Get tracking record
  let record = trackers.get(ip);
  // 3. Initialize or Reset if window expired
  if (!record || now > record.expiresAt) {
    record = { count: 1, expiresAt: now + config.windowMs, violationCount: record?.violationCount || 0 };
    trackers.set(ip, record);
    return { success: true };
  }
  // 4. Increment count
  record.count++;
  // 5. Check limit
  if (record.count > config.limit) {
    // Increment violation count
    record.violationCount++;
    // Auto-ban logic
    const violationLimit = config.violationLimit || 5;
    const banDuration = config.banDuration || BAN_DURATION;
    if (config.autoBan && record.violationCount >= violationLimit) {
      bannedIPs.set(ip, now + banDuration);
      return { success: false, banned: true, newBan: true };
    }
    return { success: false };
  }
  return { success: true };
}

--- FILE: lib\scheduler\runner.ts ---

import cron from "node-cron"
import type { ScheduledTask as CronScheduledTask } from "node-cron"
import { getActiveTasks, deleteTask, ScheduledTask } from "@/lib/db/scheduler-service"
import { MQTTService } from "@/lib/mqtt-service"
import { getValidatedMQTTConfig } from "@/lib/mqtt-config"
// In-memory storage for running jobs
const jobs: Map<number, CronScheduledTask | NodeJS.Timeout> = new Map()
export class SchedulerRunner {
  private static instance: SchedulerRunner
  private isInitialized = false
  private constructor() {}
  public static getInstance(): SchedulerRunner {
    if (!SchedulerRunner.instance) {
      SchedulerRunner.instance = new SchedulerRunner()
    }
    return SchedulerRunner.instance
  }
  public async init() {
    if (this.isInitialized) return
    this.isInitialized = true
    console.log("[Scheduler] Initializing...")
    await this.refreshTasks()
    console.log("[Scheduler] Started")
  }
  public async refreshTasks() {
    // Stop all existing jobs
    this.stopAll()
    // Fetch active tasks
    const tasks = getActiveTasks()
    console.log(`[Scheduler] Loaded ${tasks.length} active tasks`)
    const mqtt = MQTTService.getInstance()
    // Ensure MQTT is connected
    if (!mqtt.isConnected()) {
       console.log("[Scheduler] Connecting to MQTT...")
       try {
         await mqtt.connect()
       } catch (e) {
         console.error("[Scheduler] Failed to connect to MQTT during init, but continuing to schedule tasks:", e)
       }
    }
    for (const task of tasks) {
      this.scheduleTask(task)
    }
  }
  private stopAll() {
    for (const [id, job] of jobs.entries()) {
      if ('stop' in job) {
        job.stop() // Cron job
      } else {
        clearTimeout(job) // Timeout
      }
    }
    jobs.clear()
  }
  private scheduleTask(task: ScheduledTask) {
    if (task.cron_expression) {
      // Cron Task
      if (!cron.validate(task.cron_expression)) {
        console.error(`[Scheduler] Invalid cron expression for task ${task.id}: ${task.cron_expression}`)
        return
      }
      const job = cron.schedule(task.cron_expression, () => {
        this.executeTask(task)
      })
      jobs.set(task.id, job)
      console.log(`[Scheduler] Scheduled cron task ${task.id}: ${task.title} (${task.cron_expression})`)
    } else if (task.execute_at) {
      // One-time Task
      const now = Date.now()
      const delay = task.execute_at - now
      if (delay <= 0) {
        console.log(`[Scheduler] Task ${task.id} is in the past, executing immediately if within reasonable window (e.g. 1 min)`)
        if (delay > -60000) {
           this.executeTask(task)
        } else {
           // Mark as expired? Or just delete?
           deleteTask(task.id)
        }
        return
      }
      const timeout = setTimeout(() => {
        this.executeTask(task)
        // Cleanup after run
        deleteTask(task.id)
        jobs.delete(task.id)
      }, delay)
      jobs.set(task.id, timeout)
      console.log(`[Scheduler] Scheduled one-time task ${task.id}: ${task.title} in ${Math.round(delay/1000)}s`)
    }
  }
  private async executeTask(task: ScheduledTask) {
    console.log(`[Scheduler] Executing task ${task.id}: ${task.title}`)
    const mqtt = MQTTService.getInstance()
    try {
      // Ensure MQTT is connected
      if (!mqtt.isConnected()) {
         console.log("[Scheduler] MQTT not connected, attempting to connect...")
         await mqtt.connect()
      }
      let params: any
      try {
        params = typeof task.params === 'string' ? JSON.parse(task.params) : task.params
      } catch (e) {
        console.error(`[Scheduler] Failed to parse params for task ${task.id}:`, task.params)
        return
      }
      console.log(`[Scheduler] Task params:`, params)
      let command: any = {}
      if (task.action_type === 'relay') {
        if (params.value === undefined) throw new Error("Missing 'value' in relay task params")
        command = {
          type: 'relay',
          relayNum: task.device_id,
          newState: params.value
        }
      } else if (task.action_type === 'led') {
        command = {
          type: 'led',
          led1: params.r || 0,
          led2: params.g || 0,
          led3: params.b || 0,
          led4: params.w || 0
        }
      }
      console.log(`[Scheduler] Sending command:`, command)
      await mqtt.sendControlCommand(command)
      console.log(`[Scheduler] Task ${task.id} executed successfully`)
    } catch (e) {
      console.error(`[Scheduler] Failed to execute task ${task.id}:`, e)
    }
  }
}

--- FILE: lib\security.ts ---

import { NextRequest, NextResponse } from "next/server"
import { isIPBanned, recordAccessLog, getBanDetails } from "@/lib/db/security-service"
import { headers } from "next/headers"
/**
 * 获取请求的真实 IP
 */
export function getClientIp(req: NextRequest): string {
  // 优先从 headers 获取 (适用于反向代理/CDN)
  const forwardedFor = req.headers.get("x-forwarded-for")
  if (forwardedFor) {
    return forwardedFor.split(",")[0].trim()
  }
  // 其次尝试 NextRequest 的 ip 属性
  if ((req as any).ip) {
    return (req as any).ip
  }
  return "127.0.0.1"
}
/**
 * 安全检查结果
 */
interface SecurityCheckResult {
  allowed: boolean
  response?: NextResponse
  ip: string
}
/**
 * 执行安全检查（IP封禁检查 + 访问日志）
 * 注意：此函数不应在 Middleware 中调用（因为涉及数据库操作）
 */
export async function checkSecurity(req: NextRequest, userId?: number): Promise<SecurityCheckResult> {
  const start = Date.now()
  const ip = getClientIp(req)
  const method = req.method
  const path = req.nextUrl.pathname
  const userAgent = req.headers.get("user-agent") || ""
  // 1. 检查 IP 是否被封禁
  const banDetails = await getBanDetails(ip)
  if (banDetails) {
    // 记录被拒绝的访问
    await recordAccessLog({
      ip,
      method,
      path,
      status: 403,
      duration: Date.now() - start,
      user_id: userId,
      user_agent: userAgent
    })
    return {
      allowed: false,
      ip,
      response: NextResponse.json(
        {
          error: "Access Denied: Your IP has been banned.",
          reason: banDetails.reason || undefined
        },
        { status: 403 }
      )
    }
  }
  // 2. 记录正常访问 (异步，不阻塞)
  // 为了性能，可以考虑只记录写操作或关键路径，但用户要求“记录每个访问IP”，所以暂时全部记录
  // 但为了防止日志爆炸，建议只对 API 请求记录，或者由调用方决定
  // 这里我们只返回 info，由调用方决定何时调用 recordAccessLog 完成记录（通常在响应发送后或处理完后）
  // 实际上，为了简化，我们在 checkSecurity 内部只做检查。
  // 日志记录最好结合响应状态码，所以在 API handler 结束时记录更准确。
  // 但 Next.js App Router 很难在 handler 结束后统一 hook。
  // 所以我们在 checkSecurity 记录 "Request Started" 或者由调用者负责记录。
  // 妥协方案：在此处记录，状态码暂时设为 0 (Processing)，或者由调用者传入最终状态。
  // 鉴于用户需求是“记录访问IP”，我们在 checkSecurity 中记录一次即可。
  // 只有非 GET 请求或关键路径才记录详细日志？
  // 用户说 "记录每个访问的ip"，所以我们记录。
  return {
    allowed: true,
    ip
  }
}
/**
 * 记录请求完成后的日志 (用于 API 路由)
 */
export async function logRequest(req: NextRequest, status: number, userId?: number) {
  const ip = getClientIp(req)
  const method = req.method
  const path = req.nextUrl.pathname
  const userAgent = req.headers.get("user-agent") || ""
  await recordAccessLog({
    ip,
    method,
    path,
    status,
    duration: 0, // 简化，不计算耗时
    user_id: userId,
    user_agent: userAgent
  })
}

--- FILE: lib\server\sessionStore.ts ---

import { promises as fs } from "fs"
import path from "path"
export type ChatMessage = {
  role: "user" | "assistant"
  content: string
  citations?: Array<{ number: string; title: string; url: string; description?: string; quote?: string }>
  reasoning?: { text: string; durationMs?: number }
  tasks?: Array<{ title: string; items: Array<{ type: "text" | "file"; text: string; file?: { name: string; icon?: string } }>; status: "pending" | "in_progress" | "completed" }>
}
type SessionMeta = { id: string; title: string; createdAt: number; updatedAt: number; userId?: number }
type Store = { sessions: SessionMeta[]; messagesById: Record<string, ChatMessage[]> }
const DATA_DIR = path.join(process.cwd(), "data")
const FILE_PATH = path.join(DATA_DIR, "sessions.json")
async function ensureFile(): Promise<void> {
  try {
    await fs.mkdir(DATA_DIR, { recursive: true })
    await fs.access(FILE_PATH)
  } catch {
    const empty: Store = { sessions: [], messagesById: {} }
    await fs.writeFile(FILE_PATH, JSON.stringify(empty, null, 2), "utf-8")
  }
}
async function readStore(): Promise<Store> {
  await ensureFile()
  const raw = await fs.readFile(FILE_PATH, "utf-8")
  try {
    const parsed = JSON.parse(raw) as unknown
    const store = parsed as Store
    if (!store.sessions) store.sessions = []
    if (!store.messagesById) store.messagesById = {}
    return store
  } catch {
    const empty: Store = { sessions: [], messagesById: {} }
    await fs.writeFile(FILE_PATH, JSON.stringify(empty, null, 2), "utf-8")
    return empty
  }
}
async function writeStore(store: Store): Promise<void> {
  await fs.writeFile(FILE_PATH, JSON.stringify(store, null, 2), "utf-8")
}
export async function listSessions(userId?: number): Promise<SessionMeta[]> {
  const store = await readStore()
  let sessions = store.sessions
  if (userId !== undefined) {
    sessions = sessions.filter(s => s.userId === userId)
  }
  return sessions.sort((a, b) => b.updatedAt - a.updatedAt)
}
export async function createSession(title: string, userId?: number): Promise<SessionMeta> {
  const store = await readStore()
  const id = `${Date.now()}`
  const now = Date.now()
  const meta: SessionMeta = { id, title, createdAt: now, updatedAt: now, userId }
  store.sessions.push(meta)
  store.messagesById[id] = []
  await writeStore(store)
  return meta
}
export async function getMessages(id: string, userId?: number): Promise<ChatMessage[] | null> {
  const store = await readStore()
  const session = store.sessions.find(s => s.id === id)
  // If session doesn't exist, return null or empty?
  // If userId is provided, check ownership
  if (userId !== undefined && session && session.userId !== undefined && session.userId !== userId) {
    // Unauthorized access attempt or just not found for this user
    return null
  }
  return store.messagesById[id] ?? []
}
export async function saveMessages(id: string, messages: ChatMessage[], userId?: number): Promise<void> {
  const store = await readStore()
  // Check if session exists
  let meta = store.sessions.find(s => s.id === id)
  if (!meta) {
    // Create new session if not exists (though usually createSession is called first)
    const title = `会话 ${id}`
    const now = Date.now()
    meta = { id, title, createdAt: now, updatedAt: now, userId }
    store.sessions.push(meta)
    store.messagesById[id] = []
  } else {
    // If session exists, check ownership if userId provided
    if (userId !== undefined && meta.userId !== undefined && meta.userId !== userId) {
      throw new Error("Unauthorized access to session")
    }
    meta.updatedAt = Date.now()
  }
  store.messagesById[id] = messages
  await writeStore(store)
}
export async function deleteSession(id: string, userId?: number): Promise<void> {
  const store = await readStore()
  if (userId !== undefined) {
    const session = store.sessions.find(s => s.id === id)
    if (session && session.userId !== undefined && session.userId !== userId) {
      throw new Error("Unauthorized delete attempt")
    }
  }
  store.sessions = store.sessions.filter(s => s.id !== id)
  delete store.messagesById[id]
  await writeStore(store)
}
export async function updateSessionTitle(id: string, title: string, userId?: number): Promise<void> {
  const store = await readStore()
  const meta = store.sessions.find(s => s.id === id)
  if (meta) {
    if (userId !== undefined && meta.userId !== undefined && meta.userId !== userId) {
      throw new Error("Unauthorized update attempt")
    }
    meta.title = title
    meta.updatedAt = Date.now()
    await writeStore(store)
  }
}

--- FILE: lib\token.ts ---

import { SignJWT, jwtVerify } from "jose";
/**
 * JWT Payload Interface
 */
export interface JWTPayload {
  id: number;
  email: string;
  username: string;
  [key: string]: unknown; // Allow other properties for Jose compatibility
}
/**
 * Get JWT Secret
 */
export function getJwtSecret(): Uint8Array {
  const secret = process.env.JWT_SECRET;
  if (!secret) {
    if (process.env.NODE_ENV === "production") {
       throw new Error("FATAL: JWT_SECRET is not defined in production environment!");
    }
    // console.warn("Warning: JWT_SECRET not set, using default dev secret");
  }
  const secretStr = secret || "dev-secret-change-in-production";
  return new TextEncoder().encode(secretStr);
}
/**
 * Generate JWT Token (Edge compatible)
 */
export async function signToken(payload: Omit<JWTPayload, "exp" | "iat">): Promise<string> {
  const secret = getJwtSecret();
  const alg = "HS256";
  return new SignJWT(payload)
    .setProtectedHeader({ alg })
    .setExpirationTime("7d")
    .setIssuedAt()
    .sign(secret);
}
/**
 * Verify JWT Token (Edge compatible)
 */
export async function verifyToken(token: string): Promise<JWTPayload | null> {
  try {
    const secret = getJwtSecret();
    const { payload } = await jwtVerify(token, secret);
    return payload as unknown as JWTPayload;
  } catch (error) {
    return null;
  }
}

--- FILE: lib\turnstile.ts ---

export async function verifyTurnstileToken(token: string): Promise<boolean> {
  const secretKey = process.env.TURNSTILE_SECRET_KEY;
  if (!secretKey) {
    if (process.env.NODE_ENV === "production") {
       console.error("TURNSTILE_SECRET_KEY is not defined in production.");
       return false;
    }
    // In development, if no key is set, we might want to bypass or warn.
    // But usually we want to test it. If the user hasn't set it, this will fail.
    // Let's assume user will set it.
    console.warn("TURNSTILE_SECRET_KEY is missing.");
    return false;
  }
  try {
    const formData = new FormData();
    formData.append("secret", secretKey);
    formData.append("response", token);
    const result = await fetch(
      "https://challenges.cloudflare.com/turnstile/v0/siteverify",
      {
        method: "POST",
        body: formData,
      }
    );
    const outcome = await result.json();
    if (!outcome.success) {
        console.error("Turnstile verification failed:", outcome);
    }
    return outcome.success;
  } catch (e) {
    console.error("Turnstile verification error:", e);
    return false;
  }
}

--- FILE: lib\types\plant-growth-types.ts ---

// Plant Growth Analysis Types
export interface PlantGrowthStage {
  stage: number // 1-6
  name: string
  description: string
}
export type PlantHealthStatus = 'excellent' | 'good' | 'normal' | 'attention' | 'warning' | 'critical'
export interface PlantHealthInfo {
  score: number // 0-100
  status: PlantHealthStatus
  color: string
}
export interface PlantAnalysisResult {
  stage: number // 1-6 生长阶段
  healthScore: number // 0-100 整体健康度
  healthStatus: PlantHealthStatus // 健康状态
  issues: string[] // 发现的问题
  recommendations: string[] // 建议措施
  confidence: number // 0-1 分析置信度
  timestamp: number // 分析时间戳
  heatmap: number[] // 6个区域的健康度 0-100
}
export interface VLMAnalysisRequest {
  imageData: string // base64 encoded image
  model?: string // qwen3-vl-plus, qwen3-vl-max, etc.
  prompt?: string // custom prompt
}
export interface VLMAnalysTask {
  analyzing: boolean
  result: PlantAnalysisResult | null
  error: string | null
  tokenUsage?: {
    input: number
    output: number
    total: number
  }
}
// Growth stage constants
export const GROWTH_STAGES: PlantGrowthStage[] = [
  { stage: 1, name: '幼苗期', description: '种子萌发，初生叶片展开' },
  { stage: 2, name: '生长期', description: '植株快速生长，叶片增多' },
  { stage: 3, name: '花芽分化期', description: '开始形成花芽' },
  { stage: 4, name: '开花结果期', description: '开花授粉，果实形成' },
  { stage: 5, name: '果实成熟期', description: '果实膨大成熟' },
  { stage: 6, name: '采收后期', description: '果实采收，植株休整' }
]
// Health status color mapping
export const HEALTH_STATUS_COLORS: Record<PlantHealthStatus, string> = {
  'excellent': '#9EE09E',
  'good': '#A5F28F',
  'normal': '#C8FF8F',
  'attention': '#FFB3C1',
  'warning': '#FF8FA3',
  'critical': '#FF6F91'
}
// Helper function to get health status from score
export function getHealthStatus(score: number): PlantHealthStatus {
  if (score >= 90) return 'excellent'
  if (score >= 75) return 'good'
  if (score >= 60) return 'normal'
  if (score >= 45) return 'attention'
  if (score >= 30) return 'warning'
  return 'critical'
}
// Helper function to get health info from score
export function getHealthInfo(score: number): PlantHealthInfo {
  const status = getHealthStatus(score)
  return {
    score,
    status,
    color: HEALTH_STATUS_COLORS[status]
  }
}

--- FILE: lib\utils\model-compatibility.test.ts ---

import { describe, it, expect } from 'vitest'
import { supportsSearch, getSearchUnsupportedMessage } from './model-compatibility'
describe('Model Compatibility Utils', () => {
  describe('supportsSearch', () => {
    it('should return true for qwen-max models', () => {
      expect(supportsSearch('qwen-max', 'https://dashscope.aliyuncs.com')).toBe(true)
      expect(supportsSearch('qwen-max-latest', 'https://dashscope.aliyuncs.com')).toBe(true)
    })
    it('should return true for qwen3-max models', () => {
      expect(supportsSearch('qwen3-max', 'https://dashscope.aliyuncs.com')).toBe(true)
      expect(supportsSearch('qwen3-max-latest', 'https://dashscope.aliyuncs.com')).toBe(true)
    })
    it('should return false for qwen-plus models', () => {
      expect(supportsSearch('qwen-plus', 'https://dashscope.aliyuncs.com')).toBe(false)
      expect(supportsSearch('qwen-vl-plus', 'https://dashscope.aliyuncs.com')).toBe(false)
    })
    it('should return false for OpenAI models', () => {
      expect(supportsSearch('gpt-3.5-turbo', 'https://api.openai.com')).toBe(false)
      expect(supportsSearch('gpt-4o', 'https://api.openai.com')).toBe(false)
    })
    it('should return false for undefined model', () => {
      expect(supportsSearch(undefined, 'https://dashscope.aliyuncs.com')).toBe(false)
    })
    it('should handle case-insensitive model names', () => {
      expect(supportsSearch('QWEN-MAX', 'https://dashscope.aliyuncs.com')).toBe(true)
      expect(supportsSearch('Qwen3-Max', 'https://dashscope.aliyuncs.com')).toBe(true)
    })
  })
  describe('getSearchUnsupportedMessage', () => {
    it('should return appropriate message for OpenAI models', () => {
      const message = getSearchUnsupportedMessage('gpt-4o')
      expect(message).toContain('OpenAI')
    })
    it('should return appropriate message for qwen models', () => {
      const message = getSearchUnsupportedMessage('qwen-plus')
      expect(message).toContain('qwen-max')
    })
    it('should return generic message for unknown models', () => {
      const message = getSearchUnsupportedMessage('unknown-model')
      expect(message).toContain('不支持')
    })
    it('should return message for undefined model', () => {
      const message = getSearchUnsupportedMessage(undefined)
      expect(message).toContain('选择')
    })
  })
})

--- FILE: lib\utils\model-compatibility.ts ---

/**
 * Utility functions for checking model compatibility with various features
 */
/**
 * Check if a model supports search functionality
 * @param model - The model name
 * @param apiUrl - The API URL (optional)
 * @returns true if the model supports search, false otherwise
 */
export function supportsSearch(model: string | undefined, apiUrl?: string): boolean {
  if (!model) return false
  const isDashScope = apiUrl?.includes("dashscope.aliyuncs.com") || model?.startsWith("qwen")
  if (!isDashScope) {
    // OpenAI models don't support search through this API
    return false
  }
  // Only qwen-max and qwen3-max series support search in DashScope
  const modelLower = model.toLowerCase()
  return modelLower.includes("qwen-max") || modelLower.includes("qwen3-max")
}
/**
 * Get a user-friendly message explaining why search is not supported
 * @param model - The model name
 * @returns A message explaining the limitation
 */
export function getSearchUnsupportedMessage(model: string | undefined): string {
  if (!model) return "请先选择一个模型"
  const modelLower = model.toLowerCase()
  if (modelLower.includes("gpt") || modelLower.includes("openai")) {
    return "OpenAI 模型暂不支持联网搜索功能"
  }
  if (modelLower.includes("qwen")) {
    return "当前模型不支持搜索，请使用 qwen-max 或 qwen3-max 系列模型"
  }
  return "当前模型不支持联网搜索功能"
}

--- FILE: lib\utils\plant-analysis-helper.ts ---

// Helper function to detect plant analysis requests and handle VLM analysis
import type { PlantAnalysisResult } from '@/lib/types/plant-growth-types'
import { captureFrameFromVideo } from '@/lib/utils/video-capture'
export interface AnalyzePlantOptions {
    apiKey: string
    apiUrl?: string
    model?: string
}
/**
 * Check if user message is requesting plant analysis
 */
export function isPlantAnalysisRequest(message: string): boolean {
    const keywords = [
        '分析植株',
        '分析草莓',
        '植株诊断',
        '植物诊断',
        '植株状态',
        '生长状况',
        '健康状况',
        '检查植株',
        '看看植株',
        '植株怎么样'
    ]
    const lowerMessage = message.toLowerCase()
    return keywords.some(keyword => lowerMessage.includes(keyword.toLowerCase()))
}
/**
 * Analyze plant from video element
 */
export async function analyzePlantFromVideo(
    videoElement: HTMLVideoElement | null,
    options: AnalyzePlantOptions
): Promise<{
    success: boolean
    result?: PlantAnalysisResult
    frameImage?: string
    error?: string
    tokenUsage?: { input: number; output: number; total: number }
}> {
    try {
        if (!videoElement) {
            return {
                success: false,
                error: '未找到视频流元素'
            }
        }
        // Capture frame from video
        const frameData = captureFrameFromVideo(videoElement, {
            maxWidth: 640,
            maxHeight: 480,
            quality: 0.85
        })
        if (!frameData) {
            return {
                success: false,
                error: '无法捕获视频帧，请确保视频正在播放'
            }
        }
        // Call VLM analysis API
        const response = await fetch('/api/vlm/analyze-frame', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imageData: frameData,
                apiKey: options.apiKey,
                apiUrl: options.apiUrl,
                model: options.model || 'qwen3-vl-plus'
            })
        })
        if (!response.ok) {
            const errorData = await response.json()
            return {
                success: false,
                error: errorData.error || 'VLM分析请求失败'
            }
        }
        const data = await response.json()
        if (!data.success) {
            return {
                success: false,
                error: data.error || '分析失败'
            }
        }
        // Update plant growth state
        await fetch('/api/plant-growth', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                result: data.result
            })
        })
        return {
            success: true,
            result: data.result,
            frameImage: frameData,
            tokenUsage: data.tokenUsage
        }
    } catch (error: any) {
        return {
            success: false,
            error: error.message || '分析过程出现错误'
        }
    }
}
/**
 * Format analysis result as readable text
 */
export function formatAnalysisResult(result: PlantAnalysisResult): string {
    const stageNames = ['幼苗期', '生长期', '花芽分化期', '开花结果期', '果实成熟期', '采收后期']
    const stageName = stageNames[result.stage - 1] || `第${result.stage}阶段`
    const statusMap = {
        'excellent': '优秀',
        'good': '良好',
        'normal': '正常',
        'attention': '需要关注',
        'warning': '警告',
        'critical': '危急'
    }
    const statusText = statusMap[result.healthStatus] || result.healthStatus
    let text = `## 植株诊断结果\n\n`
    text += `**生长阶段**: ${stageName}\n\n`
    text += `**整体健康度**: ${result.healthScore}/100 (${statusText})\n\n`
    if (result.issues && result.issues.length > 0) {
        text += `### 发现的问题\n\n`
        result.issues.forEach((issue, i) => {
            text += `${i + 1}. ${issue}\n`
        })
        text += `\n`
    }
    if (result.recommendations && result.recommendations.length > 0) {
        text += `### 改进建议\n\n`
        result.recommendations.forEach((rec, i) => {
            text += `${i + 1}. ${rec}\n`
        })
        text += `\n`
    }
    text += `### 区域健康度分布\n\n`
    text += `从左到右6个区域的健康度评分：\n\n`
    result.heatmap.forEach((score, i) => {
        const status = score >= 90 ? '优秀' : score >= 75 ? '良好' : score >= 60 ? '正常' : score >= 45 ? '注意' : score >= 30 ? '警告' : '异常'
        text += `- 区域${i + 1}: ${score}/100 (${status})\n`
    })
    text += `\n---\n\n`
    text += `*分析时间: ${new Date(result.timestamp).toLocaleString('zh-CN')}*\n`
    text += `*置信度: ${(result.confidence * 100).toFixed(0)}%*`
    return text
}

--- FILE: lib\utils\video-capture.ts ---

// Video Frame Capture Utilities
/**
 * Capture a frame from a video element
 * @param videoElement - The video element to capture from
 * @param maxWidth - Maximum width of captured frame (default: 640)
 * @param maxHeight - Maximum height of captured frame (default: 480)
 * @param quality - JPEG quality 0-1 (default: 0.85)
 * @returns Base64 encoded JPEG image data URL
 */
export function captureVideoFrame(
    videoElement: HTMLVideoElement,
    maxWidth: number = 640,
    maxHeight: number = 480,
    quality: number = 0.85
): string | null {
    try {
        // Create canvas
        const canvas = document.createElement('canvas')
        const ctx = canvas.getContext('2d')
        if (!ctx) {
            console.error('Failed to get canvas context')
            return null
        }
        // Get video dimensions
        const videoWidth = videoElement.videoWidth
        const videoHeight = videoElement.videoHeight
        if (videoWidth === 0 || videoHeight === 0) {
            console.error('Video has no dimensions')
            return null
        }
        // Calculate scaled dimensions
        let width = videoWidth
        let height = videoHeight
        if (width > maxWidth) {
            height = (height * maxWidth) / width
            width = maxWidth
        }
        if (height > maxHeight) {
            width = (width * maxHeight) / height
            height = maxHeight
        }
        // Set canvas size
        canvas.width = width
        canvas.height = height
        // Draw video frame to canvas
        ctx.drawImage(videoElement, 0, 0, width, height)
        // Convert to JPEG base64
        const dataUrl = canvas.toDataURL('image/jpeg', quality)
        return dataUrl
    } catch (error) {
        console.error('Error capturing video frame:', error)
        return null
    }
}
/**
 * Get base64 image data without data URL prefix
 * @param dataUrl - Data URL (e.g., "data:image/jpeg;base64,...")
 * @returns Base64 string without prefix
 */
export function getBase64FromDataUrl(dataUrl: string): string {
    const parts = dataUrl.split(',')
    return parts.length > 1 ? parts[1] : dataUrl
}
/**
 * Calculate simple hash for image comparison
 * @param dataUrl - Base64 data URL
 * @returns Simple hash string
 */
export function simpleImageHash(dataUrl: string): string {
    const base64 = getBase64FromDataUrl(dataUrl)
    // Take samples from different positions
    const samples = [
        base64.substring(0, 50),
        base64.substring(base64.length / 4, base64.length / 4 + 50),
        base64.substring(base64.length / 2, base64.length / 2 + 50),
        base64.substring(base64.length * 3 / 4, base64.length * 3 / 4 + 50),
        base64.substring(base64.length - 50)
    ]
    return samples.join('-')
}
/**
 * Capture frame from video element by ID or ref
 * @param videoIdOrElement - Video element ID or HTMLVideoElement
 * @param options - Capture options
 * @returns Captured frame data or null
 */
export function captureFrameFromVideo(
    videoIdOrElement: string | HTMLVideoElement,
    options?: {
        maxWidth?: number
        maxHeight?: number
        quality?: number
    }
): string | null {
    const video = typeof videoIdOrElement === 'string'
        ? document.getElementById(videoIdOrElement) as HTMLVideoElement
        : videoIdOrElement
    if (!video) {
        console.error('Video element not found')
        return null
    }
    return captureVideoFrame(
        video,
        options?.maxWidth || 640,
        options?.maxHeight || 480,
        options?.quality || 0.85
    )
}

--- FILE: lib\utils.ts ---

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

--- FILE: lib\validations\auth.ts ---

import { z } from "zod"
export const usernameSchema = z
  .string()
  .min(2, "用户名长度需在2-20个字符之间")
  .max(20, "用户名长度需在2-20个字符之间")
  // Allow letters, numbers, underscores, hyphens, and Chinese characters
  // Prevent dangerous characters like < > / \ ' "
  .regex(/^[a-zA-Z0-9_\-\u4e00-\u9fa5]+$/, "用户名只能包含字母、数字、下划线、连字符和中文字符")
export const passwordSchema = z
  .string()
  .min(8, "密码至少需要8个字符")
  .max(100, "密码过长")
export const emailSchema = z
  .string()
  .email("邮箱格式不正确")
  .toLowerCase()
  .trim()
export const avatarUrlSchema = z
  .string()
  .optional()
  .nullable()
  .refine((val) => {
    if (!val) return true
    // Allow relative paths starting with /
    if (val.startsWith("/")) return true
    try {
      const url = new URL(val)
      // Only allow http and https protocols to prevent javascript: XSS
      return ["http:", "https:"].includes(url.protocol)
    } catch {
      return false
    }
  }, "头像 URL 必须是有效的 HTTP/HTTPS 链接或相对路径")
export const loginSchema = z.object({
  email: z.string().trim(), // Allow non-email username login if we wanted, but here we strictly use email
  password: z.string(),
})
export const registerSchema = z.object({
  email: emailSchema,
  password: passwordSchema,
  username: usernameSchema,
})
export const updateUserSchema = z.object({
  username: usernameSchema.optional(),
  avatar_url: avatarUrlSchema,
})

--- FILE: lib\vlm-prompts.ts ---

// VLM Prompt Templates for Plant Diagnosis
export const PLANT_DIAGNOSIS_PROMPT = `请分析图片中的草莓植株状况，返回JSON格式诊断结果。
要求：
1. 评估生长阶段（1-6）：幼苗期/生长期/花芽分化期/开花结果期/果实成熟期/采收后期
2. 整体健康度评分（0-100）
3. 识别可见问题（病虫害、营养不良、环境压力等）
4. 提供改进建议
5. 将画面分为6个区域（从左到右），评估每个区域的植株健康度（0-100）
返回JSON格式（不要有任何额外文字）：
{
  "stage": <1-6数字>,
  "healthScore": <0-100数字>,
  "issues": [<问题列表字符串>],
  "recommendations": [<建议列表字符串>],
  "heatmap": [<6个数字，表示从左到右6个区域的健康度0-100>]
}
评估标准：
- 叶片：颜色（深绿健康，黄化/褐化异常）、大小、形态、病斑
- 茎秆：粗壮度、颜色、是否有病害
- 果实：大小、颜色、成熟度、病虫害
- 整体：密度、生长势、均匀度
仅返回JSON，不要其他解释。`
export const PLANT_DIAGNOSIS_PROMPT_COMPACT = `分析草莓植株，返回JSON：
{"stage":<1-6>,"healthScore":<0-100>,"issues":[...],"recommendations":[...],"heatmap":[6个数值0-100]}
阶段：1幼苗/2生长/3花芽/4开花/5成熟/6采收
评分：叶色形态、茎秆、果实、整体
热图：从左到右6区域健康度
仅JSON无其他文字。`
// Get default model for VLM analysis
export function getDefaultVLMModel(): string {
    return 'qwen3-vl-plus'
}
// Get available VLM models
export function getAvailableVLMModels(): string[] {
    return [
        'qwen3-vl-plus',
        'qwen3-vl-max',
        'qwen-vl-turbo'
    ]
}

--- FILE: scripts\check-users.ts ---

import { getDB, initDB } from '../lib/db/database';
async function listUsers() {
  try {
    await initDB();
    const db = getDB();
    const users = db.prepare('SELECT * FROM users').all();
    console.log('Users found:', users.length);
    users.forEach((u: any) => {
      console.log(`- ID: ${u.id}, Username: ${u.username}, Email: ${u.email}, Role: ${u.role}`);
    });
  } catch (error) {
    console.error('Error listing users:', error);
  }
}
listUsers();

--- FILE: scripts\set-admin.js ---

const Database = require('better-sqlite3');
const path = require('path');
const fs = require('fs');
const dbPath = path.join(process.cwd(), 'data', 'users.db');
if (!fs.existsSync(dbPath)) {
  console.error(`Database not found at ${dbPath}`);
  process.exit(1);
}
const db = new Database(dbPath);
const email = process.argv[2];
const role = process.argv[3] || 'super_admin';
if (!email) {
  console.log('Usage: node scripts/set-admin.js <email> [role]');
  process.exit(1);
}
try {
  // Check if role column exists (migration might not have run if app hasn't started)
  const tableInfo = db.prepare("PRAGMA table_info(users)").all();
  const hasRole = tableInfo.some(col => col.name === 'role');
  if (!hasRole) {
    console.log('Adding role column...');
    db.exec("ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'");
    db.exec("ALTER TABLE users ADD COLUMN permissions TEXT DEFAULT '{}'");
  }
  const stmt = db.prepare("UPDATE users SET role = ? WHERE email = ?");
  const info = stmt.run(role, email);
  if (info.changes > 0) {
    console.log(`User ${email} is now ${role}`);
  } else {
    console.log(`User ${email} not found`);
  }
} catch (e) {
  console.error('Error:', e);
}

--- FILE: middleware.ts ---

import { NextRequest, NextResponse, NextFetchEvent } from "next/server"
import { rateLimit, getClientIp, resetIp } from "@/lib/rate-limit"
import { getInternalApiSecret } from "@/lib/constants"
function isMobileUA(ua: string | null, chMobile: string | null) {
  if (chMobile === "?1") return true
  if (!ua) return false
  const u = ua.toLowerCase()
  if (u.includes("ipad") || u.includes("tablet")) return false
  const hasAndroidMobile = u.includes("android") && (u.includes("mobile") || u.includes("mobi"))
  const hasIphone = u.includes("iphone") || u.includes("ipod")
  const hasWindowsPhone = u.includes("windows phone")
  const hasGenericMobile = u.includes("mobi") || u.includes("mobile")
  return hasAndroidMobile || hasIphone || hasWindowsPhone || hasGenericMobile
}
export async function middleware(req: NextRequest, event: NextFetchEvent) {
  const url = new URL(req.url)
  const pathname = url.pathname
  // Skip internal APIs to avoid infinite loops and rate limiting on internal checks
  if (pathname.startsWith("/api/internal")) {
    return NextResponse.next()
  }
  // Exempt Alipay login and callback from rate limiting
  if (pathname.startsWith("/api/auth/alipay/login") ||
      pathname.startsWith("/api/auth/alipay/callback") ||
      pathname.startsWith("/api/auth/ticket/check")) {
    return NextResponse.next()
  }
  // Fetch Rate Limit Config (Lazy/Cache)
  // Note: Middleware in Next.js (Node runtime) shares process memory usually,
  // but to be safe and robust, we fetch from internal API periodically or use defaults.
  // For performance, we'll use hardcoded defaults for now but overridden by logic below if we had a lightweight config store.
  // In a real high-scale app, this would be a Redis call.
  // Here, we'll implement a simple "stale-while-revalidate" in-memory cache variable if possible,
  // but since middleware scope is tricky, we'll fetch only on specific triggers or just use defaults + DB check for unban.
  // Wait, user explicitly asked for Admin adjustable thresholds.
  // We will try to fetch config from internal API asynchronously and update a local variable?
  // No, we can't easily update a global variable reliably across all isolate instances in Edge (though we are on Node).
  // Strategy: We will try to fetch config from a global variable if we are in Node.
  // Actually, we can just fetch it from the internal API with a short timeout? No, adds 10ms+ latency.
  // Revised Strategy: We use a "Soft Fetch" - we default to standard limits, but if a request comes in,
  // we occasionally (e.g. 1% of requests) refresh the config from the DB via internal API and store it in a global.
  // For now, to ensure it works immediately without complexity, we'll just define the limits here.
  // If we want dynamic limits, we need to pass them to rateLimit.
  // Dynamic Configuration Loading (Simulated with Global Cache)
  // @ts-ignore
  let dynamicConfig = globalThis.rateLimitConfig
  const now = Date.now()
  // @ts-ignore
  if (!dynamicConfig || (now - (globalThis.lastConfigFetch || 0) > 60000)) {
     // Trigger background refresh
     const protocol = req.nextUrl.protocol
     const host = req.headers.get("host") || 'localhost:3000'
     // Don't await to avoid blocking response
     fetch(`${protocol}//${host}/api/internal/security/config`, {
        headers: { "x-internal-secret": getInternalApiSecret() }
     }).then(res => res.json()).then(config => {
        if (config && !config.error) {
           // @ts-ignore
           globalThis.rateLimitConfig = config
           // @ts-ignore
           globalThis.lastConfigFetch = Date.now()
        }
     }).catch(e => console.error("Config fetch failed", e))
  }
  // 0. Global Rate Limiting & Auto-Ban (API & Auth routes)
  // Protect sensitive endpoints from brute force / DoS
  if (pathname.startsWith("/api") || pathname.startsWith("/login") || pathname.startsWith("/register")) {
    // Exempt /api/auth/me from strict limits as it's a frequent session check
    const isStrictAuthApi = pathname.startsWith("/api/auth") && !pathname.startsWith("/api/auth/me");
    // Default values if config not loaded yet
    // @ts-ignore
    const config = globalThis.rateLimitConfig || {
       limit: 300,
       windowMs: 60000,
       violationLimit: 20,
       banDuration: 900000
    }
    // Stricter limits for auth endpoints (unless configured otherwise, we assume config is for general API)
    // We can scale auth limits based on general limits (e.g. 1/6th)
    const limit = isStrictAuthApi ? Math.max(5, Math.floor(config.limit / 6)) : config.limit;
    const windowMs = config.windowMs;
    // Enable auto-ban for repeated violations
    const result = rateLimit(req, {
       limit,
       windowMs,
       autoBan: true,
       violationLimit: config.violationLimit,
       banDuration: config.banDuration
    });
    if (!result.success) {
      const ip = getClientIp(req);
      if (result.banned) {
        // @ts-ignore
        if (result.newBan) {
          // Persist ban to DB asynchronously
          const protocol = req.nextUrl.protocol
          const host = req.headers.get("host") || 'localhost:3000'
          event.waitUntil(
            fetch(`${protocol}//${host}/api/internal/security/ban`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-internal-secret': getInternalApiSecret()
              },
              body: JSON.stringify({ ip, reason: "Auto-ban: Frequent suspicious activity" })
            }).catch(e => console.error("Failed to persist ban:", e))
          )
        }
        // Check if unbanned in DB (Allowlist Check)
        try {
           const protocol = req.nextUrl.protocol
           const host = req.headers.get("host") || 'localhost:3000'
           const checkRes = await fetch(`${protocol}//${host}/api/internal/security/check?ip=${ip}`, {
              headers: { "x-internal-secret": "stravision-internal-secret" }
           })
           if (checkRes.ok) {
             const { banned } = await checkRes.json()
             if (!banned) {
               // Unbanned in DB -> Unban locally
               resetIp(ip)
               return NextResponse.next()
             }
           }
        } catch (e) {
           console.error("Security check failed:", e)
        }
        console.warn(`[Security] IP ${ip} blocked due to suspicious behavior (Auto-Ban)`);
        // For API requests, return JSON error
        if (pathname.startsWith("/api")) {
          return new NextResponse(JSON.stringify({ error: "Access Denied: Suspicious activity detected." }), {
            status: 403,
            headers: { "Content-Type": "application/json" }
          });
        }
        // For page requests (login/register), redirect to Access Denied page
        return NextResponse.redirect(new URL("/access-denied", req.url));
      }
      // For API requests, return JSON error
      if (pathname.startsWith("/api")) {
        return new NextResponse(JSON.stringify({ error: "Too many requests" }), {
          status: 429,
          headers: { "Content-Type": "application/json" }
        });
      }
      // For page requests, redirect to Too Many Requests page
      return NextResponse.redirect(new URL("/too-many-requests", req.url));
    }
  }
  // 1. Admin Protection (Stealth Mode)
  if (pathname.startsWith("/admin")) {
    const token = req.cookies.get("auth")?.value
    // If no token, pretend it doesn't exist (404) or redirect to home to avoid detection
    if (!token) {
      return NextResponse.redirect(new URL("/", req.url))
    }
    // Note: Role check happens in layout/page server components for security
  }
  // 2. Authentication Check (Security)
  // 检查是否访问受保护的路由
  const protectedPaths = [
    "/dashboard",
    "/monitor",
    "/device-control",
    "/settings",
    "/profile",
    "/ai-assistant"
  ]
  const isProtected = protectedPaths.some(path => pathname.startsWith(path))
  if (isProtected) {
    const token = req.cookies.get("auth")?.value
    if (!token) {
      // 如果没有 auth cookie，重定向到登录页
      const loginUrl = new URL("/login", req.url)
      // Add return URL for better UX
      loginUrl.searchParams.set("from", pathname);
      return NextResponse.redirect(loginUrl)
    }
  }
  // 3. Mobile Redirection (UX)
  const ua = req.headers.get("user-agent")
  const chMobile = req.headers.get("sec-ch-ua-mobile")
  const mobile = isMobileUA(ua, chMobile)
  const mapping: Record<string, string> = {
    "/monitor": "/monitor-ios",
    "/device-control": "/device-control-ios",
    "/dashboard": "/dashboard-ios",
    "/ai-assistant": "/ai-assistant-ios"
  }
  // Only redirect if explicitly accessing the desktop version while on mobile
  // and avoid infinite loops or redirecting API calls
  if (mobile && mapping[pathname]) {
    const target = mapping[pathname]
    const nextUrl = new URL(req.url)
    nextUrl.pathname = target
    return NextResponse.rewrite(nextUrl)
  }
  const response = NextResponse.next()
  // 4. Security Headers
  // Add basic security headers to every response
  response.headers.set("X-Content-Type-Options", "nosniff")
  response.headers.set("X-Frame-Options", "SAMEORIGIN")
  response.headers.set("X-XSS-Protection", "1; mode=block")
  response.headers.set("Referrer-Policy", "strict-origin-when-cross-origin")
  response.headers.set("Permissions-Policy", "camera=(), microphone=(), geolocation=()")
  return response
}
export const config = {
  // 匹配所有受保护的路由、API路由和需要移动端适配的路由
  matcher: [
    "/dashboard/:path*",
    "/monitor/:path*",
    "/device-control/:path*",
    "/settings/:path*",
    "/profile/:path*",
    "/ai-assistant/:path*",
    "/admin/:path*",
    "/api/:path*",     // Add API routes for rate limiting
    "/login",          // Add login page
    "/register"        // Add register page
  ],
}

--- FILE: next.config.ts ---

import type { NextConfig } from "next";
const nextConfig: NextConfig = {
  output: "standalone",
  /* config options here */
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "images.unsplash.com",
      },
      {
        protocol: "https",
        hostname: "plus.unsplash.com",
      },
    ],
  },
  async headers() {
    const cspHeader = `
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline' https://challenges.cloudflare.com https://*.alipay.com https://*.alipayobjects.com https://*.qq.com https://*.weixin.qq.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' blob: data: https: https://images.unsplash.com https://plus.unsplash.com;
      font-src 'self' data:;
      connect-src 'self' https://*.alipay.com https://*.qq.com https://*.weixin.qq.com;
      object-src 'none';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
      frame-src 'self' https://challenges.cloudflare.com https://*.alipay.com https://*.qq.com;
      upgrade-insecure-requests;
    `.replace(/\s{2,}/g, ' ').trim()
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: cspHeader
          },
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin'
          }
        ]
      }
    ]
  },
};
export default nextConfig;

--- FILE: tsconfig.json ---

{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "baseUrl": ".",
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}

--- FILE: package.json ---

{
  "name": "my-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "test": "vitest --run",
    "test:watch": "vitest"
  },
  "dependencies": {
    "@ai-sdk/openai": "^2.0.76",
    "@gsap/react": "^2.1.2",
    "@heroicons/react": "^2.2.0",
    "@nanostores/react": "github:ai/react",
    "@radix-ui/react-aspect-ratio": "^1.1.8",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@radix-ui/react-tooltip": "^1.2.8",
    "@studio-freight/react-lenis": "^0.0.47",
    "@tabler/icons-react": "^3.35.0",
    "@types/jsonwebtoken": "^9.0.10",
    "ai": "^5.0.106",
    "alipay-sdk": "^4.14.0",
    "bcryptjs": "^3.0.3",
    "better-sqlite3": "^12.4.6",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cron-parser": "^5.4.0",
    "date-fns": "^4.1.0",
    "driver.js": "^1.4.0",
    "echarts": "^6.0.0",
    "echarts-for-react": "^3.0.5",
    "framer-motion": "^11.18.2",
    "gsap": "^3.13.0",
    "html-to-image": "^1.11.13",
    "html2canvas": "^1.0.0-rc.7",
    "jose": "^6.1.3",
    "jsonwebtoken": "^9.0.2",
    "jspdf": "^3.0.4",
    "lucide-react": "^0.554.0",
    "mermaid": "^11.12.1",
    "motion": "^12.23.25",
    "mqtt": "^5.14.1",
    "next": "^16.0.5",
    "next-themes": "^0.4.6",
    "node-cron": "^4.2.1",
    "react": "^19.2.2",
    "react-dom": "^19.2.2",
    "react-grid-layout": "^1.5.2",
    "react-markdown": "^9.0.0",
    "react-use-measure": "^2.1.7",
    "react-vega": "^8.0.0",
    "remark-gfm": "^4.0.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "three": "^0.181.2",
    "vega": "^6.2.0",
    "vega-embed": "^7.1.0",
    "vega-lite": "^6.4.1",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@types/better-sqlite3": "^7.6.13",
    "@types/node": "^20",
    "@types/node-cron": "^3.0.11",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/react-grid-layout": "^1.3.6",
    "@types/three": "^0.181.0",
    "@vitejs/plugin-react": "^5.1.1",
    "@vitest/ui": "^4.0.14",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "fast-check": "^4.3.0",
    "jsdom": "^27.2.0",
    "shadcn": "^3.5.0",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5",
    "vitest": "^4.0.14"
  }
}

--- FILE: instrumentation.ts ---

export const runtime = 'nodejs'
export async function register() {
  if (process.env.NEXT_RUNTIME !== 'nodejs') {
    return
  }
  console.log('Starting scheduler instrumentation...')
  const { initDB } = await import("@/lib/db/database")
  const { SchedulerRunner } = await import("@/lib/scheduler/runner")
  await initDB()
  await SchedulerRunner.getInstance().init()
}

--- FILE: postcss.config.mjs ---

const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};
export default config;

--- FILE: eslint.config.mjs ---

import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";
const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);
export default eslintConfig;