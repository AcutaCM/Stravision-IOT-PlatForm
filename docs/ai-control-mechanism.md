# AI 智能调控机制说明

本文档详细说明了莓界智慧农业平台中 AI 如何实现对环境的智能感知与调控。

## 核心架构

AI 调控系统由四个核心部分组成：

1.  **感知层 (The Eyes)**: 实时收集传感器数据和天气信息。
2.  **决策层 (The Brain)**: 基于大模型 (LLM) 和农业专家知识库进行分析。
3.  **执行层 (The Hands)**: 将 AI 决策转换为具体的设备控制指令。
4.  **物理层 (The Nerves)**: 通过 MQTT 协议与硬件设备通信。

## 1. 感知层：数据收集与上下文构建

在用户与 AI 对话或 AI 自动运行时，系统会实时构建当前的上下文环境 (`app/api/chat/route.ts`)：

*   **设备传感器数据**:
    *   环境数据：温度、湿度、光照、CO2
    *   土壤数据：温度、水分、EC值、氮磷钾含量
    *   设备状态：继电器开关状态、LED 颜色值
*   **外部环境数据**:
    *   基于位置的实时天气
    *   未来 7 天天气预报

这些数据会被格式化并注入到 AI 的系统提示词 (System Prompt) 中，确保 AI 始终"看到"最新的环境状态。

## 2. 决策层：专家系统与推理

AI 的决策逻辑定义在 `lib/ai-system-prompt.ts` 中，它包含了一套完整的草莓种植专家知识库：

### 种植最佳实践标准
*   **温度**: 白天 20-25°C，夜间 10-15°C
*   **湿度**: 60-80%
*   **光照**: 30000-50000 lux (补光策略：生长期蓝光、结果期红光)
*   **CO2**: 800-1200 ppm
*   **土壤**: 水分 60-80%，EC 1.0-2.0 mS/cm

### 智能分析流程
1.  **数据分析**: AI 对比当前传感器数据与最佳实践标准。
2.  **多维推理**: 结合天气预报（例如：虽然现在缺水，但马上要下雨，则暂缓灌溉）。
3.  **生成方案**: 制定具体的设备控制策略。
4.  **解释原因**: 生成自然语言解释，告诉用户为什么要这样调控。

## 3. 执行层：指令生成与转换

当 AI 决定需要调控设备时，它会生成特定的 JSON 格式指令。

### 指令格式
AI 会输出如下 JSON 代码块：

**继电器控制 (水泵/风扇/补光灯)**:
```json
{
  "action": "toggle_relay",
  "device": 5,  // 5=水泵, 6=风扇, 7=补光灯, 8=白灯
  "value": 1    // 1=开启, 0=关闭
}
```

**LED 颜色控制**:
```json
{
  "action": "set_led",
  "r": 255,
  "g": 100,
  "b": 50
}
```

前端界面 (`app/dashboard/page.tsx`) 会解析这些 JSON，并调用 `app/api/ai/device-control` 接口。

## 4. 物理层：MQTT 通信

`app/api/ai/device-control/route.ts` 接收到指令后，会进行安全校验和格式转换，最终通过 MQTT 协议发送给硬件：

*   **Relay 映射**: `action: "toggle_relay"` -> MQTT `type: "relay"`
*   **LED 映射**: `action: "set_led"` -> MQTT `type: "led"`

## 示例：智能降温流程

1.  **感知**: 传感器回传室内温度 **32°C**。
2.  **决策**: AI 分析发现温度高于最佳范围 (20-25°C)，且天气预报显示今日持续高温。
3.  **策略**: AI 决定开启风扇进行降温。
4.  **执行**:
    *   AI 生成: `{"action": "toggle_relay", "device": 6, "value": 1}`
    *   API 转换: `{"type": "relay", "relayNum": 6, "newState": 1}`
    *   MQTT 发送: Topic `/device/control`
5.  **结果**: 物理风扇启动，温度逐渐下降。
