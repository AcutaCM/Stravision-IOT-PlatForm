# AI 智能设备控制功能说明

## 功能概述

AI 助手现在可以：
1. 分析实时设备数据和环境参数
2. 获取当地天气信息（通过联网搜索）
3. 根据草莓种植最佳实践提供智能建议
4. 生成设备控制方案
5. 控制设备开关和 RGB 补光灯颜色

## 实现架构

### 1. 数据流

```
Dashboard Page
    ↓
获取设备数据 (deviceData) + 天气数据 (weatherData)
    ↓
发送到 Chat API (/api/chat)
    ↓
增强的系统提示词 + 当前数据上下文
    ↓
AI 模型分析
    ↓
生成控制建议和命令
    ↓
用户确认
    ↓
执行控制 (/api/ai/device-control)
    ↓
MQTT 控制 (/api/mqtt/control)
    ↓
设备执行
```

### 2. 新增文件

#### API 端点
- `app/api/ai/device-status/route.ts` - 设备状态查询（供参考）
- `app/api/ai/device-control/route.ts` - 设备控制接口

#### 系统提示词
- `lib/ai-system-prompt.ts` - 智慧农业专业知识库

#### 更新文件
- `app/api/chat/route.ts` - 添加设备和天气数据上下文
- `app/dashboard/page.tsx` - 传递实时数据给 AI

## 使用示例

### 示例 1: 环境分析

**用户**: "帮我看看现在的环境怎么样"

**AI 响应**:
```
让我分析一下当前环境数据：

📊 环境参数分析：
- 温度: 28.5°C（偏高 ⚠️，最佳范围 20-25°C）
- 湿度: 55%（正常 ✓）
- 光照: 15000 lux（偏低 ⚠️，建议 30000-50000 lux）
- CO₂: 450 ppm（正常 ✓）

🌱 土壤状况：
- 土壤温度: 22°C（正常 ✓）
- 土壤湿度: 65%（正常 ✓）
- 土壤EC: 1500 μS/cm（正常 ✓）

💡 建议措施：
1. 开启风扇降温（Relay 6）
2. 开启补光灯，使用生长期配色（蓝光为主）

是否需要我执行这些调控？
```

### 示例 2: 天气联动控制

**用户**: "根据今天的天气给我一个设备控制方案"

**AI 响应**:
```
好的，让我先查询当地天气...

🌤️ 今日天气：晴天
- 最高温度: 32°C
- 最低温度: 22°C
- 降雨概率: 0%
- 湿度: 45%

📋 综合分析：
- 高温天气，需要加强降温和通风
- 无降雨，需要正常灌溉
- 光照充足，可减少补光时间
- 湿度偏低，需要增加灌溉

⚙️ 今日控制方案：

上午 (8:00-12:00)：
- 开启风扇（Relay 6）
- 关闭补光灯（Relay 7）
- 开启灌溉 5 分钟（Relay 5）

中午 (12:00-14:00)：
- 保持风扇开启
- 再次灌溉 3 分钟

下午 (14:00-18:00)：
- 继续风扇运行
- 16:00 后根据光照开启补光灯

晚上 (18:00-20:00)：
- 开启补光灯（结果期红光配色）
- RGB 设置: R:255, G:100, B:50

是否需要我开始执行第一步（开启风扇）？
```

### 示例 3: RGB 补光灯调节

**用户**: "现在是开花期，帮我调整补光灯颜色"

**AI 响应**:
```
好的！草莓开花期需要红蓝混合光照来促进花芽分化和开花。

🌸 开花期最佳光照配置：
- 红光: 促进开花
- 蓝光: 促进花芽分化
- 建议比例: 红:蓝 = 4:3

💡 推荐 RGB 设置：

\`\`\`json
{
  "action": "set_led",
  "r": 200,
  "g": 50,
  "b": 150
}
\`\`\`

这个配置会产生偏紫红色的光照，非常适合开花期。

是否确认执行？
```

## 控制命令格式

### 继电器控制

```json
{
  "action": "toggle_relay",
  "device": 5,
  "value": 1
}
```

**参数说明**:
- `device`: 5=水泵, 6=风扇, 7=补光灯, 8=白灯
- `value`: 0=关闭, 1=开启

### RGB LED 控制

```json
{
  "action": "set_led",
  "r": 255,
  "g": 100,
  "b": 50
}
```

**参数说明**:
- `r`: 红色值 (0-255)
- `g`: 绿色值 (0-255)
- `b`: 蓝色值 (0-255)

## 草莓种植最佳实践（内置知识库）

### 温度管理
- 最佳温度: 白天 20-25°C，夜间 10-15°C
- 开花期: 15-20°C
- 果实成熟期: 18-22°C

### 湿度管理
- 最佳湿度: 60-80%
- 过高 (>85%): 易发病害，需通风
- 过低 (<50%): 需灌溉

### 光照管理
- 最佳光照: 30000-50000 lux
- 光照不足 (<20000 lux): 需补光
- 补光时间: 每天 12-14 小时

### 补光颜色建议
- **生长期**: 蓝光为主 (R:50, G:100, B:255)
- **开花期**: 红蓝混合 (R:200, G:50, B:150)
- **结果期**: 红光为主 (R:255, G:100, B:50)

### CO₂ 管理
- 最佳浓度: 800-1200 ppm
- 过低 (<400 ppm): 减少通风
- 过高 (>1500 ppm): 增加通风

### 土壤管理
- 土壤湿度: 60-80%
- 土壤EC: 1.0-2.0 mS/cm
- 土壤温度: 18-22°C

## 安全机制

1. **用户确认**: AI 不会自动执行控制命令，必须经过用户确认
2. **数据验证**: 所有控制命令都会验证参数范围
3. **错误处理**: 控制失败会返回明确的错误信息
4. **实时反馈**: 通过 SSE 连接实时显示设备状态

## 扩展建议

### 未来可以添加的功能
1. **自动化规则**: 设置条件触发自动控制
2. **历史数据分析**: 基于历史数据优化控制策略
3. **预测性维护**: 预测设备故障和维护需求
4. **多设备协同**: 智能协调多个设备的运行
5. **能耗优化**: 在保证效果的前提下降低能耗

## 注意事项

1. AI 的建议基于通用的草莓种植最佳实践，具体情况可能需要根据品种、地区等因素调整
2. 建议在执行重大调控前咨询农业专家
3. 定期校准传感器以确保数据准确性
4. 保持 MQTT 连接稳定以确保控制命令及时执行
