# AI 设备控制命令执行

## 功能说明

当 AI 助手生成设备控制命令时，会在聊天界面显示一个可执行的命令卡片，用户点击"执行命令"按钮即可控制设备。

## 工作流程

```
用户请求
    ↓
AI 分析环境数据
    ↓
AI 生成控制建议和命令
    ↓
前端检测到设备控制命令
    ↓
显示命令卡片 + 执行按钮
    ↓
用户点击"执行命令"
    ↓
调用 /api/ai/device-control
    ↓
调用 /api/mqtt/control
    ↓
MQTT 发送命令到设备
    ↓
设备执行 + 返回结果
    ↓
显示执行结果
```

## 命令检测

### 检测逻辑

```typescript
const isDeviceCommand = maybe && 
  typeof maybe === "object" && 
  maybe.action && 
  (maybe.action === "toggle_relay" || maybe.action === "set_led")
```

### 支持的命令类型

#### 1. 继电器控制 (toggle_relay)

```json
{
  "action": "toggle_relay",
  "device": 5,
  "value": 1
}
```

**参数**:
- `action`: "toggle_relay"
- `device`: 5=水泵, 6=风扇, 7=补光灯, 8=白灯
- `value`: 0=关闭, 1=开启

#### 2. RGB LED 控制 (set_led)

```json
{
  "action": "set_led",
  "r": 255,
  "g": 100,
  "b": 50
}
```

**参数**:
- `action`: "set_led"
- `r`: 红色值 (0-255)
- `g`: 绿色值 (0-255)
- `b`: 蓝色值 (0-255)

## UI 展示

### 命令卡片样式

```
┌─────────────────────────────────────────────┐
│ 🎮 设备控制命令                              │
│                                             │
│ {                                           │
│   "action": "toggle_relay",                 │
│   "device": 5,                              │
│   "value": 1                                │
│ }                                           │
│                                             │
│                          [执行命令] 按钮     │
└─────────────────────────────────────────────┘
```

**特点**:
- 蓝色渐变背景，突出显示
- JSON 格式化显示，便于查看
- 大按钮，易于点击
- 响应式设计

## 执行流程

### 1. 用户点击"执行命令"

```typescript
onClick={async () => {
  try {
    const response = await fetch('/api/ai/device-control', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(maybe)
    })
    const result = await response.json()
    // 处理结果...
  } catch (error) {
    // 错误处理...
  }
}}
```

### 2. API 验证和执行

`/api/ai/device-control` 会：
1. 验证命令格式
2. 验证参数范围
3. 调用 MQTT 控制 API
4. 返回执行结果

### 3. 显示执行结果

**成功**:
```
✅ 命令执行成功！设备状态已更新。
```

**失败**:
```
❌ 命令执行失败：[错误信息]
```

## 使用示例

### 示例 1: 开启风扇

**用户**: "温度太高了，帮我开启风扇"

**AI 回复**:
```
当前温度 28.5°C，确实偏高。建议开启风扇降温。

执行命令：
```json
{
  "action": "toggle_relay",
  "device": 6,
  "value": 1
}
```

点击下方按钮执行。
```

**用户操作**: 点击"执行命令"按钮

**结果**: 
```
✅ 命令执行成功！设备状态已更新。
```

风扇立即开启！

### 示例 2: 调整补光灯颜色

**用户**: "现在是开花期，帮我调整补光灯"

**AI 回复**:
```
开花期建议使用红蓝混合光照。

推荐配置：
```json
{
  "action": "set_led",
  "r": 200,
  "g": 50,
  "b": 150
}
```

这个配置会产生偏紫红色的光照，适合开花期。
```

**用户操作**: 点击"执行命令"按钮

**结果**: RGB LED 颜色立即更新！

## 错误处理

### 常见错误

#### 1. 网络错误
```
❌ 命令执行失败：网络错误
```

**原因**: 无法连接到服务器  
**解决**: 检查网络连接

#### 2. 参数错误
```
❌ 命令执行失败：Invalid device or value for toggle_relay
```

**原因**: 设备编号或值不正确  
**解决**: AI 会重新生成正确的命令

#### 3. MQTT 连接失败
```
❌ 命令执行失败：MQTT client not connected
```

**原因**: MQTT 服务未连接  
**解决**: 检查 MQTT 配置和连接状态

## 安全机制

### 1. 用户确认
- 所有命令都需要用户手动点击执行
- AI 不会自动执行任何控制命令

### 2. 参数验证
- API 会验证所有参数的有效性
- 超出范围的值会被拒绝

### 3. 错误反馈
- 所有错误都会明确显示给用户
- 用户可以根据错误信息调整请求

## 优势

1. **直观**: 命令以卡片形式展示，清晰易懂
2. **安全**: 需要用户确认，不会误操作
3. **快速**: 一键执行，无需手动输入命令
4. **反馈**: 实时显示执行结果
5. **可追溯**: 所有命令和结果都保留在聊天记录中

## 扩展功能

### 未来可以添加

1. **批量执行**: 一次执行多个命令
2. **定时执行**: 设置命令在特定时间执行
3. **条件执行**: 当满足某些条件时自动执行
4. **命令历史**: 查看和重复执行历史命令
5. **命令模板**: 保存常用的命令组合

## 技术细节

### 命令检测正则

```typescript
const blockRegex = /<CHART\s+type="([^"]+)"\s*>([\s\S]*?)<\/CHART>|```(\w+)?\n([\s\S]*?)```/g
```

这个正则会匹配：
- Markdown 代码块 (```json ... ```)
- Chart 标签 (<CHART>...</CHART>)

### JSON 解析

```typescript
try {
  const maybe = JSON.parse(p.value)
  const isDeviceCommand = maybe && 
    typeof maybe === "object" && 
    maybe.action && 
    (maybe.action === "toggle_relay" || maybe.action === "set_led")
} catch {}
```

安全地解析 JSON，失败时不会崩溃。

## 测试场景

### 测试 1: 开启设备
1. 询问 AI："帮我开启风扇"
2. AI 生成命令
3. 点击"执行命令"
4. 验证风扇是否开启

### 测试 2: 调整 LED
1. 询问 AI："调整补光灯为红光"
2. AI 生成 RGB 命令
3. 点击"执行命令"
4. 验证 LED 颜色是否改变

### 测试 3: 错误处理
1. 断开 MQTT 连接
2. 尝试执行命令
3. 验证是否显示错误信息

## 注意事项

1. 确保 MQTT 服务正常运行
2. 确保设备在线并可控制
3. 命令执行后可能需要几秒钟才能看到设备状态更新
4. 如果命令失败，可以重新请求 AI 生成新命令
